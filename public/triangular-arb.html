<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Triangular Arbitrage - ARB4ME</title>

    <!-- Trade Logger Service (Shared across all strategies and 20 exchanges) -->
    <script src="/utils/trade-logger.js"></script>

    <!-- Test Scan Service (Shared across all strategies) -->
    <script src="/services/testScanConfigs.js"></script>
    <script src="/services/testScanService.js"></script>

    <style>
        body {
            background: linear-gradient(135deg, #0c0c1e 0%, #161632 100%);
            color: #b8c6db;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }

        .triangular-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #b8c6db;
            font-size: 0.9rem;
        }

        .form-group input {
            width: 100%;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            color: #fff;
            font-size: 0.9rem;
        }

        .toggle-switch {
            width: 50px;
            height: 25px;
            background: #ff6b6b;
            border-radius: 25px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
        }

        .toggle-switch.active {
            background: #00ff88;
        }

        .toggle-knob {
            width: 21px;
            height: 21px;
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 2px;
            left: 2px;
            transition: all 0.3s;
        }

        .toggle-switch.active .toggle-knob {
            left: 27px;
        }

        .btn {
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #b8c6db;
        }

        #triangularTab:not(.active) {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
        }
        #triangularTab.active {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        /* Notification animations */
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        /* ============================================================ */
        /* EXCHANGE SELECTION RESPONSIVE STYLES */
        /* ============================================================ */

        /* Desktop: Hide dropdown, show checkboxes */
        #exchangeDropdownContainer {
            display: none;
        }

        #exchangeCheckboxGrid {
            display: grid;
        }

        /* ============================================================ */
        /* MOBILE RESPONSIVE STYLES */
        /* ============================================================ */

        /* Tablets and Mobile Devices (768px and below) */
        @media (max-width: 768px) {
            /* Reduce body padding on mobile */
            body {
                padding: 10px;
            }

            /* Force single column layout for stats grid */
            .stats-grid {
                grid-template-columns: 1fr !important;
                gap: 15px !important;
            }

            /* TEST SCAN section - stack cards vertically */
            div[style*="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr))"] {
                grid-template-columns: 1fr !important;
            }

            /* LIVE TRADING header - reduce padding and font size */
            div[style*="LIVE TRADING MODE"] h2 {
                font-size: 1.4rem !important;
            }

            div[style*="LIVE TRADING MODE"] p {
                font-size: 0.85rem !important;
            }

            div[style*="LIVE TRADING MODE"] {
                padding: 15px !important;
            }

            /* Exchange cards - reduce padding */
            div[id$="-card"] {
                padding: 15px !important;
            }

            /* Settings grids inside cards - stack vertically */
            div[style*="minmax(250px, 1fr)"] {
                grid-template-columns: 1fr !important;
            }

            /* Path set checkboxes - maintain 2 columns for readability */
            div[style*="grid-template-columns: 1fr auto"] {
                font-size: 0.8rem !important;
            }

            /* Control buttons - reduce to 2 columns on mobile */
            div[style*="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr))"],
            div[style*="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr))"] {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 10px !important;
            }

            /* Reduce stat card padding */
            .stat-card {
                padding: 15px !important;
            }

            /* Reduce heading sizes */
            h2 {
                font-size: 1.5rem !important;
            }

            h3 {
                font-size: 1.2rem !important;
            }

            h4 {
                font-size: 1rem !important;
            }

            /* Stat values - reduce size */
            .stat-value {
                font-size: 1.5rem !important;
            }

            /* TEST SCAN analysis tables - enable horizontal scroll */
            div[style*="max-height: 400px"] {
                overflow-x: auto !important;
            }

            div[style*="max-height: 400px"] table {
                min-width: 500px;
                font-size: 0.85rem !important;
            }

            /* Storage stats grid - stack on mobile */
            div[style*="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr))"] {
                grid-template-columns: repeat(2, 1fr) !important;
            }

            /* Analysis report grid - single column */
            div[style*="grid-template-columns: repeat(auto-fit, minmax(400px, 1fr))"] {
                grid-template-columns: 1fr !important;
            }

            /* Exchange selection - show dropdown on mobile, hide checkboxes */
            #exchangeDropdownContainer {
                display: block !important;
            }

            #exchangeCheckboxGrid {
                display: none !important;
            }

            /* Buttons - adjust padding */
            .btn {
                padding: 10px 18px !important;
                font-size: 0.85rem !important;
            }

            /* Form inputs - adjust sizing */
            .form-group input,
            .form-group select {
                font-size: 0.85rem !important;
                padding: 10px !important;
            }

            /* Toggle switches - slightly smaller */
            .toggle-switch {
                width: 45px !important;
                height: 23px !important;
            }

            .toggle-knob {
                width: 19px !important;
                height: 19px !important;
            }

            .toggle-switch.active .toggle-knob {
                left: 24px !important;
            }

            /* Alert cards - stack info */
            div[style*="display: flex"][style*="gap: 15px"] {
                flex-direction: column !important;
                gap: 10px !important;
            }

            /* Funding requirement boxes - reduce padding */
            div[style*="padding: 20px"][style*="margin-bottom: 20px"] {
                padding: 15px !important;
            }

            /* Info banners - reduce icon size */
            div[style*="font-size: 2.5rem"] {
                font-size: 2rem !important;
            }

            div[style*="font-size: 2rem"] {
                font-size: 1.5rem !important;
            }
        }

        /* Very Small Phones (400px and below) */
        @media (max-width: 400px) {
            /* Minimal body padding */
            body {
                padding: 5px;
            }

            /* Single column for all grids */
            div[style*="grid-template-columns: repeat(2, 1fr)"],
            #exchangeCheckboxGrid {
                grid-template-columns: 1fr !important;
            }

            /* Control buttons - single column on very small screens */
            div[style*="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr))"],
            div[style*="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr))"] {
                grid-template-columns: 1fr !important;
            }

            /* Storage stats - single column */
            div[style*="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr))"] {
                grid-template-columns: 1fr !important;
            }

            /* Further reduce headings */
            h2 {
                font-size: 1.3rem !important;
            }

            h3 {
                font-size: 1.1rem !important;
            }

            h4 {
                font-size: 0.95rem !important;
            }

            /* Smaller stat values */
            .stat-value {
                font-size: 1.3rem !important;
            }

            /* Smaller buttons */
            .btn {
                padding: 8px 14px !important;
                font-size: 0.8rem !important;
            }

            /* Tighter card padding */
            .stat-card {
                padding: 12px !important;
            }

            div[id$="-card"] {
                padding: 12px !important;
            }

            /* Smaller form elements */
            .form-group input,
            .form-group select {
                font-size: 0.8rem !important;
                padding: 8px !important;
            }

            /* Reduce gaps everywhere */
            .stats-grid,
            div[style*="gap: 20px"],
            div[style*="gap: 15px"] {
                gap: 8px !important;
            }

            /* Tables - smaller font */
            table {
                font-size: 0.75rem !important;
            }

            div[style*="max-height: 400px"] table {
                min-width: 400px;
            }

            /* Return to dashboard button - full width */
            button[onclick="returnToPlatform()"] {
                width: 100% !important;
                padding: 12px 20px !important;
            }

            /* LIVE TRADING header - more compact */
            div[style*="LIVE TRADING MODE"] {
                padding: 12px !important;
            }

            div[style*="LIVE TRADING MODE"] h2 {
                font-size: 1.2rem !important;
            }

            div[style*="LIVE TRADING MODE"] p {
                font-size: 0.75rem !important;
            }

            /* Icons - smaller on tiny screens */
            div[style*="font-size: 2.5rem"],
            div[style*="font-size: 2rem"],
            div[style*="font-size: 1.5rem"] {
                font-size: 1.2rem !important;
            }
        }

        /* Landscape orientation fixes for mobile */
        @media (max-width: 768px) and (orientation: landscape) {
            /* Reduce header sizes in landscape */
            h2 {
                font-size: 1.3rem !important;
            }

            h3 {
                font-size: 1.1rem !important;
            }

            /* Compact stat cards in landscape */
            .stat-card {
                padding: 10px !important;
            }

            /* Smaller buttons in landscape */
            .btn {
                padding: 8px 16px !important;
                font-size: 0.8rem !important;
            }
        }
    </style>
</head>
<body>
    <div class="triangular-container">
        <!-- Return to Dashboard Button -->
        <div style="margin-bottom: 20px; text-align: center;">
            <button onclick="returnToPlatform()" class="btn" style="background: linear-gradient(45deg, #ff6b6b 0%, #ee5a24 100%); font-size: 1rem; padding: 15px 30px;">
                ‚Üê Return to Dashboard
            </button>
        </div>

        <!-- Triangular Arbitrage Management Tab -->
        <div id="triangularTab" class="tab-content active">
            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                <h3 style="color: #00d4ff; margin: 0;">üî∫ Triangular Arbitrage Management</h3>
                <button onclick="openTriangularAboutModal()" style="background: rgba(0,212,255,0.2); color: #00d4ff; border: 1px solid #00d4ff; padding: 6px 16px; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 600; transition: all 0.3s;" onmouseover="this.style.background='rgba(0,212,255,0.3)'" onmouseout="this.style.background='rgba(0,212,255,0.2)'">
                    ‚ÑπÔ∏è About
                </button>
            </div>

            <!-- Statistics Grid for Triangular Arbitrage -->
            <div class="stats-grid" style="margin-bottom: 30px;">
                <div class="stat-card">
                    <div class="stat-value" style="color: #00ff88;" id="triangularActiveExchanges">21</div>
                    <div class="stat-label">Active Exchanges</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" style="color: #ffb347;" id="triangularTotalPaths">600+</div>
                    <div class="stat-label">Total Paths</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" style="color: #ff6b6b;" id="triangularProfitableToday">0</div>
                    <div class="stat-label">Profitable Today</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" style="color: #00d4ff;" id="triangularProfitToday">$0.00</div>
                    <div class="stat-label">Today's Profit</div>
                </div>
            </div>
        </div>

        <!-- TEST SCAN Section -->
        <div style="background: rgba(0,212,255,0.1); padding: 20px; border-radius: 15px; margin-bottom: 30px; border: 2px solid #00d4ff;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: #00d4ff; margin: 0;">üß™ TEST SCAN - Data Collection Mode</h3>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <span id="testScanStatus" style="color: #ff6b6b; font-size: 0.9rem; font-weight: 600;">STOPPED</span>
                </div>
            </div>

            <!-- Info Banner -->
            <div style="background: rgba(0,212,255,0.15); border: 2px solid #00d4ff; border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                <div style="display: flex; align-items: flex-start; gap: 15px;">
                    <div style="font-size: 2rem; flex-shrink: 0;">üìä</div>
                    <div>
                        <h4 style="color: #00d4ff; margin: 0 0 8px 0; font-size: 1.1rem;">What is TEST SCAN?</h4>
                        <p style="color: #b8e0ff; margin: 0 0 8px 0; font-size: 0.9rem;">
                            TEST SCAN monitors triangular arbitrage opportunities WITHOUT executing trades. It collects data to help you identify:
                            <strong>which path sets are most profitable</strong>, <strong>which exchanges have the best opportunities</strong>, and <strong>optimal trading times</strong>.
                        </p>
                        <p style="color: #ffc266; margin: 0; font-size: 0.85rem;">
                            üí° <strong>No trading, no risk</strong> - Just data collection to inform your strategy before going live.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Settings Grid -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">

                <!-- Exchange Selection -->
                <div class="stat-card">
                    <h4 style="color: #ffb347; margin-bottom: 15px;">üìç Select Exchange</h4>
                    <div class="form-group">
                        <label>Exchange to Scan</label>
                        <select id="testScanExchange" style="width: 100%; padding: 10px; background: #1a1a2e; border: 1px solid rgba(0,212,255,0.5); border-radius: 6px; color: #fff; font-size: 0.9rem;">
                            <option value="valr" style="background: #1a1a2e; color: #fff;">üíö VALR (48 paths)</option>
                            <option value="luno" style="background: #1a1a2e; color: #fff;">üî∑ LUNO (24 paths)</option>
                            <option value="kraken" style="background: #1a1a2e; color: #fff;">üü£ Kraken (114+ paths)</option>
                            <option value="binance" style="background: #1a1a2e; color: #fff;">üü° Binance (60+ paths)</option>
                            <option value="bybit" style="background: #1a1a2e; color: #fff;">üü° ByBit (40+ paths)</option>
                            <option value="kucoin" style="background: #1a1a2e; color: #fff;">üü¢ KuCoin (50+ paths)</option>
                        </select>
                    </div>
                    <div style="margin-top: 10px; padding: 8px; background: rgba(0,212,255,0.1); border-radius: 6px; font-size: 0.8rem; color: #b8c6db;">
                        üí° Start with one exchange, then expand to compare results across exchanges.
                    </div>
                </div>

                <!-- Path Set Selection -->
                <div class="stat-card">
                    <h4 style="color: #ffb347; margin-bottom: 15px;">üéØ Path Sets to Scan</h4>
                    <div style="display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center; max-height: 200px; overflow-y: auto;" id="testScanPathSets">
                        <!-- VALR Path Sets (default) -->
                        <span style="color: #b8c6db; font-size: 0.85rem;">SET 1: ETH (4 paths)</span>
                        <input type="checkbox" class="test-scan-path" data-set="1" checked>

                        <span style="color: #b8c6db; font-size: 0.85rem;">SET 2: XRP (4 paths)</span>
                        <input type="checkbox" class="test-scan-path" data-set="2" checked>

                        <span style="color: #b8c6db; font-size: 0.85rem;">SET 3: SOL (4 paths)</span>
                        <input type="checkbox" class="test-scan-path" data-set="3" checked>

                        <span style="color: #b8c6db; font-size: 0.85rem;">SET 4: BNB (4 paths)</span>
                        <input type="checkbox" class="test-scan-path" data-set="4" checked>
                    </div>
                    <div style="margin-top: 10px;">
                        <button onclick="selectAllTestPaths()" style="background: rgba(0,212,255,0.2); color: #00d4ff; border: 1px solid #00d4ff; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; margin-right: 8px;">Select All</button>
                        <button onclick="deselectAllTestPaths()" style="background: rgba(255,107,107,0.2); color: #ff6b6b; border: 1px solid #ff6b6b; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem;">Deselect All</button>
                    </div>
                </div>

                <!-- Scan Settings -->
                <div class="stat-card">
                    <h4 style="color: #ffb347; margin-bottom: 15px;">‚öôÔ∏è Scan Settings</h4>
                    <div class="form-group">
                        <label>Min Profit Threshold (%) - Use negative to test calculation</label>
                        <input type="number" id="testScanMinProfit" value="0.5" min="-10" max="10" step="0.1" style="width: 100%; padding: 8px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); border-radius: 6px; color: #fff;">
                    </div>
                    <div class="form-group">
                        <label>Scan Interval (seconds)</label>
                        <input type="number" id="testScanInterval" value="30" min="10" max="300" step="10" style="width: 100%; padding: 8px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); border-radius: 6px; color: #fff;">
                    </div>
                    <div class="form-group">
                        <label>Test Amount (for calculations)</label>
                        <input type="number" id="testScanAmount" value="1000" min="100" max="10000" step="100" style="width: 100%; padding: 8px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); border-radius: 6px; color: #fff;">
                    </div>
                </div>

            </div>

            <!-- Control Buttons -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                <button onclick="startTestScan()" class="btn" style="background: linear-gradient(45deg, #00d4ff 0%, #0099ff 100%);">
                    ‚ñ∂Ô∏è Start Scan
                </button>
                <button onclick="pauseTestScan()" class="btn" style="background: linear-gradient(45deg, #ffb347 0%, #ff9500 100%);">
                    ‚è∏Ô∏è Pause
                </button>
                <button onclick="stopTestScan()" class="btn" style="background: linear-gradient(45deg, #ff6b6b 0%, #ee5a24 100%);">
                    ‚èπÔ∏è Stop & Analyze
                </button>
                <button onclick="clearTestScanData()" class="btn" style="background: linear-gradient(45deg, #666 0%, #444 100%);">
                    üóëÔ∏è Clear Data
                </button>
            </div>

            <!-- Storage Stats -->
            <div class="stat-card" style="margin-bottom: 20px;">
                <h4 style="color: #ffb347; margin-bottom: 15px;">üíæ Storage Statistics</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div>
                        <div style="color: #b8c6db; font-size: 0.85rem; margin-bottom: 5px;">Opportunities Stored</div>
                        <div style="color: #00d4ff; font-size: 1.3rem; font-weight: 600;" id="testStoredCount">0</div>
                    </div>
                    <div>
                        <div style="color: #b8c6db; font-size: 0.85rem; margin-bottom: 5px;">Unique Routes</div>
                        <div style="color: #00ff88; font-size: 1.3rem; font-weight: 600;" id="testUniqueRoutes">0</div>
                    </div>
                    <div>
                        <div style="color: #b8c6db; font-size: 0.85rem; margin-bottom: 5px;">Storage Used</div>
                        <div style="color: #ffb347; font-size: 1.3rem; font-weight: 600;" id="testStorageUsed">0%</div>
                    </div>
                    <div>
                        <div style="color: #b8c6db; font-size: 0.85rem; margin-bottom: 5px;">Scan Duration</div>
                        <div style="color: #b8c6db; font-size: 1.3rem; font-weight: 600;" id="testScanDuration">0:00:00</div>
                    </div>
                </div>
            </div>

            <!-- Live Analysis Report (Always Visible) -->
            <div id="testScanAnalysis">
                <h4 style="color: #ffc107; margin-bottom: 20px; font-size: 1.2rem; text-align: center;">üìä Live Analysis Report</h4>

                <!-- Top 20 Paths by Profit % -->
                <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                    <h5 style="color: #00ff88; margin-bottom: 15px;">üèÜ Top 20 Paths by Profit %</h5>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; color: #b8c6db; font-size: 0.85rem;">
                            <thead>
                                <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                                    <th style="text-align: left; padding: 10px; color: #888;">#</th>
                                    <th style="text-align: left; padding: 10px; color: #888;">Exchange</th>
                                    <th style="text-align: left; padding: 10px; color: #888;">Path</th>
                                    <th style="text-align: left; padding: 10px; color: #888;">Base Crypto</th>
                                    <th style="text-align: right; padding: 10px; color: #888;">Avg Profit %</th>
                                    <th style="text-align: right; padding: 10px; color: #888;">Best Profit %</th>
                                    <th style="text-align: right; padding: 10px; color: #888;">Times Found</th>
                                    <th style="text-align: center; padding: 10px; color: #888;">Liquidity</th>
                                    <th style="text-align: right; padding: 10px; color: #888;">Last Seen</th>
                                </tr>
                            </thead>
                            <tbody id="testTopProfitTable">
                                <tr><td colspan="9" style="text-align: center; padding: 30px; color: #888; font-style: italic;">Waiting for scan data... Click "Start Scan" above.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Top 20 Paths by Consistency -->
                <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                    <h5 style="color: #00d4ff; margin-bottom: 15px;">üìà Top 20 Paths by Consistency (Most Reliable)</h5>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; color: #b8c6db; font-size: 0.85rem;">
                            <thead>
                                <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                                    <th style="text-align: left; padding: 10px; color: #888;">#</th>
                                    <th style="text-align: left; padding: 10px; color: #888;">Exchange</th>
                                    <th style="text-align: left; padding: 10px; color: #888;">Path</th>
                                    <th style="text-align: left; padding: 10px; color: #888;">Base Crypto</th>
                                    <th style="text-align: right; padding: 10px; color: #888;">Times Found</th>
                                    <th style="text-align: right; padding: 10px; color: #888;">Avg Profit %</th>
                                    <th style="text-align: right; padding: 10px; color: #888;">Min/Max Profit</th>
                                    <th style="text-align: center; padding: 10px; color: #888;">Consistency</th>
                                </tr>
                            </thead>
                            <tbody id="testTopConsistencyTable">
                                <tr><td colspan="8" style="text-align: center; padding: 30px; color: #888; font-style: italic;">Waiting for scan data... Click "Start Scan" above.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Best Cryptos & Best Exchanges Side by Side -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <!-- Best Cryptos -->
                    <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 20px;">
                        <h5 style="color: #667eea; margin-bottom: 15px;">‚ö° Best Cryptos for Triangular Arb</h5>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; color: #b8c6db; font-size: 0.85rem;">
                                <thead>
                                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                                        <th style="text-align: left; padding: 10px; color: #888;">Crypto</th>
                                        <th style="text-align: right; padding: 10px; color: #888;">Opps</th>
                                        <th style="text-align: right; padding: 10px; color: #888;">Avg Profit</th>
                                    </tr>
                                </thead>
                                <tbody id="testBestCryptosTable">
                                    <tr><td colspan="3" style="text-align: center; padding: 20px; color: #888;">Waiting for scan data...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Best Exchanges -->
                    <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 20px;">
                        <h5 style="color: #ffb347; margin-bottom: 15px;">üè¶ Best Exchanges</h5>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; color: #b8c6db; font-size: 0.85rem;">
                                <thead>
                                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                                        <th style="text-align: left; padding: 10px; color: #888;">Exchange</th>
                                        <th style="text-align: right; padding: 10px; color: #888;">Opps</th>
                                        <th style="text-align: right; padding: 10px; color: #888;">Avg Profit</th>
                                    </tr>
                                </thead>
                                <tbody id="testBestExchangesTable">
                                    <tr><td colspan="3" style="text-align: center; padding: 20px; color: #888;">Waiting for scan data...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Time of Day Analysis -->
                <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                    <h5 style="color: #ffc107; margin-bottom: 15px;">üïê Best Times to Trade (Hourly Analysis)</h5>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; color: #b8c6db; font-size: 0.85rem;">
                            <thead>
                                <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                                    <th style="text-align: left; padding: 10px; color: #888;">Hour (Local Time)</th>
                                    <th style="text-align: right; padding: 10px; color: #888;">Opportunities</th>
                                    <th style="text-align: right; padding: 10px; color: #888;">Avg Profit %</th>
                                    <th style="text-align: left; padding: 10px; color: #888;">Most Common Path</th>
                                </tr>
                            </thead>
                            <tbody id="testTimeAnalysisTable">
                                <tr><td colspan="4" style="text-align: center; padding: 20px; color: #888;">Waiting for scan data...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Export Button -->
                <div style="text-align: center; margin-top: 20px;">
                    <button onclick="exportTestScanData()" class="btn" style="background: linear-gradient(45deg, #00ff88 0%, #00cc70 100%);">
                        üíæ Export Analysis to JSON
                    </button>
                </div>
            </div>

        </div>

        <!-- LIVE TRADING Section Header -->
        <div style="background: linear-gradient(135deg, rgba(0,255,136,0.15) 0%, rgba(0,212,255,0.15) 100%); padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 2px solid rgba(0,255,136,0.3); text-align: center;">
            <div style="display: flex; align-items: center; justify-content: center; gap: 15px;">
                <div style="font-size: 2.5rem;">‚ö°</div>
                <div>
                    <h2 style="color: #00ff88; margin: 0 0 5px 0; font-size: 1.8rem; font-weight: 700;">LIVE TRADING MODE</h2>
                    <p style="color: #b8e0ff; margin: 0; font-size: 0.95rem;">
                        Configure and manage automated triangular arbitrage trading across all exchanges
                    </p>
                </div>
                <div style="font-size: 2.5rem;">‚ö°</div>
            </div>
        </div>

        <!-- Exchange Selection Filter -->
        <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 12px; margin-bottom: 30px; border: 1px solid rgba(255,255,255,0.2);">
            <h4 style="color: #00d4ff; margin: 0 0 15px 0;">üìã Select Exchanges to Display</h4>

            <!-- Mobile Dropdown (shown on mobile ‚â§768px, hidden on desktop) -->
            <div id="exchangeDropdownContainer" style="margin-bottom: 15px;">
                <label style="display: block; color: #b8c6db; font-size: 0.9rem; margin-bottom: 8px;">Select Exchange:</label>
                <select id="exchangeDropdown" multiple style="width: 100%; padding: 10px; background: #1a1a2e; border: 1px solid rgba(0,212,255,0.5); border-radius: 8px; color: #fff; font-size: 0.95rem; min-height: 200px;">
                    <!-- Options will be dynamically generated by JavaScript -->
                </select>
                <div style="margin-top: 8px; color: #b8c6db; font-size: 0.8rem;">
                    üí° Hold Ctrl/Cmd to select multiple exchanges
                </div>
            </div>

            <!-- Desktop Checkbox Grid (shown on desktop >768px, hidden on mobile) -->
            <div id="exchangeCheckboxGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px;">
                <!-- Checkboxes will be dynamically generated by JavaScript -->
            </div>

            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); color: #b8c6db; font-size: 0.85rem;">
                <span id="selectedExchangeCount">0</span> of 21 exchanges selected
            </div>
        </div>

        <!-- VALR Exchange Card -->
        <div id="valr-card" style="display: none; background: rgba(0,255,136,0.1); padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 2px solid #00ff88;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: #00ff88; margin: 0;">üíö VALR Triangular Arbitrage</h3>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <span style="color: #b8c6db; font-size: 0.9rem;">VALR Live Trading:</span>
                    <div class="toggle-switch" id="valrTriangularEnabled">
                        <div class="toggle-knob"></div>
                    </div>
                    <span id="valrTriangularStatus" style="color: #ff6b6b; font-size: 0.9rem; margin-left: 10px;">OFF</span>
                </div>
            </div>

            <!-- VALR Settings Grid -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
                <!-- Risk Management -->
                <div class="stat-card">
                    <h4 style="color: #ffb347; margin-bottom: 15px;">‚öñÔ∏è Risk Management</h4>
                    <div class="form-group">
                        <label>Max Single Trade (ZAR)</label>
                        <input type="number" id="valrMaxTrade" value="500" min="100" max="10000">
                    </div>
                    <div class="form-group">
                        <label>Portfolio % per Trade</label>
                        <input type="number" id="valrPortfolioPercent" value="10" min="1" max="50">
                    </div>
                    <div class="form-group">
                        <label>Min Profit Threshold (%)</label>
                        <input type="number" id="valrProfitThreshold" value="0.8" min="0.1" max="5" step="0.1">
                    </div>
                </div>

                <!-- Path Categories -->
                <div class="stat-card">
                    <h4 style="color: #ffb347; margin-bottom: 15px;">üìä Path Sets (ZAR ‚Üí Crypto ‚Üí USDT)</h4>
                    <div id="valrLivePathSets" style="display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center; max-height: 200px; overflow-y: auto;">
                        <!-- Dynamically populated with expandable path sets -->
                    </div>
                    <div style="margin-top: 10px; padding: 8px; background: rgba(0,212,255,0.1); border-radius: 6px; font-size: 0.8rem; color: #b8c6db;">
                        üí° Click any set to see path details. All sets support ZAR ‚Üí Crypto ‚Üí USDT ‚Üí ZAR triangular arbitrage.
                    </div>
                </div>

                <!-- Performance Stats -->
                <div class="stat-card">
                    <h4 style="color: #ffb347; margin-bottom: 15px;">üìà Performance Stats</h4>
                    <div style="display: grid; grid-template-columns: 1fr auto; gap: 10px; font-size: 0.9rem;">
                        <span style="color: #b8c6db;">Total Trades:</span>
                        <span style="color: #00ff88;" id="valrTotalTrades">0</span>

                        <span style="color: #b8c6db;">Successful Trades:</span>
                        <span style="color: #00ff88;" id="valrSuccessfulTrades">0</span>

                        <span style="color: #b8c6db;">Success Rate:</span>
                        <span style="color: #00ff88;" id="valrSuccessRate">0%</span>

                        <span style="color: #b8c6db;">Total Profit:</span>
                        <span style="color: #00ff88;" id="valrTotalProfit">R 0.00</span>

                        <span style="color: #b8c6db;">Best Path:</span>
                        <span style="color: #00ff88;" id="valrBestPath">-</span>

                        <span style="color: #b8c6db;">Last Scan:</span>
                        <span style="color: #b8c6db;" id="valrLastScan">Never</span>
                    </div>
                </div>
            </div>

            <!-- FUNDING REQUIREMENTS Info Banner -->
            <div style="background: rgba(0,255,136,0.15); border: 2px solid #00ff88; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                <div style="display: flex; align-items: flex-start; gap: 15px;">
                    <div style="font-size: 2.5rem; flex-shrink: 0;">üí∞</div>
                    <div>
                        <h4 style="color: #00ff88; margin: 0 0 10px 0; font-size: 1.2rem;">Funding Requirements for Maximum Coverage</h4>
                        <p style="color: #b8e0ff; margin: 0 0 15px 0;">
                            VALR supports <strong>48 triangular arbitrage paths</strong> across 2 fundable currencies.
                        </p>
                        <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px;">
                            <div style="display: grid; gap: 12px;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <span style="color: #00ff88; font-size: 1.3rem;">‚úì</span>
                                    <div>
                                        <strong style="color: #00ff88;">ZAR</strong> (South African Rand - Fiat)
                                        <span style="color: #888; font-size: 0.85rem;">‚Üí 24 paths available</span>
                                        <div style="color: #888; font-size: 0.85rem;">Deposit via: Bank transfer, EFT, Instant EFT</div>
                                    </div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <span style="color: #00ff88; font-size: 1.3rem;">‚úì</span>
                                    <div>
                                        <strong style="color: #00ff88;">USDT</strong> (Tether - Stablecoin)
                                        <span style="color: #888; font-size: 0.85rem;">‚Üí 24 paths available</span>
                                        <div style="color: #888; font-size: 0.85rem;">Deposit via: Transfer from another exchange, Crypto wallet</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div style="background: rgba(255,152,0,0.15); padding: 12px; border-radius: 6px; margin-top: 12px;">
                            <p style="margin: 0; color: #ffc266; font-size: 0.9rem;">
                                <strong>üí° Important:</strong> Each path is a complete cycle (e.g., ZAR ‚Üí ETH ‚Üí USDT ‚Üí ZAR).
                                <br>‚Ä¢ Fund <strong>ONLY ZAR</strong> = 24 paths (12 sets √ó 2 ZAR paths per set)
                                <br>‚Ä¢ Fund <strong>ONLY USDT</strong> = 24 paths (12 sets √ó 2 USDT paths per set)
                                <br>‚Ä¢ Fund <strong>BOTH ZAR + USDT</strong> = <strong>48 paths</strong> (12 sets √ó 4 paths per set)
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VALR Control Buttons -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                <button onclick="testValrTriangularConnection()" class="btn" disabled style="opacity: 0.4; cursor: not-allowed;" title="Disabled: Automated worker handles connections">
                    üîç Test Connection
                </button>
                <button onclick="scanValrTriangularPaths()" class="btn" disabled style="opacity: 0.4; cursor: not-allowed;" title="Disabled: Automated worker scans continuously">
                    üîç Scan Opportunities
                </button>
                <button onclick="viewValrPathDetails()" class="btn">
                    üìä View Paths
                </button>
                <button onclick="clearValrTriangularHistory()" class="btn" disabled style="opacity: 0.4; cursor: not-allowed;" title="Disabled: Backend integration pending">
                    üóëÔ∏è Clear History
                </button>
            </div>

            <!-- Tabbed Section: Recent Trades | Balance Tracker | Alerts -->
            <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px;">
                <!-- Tab Headers -->
                <div style="display: flex; gap: 5px; margin-bottom: 15px; background: rgba(0,0,0,0.4); padding: 5px; border-radius: 8px;">
                    <button class="valr-tab-btn active" data-tab="trades" style="flex: 1; padding: 12px 10px; background: rgba(0,255,136,0.15); border: 1px solid #00ff88; border-radius: 6px; color: #00ff88; cursor: pointer; font-weight: bold; font-size: 0.95rem; transition: all 0.3s ease;">
                        üìú Recent Trades
                    </button>
                    <button class="valr-tab-btn" data-tab="balance" style="flex: 1; padding: 12px 10px; background: rgba(255,255,255,0.03); border: 1px solid transparent; border-radius: 6px; color: #888; cursor: pointer; font-weight: bold; font-size: 0.95rem; transition: all 0.3s ease;">
                        üí∞ Balance Tracker
                    </button>
                    <button class="valr-tab-btn" data-tab="alerts" style="flex: 1; padding: 12px 10px; background: rgba(255,255,255,0.03); border: 1px solid transparent; border-radius: 6px; color: #888; cursor: pointer; font-weight: bold; font-size: 0.95rem; transition: all 0.3s ease;">
                        ‚ö†Ô∏è Alerts <span id="valrAlertBadge" style="display: none; background: #ff4444; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.75rem; margin-left: 5px;">0</span>
                    </button>
                </div>

                <!-- Tab Content Panels -->

                <!-- Tab 1: Recent Trades (existing code preserved) -->
                <div id="valrTabTrades" class="valr-tab-content" style="display: block;">
                    <div id="valrRecentTrades" style="max-height: 200px; overflow-y: auto;">
                        <div style="text-align: center; color: #888; padding: 20px;">
                            No triangular trades yet. Enable live trading to start.
                        </div>
                    </div>
                </div>

                <!-- Tab 2: Balance Tracker (NEW) -->
                <div id="valrTabBalance" class="valr-tab-content" style="display: none;">
                    <div style="margin-bottom: 20px;">
                        <h5 style="color: #00ff88; margin-bottom: 10px;">üíµ ZAR Balance</h5>
                        <div style="background: rgba(0,255,136,0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #00ff88;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; font-size: 0.9rem;">
                                <div>
                                    <div style="color: #888; margin-bottom: 5px;">Starting</div>
                                    <div style="color: #00ff88; font-weight: bold; font-size: 1.1rem;" id="valrStartingZAR">R 0.00</div>
                                </div>
                                <div>
                                    <div style="color: #888; margin-bottom: 5px;">Current</div>
                                    <div style="color: #00ff88; font-weight: bold; font-size: 1.1rem;" id="valrCurrentZAR">R 0.00</div>
                                </div>
                                <div>
                                    <div style="color: #888; margin-bottom: 5px;">Change</div>
                                    <div style="font-weight: bold; font-size: 1.1rem;" id="valrChangeZAR">+R 0.00 (+0%)</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <h5 style="color: #00ff88; margin-bottom: 10px;">üíµ USDT Balance</h5>
                        <div style="background: rgba(0,255,136,0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #00ff88;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; font-size: 0.9rem;">
                                <div>
                                    <div style="color: #888; margin-bottom: 5px;">Starting</div>
                                    <div style="color: #00ff88; font-weight: bold; font-size: 1.1rem;" id="valrStartingUSDT">$0.00</div>
                                </div>
                                <div>
                                    <div style="color: #888; margin-bottom: 5px;">Current</div>
                                    <div style="color: #00ff88; font-weight: bold; font-size: 1.1rem;" id="valrCurrentUSDT">$0.00</div>
                                </div>
                                <div>
                                    <div style="color: #888; margin-bottom: 5px;">Change</div>
                                    <div style="font-weight: bold; font-size: 1.1rem;" id="valrChangeUSDT">+$0.00 (+0%)</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px; justify-content: space-between; align-items: center; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1);">
                        <div style="color: #888; font-size: 0.85rem;">
                            Last Updated: <span id="valrBalanceLastUpdate">Never</span>
                        </div>
                        <button onclick="resetValrStartingBalance()" style="padding: 6px 12px; background: rgba(255,255,255,0.1); color: #00ff88; border: 1px solid #00ff88; border-radius: 5px; cursor: pointer; font-size: 0.85rem;">
                            üîÑ Reset Starting Balance
                        </button>
                    </div>
                </div>

                <!-- Tab 3: Alerts (NEW) -->
                <div id="valrTabAlerts" class="valr-tab-content" style="display: none;">
                    <div id="valrAlertsList" style="max-height: 200px; overflow-y: auto;">
                        <div style="text-align: center; color: #888; padding: 20px;">
                            No alerts. Worker running smoothly. ‚úÖ
                        </div>
                    </div>
                    <div style="padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1); text-align: right;">
                        <button onclick="clearValrAlerts()" style="padding: 6px 12px; background: rgba(255,255,255,0.1); color: #888; border: 1px solid #555; border-radius: 5px; cursor: pointer; font-size: 0.85rem;">
                            Clear All Alerts
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- LUNO Exchange Card -->
        <div id="luno-card" style="display: none; background: rgba(0,212,255,0.1); padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 2px solid #00d4ff;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: #00d4ff; margin: 0;">üî∑ LUNO Triangular Arbitrage</h3>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <span style="color: #b8c6db; font-size: 0.9rem;">LUNO Live Trading:</span>
                    <div class="toggle-switch" id="lunoTriangularEnabled">
                        <div class="toggle-knob"></div>
                    </div>
                    <span id="lunoTriangularStatus" style="color: #ff6b6b; font-size: 0.9rem; margin-left: 10px;">OFF</span>
                </div>
            </div>

            <!-- LUNO Settings Grid -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
                <!-- Risk Management -->
                <div class="stat-card">
                    <h4 style="color: #ffb347; margin-bottom: 15px;">‚öñÔ∏è Risk Management</h4>
                    <div class="form-group">
                        <label>Max Single Trade (USDT)</label>
                        <input type="number" id="lunoMaxTrade" value="50" min="10" max="1000">
                    </div>
                    <div class="form-group">
                        <label>Portfolio % per Trade</label>
                        <input type="number" id="lunoPortfolioPercent" value="10" min="1" max="50">
                    </div>
                    <div class="form-group">
                        <label>Min Profit Threshold (%)</label>
                        <input type="number" id="lunoProfitThreshold" value="0.5" min="0.1" max="5" step="0.1">
                    </div>
                </div>

                <!-- Path Categories -->
                <div class="stat-card">
                    <h4 style="color: #ffb347; margin-bottom: 15px;">üìä Path Sets (24 Paths in 6 Sets)</h4>
                    <div style="display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center; max-height: 200px; overflow-y: auto;">
                        <span style="color: #ffd700; font-size: 0.85rem;">SET 1: ETH Focus (4 paths)</span>
                        <input type="checkbox" id="lunoSet1Enabled" checked>

                        <span style="color: #ffb347; font-size: 0.85rem;">SET 2: SOL Focus (4 paths)</span>
                        <input type="checkbox" id="lunoSet2Enabled" checked>

                        <span style="color: #32cd32; font-size: 0.85rem;">SET 3: XRP Focus (4 paths)</span>
                        <input type="checkbox" id="lunoSet3Enabled" checked>

                        <span style="color: #00d4ff; font-size: 0.85rem;">SET 4: USDT Bridge (4 paths)</span>
                        <input type="checkbox" id="lunoSet4Enabled" checked>

                        <span style="color: #9370db; font-size: 0.85rem;">SET 5: Altcoins 1 - ADA/DOT (4 paths)</span>
                        <input type="checkbox" id="lunoSet5Enabled" checked>

                        <span style="color: #ff69b4; font-size: 0.85rem;">SET 6: Altcoins 2 - AVAX/LTC (4 paths)</span>
                        <input type="checkbox" id="lunoSet6Enabled" checked>
                    </div>
                    <div style="margin-top: 10px; padding: 8px; background: rgba(0,212,255,0.1); border-radius: 6px; font-size: 0.8rem; color: #b8c6db;">
                        üí° Simple 4-paths-per-set structure matching VALR. All paths use ZAR or USDT (fundable currencies).
                    </div>
                </div>

                <!-- Performance Stats -->
                <div class="stat-card">
                    <h4 style="color: #ffb347; margin-bottom: 15px;">üìà Performance Stats</h4>
                    <div style="display: grid; grid-template-columns: 1fr auto; gap: 10px; font-size: 0.9rem;">
                        <span style="color: #b8c6db;">Total Trades:</span>
                        <span style="color: #00d4ff;" id="lunoTotalTrades">0</span>

                        <span style="color: #b8c6db;">Successful Trades:</span>
                        <span style="color: #00d4ff;" id="lunoSuccessfulTrades">0</span>

                        <span style="color: #b8c6db;">Success Rate:</span>
                        <span style="color: #00d4ff;" id="lunoSuccessRate">0%</span>

                        <span style="color: #b8c6db;">Total Profit:</span>
                        <span style="color: #00d4ff;" id="lunoTotalProfit">$0.00</span>

                        <span style="color: #b8c6db;">Best Path:</span>
                        <span style="color: #00d4ff;" id="lunoBestPath">-</span>

                        <span style="color: #b8c6db;">Last Scan:</span>
                        <span style="color: #b8c6db;" id="lunoLastScan">Never</span>
                    </div>
                </div>
            </div>

            <!-- FUNDING REQUIREMENTS Info Banner -->
            <div style="background: rgba(0,212,255,0.15); border: 2px solid #00d4ff; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                <div style="display: flex; align-items: flex-start; gap: 15px;">
                    <div style="font-size: 2.5rem; flex-shrink: 0;">üí∞</div>
                    <div>
                        <h4 style="color: #00d4ff; margin: 0 0 10px 0; font-size: 1.2rem;">Funding Requirements for Maximum Coverage</h4>
                        <p style="color: #b8e0ff; margin: 0 0 15px 0;">
                            Luno supports <strong>24 triangular arbitrage paths</strong> across 2 fundable currencies.
                        </p>
                        <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px;">
                            <div style="display: grid; gap: 12px;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <span style="color: #00d4ff; font-size: 1.3rem;">‚úì</span>
                                    <div>
                                        <strong style="color: #00d4ff;">ZAR</strong> (South African Rand - Fiat)
                                        <span style="color: #888; font-size: 0.85rem;">‚Üí 12 paths available</span>
                                        <div style="color: #888; font-size: 0.85rem;">Deposit via: Bank transfer, EFT, Instant EFT</div>
                                    </div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <span style="color: #00d4ff; font-size: 1.3rem;">‚úì</span>
                                    <div>
                                        <strong style="color: #00d4ff;">USDT</strong> (Tether - Stablecoin)
                                        <span style="color: #888; font-size: 0.85rem;">‚Üí 12 paths available</span>
                                        <div style="color: #888; font-size: 0.85rem;">Deposit via: Transfer from another exchange, Crypto wallet</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div style="background: rgba(255,152,0,0.15); padding: 12px; border-radius: 6px; margin-top: 12px;">
                            <p style="margin: 0; color: #ffc266; font-size: 0.9rem;">
                                <strong>üí° Important:</strong> Each path is a complete cycle (e.g., ZAR ‚Üí XBT ‚Üí ETH ‚Üí ZAR).
                                <br>‚Ä¢ Fund <strong>ONLY ZAR</strong> = 12 paths (6 sets √ó 2 ZAR paths per set)
                                <br>‚Ä¢ Fund <strong>ONLY USDT</strong> = 12 paths (6 sets √ó 2 USDT paths per set)
                                <br>‚Ä¢ Fund <strong>BOTH ZAR + USDT</strong> = <strong>24 paths</strong> (6 sets √ó 4 paths per set)
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- LUNO Control Buttons -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                <button onclick="testLunoTriangularConnection()" class="btn" disabled style="opacity: 0.4; cursor: not-allowed;" title="Disabled: Automated worker handles connections">
                    üîç Test Connection
                </button>
                <button onclick="scanLunoTriangularPaths()" class="btn" disabled style="opacity: 0.4; cursor: not-allowed;" title="Disabled: Automated worker scans continuously">
                    üîç Scan Opportunities
                </button>
                <button onclick="viewLunoPathDetails()" class="btn">
                    üìä View Paths
                </button>
                <button onclick="clearLunoTriangularHistory()" class="btn" disabled style="opacity: 0.4; cursor: not-allowed;" title="Disabled: Backend integration pending">
                    üóëÔ∏è Clear History
                </button>
            </div>

            <!-- Tabbed Section: Recent Trades | Balance Tracker | Alerts -->
            <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px;">
                <!-- Tab Headers -->
                <div style="display: flex; gap: 5px; margin-bottom: 15px; background: rgba(0,0,0,0.4); padding: 5px; border-radius: 8px;">
                    <button class="luno-tab-btn active" data-tab="trades" onclick="switchLunoTab('trades')" style="flex: 1; padding: 12px 10px; background: rgba(0,212,255,0.15); border: 1px solid #00d4ff; border-radius: 6px; color: #00d4ff; cursor: pointer; font-weight: bold; font-size: 0.95rem; transition: all 0.3s ease;">
                        üìú Recent Trades
                    </button>
                    <button class="luno-tab-btn" data-tab="balance" onclick="switchLunoTab('balance')" style="flex: 1; padding: 12px 10px; background: rgba(255,255,255,0.03); border: 1px solid transparent; border-radius: 6px; color: #888; cursor: pointer; font-weight: bold; font-size: 0.95rem; transition: all 0.3s ease;">
                        üí∞ Balance Tracker
                    </button>
                    <button class="luno-tab-btn" data-tab="alerts" onclick="switchLunoTab('alerts')" style="flex: 1; padding: 12px 10px; background: rgba(255,255,255,0.03); border: 1px solid transparent; border-radius: 6px; color: #888; cursor: pointer; font-weight: bold; font-size: 0.95rem; transition: all 0.3s ease;">
                        ‚ö†Ô∏è Alerts <span id="lunoAlertBadge" style="display: none; background: #ff4444; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.75rem; margin-left: 5px;">0</span>
                    </button>
                </div>

                <!-- Tab 1: Recent Trades (preserve existing) -->
                <div id="lunoTabTrades" class="luno-tab-content" style="display: block;">
                    <div id="lunoRecentTrades" style="max-height: 200px; overflow-y: auto;">
                        <div style="text-align: center; color: #888; padding: 20px;">
                            No triangular trades yet. Enable live trading to start.
                        </div>
                    </div>
                </div>

                <!-- Tab 2: Balance Tracker (NEW) -->
                <div id="lunoTabBalance" class="luno-tab-content" style="display: none;">
                    <!-- ZAR Balance -->
                    <div style="background: rgba(0,212,255,0.05); padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 3px solid #00d4ff;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h5 style="color: #00d4ff; margin: 0;">üáøüá¶ ZAR Balance</h5>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; font-size: 0.9rem;">
                            <div>
                                <div style="color: #888; font-size: 0.8rem; margin-bottom: 5px;">Starting</div>
                                <div id="lunoStartingZAR" style="color: #b8c6db; font-weight: bold; font-family: monospace;">R 0.00</div>
                            </div>
                            <div>
                                <div style="color: #888; font-size: 0.8rem; margin-bottom: 5px;">Current</div>
                                <div id="lunoCurrentZAR" style="color: #00d4ff; font-weight: bold; font-family: monospace;">R 0.00</div>
                            </div>
                            <div>
                                <div style="color: #888; font-size: 0.8rem; margin-bottom: 5px;">Change</div>
                                <div id="lunoChangeZAR" style="font-weight: bold; font-family: monospace;">+R 0.00 (+0%)</div>
                            </div>
                        </div>
                    </div>

                    <!-- USDT Balance -->
                    <div style="background: rgba(0,212,255,0.05); padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 3px solid #00d4ff;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h5 style="color: #00d4ff; margin: 0;">üíµ USDT Balance</h5>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; font-size: 0.9rem;">
                            <div>
                                <div style="color: #888; font-size: 0.8rem; margin-bottom: 5px;">Starting</div>
                                <div id="lunoStartingUSDT" style="color: #b8c6db; font-weight: bold; font-family: monospace;">$0.00</div>
                            </div>
                            <div>
                                <div style="color: #888; font-size: 0.8rem; margin-bottom: 5px;">Current</div>
                                <div id="lunoCurrentUSDT" style="color: #00d4ff; font-weight: bold; font-family: monospace;">$0.00</div>
                            </div>
                            <div>
                                <div style="color: #888; font-size: 0.8rem; margin-bottom: 5px;">Change</div>
                                <div id="lunoChangeUSDT" style="font-weight: bold; font-family: monospace;">+$0.00 (+0%)</div>
                            </div>
                        </div>
                    </div>

                    <!-- Last Updated & Reset Button -->
                    <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1);">
                        <div style="color: #888; font-size: 0.85rem;">
                            Last Updated: <span id="lunoBalanceLastUpdate">Never</span>
                        </div>
                        <button onclick="resetLunoStartingBalance()" style="background: rgba(0,212,255,0.1); border: 1px solid #00d4ff; color: #00d4ff; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">
                            üîÑ Reset Starting Balance
                        </button>
                    </div>
                </div>

                <!-- Tab 3: Alerts (NEW) -->
                <div id="lunoTabAlerts" class="luno-tab-content" style="display: none;">
                    <div id="lunoAlertsList" style="max-height: 200px; overflow-y: auto;">
                        <div style="text-align: center; color: #888; padding: 20px;">
                            No alerts yet. Alerts will appear here when errors occur.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CHAINEX Exchange Card -->
        <div id="chainex-card" style="display: none; background: rgba(255,152,0,0.1); padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 2px solid #ff9800; opacity: 0.5; position: relative;">
            <!-- NOT SUPPORTED Overlay Badge -->
            <div style="position: absolute; top: 10px; right: 10px; background: rgba(255,68,68,0.9); color: white; padding: 8px 16px; border-radius: 20px; font-weight: bold; font-size: 0.9rem; box-shadow: 0 4px 12px rgba(255,68,68,0.4); z-index: 1;">
                ‚õî NOT SUPPORTED
            </div>

            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: #ff9800; margin: 0;">üî∂ CHAINEX Triangular Arbitrage</h3>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <span style="color: #b8c6db; font-size: 0.9rem;">CHAINEX Live Trading:</span>
                    <div class="toggle-switch" id="chainexTriangularEnabled" style="pointer-events: none; opacity: 0.5;">
                        <div class="toggle-knob"></div>
                    </div>
                    <span id="chainexTriangularStatus" style="color: #ff6b6b; font-size: 0.9rem; margin-left: 10px;">DISABLED</span>
                </div>
            </div>

            <!-- NOT SUPPORTED Warning Banner -->
            <div style="background: rgba(255,68,68,0.15); border: 2px solid #ff4444; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                <div style="display: flex; align-items: flex-start; gap: 15px;">
                    <div style="font-size: 2.5rem; flex-shrink: 0;">‚ö†Ô∏è</div>
                    <div>
                        <h4 style="color: #ff4444; margin: 0 0 10px 0; font-size: 1.2rem;">Triangular Arbitrage Not Supported on ChainEX</h4>
                        <p style="color: #ffa8a8; margin: 0; line-height: 1.6; font-size: 0.95rem;">
                            ChainEX does <strong>not support crypto-to-crypto trading pairs</strong> (e.g., BTC/ETH, ETH/XRP).
                            <br><br>
                            <strong>Why this matters:</strong> Triangular arbitrage requires 3 different pairs like:<br>
                            &nbsp;&nbsp;&nbsp;‚Ä¢ ZAR ‚Üí BTC (requires <code style="background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 4px;">BTC/ZAR</code>)<br>
                            &nbsp;&nbsp;&nbsp;‚Ä¢ BTC ‚Üí ETH (requires <code style="background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 4px;">ETH/BTC</code> ‚ùå not available)<br>
                            &nbsp;&nbsp;&nbsp;‚Ä¢ ETH ‚Üí ZAR (requires <code style="background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 4px;">ETH/ZAR</code>)
                            <br><br>
                            ChainEX only offers <strong>ZAR pairs</strong> (BTC/ZAR, ETH/ZAR, etc.) and <strong>USDT pairs</strong> (BTC/USDT, ETH/USDT, etc.).
                            <br><br>
                            <strong style="color: #00ff88;">‚úÖ Alternative:</strong> Use ChainEX for <strong>Cross-Exchange Arbitrage</strong> instead (buy on ChainEX, sell on another exchange).
                        </p>
                    </div>
                </div>
            </div>

            <!-- CHAINEX Settings Grid (Greyed Out) -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
                <!-- Risk Management -->
                <div class="stat-card">
                    <h4 style="color: #ffb347; margin-bottom: 15px;">‚öñÔ∏è Risk Management</h4>
                    <div class="form-group">
                        <label>Max Single Trade (ZAR)</label>
                        <input type="number" id="chainexMaxTrade" value="500" min="100" max="10000">
                    </div>
                    <div class="form-group">
                        <label>Portfolio % per Trade</label>
                        <input type="number" id="chainexPortfolioPercent" value="10" min="1" max="50">
                    </div>
                    <div class="form-group">
                        <label>Min Profit Threshold (%)</label>
                        <input type="number" id="chainexProfitThreshold" value="0.5" min="0.1" max="5" step="0.1">
                    </div>
                </div>

                <!-- Path Categories -->
                <div class="stat-card">
                    <h4 style="color: #ffb347; margin-bottom: 15px;">üìä Path Sets (28 Paths in 6 Sets)</h4>
                    <div style="display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center; max-height: 200px; overflow-y: auto;">
                        <span style="color: #ffd700; font-size: 0.85rem;">SET 1: ZAR Focus (8 paths)</span>
                        <input type="checkbox" id="chainexSet1Enabled" checked>

                        <span style="color: #ff9800; font-size: 0.85rem;">SET 2: BTC Focus (7 paths)</span>
                        <input type="checkbox" id="chainexSet2Enabled" checked>

                        <span style="color: #32cd32; font-size: 0.85rem;">SET 3: USDT Focus (6 paths)</span>
                        <input type="checkbox" id="chainexSet3Enabled" checked>

                        <span style="color: #00d4ff; font-size: 0.85rem;">SET 4: ETH Focus (4 paths)</span>
                        <input type="checkbox" id="chainexSet4Enabled">

                        <span style="color: #9370db; font-size: 0.85rem;">SET 5: Cross-Currency (2 paths)</span>
                        <input type="checkbox" id="chainexSet5Enabled">

                        <span style="color: #778899; font-size: 0.85rem;">SET 6: Extended Altcoins (1 path)</span>
                        <input type="checkbox" id="chainexSet6Enabled">
                    </div>
                    <div style="margin-top: 10px; padding: 8px; background: rgba(255,152,0,0.1); border-radius: 6px; font-size: 0.8rem; color: #b8c6db;">
                        üí° Sets 1-3 are essential (21 paths). ChainEX specializes in ZAR and major crypto pairs with competitive fees.
                    </div>
                </div>

                <!-- Performance Stats -->
                <div class="stat-card">
                    <h4 style="color: #ffb347; margin-bottom: 15px;">üìà Performance Stats</h4>
                    <div style="display: grid; grid-template-columns: 1fr auto; gap: 10px; font-size: 0.9rem;">
                        <span style="color: #b8c6db;">Total Trades:</span>
                        <span style="color: #ff9800;" id="chainexTotalTrades">0</span>

                        <span style="color: #b8c6db;">Successful Trades:</span>
                        <span style="color: #ff9800;" id="chainexSuccessfulTrades">0</span>

                        <span style="color: #b8c6db;">Success Rate:</span>
                        <span style="color: #ff9800;" id="chainexSuccessRate">0%</span>

                        <span style="color: #b8c6db;">Total Profit:</span>
                        <span style="color: #ff9800;" id="chainexTotalProfit">R 0.00</span>

                        <span style="color: #b8c6db;">Best Path:</span>
                        <span style="color: #ff9800;" id="chainexBestPath">-</span>

                        <span style="color: #b8c6db;">Last Scan:</span>
                        <span style="color: #b8c6db;" id="chainexLastScan">Never</span>
                    </div>
                </div>
            </div>

            <!-- CHAINEX Control Buttons -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                <button onclick="testChainExTriangularConnection()" class="btn">
                    üîç Test Connection
                </button>
                <button onclick="scanChainExTriangularPaths()" class="btn">
                    üîç Scan Opportunities
                </button>
                <button onclick="viewChainExPathDetails()" class="btn">
                    üìä View Paths
                </button>
                <button onclick="clearChainExTriangularHistory()" class="btn">
                    üóëÔ∏è Clear History
                </button>
            </div>

            <!-- 3-Tab Interface -->
            <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px;">
                <!-- Tab Headers -->
                <div style="display: flex; gap: 5px; margin-bottom: 15px; background: rgba(0,0,0,0.4); padding: 5px; border-radius: 8px;">
                    <button class="chainex-tab-btn active" data-tab="trades" onclick="switchChainExTab('trades')" style="flex: 1; padding: 12px 10px; background: rgba(255,152,0,0.15); border: 1px solid #ff9800; border-radius: 6px; color: #ff9800; cursor: pointer; font-weight: bold; font-size: 0.95rem; transition: all 0.3s ease;">
                        üìú Recent Trades
                    </button>
                    <button class="chainex-tab-btn" data-tab="balance" onclick="switchChainExTab('balance')" style="flex: 1; padding: 12px 10px; background: rgba(255,255,255,0.03); border: 1px solid transparent; border-radius: 6px; color: #888; cursor: pointer; font-weight: bold; font-size: 0.95rem; transition: all 0.3s ease;">
                        üí∞ Balance Tracker
                    </button>
                    <button class="chainex-tab-btn" data-tab="alerts" onclick="switchChainExTab('alerts')" style="flex: 1; padding: 12px 10px; background: rgba(255,255,255,0.03); border: 1px solid transparent; border-radius: 6px; color: #888; cursor: pointer; font-weight: bold; font-size: 0.95rem; transition: all 0.3s ease;">
                        ‚ö†Ô∏è Alerts <span id="chainexAlertBadge" style="display: none; background: #ff4444; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.75rem; margin-left: 5px;">0</span>
                    </button>
                </div>

                <!-- Tab Content Panels -->

                <!-- Tab 1: Recent Trades -->
                <div id="chainexTabTrades" class="chainex-tab-content" style="display: block;">
                    <div id="chainexRecentTrades" style="max-height: 200px; overflow-y: auto;">
                        <div style="text-align: center; color: #888; padding: 20px;">
                            No triangular trades yet. Enable live trading to start.
                        </div>
                    </div>
                </div>

                <!-- Tab 2: Balance Tracker -->
                <div id="chainexTabBalance" class="chainex-tab-content" style="display: none;">
                    <div style="margin-bottom: 20px;">
                        <h5 style="color: #ff9800; margin-bottom: 10px;">üíµ ZAR Balance</h5>
                        <div style="background: rgba(255,152,0,0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #ff9800;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; font-size: 0.9rem;">
                                <div>
                                    <div style="color: #888; margin-bottom: 5px;">Starting</div>
                                    <div style="color: #ff9800; font-weight: bold; font-size: 1.1rem;" id="chainexStartingZAR">R 0.00</div>
                                </div>
                                <div>
                                    <div style="color: #888; margin-bottom: 5px;">Current</div>
                                    <div style="color: #ff9800; font-weight: bold; font-size: 1.1rem;" id="chainexCurrentZAR">R 0.00</div>
                                </div>
                                <div>
                                    <div style="color: #888; margin-bottom: 5px;">Change</div>
                                    <div style="font-weight: bold; font-size: 1.1rem;" id="chainexChangeZAR">+R 0.00 (+0%)</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <h5 style="color: #ff9800; margin-bottom: 10px;">üíµ USDT Balance</h5>
                        <div style="background: rgba(255,152,0,0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #ff9800;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; font-size: 0.9rem;">
                                <div>
                                    <div style="color: #888; margin-bottom: 5px;">Starting</div>
                                    <div style="color: #ff9800; font-weight: bold; font-size: 1.1rem;" id="chainexStartingUSDT">$0.00</div>
                                </div>
                                <div>
                                    <div style="color: #888; margin-bottom: 5px;">Current</div>
                                    <div style="color: #ff9800; font-weight: bold; font-size: 1.1rem;" id="chainexCurrentUSDT">$0.00</div>
                                </div>
                                <div>
                                    <div style="color: #888; margin-bottom: 5px;">Change</div>
                                    <div style="font-weight: bold; font-size: 1.1rem;" id="chainexChangeUSDT">+$0.00 (+0%)</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px; justify-content: space-between; align-items: center; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1);">
                        <div style="color: #888; font-size: 0.85rem;">
                            Last Updated: <span id="chainexBalanceLastUpdate">Never</span>
                        </div>
                        <button onclick="resetChainExStartingBalance()" style="padding: 6px 12px; background: rgba(255,255,255,0.1); color: #ff9800; border: 1px solid #ff9800; border-radius: 5px; cursor: pointer; font-size: 0.85rem;">
                            üîÑ Reset Starting Balance
                        </button>
                    </div>
                </div>

                <!-- Tab 3: Alerts -->
                <div id="chainexTabAlerts" class="chainex-tab-content" style="display: none;">
                    <div id="chainexAlertsList" style="max-height: 200px; overflow-y: auto;">
                        <div style="text-align: center; color: #888; padding: 20px;">
                            No alerts. Worker running smoothly. ‚úÖ
                        </div>
                    </div>
                    <div style="padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1); text-align: right;">
                        <button onclick="clearChainExAlerts()" style="padding: 6px 12px; background: rgba(255,255,255,0.1); color: #888; border: 1px solid #555; border-radius: 5px; cursor: pointer; font-size: 0.85rem;">
                            Clear All Alerts
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- KRAKEN Exchange Card -->
        <div id="kraken-card" style="display: none; background: rgba(153,102,255,0.1); padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 2px solid #9966ff;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: #9966ff; margin: 0;">üü£ KRAKEN Triangular Arbitrage</h3>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <span style="color: #b8c6db; font-size: 0.9rem;">KRAKEN Live Trading:</span>
                    <div class="toggle-switch" id="krakenTriangularEnabled">
                        <div class="toggle-knob"></div>
                    </div>
                    <span id="krakenTriangularStatus" style="color: #ff6b6b; font-size: 0.9rem; margin-left: 10px;">OFF</span>
                </div>
            </div>

            <!-- FUNDING REQUIREMENTS Info Banner -->
            <div style="background: rgba(0,212,255,0.15); border: 2px solid #00d4ff; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                <div style="display: flex; align-items: flex-start; gap: 15px;">
                    <div style="font-size: 2.5rem; flex-shrink: 0;">üí∞</div>
                    <div>
                        <h4 style="color: #00d4ff; margin: 0 0 10px 0; font-size: 1.2rem;">Funding Requirements for Maximum Coverage</h4>
                        <p style="color: #b8e0ff; margin: 0 0 15px 0; line-height: 1.6; font-size: 0.95rem;">
                            Kraken supports <strong>114 triangular arbitrage paths</strong> across 3 stablecoin currencies.
                            Fund your account with the following to maximize opportunities:
                        </p>

                        <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <div style="display: grid; gap: 12px;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <span style="color: #00ff88; font-size: 1.3rem;">‚úì</span>
                                    <div>
                                        <strong style="color: #00d4ff;">USD</strong> (US Dollar - Fiat)
                                        <span style="color: #888; font-size: 0.85rem; margin-left: 10px;">‚Üí 38 paths available</span>
                                        <div style="color: #888; font-size: 0.85rem; margin-top: 3px;">Deposit via: Bank wire, ACH transfer</div>
                                    </div>
                                </div>

                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <span style="color: #00ff88; font-size: 1.3rem;">‚úì</span>
                                    <div>
                                        <strong style="color: #00d4ff;">USDT</strong> (Tether - Stablecoin)
                                        <span style="color: #888; font-size: 0.85rem; margin-left: 10px;">‚Üí 38 paths available</span>
                                        <div style="color: #888; font-size: 0.85rem; margin-top: 3px;">Deposit via: Transfer from another exchange/wallet</div>
                                    </div>
                                </div>

                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <span style="color: #00ff88; font-size: 1.3rem;">‚úì</span>
                                    <div>
                                        <strong style="color: #00d4ff;">USDC</strong> (USD Coin - Stablecoin)
                                        <span style="color: #888; font-size: 0.85rem; margin-left: 10px;">‚Üí 38 paths available</span>
                                        <div style="color: #888; font-size: 0.85rem; margin-top: 3px;">Deposit via: Transfer from another exchange/wallet</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div style="background: rgba(255,152,0,0.15); padding: 12px; border-radius: 6px; border-left: 4px solid #ff9800;">
                            <p style="margin: 0; color: #ffc266; font-size: 0.9rem; line-height: 1.5;">
                                <strong>üí° Important:</strong> Each path is a complete cycle (e.g., USD ‚Üí BTC ‚Üí ETH ‚Üí USD).
                                <br>
                                ‚Ä¢ Fund <strong>ONLY USD</strong> = 38 paths | Fund <strong>ONLY USDT</strong> = 38 paths | Fund <strong>ONLY USDC</strong> = 38 paths
                                <br>
                                ‚Ä¢ Fund <strong>ALL 3 currencies</strong> = <strong>114 paths</strong> (maximum opportunity coverage!)
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- KRAKEN Settings Grid -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
                <!-- Risk Management -->
                <div class="stat-card">
                    <h4 style="color: #ffb347; margin-bottom: 15px;">‚öñÔ∏è Risk Management</h4>
                    <div class="form-group">
                        <label>Max Single Trade (USDT)</label>
                        <input type="number" id="krakenMaxTrade" value="100" min="10" max="5000">
                    </div>
                    <div class="form-group">
                        <label>Portfolio % per Trade</label>
                        <input type="number" id="krakenPortfolioPercent" value="10" min="1" max="50">
                    </div>
                    <div class="form-group">
                        <label>Min Profit Threshold (%)</label>
                        <input type="number" id="krakenProfitThreshold" value="0.5" min="0.1" max="5" step="0.1">
                    </div>
                </div>

                <!-- Path Categories -->
                <div class="stat-card">
                    <h4 style="color: #ffb347; margin-bottom: 15px;">üìä Path Sets (114 Paths in 10 Sets)</h4>
                    <div style="display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center; max-height: 200px; overflow-y: auto;">
                        <span style="color: #ffd700; font-size: 0.85rem;">SET 1: ETH Focus (6 paths)</span>
                        <input type="checkbox" id="krakenSet1Enabled" checked>

                        <span style="color: #9966ff; font-size: 0.85rem;">SET 2: XRP Focus (12 paths)</span>
                        <input type="checkbox" id="krakenSet2Enabled" checked>

                        <span style="color: #32cd32; font-size: 0.85rem;">SET 3: SOL Focus (12 paths)</span>
                        <input type="checkbox" id="krakenSet3Enabled" checked>

                        <span style="color: #00d4ff; font-size: 0.85rem;">SET 4: ADA Focus (12 paths)</span>
                        <input type="checkbox" id="krakenSet4Enabled">

                        <span style="color: #ff69b4; font-size: 0.85rem;">SET 5: DOT Focus (12 paths)</span>
                        <input type="checkbox" id="krakenSet5Enabled">

                        <span style="color: #ff9800; font-size: 0.85rem;">SET 6: MATIC Focus (12 paths)</span>
                        <input type="checkbox" id="krakenSet6Enabled">

                        <span style="color: #00ff88; font-size: 0.85rem;">SET 7: LINK Focus (12 paths)</span>
                        <input type="checkbox" id="krakenSet7Enabled">

                        <span style="color: #ffa500; font-size: 0.85rem;">SET 8: LTC Focus (12 paths)</span>
                        <input type="checkbox" id="krakenSet8Enabled">

                        <span style="color: #8a2be2; font-size: 0.85rem;">SET 9: ATOM Focus (12 paths)</span>
                        <input type="checkbox" id="krakenSet9Enabled">

                        <span style="color: #e74c3c; font-size: 0.85rem;">SET 10: AVAX Focus (12 paths)</span>
                        <input type="checkbox" id="krakenSet10Enabled">
                    </div>
                    <div style="margin-top: 10px; padding: 8px; background: rgba(153,102,255,0.1); border-radius: 6px; font-size: 0.8rem; color: #b8c6db;">
                        üí° Sets 1-3 (30 paths) cover major liquidity. All 10 sets provide comprehensive USD/USDT/USDC coverage with BTC/ETH bridges.
                    </div>
                </div>

                <!-- Performance Stats -->
                <div class="stat-card">
                    <h4 style="color: #ffb347; margin-bottom: 15px;">üìà Performance Stats</h4>
                    <div style="display: grid; grid-template-columns: 1fr auto; gap: 10px; font-size: 0.9rem;">
                        <span style="color: #b8c6db;">Total Trades:</span>
                        <span style="color: #9966ff;" id="krakenTotalTrades">0</span>

                        <span style="color: #b8c6db;">Successful Trades:</span>
                        <span style="color: #9966ff;" id="krakenSuccessfulTrades">0</span>

                        <span style="color: #b8c6db;">Success Rate:</span>
                        <span style="color: #9966ff;" id="krakenSuccessRate">0%</span>

                        <span style="color: #b8c6db;">Total Profit:</span>
                        <span style="color: #9966ff;" id="krakenTotalProfit">$0.00</span>

                        <span style="color: #b8c6db;">Best Path:</span>
                        <span style="color: #9966ff;" id="krakenBestPath">-</span>

                        <span style="color: #b8c6db;">Last Scan:</span>
                        <span style="color: #b8c6db;" id="krakenLastScan">Never</span>
                    </div>
                </div>
            </div>

            <!-- KRAKEN Control Buttons -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                <button disabled class="btn" style="opacity: 0.5; cursor: not-allowed; background: rgba(255,255,255,0.05);">
                    üîç Test Connection
                </button>
                <button disabled class="btn" style="opacity: 0.5; cursor: not-allowed; background: rgba(255,255,255,0.05);">
                    üîç Scan Opportunities
                </button>
                <button onclick="viewKrakenPathDetails()" class="btn">
                    üìä View Paths
                </button>
                <button disabled class="btn" style="opacity: 0.5; cursor: not-allowed; background: rgba(255,255,255,0.05);">
                    üóëÔ∏è Clear History
                </button>
            </div>

            <!-- 3-Tab Interface -->
            <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px;">
                <!-- Tab Headers -->
                <div style="display: flex; gap: 5px; margin-bottom: 15px; background: rgba(0,0,0,0.4); padding: 5px; border-radius: 8px;">
                    <button class="kraken-tab-btn active" data-tab="trades" onclick="switchKrakenTab('trades')" style="flex: 1; padding: 12px 10px; background: rgba(153,102,255,0.15); border: 1px solid #9966ff; border-radius: 6px; color: #9966ff; cursor: pointer; font-weight: bold; font-size: 0.95rem; transition: all 0.3s ease;">
                        üìú Recent Trades
                    </button>
                    <button class="kraken-tab-btn" data-tab="balance" onclick="switchKrakenTab('balance')" style="flex: 1; padding: 12px 10px; background: rgba(255,255,255,0.03); border: 1px solid transparent; border-radius: 6px; color: #888; cursor: pointer; font-weight: bold; font-size: 0.95rem; transition: all 0.3s ease;">
                        üí∞ Balance Tracker
                    </button>
                    <button class="kraken-tab-btn" data-tab="alerts" onclick="switchKrakenTab('alerts')" style="flex: 1; padding: 12px 10px; background: rgba(255,255,255,0.03); border: 1px solid transparent; border-radius: 6px; color: #888; cursor: pointer; font-weight: bold; font-size: 0.95rem; transition: all 0.3s ease;">
                        ‚ö†Ô∏è Alerts <span id="krakenAlertBadge" style="display: none; background: #ff4444; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.75rem; margin-left: 5px;">0</span>
                    </button>
                </div>

                <!-- Tab Content Panels -->

                <!-- Tab 1: Recent Trades -->
                <div id="krakenTabTrades" class="kraken-tab-content" style="display: block;">
                    <div id="krakenRecentTrades" style="max-height: 200px; overflow-y: auto;">
                        <div style="text-align: center; color: #888; padding: 20px;">
                            No triangular trades yet. Enable live trading to start.
                        </div>
                    </div>
                </div>

                <!-- Tab 2: Balance Tracker -->
                <div id="krakenTabBalance" class="kraken-tab-content" style="display: none;">
                    <div style="margin-bottom: 20px;">
                        <h5 style="color: #9966ff; margin-bottom: 10px;">üíµ USD Balance</h5>
                        <div style="background: rgba(153,102,255,0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #9966ff;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; font-size: 0.9rem;">
                                <div>
                                    <div style="color: #888; margin-bottom: 5px;">Starting</div>
                                    <div style="color: #9966ff; font-weight: bold; font-size: 1.1rem;" id="krakenStartingUSD">$0.00</div>
                                </div>
                                <div>
                                    <div style="color: #888; margin-bottom: 5px;">Current</div>
                                    <div style="color: #9966ff; font-weight: bold; font-size: 1.1rem;" id="krakenCurrentUSD">$0.00</div>
                                </div>
                                <div>
                                    <div style="color: #888; margin-bottom: 5px;">Change</div>
                                    <div style="font-weight: bold; font-size: 1.1rem;" id="krakenChangeUSD">+$0.00 (+0%)</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <h5 style="color: #9966ff; margin-bottom: 10px;">üíµ USDT Balance</h5>
                        <div style="background: rgba(153,102,255,0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #9966ff;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; font-size: 0.9rem;">
                                <div>
                                    <div style="color: #888; margin-bottom: 5px;">Starting</div>
                                    <div style="color: #9966ff; font-weight: bold; font-size: 1.1rem;" id="krakenStartingUSDT">$0.00</div>
                                </div>
                                <div>
                                    <div style="color: #888; margin-bottom: 5px;">Current</div>
                                    <div style="color: #9966ff; font-weight: bold; font-size: 1.1rem;" id="krakenCurrentUSDT">$0.00</div>
                                </div>
                                <div>
                                    <div style="color: #888; margin-bottom: 5px;">Change</div>
                                    <div style="font-weight: bold; font-size: 1.1rem;" id="krakenChangeUSDT">+$0.00 (+0%)</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <h5 style="color: #9966ff; margin-bottom: 10px;">üíµ USDC Balance</h5>
                        <div style="background: rgba(153,102,255,0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #9966ff;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; font-size: 0.9rem;">
                                <div>
                                    <div style="color: #888; margin-bottom: 5px;">Starting</div>
                                    <div style="color: #9966ff; font-weight: bold; font-size: 1.1rem;" id="krakenStartingUSDC">$0.00</div>
                                </div>
                                <div>
                                    <div style="color: #888; margin-bottom: 5px;">Current</div>
                                    <div style="color: #9966ff; font-weight: bold; font-size: 1.1rem;" id="krakenCurrentUSDC">$0.00</div>
                                </div>
                                <div>
                                    <div style="color: #888; margin-bottom: 5px;">Change</div>
                                    <div style="font-weight: bold; font-size: 1.1rem;" id="krakenChangeUSDC">+$0.00 (+0%)</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px; justify-content: space-between; align-items: center; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1);">
                        <div style="color: #888; font-size: 0.85rem;">
                            Last Updated: <span id="krakenBalanceLastUpdate">Never</span>
                        </div>
                        <button onclick="resetKrakenStartingBalance()" style="padding: 6px 12px; background: rgba(255,255,255,0.1); color: #9966ff; border: 1px solid #9966ff; border-radius: 5px; cursor: pointer; font-size: 0.85rem;">
                            üîÑ Reset Starting Balance
                        </button>
                    </div>
                </div>

                <!-- Tab 3: Alerts -->
                <div id="krakenTabAlerts" class="kraken-tab-content" style="display: none;">
                    <div id="krakenAlertsList" style="max-height: 200px; overflow-y: auto;">
                        <div style="text-align: center; color: #888; padding: 20px;">
                            No alerts. Worker running smoothly. ‚úÖ
                        </div>
                    </div>
                    <div style="padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1); text-align: right;">
                        <button onclick="clearKrakenAlerts()" style="padding: 6px 12px; background: rgba(255,255,255,0.1); color: #888; border: 1px solid #555; border-radius: 5px; cursor: pointer; font-size: 0.85rem;">
                            Clear All Alerts
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- BYBIT Exchange Card -->
        <div id="bybit-card" style="display: none; background: rgba(255,165,0,0.1); padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 2px solid #FFA500;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: #FFA500; margin: 0;">üü° BYBIT Triangular Arbitrage</h3>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <span style="color: #b8c6db; font-size: 0.9rem;">BYBIT Live Trading:</span>
                    <div class="toggle-switch" id="bybitTriangularEnabled">
                        <div class="toggle-knob"></div>
                    </div>
                    <span id="bybitTriangularStatus" style="color: #ff6b6b; font-size: 0.9rem; margin-left: 10px;">OFF</span>
                </div>
            </div>

            <!-- FUNDING REQUIREMENTS Info Banner -->
            <div style="background: rgba(255,165,0,0.15); border: 2px solid #FFA500; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                <div style="text-align: center;">
                    <h4 style="color: #FFA500; margin: 0 0 10px 0; font-size: 1.2rem;">Funding Requirements for Maximum Coverage</h4>
                    <p style="color: #b8c6db; margin: 0 0 15px 0; font-size: 0.95rem;">
                        ByBit supports <strong style="color: #FFA500;">40 triangular arbitrage paths</strong> across <strong>1 fundable currency</strong>.
                    </p>
                </div>

                <div style="display: grid; grid-template-columns: 1fr; gap: 15px; margin-top: 15px;">
                    <!-- USDT Currency -->
                    <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; border-left: 4px solid #FFA500;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h5 style="color: #FFA500; margin: 0; font-size: 1.1rem;">üí∞ USDT (Tether)</h5>
                            <span style="color: #FFA500; font-weight: bold; font-size: 1.1rem;">40 Paths</span>
                        </div>
                        <p style="color: #b8c6db; margin: 0 0 10px 0; font-size: 0.9rem;">
                            <strong>How to fund:</strong> Transfer from exchange ‚Ä¢ Crypto wallet ‚Ä¢ Convert fiat to USDT
                        </p>
                        <p style="color: #888; margin: 0; font-size: 0.85rem; font-style: italic;">
                            All paths use USDT as the base currency for pure 3-leg triangular trading cycles
                        </p>
                    </div>
                </div>

                <div style="margin-top: 15px; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 8px; text-align: center;">
                    <p style="color: #FFA500; margin: 0; font-size: 0.9rem; font-weight: 500;">
                        üí° <strong>Pro Tip:</strong> Fund with USDT = Access to all 40 triangular arbitrage paths (5 sets √ó 8 paths per set)
                    </p>
                </div>

                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,165,0,0.3);">
                    <p style="color: #888; margin: 0; font-size: 0.85rem; text-align: center;">
                        <strong>Multi-User Platform:</strong> This information helps all users optimize their ByBit triangular trading setup
                    </p>
                </div>
            </div>

            <!-- BYBIT Settings Grid -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
                <!-- Risk Management -->
                <div class="stat-card">
                    <h4 style="color: #ffb347; margin-bottom: 15px;">‚öñÔ∏è Risk Management</h4>
                    <div class="form-group">
                        <label>Max Single Trade (USDT)</label>
                        <input type="number" id="bybitMaxTrade" value="100" min="10" max="5000">
                    </div>
                    <div class="form-group">
                        <label>Portfolio % per Trade</label>
                        <input type="number" id="bybitPortfolioPercent" value="10" min="1" max="50">
                    </div>
                    <div class="form-group">
                        <label>Min Profit Threshold (%)</label>
                        <input type="number" id="bybitProfitThreshold" value="0.5" min="0.1" max="5" step="0.1">
                    </div>
                </div>

                <!-- Path Categories -->
                <div class="stat-card">
                    <h4 style="color: #ffb347; margin-bottom: 15px;">üìä Path Sets (40 Paths in 5 Sets)</h4>
                    <div style="display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center; max-height: 200px; overflow-y: auto;">
                        <span style="color: #ffd700; font-size: 0.85rem;">SET 1: Major BTC Bridge (8 paths)</span>
                        <input type="checkbox" id="bybitSet1Enabled" checked>

                        <span style="color: #32cd32; font-size: 0.85rem;">SET 2: Altcoins BTC Bridge (8 paths)</span>
                        <input type="checkbox" id="bybitSet2Enabled" checked>

                        <span style="color: #00d4ff; font-size: 0.85rem;">SET 3: DeFi BTC Bridge (8 paths)</span>
                        <input type="checkbox" id="bybitSet3Enabled">

                        <span style="color: #ff69b4; font-size: 0.85rem;">SET 4: ETH Bridge (8 paths)</span>
                        <input type="checkbox" id="bybitSet4Enabled">

                        <span style="color: #778899; font-size: 0.85rem;">SET 5: Extended BTC (8 paths)</span>
                        <input type="checkbox" id="bybitSet5Enabled">
                    </div>
                    <div style="margin-top: 10px; padding: 8px; background: rgba(255,165,0,0.1); border-radius: 6px; font-size: 0.8rem; color: #b8c6db;">
                        üí° Sets 1-2 are essential (16 paths). All paths are 3-leg pure triangular arbitrage.
                    </div>
                </div>

                <!-- Performance Stats -->
                <div class="stat-card">
                    <h4 style="color: #ffb347; margin-bottom: 15px;">üìà Performance Stats</h4>
                    <div style="display: grid; grid-template-columns: 1fr auto; gap: 10px; font-size: 0.9rem;">
                        <span style="color: #b8c6db;">Total Trades:</span>
                        <span style="color: #FFA500;" id="bybitTotalTrades">0</span>

                        <span style="color: #b8c6db;">Successful Trades:</span>
                        <span style="color: #FFA500;" id="bybitSuccessfulTrades">0</span>

                        <span style="color: #b8c6db;">Success Rate:</span>
                        <span style="color: #FFA500;" id="bybitSuccessRate">0%</span>

                        <span style="color: #b8c6db;">Total Profit:</span>
                        <span style="color: #FFA500;" id="bybitTotalProfit">$0.00</span>

                        <span style="color: #b8c6db;">Best Path:</span>
                        <span style="color: #FFA500;" id="bybitBestPath">-</span>

                        <span style="color: #b8c6db;">Last Scan:</span>
                        <span style="color: #b8c6db;" id="bybitLastScan">Never</span>
                    </div>
                </div>
            </div>

            <!-- BYBIT Control Buttons -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                <button onclick="testByBitTriangularConnection()" class="btn" disabled style="opacity: 0.4; cursor: not-allowed;">
                    üîç Test Connection
                </button>
                <button onclick="scanByBitTriangularPaths()" class="btn" disabled style="opacity: 0.4; cursor: not-allowed;">
                    üîç Scan Opportunities
                </button>
                <button onclick="viewByBitPathDetails()" class="btn">
                    üìä View Paths
                </button>
                <button onclick="clearByBitTriangularHistory()" class="btn" disabled style="opacity: 0.4; cursor: not-allowed;">
                    üóëÔ∏è Clear History
                </button>
            </div>

            <!-- Tabbed Interface: Balance Tracker & Recent Trades -->
            <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px;">
                <!-- Tab Headers -->
                <div style="display: flex; gap: 10px; margin-bottom: 15px; border-bottom: 2px solid rgba(255,165,0,0.3);">
                    <button id="bybitBalanceTab" onclick="switchBybitTab('balance')" style="flex: 1; padding: 10px; background: rgba(255,165,0,0.3); border: none; border-radius: 8px 8px 0 0; color: #FFA500; font-weight: bold; cursor: pointer; transition: all 0.3s;">
                        üí∞ Balance Tracker
                    </button>
                    <button id="bybitTradesTab" onclick="switchBybitTab('trades')" style="flex: 1; padding: 10px; background: rgba(255,255,255,0.05); border: none; border-radius: 8px 8px 0 0; color: #b8c6db; cursor: pointer; transition: all 0.3s;">
                        üïí Recent Trades
                    </button>
                </div>

                <!-- Balance Tracker Tab Content -->
                <div id="bybitBalanceContent" style="display: block;">
                    <h4 style="color: #ffb347; margin-bottom: 15px;">üí∞ USDT Balance Tracking</h4>
                    <div style="display: grid; grid-template-columns: 1fr; gap: 12px;">
                        <!-- USDT Balance -->
                        <div style="background: rgba(255,165,0,0.1); padding: 12px; border-radius: 8px; border-left: 4px solid #FFA500;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; font-size: 0.9rem;">
                                <div>
                                    <div style="color: #888; font-size: 0.8rem; margin-bottom: 5px;">Starting</div>
                                    <div style="color: #FFA500; font-weight: bold;" id="bybitStartingUSDT">$0.00</div>
                                </div>
                                <div>
                                    <div style="color: #888; font-size: 0.8rem; margin-bottom: 5px;">Current</div>
                                    <div style="color: #FFA500; font-weight: bold;" id="bybitCurrentUSDT">$0.00</div>
                                </div>
                                <div>
                                    <div style="color: #888; font-size: 0.8rem; margin-bottom: 5px;">Change</div>
                                    <div style="color: #b8c6db; font-weight: bold;" id="bybitChangeUSDT">$0.00 (0.0%)</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div style="margin-top: 10px; padding: 8px; background: rgba(255,165,0,0.1); border-radius: 6px; font-size: 0.8rem; color: #888; text-align: center;">
                        üí° Balance updates automatically when the worker is running
                    </div>
                </div>

                <!-- Recent Trades Tab Content -->
                <div id="bybitTradesContent" style="display: none;">
                    <h4 style="color: #ffb347; margin-bottom: 15px;">üïí Recent Triangular Trades</h4>
                    <div id="bybitRecentTrades" style="max-height: 200px; overflow-y: auto;">
                        <div style="text-align: center; color: #888; padding: 20px;">
                            No triangular trades yet. Enable live trading to start.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Binance Exchange -->
        <div id="binance-card" style="display: none; background: rgba(240,185,11,0.1); padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 2px solid #F0B90B;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: #F0B90B; margin: 0;">üü° BINANCE Triangular Arbitrage</h3>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <span style="color: #b8c6db; font-size: 0.9rem;">BINANCE Live Trading:</span>
                    <div class="toggle-switch" id="binanceTriangularEnabled">
                        <div class="toggle-knob"></div>
                    </div>
                    <span id="binanceTriangularStatus" style="color: #ff6b6b; font-size: 0.9rem; margin-left: 10px;">OFF</span>
                </div>
            </div>

            <!-- FUNDING REQUIREMENTS Info Banner -->
            <div style="background: rgba(240,185,11,0.15); border: 2px solid #F0B90B; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                <div style="text-align: center;">
                    <h4 style="color: #F0B90B; margin: 0 0 10px 0; font-size: 1.2rem;">üí∞ Funding Requirements for Maximum Coverage</h4>
                    <p style="color: #b8c6db; margin: 0 0 15px 0; font-size: 0.95rem;">
                        Binance supports <strong style="color: #F0B90B;">24+ triangular arbitrage paths</strong> across <strong>1 fundable currency</strong>.
                    </p>
                </div>

                <div style="display: grid; grid-template-columns: 1fr; gap: 15px; margin-top: 15px;">
                    <!-- USDT Currency -->
                    <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; border-left: 4px solid #F0B90B;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h5 style="color: #F0B90B; margin: 0; font-size: 1.1rem;">üí∞ USDT (Tether)</h5>
                            <span style="color: #F0B90B; font-weight: bold; font-size: 1.1rem;">24+ Paths</span>
                        </div>
                        <p style="color: #b8c6db; margin: 0 0 10px 0; font-size: 0.9rem;">
                            <strong>How to fund:</strong> Transfer from wallet ‚Ä¢ Bank transfer to USDT ‚Ä¢ Convert crypto to USDT
                        </p>
                        <p style="color: #888; margin: 0; font-size: 0.85rem; font-style: italic;">
                            All paths use USDT as the base currency for pure 3-leg triangular trading cycles with BTC, ETH, and BNB bridges
                        </p>
                    </div>
                </div>

                <div style="margin-top: 15px; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 8px; text-align: center;">
                    <p style="color: #F0B90B; margin: 0; font-size: 0.9rem; font-weight: 500;">
                        üí° <strong>Pro Tip:</strong> Fund with USDT = Access to all triangular arbitrage paths across major coins
                    </p>
                </div>

                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(240,185,11,0.3);">
                    <p style="color: #888; margin: 0; font-size: 0.85rem; text-align: center;">
                        <strong>Multi-User Platform:</strong> This information helps all users optimize their Binance triangular trading setup
                    </p>
                </div>
            </div>

            <!-- Risk Management Section -->
            <div class="stat-card">
                <h4 style="color: #F0B90B; margin-bottom: 15px;">‚öñÔ∏è Risk Management</h4>
                <div class="form-group">
                    <label>Max Single Trade (USDT)</label>
                    <input type="number" id="binanceMaxTrade" value="100" min="10" max="10000">
                </div>
                <div class="form-group">
                    <label>Portfolio % per Trade</label>
                    <input type="number" id="binancePortfolioPercent" value="10" min="1" max="50">
                </div>
                <div class="form-group">
                    <label>Min Profit Threshold (%)</label>
                    <input type="number" id="binanceProfitThreshold" value="0.5" min="0.1" max="5" step="0.1">
                </div>
            </div>

            <!-- Path Sets Section -->
            <div class="stat-card">
                <h4 style="color: #F0B90B; margin-bottom: 15px;">üìä Path Sets (24 Paths in 5 Sets)</h4>
                <div style="display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center;">
                    <span style="color: #ffd700; font-size: 0.85rem;">SET 1: Major BTC Bridge (8 paths)</span>
                    <input type="checkbox" id="binanceSet1Enabled" checked>

                    <span style="color: #32cd32; font-size: 0.85rem;">SET 2: Altcoins BTC Bridge (8 paths)</span>
                    <input type="checkbox" id="binanceSet2Enabled" checked>

                    <span style="color: #00d4ff; font-size: 0.85rem;">SET 3: DeFi BTC Bridge (6 paths)</span>
                    <input type="checkbox" id="binanceSet3Enabled">

                    <span style="color: #ff69b4; font-size: 0.85rem;">SET 4: ETH/BNB Bridge (varies)</span>
                    <input type="checkbox" id="binanceSet4Enabled">

                    <span style="color: #ff8c00; font-size: 0.85rem;">SET 5: Multi-Bridge (varies)</span>
                    <input type="checkbox" id="binanceSet5Enabled">
                </div>
            </div>

            <!-- Statistics Section -->
            <div class="stat-card">
                <h4 style="color: #F0B90B; margin-bottom: 15px;">üìà Today's Statistics</h4>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                    <div>
                        <div style="color: #888; font-size: 0.75rem;">Scans</div>
                        <div style="color: #F0B90B; font-size: 1.3rem; font-weight: bold;">0</div>
                    </div>
                    <div>
                        <div style="color: #888; font-size: 0.75rem;">Opportunities</div>
                        <div style="color: #32cd32; font-size: 1.3rem; font-weight: bold;">0</div>
                    </div>
                    <div>
                        <div style="color: #888; font-size: 0.75rem;">Profit (ZAR)</div>
                        <div style="color: #F0B90B; font-size: 1.3rem; font-weight: bold;">R 0.00</div>
                    </div>
                </div>
            </div>

            <!-- Control Buttons -->
            <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 20px;">
                <button disabled class="btn" style="background: #555; opacity: 0.5; cursor: not-allowed;">üîç Test Connection (Disabled)</button>
                <button disabled class="btn" style="background: #555; opacity: 0.5; cursor: not-allowed;">üîç Scan Opportunities (Disabled)</button>
                <button onclick="viewBinancePathDetails()" class="btn" style="background: linear-gradient(135deg, #00bfff, #87ceeb);">üìä View Paths</button>
                <button disabled class="btn" style="background: #555; opacity: 0.5; cursor: not-allowed;">üóëÔ∏è Clear History (Disabled)</button>
            </div>

            <!-- Tabbed Interface: Balance Tracker & Recent Trades -->
            <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px;">
                <!-- Tab Headers -->
                <div style="display: flex; gap: 10px; margin-bottom: 15px; border-bottom: 2px solid rgba(240,185,11,0.3);">
                    <button id="binanceBalanceTab" onclick="switchBinanceTab('balance')" style="flex: 1; padding: 10px; background: rgba(240,185,11,0.3); border: none; border-radius: 8px 8px 0 0; color: #F0B90B; font-weight: bold; cursor: pointer; transition: all 0.3s;">
                        üí∞ Balance Tracker
                    </button>
                    <button id="binanceTradesTab" onclick="switchBinanceTab('trades')" style="flex: 1; padding: 10px; background: rgba(255,255,255,0.05); border: none; border-radius: 8px 8px 0 0; color: #b8c6db; cursor: pointer; transition: all 0.3s;">
                        üïí Recent Trades
                    </button>
                </div>

                <!-- Balance Tracker Tab Content -->
                <div id="binanceBalanceContent" style="display: block;">
                    <h4 style="color: #F0B90B; margin-bottom: 15px;">üí∞ USDT Balance Tracking</h4>
                    <div style="display: grid; grid-template-columns: 1fr; gap: 12px;">
                        <!-- USDT Balance -->
                        <div style="background: rgba(240,185,11,0.1); padding: 12px; border-radius: 8px; border-left: 4px solid #F0B90B;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; font-size: 0.9rem;">
                                <div>
                                    <div style="color: #888; font-size: 0.8rem; margin-bottom: 5px;">Starting</div>
                                    <div style="color: #F0B90B; font-weight: bold;" id="binanceStartingUSDT">$0.00</div>
                                </div>
                                <div>
                                    <div style="color: #888; font-size: 0.8rem; margin-bottom: 5px;">Current</div>
                                    <div style="color: #F0B90B; font-weight: bold;" id="binanceCurrentUSDT">$0.00</div>
                                </div>
                                <div>
                                    <div style="color: #888; font-size: 0.8rem; margin-bottom: 5px;">Change</div>
                                    <div style="color: #b8c6db; font-weight: bold;" id="binanceChangeUSDT">$0.00 (0.0%)</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div style="margin-top: 10px; padding: 8px; background: rgba(240,185,11,0.1); border-radius: 6px; font-size: 0.8rem; color: #888; text-align: center;">
                        üí° Balance updates automatically when the worker is running
                    </div>
                </div>

                <!-- Recent Trades Tab Content -->
                <div id="binanceTradesContent" style="display: none;">
                    <h4 style="color: #F0B90B; margin-bottom: 15px;">üïí Recent Triangular Trades</h4>
                    <div id="binanceRecentTrades" style="max-height: 200px; overflow-y: auto;">
                        <div style="text-align: center; color: #888; padding: 20px;">
                            No triangular trades yet. Enable live trading to start.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- OKX Exchange -->
        <div id="okx-card" style="display: none; background: rgba(0,166,255,0.1); padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 2px solid #00A6FF;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: #00A6FF; margin: 0;">üîµ OKX Triangular Arbitrage</h3>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <span style="color: #b8c6db; font-size: 0.9rem;">OKX Live Trading:</span>
                    <div class="toggle-switch" id="okxTriangularEnabled">
                        <div class="toggle-knob"></div>
                    </div>
                    <span id="okxTriangularStatus" style="color: #ff6b6b; font-size: 0.9rem; margin-left: 10px;">OFF</span>
                </div>
            </div>

            <!-- FUNDING REQUIREMENTS Info Banner -->
            <div style="background: rgba(0,166,255,0.15); border: 2px solid #00A6FF; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                <div style="text-align: center;">
                    <h4 style="color: #00A6FF; margin: 0 0 10px 0; font-size: 1.2rem;">üí∞ Funding Requirements for Maximum Coverage</h4>
                    <p style="color: #b8c6db; margin: 0 0 15px 0; font-size: 0.95rem;">
                        OKX supports <strong style="color: #00A6FF;">32 triangular arbitrage paths</strong> across <strong>1 fundable currency</strong>.
                    </p>
                </div>

                <div style="display: grid; grid-template-columns: 1fr; gap: 15px; margin-top: 15px;">
                    <!-- USDT Currency -->
                    <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; border-left: 4px solid #00A6FF;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h5 style="color: #00A6FF; margin: 0; font-size: 1.1rem;">üí∞ USDT (Tether)</h5>
                            <span style="color: #00A6FF; font-weight: bold; font-size: 1.1rem;">32 Paths</span>
                        </div>
                        <p style="color: #b8c6db; margin: 0 0 10px 0; font-size: 0.9rem;">
                            <strong>How to fund:</strong> Transfer from exchange ‚Ä¢ Crypto wallet ‚Ä¢ Convert fiat to USDT
                        </p>
                        <p style="color: #888; margin: 0; font-size: 0.85rem; font-style: italic;">
                            All paths use USDT as the base currency including unique OKB (native token) arbitrage opportunities
                        </p>
                    </div>
                </div>

                <div style="margin-top: 15px; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 8px; text-align: center;">
                    <p style="color: #00A6FF; margin: 0; font-size: 0.9rem; font-weight: 500;">
                        üí° <strong>Pro Tip:</strong> Fund with USDT = Access to all 32 paths (includes 6 OKB native token paths + 1 four-leg extended path)
                    </p>
                </div>

                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(0,166,255,0.3);">
                    <p style="color: #888; margin: 0; font-size: 0.85rem; text-align: center;">
                        <strong>Multi-User Platform:</strong> This information helps all users optimize their OKX triangular trading setup
                    </p>
                </div>
            </div>

            <!-- Risk Management Section -->
            <div class="stat-card">
                <h4 style="color: #00A6FF; margin-bottom: 15px;">‚öñÔ∏è Risk Management</h4>
                <div class="form-group">
                    <label>Max Single Trade (USDT)</label>
                    <input type="number" id="okxMaxTrade" value="100" min="10" max="10000">
                </div>
                <div class="form-group">
                    <label>Portfolio % per Trade</label>
                    <input type="number" id="okxPortfolioPercent" value="10" min="1" max="50">
                </div>
                <div class="form-group">
                    <label>Min Profit Threshold (%)</label>
                    <input type="number" id="okxProfitThreshold" value="0.5" min="0.1" max="5" step="0.1">
                </div>
            </div>

            <!-- Path Sets Section -->
            <div class="stat-card">
                <h4 style="color: #00A6FF; margin-bottom: 15px;">üìä Path Sets (32 Paths in 5 Sets)</h4>
                <div style="display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center;">
                    <span style="color: #ffd700; font-size: 0.85rem;">SET 1: Major ETH Bridge (7 paths)</span>
                    <input type="checkbox" id="okxSet1Enabled" checked>

                    <span style="color: #32cd32; font-size: 0.85rem;">SET 2: Mid-Cap BTC Bridge (7 paths)</span>
                    <input type="checkbox" id="okxSet2Enabled" checked>

                    <span style="color: #00d4ff; font-size: 0.85rem;">SET 3: OKB Native Bridge (6 paths)</span>
                    <input type="checkbox" id="okxSet3Enabled">

                    <span style="color: #ff69b4; font-size: 0.85rem;">SET 4: High Volatility (6 paths)</span>
                    <input type="checkbox" id="okxSet4Enabled">

                    <span style="color: #ff8c00; font-size: 0.85rem;">SET 5: Extended Multi-Bridge (6 paths)</span>
                    <input type="checkbox" id="okxSet5Enabled">
                </div>
            </div>

            <!-- Statistics Section -->
            <div class="stat-card">
                <h4 style="color: #00A6FF; margin-bottom: 15px;">üìà Today's Statistics</h4>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                    <div>
                        <div style="color: #888; font-size: 0.75rem;">Scans</div>
                        <div style="color: #00A6FF; font-size: 1.3rem; font-weight: bold;">0</div>
                    </div>
                    <div>
                        <div style="color: #888; font-size: 0.75rem;">Opportunities</div>
                        <div style="color: #32cd32; font-size: 1.3rem; font-weight: bold;">0</div>
                    </div>
                    <div>
                        <div style="color: #888; font-size: 0.75rem;">Profit (ZAR)</div>
                        <div style="color: #00A6FF; font-size: 1.3rem; font-weight: bold;">R 0.00</div>
                    </div>
                </div>
            </div>

            <!-- Control Buttons -->
            <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 20px;">
                <button disabled class="btn" style="background: #555; opacity: 0.5; cursor: not-allowed;">üîç Test Connection (Disabled)</button>
                <button disabled class="btn" style="background: #555; opacity: 0.5; cursor: not-allowed;">üîç Scan Opportunities (Disabled)</button>
                <button onclick="viewOKXPathDetails()" class="btn" style="background: linear-gradient(135deg, #00bfff, #87ceeb);">üìä View Paths</button>
                <button disabled class="btn" style="background: #555; opacity: 0.5; cursor: not-allowed;">üóëÔ∏è Clear History (Disabled)</button>
            </div>

            <!-- Tabbed Interface: Balance Tracker & Recent Trades -->
            <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px;">
                <!-- Tab Headers -->
                <div style="display: flex; gap: 10px; margin-bottom: 15px; border-bottom: 2px solid rgba(0,166,255,0.3);">
                    <button id="okxBalanceTab" onclick="switchOKXTab('balance')" style="flex: 1; padding: 10px; background: rgba(0,166,255,0.3); border: none; border-radius: 8px 8px 0 0; color: #00A6FF; font-weight: bold; cursor: pointer; transition: all 0.3s;">
                        üí∞ Balance Tracker
                    </button>
                    <button id="okxTradesTab" onclick="switchOKXTab('trades')" style="flex: 1; padding: 10px; background: rgba(255,255,255,0.05); border: none; border-radius: 8px 8px 0 0; color: #b8c6db; cursor: pointer; transition: all 0.3s;">
                        üïí Recent Trades
                    </button>
                </div>

                <!-- Balance Tracker Tab Content -->
                <div id="okxBalanceContent" style="display: block;">
                    <h4 style="color: #00A6FF; margin-bottom: 15px;">üí∞ USDT Balance Tracking</h4>
                    <div style="display: grid; grid-template-columns: 1fr; gap: 12px;">
                        <!-- USDT Balance -->
                        <div style="background: rgba(0,166,255,0.1); padding: 12px; border-radius: 8px; border-left: 4px solid #00A6FF;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; font-size: 0.9rem;">
                                <div>
                                    <div style="color: #888; font-size: 0.8rem; margin-bottom: 5px;">Starting</div>
                                    <div style="color: #00A6FF; font-weight: bold;" id="okxStartingUSDT">$0.00</div>
                                </div>
                                <div>
                                    <div style="color: #888; font-size: 0.8rem; margin-bottom: 5px;">Current</div>
                                    <div style="color: #00A6FF; font-weight: bold;" id="okxCurrentUSDT">$0.00</div>
                                </div>
                                <div>
                                    <div style="color: #888; font-size: 0.8rem; margin-bottom: 5px;">Change</div>
                                    <div style="color: #b8c6db; font-weight: bold;" id="okxChangeUSDT">$0.00 (0.0%)</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div style="margin-top: 10px; padding: 8px; background: rgba(0,166,255,0.1); border-radius: 6px; font-size: 0.8rem; color: #888; text-align: center;">
                        üí° Balance updates automatically when the worker is running
                    </div>
                </div>

                <!-- Recent Trades Tab Content -->
                <div id="okxTradesContent" style="display: none;">
                    <h4 style="color: #00A6FF; margin-bottom: 15px;">üïí Recent Triangular Trades</h4>
                    <div id="okxRecentTrades" style="max-height: 200px; overflow-y: auto;">
                        <div style="text-align: center; color: #888; padding: 20px;">
                            No triangular trades yet. Enable live trading to start.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- KuCoin Exchange -->
        <div id="kucoin-card" style="display: none; background: rgba(0,208,146,0.1); padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 2px solid #00D092;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: #00D092; margin: 0;">üü¢ KUCOIN Triangular Arbitrage</h3>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <span style="color: #b8c6db; font-size: 0.9rem;">KuCoin Live Trading:</span>
                    <div class="toggle-switch" id="kucoinTriangularEnabled" onclick="toggleKuCoinTriangular()">
                        <div class="toggle-knob"></div>
                    </div>
                    <span id="kucoinTriangularStatus" style="color: #ff6b6b; font-size: 0.9rem; margin-left: 10px;">OFF</span>
                </div>
            </div>

            <!-- FUNDING REQUIREMENTS Info Banner -->
            <div style="background: rgba(0,208,146,0.15); border: 2px solid #00D092; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                <div style="text-align: center;">
                    <h4 style="color: #00D092; margin: 0 0 10px 0; font-size: 1.2rem;">üí∞ Funding Requirements for Maximum Coverage</h4>
                    <p style="color: #b8c6db; margin: 0 0 15px 0; font-size: 0.95rem;">
                        KuCoin supports <strong style="color: #00D092;">32 triangular arbitrage paths</strong> across <strong>1 fundable currency</strong>.
                    </p>
                </div>

                <div style="display: grid; grid-template-columns: 1fr; gap: 15px; margin-top: 15px;">
                    <!-- USDT Currency -->
                    <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; border-left: 4px solid #00D092;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h5 style="color: #00D092; margin: 0; font-size: 1.1rem;">üí∞ USDT (Tether)</h5>
                            <span style="color: #00D092; font-weight: bold; font-size: 1.1rem;">32 Paths</span>
                        </div>
                        <p style="color: #b8c6db; margin: 0 0 10px 0; font-size: 0.9rem;">
                            <strong>How to fund:</strong> Transfer from exchange ‚Ä¢ Crypto wallet ‚Ä¢ Convert fiat to USDT
                        </p>
                        <p style="color: #888; margin: 0; font-size: 0.85rem; font-style: italic;">
                            All paths use USDT as the base currency - includes ETH Bridge, BTC Bridge, and KCS Native paths
                        </p>
                    </div>
                </div>

                <div style="margin-top: 15px; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 8px; text-align: center;">
                    <p style="color: #00D092; margin: 0; font-size: 0.9rem; font-weight: 500;">
                        üí° <strong>Pro Tip:</strong> Fund with USDT = Access to all 32 triangular arbitrage paths (5 sets)
                    </p>
                </div>

                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(0,208,146,0.3);">
                    <p style="color: #888; margin: 0; font-size: 0.85rem; text-align: center;">
                        <strong>Multi-User Platform:</strong> This information helps all users optimize their KuCoin triangular trading setup
                    </p>
                </div>
            </div>

            <!-- KUCOIN Settings Grid -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
                <!-- Risk Management -->
                <div class="stat-card">
                    <h4 style="color: #00D092; margin-bottom: 15px;">‚öñÔ∏è Risk Management</h4>
                    <div class="form-group">
                        <label>Max Single Trade (USDT)</label>
                        <input type="number" id="kucoinMaxTrade" value="100" min="10" max="5000">
                    </div>
                    <div class="form-group">
                        <label>Portfolio % per Trade</label>
                        <input type="number" id="kucoinPortfolioPercent" value="10" min="1" max="50">
                    </div>
                    <div class="form-group">
                        <label>Min Profit Threshold (%)</label>
                        <input type="number" id="kucoinProfitThreshold" value="0.5" min="0.1" max="5" step="0.1">
                    </div>
                </div>

                <!-- Path Categories -->
                <div class="stat-card">
                    <h4 style="color: #00D092; margin-bottom: 15px;">üìä Path Sets (32 Paths in 5 Sets)</h4>
                    <div style="display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center; max-height: 200px; overflow-y: auto;">
                        <span style="color: #00D092; font-size: 0.85rem;">SET 1: ETH Bridge (7 paths)</span>
                        <input type="checkbox" id="kucoinSet1Enabled" checked>

                        <span style="color: #00D092; font-size: 0.85rem;">SET 2: BTC Bridge (7 paths)</span>
                        <input type="checkbox" id="kucoinSet2Enabled" checked>

                        <span style="color: #00D092; font-size: 0.85rem;">SET 3: KCS Native (6 paths)</span>
                        <input type="checkbox" id="kucoinSet3Enabled">

                        <span style="color: #00D092; font-size: 0.85rem;">SET 4: High Volatility (6 paths)</span>
                        <input type="checkbox" id="kucoinSet4Enabled">

                        <span style="color: #00D092; font-size: 0.85rem;">SET 5: Extended (6 paths)</span>
                        <input type="checkbox" id="kucoinSet5Enabled">
                    </div>
                    <div style="margin-top: 10px; padding: 8px; background: rgba(0,208,146,0.1); border-radius: 6px; font-size: 0.8rem; color: #b8c6db;">
                        üí° Sets 1-2 are essential (14 paths). All paths are 3-leg pure triangular arbitrage.
                    </div>
                </div>

                <!-- Performance Stats -->
                <div class="stat-card">
                    <h4 style="color: #00D092; margin-bottom: 15px;">üìà Performance Stats</h4>
                    <div style="display: grid; grid-template-columns: 1fr auto; gap: 10px; font-size: 0.9rem;">
                        <span style="color: #b8c6db;">Total Trades:</span>
                        <span style="color: #00D092;" id="kucoinTotalTrades">0</span>

                        <span style="color: #b8c6db;">Successful Trades:</span>
                        <span style="color: #00D092;" id="kucoinSuccessfulTrades">0</span>

                        <span style="color: #b8c6db;">Success Rate:</span>
                        <span style="color: #00D092;" id="kucoinSuccessRate">0%</span>

                        <span style="color: #b8c6db;">Total Profit:</span>
                        <span style="color: #00D092;" id="kucoinTotalProfit">$0.00</span>

                        <span style="color: #b8c6db;">Best Path:</span>
                        <span style="color: #00D092;" id="kucoinBestPath">-</span>

                        <span style="color: #b8c6db;">Last Scan:</span>
                        <span style="color: #b8c6db;" id="kucoinLastScan">Never</span>
                    </div>
                </div>
            </div>

            <!-- KUCOIN Control Buttons -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                <button onclick="testKuCoinTriangularConnection()" class="btn" disabled style="opacity: 0.4; cursor: not-allowed;">
                    üîç Test Connection
                </button>
                <button onclick="scanKuCoinTriangularPaths()" class="btn" disabled style="opacity: 0.4; cursor: not-allowed;">
                    üîç Scan Opportunities
                </button>
                <button onclick="viewKuCoinPathDetails()" class="btn">
                    üìä View Paths
                </button>
                <button onclick="clearKuCoinTriangularHistory()" class="btn" disabled style="opacity: 0.4; cursor: not-allowed;">
                    üóëÔ∏è Clear History
                </button>
            </div>

            <!-- Tabbed Interface: Balance Tracker & Trading -->
            <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px;">
                <!-- Tab Headers -->
                <div style="display: flex; gap: 10px; margin-bottom: 15px; border-bottom: 2px solid rgba(0,208,146,0.3);">
                    <button id="kucoinBalanceTab" onclick="switchKuCoinTab('balance')" style="flex: 1; padding: 10px; background: rgba(0,208,146,0.3); border: none; border-radius: 8px 8px 0 0; color: #00D092; font-weight: bold; cursor: pointer; transition: all 0.3s;">
                        üí∞ Balance Tracker
                    </button>
                    <button id="kucoinTradingTab" onclick="switchKuCoinTab('trading')" style="flex: 1; padding: 10px; background: rgba(255,255,255,0.05); border: none; border-radius: 8px 8px 0 0; color: #b8c6db; cursor: pointer; transition: all 0.3s;">
                        üíé Current Opportunities
                    </button>
                </div>

                <!-- Balance Tracker Tab Content -->
                <div id="kucoinBalanceContent" style="display: block;">
                    <h4 style="color: #00D092; margin-bottom: 15px;">üí∞ USDT Balance Tracking</h4>
                    <div style="display: grid; grid-template-columns: 1fr; gap: 12px;">
                        <!-- USDT Balance -->
                        <div style="background: rgba(0,208,146,0.1); padding: 12px; border-radius: 8px; border-left: 4px solid #00D092;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; font-size: 0.9rem;">
                                <div>
                                    <div style="color: #888; font-size: 0.8rem; margin-bottom: 5px;">Starting</div>
                                    <div style="color: #00D092; font-weight: bold;" id="kucoinStartingUSDT">$0.00</div>
                                </div>
                                <div>
                                    <div style="color: #888; font-size: 0.8rem; margin-bottom: 5px;">Current</div>
                                    <div style="color: #00D092; font-weight: bold;" id="kucoinCurrentUSDT">$0.00</div>
                                </div>
                                <div>
                                    <div style="color: #888; font-size: 0.8rem; margin-bottom: 5px;">Change</div>
                                    <div style="color: #b8c6db; font-weight: bold;" id="kucoinChangeUSDT">$0.00 (0.0%)</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div style="margin-top: 10px; padding: 8px; background: rgba(0,208,146,0.1); border-radius: 6px; font-size: 0.8rem; color: #888; text-align: center;">
                        üí° Balance updates automatically when scanning opportunities
                    </div>
                </div>

                <!-- Trading Tab Content -->
                <div id="kucoinTradingContent" style="display: none;">
                    <h4 style="color: #00D092; margin-bottom: 15px;">üíé Current Opportunities</h4>
                    <div id="kucoinOpportunities" style="max-height: 200px; overflow-y: auto;">
                        <div style="text-align: center; color: #888; padding: 20px;">
                            Click "Scan Opportunities" to find triangular arbitrage paths
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Huobi (HTX) Exchange -->
        <div id="huobi-card" style="display: none; background: rgba(45,108,248,0.1); padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 2px solid #2D6CF8;">
            <!-- Header with toggle -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: #2D6CF8; margin: 0;">üî∑ HUOBI (HTX) Triangular Arbitrage</h3>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <span style="color: #b8c6db; font-size: 0.9rem;">HTX Live Trading:</span>
                    <div class="toggle-switch" id="huobiTriangularEnabled" onclick="toggleHuobiTriangular()">
                        <div class="toggle-knob"></div>
                    </div>
                    <span id="huobiTriangularStatus" style="color: #ff6b6b; font-size: 0.9rem; margin-left: 10px;">OFF</span>
                </div>
            </div>

            <!-- FUNDING REQUIREMENTS Info Banner -->
            <div style="background: rgba(45,108,248,0.15); border: 2px solid #2D6CF8; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                <div style="text-align: center;">
                    <h4 style="color: #2D6CF8; margin: 0 0 10px 0; font-size: 1.2rem;">üí∞ Funding Requirements for Maximum Coverage</h4>
                    <p style="color: #b8c6db; margin: 0 0 15px 0; font-size: 0.95rem;">
                        HTX supports <strong style="color: #2D6CF8;">31 triangular arbitrage paths</strong> across <strong>1 fundable currency</strong>.
                    </p>
                </div>

                <!-- USDT Currency Details -->
                <div style="background: rgba(45,108,248,0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #2D6CF8;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h5 style="color: #2D6CF8; margin: 0; font-size: 1.1rem;">üíµ USDT (Tether)</h5>
                        <span style="color: #00d26a; font-weight: bold; font-size: 0.9rem;">‚úì REQUIRED</span>
                    </div>
                    <div style="color: #b8c6db; font-size: 0.9rem; line-height: 1.6;">
                        <div style="margin-bottom: 8px;">
                            <strong style="color: #2D6CF8;">Coverage:</strong> All 31 paths (100% coverage)
                        </div>
                        <div style="margin-bottom: 8px;">
                            <strong style="color: #2D6CF8;">Path Sets:</strong>
                            <ul style="margin: 5px 0; padding-left: 20px;">
                                <li>SET 1: Essential ETH Bridge (7 paths)</li>
                                <li>SET 2: Mid-Cap BTC Bridge (7 paths)</li>
                                <li>SET 3: HT Native Bridge (6 paths)</li>
                                <li>SET 4: High Volatility (6 paths)</li>
                                <li>SET 5: Extended Multi-Bridge (5 paths)</li>
                            </ul>
                        </div>
                        <div style="background: rgba(45,108,248,0.15); padding: 8px; border-radius: 5px; margin-top: 10px;">
                            üí° <strong>Recommendation:</strong> Fund HTX with USDT only - covers all triangular arbitrage opportunities
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Grid: Risk Management, Path Sets, Performance Stats -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">

                <!-- Risk Management -->
                <div class="stat-card">
                    <h4 style="color: #2D6CF8; margin-bottom: 15px;">‚öñÔ∏è Risk Management</h4>
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #b8c6db;">Max Trade (USDT)</label>
                        <input type="number" id="huobiMaxTrade" value="1000" min="10" max="10000" step="10"
                               style="width: 100%; padding: 8px; border: 1px solid #2D6CF8; border-radius: 5px; background: rgba(45,108,248,0.05); color: #fff;">
                    </div>
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #b8c6db;">Portfolio % per Trade</label>
                        <input type="number" id="huobiPortfolioPercent" value="10" min="1" max="50" step="1"
                               style="width: 100%; padding: 8px; border: 1px solid #2D6CF8; border-radius: 5px; background: rgba(45,108,248,0.05); color: #fff;">
                    </div>
                    <div class="form-group">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #b8c6db;">Min Profit % Threshold</label>
                        <input type="number" id="huobiProfitThreshold" value="0.5" min="0.1" max="5" step="0.1"
                               style="width: 100%; padding: 8px; border: 1px solid #2D6CF8; border-radius: 5px; background: rgba(45,108,248,0.05); color: #fff;">
                    </div>
                </div>

                <!-- Path Sets - Compact Grid -->
                <div class="stat-card">
                    <h4 style="color: #2D6CF8; margin-bottom: 15px;">üìä Path Sets (31 Paths in 5 Sets)</h4>
                    <div style="display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center;">
                        <span style="color: #2D6CF8; font-size: 0.85rem;">SET 1: ETH Bridge (7 paths)</span>
                        <input type="checkbox" id="huobiSet1Enabled" checked>

                        <span style="color: #2D6CF8; font-size: 0.85rem;">SET 2: BTC Bridge (7 paths)</span>
                        <input type="checkbox" id="huobiSet2Enabled" checked>

                        <span style="color: #888; font-size: 0.85rem;">SET 3: HT Native (6 paths)</span>
                        <input type="checkbox" id="huobiSet3Enabled">

                        <span style="color: #888; font-size: 0.85rem;">SET 4: High Vol (6 paths)</span>
                        <input type="checkbox" id="huobiSet4Enabled">

                        <span style="color: #888; font-size: 0.85rem;">SET 5: Extended (5 paths)</span>
                        <input type="checkbox" id="huobiSet5Enabled">
                    </div>
                    <div style="margin-top: 12px; padding: 8px; background: rgba(45,108,248,0.1); border-radius: 6px; font-size: 0.8rem; color: #888; text-align: center;">
                        üí° Sets 1-2 enabled by default (14 paths)
                    </div>
                </div>

                <!-- Performance Stats -->
                <div class="stat-card">
                    <h4 style="color: #2D6CF8; margin-bottom: 15px;">üìà Performance Stats</h4>
                    <div style="display: grid; grid-template-columns: 1fr auto; gap: 10px; font-size: 0.9rem;">
                        <span style="color: #b8c6db;">Total Trades:</span>
                        <span style="color: #2D6CF8;" id="huobiTotalTrades">0</span>

                        <span style="color: #b8c6db;">Success Rate:</span>
                        <span style="color: #2D6CF8;" id="huobiSuccessRate">0%</span>

                        <span style="color: #b8c6db;">Avg Profit:</span>
                        <span style="color: #2D6CF8;" id="huobiAvgProfit">$0.00</span>

                        <span style="color: #b8c6db;">Total Profit:</span>
                        <span style="color: #00d26a; font-weight: bold;" id="huobiTotalProfit">$0.00</span>

                        <span style="color: #b8c6db;">Best Path:</span>
                        <span style="color: #2D6CF8; font-size: 0.8rem;" id="huobiBestPath">-</span>

                        <span style="color: #b8c6db;">Last Scan:</span>
                        <span style="color: #888; font-size: 0.8rem;" id="huobiLastScan">Never</span>
                    </div>
                </div>
            </div>

            <!-- HTX Control Buttons -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                <button onclick="testHuobiTriangularConnection()" class="btn" disabled style="opacity: 0.4; cursor: not-allowed;">
                    üîç Test Connection
                </button>
                <button onclick="scanHuobiTriangularPaths()" class="btn" disabled style="opacity: 0.4; cursor: not-allowed;">
                    üîç Scan Opportunities
                </button>
                <button onclick="viewHuobiPathDetails()" class="btn">
                    üìä View Paths
                </button>
                <button onclick="clearHuobiTriangularHistory()" class="btn" disabled style="opacity: 0.4; cursor: not-allowed;">
                    üóëÔ∏è Clear History
                </button>
            </div>

            <!-- Tabbed Interface: Balance Tracker & Trading -->
            <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px;">
                <!-- Tab Headers -->
                <div style="display: flex; gap: 10px; margin-bottom: 15px; border-bottom: 2px solid rgba(45,108,248,0.3);">
                    <button id="huobiBalanceTab" onclick="switchHuobiTab('balance')" style="flex: 1; padding: 10px; background: rgba(45,108,248,0.3); border: none; border-radius: 8px 8px 0 0; color: #2D6CF8; font-weight: bold; cursor: pointer; transition: all 0.3s;">
                        üí∞ Balance Tracker
                    </button>
                    <button id="huobiTradingTab" onclick="switchHuobiTab('trading')" style="flex: 1; padding: 10px; background: rgba(255,255,255,0.05); border: none; border-radius: 8px 8px 0 0; color: #b8c6db; cursor: pointer; transition: all 0.3s;">
                        üíé Current Opportunities
                    </button>
                </div>

                <!-- Balance Tracker Tab Content -->
                <div id="huobiBalanceContent" style="display: block;">
                    <h4 style="color: #2D6CF8; margin-bottom: 15px;">üí∞ USDT Balance Tracking</h4>
                    <div style="display: grid; grid-template-columns: 1fr; gap: 12px;">
                        <!-- USDT Balance -->
                        <div style="background: rgba(45,108,248,0.1); padding: 12px; border-radius: 8px; border-left: 4px solid #2D6CF8;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; font-size: 0.9rem;">
                                <div>
                                    <div style="color: #888; font-size: 0.8rem; margin-bottom: 5px;">Starting</div>
                                    <div style="color: #2D6CF8; font-weight: bold;" id="huobiStartingUSDT">$0.00</div>
                                </div>
                                <div>
                                    <div style="color: #888; font-size: 0.8rem; margin-bottom: 5px;">Current</div>
                                    <div style="color: #2D6CF8; font-weight: bold;" id="huobiCurrentUSDT">$0.00</div>
                                </div>
                                <div>
                                    <div style="color: #888; font-size: 0.8rem; margin-bottom: 5px;">Change</div>
                                    <div style="color: #b8c6db; font-weight: bold;" id="huobiChangeUSDT">$0.00 (0.0%)</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div style="margin-top: 10px; padding: 8px; background: rgba(45,108,248,0.1); border-radius: 6px; font-size: 0.8rem; color: #888; text-align: center;">
                        üí° Balance updates automatically when scanning opportunities
                    </div>
                </div>

                <!-- Trading Tab Content -->
                <div id="huobiTradingContent" style="display: none;">
                    <h4 style="color: #2D6CF8; margin-bottom: 15px;">üíé Current Opportunities</h4>
                    <div id="huobiOpportunities" style="max-height: 200px; overflow-y: auto;">
                        <div style="text-align: center; color: #888; padding: 20px;">
                            Click "Scan Opportunities" to find triangular arbitrage paths
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gate.io Exchange -->
        <div id="gateio-card" style="display: none; background: rgba(23,199,132,0.1); padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 2px solid #17C784;">
            <!-- Header with toggle -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: #17C784; margin: 0;">üåø GATE.IO Triangular Arbitrage</h3>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <span style="color: #b8c6db; font-size: 0.9rem;">Gate.io Live Trading:</span>
                    <div class="toggle-switch" id="gateioTriangularEnabled" onclick="toggleGateioTriangular()">
                        <div class="toggle-knob"></div>
                    </div>
                    <span id="gateioTriangularStatus" style="color: #ff6b6b; font-size: 0.9rem; margin-left: 10px;">OFF</span>
                </div>
            </div>

            <!-- FUNDING REQUIREMENTS Info Banner -->
            <div style="background: rgba(23,199,132,0.15); border: 2px solid #17C784; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                <div style="text-align: center;">
                    <h4 style="color: #17C784; margin: 0 0 10px 0; font-size: 1.2rem;">üí∞ Funding Requirements for Maximum Coverage</h4>
                    <p style="color: #b8c6db; margin: 0 0 15px 0; font-size: 0.95rem;">
                        Gate.io supports <strong style="color: #17C784;">32 triangular arbitrage paths</strong> across <strong>1 fundable currency</strong>.
                    </p>
                </div>

                <!-- USDT Currency Details -->
                <div style="background: rgba(23,199,132,0.1); border-left: 4px solid #17C784; padding: 15px; border-radius: 8px; margin-top: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h5 style="color: #17C784; margin: 0; font-size: 1.1rem;">üíµ USDT (Tether)</h5>
                        <span style="background: #17C784; color: white; padding: 4px 12px; border-radius: 12px; font-weight: 600; font-size: 0.9rem;">32 paths</span>
                    </div>
                    <p style="color: #b8c6db; margin: 10px 0; font-size: 0.9rem;">
                        <strong>Required for:</strong> All 32 triangular arbitrage paths (5 sets total)
                    </p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; font-size: 0.85rem; color: #b8c6db;">
                        <div>‚Ä¢ <strong style="color: #17C784;">SET 1:</strong> ETH Bridge (7 paths)</div>
                        <div>‚Ä¢ <strong style="color: #17C784;">SET 2:</strong> BTC Bridge (7 paths)</div>
                        <div>‚Ä¢ <strong style="color: #17C784;">SET 3:</strong> GT Native (6 paths)</div>
                        <div>‚Ä¢ <strong style="color: #17C784;">SET 4:</strong> High Volatility (6 paths)</div>
                        <div style="grid-column: 1 / -1;">‚Ä¢ <strong style="color: #17C784;">SET 5:</strong> Extended Multi-Bridge (6 paths, includes 2 four-leg paths)</div>
                    </div>
                    <p style="color: #888; margin: 15px 0 0 0; font-size: 0.8rem; font-style: italic;">
                        üí° Recommended minimum: Fund USDT on Gate.io for maximum arbitrage coverage
                    </p>
                </div>
            </div>

            <!-- Settings Grid: Risk Management, Path Sets, Performance Stats -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
                <!-- Risk Management -->
                <div class="stat-card">
                    <h4 style="color: #17C784; margin-bottom: 15px;">‚öñÔ∏è Risk Management</h4>
                    <label style="display: block; color: #888; margin-bottom: 5px; font-size: 14px;">Max Trade Amount (USDT)</label>
                    <input type="number" id="gateioMaxTrade" value="1000" min="10" max="10000" step="10" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid #444; border-radius: 8px; color: white; margin-bottom: 15px;" onchange="saveGateioTriangularSettings()">

                    <label style="display: block; color: #888; margin-bottom: 5px; font-size: 14px;">Portfolio % Risk</label>
                    <input type="number" id="gateioPortfolioPercent" value="10" min="1" max="100" step="1" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid #444; border-radius: 8px; color: white; margin-bottom: 15px;" onchange="saveGateioTriangularSettings()">

                    <label style="display: block; color: #888; margin-bottom: 5px; font-size: 14px;">Min Profit Threshold (%)</label>
                    <input type="number" id="gateioProfitThreshold" value="0.5" min="0.1" max="5" step="0.1" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid #444; border-radius: 8px; color: white;" onchange="saveGateioTriangularSettings()">
                </div>

                <!-- Path Sets - Compact Grid -->
                <div class="stat-card">
                    <h4 style="color: #17C784; margin-bottom: 15px;">üìä Path Sets (32 Paths in 5 Sets)</h4>
                    <div style="display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center;">
                        <span style="color: #17C784; font-size: 0.85rem;">SET 1: ETH Bridge (7 paths)</span>
                        <input type="checkbox" id="gateioSet1Enabled" checked onchange="saveGateioTriangularSettings()">

                        <span style="color: #17C784; font-size: 0.85rem;">SET 2: BTC Bridge (7 paths)</span>
                        <input type="checkbox" id="gateioSet2Enabled" checked onchange="saveGateioTriangularSettings()">

                        <span style="color: #888; font-size: 0.85rem;">SET 3: GT Native (6 paths)</span>
                        <input type="checkbox" id="gateioSet3Enabled" onchange="saveGateioTriangularSettings()">

                        <span style="color: #888; font-size: 0.85rem;">SET 4: High Volatility (6 paths)</span>
                        <input type="checkbox" id="gateioSet4Enabled" onchange="saveGateioTriangularSettings()">

                        <span style="color: #888; font-size: 0.85rem;">SET 5: Extended Multi (6 paths)</span>
                        <input type="checkbox" id="gateioSet5Enabled" onchange="saveGateioTriangularSettings()">
                    </div>
                </div>

                <!-- Performance Stats -->
                <div class="stat-card">
                    <h4 style="color: #17C784; margin-bottom: 15px;">üìà Performance Stats</h4>
                    <div style="display: grid; grid-template-columns: 1fr auto; gap: 10px; font-size: 0.9rem;">
                        <span style="color: #b8c6db;">Total Trades:</span>
                        <span style="color: #17C784;" id="gateioTotalTrades">0</span>

                        <span style="color: #b8c6db;">Success Rate:</span>
                        <span style="color: #17C784;" id="gateioSuccessRate">0%</span>

                        <span style="color: #b8c6db;">Avg Profit:</span>
                        <span style="color: #17C784;" id="gateioAvgProfit">$0.00</span>

                        <span style="color: #b8c6db;">Total Profit:</span>
                        <span style="color: #17C784;" id="gateioTotalProfit">$0.00</span>

                        <span style="color: #b8c6db;">Best Path:</span>
                        <span style="color: #17C784; font-size: 0.75rem;" id="gateioBestPath">-</span>

                        <span style="color: #b8c6db;">Last Scan:</span>
                        <span style="color: #888; font-size: 0.75rem;" id="gateioLastScan">Never</span>
                    </div>
                </div>
            </div>

            <!-- Gate.io Control Buttons -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                <button onclick="testGateioTriangularConnection()" class="btn" disabled style="opacity: 0.4; cursor: not-allowed;">
                    üîç Test Connection
                </button>
                <button onclick="scanGateioTriangularPaths()" class="btn" disabled style="opacity: 0.4; cursor: not-allowed;">
                    üîç Scan Opportunities
                </button>
                <button onclick="viewGateioPathDetails()" class="btn">
                    üìä View Paths
                </button>
                <button onclick="clearGateioTriangularHistory()" class="btn" disabled style="opacity: 0.4; cursor: not-allowed;">
                    üóëÔ∏è Clear History
                </button>
            </div>

            <!-- Tabbed Interface: Balance Tracker & Trading -->
            <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px;">
                <!-- Tab Headers -->
                <div style="display: flex; gap: 10px; margin-bottom: 15px; border-bottom: 2px solid rgba(23,199,132,0.3);">
                    <button id="gateioBalanceTab" onclick="switchGateioTab('balance')" style="flex: 1; padding: 10px; background: rgba(23,199,132,0.3); border: none; border-radius: 8px 8px 0 0; color: #17C784; font-weight: bold; cursor: pointer; transition: all 0.3s;">
                        üí∞ Balance Tracker
                    </button>
                    <button id="gateioTradingTab" onclick="switchGateioTab('trading')" style="flex: 1; padding: 10px; background: rgba(255,255,255,0.05); border: none; border-radius: 8px 8px 0 0; color: #b8c6db; cursor: pointer; transition: all 0.3s;">
                        üíé Current Opportunities
                    </button>
                </div>

                <!-- Balance Tracker Tab Content -->
                <div id="gateioBalanceContent" style="display: block;">
                    <h4 style="color: #17C784; margin-bottom: 15px;">üí∞ USDT Balance Tracking</h4>
                    <div style="display: grid; grid-template-columns: 1fr; gap: 12px;">
                        <div style="background: rgba(23,199,132,0.1); padding: 12px; border-radius: 8px; border-left: 4px solid #17C784;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; font-size: 0.9rem;">
                                <div>
                                    <div style="color: #888; font-size: 0.8rem; margin-bottom: 5px;">Starting</div>
                                    <div style="color: #17C784; font-weight: bold;" id="gateioStartingUSDT">$0.00</div>
                                </div>
                                <div>
                                    <div style="color: #888; font-size: 0.8rem; margin-bottom: 5px;">Current</div>
                                    <div style="color: #17C784; font-weight: bold;" id="gateioCurrentUSDT">$0.00</div>
                                </div>
                                <div>
                                    <div style="color: #888; font-size: 0.8rem; margin-bottom: 5px;">Change</div>
                                    <div style="color: #b8c6db; font-weight: bold;" id="gateioChangeUSDT">$0.00 (0.0%)</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Trading Tab Content -->
                <div id="gateioTradingContent" style="display: none;">
                    <h4 style="color: #17C784; margin-bottom: 15px;">üíé Current Opportunities</h4>
                    <div id="gateioOpportunities" style="max-height: 200px; overflow-y: auto;">
                        <div style="text-align: center; color: #888; padding: 20px;">
                            Click "Scan Opportunities" to find triangular arbitrage paths
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Crypto.com Exchange -->
        <div id="cryptocom-card" style="display: none; background: rgba(0,45,116,0.1); padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 2px solid #002D74;">
            <!-- Header with toggle -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: #0066FF; margin: 0;">üíé CRYPTO.COM Triangular Arbitrage</h3>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <span style="color: #b8c6db; font-size: 0.9rem;">Crypto.com Live Trading:</span>
                    <div class="toggle-switch" id="cryptocomTriangularEnabled" onclick="toggleCryptocomTriangular()">
                        <div class="toggle-knob"></div>
                    </div>
                    <span id="cryptocomTriangularStatus" style="color: #ff6b6b; font-size: 0.9rem; margin-left: 10px;">OFF</span>
                </div>
            </div>

            <!-- FUNDING REQUIREMENTS Info Banner -->
            <div style="background: rgba(0,102,255,0.15); border: 2px solid #0066FF; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                <div style="text-align: center;">
                    <h4 style="color: #0066FF; margin: 0 0 10px 0; font-size: 1.2rem;">üí∞ Funding Requirements for Maximum Coverage</h4>
                    <p style="color: #b8c6db; margin: 0 0 15px 0; font-size: 0.95rem;">
                        Crypto.com supports <strong style="color: #0066FF;">32 triangular arbitrage paths</strong> across <strong>1 fundable currency</strong>.
                    </p>
                </div>

                <!-- USDT Currency Details -->
                <div style="background: rgba(0,102,255,0.1); border-left: 4px solid #0066FF; padding: 15px; border-radius: 8px; margin-top: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h5 style="color: #0066FF; margin: 0; font-size: 1.1rem;">üíµ USDT (Tether)</h5>
                        <span style="background: #0066FF; color: white; padding: 4px 12px; border-radius: 12px; font-weight: 600; font-size: 0.9rem;">32 paths</span>
                    </div>
                    <p style="color: #b8c6db; margin: 10px 0; font-size: 0.9rem;">
                        <strong>Required for:</strong> All 32 triangular arbitrage paths (5 sets total)
                    </p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; font-size: 0.85rem; color: #b8c6db;">
                        <div>‚Ä¢ <strong style="color: #0066FF;">SET 1:</strong> ETH Bridge (7 paths)</div>
                        <div>‚Ä¢ <strong style="color: #0066FF;">SET 2:</strong> BTC Bridge (7 paths)</div>
                        <div>‚Ä¢ <strong style="color: #0066FF;">SET 3:</strong> CRO Native (6 paths)</div>
                        <div>‚Ä¢ <strong style="color: #0066FF;">SET 4:</strong> High Volatility (6 paths)</div>
                        <div style="grid-column: 1 / -1;">‚Ä¢ <strong style="color: #0066FF;">SET 5:</strong> Extended Multi-Bridge (6 paths, includes 2 four-leg paths)</div>
                    </div>
                    <p style="color: #888; margin: 15px 0 0 0; font-size: 0.8rem; font-style: italic;">
                        üí° Recommended minimum: Fund USDT on Crypto.com for maximum arbitrage coverage
                    </p>
                </div>
            </div>

            <!-- Settings Grid: Risk Management, Path Sets, Performance Stats -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
                <!-- Risk Management -->
                <div class="stat-card">
                    <h4 style="color: #0066FF; margin-bottom: 15px;">‚öñÔ∏è Risk Management</h4>
                    <label style="display: block; color: #888; margin-bottom: 5px; font-size: 14px;">Max Trade Amount (USDT)</label>
                    <input type="number" id="cryptocomMaxTrade" value="1000" min="10" max="10000" step="10" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid #444; border-radius: 8px; color: white; margin-bottom: 15px;" onchange="saveCryptocomTriangularSettings()">

                    <label style="display: block; color: #888; margin-bottom: 5px; font-size: 14px;">Portfolio % Risk</label>
                    <input type="number" id="cryptocomPortfolioPercent" value="10" min="1" max="100" step="1" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid #444; border-radius: 8px; color: white; margin-bottom: 15px;" onchange="saveCryptocomTriangularSettings()">

                    <label style="display: block; color: #888; margin-bottom: 5px; font-size: 14px;">Min Profit Threshold (%)</label>
                    <input type="number" id="cryptocomProfitThreshold" value="0.5" min="0.1" max="5" step="0.1" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid #444; border-radius: 8px; color: white;" onchange="saveCryptocomTriangularSettings()">
                </div>

                <!-- Path Sets - Compact Grid -->
                <div class="stat-card">
                    <h4 style="color: #0066FF; margin-bottom: 15px;">üìä Path Sets (32 Paths in 5 Sets)</h4>
                    <div style="display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center;">
                        <span style="color: #0066FF; font-size: 0.85rem;">SET 1: ETH Bridge (7 paths)</span>
                        <input type="checkbox" id="cryptocomSet1Enabled" checked onchange="saveCryptocomTriangularSettings()">

                        <span style="color: #0066FF; font-size: 0.85rem;">SET 2: BTC Bridge (7 paths)</span>
                        <input type="checkbox" id="cryptocomSet2Enabled" checked onchange="saveCryptocomTriangularSettings()">

                        <span style="color: #888; font-size: 0.85rem;">SET 3: CRO Native (6 paths)</span>
                        <input type="checkbox" id="cryptocomSet3Enabled" onchange="saveCryptocomTriangularSettings()">

                        <span style="color: #888; font-size: 0.85rem;">SET 4: High Volatility (6 paths)</span>
                        <input type="checkbox" id="cryptocomSet4Enabled" onchange="saveCryptocomTriangularSettings()">

                        <span style="color: #888; font-size: 0.85rem;">SET 5: Extended Multi (6 paths)</span>
                        <input type="checkbox" id="cryptocomSet5Enabled" onchange="saveCryptocomTriangularSettings()">
                    </div>
                </div>

                <!-- Performance Stats -->
                <div class="stat-card">
                    <h4 style="color: #0066FF; margin-bottom: 15px;">üìà Performance Stats</h4>
                    <div style="display: grid; grid-template-columns: 1fr auto; gap: 10px; font-size: 0.9rem;">
                        <span style="color: #b8c6db;">Total Trades:</span>
                        <span style="color: #0066FF;" id="cryptocomTotalTrades">0</span>

                        <span style="color: #b8c6db;">Success Rate:</span>
                        <span style="color: #0066FF;" id="cryptocomSuccessRate">0%</span>

                        <span style="color: #b8c6db;">Avg Profit:</span>
                        <span style="color: #0066FF;" id="cryptocomAvgProfit">$0.00</span>

                        <span style="color: #b8c6db;">Total Profit:</span>
                        <span style="color: #0066FF;" id="cryptocomTotalProfit">$0.00</span>

                        <span style="color: #b8c6db;">Best Path:</span>
                        <span style="color: #0066FF; font-size: 0.75rem;" id="cryptocomBestPath">-</span>

                        <span style="color: #b8c6db;">Last Scan:</span>
                        <span style="color: #888; font-size: 0.75rem;" id="cryptocomLastScan">Never</span>
                    </div>
                </div>
            </div>

            <!-- Crypto.com Control Buttons -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                <button onclick="testCryptocomTriangularConnection()" class="btn" disabled style="opacity: 0.4; cursor: not-allowed;">
                    üîç Test Connection
                </button>
                <button onclick="scanCryptocomTriangularPaths()" class="btn" disabled style="opacity: 0.4; cursor: not-allowed;">
                    üîç Scan Opportunities
                </button>
                <button onclick="viewCryptocomPathDetails()" class="btn">
                    üìä View Paths
                </button>
                <button onclick="clearCryptocomTriangularHistory()" class="btn" disabled style="opacity: 0.4; cursor: not-allowed;">
                    üóëÔ∏è Clear History
                </button>
            </div>

            <!-- Tabbed Interface: Balance Tracker & Trading -->
            <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px;">
                <!-- Tab Headers -->
                <div style="display: flex; gap: 10px; margin-bottom: 15px; border-bottom: 2px solid rgba(0,102,255,0.3);">
                    <button id="cryptocomBalanceTab" onclick="switchCryptocomTab('balance')" style="flex: 1; padding: 10px; background: rgba(0,102,255,0.3); border: none; border-radius: 8px 8px 0 0; color: #0066FF; font-weight: bold; cursor: pointer; transition: all 0.3s;">
                        üí∞ Balance Tracker
                    </button>
                    <button id="cryptocomTradingTab" onclick="switchCryptocomTab('trading')" style="flex: 1; padding: 10px; background: rgba(255,255,255,0.05); border: none; border-radius: 8px 8px 0 0; color: #b8c6db; cursor: pointer; transition: all 0.3s;">
                        üíé Current Opportunities
                    </button>
                </div>

                <!-- Balance Tracker Tab Content -->
                <div id="cryptocomBalanceContent" style="display: block;">
                    <h4 style="color: #0066FF; margin-bottom: 15px;">üí∞ USDT Balance Tracking</h4>
                    <div style="display: grid; grid-template-columns: 1fr; gap: 12px;">
                        <div style="background: rgba(0,102,255,0.1); padding: 12px; border-radius: 8px; border-left: 4px solid #0066FF;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; font-size: 0.9rem;">
                                <div>
                                    <div style="color: #888; font-size: 0.8rem; margin-bottom: 5px;">Starting</div>
                                    <div style="color: #0066FF; font-weight: bold;" id="cryptocomStartingUSDT">$0.00</div>
                                </div>
                                <div>
                                    <div style="color: #888; font-size: 0.8rem; margin-bottom: 5px;">Current</div>
                                    <div style="color: #0066FF; font-weight: bold;" id="cryptocomCurrentUSDT">$0.00</div>
                                </div>
                                <div>
                                    <div style="color: #888; font-size: 0.8rem; margin-bottom: 5px;">Change</div>
                                    <div style="color: #b8c6db; font-weight: bold;" id="cryptocomChangeUSDT">$0.00 (0.0%)</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Trading Tab Content -->
                <div id="cryptocomTradingContent" style="display: none;">
                    <h4 style="color: #0066FF; margin-bottom: 15px;">üíé Current Opportunities</h4>
                    <div id="cryptocomOpportunities" style="max-height: 200px; overflow-y: auto;">
                        <div style="text-align: center; color: #888; padding: 20px;">
                            Click "Scan Opportunities" to find triangular arbitrage paths
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- MEXC Exchange -->
        <div id="mexc-card" style="display: none; background: rgba(255,165,0,0.1); padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 2px solid #FFA500;">
            <!-- Header with toggle -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: #FFA500; margin: 0;">üü† MEXC Triangular Arbitrage</h3>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <span style="color: #b8c6db; font-size: 0.9rem;">MEXC Live Trading:</span>
                    <div class="toggle-switch" id="mexcTriangularEnabled" onclick="toggleMexcTriangular()">
                        <div class="toggle-knob"></div>
                    </div>
                    <span id="mexcTriangularStatus" style="color: #ff6b6b; font-size: 0.9rem; margin-left: 10px;">OFF</span>
                </div>
            </div>

            <!-- FUNDING REQUIREMENTS Info Banner -->
            <div style="background: rgba(255,165,0,0.15); border: 2px solid #FFA500; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                <div style="text-align: center;">
                    <h4 style="color: #FFA500; margin: 0 0 10px 0; font-size: 1.2rem;">üí∞ Funding Requirements for Maximum Coverage</h4>
                    <p style="color: #b8c6db; margin: 0 0 15px 0; font-size: 0.95rem;">
                        MEXC supports <strong style="color: #FFA500;">32 triangular arbitrage paths</strong> across <strong>1 fundable currency</strong>.
                    </p>
                </div>

                <!-- USDT currency details with all 5 sets listed -->
                <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; border-left: 4px solid #FFA500;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="color: #FFA500; font-size: 1.5rem;">üíµ</span>
                            <div>
                                <div style="color: #FFA500; font-weight: 600; font-size: 1.1rem;">USDT (Tether)</div>
                                <div style="color: #888; font-size: 0.85rem;">Base Currency - Fund MEXC with USDT only</div>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="color: #FFA500; font-weight: 600; font-size: 1.2rem;">32 Paths</div>
                            <div style="color: #888; font-size: 0.85rem;">2,908+ pairs</div>
                        </div>
                    </div>
                    <div style="color: #b8c6db; font-size: 0.9rem; line-height: 1.6;">
                        <strong style="color: #FFA500;">Path Sets Included:</strong><br>
                        ‚Ä¢ <strong>Set 1:</strong> Essential ETH Bridge (7 paths) - ETH/BTC/SOL/XRP/ADA/MATIC/DOT/AVAX<br>
                        ‚Ä¢ <strong>Set 2:</strong> Mid-Cap BTC Bridge (7 paths) - BTC/ETH/SOL/XRP/LTC/LINK/ATOM/UNI<br>
                        ‚Ä¢ <strong>Set 3:</strong> MX Native Bridge (6 paths) - MX token (0% fees!) / BTC/ETH/SOL/BNB<br>
                        ‚Ä¢ <strong>Set 4:</strong> High Volatility (6 paths) - DOGE/SHIB/PEPE/FLOKI/TON/SUI<br>
                        ‚Ä¢ <strong>Set 5:</strong> Extended Multi-Bridge (6 paths) - Includes 2 four-leg paths
                    </div>
                </div>
            </div>

            <!-- Settings Grid: Risk Management, Path Sets, Performance Stats -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
                <!-- Risk Management -->
                <div class="stat-card">
                    <h4 style="color: #FFA500; margin-bottom: 15px;">‚öñÔ∏è Risk Management</h4>
                    <label style="display: block; color: #888; margin-bottom: 5px; font-size: 14px;">Max Trade Amount (USDT)</label>
                    <input type="number" id="mexcMaxTrade" value="1000" min="10" max="10000" step="10"
                           onchange="saveMexcTriangularSettings()"
                           style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid #444; border-radius: 8px; color: white; margin-bottom: 15px;">

                    <label style="display: block; color: #888; margin-bottom: 5px; font-size: 14px;">Portfolio % Risk</label>
                    <input type="number" id="mexcPortfolioPercent" value="10" min="1" max="20" step="1"
                           onchange="saveMexcTriangularSettings()"
                           style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid #444; border-radius: 8px; color: white; margin-bottom: 15px;">

                    <label style="display: block; color: #888; margin-bottom: 5px; font-size: 14px;">Min Profit Threshold (%)</label>
                    <input type="number" id="mexcProfitThreshold" value="0.5" min="0.1" max="5" step="0.1"
                           onchange="saveMexcTriangularSettings()"
                           style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid #444; border-radius: 8px; color: white;">
                </div>

                <!-- Path Sets (Compact 2-column grid) -->
                <div class="stat-card">
                    <h4 style="color: #FFA500; margin-bottom: 15px;">üîÄ Path Sets (32 Total)</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.85rem;">
                            <input type="checkbox" id="mexcSet1Enabled" checked onchange="saveMexcTriangularSettings()" style="width: 16px; height: 16px; cursor: pointer;">
                            <span style="color: #ddd;">‚úÖ Set 1 (7)</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.85rem;">
                            <input type="checkbox" id="mexcSet2Enabled" checked onchange="saveMexcTriangularSettings()" style="width: 16px; height: 16px; cursor: pointer;">
                            <span style="color: #ddd;">‚úÖ Set 2 (7)</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.85rem;">
                            <input type="checkbox" id="mexcSet3Enabled" onchange="saveMexcTriangularSettings()" style="width: 16px; height: 16px; cursor: pointer;">
                            <span style="color: #ddd;">üü† Set 3 (6)</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.85rem;">
                            <input type="checkbox" id="mexcSet4Enabled" onchange="saveMexcTriangularSettings()" style="width: 16px; height: 16px; cursor: pointer;">
                            <span style="color: #ddd;">‚ö° Set 4 (6)</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.85rem; grid-column: 1 / -1;">
                            <input type="checkbox" id="mexcSet5Enabled" onchange="saveMexcTriangularSettings()" style="width: 16px; height: 16px; cursor: pointer;">
                            <span style="color: #ddd;">üîÅ Set 5 (6)</span>
                        </label>
                    </div>
                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,165,0,0.2); font-size: 0.8rem; color: #888; text-align: center;">
                        ETH Bridge ‚Ä¢ BTC Bridge ‚Ä¢ MX Native ‚Ä¢ Volatility ‚Ä¢ Extended
                    </div>
                </div>

                <!-- Performance Stats -->
                <div class="stat-card">
                    <h4 style="color: #FFA500; margin-bottom: 15px;">üìä Performance Stats</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.85rem;">
                        <div>
                            <div style="color: #888;">Total Trades</div>
                            <div style="color: #FFA500; font-weight: 600;" id="mexcTotalTrades">0</div>
                        </div>
                        <div>
                            <div style="color: #888;">Success Rate</div>
                            <div style="color: #FFA500; font-weight: 600;" id="mexcSuccessRate">0%</div>
                        </div>
                        <div>
                            <div style="color: #888;">Avg Profit</div>
                            <div style="color: #FFA500; font-weight: 600;" id="mexcAvgProfit">$0.00</div>
                        </div>
                        <div>
                            <div style="color: #888;">Total Profit</div>
                            <div style="color: #FFA500; font-weight: 600;" id="mexcTotalProfit">$0.00</div>
                        </div>
                        <div style="grid-column: 1 / -1;">
                            <div style="color: #888;">Best Path</div>
                            <div style="color: #FFA500; font-weight: 600; font-size: 0.75rem;" id="mexcBestPath">‚Äî</div>
                        </div>
                        <div style="grid-column: 1 / -1;">
                            <div style="color: #888;">Last Scan</div>
                            <div style="color: #888; font-size: 0.75rem;" id="mexcLastScan">Never</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Control Buttons -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                <button onclick="testMexcTriangularConnection()" class="btn" disabled style="opacity: 0.4; cursor: not-allowed;">
                    üîç Test Connection
                </button>
                <button onclick="scanMexcTriangularPaths()" class="btn" disabled style="opacity: 0.4; cursor: not-allowed;">
                    üîç Scan Opportunities
                </button>
                <button onclick="viewMexcPathDetails()" class="btn">
                    üìä View Paths
                </button>
                <button onclick="clearMexcTriangularHistory()" class="btn" disabled style="opacity: 0.4; cursor: not-allowed;">
                    üóëÔ∏è Clear History
                </button>
            </div>

            <!-- Tabbed Interface: Balance Tracker & Trading -->
            <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px;">
                <div style="display: flex; gap: 10px; margin-bottom: 15px; border-bottom: 2px solid rgba(255,165,0,0.3);">
                    <button id="mexcBalanceTab" onclick="switchMexcTab('balance')" style="padding: 10px 20px; background: rgba(255,165,0,0.3); color: #FFA500; border: none; border-bottom: 3px solid #FFA500; cursor: pointer; font-weight: 600; transition: all 0.3s;">
                        üí∞ Balance Tracker
                    </button>
                    <button id="mexcTradingTab" onclick="switchMexcTab('trading')" style="padding: 10px 20px; background: rgba(255,255,255,0.05); color: #b8c6db; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-weight: 600; transition: all 0.3s;">
                        üü† Current Opportunities
                    </button>
                </div>

                <!-- Balance Tracker Tab Content -->
                <div id="mexcBalanceContent" style="display: block;">
                    <h4 style="color: #FFA500; margin-bottom: 15px;">üí∞ USDT Balance Tracking</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                        <div>
                            <div style="color: #888;">Starting</div>
                            <div style="color: #FFA500; font-weight: 600; font-size: 1.2rem;" id="mexcStartingUSDT">$0.00</div>
                        </div>
                        <div>
                            <div style="color: #888;">Current</div>
                            <div style="color: #FFA500; font-weight: 600; font-size: 1.2rem;" id="mexcCurrentUSDT">$0.00</div>
                        </div>
                        <div>
                            <div style="color: #888;">Change</div>
                            <div style="color: #b8c6db; font-weight: 600; font-size: 1.2rem;" id="mexcChangeUSDT">$0.00 (0.0%)</div>
                        </div>
                    </div>
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,165,0,0.2);">
                        <button onclick="updateMexcBalance()" style="padding: 10px 20px; background: rgba(255,165,0,0.2); color: #FFA500; border: 1px solid #FFA500; border-radius: 8px; cursor: pointer; margin-right: 10px;">
                            üîÑ Refresh Balance
                        </button>
                        <button onclick="resetMexcStartingBalance()" style="padding: 10px 20px; background: rgba(255,255,255,0.05); color: #888; border: 1px solid #444; border-radius: 8px; cursor: pointer;">
                            üîÅ Reset Starting Balance
                        </button>
                    </div>
                </div>

                <!-- Trading Tab Content -->
                <div id="mexcTradingContent" style="display: none;">
                    <div id="mexcOpportunities" style="color: #888; font-size: 14px;">
                        Click "Scan Opportunities" to find triangular arbitrage paths
                    </div>
                    <div id="mexcScanStatus" style="color: #888; font-size: 14px; margin-top: 15px; text-align: center;"></div>
                </div>
            </div>
        </div>

        <!-- XT Exchange -->
        <div id="xt-card" style="display: none; background: rgba(0,150,255,0.1); padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 2px solid #0096FF;">
            <!-- Header with toggle -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: #0096FF; margin: 0;">üöÄ XT.COM Triangular Arbitrage</h3>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <span style="color: #b8c6db; font-size: 0.9rem;">XT Live Trading:</span>
                    <div class="toggle-switch" id="xtTriangularEnabled" onclick="toggleXtTriangular()">
                        <div class="toggle-knob"></div>
                    </div>
                    <span id="xtTriangularStatus" style="color: #ff6b6b; font-size: 0.9rem; margin-left: 10px;">OFF</span>
                </div>
            </div>

            <!-- FUNDING REQUIREMENTS Info Banner -->
            <div style="background: rgba(0,150,255,0.15); border: 2px solid #0096FF; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                <h4 style="color: #0096FF; margin: 0 0 15px 0; font-size: 1.1rem;">üí∞ FUNDING REQUIREMENTS - XT Triangular Arbitrage</h4>
                <p style="color: #b8c6db; margin: 0 0 15px 0; line-height: 1.6;">
                    XT.com offers <strong>32 triangular arbitrage paths</strong> across 5 path sets. Portfolio % (default 10%) determines your trade size:
                    <code style="background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 4px;">tradeAmount = MIN(portfolioPercent √ó balance, maxTradeAmount)</code>
                </p>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px; border-left: 3px solid #ffd700;">
                        <div style="color: #ffd700; font-weight: 600; margin-bottom: 5px;">SET 1: Essential ETH Bridge</div>
                        <div style="color: #888; font-size: 0.9rem;">7 paths ‚Ä¢ ETH ‚Üí BTC, SOL, XRP, ADA, MATIC, DOT, AVAX</div>
                    </div>
                    <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px; border-left: 3px solid #0096FF;">
                        <div style="color: #0096FF; font-weight: 600; margin-bottom: 5px;">SET 2: Mid-Cap BTC Bridge</div>
                        <div style="color: #888; font-size: 0.9rem;">7 paths ‚Ä¢ BTC ‚Üí ETH, SOL, ADA, DOT, ATOM, LTC, XRP</div>
                    </div>
                    <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px; border-left: 3px solid #00bfff;">
                        <div style="color: #00bfff; font-weight: 600; margin-bottom: 5px;">SET 3: XT Native Bridge üöÄ</div>
                        <div style="color: #888; font-size: 0.9rem;">6 paths ‚Ä¢ XT token native pairs</div>
                    </div>
                    <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px; border-left: 3px solid #ff6347;">
                        <div style="color: #ff6347; font-weight: 600; margin-bottom: 5px;">SET 4: High Volatility</div>
                        <div style="color: #888; font-size: 0.9rem;">6 paths ‚Ä¢ DOGE, SHIB, MATIC, SOL, ADA, DOT</div>
                    </div>
                    <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px; border-left: 3px solid #8a2be2;">
                        <div style="color: #8a2be2; font-weight: 600; margin-bottom: 5px;">SET 5: Extended Multi-Bridge</div>
                        <div style="color: #888; font-size: 0.9rem;">6 paths ‚Ä¢ Includes 2 four-leg paths</div>
                    </div>
                </div>
                <p style="color: #0096FF; margin: 15px 0 0 0; font-size: 0.9rem;">
                    ‚ö° <strong>Portfolio %</strong> is your primary risk control. <strong>Max Trade Amount</strong> acts as a safety cap.
                    Starting with 10% portfolio risk and $1000 max cap is recommended for XT.
                </p>
            </div>

            <!-- Settings Grid: Risk Management, Path Sets, Performance Stats -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">

                <!-- Risk Management -->
                <div class="stat-card">
                    <h4 style="color: #0096FF; margin-bottom: 15px;">‚öñÔ∏è Risk Management</h4>

                    <label style="display: block; color: #888; margin-bottom: 5px; font-size: 13px;">Max Trade Amount (USDT)</label>
                    <input type="number" id="xtMaxTrade" value="1000" min="10" max="10000" step="10"
                           onchange="saveXtTriangularSettings()"
                           style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid #444; border-radius: 8px; color: white; margin-bottom: 15px; font-size: 14px;">

                    <label style="display: block; color: #888; margin-bottom: 5px; font-size: 13px;">Portfolio % Risk</label>
                    <input type="number" id="xtPortfolioPercent" value="10" min="1" max="20" step="1"
                           onchange="saveXtTriangularSettings()"
                           style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid #444; border-radius: 8px; color: white; margin-bottom: 15px; font-size: 14px;">

                    <label style="display: block; color: #888; margin-bottom: 5px; font-size: 13px;">Min Profit Threshold (%)</label>
                    <input type="number" id="xtProfitThreshold" value="0.5" min="0.1" max="5" step="0.1"
                           onchange="saveXtTriangularSettings()"
                           style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid #444; border-radius: 8px; color: white; font-size: 14px;">

                    <div style="margin-top: 15px; display: flex; gap: 8px;">
                        <button onclick="testXtTriangularConnection()"
                                style="flex: 1; padding: 10px; background: #0096FF; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px; opacity: 0.4;">
                            Test Connection
                        </button>
                        <button onclick="viewXtPathDetails()"
                                style="flex: 1; padding: 10px; background: rgba(0,150,255,0.2); color: #0096FF; border: 1px solid #0096FF; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px;">
                            View Paths
                        </button>
                    </div>
                </div>

                <!-- Path Sets (2-column compact grid) -->
                <div class="stat-card">
                    <h4 style="color: #0096FF; margin-bottom: 15px;">üîÄ Path Sets (32 Total)</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px; background: rgba(255,255,255,0.03); border-radius: 6px;">
                            <input type="checkbox" id="xtSet1Enabled" checked onchange="saveXtTriangularSettings()" style="width: 16px; height: 16px; cursor: pointer;">
                            <span style="color: #ddd; font-size: 13px;">SET 1 (7)</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px; background: rgba(255,255,255,0.03); border-radius: 6px;">
                            <input type="checkbox" id="xtSet2Enabled" checked onchange="saveXtTriangularSettings()" style="width: 16px; height: 16px; cursor: pointer;">
                            <span style="color: #ddd; font-size: 13px;">SET 2 (7)</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px; background: rgba(255,255,255,0.03); border-radius: 6px;">
                            <input type="checkbox" id="xtSet3Enabled" onchange="saveXtTriangularSettings()" style="width: 16px; height: 16px; cursor: pointer;">
                            <span style="color: #ddd; font-size: 13px;">SET 3 (6) üöÄ</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px; background: rgba(255,255,255,0.03); border-radius: 6px;">
                            <input type="checkbox" id="xtSet4Enabled" onchange="saveXtTriangularSettings()" style="width: 16px; height: 16px; cursor: pointer;">
                            <span style="color: #ddd; font-size: 13px;">SET 4 (6)</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px; background: rgba(255,255,255,0.03); border-radius: 6px; grid-column: 1 / -1;">
                            <input type="checkbox" id="xtSet5Enabled" onchange="saveXtTriangularSettings()" style="width: 16px; height: 16px; cursor: pointer;">
                            <span style="color: #ddd; font-size: 13px;">SET 5: Extended Multi-Bridge (6)</span>
                        </label>
                    </div>

                    <button onclick="scanXtTriangularPaths()"
                            style="width: 100%; padding: 12px; background: #0096FF; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; margin-top: 15px; opacity: 0.4;">
                        üîç Scan Opportunities
                    </button>
                    <button onclick="clearXtHistory()"
                            style="width: 100%; padding: 8px; background: rgba(255,255,255,0.05); color: #888; border: 1px solid #444; border-radius: 8px; cursor: pointer; font-size: 12px; margin-top: 8px; opacity: 0.4;">
                        üóëÔ∏è Clear History
                    </button>
                </div>

                <!-- Performance Stats -->
                <div class="stat-card">
                    <h4 style="color: #0096FF; margin-bottom: 15px;">üìä Performance Stats</h4>
                    <div style="display: grid; gap: 12px;">
                        <div style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 6px;">
                            <div style="color: #888; font-size: 0.85rem;">Total Trades</div>
                            <div id="xtTotalTrades" style="color: white; font-size: 1.3rem; font-weight: 600;">0</div>
                        </div>
                        <div style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 6px;">
                            <div style="color: #888; font-size: 0.85rem;">Success Rate</div>
                            <div id="xtSuccessRate" style="color: #00ff88; font-size: 1.3rem; font-weight: 600;">0%</div>
                        </div>
                        <div style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 6px;">
                            <div style="color: #888; font-size: 0.85rem;">Avg Profit</div>
                            <div id="xtAvgProfit" style="color: #0096FF; font-size: 1.3rem; font-weight: 600;">$0.00</div>
                        </div>
                        <div style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 6px;">
                            <div style="color: #888; font-size: 0.85rem;">Total Profit</div>
                            <div id="xtTotalProfit" style="color: #0096FF; font-size: 1.3rem; font-weight: 600;">$0.00</div>
                        </div>
                        <div style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 6px;">
                            <div style="color: #888; font-size: 0.85rem;">Best Path</div>
                            <div id="xtBestPath" style="color: white; font-size: 0.9rem; font-weight: 600;">‚Äî</div>
                        </div>
                        <div style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 6px;">
                            <div style="color: #888; font-size: 0.85rem;">Last Scan</div>
                            <div id="xtLastScan" style="color: white; font-size: 0.85rem;">Never</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabbed Interface: Balance Tracker & Trading -->
            <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px;">
                <!-- Tab Buttons -->
                <div style="display: flex; gap: 10px; margin-bottom: 15px; border-bottom: 2px solid rgba(255,255,255,0.1); padding-bottom: 10px;">
                    <button id="xtBalanceTab" onclick="switchXtTab('balance')"
                            class="active"
                            style="flex: 1; padding: 12px; background: rgba(0,150,255,0.2); color: #0096FF; border: 1px solid #0096FF; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.3s;">
                        üí∞ Balance Tracker
                    </button>
                    <button id="xtTradingTab" onclick="switchXtTab('trading')"
                            style="flex: 1; padding: 12px; background: rgba(255,255,255,0.05); color: #888; border: 1px solid #444; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.3s;">
                        üöÄ Current Opportunities
                    </button>
                </div>

                <!-- Balance Tracker Tab Content -->
                <div id="xtBalanceContent" style="display: block;">
                    <h4 style="color: #0096FF; margin: 0 0 15px 0;">üí∞ USDT Balance Tracking</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div id="xtStartingUSDT" style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="color: #888; font-size: 0.85rem; margin-bottom: 5px;">üí∞ Starting Balance</div>
                            <div style="color: white; font-size: 1.3rem; font-weight: 600;">$0.00</div>
                            <div style="color: #888; font-size: 0.8rem;">USDT</div>
                        </div>
                        <div id="xtCurrentUSDT" style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="color: #888; font-size: 0.85rem; margin-bottom: 5px;">üìä Current Balance</div>
                            <div style="color: white; font-size: 1.3rem; font-weight: 600;">$0.00</div>
                            <div style="color: #888; font-size: 0.8rem;">USDT</div>
                        </div>
                        <div id="xtChangeUSDT" style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="color: #888; font-size: 0.85rem; margin-bottom: 5px;">üìà Change</div>
                            <div style="color: #0096FF; font-size: 1.3rem; font-weight: 600;">$0.00</div>
                            <div style="color: #0096FF; font-size: 0.9rem;">0.0%</div>
                        </div>
                    </div>
                    <button onclick="resetXtStartingBalance()"
                            style="width: 100%; padding: 10px; background: rgba(0,150,255,0.2); color: #0096FF; border: 1px solid #0096FF; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px;">
                        üîÑ Reset Starting Balance
                    </button>
                </div>

                <!-- Trading Tab Content -->
                <div id="xtTradingContent" style="display: none;">
                    <h4 style="color: #0096FF; margin: 0 0 10px 0;">üöÄ Active Opportunities</h4>
                    <div id="xtOpportunities" style="color: #888; font-size: 14px; min-height: 100px;">
                        No scan results yet. Click "Scan Opportunities" to begin.
                    </div>
                    <div id="xtScanStatus" style="color: #888; font-size: 13px; text-align: center; margin-top: 15px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 6px;"></div>
                </div>
            </div>
        </div>

        <!-- AscendEX Exchange -->
        <div id="ascendex-card" style="display: none; background: rgba(138,43,226,0.1); padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 2px solid #8A2BE2;">
            <!-- Header with toggle -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: #8A2BE2; margin: 0;">üíé AscendEX Triangular Arbitrage</h3>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <span style="color: #b8c6db; font-size: 0.9rem;">AscendEX Live Trading:</span>
                    <div class="toggle-switch" id="ascendexTriangularEnabled" onclick="toggleAscendexTriangular()">
                        <div class="toggle-knob"></div>
                    </div>
                    <span id="ascendexTriangularStatus" style="color: #ff6b6b; font-size: 0.9rem; margin-left: 10px;">OFF</span>
                </div>
            </div>

            <!-- FUNDING REQUIREMENTS Info Banner -->
            <div style="background: rgba(138,43,226,0.15); border: 2px solid #8A2BE2; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                <h4 style="color: #8A2BE2; margin: 0 0 15px 0; font-size: 1.1rem;">üí∞ FUNDING REQUIREMENTS - 32 Paths Across 5 Sets</h4>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;">
                    <!-- SET 1 -->
                    <div style="background: rgba(0,255,0,0.05); border-left: 3px solid #00ff00; padding: 12px; border-radius: 5px;">
                        <div style="color: #00ff00; font-weight: bold; margin-bottom: 8px;">‚úÖ SET 1: Essential ETH Bridge</div>
                        <div style="color: #b8c6db; font-size: 0.85rem; line-height: 1.6;">
                            <div>‚Ä¢ 7 paths (3-leg cycles)</div>
                            <div>‚Ä¢ Assets: ETH, BTC, SOL, MATIC, LINK</div>
                            <div>‚Ä¢ Funding: ~$50-100 USDT per path</div>
                            <div>‚Ä¢ Total Set Budget: ~$350-700 USDT</div>
                        </div>
                    </div>

                    <!-- SET 2 -->
                    <div style="background: rgba(0,255,0,0.05); border-left: 3px solid #00ff00; padding: 12px; border-radius: 5px;">
                        <div style="color: #00ff00; font-weight: bold; margin-bottom: 8px;">‚úÖ SET 2: Mid-Cap BTC Bridge</div>
                        <div style="color: #b8c6db; font-size: 0.85rem; line-height: 1.6;">
                            <div>‚Ä¢ 7 paths (3-leg cycles)</div>
                            <div>‚Ä¢ Assets: BTC, AVAX, UNI, ATOM, DOT</div>
                            <div>‚Ä¢ Funding: ~$50-100 USDT per path</div>
                            <div>‚Ä¢ Total Set Budget: ~$350-700 USDT</div>
                        </div>
                    </div>

                    <!-- SET 3 -->
                    <div style="background: rgba(255,215,0,0.05); border-left: 3px solid #FFD700; padding: 12px; border-radius: 5px;">
                        <div style="color: #FFD700; font-weight: bold; margin-bottom: 8px;">üíé SET 3: ASD Native Bridge</div>
                        <div style="color: #b8c6db; font-size: 0.85rem; line-height: 1.6;">
                            <div>‚Ä¢ 6 paths (3-leg cycles)</div>
                            <div>‚Ä¢ Assets: ASD (native), BTC, ETH</div>
                            <div>‚Ä¢ Funding: ~$50-100 USDT per path</div>
                            <div>‚Ä¢ Total Set Budget: ~$300-600 USDT</div>
                        </div>
                    </div>

                    <!-- SET 4 -->
                    <div style="background: rgba(255,165,0,0.05); border-left: 3px solid #FFA500; padding: 12px; border-radius: 5px;">
                        <div style="color: #FFA500; font-weight: bold; margin-bottom: 8px;">‚ö° SET 4: High Volatility</div>
                        <div style="color: #b8c6db; font-size: 0.85rem; line-height: 1.6;">
                            <div>‚Ä¢ 6 paths (3-leg cycles)</div>
                            <div>‚Ä¢ Assets: FTM, NEAR, AAVE, ALGO</div>
                            <div>‚Ä¢ Funding: ~$75-150 USDT per path</div>
                            <div>‚Ä¢ Total Set Budget: ~$450-900 USDT</div>
                        </div>
                    </div>

                    <!-- SET 5 -->
                    <div style="background: rgba(255,0,0,0.05); border-left: 3px solid #ff4444; padding: 12px; border-radius: 5px;">
                        <div style="color: #ff4444; font-weight: bold; margin-bottom: 8px;">üîÅ SET 5: Extended Multi-Bridge</div>
                        <div style="color: #b8c6db; font-size: 0.85rem; line-height: 1.6;">
                            <div>‚Ä¢ 6 paths (4 three-leg, 2 four-leg)</div>
                            <div>‚Ä¢ Assets: XRP, LTC, TRX, ADA, DOGE</div>
                            <div>‚Ä¢ Funding: ~$75-150 USDT per path</div>
                            <div>‚Ä¢ Total Set Budget: ~$450-900 USDT</div>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 15px; padding: 12px; background: rgba(138,43,226,0.1); border-radius: 5px;">
                    <div style="color: #8A2BE2; font-weight: bold; margin-bottom: 5px;">üìä TOTAL FUNDING RANGE</div>
                    <div style="color: #b8c6db; font-size: 0.9rem;">
                        ‚Ä¢ Conservative (All Sets): ~$1,900 USDT | Recommended (All Sets): ~$3,800 USDT
                    </div>
                    <div style="color: #888; font-size: 0.85rem; margin-top: 8px;">
                        üí° <strong>Portfolio % Mode:</strong> Trade amount = MIN(portfolioPercent √ó balance, maxTradeAmount). Start with conservative funding and scale up as profits compound.
                    </div>
                </div>
            </div>

            <!-- Settings Grid: Risk Management, Path Sets, Performance Stats -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">

                <!-- Column 1: Risk Management -->
                <div class="stat-card">
                    <h4 style="color: #8A2BE2; margin-bottom: 15px;">‚öñÔ∏è Risk Management</h4>

                    <label style="display: block; color: #888; margin-bottom: 5px; font-size: 14px;">Max Trade Amount (USDT)</label>
                    <input type="number" id="ascendexMaxTrade" value="1000" min="10" max="10000" step="10"
                           style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid #444; border-radius: 8px; color: white; margin-bottom: 15px;"
                           onchange="saveAscendexTriangularSettings()">

                    <label style="display: block; color: #888; margin-bottom: 5px; font-size: 14px;">Portfolio % Risk</label>
                    <input type="number" id="ascendexPortfolioPercent" value="10" min="1" max="20" step="1"
                           style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid #444; border-radius: 8px; color: white; margin-bottom: 15px;"
                           onchange="saveAscendexTriangularSettings()">

                    <label style="display: block; color: #888; margin-bottom: 5px; font-size: 14px;">Min Profit Threshold (%)</label>
                    <input type="number" id="ascendexProfitThreshold" value="0.5" min="0.1" max="5" step="0.1"
                           style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid #444; border-radius: 8px; color: white;"
                           onchange="saveAscendexTriangularSettings()">

                    <div style="margin-top: 15px; padding: 10px; background: rgba(138,43,226,0.1); border-radius: 5px;">
                        <div style="color: #8A2BE2; font-size: 0.85rem; font-weight: bold; margin-bottom: 5px;">üí° Portfolio % Mode Active</div>
                        <div style="color: #888; font-size: 0.8rem; line-height: 1.4;">Trade size = MIN(10% √ó balance, $1,000 cap)</div>
                    </div>
                </div>

                <!-- Column 2: Path Sets -->
                <div class="stat-card">
                    <h4 style="color: #8A2BE2; margin-bottom: 15px;">üîÄ Path Selection (32 Total)</h4>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="ascendexSet1Enabled" checked style="width: 18px; height: 18px; cursor: pointer;" onchange="saveAscendexTriangularSettings()">
                            <span style="color: #00ff00; font-weight: 600;">‚úÖ SET 1: Essential ETH (7)</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="ascendexSet2Enabled" checked style="width: 18px; height: 18px; cursor: pointer;" onchange="saveAscendexTriangularSettings()">
                            <span style="color: #00ff00; font-weight: 600;">‚úÖ SET 2: Mid-Cap BTC (7)</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="ascendexSet3Enabled" style="width: 18px; height: 18px; cursor: pointer;" onchange="saveAscendexTriangularSettings()">
                            <span style="color: #FFD700; font-weight: 600;">üíé SET 3: ASD Native (6)</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="ascendexSet4Enabled" style="width: 18px; height: 18px; cursor: pointer;" onchange="saveAscendexTriangularSettings()">
                            <span style="color: #FFA500; font-weight: 600;">‚ö° SET 4: High Volatility (6)</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="ascendexSet5Enabled" style="width: 18px; height: 18px; cursor: pointer;" onchange="saveAscendexTriangularSettings()">
                            <span style="color: #ff4444; font-weight: 600;">üîÅ SET 5: Multi-Bridge (6)</span>
                        </label>
                    </div>

                    <div style="margin-top: 15px;">
                        <button onclick="viewAscendexPathDetails()"
                                style="width: 100%; padding: 10px; background: rgba(138,43,226,0.2); color: #8A2BE2; border: 1px solid #8A2BE2; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            üìã View All 32 Paths
                        </button>
                    </div>
                </div>

                <!-- Column 3: Performance Stats -->
                <div class="stat-card">
                    <h4 style="color: #8A2BE2; margin-bottom: 15px;">üìä Performance Stats</h4>
                    <div style="display: grid; gap: 10px;">
                        <div style="background: rgba(138,43,226,0.1); padding: 10px; border-radius: 5px;">
                            <div style="color: #888; font-size: 0.75rem; margin-bottom: 3px;">Paths Scanned</div>
                            <div id="ascendexPathsScanned" style="color: #8A2BE2; font-size: 1.3rem; font-weight: bold;">0</div>
                        </div>
                        <div style="background: rgba(138,43,226,0.1); padding: 10px; border-radius: 5px;">
                            <div style="color: #888; font-size: 0.75rem; margin-bottom: 3px;">Opportunities Found</div>
                            <div id="ascendexOpportunitiesFound" style="color: #00d26a; font-size: 1.3rem; font-weight: bold;">0</div>
                        </div>
                        <div style="background: rgba(138,43,226,0.1); padding: 10px; border-radius: 5px;">
                            <div style="color: #888; font-size: 0.75rem; margin-bottom: 3px;">Trades Executed</div>
                            <div id="ascendexTradesExecuted" style="color: #8A2BE2; font-size: 1.3rem; font-weight: bold;">0</div>
                        </div>
                        <div style="background: rgba(138,43,226,0.1); padding: 10px; border-radius: 5px;">
                            <div style="color: #888; font-size: 0.75rem; margin-bottom: 3px;">Success Rate</div>
                            <div id="ascendexSuccessRate" style="color: #8A2BE2; font-size: 1.3rem; font-weight: bold;">0%</div>
                        </div>
                        <div style="background: rgba(138,43,226,0.1); padding: 10px; border-radius: 5px;">
                            <div style="color: #888; font-size: 0.75rem; margin-bottom: 3px;">Total Profit</div>
                            <div id="ascendexTotalProfit" style="color: #00d26a; font-size: 1.3rem; font-weight: bold;">$0.00</div>
                        </div>
                        <div style="background: rgba(138,43,226,0.1); padding: 10px; border-radius: 5px;">
                            <div style="color: #888; font-size: 0.75rem; margin-bottom: 3px;">Avg Profit/Trade</div>
                            <div id="ascendexAvgProfit" style="color: #8A2BE2; font-size: 1.3rem; font-weight: bold;">$0.00</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabbed Interface: Balance Tracker & Trading -->
            <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px;">
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button id="ascendexBalanceTab" onclick="switchAscendexTab('balance')"
                            style="flex: 1; padding: 12px; background: #8A2BE2; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s;">
                        üí∞ Balance Tracker
                    </button>
                    <button id="ascendexTradingTab" onclick="switchAscendexTab('trading')"
                            style="flex: 1; padding: 12px; background: rgba(138,43,226,0.2); color: #8A2BE2; border: 1px solid #8A2BE2; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s;">
                        üöÄ Current Opportunities
                    </button>
                </div>

                <!-- Balance Tracker Tab Content -->
                <div id="ascendexBalanceContent" style="display: block;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                        <div style="background: rgba(138,43,226,0.1); padding: 15px; border-radius: 8px;">
                            <div style="color: #888; font-size: 0.85rem; margin-bottom: 5px;">Starting Balance</div>
                            <div id="ascendexStartingUSDT" style="color: #8A2BE2; font-size: 1.4rem; font-weight: bold;">0.00 USDT</div>
                        </div>
                        <div style="background: rgba(138,43,226,0.1); padding: 15px; border-radius: 8px;">
                            <div style="color: #888; font-size: 0.85rem; margin-bottom: 5px;">Current Balance</div>
                            <div id="ascendexCurrentUSDT" style="color: #8A2BE2; font-size: 1.4rem; font-weight: bold;">0.00 USDT</div>
                        </div>
                        <div style="background: rgba(138,43,226,0.1); padding: 15px; border-radius: 8px;">
                            <div style="color: #888; font-size: 0.85rem; margin-bottom: 5px;">Change</div>
                            <div id="ascendexChangeUSDT" style="font-size: 1.4rem; font-weight: bold;">0.00 USDT (0.0%)</div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="updateAscendexBalance()"
                                style="flex: 1; padding: 10px; background: #8A2BE2; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            üîÑ Refresh Balance
                        </button>
                        <button onclick="resetAscendexStartingBalance()"
                                style="flex: 1; padding: 10px; background: rgba(138,43,226,0.2); color: #8A2BE2; border: 1px solid #8A2BE2; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            üìä Reset Starting Point
                        </button>
                    </div>
                </div>

                <!-- Trading Tab Content -->
                <div id="ascendexTradingContent" style="display: none;">
                    <button onclick="scanAscendexTriangularPaths()"
                            style="width: 100%; padding: 12px; background: #8A2BE2; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 16px; margin-bottom: 15px;">
                        üîç Scan Opportunities Now
                    </button>
                    <div id="ascendexScanStatus" style="color: #888; font-size: 14px; text-align: center; margin-bottom: 15px; min-height: 20px;"></div>
                    <div id="ascendexOpportunities" style="color: #888; font-size: 14px;">
                        No opportunities found yet. Click "Scan Opportunities Now" to begin scanning.
                    </div>
                    <button onclick="clearAscendexHistory()"
                            style="width: 100%; padding: 10px; background: rgba(255,68,68,0.2); color: #ff4444; border: 1px solid #ff4444; border-radius: 8px; cursor: pointer; font-weight: 600; margin-top: 15px;">
                        üóëÔ∏è Clear Opportunity History
                    </button>
                </div>
            </div>
        </div>

        <!-- BingX Exchange -->
        <div id="bingx-card" style="display: none; background: rgba(0,191,255,0.1); padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 2px solid #00BFFF;">
            <!-- Header with toggle -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: #00BFFF; margin: 0;">üåä BingX Triangular Arbitrage</h3>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <span style="color: #b8c6db; font-size: 0.9rem;">BingX Live Trading:</span>
                    <div class="toggle-switch" id="bingxTriangularEnabled" onclick="toggleBingxTriangular()">
                        <div class="toggle-knob"></div>
                    </div>
                    <span id="bingxTriangularStatus" style="color: #ff6b6b; font-size: 0.9rem; margin-left: 10px;">OFF</span>
                </div>
            </div>

            <!-- FUNDING REQUIREMENTS Info Banner -->
            <div style="background: rgba(0,191,255,0.15); border: 2px solid #00BFFF; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                <h4 style="color: #00BFFF; margin: 0 0 15px 0; font-size: 1.1rem;">üí∞ FUNDING REQUIREMENTS - 32 Paths Across 5 Sets</h4>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;">
                    <!-- SET 1 -->
                    <div style="background: rgba(0,255,0,0.05); border-left: 3px solid #00ff00; padding: 12px; border-radius: 5px;">
                        <div style="color: #00ff00; font-weight: bold; margin-bottom: 8px;">‚úÖ SET 1: Essential ETH Bridge</div>
                        <div style="color: #b8c6db; font-size: 0.85rem; line-height: 1.6;">
                            <div>‚Ä¢ 7 paths (3-leg cycles)</div>
                            <div>‚Ä¢ Assets: ETH, BTC, SOL, MATIC, LINK</div>
                            <div>‚Ä¢ Funding: ~$50-100 USDT per path</div>
                            <div>‚Ä¢ Total Set Budget: ~$350-700 USDT</div>
                        </div>
                    </div>

                    <!-- SET 2 -->
                    <div style="background: rgba(0,255,0,0.05); border-left: 3px solid #00ff00; padding: 12px; border-radius: 5px;">
                        <div style="color: #00ff00; font-weight: bold; margin-bottom: 8px;">‚úÖ SET 2: Mid-Cap BTC Bridge</div>
                        <div style="color: #b8c6db; font-size: 0.85rem; line-height: 1.6;">
                            <div>‚Ä¢ 7 paths (3-leg cycles)</div>
                            <div>‚Ä¢ Assets: BTC, ETH, SOL, AVAX, UNI</div>
                            <div>‚Ä¢ Funding: ~$50-100 USDT per path</div>
                            <div>‚Ä¢ Total Set Budget: ~$350-700 USDT</div>
                        </div>
                    </div>

                    <!-- SET 3 -->
                    <div style="background: rgba(255,215,0,0.05); border-left: 3px solid #FFD700; padding: 12px; border-radius: 5px;">
                        <div style="color: #FFD700; font-weight: bold; margin-bottom: 8px;">üíé SET 3: SOL High-Liquidity</div>
                        <div style="color: #b8c6db; font-size: 0.85rem; line-height: 1.6;">
                            <div>‚Ä¢ 6 paths (3-leg cycles)</div>
                            <div>‚Ä¢ Assets: SOL, BTC, ETH, BNB, AVAX</div>
                            <div>‚Ä¢ Funding: ~$50-100 USDT per path</div>
                            <div>‚Ä¢ Total Set Budget: ~$300-600 USDT</div>
                        </div>
                    </div>

                    <!-- SET 4 -->
                    <div style="background: rgba(255,165,0,0.05); border-left: 3px solid #FFA500; padding: 12px; border-radius: 5px;">
                        <div style="color: #FFA500; font-weight: bold; margin-bottom: 8px;">‚ö° SET 4: High Volatility</div>
                        <div style="color: #b8c6db; font-size: 0.85rem; line-height: 1.6;">
                            <div>‚Ä¢ 6 paths (3-leg cycles)</div>
                            <div>‚Ä¢ Assets: FTM, NEAR, AAVE, ALGO</div>
                            <div>‚Ä¢ Funding: ~$75-150 USDT per path</div>
                            <div>‚Ä¢ Total Set Budget: ~$450-900 USDT</div>
                        </div>
                    </div>

                    <!-- SET 5 -->
                    <div style="background: rgba(255,0,0,0.05); border-left: 3px solid #ff4444; padding: 12px; border-radius: 5px;">
                        <div style="color: #ff4444; font-weight: bold; margin-bottom: 8px;">üîÅ SET 5: Extended Multi-Bridge</div>
                        <div style="color: #b8c6db; font-size: 0.85rem; line-height: 1.6;">
                            <div>‚Ä¢ 6 paths (4 three-leg, 2 four-leg)</div>
                            <div>‚Ä¢ Assets: XRP, LTC, TRX, ADA, DOGE</div>
                            <div>‚Ä¢ Funding: ~$75-150 USDT per path</div>
                            <div>‚Ä¢ Total Set Budget: ~$450-900 USDT</div>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 15px; padding: 12px; background: rgba(0,191,255,0.1); border-radius: 5px;">
                    <div style="color: #00BFFF; font-weight: bold; margin-bottom: 5px;">üìä TOTAL FUNDING RANGE</div>
                    <div style="color: #b8c6db; font-size: 0.9rem;">
                        ‚Ä¢ Conservative (All Sets): ~$1,900 USDT | Recommended (All Sets): ~$3,800 USDT
                    </div>
                    <div style="color: #888; font-size: 0.85rem; margin-top: 8px;">
                        üí° <strong>Portfolio % Mode:</strong> Trade amount = MIN(portfolioPercent √ó balance, maxTradeAmount). Start with conservative funding and scale up as profits compound.
                    </div>
                </div>
            </div>

            <!-- Settings Grid: Risk Management, Path Sets, Performance Stats -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">

                <!-- Column 1: Risk Management -->
                <div class="stat-card">
                    <h4 style="color: #00BFFF; margin-bottom: 15px;">‚öñÔ∏è Risk Management</h4>

                    <label style="display: block; color: #888; margin-bottom: 5px; font-size: 14px;">Max Trade Amount (USDT)</label>
                    <input type="number" id="bingxMaxTrade" value="1000" min="10" max="10000" step="10"
                           style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid #444; border-radius: 8px; color: white; margin-bottom: 15px;"
                           onchange="saveBingxTriangularSettings()">

                    <label style="display: block; color: #888; margin-bottom: 5px; font-size: 14px;">Portfolio % Risk</label>
                    <input type="number" id="bingxPortfolioPercent" value="10" min="1" max="20" step="1"
                           style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid #444; border-radius: 8px; color: white; margin-bottom: 15px;"
                           onchange="saveBingxTriangularSettings()">

                    <label style="display: block; color: #888; margin-bottom: 5px; font-size: 14px;">Min Profit Threshold (%)</label>
                    <input type="number" id="bingxProfitThreshold" value="0.5" min="0.1" max="5" step="0.1"
                           style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid #444; border-radius: 8px; color: white;"
                           onchange="saveBingxTriangularSettings()">

                    <div style="margin-top: 15px; padding: 10px; background: rgba(0,191,255,0.1); border-radius: 5px;">
                        <div style="color: #00BFFF; font-size: 0.85rem; font-weight: bold; margin-bottom: 5px;">üí° Portfolio % Mode Active</div>
                        <div style="color: #888; font-size: 0.8rem; line-height: 1.4;">Trade size = MIN(10% √ó balance, $1,000 cap)</div>
                    </div>
                </div>

                <!-- Column 2: Path Sets -->
                <div class="stat-card">
                    <h4 style="color: #00BFFF; margin-bottom: 15px;">üîÄ Path Selection (32 Total)</h4>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="bingxSet1Enabled" checked style="width: 18px; height: 18px; cursor: pointer;" onchange="saveBingxTriangularSettings()">
                            <span style="color: #00ff00; font-weight: 600;">‚úÖ SET 1: Essential ETH (7)</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="bingxSet2Enabled" checked style="width: 18px; height: 18px; cursor: pointer;" onchange="saveBingxTriangularSettings()">
                            <span style="color: #00ff00; font-weight: 600;">‚úÖ SET 2: Mid-Cap BTC (7)</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="bingxSet3Enabled" style="width: 18px; height: 18px; cursor: pointer;" onchange="saveBingxTriangularSettings()">
                            <span style="color: #FFD700; font-weight: 600;">üíé SET 3: SOL High-Liq (6)</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="bingxSet4Enabled" style="width: 18px; height: 18px; cursor: pointer;" onchange="saveBingxTriangularSettings()">
                            <span style="color: #FFA500; font-weight: 600;">‚ö° SET 4: High Volatility (6)</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="bingxSet5Enabled" style="width: 18px; height: 18px; cursor: pointer;" onchange="saveBingxTriangularSettings()">
                            <span style="color: #ff4444; font-weight: 600;">üîÅ SET 5: Multi-Bridge (6)</span>
                        </label>
                    </div>

                    <div style="margin-top: 15px;">
                        <button onclick="viewBingxPathDetails()"
                                style="width: 100%; padding: 10px; background: rgba(0,191,255,0.2); color: #00BFFF; border: 1px solid #00BFFF; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            üìã View All 32 Paths
                        </button>
                    </div>
                </div>

                <!-- Column 3: Performance Stats -->
                <div class="stat-card">
                    <h4 style="color: #00BFFF; margin-bottom: 15px;">üìä Performance Stats</h4>
                    <div style="display: grid; gap: 10px;">
                        <div style="background: rgba(0,191,255,0.1); padding: 10px; border-radius: 5px;">
                            <div style="color: #888; font-size: 0.75rem; margin-bottom: 3px;">Paths Scanned</div>
                            <div id="bingxPathsScanned" style="color: #00BFFF; font-size: 1.3rem; font-weight: bold;">0</div>
                        </div>
                        <div style="background: rgba(0,191,255,0.1); padding: 10px; border-radius: 5px;">
                            <div style="color: #888; font-size: 0.75rem; margin-bottom: 3px;">Opportunities Found</div>
                            <div id="bingxOpportunitiesFound" style="color: #00d26a; font-size: 1.3rem; font-weight: bold;">0</div>
                        </div>
                        <div style="background: rgba(0,191,255,0.1); padding: 10px; border-radius: 5px;">
                            <div style="color: #888; font-size: 0.75rem; margin-bottom: 3px;">Trades Executed</div>
                            <div id="bingxTradesExecuted" style="color: #00BFFF; font-size: 1.3rem; font-weight: bold;">0</div>
                        </div>
                        <div style="background: rgba(0,191,255,0.1); padding: 10px; border-radius: 5px;">
                            <div style="color: #888; font-size: 0.75rem; margin-bottom: 3px;">Success Rate</div>
                            <div id="bingxSuccessRate" style="color: #00BFFF; font-size: 1.3rem; font-weight: bold;">0%</div>
                        </div>
                        <div style="background: rgba(0,191,255,0.1); padding: 10px; border-radius: 5px;">
                            <div style="color: #888; font-size: 0.75rem; margin-bottom: 3px;">Total Profit</div>
                            <div id="bingxTotalProfit" style="color: #00d26a; font-size: 1.3rem; font-weight: bold;">$0.00</div>
                        </div>
                        <div style="background: rgba(0,191,255,0.1); padding: 10px; border-radius: 5px;">
                            <div style="color: #888; font-size: 0.75rem; margin-bottom: 3px;">Avg Profit/Trade</div>
                            <div id="bingxAvgProfit" style="color: #00BFFF; font-size: 1.3rem; font-weight: bold;">$0.00</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabbed Interface: Balance Tracker & Trading -->
            <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px;">
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button id="bingxBalanceTab" onclick="switchBingxTab('balance')"
                            style="flex: 1; padding: 12px; background: #00BFFF; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s;">
                        üí∞ Balance Tracker
                    </button>
                    <button id="bingxTradingTab" onclick="switchBingxTab('trading')"
                            style="flex: 1; padding: 12px; background: rgba(0,191,255,0.2); color: #00BFFF; border: 1px solid #00BFFF; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s;">
                        üöÄ Current Opportunities
                    </button>
                </div>

                <!-- Balance Tracker Tab Content -->
                <div id="bingxBalanceContent" style="display: block;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                        <div style="background: rgba(0,191,255,0.1); padding: 15px; border-radius: 8px;">
                            <div style="color: #888; font-size: 0.85rem; margin-bottom: 5px;">Starting Balance</div>
                            <div id="bingxStartingUSDT" style="color: #00BFFF; font-size: 1.4rem; font-weight: bold;">0.00 USDT</div>
                        </div>
                        <div style="background: rgba(0,191,255,0.1); padding: 15px; border-radius: 8px;">
                            <div style="color: #888; font-size: 0.85rem; margin-bottom: 5px;">Current Balance</div>
                            <div id="bingxCurrentUSDT" style="color: #00BFFF; font-size: 1.4rem; font-weight: bold;">0.00 USDT</div>
                        </div>
                        <div style="background: rgba(0,191,255,0.1); padding: 15px; border-radius: 8px;">
                            <div style="color: #888; font-size: 0.85rem; margin-bottom: 5px;">Change</div>
                            <div id="bingxChangeUSDT" style="font-size: 1.4rem; font-weight: bold;">0.00 USDT (0.0%)</div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="updateBingxBalance()"
                                style="flex: 1; padding: 10px; background: #00BFFF; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            üîÑ Refresh Balance
                        </button>
                        <button onclick="resetBingxStartingBalance()"
                                style="flex: 1; padding: 10px; background: rgba(0,191,255,0.2); color: #00BFFF; border: 1px solid #00BFFF; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            üìä Reset Starting Point
                        </button>
                    </div>
                </div>

                <!-- Trading Tab Content -->
                <div id="bingxTradingContent" style="display: none;">
                    <button onclick="scanBingxTriangularPaths()"
                            style="width: 100%; padding: 12px; background: #00BFFF; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 16px; margin-bottom: 15px;">
                        üîç Scan Opportunities Now
                    </button>
                    <div id="bingxScanStatus" style="color: #888; font-size: 14px; text-align: center; margin-bottom: 15px; min-height: 20px;"></div>
                    <div id="bingxOpportunities" style="color: #888; font-size: 14px;">
                        No opportunities found yet. Click "Scan Opportunities Now" to begin scanning.
                    </div>
                    <button onclick="clearBingxHistory()"
                            style="width: 100%; padding: 10px; background: rgba(255,68,68,0.2); color: #ff4444; border: 1px solid #ff4444; border-radius: 8px; cursor: pointer; font-weight: 600; margin-top: 15px;">
                        üóëÔ∏è Clear Opportunity History
                    </button>
                </div>
            </div>
        </div>

        <!-- Bitget Exchange -->
        <!-- BITGET TRIANGULAR ARBITRAGE -->
        <div id="bitget-card" style="display: none; background: rgba(138,43,226,0.1); padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 2px solid #8A2BE2;">
            <!-- Header with Toggle -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: #8A2BE2; margin: 0;">üíú Bitget Triangular Arbitrage</h3>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <span style="color: #b8c6db; font-size: 0.9rem;">Live Trading:</span>
                    <div class="toggle-switch" id="bitgetTriangularEnabled" onclick="toggleBitgetTriangular()">
                        <div class="toggle-knob"></div>
                    </div>
                    <span id="bitgetTriangularStatus" style="color: #ff6b6b; font-weight: 600; font-size: 0.9rem;">OFF</span>
                </div>
            </div>

            <!-- FUNDING REQUIREMENTS Info Banner -->
            <div style="background: rgba(138,43,226,0.15); border: 2px solid #8A2BE2; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                <h4 style="color: #8A2BE2; margin: 0 0 15px 0; font-size: 1.1rem;">üí∞ FUNDING REQUIREMENTS (Portfolio % Mode)</h4>
                <p style="color: #b8c6db; margin: 0 0 15px 0; font-size: 0.9rem; line-height: 1.6;">
                    <strong>Portfolio % Strategy:</strong> Trade amount = MIN(portfolioPercent √ó balance, maxTradeAmount). Default 10% of USDT balance, capped at $1,000. <br>
                    <strong>Note:</strong> Passphrase required for Bitget API authentication (HMAC-SHA256 Base64).
                </p>
                <div style="display: grid; gap: 12px;">
                    <div style="padding: 12px; background: rgba(0,255,0,0.1); border-left: 4px solid #00ff00; border-radius: 6px;">
                        <strong style="color: #00ff00;">SET 1: Essential ETH Bridge (7 paths)</strong><br>
                        <span style="color: #b8c6db; font-size: 0.85rem;">Funding: $350-700 USDT | High liquidity ETH-based paths</span>
                    </div>
                    <div style="padding: 12px; background: rgba(0,255,0,0.1); border-left: 4px solid #00ff00; border-radius: 6px;">
                        <strong style="color: #00ff00;">SET 2: Mid-Cap BTC Bridge (7 paths)</strong><br>
                        <span style="color: #b8c6db; font-size: 0.85rem;">Funding: $350-700 USDT | Established BTC trading pairs</span>
                    </div>
                    <div style="padding: 12px; background: rgba(138,43,226,0.2); border-left: 4px solid #8A2BE2; border-radius: 6px;">
                        <strong style="color: #8A2BE2;">SET 3: BGB Native Token (6 paths)</strong><br>
                        <span style="color: #b8c6db; font-size: 0.85rem;">Funding: $300-600 USDT | Bitget's exchange token (BGB) - Fee discounts!</span>
                    </div>
                    <div style="padding: 12px; background: rgba(255,165,0,0.1); border-left: 4px solid #FFA500; border-radius: 6px;">
                        <strong style="color: #FFA500;">SET 4: High Volatility (6 paths)</strong><br>
                        <span style="color: #b8c6db; font-size: 0.85rem;">Funding: $300-600 USDT | Higher risk/reward volatile assets</span>
                    </div>
                    <div style="padding: 12px; background: rgba(255,0,0,0.1); border-left: 4px solid #ff4444; border-radius: 6px;">
                        <strong style="color: #ff4444;">SET 5: Extended Multi-Bridge (6 paths)</strong><br>
                        <span style="color: #b8c6db; font-size: 0.85rem;">Funding: $300-600 USDT | Includes 2 four-leg paths (advanced)</span>
                    </div>
                </div>
                <p style="color: #8A2BE2; margin: 15px 0 0 0; font-weight: 600; font-size: 0.95rem;">
                    Total Recommended Funding: <strong>$1,600-3,200 USDT</strong> (all sets enabled)
                </p>
            </div>

            <!-- 3-Column Responsive Grid -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
                <!-- Column 1: Risk Management -->
                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; border: 1px solid rgba(138,43,226,0.3);">
                    <h4 style="color: #8A2BE2; margin: 0 0 15px 0;">‚öñÔ∏è Risk Management</h4>
                    <label style="display: block; color: #888; margin-bottom: 5px; font-size: 13px;">Max Trade Amount (USDT)</label>
                    <input type="number" id="bitgetMaxTrade" value="1000" min="10" max="10000" step="10" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid #444; border-radius: 8px; color: white; margin-bottom: 15px; font-size: 14px;">

                    <label style="display: block; color: #888; margin-bottom: 5px; font-size: 13px;">Portfolio % (of USDT balance)</label>
                    <input type="number" id="bitgetPortfolioPercent" value="10" min="1" max="50" step="1" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid #444; border-radius: 8px; color: white; margin-bottom: 15px; font-size: 14px;">

                    <label style="display: block; color: #888; margin-bottom: 5px; font-size: 13px;">Min Profit Threshold (%)</label>
                    <input type="number" id="bitgetProfitThreshold" value="0.5" min="0.1" max="5" step="0.1" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid #444; border-radius: 8px; color: white; font-size: 14px;">
                </div>

                <!-- Column 2: Path Selection -->
                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; border: 1px solid rgba(138,43,226,0.3);">
                    <h4 style="color: #8A2BE2; margin: 0 0 15px 0;">üîÄ Path Sets (32 Total)</h4>
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="bitgetSet1Enabled" checked style="width: 18px; height: 18px; cursor: pointer;">
                            <span style="color: #ddd; font-size: 14px;">‚úÖ SET 1 (7)</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="bitgetSet2Enabled" checked style="width: 18px; height: 18px; cursor: pointer;">
                            <span style="color: #ddd; font-size: 14px;">‚úÖ SET 2 (7)</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="bitgetSet3Enabled" style="width: 18px; height: 18px; cursor: pointer;">
                            <span style="color: #ddd; font-size: 14px;">üíú SET 3: BGB (6)</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="bitgetSet4Enabled" style="width: 18px; height: 18px; cursor: pointer;">
                            <span style="color: #ddd; font-size: 14px;">‚ö° SET 4 (6)</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="bitgetSet5Enabled" style="width: 18px; height: 18px; cursor: pointer;">
                            <span style="color: #ddd; font-size: 14px;">üîÅ SET 5 (6)</span>
                        </label>
                    </div>
                    <button onclick="viewBitgetPathDetails()" style="width: 100%; margin-top: 15px; padding: 10px; background: rgba(138,43,226,0.2); color: #8A2BE2; border: 1px solid #8A2BE2; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px;">
                        üìã View All 32 Paths
                    </button>
                </div>

                <!-- Column 3: Performance Stats -->
                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; border: 1px solid rgba(138,43,226,0.3);">
                    <h4 style="color: #8A2BE2; margin: 0 0 15px 0;">üìä Performance Stats</h4>
                    <div style="display: flex; flex-direction: column; gap: 12px; font-size: 13px;">
                        <div style="display: flex; justify-content: space-between; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                            <span style="color: #888;">Paths Scanned:</span>
                            <span id="bitgetPathsScanned" style="color: white; font-weight: 600;">0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                            <span style="color: #888;">Opportunities Found:</span>
                            <span id="bitgetOpportunitiesFound" style="color: #8A2BE2; font-weight: 600;">0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                            <span style="color: #888;">Trades Executed:</span>
                            <span id="bitgetTradesExecuted" style="color: white; font-weight: 600;">0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                            <span style="color: #888;">Success Rate:</span>
                            <span id="bitgetSuccessRate" style="color: #00d26a; font-weight: 600;">0%</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                            <span style="color: #888;">Total Profit:</span>
                            <span id="bitgetTotalProfit" style="color: #00d26a; font-weight: 600;">$0.00</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                            <span style="color: #888;">Avg Profit/Trade:</span>
                            <span id="bitgetAvgProfit" style="color: #8A2BE2; font-weight: 600;">$0.00</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabbed Interface: Balance Tracker + Trading -->
            <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px;">
                <!-- Tab Buttons -->
                <div style="display: flex; gap: 10px; margin-bottom: 15px; border-bottom: 1px solid rgba(138,43,226,0.3);">
                    <button id="bitgetBalanceTab" onclick="switchBitgetTab('balance')" style="padding: 12px 20px; background: #8A2BE2; color: white; border: none; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: 600; font-size: 14px;">
                        üí∞ Balance Tracker
                    </button>
                    <button id="bitgetTradingTab" onclick="switchBitgetTab('trading')" style="padding: 12px 20px; background: rgba(138,43,226,0.2); color: #8A2BE2; border: 1px solid #8A2BE2; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: 600; font-size: 14px;">
                        üìà Current Opportunities
                    </button>
                </div>

                <!-- Balance Tracker Tab Content -->
                <div id="bitgetBalanceContent" style="display: block;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                        <div style="background: rgba(138,43,226,0.1); padding: 15px; border-radius: 10px; border-left: 4px solid #8A2BE2;">
                            <div style="color: #888; font-size: 12px; margin-bottom: 5px;">Starting Balance</div>
                            <div id="bitgetStartingUSDT" style="color: white; font-size: 18px; font-weight: 600;">0.00 USDT</div>
                        </div>
                        <div style="background: rgba(138,43,226,0.1); padding: 15px; border-radius: 10px; border-left: 4px solid #8A2BE2;">
                            <div style="color: #888; font-size: 12px; margin-bottom: 5px;">Current Balance</div>
                            <div id="bitgetCurrentUSDT" style="color: white; font-size: 18px; font-weight: 600;">0.00 USDT</div>
                        </div>
                        <div style="background: rgba(138,43,226,0.1); padding: 15px; border-radius: 10px; border-left: 4px solid #8A2BE2;">
                            <div style="color: #888; font-size: 12px; margin-bottom: 5px;">Change (Profit/Loss)</div>
                            <div id="bitgetChangeUSDT" style="color: white; font-size: 18px; font-weight: 600;">0.00 USDT (0.0%)</div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="updateBitgetBalance()" style="flex: 1; padding: 10px; background: #8A2BE2; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px;">
                            üîÑ Refresh Balance
                        </button>
                        <button onclick="resetBitgetStartingBalance()" style="flex: 1; padding: 10px; background: rgba(138,43,226,0.2); color: #8A2BE2; border: 1px solid #8A2BE2; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px;">
                            üîÅ Reset Starting Point
                        </button>
                    </div>
                </div>

                <!-- Trading Tab Content -->
                <div id="bitgetTradingContent" style="display: none;">
                    <button onclick="scanBitgetTriangularPaths()" style="width: 100%; padding: 14px; background: #8A2BE2; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 15px; margin-bottom: 15px;">
                        üîç Scan Opportunities Now
                    </button>
                    <div id="bitgetScanStatus" style="color: #888; font-size: 14px; margin-bottom: 15px; text-align: center;"></div>
                    <div id="bitgetOpportunities" style="color: #888; font-size: 14px; min-height: 100px;">
                        No opportunities found yet. Click "Scan Opportunities Now" to begin scanning.
                    </div>
                    <button onclick="clearBitgetHistory()" style="width: 100%; margin-top: 15px; padding: 10px; background: rgba(255,68,68,0.2); color: #ff4444; border: 1px solid #ff4444; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px;">
                        üóëÔ∏è Clear Opportunity History
                    </button>
                </div>
            </div>
        </div>

        <!-- BITMART TRIANGULAR ARBITRAGE -->
        <div id="bitmart-card" style="display: none; background: rgba(255,140,0,0.1); padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 2px solid #FF8C00;">
            <!-- Header with Toggle -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: #FF8C00; margin: 0;">üß° BitMart Triangular Arbitrage</h3>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <span style="color: #b8c6db; font-size: 0.9rem;">Live Trading:</span>
                    <div class="toggle-switch" id="bitmartTriangularEnabled" onclick="toggleBitmartTriangular()">
                        <div class="toggle-knob"></div>
                    </div>
                    <span id="bitmartTriangularStatus" style="color: #ff6b6b; font-weight: 600; font-size: 0.9rem;">OFF</span>
                </div>
            </div>

            <!-- FUNDING REQUIREMENTS Info Banner -->
            <div style="background: rgba(255,140,0,0.15); border: 2px solid #FF8C00; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                <h4 style="color: #FF8C00; margin: 0 0 15px 0; font-size: 1.1rem;">üí∞ FUNDING REQUIREMENTS (Portfolio % Mode)</h4>
                <p style="color: #b8c6db; margin: 0 0 15px 0; font-size: 0.9rem; line-height: 1.6;">
                    <strong>Portfolio % Strategy:</strong> Trade amount = MIN(portfolioPercent √ó balance, maxTradeAmount). Default 10% of USDT balance, capped at $1,000. <br>
                    <strong>Note:</strong> Memo required for BitMart API authentication (HMAC-SHA256).
                </p>
                <div style="display: grid; gap: 12px;">
                    <div style="padding: 12px; background: rgba(0,210,106,0.15); border-left: 4px solid #00d26a; border-radius: 6px;">
                        <strong style="color: #00d26a;">SET 1: Essential ETH Bridge (7 paths)</strong><br>
                        <span style="color: #b8c6db; font-size: 0.85rem;">Funding: $350-700 USDT | ETH-based triangular paths</span>
                    </div>
                    <div style="padding: 12px; background: rgba(0,210,106,0.15); border-left: 4px solid #00d26a; border-radius: 6px;">
                        <strong style="color: #00d26a;">SET 2: Mid-Cap BTC Bridge (7 paths)</strong><br>
                        <span style="color: #b8c6db; font-size: 0.85rem;">Funding: $350-700 USDT | BTC-based triangular paths</span>
                    </div>
                    <div style="padding: 12px; background: rgba(255,140,0,0.2); border-left: 4px solid #FF8C00; border-radius: 6px;">
                        <strong style="color: #FF8C00;">SET 3: BMX Native Token (6 paths) üß°</strong><br>
                        <span style="color: #b8c6db; font-size: 0.85rem;">Funding: $300-600 USDT | BitMart's exchange token (BMX) - 0.1% fees!</span>
                    </div>
                    <div style="padding: 12px; background: rgba(255,165,0,0.1); border-left: 4px solid #FFA500; border-radius: 6px;">
                        <strong style="color: #FFA500;">SET 4: High Volatility (6 paths)</strong><br>
                        <span style="color: #b8c6db; font-size: 0.85rem;">Funding: $300-600 USDT | Volatile altcoin pairs</span>
                    </div>
                    <div style="padding: 12px; background: rgba(255,68,68,0.1); border-left: 4px solid #FF4444; border-radius: 6px;">
                        <strong style="color: #FF4444;">SET 5: Extended Multi-Bridge (6 paths) üî•</strong><br>
                        <span style="color: #b8c6db; font-size: 0.85rem;">Funding: $300-600 USDT | Includes 2 four-leg paths</span>
                    </div>
                </div>
                <p style="color: #FF8C00; margin: 15px 0 0 0; font-weight: 600; font-size: 0.95rem;">
                    Total Recommended Funding: <strong>$1,600-3,200 USDT</strong> (all sets enabled)
                </p>
            </div>

            <!-- 3-Column Responsive Grid -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
                <!-- Column 1: Risk Management -->
                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; border: 1px solid rgba(255,140,0,0.3);">
                    <h4 style="color: #FF8C00; margin: 0 0 15px 0;">‚öñÔ∏è Risk Management</h4>
                    <label style="display: block; color: #888; margin-bottom: 5px; font-size: 13px;">Max Trade Amount (USDT)</label>
                    <input type="number" id="bitmartMaxTrade" value="1000" min="10" max="10000" step="10" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid #444; border-radius: 8px; color: white; margin-bottom: 15px; font-size: 14px;">

                    <label style="display: block; color: #888; margin-bottom: 5px; font-size: 13px;">Portfolio % Risk</label>
                    <input type="number" id="bitmartPortfolioPercent" value="10" min="1" max="50" step="1" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid #444; border-radius: 8px; color: white; margin-bottom: 15px; font-size: 14px;">

                    <label style="display: block; color: #888; margin-bottom: 5px; font-size: 13px;">Min Profit Threshold (%)</label>
                    <input type="number" id="bitmartProfitThreshold" value="0.5" min="0.1" max="5" step="0.1" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid #444; border-radius: 8px; color: white; font-size: 14px;">
                </div>

                <!-- Column 2: Path Selection -->
                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; border: 1px solid rgba(255,140,0,0.3);">
                    <h4 style="color: #FF8C00; margin: 0 0 15px 0;">üîÄ Path Selection</h4>
                    <div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px;">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="bitmartSet1Enabled" checked style="width: 18px; height: 18px; cursor: pointer;">
                            <span style="color: #ddd; font-size: 13px;">SET 1: Essential ETH (7)</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="bitmartSet2Enabled" checked style="width: 18px; height: 18px; cursor: pointer;">
                            <span style="color: #ddd; font-size: 13px;">SET 2: Mid-Cap BTC (7)</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="bitmartSet3Enabled" style="width: 18px; height: 18px; cursor: pointer;">
                            <span style="color: #ddd; font-size: 13px;">üß° SET 3: BMX Native (6)</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="bitmartSet4Enabled" style="width: 18px; height: 18px; cursor: pointer;">
                            <span style="color: #ddd; font-size: 13px;">SET 4: High Volatility (6)</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="bitmartSet5Enabled" style="width: 18px; height: 18px; cursor: pointer;">
                            <span style="color: #ddd; font-size: 13px;">SET 5: Extended (6)</span>
                        </label>
                    </div>
                    <button onclick="viewBitmartPathDetails()" style="width: 100%; padding: 10px; background: rgba(255,140,0,0.2); color: #FF8C00; border: 1px solid #FF8C00; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px;">
                        üìã View All 32 Paths
                    </button>
                </div>

                <!-- Column 3: Performance Stats -->
                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; border: 1px solid rgba(255,140,0,0.3);">
                    <h4 style="color: #FF8C00; margin: 0 0 15px 0;">üìä Performance</h4>
                    <div style="display: grid; gap: 10px;">
                        <div style="padding: 8px; background: rgba(255,255,255,0.03); border-radius: 6px;">
                            <div style="color: #888; font-size: 11px;">Total Scans</div>
                            <div style="color: white; font-size: 16px; font-weight: 600;">0</div>
                        </div>
                        <div style="padding: 8px; background: rgba(255,255,255,0.03); border-radius: 6px;">
                            <div style="color: #888; font-size: 11px;">Opportunities Found</div>
                            <div style="color: #FF8C00; font-size: 16px; font-weight: 600;">0</div>
                        </div>
                        <div style="padding: 8px; background: rgba(255,255,255,0.03); border-radius: 6px;">
                            <div style="color: #888; font-size: 11px;">Trades Executed</div>
                            <div style="color: #00d26a; font-size: 16px; font-weight: 600;">0</div>
                        </div>
                        <div style="padding: 8px; background: rgba(255,255,255,0.03); border-radius: 6px;">
                            <div style="color: #888; font-size: 11px;">Success Rate</div>
                            <div style="color: white; font-size: 16px; font-weight: 600;">0%</div>
                        </div>
                        <div style="padding: 8px; background: rgba(255,255,255,0.03); border-radius: 6px;">
                            <div style="color: #888; font-size: 11px;">Avg Profit</div>
                            <div style="color: white; font-size: 16px; font-weight: 600;">0%</div>
                        </div>
                        <div style="padding: 8px; background: rgba(255,255,255,0.03); border-radius: 6px;">
                            <div style="color: #888; font-size: 11px;">Total P&L</div>
                            <div style="color: white; font-size: 16px; font-weight: 600;">$0.00</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabbed Interface: Balance Tracker + Trading -->
            <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px;">
                <!-- Tab Headers -->
                <div style="display: flex; gap: 10px; margin-bottom: 15px; border-bottom: 2px solid rgba(255,140,0,0.2); padding-bottom: 10px;">
                    <button id="bitmartBalanceTab" onclick="switchBitmartTab('balance')" style="padding: 10px 20px; background: linear-gradient(135deg, #FF8C00, #FFA500); color: white; border: none; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: 600; font-size: 14px;">
                        üí∞ Balance Tracker
                    </button>
                    <button id="bitmartTradingTab" onclick="switchBitmartTab('trading')" style="padding: 10px 20px; background: rgba(0,0,0,0.3); color: #888; border: none; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: 600; font-size: 14px;">
                        üìà Current Opportunities
                    </button>
                </div>

                <!-- Balance Tracker Tab Content -->
                <div id="bitmartBalanceContent" style="display: block;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                        <div style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: 10px; border-left: 4px solid #888;">
                            <div style="color: #888; font-size: 12px; margin-bottom: 5px;">Starting Balance</div>
                            <div id="bitmartStartingUSDT" style="color: white; font-size: 18px; font-weight: 600;">0.00 USDT</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: 10px; border-left: 4px solid #FF8C00;">
                            <div style="color: #888; font-size: 12px; margin-bottom: 5px;">Current Balance</div>
                            <div id="bitmartCurrentUSDT" style="color: white; font-size: 18px; font-weight: 600;">0.00 USDT</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: 10px; border-left: 4px solid #00d26a;">
                            <div style="color: #888; font-size: 12px; margin-bottom: 5px;">Change</div>
                            <div id="bitmartChangeUSDT" style="color: white; font-size: 18px; font-weight: 600;">0.00 USDT (0.0%)</div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="updateBitmartBalance()" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #FF8C00, #FFA500); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            üîÑ Refresh Balance
                        </button>
                        <button onclick="resetBitmartStartingBalance()" style="flex: 1; padding: 12px; background: rgba(255,140,0,0.2); color: #FF8C00; border: 1px solid #FF8C00; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            üîÅ Reset Starting Point
                        </button>
                    </div>
                </div>

                <!-- Trading Tab Content -->
                <div id="bitmartTradingContent" style="display: none;">
                    <button onclick="scanBitmartTriangularPaths()" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #FF8C00, #FFA500); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 16px; margin-bottom: 15px;">
                        üîç Scan Opportunities Now
                    </button>
                    <div id="bitmartScanStatus" style="margin-bottom: 15px;"></div>
                    <div id="bitmartOpportunities" style="color: #888; font-size: 14px;">
                        No scan results yet. Click "Scan Opportunities Now" to begin.
                    </div>
                    <button onclick="clearBitmartHistory()" style="width: 100%; padding: 10px; background: rgba(255,68,68,0.2); color: #ff6b6b; border: 1px solid #ff6b6b; border-radius: 8px; cursor: pointer; font-weight: 600; margin-top: 15px;">
                        üóëÔ∏è Clear Opportunity History
                    </button>
                </div>
            </div>
        </div>

        <!-- BITRUE TRIANGULAR ARBITRAGE -->
        <div id="bitrue-card" style="display: none; background: rgba(34,197,94,0.1); padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 2px solid #22C55E;">
            <!-- Header with Toggle -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: #22C55E; margin: 0;">üíö Bitrue Triangular Arbitrage</h3>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <span style="color: #b8c6db; font-size: 0.9rem;">Live Trading:</span>
                    <div class="toggle-switch" id="bitrueTriangularEnabled" onclick="toggleBitrueTriangular()">
                        <div class="toggle-knob"></div>
                    </div>
                    <span id="bitrueTriangularStatus" style="color: #ff6b6b; font-weight: 600; font-size: 0.9rem;">OFF</span>
                </div>
            </div>

            <!-- FUNDING REQUIREMENTS Info Banner -->
            <div style="background: rgba(34,197,94,0.15); border: 2px solid #22C55E; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                <h4 style="color: #22C55E; margin: 0 0 15px 0; font-size: 1.1rem;">üí∞ FUNDING REQUIREMENTS (Portfolio % Mode)</h4>
                <p style="color: #b8c6db; margin: 0 0 15px 0; font-size: 0.9rem; line-height: 1.6;">
                    <strong>Portfolio % Strategy:</strong> Trade amount = MIN(portfolioPercent √ó balance, maxTradeAmount). Default 10% of USDT balance, capped at $1,000. <br>
                    <strong>Note:</strong> Binance-compatible API with HMAC-SHA256 authentication.
                </p>
                <div style="display: grid; gap: 12px;">
                    <div style="padding: 12px; background: rgba(0,210,106,0.2); border-left: 4px solid #00d26a; border-radius: 6px;">
                        <strong style="color: #00d26a;">SET 1: Essential ETH Bridge (7 paths) üíö</strong><br>
                        <span style="color: #b8c6db; font-size: 0.85rem;">Funding: $350-700 USDT | Core ETH-based triangular paths</span>
                    </div>
                    <div style="padding: 12px; background: rgba(0,210,106,0.2); border-left: 4px solid #00d26a; border-radius: 6px;">
                        <strong style="color: #00d26a;">SET 2: Mid-Cap BTC Bridge (7 paths) üíö</strong><br>
                        <span style="color: #b8c6db; font-size: 0.85rem;">Funding: $350-700 USDT | BTC cross-pair opportunities</span>
                    </div>
                    <div style="padding: 12px; background: rgba(34,197,94,0.2); border-left: 4px solid #22C55E; border-radius: 6px;">
                        <strong style="color: #22C55E;">SET 3: BTR Native Token (6 paths) üíö</strong><br>
                        <span style="color: #b8c6db; font-size: 0.85rem;">Funding: $300-600 USDT | Bitrue's exchange token - 0.07% fees (30% discount!)
</span>
                    </div>
                    <div style="padding: 12px; background: rgba(255,165,0,0.2); border-left: 4px solid #FFA500; border-radius: 6px;">
                        <strong style="color: #FFA500;">SET 4: High Volatility (6 paths) ‚ö°</strong><br>
                        <span style="color: #b8c6db; font-size: 0.85rem;">Funding: $300-600 USDT | Higher risk/reward opportunities</span>
                    </div>
                    <div style="padding: 12px; background: rgba(255,68,68,0.2); border-left: 4px solid #FF4444; border-radius: 6px;">
                        <strong style="color: #FF4444;">SET 5: Extended Multi-Bridge (6 paths) üî•</strong><br>
                        <span style="color: #b8c6db; font-size: 0.85rem;">Funding: $300-600 USDT | Includes 2 four-leg paths</span>
                    </div>
                </div>
                <p style="color: #22C55E; margin: 15px 0 0 0; font-weight: 600; font-size: 0.95rem;">
                    Total Recommended Funding: <strong>$1,600-3,200 USDT</strong> (all sets enabled)
                </p>
            </div>

            <!-- 3-Column Responsive Grid -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
                <!-- Column 1: Risk Management -->
                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; border: 1px solid rgba(34,197,94,0.3);">
                    <h4 style="color: #22C55E; margin: 0 0 15px 0;">‚öñÔ∏è Risk Management</h4>
                    <label style="display: block; color: #888; margin-bottom: 5px; font-size: 13px;">Max Trade Amount (USDT)</label>
                    <input type="number" id="bitrueMaxTrade" value="1000" min="10" max="10000" step="10" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid #444; border-radius: 8px; color: white; margin-bottom: 15px; font-size: 14px;">

                    <label style="display: block; color: #888; margin-bottom: 5px; font-size: 13px;">Portfolio % Risk</label>
                    <input type="number" id="bitruePortfolioPercent" value="10" min="1" max="50" step="1" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid #444; border-radius: 8px; color: white; margin-bottom: 15px; font-size: 14px;">

                    <label style="display: block; color: #888; margin-bottom: 5px; font-size: 13px;">Min Profit Threshold (%)</label>
                    <input type="number" id="bitrueProfitThreshold" value="0.5" min="0.1" max="5" step="0.1" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid #444; border-radius: 8px; color: white; font-size: 14px;">
                </div>

                <!-- Column 2: Path Selection -->
                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; border: 1px solid rgba(34,197,94,0.3);">
                    <h4 style="color: #22C55E; margin: 0 0 15px 0;">üîÄ Path Selection</h4>
                    <div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px;">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="bitrueSet1Enabled" checked style="width: 18px; height: 18px; cursor: pointer;">
                            <span style="color: #ddd; font-size: 13px;">SET 1: Essential ETH (7)</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="bitrueSet2Enabled" checked style="width: 18px; height: 18px; cursor: pointer;">
                            <span style="color: #ddd; font-size: 13px;">SET 2: Mid-Cap BTC (7)</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="bitrueSet3Enabled" style="width: 18px; height: 18px; cursor: pointer;">
                            <span style="color: #ddd; font-size: 13px;">üíö SET 3: BTR Native (6)</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="bitrueSet4Enabled" style="width: 18px; height: 18px; cursor: pointer;">
                            <span style="color: #ddd; font-size: 13px;">‚ö° SET 4: High Vol (6)</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="bitrueSet5Enabled" style="width: 18px; height: 18px; cursor: pointer;">
                            <span style="color: #ddd; font-size: 13px;">üî• SET 5: Extended (6)</span>
                        </label>
                    </div>
                    <button onclick="viewBitruePathDetails()" style="width: 100%; padding: 10px; background: rgba(34,197,94,0.2); color: #22C55E; border: 1px solid #22C55E; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px;">
                        üìã View All 32 Paths
                    </button>
                </div>

                <!-- Column 3: Performance Stats -->
                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; border: 1px solid rgba(34,197,94,0.3);">
                    <h4 style="color: #22C55E; margin: 0 0 15px 0;">üìä Performance Stats</h4>
                    <div style="display: grid; gap: 10px;">
                        <div>
                            <div style="color: #888; font-size: 12px;">Scans Run</div>
                            <div id="bitrueScansRun" style="color: white; font-size: 20px; font-weight: 700;">0</div>
                        </div>
                        <div>
                            <div style="color: #888; font-size: 12px;">Opportunities Found</div>
                            <div id="bitrueOpportunitiesFound" style="color: #22C55E; font-size: 20px; font-weight: 700;">0</div>
                        </div>
                        <div>
                            <div style="color: #888; font-size: 12px;">Best Profit %</div>
                            <div id="bitrueBestProfit" style="color: #22C55E; font-size: 20px; font-weight: 700;">0.00%</div>
                        </div>
                        <div>
                            <div style="color: #888; font-size: 12px;">Trades Executed</div>
                            <div id="bitrueTradesExecuted" style="color: white; font-size: 20px; font-weight: 700;">0</div>
                        </div>
                        <div>
                            <div style="color: #888; font-size: 12px;">Total Profit</div>
                            <div id="bitrueTotalProfit" style="color: #00d26a; font-size: 20px; font-weight: 700;">$0.00</div>
                        </div>
                        <div>
                            <div style="color: #888; font-size: 12px;">Win Rate</div>
                            <div id="bitrueWinRate" style="color: white; font-size: 20px; font-weight: 700;">0%</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabbed Interface: Balance Tracker + Current Opportunities -->
            <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px;">
                <!-- Tab Buttons -->
                <div style="display: flex; gap: 10px; margin-bottom: 15px; border-bottom: 2px solid rgba(34,197,94,0.3); padding-bottom: 10px;">
                    <button id="bitrueBalanceTab" onclick="switchBitrueTab('balance')" style="padding: 10px 20px; background: linear-gradient(135deg, #22C55E, #00d26a); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s;">
                        üí∞ Balance Tracker
                    </button>
                    <button id="bitrueTradingTab" onclick="switchBitrueTab('trading')" style="padding: 10px 20px; background: rgba(0,0,0,0.3); color: #888; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s;">
                        üìà Current Opportunities
                    </button>
                </div>

                <!-- Balance Tracker Content -->
                <div id="bitrueBalanceContent" style="display: block;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div style="background: rgba(34,197,94,0.1); padding: 15px; border-radius: 10px; border: 1px solid rgba(34,197,94,0.3);">
                            <div style="color: #888; font-size: 13px; margin-bottom: 5px;">Starting Balance</div>
                            <div id="bitrueStartingUSDT" style="color: white; font-size: 18px; font-weight: 600;">0.00 USDT</div>
                        </div>
                        <div style="background: rgba(34,197,94,0.1); padding: 15px; border-radius: 10px; border: 1px solid rgba(34,197,94,0.3);">
                            <div style="color: #888; font-size: 13px; margin-bottom: 5px;">Current Balance</div>
                            <div id="bitrueCurrentUSDT" style="color: white; font-size: 18px; font-weight: 600;">0.00 USDT</div>
                        </div>
                        <div style="background: rgba(34,197,94,0.1); padding: 15px; border-radius: 10px; border: 1px solid rgba(34,197,94,0.3);">
                            <div style="color: #888; font-size: 13px; margin-bottom: 5px;">Total Change</div>
                            <div id="bitrueChangeUSDT" style="color: white; font-size: 18px; font-weight: 600;">0.00 USDT (0.0%)</div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="updateBitrueBalance()" style="flex: 1; padding: 12px; background: #22C55E; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            üîÑ Refresh Balance
                        </button>
                        <button onclick="resetBitrueStartingBalance()" style="flex: 1; padding: 12px; background: rgba(34,197,94,0.2); color: #22C55E; border: 1px solid #22C55E; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            üîÅ Reset Starting Point
                        </button>
                    </div>
                </div>

                <!-- Trading Content -->
                <div id="bitrueTradingContent" style="display: none;">
                    <button onclick="scanBitrueTriangularPaths()" style="width: 100%; padding: 12px; background: #22C55E; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 16px; margin-bottom: 15px;">
                        üîç Scan Opportunities Now
                    </button>
                    <div id="bitrueScanStatus" style="margin-bottom: 15px;"></div>
                    <div id="bitrueOpportunities" style="margin-bottom: 15px;"></div>
                    <button onclick="clearBitrueHistory()" style="width: 100%; padding: 10px; background: rgba(255,68,68,0.2); color: #FF4444; border: 1px solid #FF4444; border-radius: 8px; cursor: pointer; font-weight: 600;">
                        üóëÔ∏è Clear Opportunity History
                    </button>
                </div>

                <!-- Trade History (always visible at bottom) -->
                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(34,197,94,0.3);">
                    <h4 style="color: #22C55E; margin: 0 0 15px 0;">üìú Recent Trades</h4>
                    <div id="bitrueTradeHistory" style="color: #888; font-size: 14px;">
                        No trade history available.
                    </div>
                </div>
            </div>
        </div>

        <!-- GEMINI TRIANGULAR ARBITRAGE -->
        <div id="gemini-card" style="display: none; background: rgba(0,170,221,0.1); padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 2px solid #00AADD;">
            <!-- Header with Toggle -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: #00AADD; margin: 0;">üíé Gemini Triangular Arbitrage</h3>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <span style="color: #b8c6db; font-size: 0.9rem;">Live Trading:</span>
                    <div class="toggle-switch" id="geminiTriangularEnabled" onclick="toggleGeminiTriangular()">
                        <div class="toggle-knob"></div>
                    </div>
                    <span id="geminiTriangularStatus" style="color: #ff6b6b; font-weight: 600; font-size: 0.9rem;">OFF</span>
                </div>
            </div>

            <!-- FUNDING REQUIREMENTS Info Banner -->
            <div style="background: rgba(0,170,221,0.15); border: 2px solid #00AADD; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                <h4 style="color: #00AADD; margin: 0 0 15px 0; font-size: 1.1rem;">üí∞ FUNDING REQUIREMENTS (Portfolio % Mode)</h4>
                <p style="color: #b8c6db; margin: 0 0 15px 0; font-size: 0.9rem; line-height: 1.6;">
                    <strong>Portfolio % Strategy:</strong> Trade amount = MIN(portfolioPercent √ó balance, maxTradeAmount). Default 10% of USDT balance, capped at $1,000. <br>
                    <strong>Note:</strong> Regulated US exchange (Winklevoss-founded) | HMAC-SHA384 auth | Limited USDT pairs (only btcusdt, ethusdt) | 10 paths total
                </p>
                <div style="display: grid; gap: 12px;">
                    <!-- 5 color-coded path sets with funding details -->
                    <div style="padding: 12px; background: rgba(0,170,221,0.2); border-left: 4px solid #00AADD; border-radius: 6px;">
                        <strong style="color: #00AADD;">SET 1: BTC-ETH Direct (2 paths) üíé</strong><br>
                        <span style="color: #b8c6db; font-size: 0.85rem;">Funding: $200-400 USDT | Direct BTC-ETH bridge (3-leg)</span>
                    </div>
                    <div style="padding: 12px; background: rgba(0,170,221,0.2); border-left: 4px solid #00AADD; border-radius: 6px;">
                        <strong style="color: #00AADD;">SET 2: DOGE Bridge (2 paths) üíé</strong><br>
                        <span style="color: #b8c6db; font-size: 0.85rem;">Funding: $200-400 USDT | BTC/ETH via DOGE (4-leg)</span>
                    </div>
                    <div style="padding: 12px; background: rgba(255,193,7,0.2); border-left: 4px solid #FFC107; border-radius: 6px;">
                        <strong style="color: #FFC107;">SET 3: LINK Bridge (2 paths) ‚ö†Ô∏è</strong><br>
                        <span style="color: #b8c6db; font-size: 0.85rem;">Funding: $200-400 USDT | BTC/ETH via LINK (4-leg)</span>
                    </div>
                    <div style="padding: 12px; background: rgba(255,193,7,0.2); border-left: 4px solid #FFC107; border-radius: 6px;">
                        <strong style="color: #FFC107;">SET 4: LTC Bridge (2 paths) ‚ö†Ô∏è</strong><br>
                        <span style="color: #b8c6db; font-size: 0.85rem;">Funding: $200-400 USDT | BTC/ETH via LTC (4-leg)</span>
                    </div>
                    <div style="padding: 12px; background: rgba(255,87,34,0.2); border-left: 4px solid #FF5722; border-radius: 6px;">
                        <strong style="color: #FF5722;">SET 5: SOL Bridge (2 paths) üî•</strong><br>
                        <span style="color: #b8c6db; font-size: 0.85rem;">Funding: $200-400 USDT | BTC/ETH via SOL (4-leg, higher volatility)</span>
                    </div>
                </div>
                <p style="color: #00AADD; margin: 15px 0 0 0; font-weight: 600; font-size: 0.95rem;">
                    Total Recommended Funding: <strong>$1,000-2,000 USDT</strong> (all sets enabled)
                </p>
            </div>

            <!-- 3-Column Responsive Grid -->
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
                <!-- Column 1: Risk Management -->
                <div class="stat-card">
                    <h4 style="color: #00AADD; margin: 0 0 15px 0; font-size: 0.95rem;">‚öôÔ∏è Risk Management</h4>
                    <div style="margin-bottom: 12px;">
                        <label style="color: #888; font-size: 0.8rem; display: block; margin-bottom: 5px;">Max Trade Amount ($)</label>
                        <input type="number" id="geminiMaxTrade" value="1000" step="100" min="10" style="width: 100%; padding: 8px; background: rgba(255,255,255,0.05); border: 1px solid #555; border-radius: 5px; color: white; font-size: 0.85rem;">
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="color: #888; font-size: 0.8rem; display: block; margin-bottom: 5px;">Portfolio % to Use</label>
                        <input type="number" id="geminiPortfolioPercent" value="10" step="1" min="1" max="100" style="width: 100%; padding: 8px; background: rgba(255,255,255,0.05); border: 1px solid #555; border-radius: 5px; color: white; font-size: 0.85rem;">
                    </div>
                    <div>
                        <label style="color: #888; font-size: 0.8rem; display: block; margin-bottom: 5px;">Min Profit % Threshold</label>
                        <input type="number" id="geminiProfitThreshold" value="0.5" step="0.1" min="0.1" style="width: 100%; padding: 8px; background: rgba(255,255,255,0.05); border: 1px solid #555; border-radius: 5px; color: white; font-size: 0.85rem;">
                    </div>
                </div>

                <!-- Column 2: Path Selection -->
                <div class="stat-card">
                    <h4 style="color: #00AADD; margin: 0 0 15px 0; font-size: 0.95rem;">üõ§Ô∏è Path Selection</h4>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <label style="display: flex; align-items: center; color: #888; cursor: pointer; font-size: 0.85rem;">
                            <input type="checkbox" id="geminiSet1Enabled" checked style="margin-right: 8px; width: 16px; height: 16px;">
                            <span>SET 1: BTC-ETH (2)</span>
                        </label>
                        <label style="display: flex; align-items: center; color: #888; cursor: pointer; font-size: 0.85rem;">
                            <input type="checkbox" id="geminiSet2Enabled" checked style="margin-right: 8px; width: 16px; height: 16px;">
                            <span>SET 2: DOGE (2)</span>
                        </label>
                        <label style="display: flex; align-items: center; color: #888; cursor: pointer; font-size: 0.85rem;">
                            <input type="checkbox" id="geminiSet3Enabled" style="margin-right: 8px; width: 16px; height: 16px;">
                            <span>SET 3: LINK (2)</span>
                        </label>
                        <label style="display: flex; align-items: center; color: #888; cursor: pointer; font-size: 0.85rem;">
                            <input type="checkbox" id="geminiSet4Enabled" style="margin-right: 8px; width: 16px; height: 16px;">
                            <span>SET 4: LTC (2)</span>
                        </label>
                        <label style="display: flex; align-items: center; color: #888; cursor: pointer; font-size: 0.85rem;">
                            <input type="checkbox" id="geminiSet5Enabled" style="margin-right: 8px; width: 16px; height: 16px;">
                            <span>SET 5: SOL (2)</span>
                        </label>
                        <button onclick="viewGeminiPathDetails()" style="width: 100%; padding: 8px; background: rgba(0,170,221,0.2); color: #00AADD; border: 1px solid #00AADD; border-radius: 5px; cursor: pointer; font-size: 0.8rem; margin-top: 5px;">
                            üìä View All 10 Paths
                        </button>
                    </div>
                </div>

                <!-- Column 3: Performance Stats -->
                <div class="stat-card">
                    <h4 style="color: #00AADD; margin: 0 0 15px 0; font-size: 0.95rem;">üìä Performance Stats</h4>
                    <div style="display: grid; gap: 8px; font-size: 0.8rem;">
                        <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                            <span style="color: #888;">Total Scans:</span>
                            <span id="geminiTotalScans" style="color: #00AADD; font-weight: 600;">0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                            <span style="color: #888;">Opportunities Found:</span>
                            <span id="geminiOppsFound" style="color: #00AADD; font-weight: 600;">0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                            <span style="color: #888;">Trades Executed:</span>
                            <span id="geminiTradesExecuted" style="color: #00AADD; font-weight: 600;">0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                            <span style="color: #888;">Success Rate:</span>
                            <span id="geminiSuccessRate" style="color: #00AADD; font-weight: 600;">0%</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                            <span style="color: #888;">Total Profit:</span>
                            <span id="geminiTotalProfit" style="color: #00d26a; font-weight: 600;">$0.00</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 6px 0;">
                            <span style="color: #888;">Avg Profit/Trade:</span>
                            <span id="geminiAvgProfit" style="color: #00d26a; font-weight: 600;">$0.00</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Balance Tracker + Trading Tabs -->
            <div style="background: rgba(0,0,0,0.2); border-radius: 10px; padding: 15px;">
                <!-- Tab Headers -->
                <div style="display: flex; gap: 10px; margin-bottom: 15px; border-bottom: 2px solid rgba(255,255,255,0.1); padding-bottom: 10px;">
                    <button id="geminiBalanceTab" onclick="switchGeminiTab('balance')" style="padding: 8px 16px; background: linear-gradient(135deg, #00AADD, #0088AA); color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; font-size: 0.9rem;">
                        üí∞ Balance Tracker
                    </button>
                    <button id="geminiTradingTab" onclick="switchGeminiTab('trading')" style="padding: 8px 16px; background: rgba(0,0,0,0.3); color: #888; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; font-size: 0.9rem;">
                        üìà Current Opportunities
                    </button>
                </div>

                <!-- Balance Tracker Content -->
                <div id="geminiBalanceContent" style="display: block;">
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 15px;">
                        <!-- Starting Balance Card -->
                        <div style="background: rgba(0,170,221,0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(0,170,221,0.3);">
                            <div style="color: #888; font-size: 0.8rem; margin-bottom: 5px;">Starting Balance</div>
                            <div id="geminiStartingUSDT" style="color: #00AADD; font-size: 1.2rem; font-weight: 700;">0.00 USDT</div>
                        </div>

                        <!-- Current Balance Card -->
                        <div style="background: rgba(0,170,221,0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(0,170,221,0.3);">
                            <div style="color: #888; font-size: 0.8rem; margin-bottom: 5px;">Current Balance</div>
                            <div id="geminiCurrentUSDT" style="color: #00AADD; font-size: 1.2rem; font-weight: 700;">0.00 USDT</div>
                        </div>

                        <!-- Change Card -->
                        <div style="background: rgba(0,170,221,0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(0,170,221,0.3);">
                            <div style="color: #888; font-size: 0.8rem; margin-bottom: 5px;">Change (P&L)</div>
                            <div id="geminiChangeUSDT" style="color: #00d26a; font-size: 1.2rem; font-weight: 700;">+0.00 USDT (+0.00%)</div>
                        </div>
                    </div>

                    <!-- Balance Actions -->
                    <div style="display: flex; gap: 10px;">
                        <button onclick="updateGeminiBalance()" style="flex: 1; padding: 10px; background: #00AADD; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">
                            üîÑ Refresh Balance
                        </button>
                        <button onclick="resetGeminiStartingBalance()" style="flex: 1; padding: 10px; background: rgba(0,170,221,0.2); color: #00AADD; border: 1px solid #00AADD; border-radius: 5px; cursor: pointer; font-weight: 600;">
                            üîÅ Reset Starting Point
                        </button>
                    </div>
                </div>

                <!-- Trading Content -->
                <div id="geminiTradingContent" style="display: none;">
                    <!-- Scan Button -->
                    <div style="margin-bottom: 15px;">
                        <button onclick="scanGeminiTriangularPaths()" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #00AADD, #0088AA); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 1rem;">
                            üîç Scan Opportunities Now
                        </button>
                    </div>

                    <!-- Scan Status -->
                    <div id="geminiScanStatus" style="color: #888; font-size: 0.85rem; margin-bottom: 10px; text-align: center;"></div>

                    <!-- Opportunities Display -->
                    <div id="geminiOpportunities" style="max-height: 400px; overflow-y: auto;"></div>

                    <!-- Clear History Button -->
                    <div style="margin-top: 15px;">
                        <button onclick="clearGeminiHistory()" style="width: 100%; padding: 8px; background: rgba(255,87,34,0.2); color: #FF5722; border: 1px solid #FF5722; border-radius: 5px; cursor: pointer; font-size: 0.85rem;">
                            üóëÔ∏è Clear Opportunity History
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- COINCATCH TRIANGULAR ARBITRAGE (FINAL EXCHANGE - 21/21) -->
        <div id="coincatch-card" style="display: none; background: rgba(255,87,34,0.1); padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 2px solid #FF5722;">
            <!-- Header with Toggle -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: #FF5722; margin: 0;">üéØ Coincatch Triangular Arbitrage (FINAL - 21/21)</h3>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <span style="color: #b8c6db; font-size: 0.9rem;">Live Trading:</span>
                    <div class="toggle-switch" id="coincatchTriangularEnabled" onclick="toggleCoincatchTriangular()">
                        <div class="toggle-knob"></div>
                    </div>
                    <span id="coincatchTriangularStatus" style="color: #ff6b6b; font-weight: 600; font-size: 0.9rem;">OFF</span>
                </div>
            </div>

            <!-- FUNDING REQUIREMENTS Info Banner -->
            <div style="background: rgba(255,87,34,0.15); border: 2px solid #FF5722; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                <h4 style="color: #FF5722; margin: 0 0 15px 0; font-size: 1.1rem;">üí∞ FUNDING REQUIREMENTS (Portfolio % Mode)</h4>
                <p style="color: #b8c6db; margin: 0 0 15px 0; font-size: 0.9rem; line-height: 1.6;">
                    <strong>Portfolio % Strategy:</strong> Trade amount = MIN(portfolioPercent √ó balance, maxTradeAmount). Default 10% of USDT balance, capped at $1,000.
                    <br><strong>Exchange:</strong> 129 spot pairs | Only 2 BTC cross pairs (ETHBTC, GMTBTC) | HMAC-SHA256 + Passphrase | 0.2% fees
                </p>
                <div style="display: grid; gap: 12px;">
                    <div style="padding: 12px; background: rgba(255,87,34,0.2); border-left: 4px solid #FF5722; border-radius: 6px;">
                        <strong style="color: #FF5722;">SET 1: BTC-ETH Direct (2 paths) üéØ</strong><br>
                        <span style="color: #b8c6db; font-size: 0.85rem;">Funding: $200-400 USDT | Direct BTC-ETH bridge (3-leg) | Uses ETHBTC_SPBL cross pair</span>
                    </div>
                    <div style="padding: 12px; background: rgba(255,152,0,0.15); border-left: 4px solid #FF9800; border-radius: 6px;">
                        <strong style="color: #FF9800;">SET 2: GMT-BTC Bridge (2 paths) üöÄ</strong><br>
                        <span style="color: #b8c6db; font-size: 0.85rem;">Funding: $200-400 USDT | GMT-BTC bridge (3-leg) | Uses GMTBTC_SPBL cross pair</span>
                    </div>
                    <div style="padding: 12px; background: rgba(255,193,7,0.15); border-left: 4px solid #FFC107; border-radius: 6px;">
                        <strong style="color: #FFC107;">SET 3: Major 4-Leg (8 paths) ‚ö°</strong><br>
                        <span style="color: #b8c6db; font-size: 0.85rem;">Funding: $800-1,600 USDT | BTC-ETH, BTC-SOL, ETH-SOL cycles (4-leg)</span>
                    </div>
                    <div style="padding: 12px; background: rgba(139,195,74,0.15); border-left: 4px solid #8BC34A; border-radius: 6px;">
                        <strong style="color: #8BC34A;">SET 4: Altcoin 4-Leg (10 paths) ü™ô</strong><br>
                        <span style="color: #b8c6db; font-size: 0.85rem;">Funding: $1,000-2,000 USDT | DOGE-XRP, LINK-UNI, AVAX-ATOM, LTC-BCH cycles (4-leg)</span>
                    </div>
                    <div style="padding: 12px; background: rgba(33,150,243,0.15); border-left: 4px solid #2196F3; border-radius: 6px;">
                        <strong style="color: #2196F3;">SET 5: Extended 4-Leg (12 paths) üíé</strong><br>
                        <span style="color: #b8c6db; font-size: 0.85rem;">Funding: $1,200-2,400 USDT | Meme coins, L2 tokens, DeFi tokens (4-leg)</span>
                    </div>
                </div>
                <p style="color: #FF5722; margin: 15px 0 0 0; font-weight: 600; font-size: 0.95rem;">
                    Total Recommended Funding: <strong>$1,000-2,000 USDT</strong> (all sets enabled)<br>
                    <span style="color: #b8c6db; font-size: 0.85rem; font-weight: normal;">Starter: $400-800 (SET 1 & 2 only) | Advanced: $3,000-6,000 (multiple sets fully funded)</span>
                </p>
            </div>

            <!-- 3-Column Responsive Grid -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px;">

                <!-- Column 1: Risk Management -->
                <div class="stat-card">
                    <h4 style="color: #FF5722; margin-bottom: 15px;">‚öôÔ∏è Risk Management</h4>
                    <div style="margin-bottom: 15px;">
                        <label style="color: #888; font-size: 12px; display: block; margin-bottom: 5px;">Max Trade Amount ($)</label>
                        <input type="number" id="coincatchMaxTrade" value="1000" step="100" min="10"
                            style="width: 100%; padding: 8px; background: rgba(255,255,255,0.05); border: 1px solid #555; border-radius: 5px; color: white; font-size: 14px;">
                        <span style="color: #666; font-size: 11px;">Safety cap for each path scan</span>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="color: #888; font-size: 12px; display: block; margin-bottom: 5px;">Portfolio % to Use</label>
                        <input type="number" id="coincatchPortfolioPercent" value="10" step="1" min="1" max="100"
                            style="width: 100%; padding: 8px; background: rgba(255,255,255,0.05); border: 1px solid #555; border-radius: 5px; color: white; font-size: 14px;">
                        <span style="color: #666; font-size: 11px;">% of USDT balance (default 10%)</span>
                    </div>
                    <div>
                        <label style="color: #888; font-size: 12px; display: block; margin-bottom: 5px;">Profit Threshold (%)</label>
                        <input type="number" id="coincatchProfitThreshold" value="0.5" step="0.1" min="0.1"
                            style="width: 100%; padding: 8px; background: rgba(255,255,255,0.05); border: 1px solid #555; border-radius: 5px; color: white; font-size: 14px;">
                        <span style="color: #666; font-size: 11px;">Minimum profit % to show</span>
                    </div>
                </div>

                <!-- Column 2: Path Selection -->
                <div class="stat-card">
                    <h4 style="color: #FF5722; margin-bottom: 15px;">üõ§Ô∏è Path Selection (32 total)</h4>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <label style="display: flex; align-items: center; color: #888; cursor: pointer;">
                            <input type="checkbox" id="coincatchSet1Enabled" checked style="margin-right: 8px; width: 16px; height: 16px;">
                            <span>SET 1: BTC-ETH (2) üéØ</span>
                        </label>
                        <label style="display: flex; align-items: center; color: #888; cursor: pointer;">
                            <input type="checkbox" id="coincatchSet2Enabled" checked style="margin-right: 8px; width: 16px; height: 16px;">
                            <span>SET 2: GMT-BTC (2) üöÄ</span>
                        </label>
                        <label style="display: flex; align-items: center; color: #888; cursor: pointer;">
                            <input type="checkbox" id="coincatchSet3Enabled" style="margin-right: 8px; width: 16px; height: 16px;">
                            <span>SET 3: Major 4-Leg (8) ‚ö°</span>
                        </label>
                        <label style="display: flex; align-items: center; color: #888; cursor: pointer;">
                            <input type="checkbox" id="coincatchSet4Enabled" style="margin-right: 8px; width: 16px; height: 16px;">
                            <span>SET 4: Altcoin 4-Leg (10) ü™ô</span>
                        </label>
                        <label style="display: flex; align-items: center; color: #888; cursor: pointer;">
                            <input type="checkbox" id="coincatchSet5Enabled" style="margin-right: 8px; width: 16px; height: 16px;">
                            <span>SET 5: Extended 4-Leg (12) üíé</span>
                        </label>
                    </div>
                    <div style="margin-top: 15px;">
                        <button onclick="viewCoincatchPathDetails()" style="width: 100%; padding: 10px; background: rgba(255,87,34,0.2); color: #FF5722; border: 1px solid #FF5722; border-radius: 5px; cursor: pointer; font-size: 13px; font-weight: 600;">
                            üìã View All Paths (32 Total)
                        </button>
                        <div style="margin-top: 8px; color: #666; font-size: 11px; text-align: center;">
                            ‚úì Settings auto-save on change
                        </div>
                    </div>
                </div>

                <!-- Column 3: Performance Stats -->
                <div class="stat-card">
                    <h4 style="color: #FF5722; margin-bottom: 15px;">üìä Performance Stats</h4>
                    <div style="display: grid; gap: 8px; font-size: 0.8rem;">
                        <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                            <span style="color: #888;">Total Scans:</span>
                            <span id="coincatchTotalScans" style="color: #FF5722; font-weight: 600;">0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                            <span style="color: #888;">Opportunities Found:</span>
                            <span id="coincatchOppsFound" style="color: #FF5722; font-weight: 600;">0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                            <span style="color: #888;">Trades Executed:</span>
                            <span id="coincatchTradesExecuted" style="color: #FF5722; font-weight: 600;">0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                            <span style="color: #888;">Success Rate:</span>
                            <span id="coincatchSuccessRate" style="color: #FF5722; font-weight: 600;">0%</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                            <span style="color: #888;">Total Profit:</span>
                            <span id="coincatchTotalProfit" style="color: #00d26a; font-weight: 600;">$0.00</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 6px 0;">
                            <span style="color: #888;">Avg Profit/Trade:</span>
                            <span id="coincatchAvgProfit" style="color: #00d26a; font-weight: 600;">$0.00</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Balance Tracker with Tabs -->
            <div class="stat-card" style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h4 style="color: #FF5722; margin: 0;">üí∞ Balance Tracker</h4>
                    <button onclick="updateCoincatchBalance()" style="padding: 6px 12px; background: rgba(255,87,34,0.2); color: #FF5722; border: 1px solid #FF5722; border-radius: 5px; cursor: pointer; font-size: 12px;">
                        üîÑ Refresh Balance
                    </button>
                </div>

                <!-- Tab Navigation -->
                <div style="display: flex; gap: 10px; margin-bottom: 15px; border-bottom: 2px solid rgba(255,87,34,0.3); padding-bottom: 10px;">
                    <button onclick="switchCoincatchTab('balance')" id="coincatchTabBalance"
                        style="flex: 1; padding: 8px; background: rgba(255,87,34,0.3); color: #FF5722; border: 1px solid #FF5722; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 13px;">
                        üíµ Balance
                    </button>
                    <button onclick="switchCoincatchTab('trading')" id="coincatchTabTrading"
                        style="flex: 1; padding: 8px; background: rgba(255,255,255,0.05); color: #888; border: 1px solid #555; border-radius: 5px; cursor: pointer; font-size: 13px;">
                        üìà Current Opportunities
                    </button>
                </div>

                <!-- Tab Content: Balance -->
                <div id="coincatchBalanceContent" style="display: block;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                        <div>
                            <div style="color: #666; font-size: 11px; margin-bottom: 4px;">Starting USDT</div>
                            <div id="coincatchStartingUSDT" style="color: #888; font-size: 16px; font-weight: bold;">0.00 USDT</div>
                        </div>
                        <div>
                            <div style="color: #666; font-size: 11px; margin-bottom: 4px;">Current USDT</div>
                            <div id="coincatchCurrentUSDT" style="color: #FF5722; font-size: 16px; font-weight: bold;">0.00 USDT</div>
                        </div>
                        <div>
                            <div style="color: #666; font-size: 11px; margin-bottom: 4px;">Change</div>
                            <div id="coincatchChangeUSDT" style="color: #00d26a; font-size: 16px; font-weight: bold;">+0.00 USDT (0.00%)</div>
                        </div>
                    </div>
                    <button onclick="resetCoincatchStartingBalance()"
                        style="margin-top: 15px; padding: 8px; background: rgba(255,87,34,0.15); color: #FF5722; border: 1px solid rgba(255,87,34,0.5); border-radius: 5px; cursor: pointer; font-size: 12px; width: 100%;">
                        üîÑ Reset Starting Balance (set current as new baseline)
                    </button>
                </div>

                <!-- Tab Content: Current Opportunities -->
                <div id="coincatchTradingContent" style="display: none;">
                    <!-- Scan Button -->
                    <div style="margin-bottom: 15px;">
                        <button onclick="scanCoincatchTriangularPaths()" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #FF5722, #E64A19); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 1rem;">
                            üîç Scan Opportunities Now
                        </button>
                    </div>

                    <!-- Scan Status -->
                    <div id="coincatchScanStatus" style="color: #888; font-size: 13px; margin-bottom: 10px; text-align: center;"></div>
                    <div id="coincatchOpportunities" style="max-height: 300px; overflow-y: auto;">
                        <div style="color: #666; font-size: 13px; text-align: center; padding: 20px;">
                            No active opportunities. Run a scan to discover paths.
                        </div>
                    </div>
                    <button onclick="clearCoincatchHistory()"
                        style="margin-top: 15px; padding: 8px; background: rgba(255,87,34,0.15); color: #FF5722; border: 1px solid rgba(255,87,34,0.5); border-radius: 5px; cursor: pointer; font-size: 12px; width: 100%;">
                        üóëÔ∏è Clear Opportunity History
                    </button>
                </div>
            </div>
        </div>

        <!-- Coinbase Exchange -->
        <div id="coinbase-card" style="display: none; background: rgba(0,82,255,0.1); padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 2px solid #0052FF; position: relative; opacity: 0.5; pointer-events: none;">
            <!-- Coming Soon Overlay -->
            <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); border-radius: 15px; display: flex; align-items: center; justify-content: center; z-index: 10; pointer-events: none;">
                <div style="text-align: center; color: white;">
                    <h2 style="font-size: 2.5rem; margin: 0 0 10px 0; color: #FFD700;">üöß COMING SOON üöß</h2>
                    <p style="font-size: 1.2rem; margin: 0; color: #b8c6db;">Coinbase integration in development</p>
                </div>
            </div>

            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: #0052FF; margin: 0;">üîµ COINBASE Triangular Arbitrage (USDC)</h3>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div class="toggle-switch" id="coinbaseTriangularEnabled" onclick="toggleCoinbaseTriangular()">
                        <div class="toggle-knob"></div>
                    </div>
                    <span id="coinbaseTriangularStatus" style="color: #ff6b6b; font-weight: 600;">OFF</span>
                </div>
            </div>

            <div class="stat-grid">
                <!-- Risk Management -->
                <div class="stat-card">
                    <h4 style="color: #0052FF; margin-bottom: 15px;">‚öñÔ∏è Risk Management</h4>
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Max Trade (USDC)</label>
                        <input type="number" id="coinbaseMaxTrade" value="100" min="10" max="10000" step="10"
                               style="width: 100%; padding: 8px; border: 1px solid #0052FF; border-radius: 5px; background: rgba(0,82,255,0.05);">
                    </div>
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Portfolio % per Trade</label>
                        <input type="number" id="coinbasePortfolioPercent" value="10" min="1" max="50" step="1"
                               style="width: 100%; padding: 8px; border: 1px solid #0052FF; border-radius: 5px; background: rgba(0,82,255,0.05);">
                    </div>
                    <div class="form-group">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Min Profit % Threshold</label>
                        <input type="number" id="coinbaseProfitThreshold" value="0.5" min="0.1" max="5" step="0.1"
                               style="width: 100%; padding: 8px; border: 1px solid #0052FF; border-radius: 5px; background: rgba(0,82,255,0.05);">
                    </div>
                </div>

                <!-- Path Sets Configuration -->
                <div class="stat-card">
                    <h4 style="color: #0052FF; margin-bottom: 15px;">üéØ Triangular Path Sets (32 Paths)</h4>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="coinbaseSet1Enabled" checked style="margin-right: 10px; width: 18px; height: 18px;">
                            <span><strong>SET 1:</strong> Essential ETH Bridge (7 paths) - BTC, SOL, XRP, ADA, DOT, MATIC, LINK</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="coinbaseSet2Enabled" checked style="margin-right: 10px; width: 18px; height: 18px;">
                            <span><strong>SET 2:</strong> Mid-Cap BTC Bridge (7 paths) - ETH, SOL, AVAX, ATOM, LTC, UNI, ALGO</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="coinbaseSet3Enabled" style="margin-right: 10px; width: 18px; height: 18px;">
                            <span><strong>SET 3:</strong> DeFi Native (6 paths) - AAVE, COMP, MKR, SNX, CRV, SUSHI</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="coinbaseSet4Enabled" style="margin-right: 10px; width: 18px; height: 18px;">
                            <span><strong>SET 4:</strong> High Volatility (6 paths) - DOGE, SHIB, APE, GALA, SAND, MANA</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="coinbaseSet5Enabled" style="margin-right: 10px; width: 18px; height: 18px;">
                            <span><strong>SET 5:</strong> Extended Multi-Bridge (6 paths) - FIL, GRT, ICP, CHZ, ENJ + 4-leg path</span>
                        </label>
                    </div>
                </div>

                <!-- Actions -->
                <div class="stat-card">
                    <h4 style="color: #0052FF; margin-bottom: 15px;">üîß Actions</h4>
                    <button onclick="testCoinbaseTriangularConnection()" class="btn" style="background: #0052FF; width: 100%; margin-bottom: 10px;">
                        üîå Test Connection
                    </button>
                    <button onclick="scanCoinbaseTriangularPaths()" class="btn" style="background: #0052FF; width: 100%; margin-bottom: 10px;">
                        üîç Scan Opportunities
                    </button>
                    <button onclick="viewCoinbasePathDetails()" class="btn" style="background: #666; width: 100%; margin-bottom: 10px;">
                        üìã View All Paths
                    </button>
                    <button onclick="clearCoinbaseTriangularHistory()" class="btn" style="background: #ff6b6b; width: 100%; margin-bottom: 10px;">
                        üóëÔ∏è Clear History
                    </button>
                    <button onclick="saveCoinbaseTriangularSettings()" class="btn" style="background: #4CAF50; width: 100%;">
                        üíæ Save Settings
                    </button>
                </div>

                <!-- Current Opportunities -->
                <div class="stat-card" style="grid-column: span 2;">
                    <h4 style="color: #0052FF; margin-bottom: 15px;">üí∞ Current Opportunities</h4>
                    <div id="coinbaseOpportunities" style="max-height: 400px; overflow-y: auto;">
                        <p style="color: #888; text-align: center; padding: 20px;">
                            Click "Scan Opportunities" to find triangular arbitrage paths
                        </p>
                    </div>
                </div>
            </div>
        </div>


        <!-- All 21 Exchanges Complete! -->
        <div style="background: linear-gradient(135deg, rgba(0,255,0,0.1) 0%, rgba(0,170,255,0.1) 100%); padding: 30px; border-radius: 15px; border: 2px solid #00FF00; text-align: center;">
            <h2 style="color: #00FF00; margin: 0 0 15px 0;">üéâ All 21 Exchanges Implemented!</h2>
            <p style="color: #888; margin: 0 0 20px 0; font-size: 16px;">
                Triangular arbitrage functionality is now available across all supported exchanges.
            </p>
            <div style="display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; margin-top: 20px;">
                <span style="background: rgba(0,255,0,0.1); color: #00FF00; padding: 10px 20px; border: 1px solid #00FF00; border-radius: 20px; font-weight: bold;">‚úÖ 21/21 Complete</span>
                <span style="background: rgba(0,170,255,0.1); color: #00AAFF; padding: 10px 20px; border: 1px solid #00AAFF; border-radius: 20px;">600+ Triangular Paths</span>
                <span style="background: rgba(255,170,0,0.1); color: #FFAA00; padding: 10px 20px; border: 1px solid #FFAA00; border-radius: 20px;">Real-time Scanning</span>
            </div>
        </div>
    </div>

    <!-- Triangular Arbitrage About Modal -->
    <div id="triangularAboutModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; justify-content: center; align-items: center;">
        <div style="background: linear-gradient(135deg, #0c0c1e 0%, #161632 100%); padding: 30px; border-radius: 15px; max-width: 600px; width: 90%; border: 2px solid #00d4ff; box-shadow: 0 10px 40px rgba(0,212,255,0.3); position: relative;">
            <!-- Close Button -->
            <button onclick="closeTriangularAboutModal()" style="position: absolute; top: 15px; right: 15px; background: rgba(255,255,255,0.1); border: none; color: #fff; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">
                √ó
            </button>

            <!-- Header -->
            <h2 style="color: #00d4ff; margin: 0 0 20px 0; font-size: 1.5rem;">üî∫ What is Triangular Arbitrage?</h2>

            <!-- Content -->
            <div style="color: #b8c6db; line-height: 1.6; font-size: 0.95rem;">
                <p style="margin: 0 0 15px 0;">
                    <strong style="color: #00ff88;">Triangular arbitrage</strong> exploits price inefficiencies between three different assets on the <strong>same exchange</strong>.
                </p>

                <div style="background: rgba(0,212,255,0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #00d4ff; margin-bottom: 15px;">
                    <strong style="color: #00d4ff; display: block; margin-bottom: 8px;">Example Path:</strong>
                    <div style="font-family: monospace; color: #00ff88;">
                        ZAR ‚Üí ETH ‚Üí USDT ‚Üí ZAR
                    </div>
                </div>

                <p style="margin: 0 0 15px 0;">
                    <strong style="color: #ffb347;">How it works:</strong>
                </p>
                <ol style="margin: 0 0 15px 0; padding-left: 25px;">
                    <li style="margin-bottom: 8px;">Start with <strong>ZAR</strong> (South African Rand)</li>
                    <li style="margin-bottom: 8px;">Buy <strong>ETH</strong> using your ZAR</li>
                    <li style="margin-bottom: 8px;">Sell ETH for <strong>USDT</strong></li>
                    <li style="margin-bottom: 8px;">Sell USDT back to <strong>ZAR</strong></li>
                </ol>

                <p style="margin: 0 0 15px 0;">
                    If the exchange rates are misaligned, you end up with <strong style="color: #00ff88;">more ZAR than you started with</strong> ‚Äî that's your profit! üí∞
                </p>

                <div style="background: rgba(255,152,0,0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #ffb347; margin-bottom: 0;">
                    <strong style="color: #ffb347;">Key Difference:</strong> Unlike cross-exchange arbitrage (buying on one exchange, selling on another), triangular arbitrage happens <strong>entirely on one exchange</strong>, making it faster and avoiding transfer delays.
                </div>
            </div>
        </div>
    </div>

    <script>
        // API Base URL Configuration
        const API_BASE = '/api/v1';

        // Return to Platform Function
        function returnToPlatform() {
            // Set triangular toggle state to OFF
            localStorage.setItem('triangularPageActive', 'false');

            // Navigate back to main platform
            window.location.href = '/';
        }

        // Notification Utility Function
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 25px;
                border-radius: 8px;
                color: white;
                font-weight: bold;
                z-index: 10000;
                animation: slideIn 0.3s ease-out;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            `;

            // Set background color based on type
            const colors = {
                success: '#00FF00',
                error: '#FF0000',
                warning: '#FFA500',
                info: '#00AADD'
            };
            notification.style.background = colors[type] || colors.info;
            notification.textContent = message;

            // Add to page
            document.body.appendChild(notification);

            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // ============================================================================
        // TEST SCAN FUNCTIONALITY (Using Shared TestScanService)
        // ============================================================================

        // Initialize TestScanService with triangular arbitrage configuration
        const testScanService = new TestScanService(triangularArbConfig);

        // Test Scan State
        let testScanInterval = null;
        let testScanDurationInterval = null;
        let testScanState = {
            isRunning: false,
            isPaused: false,
            startTime: null,
            scanCount: 0,
            currentExchange: 'valr'
        };

        // Path Sets Configuration for Each Exchange
        const exchangePathSets = {
            valr: [
                { set: 1, name: 'ETH', paths: 4 },
                { set: 2, name: 'XRP', paths: 4 },
                { set: 3, name: 'SOL', paths: 4 },
                { set: 4, name: 'BNB', paths: 4 },
                { set: 5, name: 'SHIB', paths: 4 },
                { set: 6, name: 'AVAX', paths: 4 },
                { set: 7, name: 'DOGE', paths: 4 },
                { set: 8, name: 'TRX', paths: 4 },
                { set: 9, name: 'LTC', paths: 4 },
                { set: 10, name: 'RLUSD', paths: 4 },
                { set: 11, name: 'LINK', paths: 4 },
                { set: 12, name: 'XLM', paths: 4 }
            ],
            luno: [
                { set: 1, name: 'BTC', paths: 4 },
                { set: 2, name: 'ETH', paths: 4 },
                { set: 3, name: 'XRP', paths: 4 },
                { set: 4, name: 'LTC', paths: 4 },
                { set: 5, name: 'BCH', paths: 4 },
                { set: 6, name: 'USDC', paths: 4 }
            ],
            kraken: [
                { set: 1, name: 'BTC_USD', paths: 12 },
                { set: 2, name: 'ETH_USD', paths: 12 },
                { set: 3, name: 'BTC_USDT', paths: 12 },
                { set: 4, name: 'ETH_USDT', paths: 12 },
                { set: 5, name: 'SOL', paths: 12 },
                { set: 6, name: 'XRP', paths: 12 },
                { set: 7, name: 'ADA', paths: 12 },
                { set: 8, name: 'DOT', paths: 12 },
                { set: 9, name: 'MATIC', paths: 12 },
                { set: 10, name: 'AVAX', paths: 12 }
            ],
            binance: [
                { set: 1, name: 'BTC', paths: 6 },
                { set: 2, name: 'ETH', paths: 6 },
                { set: 3, name: 'BNB', paths: 6 },
                { set: 4, name: 'SOL', paths: 6 },
                { set: 5, name: 'XRP', paths: 6 },
                { set: 6, name: 'ADA', paths: 6 },
                { set: 7, name: 'DOGE', paths: 6 },
                { set: 8, name: 'MATIC', paths: 6 },
                { set: 9, name: 'DOT', paths: 6 },
                { set: 10, name: 'AVAX', paths: 6 }
            ],
            bybit: [
                { set: 1, name: 'BTC', paths: 4 },
                { set: 2, name: 'ETH', paths: 4 },
                { set: 3, name: 'SOL', paths: 4 },
                { set: 4, name: 'XRP', paths: 4 },
                { set: 5, name: 'BNB', paths: 4 },
                { set: 6, name: 'DOGE', paths: 4 },
                { set: 7, name: 'ADA', paths: 4 },
                { set: 8, name: 'MATIC', paths: 4 },
                { set: 9, name: 'DOT', paths: 4 },
                { set: 10, name: 'AVAX', paths: 4 }
            ],
            kucoin: [
                { set: 1, name: 'BTC', paths: 6 },
                { set: 2, name: 'ETH', paths: 6 },
                { set: 3, name: 'SOL', paths: 6 },
                { set: 4, name: 'XRP', paths: 6 },
                { set: 5, name: 'BNB', paths: 6 },
                { set: 6, name: 'ADA', paths: 6 },
                { set: 7, name: 'DOGE', paths: 6 },
                { set: 8, name: 'MATIC', paths: 6 }
            ]
        };

        // Load test scan settings from localStorage
        function loadTestScanSettings() {
            const minProfit = localStorage.getItem('testScan_minProfit');
            const interval = localStorage.getItem('testScan_interval');
            const amount = localStorage.getItem('testScan_amount');

            if (minProfit !== null) {
                document.getElementById('testScanMinProfit').value = minProfit;
            }
            if (interval !== null) {
                document.getElementById('testScanInterval').value = interval;
            }
            if (amount !== null) {
                document.getElementById('testScanAmount').value = amount;
            }
        }

        // Save test scan settings to localStorage
        function saveTestScanSettings() {
            const minProfit = document.getElementById('testScanMinProfit').value;
            const interval = document.getElementById('testScanInterval').value;
            const amount = document.getElementById('testScanAmount').value;

            localStorage.setItem('testScan_minProfit', minProfit);
            localStorage.setItem('testScan_interval', interval);
            localStorage.setItem('testScan_amount', amount);
        }

        // Update path sets when exchange changes
        document.addEventListener('DOMContentLoaded', function() {
            const exchangeSelect = document.getElementById('testScanExchange');
            if (exchangeSelect) {
                exchangeSelect.addEventListener('change', updateTestPathSets);
                // Initialize with VALR paths
                updateTestPathSets();
            }

            // Load saved test scan settings
            loadTestScanSettings();

            // Add event listeners to save settings when they change
            const settingsInputs = ['testScanMinProfit', 'testScanInterval', 'testScanAmount'];
            settingsInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    input.addEventListener('change', saveTestScanSettings);
                    input.addEventListener('blur', saveTestScanSettings); // Save on blur too
                }
            });
        });

        function updateTestPathSets() {
            const exchange = document.getElementById('testScanExchange').value;
            const pathSetsContainer = document.getElementById('testScanPathSets');
            const sets = exchangePathSets[exchange] || [];

            // Load saved checkbox states from localStorage
            const savedStates = JSON.parse(localStorage.getItem('testScan_triangular_pathSets') || '{}');
            const exchangeStates = savedStates[exchange] || {};

            let html = '';
            sets.forEach((set, index) => {
                // Check if we have a saved state, otherwise default to first 4 checked
                const checked = exchangeStates.hasOwnProperty(set.set)
                    ? (exchangeStates[set.set] ? 'checked' : '')
                    : (index < 4 ? 'checked' : '');

                html += `
                    <div style="grid-column: 1 / -1; display: flex; flex-direction: column; gap: 5px; margin-bottom: 5px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span
                                onclick="togglePathDetails('set${set.set}')"
                                style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center; gap: 5px; flex: 1;"
                                title="Click to see details"
                            >
                                <span id="set${set.set}-icon" style="color: #00d4ff; font-size: 0.7rem;">‚ñ∂</span>
                                SET ${set.set}: ${set.name} (${set.paths} paths)
                            </span>
                            <input type="checkbox" class="test-scan-path" data-set="${set.set}" ${checked}>
                        </div>
                        <div
                            id="set${set.set}-details"
                            style="display: none; padding-left: 20px; font-size: 0.75rem; color: #8899aa; border-left: 2px solid rgba(0,212,255,0.3); margin-left: 5px; padding: 8px;"
                        >
                            <div style="margin-bottom: 5px;"><strong style="color: #00d4ff;">Focus:</strong> ${set.name}-based triangular arbitrage</div>
                            <div style="margin-bottom: 5px;"><strong style="color: #00d4ff;">Paths:</strong> ${set.paths} unique triangular routes</div>
                            <div style="margin-bottom: 5px;"><strong style="color: #00d4ff;">Structure:</strong> ZAR ‚Üî ${set.name} ‚Üî USDT ‚Üî ZAR (and variations)</div>
                            <div style="color: #ffb347; font-size: 0.7rem; margin-top: 8px;">üí° Tip: Run a test scan and check the browser console debug output to see full path IDs and sequences</div>
                        </div>
                    </div>
                `;
            });

            pathSetsContainer.innerHTML = html;
            testScanState.currentExchange = exchange;

            // Add event listeners to save state when checkboxes change
            document.querySelectorAll('.test-scan-path').forEach(cb => {
                cb.addEventListener('change', saveTestPathStates);
            });
        }

        // Toggle path set details expand/collapse
        function togglePathDetails(setId) {
            const details = document.getElementById(`${setId}-details`);
            const icon = document.getElementById(`${setId}-icon`);

            if (!details || !icon) return; // Safety check

            // Check if currently hidden (display is 'none' or empty)
            const isHidden = details.style.display === 'none' || details.style.display === '';

            if (isHidden) {
                // Show details
                details.style.display = 'block';
                icon.textContent = '‚ñº';
            } else {
                // Hide details
                details.style.display = 'none';
                icon.textContent = '‚ñ∂';
            }
        }

        function saveTestPathStates() {
            const exchange = testScanState.currentExchange;
            const savedStates = JSON.parse(localStorage.getItem('testScan_triangular_pathSets') || '{}');

            // Get current checkbox states
            const currentStates = {};
            document.querySelectorAll('.test-scan-path').forEach(cb => {
                currentStates[parseInt(cb.dataset.set)] = cb.checked;
            });

            // Save for this exchange
            savedStates[exchange] = currentStates;
            localStorage.setItem('testScan_triangular_pathSets', JSON.stringify(savedStates));
        }

        function selectAllTestPaths() {
            document.querySelectorAll('.test-scan-path').forEach(cb => cb.checked = true);
            saveTestPathStates();
        }

        function deselectAllTestPaths() {
            document.querySelectorAll('.test-scan-path').forEach(cb => cb.checked = false);
            saveTestPathStates();
        }

        function getSelectedTestPaths() {
            const selected = [];
            document.querySelectorAll('.test-scan-path:checked').forEach(cb => {
                selected.push(parseInt(cb.dataset.set));
            });
            return selected;
        }

        async function startTestScan() {
            if (testScanState.isRunning) {
                showNotification('Test scan is already running', 'warning');
                return;
            }

            const selectedPaths = getSelectedTestPaths();
            if (selectedPaths.length === 0) {
                showNotification('Please select at least one path set to scan', 'warning');
                return;
            }

            testScanState.isRunning = true;
            testScanState.isPaused = false;
            testScanState.startTime = Date.now();
            testScanState.scanCount = 0;

            document.getElementById('testScanStatus').textContent = 'RUNNING';
            document.getElementById('testScanStatus').style.color = '#00ff88';

            showNotification('Test scan started', 'success');

            // Get scan interval
            const interval = parseInt(document.getElementById('testScanInterval').value) * 1000;

            // Run first scan immediately
            await performTestScan();

            // Set up interval for subsequent scans
            testScanInterval = setInterval(performTestScan, interval);

            // Update duration timer
            testScanDurationInterval = setInterval(updateTestScanDuration, 1000);
        }

        function pauseTestScan() {
            if (!testScanState.isRunning) {
                showNotification('No test scan is running', 'warning');
                return;
            }

            if (testScanState.isPaused) {
                // Resume
                testScanState.isPaused = false;
                document.getElementById('testScanStatus').textContent = 'RUNNING';
                document.getElementById('testScanStatus').style.color = '#00ff88';
                showNotification('Test scan resumed', 'info');
            } else {
                // Pause
                testScanState.isPaused = true;
                document.getElementById('testScanStatus').textContent = 'PAUSED';
                document.getElementById('testScanStatus').style.color = '#ffb347';
                showNotification('Test scan paused', 'info');
            }
        }

        function stopTestScan() {
            if (!testScanState.isRunning) {
                showNotification('No test scan is running', 'warning');
                return;
            }

            clearInterval(testScanInterval);
            clearInterval(testScanDurationInterval);
            testScanState.isRunning = false;
            testScanState.isPaused = false;

            document.getElementById('testScanStatus').textContent = 'STOPPED';
            document.getElementById('testScanStatus').style.color = '#ff6b6b';

            showNotification('Test scan stopped - analyzing data...', 'info');

            // Update analysis report
            updateTestAnalysisReport();

            // Show analysis section
            document.getElementById('testScanAnalysis').style.display = 'block';
        }

        async function performTestScan() {
            // Exit immediately if scan is paused or stopped
            if (testScanState.isPaused || !testScanState.isRunning) {
                console.log('[TEST SCAN] performTestScan exiting - scan is stopped or paused');
                return;
            }

            const exchange = testScanState.currentExchange;
            const selectedSets = getSelectedTestPaths();
            const minProfit = parseFloat(document.getElementById('testScanMinProfit').value);
            const testAmount = parseFloat(document.getElementById('testScanAmount').value);

            console.log('[TEST SCAN] performTestScan called', { exchange, selectedSets, minProfit, testAmount });

            try {
                // Call the exchange-specific scan function
                let opportunities = [];

                switch(exchange) {
                    case 'valr':
                        opportunities = await scanValrTestPaths(selectedSets, minProfit, testAmount);
                        break;
                    case 'luno':
                        opportunities = await scanLunoTestPaths(selectedSets, minProfit, testAmount);
                        break;
                    case 'kraken':
                        opportunities = await scanKrakenTestPaths(selectedSets, minProfit, testAmount);
                        break;
                    case 'binance':
                        opportunities = await scanBinanceTestPaths(selectedSets, minProfit, testAmount);
                        break;
                    case 'bybit':
                        opportunities = await scanBybitTestPaths(selectedSets, minProfit, testAmount);
                        break;
                    case 'kucoin':
                        opportunities = await scanKucoinTestPaths(selectedSets, minProfit, testAmount);
                        break;
                    default:
                        console.error('Unknown exchange:', exchange);
                }

                console.log('[TEST SCAN] Scan returned', opportunities.length, 'opportunities');

                // Store opportunities
                if (opportunities.length > 0) {
                    console.log('[TEST SCAN] Storing opportunities...');
                    storeTestOpportunities(opportunities);
                } else {
                    console.log('[TEST SCAN] No opportunities to store (0 found)');
                }

                testScanState.scanCount++;
                updateTestStorageStats();

                // Update analysis report if visible
                if (document.getElementById('testScanAnalysis').style.display !== 'none') {
                    console.log('[TEST SCAN] Updating analysis report...');
                    updateTestAnalysisReport();
                }

            } catch (error) {
                console.error('[TEST SCAN] Error in performTestScan:', error);
                showNotification(`Scan error: ${error.message}`, 'error');
            }
        }

        // Scan functions for each exchange (using existing scan logic)
        async function scanValrTestPaths(selectedSets, minProfit, testAmount) {
            // This will call the same backend API that the live trading uses
            // but we won't execute trades - just collect data
            const opportunities = [];

            console.log('[TEST SCAN] Starting VALR scan...', { selectedSets, minProfit, testAmount });

            for (const setNum of selectedSets) {
                // Check if scan has been stopped
                if (!testScanState.isRunning) {
                    console.log('[TEST SCAN] Scan stopped by user - breaking out of loop');
                    break;
                }

                const setName = `SET_${setNum}`;
                const backendSet = setNameMapping[setName];

                if (!backendSet) {
                    console.warn(`[TEST SCAN] No mapping found for ${setName}`);
                    continue;
                }

                console.log(`[TEST SCAN] Scanning ${setName} (${backendSet})...`);

                try {
                    // Use public endpoint (no auth needed for TEST scan)
                    const response = await fetch(`${API_BASE}/trading/valr/triangular/scan`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            paths: backendSet,
                            amount: testAmount,
                            profitThreshold: minProfit  // Fixed: backend expects 'profitThreshold' not 'minProfitPercent'
                        })
                    });

                    console.log(`[TEST SCAN] ${setName} response status:`, response.status);

                    if (response.ok) {
                        const result = await response.json();
                        console.log(`[TEST SCAN] ${setName} backend response:`, result);

                        // Log detailed debug info from backend
                        if (result.data?.debug) {
                            const d = result.data.debug;
                            console.log(`
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
‚ïë üîç VALR ${setName} - DETAILED SCAN DEBUG
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üìã STEP 1: Path Definitions Loaded
   ‚úÖ Paths loaded: ${d.step1_pathsLoaded}
   üìù Path IDs: ${d.step1_pathIds.join(', ')}

üìä STEP 2: Unique Pairs Extracted
   ‚úÖ Pairs needed: ${d.step2_uniquePairs.length}
   üìù Pairs: ${d.step2_uniquePairs.join(', ')}

üìñ STEP 3: Orderbooks Fetched
   ‚úÖ Fetched: ${d.step3_orderbooksFetched}/${d.step3_orderbooksRequested}
   ‚ùå Failed: ${d.step3_orderbooksRequested - d.step3_orderbooksFetched}
   üìù Pairs fetched: ${d.step3_orderbookPairs.join(', ')}
   ${d.step3_sampleOrderbook ? `üìñ Sample (${d.step3_sampleOrderbook.pair}): ${d.step3_sampleOrderbook.bidsCount} bids, ${d.step3_sampleOrderbook.asksCount} asks` : '‚ùå No orderbooks fetched'}

üí∞ STEP 4: Profit Calculations
   ‚úÖ Successful: ${d.step4_calculationsSuccessful}
   ‚ùå Failed: ${d.step4_calculationsFailed}
   üìâ Below threshold (${d.step4_profitThreshold}%): ${d.step4_calculationsBelowThreshold}

üéØ RESULT: ${result.data.opportunitiesFound} opportunities found
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                            `);
                        }

                        // Check response structure
                        const resultOpps = result.data?.opportunities || result.opportunities || [];
                        console.log(`[TEST SCAN] ${setName} found ${resultOpps.length} opportunities`);

                        if (resultOpps.length > 0) {
                            resultOpps.forEach(opp => {
                                opportunities.push({
                                    exchange: 'VALR',
                                    path: opp.path,
                                    baseCrypto: opp.baseCurrency || backendSet.split('_')[2],
                                    netProfitPercent: opp.profitPercentage,
                                    totalFees: opp.totalFees || 0,
                                    slippage: opp.slippage || 0,
                                    liquidity: opp.liquidity || 3,
                                    timestamp: Date.now()
                                });
                            });
                            console.log(`[TEST SCAN] ${setName} added ${resultOpps.length} opportunities to collection`);
                        }
                    } else {
                        const errorText = await response.text();
                        console.error(`[TEST SCAN] ${setName} error response:`, errorText);
                    }
                } catch (error) {
                    console.error(`[TEST SCAN] Error scanning VALR ${setName}:`, error);
                }

                // Add delay between sets to avoid VALR rate limiting
                // Each set makes ~23 requests over ~23 seconds, need 30s cooldown for VALR rate limit to reset
                const setIndex = selectedSets.indexOf(setNum);
                if (setIndex < selectedSets.length - 1) {
                    console.log('[TEST SCAN] Waiting 30 seconds before next set (VALR rate limit cooldown)...');
                    await new Promise(resolve => setTimeout(resolve, 30000));
                }
            }

            console.log(`[TEST SCAN] VALR scan complete. Total opportunities: ${opportunities.length}`);
            return opportunities;
        }

        async function scanLunoTestPaths(selectedSets, minProfit, testAmount) {
            // Similar implementation for Luno
            const opportunities = [];
            // TODO: Implement Luno-specific scanning
            return opportunities;
        }

        async function scanKrakenTestPaths(selectedSets, minProfit, testAmount) {
            // Similar implementation for Kraken
            const opportunities = [];
            // TODO: Implement Kraken-specific scanning
            return opportunities;
        }

        async function scanBinanceTestPaths(selectedSets, minProfit, testAmount) {
            // Similar implementation for Binance
            const opportunities = [];
            // TODO: Implement Binance-specific scanning
            return opportunities;
        }

        async function scanBybitTestPaths(selectedSets, minProfit, testAmount) {
            // Similar implementation for Bybit
            const opportunities = [];
            // TODO: Implement Bybit-specific scanning
            return opportunities;
        }

        async function scanKucoinTestPaths(selectedSets, minProfit, testAmount) {
            // Similar implementation for KuCoin
            const opportunities = [];
            // TODO: Implement KuCoin-specific scanning
            return opportunities;
        }

        function storeTestOpportunities(opportunities) {
            // Use shared TestScanService
            testScanService.storeOpportunities(opportunities);
        }

        function getTestScanData() {
            // Use shared TestScanService
            return testScanService.getData();
        }

        function clearTestScanData() {
            if (!confirm('Are you sure you want to clear all test scan data? This cannot be undone.')) {
                return;
            }

            // Use shared TestScanService
            testScanService.clearData();

            // Reset storage stats
            document.getElementById('testStoredCount').textContent = '0';
            document.getElementById('testUniqueRoutes').textContent = '0';
            document.getElementById('testStorageUsed').textContent = '0%';

            // Clear all report tables
            document.getElementById('testTopProfitTable').innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 30px; color: #888; font-style: italic;">Waiting for scan data... Click "Start Scan" above.</td></tr>';
            document.getElementById('testTopConsistencyTable').innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 30px; color: #888; font-style: italic;">Waiting for scan data... Click "Start Scan" above.</td></tr>';
            document.getElementById('testBestCryptosTable').innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 20px; color: #888;">Waiting for scan data...</td></tr>';
            document.getElementById('testBestExchangesTable').innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 20px; color: #888;">Waiting for scan data...</td></tr>';
            document.getElementById('testTimeAnalysisTable').innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px; color: #888;">Waiting for scan data...</td></tr>';

            showNotification('Test scan data cleared', 'success');
        }

        function updateTestStorageStats() {
            // Use shared TestScanService
            const stats = testScanService.getStorageStats();
            const data = testScanService.getData();
            const uniqueRoutes = new Set(data.map(d => d.routeKey)).size;

            document.getElementById('testStoredCount').textContent = stats.routeCount.toLocaleString();
            document.getElementById('testUniqueRoutes').textContent = uniqueRoutes.toLocaleString();
            document.getElementById('testStorageUsed').textContent = stats.storagePercent.toFixed(1) + '%';
        }

        function updateTestScanDuration() {
            if (!testScanState.startTime) return;

            const elapsed = Date.now() - testScanState.startTime;
            const hours = Math.floor(elapsed / 3600000);
            const minutes = Math.floor((elapsed % 3600000) / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);

            const formatted = `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('testScanDuration').textContent = formatted;
        }

        function updateTestAnalysisReport() {
            // Use shared TestScanService for analysis
            const analysis = testScanService.analyzeData(20);

            if (analysis.summary.totalOpportunities === 0) {
                // Show empty state for all tables
                document.getElementById('testTopProfitTable').innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 30px; color: #888; font-style: italic;">Waiting for scan data... Click "Start Scan" above.</td></tr>';
                document.getElementById('testTopConsistencyTable').innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 30px; color: #888; font-style: italic;">Waiting for scan data... Click "Start Scan" above.</td></tr>';
                document.getElementById('testBestCryptosTable').innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 20px; color: #888;">Waiting for scan data...</td></tr>';
                document.getElementById('testBestExchangesTable').innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 20px; color: #888;">Waiting for scan data...</td></tr>';
                document.getElementById('testTimeAnalysisTable').innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px; color: #888;">Waiting for scan data...</td></tr>';
                return;
            }

            // Update Top 20 Paths by Profit %
            updateTestTopProfitTable(analysis.topProfit);

            // Update Top 20 Paths by Consistency
            updateTestTopConsistencyTable(analysis.topConsistency);

            // Update Best Cryptos
            updateTestBestCryptosTable(analysis.bestAssets);

            // Update Best Exchanges
            updateTestBestExchangesTable(analysis.bestExchanges);

            // Update Time Analysis
            updateTestTimeAnalysisTable(analysis.timeAnalysis);
        }

        function updateTestTopProfitTable(routes) {
            const tbody = document.getElementById('testTopProfitTable');
            if (routes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 30px; color: #888;">No data yet</td></tr>';
                return;
            }

            tbody.innerHTML = routes.map((route, i) => {
                const example = route.examples[0]; // Get first example for exchange/path/crypto details
                const pathDisplay = example.path || route.routeKey;
                const liquidityRating = example.liquidity || 3;

                return `
                <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                    <td style="padding: 10px; color: #ffc107; font-weight: bold;">${i + 1}</td>
                    <td style="padding: 10px;">${(example.exchange || 'Unknown').toUpperCase()}</td>
                    <td style="padding: 10px; color: #00d4ff; font-size: 0.85rem;">${pathDisplay}</td>
                    <td style="padding: 10px; color: #00ff88; font-weight: bold;">${example.baseCrypto || ''}</td>
                    <td style="padding: 10px; text-align: right; color: #00ff88; font-weight: bold;">${route.avgProfit.toFixed(2)}%</td>
                    <td style="padding: 10px; text-align: right; color: #ffc107;">${route.maxProfit.toFixed(2)}%</td>
                    <td style="padding: 10px; text-align: right;">${route.count}</td>
                    <td style="padding: 10px; text-align: center;">${getLiquidityBadge(liquidityRating)}</td>
                    <td style="padding: 10px; text-align: right; color: #888; font-size: 0.8rem;">${formatTimestamp(example.timestamp)}</td>
                </tr>
                `;
            }).join('');
        }

        function updateTestTopConsistencyTable(routes) {
            const tbody = document.getElementById('testTopConsistencyTable');
            if (routes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 30px; color: #888;">No data yet</td></tr>';
                return;
            }

            tbody.innerHTML = routes.map((route, i) => {
                const example = route.examples[0];
                const pathDisplay = example.path || route.routeKey;

                return `
                <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                    <td style="padding: 10px; color: #00d4ff; font-weight: bold;">${i + 1}</td>
                    <td style="padding: 10px;">${(example.exchange || 'Unknown').toUpperCase()}</td>
                    <td style="padding: 10px; color: #00d4ff; font-size: 0.85rem;">${pathDisplay}</td>
                    <td style="padding: 10px; color: #00ff88; font-weight: bold;">${example.baseCrypto || ''}</td>
                    <td style="padding: 10px; text-align: right; font-weight: bold; color: #00d4ff;">${route.count}</td>
                    <td style="padding: 10px; text-align: right; color: #00ff88;">${route.avgProfit.toFixed(2)}%</td>
                    <td style="padding: 10px; text-align: right; color: #888; font-size: 0.85rem;">${route.minProfit.toFixed(2)}% / ${route.maxProfit.toFixed(2)}%</td>
                    <td style="padding: 10px; text-align: center;">${getConsistencyBadge(route.consistency)}</td>
                </tr>
                `;
            }).join('');
        }

        function updateTestBestCryptosTable(cryptos) {
            const tbody = document.getElementById('testBestCryptosTable');
            if (cryptos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 20px; color: #888;">No data yet</td></tr>';
                return;
            }

            tbody.innerHTML = cryptos.map(crypto => `
                <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                    <td style="padding: 10px; color: #667eea; font-weight: bold;">${crypto.asset}</td>
                    <td style="padding: 10px; text-align: right; color: #00d4ff;">${crypto.count}</td>
                    <td style="padding: 10px; text-align: right; color: #00ff88;">${crypto.avgProfit.toFixed(2)}%</td>
                </tr>
            `).join('');
        }

        function updateTestBestExchangesTable(exchanges) {
            const tbody = document.getElementById('testBestExchangesTable');
            if (exchanges.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 20px; color: #888;">No data yet</td></tr>';
                return;
            }

            tbody.innerHTML = exchanges.map(ex => `
                <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                    <td style="padding: 10px; color: #ffb347; font-weight: bold;">${ex.pair.toUpperCase()}</td>
                    <td style="padding: 10px; text-align: right; color: #00d4ff;">${ex.count}</td>
                    <td style="padding: 10px; text-align: right; color: #00ff88;">${ex.avgProfit.toFixed(2)}%</td>
                </tr>
            `).join('');
        }

        function updateTestTimeAnalysisTable(hourStats) {
            const tbody = document.getElementById('testTimeAnalysisTable');
            const hours = Object.keys(hourStats).filter(h => hourStats[h].count > 0).sort((a, b) => hourStats[b].count - hourStats[a].count).slice(0, 10);

            if (hours.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px; color: #888;">Need more scanning data for time analysis...</td></tr>';
                return;
            }

            tbody.innerHTML = hours.map(hour => {
                const stats = hourStats[hour];
                const avgProfit = stats.profits.reduce((a, b) => a + b, 0) / stats.profits.length;
                const mostCommonRoute = Object.keys(stats.routes).reduce((a, b) => stats.routes[a] > stats.routes[b] ? a : b);

                return `
                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                        <td style="padding: 10px; color: #ffc107; font-weight: bold;">${hour}:00 - ${hour}:59</td>
                        <td style="padding: 10px; text-align: right; color: #00d4ff;">${stats.count}</td>
                        <td style="padding: 10px; text-align: right; color: #00ff88;">${avgProfit.toFixed(2)}%</td>
                        <td style="padding: 10px; color: #b8c6db; font-size: 0.85rem;">${mostCommonRoute}</td>
                    </tr>
                `;
            }).join('');
        }

        // Helper Functions
        function getLiquidityBadge(liquidity) {
            if (liquidity >= 4) {
                return '<span style="background: rgba(0,255,136,0.2); color: #00ff88; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">üü¢ ' + liquidity + '/5</span>';
            } else if (liquidity >= 2) {
                return '<span style="background: rgba(255,179,71,0.2); color: #ffb347; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">üü° ' + liquidity + '/5</span>';
            } else {
                return '<span style="background: rgba(255,107,107,0.2); color: #ff6b6b; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">üî¥ ' + liquidity + '/5</span>';
            }
        }

        function getConsistencyBadge(consistency) {
            const stars = Math.min(5, Math.max(1, Math.round(consistency / 20)));
            const starSymbols = '‚≠ê'.repeat(stars);
            return `<span style="font-size: 1rem;">${starSymbols}</span>`;
        }

        function formatTimestamp(timestamp) {
            const now = Date.now();
            const diff = now - timestamp;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);

            if (days > 0) return `${days}d ago`;
            if (hours > 0) return `${hours}h ago`;
            if (minutes > 0) return `${minutes}m ago`;
            return 'Just now';
        }

        function exportTestScanData() {
            // Use shared TestScanService
            const exportData = testScanService.exportData();

            if (exportData.opportunities.length === 0) {
                showNotification('No data to export', 'warning');
                return;
            }

            // Add scan state info
            exportData.exchange = testScanState.currentExchange;
            exportData.scanCount = testScanState.scanCount;

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `triangular-test-scan-${testScanState.currentExchange}-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);

            showNotification('Data exported successfully', 'success');
        }

        // ============================================================================
        // END TEST SCAN FUNCTIONALITY
        // ============================================================================

        // Triangular Arbitrage JavaScript Functions

        // ============================================================================
        // VALR AUTOMATED WORKER
        // ============================================================================

        // Map SET_1, SET_2, etc. to backend set names (Only 12 valid ZAR-USDT triangular sets)
        const setNameMapping = {
            'SET_1': 'SET_1_ETH_FOCUS',
            'SET_2': 'SET_2_XRP_FOCUS',
            'SET_3': 'SET_3_SOL_FOCUS',
            'SET_4': 'SET_4_BNB_FOCUS',
            'SET_5': 'SET_5_SHIB_FOCUS',
            'SET_6': 'SET_6_AVAX_FOCUS',
            'SET_7': 'SET_7_DOGE_FOCUS',
            'SET_8': 'SET_8_TRX_FOCUS',
            'SET_9': 'SET_9_LTC_FOCUS',
            // 'SET_10': Removed - RLUSD pairs not supported on VALR
            'SET_11': 'SET_11_LINK_FOCUS',
            'SET_12': 'SET_12_XLM_FOCUS'
        };

        let valrWorkerInterval = null;
        let valrWorkerStats = {
            totalScans: 0,
            totalOpportunities: 0,
            totalTrades: 0,
            successfulTrades: 0,
            totalProfit: 0,
            bestPath: null,
            bestProfit: 0
        };

        // Balance tracking
        let valrBalanceTracking = {
            startingZAR: null,
            startingUSDT: null,
            currentZAR: 0,
            currentUSDT: 0
        };

        // Alerts tracking
        let valrAlerts = [];
        const MAX_ALERTS = 20; // Keep last 20 alerts

        // ========== TAB SWITCHING ==========
        // Handle tab switching
        document.addEventListener('DOMContentLoaded', function() {
            const tabButtons = document.querySelectorAll('.valr-tab-btn');
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    switchValrTab(tabName);
                });
            });
        });

        function switchValrTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.valr-tab-content').forEach(content => {
                content.style.display = 'none';
            });

            // Remove active class from all buttons and reset styling
            document.querySelectorAll('.valr-tab-btn').forEach(btn => {
                btn.style.background = 'rgba(255,255,255,0.03)';
                btn.style.borderColor = 'transparent';
                btn.style.color = '#888';
                btn.classList.remove('active');
            });

            // Show selected tab content
            if (tabName === 'trades') {
                document.getElementById('valrTabTrades').style.display = 'block';
            } else if (tabName === 'balance') {
                document.getElementById('valrTabBalance').style.display = 'block';
            } else if (tabName === 'alerts') {
                document.getElementById('valrTabAlerts').style.display = 'block';
            }

            // Highlight active button with enhanced styling
            const activeButton = document.querySelector(`.valr-tab-btn[data-tab="${tabName}"]`);
            if (activeButton) {
                activeButton.style.background = 'rgba(0,255,136,0.15)';
                activeButton.style.borderColor = '#00ff88';
                activeButton.style.color = '#00ff88';
                activeButton.classList.add('active');
            }
        }

        // ========== BALANCE TRACKING ==========
        async function initializeValrBalance(apiKey, apiSecret) {
            try {
                // Fetch current balance from VALR (same endpoint as Strategy API Setup page)
                const response = await fetch(`${API_BASE}/trading/valr/balance`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ apiKey, apiSecret })
                });

                const result = await response.json();
                console.log('üí∞ [VALR Balance] API Response:', result);

                // Handle different response formats
                let balances = null;
                if (result.success && result.data) {
                    balances = result.data.balances || result.data;
                } else if (result.success && result.balances) {
                    balances = result.balances;
                } else if (result.balances) {
                    balances = result.balances;
                }

                console.log('üí∞ [VALR Balance] Parsed balances:', balances);

                if (balances) {
                    // Balances is an object like { ZAR: "5000.50", USDT: "123.45", ... }
                    const currentZAR = balances.ZAR ? parseFloat(balances.ZAR) : 0;
                    const currentUSDT = balances.USDT ? parseFloat(balances.USDT) : 0;

                    // Check if starting balance is already set (from localStorage)
                    const stored = localStorage.getItem('valrStartingBalance');
                    if (stored) {
                        const parsed = JSON.parse(stored);
                        valrBalanceTracking.startingZAR = parsed.zar;
                        valrBalanceTracking.startingUSDT = parsed.usdt;
                    } else {
                        // First time - set current as starting
                        valrBalanceTracking.startingZAR = currentZAR;
                        valrBalanceTracking.startingUSDT = currentUSDT;
                        localStorage.setItem('valrStartingBalance', JSON.stringify({
                            zar: currentZAR,
                            usdt: currentUSDT
                        }));
                    }

                    valrBalanceTracking.currentZAR = currentZAR;
                    valrBalanceTracking.currentUSDT = currentUSDT;

                    updateValrBalanceDisplay();
                    console.log('‚úÖ [VALR Balance] Initialized:', valrBalanceTracking);
                }
            } catch (error) {
                console.error('‚ùå [VALR Balance] Failed to initialize:', error);
            }
        }

        async function updateValrBalance(apiKey, apiSecret) {
            try {
                const response = await fetch(`${API_BASE}/trading/valr/balance`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ apiKey, apiSecret })
                });

                const result = await response.json();

                // Handle different response formats
                let balances = null;
                if (result.success && result.data) {
                    balances = result.data.balances || result.data;
                } else if (result.success && result.balances) {
                    balances = result.balances;
                } else if (result.balances) {
                    balances = result.balances;
                }

                if (balances) {
                    valrBalanceTracking.currentZAR = balances.ZAR ? parseFloat(balances.ZAR) : 0;
                    valrBalanceTracking.currentUSDT = balances.USDT ? parseFloat(balances.USDT) : 0;

                    updateValrBalanceDisplay();
                }
            } catch (error) {
                console.error('‚ùå [VALR Balance] Update failed:', error);
            }
        }

        function updateValrBalanceDisplay() {
            // Update starting balances
            document.getElementById('valrStartingZAR').textContent = `R ${valrBalanceTracking.startingZAR?.toFixed(2) || '0.00'}`;
            document.getElementById('valrStartingUSDT').textContent = `$${valrBalanceTracking.startingUSDT?.toFixed(2) || '0.00'}`;

            // Update current balances
            document.getElementById('valrCurrentZAR').textContent = `R ${valrBalanceTracking.currentZAR.toFixed(2)}`;
            document.getElementById('valrCurrentUSDT').textContent = `$${valrBalanceTracking.currentUSDT.toFixed(2)}`;

            // Calculate and display changes
            if (valrBalanceTracking.startingZAR) {
                const zarChange = valrBalanceTracking.currentZAR - valrBalanceTracking.startingZAR;
                const zarChangePercent = (zarChange / valrBalanceTracking.startingZAR * 100).toFixed(2);
                const zarColor = zarChange >= 0 ? '#00ff00' : '#ff4444';
                const zarSign = zarChange >= 0 ? '+' : '';
                document.getElementById('valrChangeZAR').innerHTML = `<span style="color: ${zarColor}">${zarSign}R ${zarChange.toFixed(2)} (${zarSign}${zarChangePercent}%)</span>`;
            }

            if (valrBalanceTracking.startingUSDT) {
                const usdtChange = valrBalanceTracking.currentUSDT - valrBalanceTracking.startingUSDT;
                const usdtChangePercent = (usdtChange / valrBalanceTracking.startingUSDT * 100).toFixed(2);
                const usdtColor = usdtChange >= 0 ? '#00ff00' : '#ff4444';
                const usdtSign = usdtChange >= 0 ? '+' : '';
                document.getElementById('valrChangeUSDT').innerHTML = `<span style="color: ${usdtColor}">${usdtSign}$${usdtChange.toFixed(2)} (${usdtSign}${usdtChangePercent}%)</span>`;
            }

            // Update last updated time
            document.getElementById('valrBalanceLastUpdate').textContent = new Date().toLocaleTimeString();
        }

        function resetValrStartingBalance() {
            if (confirm('Reset starting balance to current balance? This will set your profit/loss tracking to zero.')) {
                valrBalanceTracking.startingZAR = valrBalanceTracking.currentZAR;
                valrBalanceTracking.startingUSDT = valrBalanceTracking.currentUSDT;
                localStorage.setItem('valrStartingBalance', JSON.stringify({
                    zar: valrBalanceTracking.startingZAR,
                    usdt: valrBalanceTracking.startingUSDT
                }));
                updateValrBalanceDisplay();
                showNotification('‚úÖ Starting balance reset successfully', 'success');
            }
        }

        // ========== ALERTS MANAGEMENT ==========
        function addValrAlert(type, message, details = {}) {
            const alert = {
                id: Date.now(),
                type: type, // 'balance', 'slippage', 'execution', 'other'
                message: message,
                details: details,
                timestamp: new Date()
            };

            valrAlerts.unshift(alert); // Add to beginning

            // Keep only last MAX_ALERTS
            if (valrAlerts.length > MAX_ALERTS) {
                valrAlerts = valrAlerts.slice(0, MAX_ALERTS);
            }

            updateValrAlertsDisplay();
        }

        function updateValrAlertsDisplay() {
            const alertsList = document.getElementById('valrAlertsList');
            const badge = document.getElementById('valrAlertBadge');

            // Update badge count
            if (valrAlerts.length > 0) {
                badge.textContent = valrAlerts.length;
                badge.style.display = 'inline-block';
            } else {
                badge.style.display = 'none';
            }

            // Display alerts
            if (valrAlerts.length === 0) {
                alertsList.innerHTML = '<div style="text-align: center; color: #888; padding: 20px;">No alerts. Worker running smoothly. ‚úÖ</div>';
                return;
            }

            let html = '';
            valrAlerts.forEach(alert => {
                const icon = alert.type === 'balance' ? '‚ö†Ô∏è' :
                            alert.type === 'slippage' ? 'üìä' :
                            alert.type === 'execution' ? '‚ùå' : '‚ö°';
                const color = alert.type === 'balance' ? '#ff9800' : '#ff4444';

                html += `
                    <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; border-left: 4px solid ${color}; margin-bottom: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                            <div style="color: ${color}; font-weight: bold; font-size: 0.9rem;">
                                ${icon} ${alert.message}
                            </div>
                            <button onclick="dismissValrAlert(${alert.id})" style="background: none; border: none; color: #888; cursor: pointer; font-size: 1.2rem; padding: 0; line-height: 1;">√ó</button>
                        </div>
                        <div style="color: #888; font-size: 0.85rem; margin-bottom: 5px;">
                            ${alert.timestamp.toLocaleTimeString()}
                        </div>
                        ${alert.details.path ? `<div style="color: #00ff88; font-size: 0.85rem;">Path: ${alert.details.path}</div>` : ''}
                        ${alert.details.required ? `<div style="color: #888; font-size: 0.85rem;">Required: ${alert.details.required} | Available: ${alert.details.available}</div>` : ''}
                        ${alert.details.shortfall ? `<div style="color: #ff4444; font-size: 0.85rem;">Shortfall: ${alert.details.shortfall}</div>` : ''}
                        ${alert.details.suggestion ? `<div style="color: #888; font-size: 0.85rem; margin-top: 5px;">üí° ${alert.details.suggestion}</div>` : ''}
                    </div>
                `;
            });

            alertsList.innerHTML = html;
        }

        function dismissValrAlert(alertId) {
            valrAlerts = valrAlerts.filter(a => a.id !== alertId);
            updateValrAlertsDisplay();
        }

        function clearValrAlerts() {
            if (valrAlerts.length === 0) return;
            if (confirm('Clear all alerts?')) {
                valrAlerts = [];
                updateValrAlertsDisplay();
            }
        }

        // ========== ERROR CATEGORIZATION ==========
        function categorizeValrError(errorMessage) {
            if (!errorMessage) return 'other';

            const msg = errorMessage.toLowerCase();

            if (msg.includes('insufficient') && (msg.includes('balance') || msg.includes('zar') || msg.includes('usdt'))) {
                return 'balance';
            } else if (msg.includes('slippage')) {
                return 'slippage';
            } else if (msg.includes('execution') || msg.includes('order') || msg.includes('trade')) {
                return 'execution';
            } else {
                return 'other';
            }
        }

        function handleValrExecutionError(error, opportunity) {
            const errorType = categorizeValrError(error.message);

            console.error(`‚ùå [VALR Worker] Execution failed (${errorType}):`, error.message);

            if (errorType === 'balance') {
                // Parse balance info from error message
                const match = error.message.match(/need [R$]([\d,.]+).*have [R$]([\d,.]+)/i);
                const currency = error.message.includes('ZAR') ? 'ZAR' : 'USDT';

                let required = 'Unknown';
                let available = 'Unknown';
                let shortfall = 'Unknown';

                if (match) {
                    required = currency === 'ZAR' ? `R ${match[1]}` : `$${match[1]}`;
                    available = currency === 'ZAR' ? `R ${match[2]}` : `$${match[2]}`;
                    const reqNum = parseFloat(match[1].replace(',', ''));
                    const availNum = parseFloat(match[2].replace(',', ''));
                    const shortfallNum = reqNum - availNum;
                    shortfall = currency === 'ZAR' ? `R ${shortfallNum.toFixed(2)}` : `$${shortfallNum.toFixed(2)}`;
                }

                addValrAlert(
                    'balance',
                    `Insufficient ${currency} Balance`,
                    {
                        path: opportunity.pathId,
                        profitPercent: opportunity.netProfitPercent?.toFixed(2) + '%',
                        required: required,
                        available: available,
                        shortfall: shortfall,
                        suggestion: `Top up ${currency} balance or reduce "Max Single Trade" amount`
                    }
                );

                showNotification(
                    `‚ö†Ô∏è Insufficient ${currency} - Opportunity skipped\nShortfall: ${shortfall}\nWorker continues scanning...`,
                    'warning',
                    8000
                );

            } else if (errorType === 'slippage') {
                addValrAlert(
                    'slippage',
                    'High Slippage Detected',
                    {
                        path: opportunity.pathId,
                        suggestion: 'Market moved too quickly. Worker continues scanning...'
                    }
                );

                showNotification(
                    'üìä Slippage too high - Opportunity skipped\nWorker continues scanning...',
                    'warning',
                    5000
                );

            } else {
                addValrAlert(
                    'execution',
                    'Execution Failed',
                    {
                        path: opportunity.pathId,
                        error: error.message,
                        suggestion: 'Check exchange API status or reduce trade size'
                    }
                );

                showNotification(
                    `‚ùå Trade execution failed\n${error.message}\nWorker continues scanning...`,
                    'error',
                    8000
                );
            }
        }

        async function startValrWorker() {
            console.log('üöÄ [VALR Worker] Starting automated trading (sequential mode)...');

            // Read settings from card
            const apiKey = localStorage.getItem('valr_triangular_api');
            const apiSecret = localStorage.getItem('valr_triangular_secret');
            const profitThreshold = parseFloat(document.getElementById('valrProfitThreshold')?.value) || 0.8;
            const maxTradeAmount = parseFloat(document.getElementById('valrMaxTrade')?.value) || 500;

            // Get selected path sets (only 12 valid sets)
            const selectedSets = [];
            for (let i = 1; i <= 12; i++) {
                const checkbox = document.getElementById(`valrSet${i}Enabled`);
                if (checkbox && checkbox.checked) {
                    selectedSets.push(`SET_${i}`);
                }
            }

            if (selectedSets.length === 0) {
                console.error('‚ùå [VALR Worker] No sets selected!');
                return;
            }

            console.log(`üìä [VALR Worker] Configuration:`, {
                profitThreshold: `${profitThreshold}%`,
                maxTradeAmount: `R ${maxTradeAmount}`,
                selectedSets: selectedSets.length,
                scanMode: 'Sequential (one set at a time)'
            });

            // Initialize balance tracking
            await initializeValrBalance(apiKey, apiSecret);

            let currentSetIndex = 0;

            // Sequential scan-and-execute function (one set per call)
            async function scanAndExecuteSequential() {
                try {
                    // Get current set to scan
                    const currentSet = selectedSets[currentSetIndex];
                    const backendSetName = setNameMapping[currentSet] || currentSet;
                    valrWorkerStats.totalScans++;

                    console.log(`\nüîç [VALR Worker] Scan #${valrWorkerStats.totalScans}: ${currentSet} (${currentSetIndex + 1}/${selectedSets.length})`);

                    // Get risk settings from UI
                    const portfolioPercent = parseFloat(document.getElementById('valrPortfolioPercent')?.value || 10);
                    const profitThresholdUI = parseFloat(document.getElementById('valrProfitThreshold')?.value || 0.5);

                    // Get current balances (from balance tracking)
                    const currentBalanceUSDT = valrBalanceTracking.currentUSDT || 0;
                    const currentBalanceZAR = valrBalanceTracking.currentZAR || 0;

                    // 1. Scan ONE set only
                    const scanResponse = await fetch(`${API_BASE}/trading/valr/triangular/scan`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            apiKey,
                            apiSecret,
                            scanSet: backendSetName,  // Backend expects scanSet with full name
                            amount: maxTradeAmount,
                            maxTradeAmount: maxTradeAmount,
                            profitThreshold: profitThresholdUI,
                            portfolioPercent: portfolioPercent,
                            currentBalanceUSDT: currentBalanceUSDT,
                            currentBalanceZAR: currentBalanceZAR
                        })
                    });

                    const scanResult = await scanResponse.json();

                    if (scanResult.success && scanResult.data && scanResult.data.opportunities) {
                        const paths = scanResult.data.opportunities;
                        console.log(`‚úÖ [VALR Worker] ${currentSet}: Analyzed ${paths.length} paths`);

                        // Log detailed profit for each path
                        paths.forEach((path, index) => {
                            const profitSign = path.netProfitPercent >= 0 ? '+' : '';
                            const profitColor = path.netProfitPercent >= profitThreshold ? 'üíö' :
                                              path.netProfitPercent >= 0 ? 'üíõ' : '‚ùå';
                            const status = path.netProfitPercent >= profitThreshold ? 'OPPORTUNITY' :
                                         path.netProfitPercent >= 0 ? 'below threshold' : 'unprofitable';
                            console.log(`   ${profitColor} Path ${index + 1}: ${profitSign}${path.netProfitPercent.toFixed(2)}% (${status})`);
                        });

                        // 2. Filter by profit threshold
                        const profitable = paths.filter(
                            opp => opp.netProfitPercent >= profitThreshold
                        );

                        valrWorkerStats.totalOpportunities += profitable.length;

                        if (profitable.length > 0) {
                            console.log(`üí∞ [VALR Worker] ${currentSet}: ${profitable.length} OPPORTUNITIES above ${profitThreshold}% threshold`);

                            // 3. Execute each profitable opportunity immediately
                            for (const opportunity of profitable) {
                                console.log(`‚ö° [VALR Worker] Executing: ${opportunity.pathId} (${opportunity.netProfitPercent.toFixed(2)}% profit)`);

                                try {
                                    const execResponse = await fetch(`${API_BASE}/trading/valr/triangular/execute`, {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({
                                            apiKey,
                                            apiSecret,
                                            pathId: opportunity.pathId,
                                            amount: maxTradeAmount,
                                            simulate: false  // LIVE TRADING
                                        })
                                    });

                                    const execResult = await execResponse.json();

                                    if (execResult.success && execResult.data) {
                                        valrWorkerStats.totalTrades++;
                                        valrWorkerStats.successfulTrades++;

                                        const profit = execResult.data.execution?.netProfit || 0;
                                        valrWorkerStats.totalProfit += profit;

                                        // Track best path
                                        if (profit > valrWorkerStats.bestProfit) {
                                            valrWorkerStats.bestProfit = profit;
                                            valrWorkerStats.bestPath = opportunity.pathId;
                                        }

                                        console.log(`‚úÖ [VALR Worker] Trade executed successfully! Profit: R ${profit.toFixed(2)}`);

                                        // Add to recent trades display
                                        addValrTradeToHistory({
                                            pathId: opportunity.pathId,
                                            profit: profit,
                                            profitPercent: opportunity.netProfitPercent,
                                            timestamp: new Date(),
                                            success: true
                                        });
                                    } else {
                                        // Execution failed - use new error handler
                                        valrWorkerStats.totalTrades++;
                                        handleValrExecutionError({ message: execResult.message || 'Unknown error' }, opportunity);

                                        // Log failed trade
                                        addValrTradeToHistory({
                                            pathId: opportunity.pathId,
                                            profit: 0,
                                            profitPercent: 0,
                                            timestamp: new Date(),
                                            success: false,
                                            error: execResult.message
                                        });
                                    }
                                } catch (execError) {
                                    valrWorkerStats.totalTrades++;
                                    handleValrExecutionError(execError, opportunity);
                                }

                                // Brief delay between executions (respect rate limits)
                                await new Promise(resolve => setTimeout(resolve, 300));
                            }
                        } else {
                            console.log(`‚ÑπÔ∏è [VALR Worker] ${currentSet}: No opportunities (all ${paths.length} paths below ${profitThreshold}% threshold)`);
                        }
                    } else {
                        console.log(`‚ÑπÔ∏è [VALR Worker] ${currentSet}: No paths found`);
                    }

                    // Update displays
                    updateValrStatsDisplay();
                    await updateValrBalance(apiKey, apiSecret);

                    // Move to next set (rotate through all selected sets)
                    currentSetIndex = (currentSetIndex + 1) % selectedSets.length;

                    if (currentSetIndex === 0) {
                        console.log(`üîÑ [VALR Worker] Completed full cycle of ${selectedSets.length} sets. Restarting...`);
                    }

                } catch (error) {
                    console.error('‚ùå [VALR Worker] Scan error:', error);
                    // Still move to next set even on error
                    currentSetIndex = (currentSetIndex + 1) % selectedSets.length;
                }
            }

            // Run immediately, then every 8 seconds
            await scanAndExecuteSequential();
            valrWorkerInterval = setInterval(scanAndExecuteSequential, 8000);

            console.log('‚úÖ [VALR Worker] Automated trading started (8s between sets, sequential scanning)');
        }

        function stopValrWorker() {
            if (valrWorkerInterval) {
                clearInterval(valrWorkerInterval);
                valrWorkerInterval = null;
                console.log('‚èπÔ∏è [VALR Worker] Automated trading stopped');
                console.log('üìä [VALR Worker] Final stats:', valrWorkerStats);
            }
        }

        function updateValrStatsDisplay() {
            // Update Performance Stats
            document.getElementById('valrTotalTrades').textContent = valrWorkerStats.totalTrades;
            document.getElementById('valrSuccessfulTrades').textContent = valrWorkerStats.successfulTrades;

            const successRate = valrWorkerStats.totalTrades > 0
                ? ((valrWorkerStats.successfulTrades / valrWorkerStats.totalTrades) * 100).toFixed(1)
                : '0';
            document.getElementById('valrSuccessRate').textContent = `${successRate}%`;

            document.getElementById('valrTotalProfit').textContent = `R ${valrWorkerStats.totalProfit.toFixed(2)}`;
            document.getElementById('valrBestPath').textContent = valrWorkerStats.bestPath || '-';
            document.getElementById('valrLastScan').textContent = new Date().toLocaleTimeString();
        }

        function addValrTradeToHistory(trade) {
            const tradesDiv = document.getElementById('valrRecentTrades');

            // Remove "no trades" message if it exists
            if (tradesDiv.querySelector('[style*="text-align: center"]')) {
                tradesDiv.innerHTML = '';
            }

            const borderColor = trade.success ? '#00ff88' : '#ff6b6b';
            const bgColor = trade.success ? 'rgba(0,255,136,0.05)' : 'rgba(255,107,107,0.05)';
            const profitColor = trade.success ? '#00ff88' : '#ff6b6b';

            const tradeDiv = document.createElement('div');
            tradeDiv.style.cssText = `padding: 10px; margin-bottom: 8px; background: ${bgColor}; border-left: 3px solid ${borderColor}; border-radius: 5px; font-size: 0.85rem;`;

            let content = `
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <span style="color: ${profitColor}; font-weight: bold;">${trade.pathId}</span>
                    <span style="color: ${profitColor};">${trade.success ? '‚úÖ' : '‚ùå FAILED'}</span>
                </div>
            `;

            if (trade.success) {
                content += `
                    <div style="display: flex; justify-content: space-between; color: #b8c6db;">
                        <span>Profit: <strong style="color: ${profitColor};">R ${trade.profit.toFixed(2)}</strong> (${trade.profitPercent.toFixed(2)}%)</span>
                        <span>${trade.timestamp.toLocaleTimeString()}</span>
                    </div>
                `;
            } else {
                content += `
                    <div style="display: flex; justify-content: space-between; color: #b8c6db;">
                        <span style="color: #ff6b6b;">Execution failed - Rolled back</span>
                        <span>${trade.timestamp.toLocaleTimeString()}</span>
                    </div>
                    ${trade.error ? `<div style="color: #888; font-size: 0.75rem; margin-top: 5px;">Error: ${trade.error}</div>` : ''}
                `;
            }

            tradeDiv.innerHTML = content;

            // Add at the top
            tradesDiv.insertBefore(tradeDiv, tradesDiv.firstChild);

            // Keep only last 10 trades
            while (tradesDiv.children.length > 10) {
                tradesDiv.removeChild(tradesDiv.lastChild);
            }
        }

        // Toggle for VALR Triangular trading
        document.getElementById('valrTriangularEnabled').addEventListener('click', async function() {
            console.log('üîÑ [VALR] Toggle clicked');

            const willBeActive = !this.classList.contains('active');
            const status = document.getElementById('valrTriangularStatus');

            if (willBeActive) {
                // Check if credentials are configured before enabling
                const apiKey = localStorage.getItem('valr_triangular_api') || '';
                const apiSecret = localStorage.getItem('valr_triangular_secret') || '';

                if (!apiKey || !apiSecret) {
                    showNotification('‚ö†Ô∏è Please configure VALR API credentials in Strategic API Configuration first!', 'warning');
                    return; // Don't toggle
                }

                // Check if at least one path set is selected (only 12 valid sets)
                let hasSelectedPaths = false;
                for (let i = 1; i <= 12; i++) {
                    const checkbox = document.getElementById(`valrSet${i}Enabled`);
                    if (checkbox && checkbox.checked) {
                        hasSelectedPaths = true;
                        break;
                    }
                }

                if (!hasSelectedPaths) {
                    showNotification('‚ö†Ô∏è Please select at least one path set before enabling live trading!', 'warning');
                    return; // Don't toggle
                }

                console.log('‚úÖ [VALR] Live trading enabled');
                this.classList.add('active');
                status.textContent = 'ON';
                status.style.color = '#00ff88';
                localStorage.setItem('valrTriangularEnabled', 'true');

                // Start automated worker
                await startValrWorker();

                showNotification('‚úÖ VALR automated trading started! Worker scanning every 20 seconds.', 'success');
            } else {
                console.log('‚ùå [VALR] Live trading disabled');

                // Stop automated worker
                stopValrWorker();

                this.classList.remove('active');
                status.textContent = 'OFF';
                status.style.color = '#ff6b6b';
                localStorage.setItem('valrTriangularEnabled', 'false');
                showNotification('VALR automated trading stopped', 'info');
            }
        });

        // Load saved toggle state and auto-start worker if enabled
        document.addEventListener('DOMContentLoaded', async function() {
            const valrEnabled = localStorage.getItem('valrTriangularEnabled') === 'true';
            const toggle = document.getElementById('valrTriangularEnabled');
            const status = document.getElementById('valrTriangularStatus');

            // Initialize balance display if credentials exist (regardless of worker state)
            const apiKey = localStorage.getItem('valr_triangular_api');
            const apiSecret = localStorage.getItem('valr_triangular_secret');

            if (apiKey && apiSecret) {
                console.log('üí∞ [VALR Balance] Fetching balance on page load...');
                await initializeValrBalance(apiKey, apiSecret);
            }

            if (valrEnabled) {
                toggle.classList.add('active');
                status.textContent = 'ON';
                status.style.color = '#00ff88';

                // Auto-start worker if toggle was left ON
                if (apiKey && apiSecret) {
                    console.log('üîÑ [VALR] Auto-starting worker from saved state...');
                    await startValrWorker();
                }
            }
        });

        // ============================================================================
        // VALR TRIANGULAR ARBITRAGE FUNCTIONS (FULL IMPLEMENTATION)
        // ============================================================================

        // Test VALR Connection
        async function testValrTriangularConnection() {
            const apiKey = localStorage.getItem('valr_triangular_api') || '';
            const apiSecret = localStorage.getItem('valr_triangular_secret') || '';

            if (!apiKey || !apiSecret) {
                showNotification('Please set up VALR API credentials in Settings first', 'error');
                return;
            }

            document.getElementById('valrTriangularStatus').innerHTML = '<span style="color: #FFA500;">‚è≥ Testing connection...</span>';

            try {
                const response = await fetch(`${API_BASE}/trading/valr/triangular/test-connection`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ apiKey, apiSecret })
                });

                const data = await response.json();

                if (data.success) {
                    document.getElementById('valrTriangularStatus').innerHTML = '<span style="color: #00FF00;">‚úÖ Connected</span>';
                    const balanceDiv = document.getElementById('valrTriangularBalance');
                    if (balanceDiv) {
                        balanceDiv.innerHTML = `USDT Balance: $${data.balance.available.toFixed(2)} / $${data.balance.total.toFixed(2)}`;
                    }
                    showNotification('VALR connection successful!', 'success');

                    // Auto-load trade history
                    await loadValrTradeHistory();
                } else {
                    document.getElementById('valrTriangularStatus').innerHTML = '<span style="color: #FF0000;">‚ùå Connection failed</span>';
                    showNotification(data.message || 'VALR connection failed', 'error');
                }
            } catch (error) {
                console.error('VALR connection error:', error);
                document.getElementById('valrTriangularStatus').innerHTML = '<span style="color: #FF0000;">‚ùå Error</span>';
                showNotification('Network error during connection test', 'error');
            }
        }

        // Scan for VALR Opportunities
        async function scanValrTriangularPaths() {
            const apiKey = localStorage.getItem('valr_triangular_api') || '';
            const apiSecret = localStorage.getItem('valr_triangular_secret') || '';

            if (!apiKey || !apiSecret) {
                showNotification('Please set up VALR API credentials and test connection first', 'error');
                return;
            }

            // Get selected sets
            const selectedSets = [];
            for (let i = 1; i <= 5; i++) {
                const checkbox = document.getElementById(`valrSet${i}Enabled`);
                if (checkbox && checkbox.checked) {
                    selectedSets.push(`SET_${i}`);
                }
            }

            if (selectedSets.length === 0) {
                showNotification('Please select at least one path set', 'error');
                return;
            }

            const scanResults = document.getElementById('valrScanResults');
            const oppDiv = document.getElementById('valrOpportunities');

            if (scanResults) scanResults.innerHTML = '<span style="color: #FFA500;">‚è≥ Scanning for opportunities...</span>';
            if (oppDiv) oppDiv.innerHTML = '<div style="color: #888; text-align: center; padding: 20px;">Scanning...</div>';

            try {
                const response = await fetch(`${API_BASE}/trading/valr/triangular/scan`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        apiKey,
                        apiSecret,
                        selectedSets
                    })
                });

                const data = await response.json();

                if (data.success) {
                    const minProfit = parseFloat(document.getElementById('valrProfitThreshold')?.value) || 0.5;
                    const filteredOpps = data.opportunities.filter(opp => opp.profitPercentage >= minProfit);

                    if (scanResults) {
                        scanResults.innerHTML =
                            `<span style="color: #00FF00;">‚úÖ Scan complete: ${filteredOpps.length} opportunities found (${data.scannedPaths} paths scanned)</span>`;
                    }

                    if (filteredOpps.length === 0) {
                        if (oppDiv) {
                            oppDiv.innerHTML =
                                '<div style="color: #888; text-align: center; padding: 20px;">No profitable opportunities found above minimum profit threshold.</div>';
                        }
                        return;
                    }

                    // Display opportunities
                    let html = '';
                    filteredOpps.forEach((opp, index) => {
                        html += `
                            <div style="background: rgba(0,255,136,0.1); padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 1px solid #00ff88;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <div>
                                        <span style="color: #00ff88; font-weight: bold;">${opp.pathId}</span>
                                        <span style="color: #888; margin-left: 10px; font-size: 12px;">${opp.description}</span>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="color: ${opp.profitPercentage >= 1 ? '#00FF00' : '#FFA500'}; font-weight: bold; font-size: 18px;">
                                            +${opp.profitPercentage.toFixed(2)}%
                                        </div>
                                        <div style="color: #888; font-size: 12px;">
                                            ~$${opp.estimatedProfit.toFixed(2)} profit
                                        </div>
                                    </div>
                                </div>
                                <div style="color: #888; font-size: 13px; margin-bottom: 10px;">
                                    Path: ${opp.path.join(' ‚Üí ')}
                                </div>
                                <div style="color: #666; font-size: 12px; margin-bottom: 10px;">
                                    Pairs: ${opp.pairs.join(', ')}
                                </div>
                                <button onclick='executeValrTriangular(${JSON.stringify(opp)})'
                                        style="width: 100%; padding: 10px; background: #00ff88; color: black; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">
                                    ‚ö° Execute Trade
                                </button>
                            </div>
                        `;
                    });

                    if (oppDiv) oppDiv.innerHTML = html;
                    showNotification(`Found ${filteredOpps.length} opportunities!`, 'success');

                } else {
                    if (scanResults) {
                        scanResults.innerHTML = '<span style="color: #FF0000;">‚ùå Scan failed</span>';
                    }
                    if (oppDiv) {
                        oppDiv.innerHTML = '<div style="color: #888; text-align: center; padding: 20px;">Scan failed. Please try again.</div>';
                    }
                    showNotification(data.message || 'Scan failed', 'error');
                }

            } catch (error) {
                console.error('VALR scan error:', error);
                if (scanResults) scanResults.innerHTML = '<span style="color: #FF0000;">‚ùå Error</span>';
                showNotification('Network error during scan', 'error');
            }
        }

        // Execute VALR Triangular Trade
        async function executeValrTriangular(opportunity) {
            const apiKey = localStorage.getItem('valr_triangular_api') || '';
            const apiSecret = localStorage.getItem('valr_triangular_secret') || '';
            const maxInvestment = parseFloat(document.getElementById('valrMaxTrade')?.value) || 1000;

            if (!confirm(`Execute triangular arbitrage on VALR?\n\nPath: ${opportunity.pathId}\nExpected Profit: ${opportunity.profitPercentage.toFixed(2)}%\nInvestment: $${maxInvestment}`)) {
                return;
            }

            showNotification('Executing VALR triangular arbitrage...', 'info');

            try {
                const response = await fetch(`${API_BASE}/trading/valr/triangular/execute`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        apiKey,
                        apiSecret,
                        opportunity,
                        investmentAmount: maxInvestment
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showNotification(`Trade executed! Profit: $${data.profit.toFixed(2)} (${data.profitPercentage}%)`, 'success');

                    // üìä Log to backend using shared service
                    logTriangularTrade('VALR', opportunity.pathId, data.profit || 0, maxInvestment, data.fees || 0).catch(e => console.warn('Logging failed:', e));

                    // Refresh opportunities and history
                    await scanValrTriangularPaths();
                    await loadValrTradeHistory();
                } else {
                    showNotification(data.message || 'Trade execution failed', 'error');
                }

            } catch (error) {
                console.error('VALR execution error:', error);
                showNotification('Network error during trade execution', 'error');
            }
        }

        // Load VALR Trade History
        async function loadValrTradeHistory() {
            try {
                const response = await fetch(`${API_BASE}/trading/valr/triangular/history`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                const data = await response.json();
                const historyDiv = document.getElementById('valrTradeHistory');

                if (!historyDiv) return;

                if (data.success && data.trades && data.trades.length > 0) {
                    let html = '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse; font-size: 13px;">';
                    html += '<thead><tr style="background: rgba(0,255,136,0.2);">';
                    html += '<th style="padding: 8px; text-align: left; color: #00ff88;">Date</th>';
                    html += '<th style="padding: 8px; text-align: left; color: #00ff88;">Path</th>';
                    html += '<th style="padding: 8px; text-align: right; color: #00ff88;">Investment</th>';
                    html += '<th style="padding: 8px; text-align: right; color: #00ff88;">Final</th>';
                    html += '<th style="padding: 8px; text-align: right; color: #00ff88;">Profit</th>';
                    html += '<th style="padding: 8px; text-align: center; color: #00ff88;">Status</th>';
                    html += '</tr></thead><tbody>';

                    data.trades.forEach(trade => {
                        const profit = parseFloat(trade.profit);
                        const profitPercent = ((profit / parseFloat(trade.investment_amount)) * 100).toFixed(2);
                        const profitColor = profit >= 0 ? '#00FF00' : '#FF0000';

                        html += `<tr style="border-bottom: 1px solid #333;">
                            <td style="padding: 8px; color: #888;">${new Date(trade.created_at).toLocaleString()}</td>
                            <td style="padding: 8px; color: #00ff88;">${trade.path_id}</td>
                            <td style="padding: 8px; text-align: right; color: #888;">$${parseFloat(trade.investment_amount).toFixed(2)}</td>
                            <td style="padding: 8px; text-align: right; color: #888;">$${parseFloat(trade.final_amount).toFixed(2)}</td>
                            <td style="padding: 8px; text-align: right; color: ${profitColor};">$${profit.toFixed(2)} (${profitPercent}%)</td>
                            <td style="padding: 8px; text-align: center;">
                                <span style="background: rgba(0,255,136,0.2); color: #00ff88; padding: 4px 8px; border-radius: 4px; font-size: 11px;">
                                    ${trade.status}
                                </span>
                            </td>
                        </tr>`;
                    });

                    html += '</tbody></table></div>';
                    historyDiv.innerHTML = html;
                } else {
                    historyDiv.innerHTML = '<div style="color: #888; font-size: 14px;">No trade history available.</div>';
                }

            } catch (error) {
                console.error('VALR history error:', error);
            }
        }

        // View Path Details - Create custom modal to show all paths
        function viewValrPathDetails() {
            // Create modal overlay
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                backdrop-filter: blur(5px);
            `;

            // Create modal content
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
                border: 2px solid #00ff88;
                border-radius: 15px;
                padding: 30px;
                max-width: 800px;
                max-height: 85vh;
                overflow-y: auto;
                box-shadow: 0 10px 50px rgba(0, 255, 136, 0.3);
                color: #fff;
                font-family: 'Courier New', monospace;
            `;

            modalContent.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #00ff88; padding-bottom: 15px;">
                    <h2 style="margin: 0; color: #00ff88; font-size: 24px;">üìã VALR Triangular Arbitrage Paths</h2>
                    <button id="closeModal" style="background: #ff4444; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 18px;">‚úï</button>
                </div>

                <div style="line-height: 1.8; font-size: 14px;">
                    <div style="background: rgba(0, 255, 136, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <strong style="color: #00ff88;">üìä SET 1: ETH Focus (4 paths) ‚úÖ DEFAULT</strong><br>
                        1. ZAR ‚Üí ETH ‚Üí USDT ‚Üí ZAR<br>
                        2. ZAR ‚Üí USDT ‚Üí ETH ‚Üí ZAR<br>
                        3. USDT ‚Üí ETH ‚Üí ZAR ‚Üí USDT<br>
                        4. USDT ‚Üí ZAR ‚Üí ETH ‚Üí USDT
                    </div>

                    <div style="background: rgba(0, 255, 136, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <strong style="color: #00ff88;">üìä SET 2: XRP Focus (4 paths) ‚úÖ DEFAULT</strong><br>
                        1. ZAR ‚Üí XRP ‚Üí USDT ‚Üí ZAR<br>
                        2. ZAR ‚Üí USDT ‚Üí XRP ‚Üí ZAR<br>
                        3. USDT ‚Üí XRP ‚Üí ZAR ‚Üí USDT<br>
                        4. USDT ‚Üí ZAR ‚Üí XRP ‚Üí USDT
                    </div>

                    <div style="background: rgba(0, 255, 136, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <strong style="color: #00ff88;">üìä SET 3: SOL Focus (4 paths)</strong><br>
                        1. ZAR ‚Üí SOL ‚Üí USDT ‚Üí ZAR<br>
                        2. ZAR ‚Üí USDT ‚Üí SOL ‚Üí ZAR<br>
                        3. USDT ‚Üí SOL ‚Üí ZAR ‚Üí USDT<br>
                        4. USDT ‚Üí ZAR ‚Üí SOL ‚Üí USDT
                    </div>

                    <div style="background: rgba(0, 255, 136, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <strong style="color: #00ff88;">üìä SET 4: BNB Focus (4 paths)</strong><br>
                        1. ZAR ‚Üí BNB ‚Üí USDT ‚Üí ZAR<br>
                        2. ZAR ‚Üí USDT ‚Üí BNB ‚Üí ZAR<br>
                        3. USDT ‚Üí BNB ‚Üí ZAR ‚Üí USDT<br>
                        4. USDT ‚Üí ZAR ‚Üí BNB ‚Üí USDT
                    </div>

                    <div style="background: rgba(0, 255, 136, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <strong style="color: #00ff88;">üìä SET 5: SHIB Focus (4 paths)</strong><br>
                        1. ZAR ‚Üí SHIB ‚Üí USDT ‚Üí ZAR<br>
                        2. ZAR ‚Üí USDT ‚Üí SHIB ‚Üí ZAR<br>
                        3. USDT ‚Üí SHIB ‚Üí ZAR ‚Üí USDT<br>
                        4. USDT ‚Üí ZAR ‚Üí SHIB ‚Üí USDT
                    </div>

                    <div style="background: rgba(0, 255, 136, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <strong style="color: #00ff88;">üìä SET 6: AVAX Focus (4 paths)</strong><br>
                        1. ZAR ‚Üí AVAX ‚Üí USDT ‚Üí ZAR<br>
                        2. ZAR ‚Üí USDT ‚Üí AVAX ‚Üí ZAR<br>
                        3. USDT ‚Üí AVAX ‚Üí ZAR ‚Üí USDT<br>
                        4. USDT ‚Üí ZAR ‚Üí AVAX ‚Üí USDT
                    </div>

                    <div style="background: rgba(0, 255, 136, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <strong style="color: #00ff88;">üìä SET 7: DOGE Focus (4 paths)</strong><br>
                        1. ZAR ‚Üí DOGE ‚Üí USDT ‚Üí ZAR<br>
                        2. ZAR ‚Üí USDT ‚Üí DOGE ‚Üí ZAR<br>
                        3. USDT ‚Üí DOGE ‚Üí ZAR ‚Üí USDT<br>
                        4. USDT ‚Üí ZAR ‚Üí DOGE ‚Üí USDT
                    </div>

                    <div style="background: rgba(0, 255, 136, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <strong style="color: #00ff88;">üìä SET 8: TRX Focus (4 paths)</strong><br>
                        1. ZAR ‚Üí TRX ‚Üí USDT ‚Üí ZAR<br>
                        2. ZAR ‚Üí USDT ‚Üí TRX ‚Üí ZAR<br>
                        3. USDT ‚Üí TRX ‚Üí ZAR ‚Üí USDT<br>
                        4. USDT ‚Üí ZAR ‚Üí TRX ‚Üí USDT
                    </div>

                    <div style="background: rgba(0, 255, 136, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <strong style="color: #00ff88;">üìä SET 9: LTC Focus (4 paths)</strong><br>
                        1. ZAR ‚Üí LTC ‚Üí USDT ‚Üí ZAR<br>
                        2. ZAR ‚Üí USDT ‚Üí LTC ‚Üí ZAR<br>
                        3. USDT ‚Üí LTC ‚Üí ZAR ‚Üí USDT<br>
                        4. USDT ‚Üí ZAR ‚Üí LTC ‚Üí USDT
                    </div>

                    <div style="background: rgba(0, 255, 136, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <strong style="color: #00ff88;">üìä SET 10: RLUSD Focus (4 paths)</strong><br>
                        1. ZAR ‚Üí RLUSD ‚Üí USDT ‚Üí ZAR<br>
                        2. ZAR ‚Üí USDT ‚Üí RLUSD ‚Üí ZAR<br>
                        3. USDT ‚Üí RLUSD ‚Üí ZAR ‚Üí USDT<br>
                        4. USDT ‚Üí ZAR ‚Üí RLUSD ‚Üí USDT
                    </div>

                    <div style="background: rgba(0, 255, 136, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <strong style="color: #00ff88;">üìä SET 11: LINK Focus (4 paths)</strong><br>
                        1. ZAR ‚Üí LINK ‚Üí USDT ‚Üí ZAR<br>
                        2. ZAR ‚Üí USDT ‚Üí LINK ‚Üí ZAR<br>
                        3. USDT ‚Üí LINK ‚Üí ZAR ‚Üí USDT<br>
                        4. USDT ‚Üí ZAR ‚Üí LINK ‚Üí USDT
                    </div>

                    <div style="background: rgba(0, 255, 136, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <strong style="color: #00ff88;">üìä SET 12: XLM Focus (4 paths)</strong><br>
                        1. ZAR ‚Üí XLM ‚Üí USDT ‚Üí ZAR<br>
                        2. ZAR ‚Üí USDT ‚Üí XLM ‚Üí ZAR<br>
                        3. USDT ‚Üí XLM ‚Üí ZAR ‚Üí USDT<br>
                        4. USDT ‚Üí ZAR ‚Üí XLM ‚Üí USDT
                    </div>

                    <div style="background: rgba(0, 136, 255, 0.1); padding: 20px; border-radius: 8px; border-left: 4px solid #0088ff; margin-top: 20px;">
                        <strong style="color: #0088ff;">üìå Summary</strong><br>
                        üí° TOTAL: 48 paths (12 sets √ó 4 paths each)<br>
                        üåâ BRIDGE: USDT (Tether)<br>
                        üîÑ PATTERN: All paths use ZAR ‚Üî CRYPTO ‚Üî USDT triangular arbitrage<br>
                        üáøüá¶ REGIONAL: Optimized for South African market (VALR exchange)<br>
                        ‚úÖ VERIFIED: Only coins with both ZAR and USDT pairs on VALR<br>
                        üîê AUTH: API Key + Secret
                    </div>
                </div>
            `;

            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // Close modal on click outside or close button
            const closeBtn = document.getElementById('closeModal');
            closeBtn.onclick = () => modal.remove();
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };

            // Close on ESC key
            document.addEventListener('keydown', function escClose(e) {
                if (e.key === 'Escape') {
                    modal.remove();
                    document.removeEventListener('keydown', escClose);
                }
            });
        }

        // Clear VALR History
        async function clearValrTriangularHistory() {
            if (!confirm('Are you sure you want to clear all VALR triangular trade history? This cannot be undone.')) {
                return;
            }

            try {
                // Call backend to clear history
                showNotification('Clearing VALR trade history...', 'info');

                // For now, just refresh the display
                const historyDiv = document.getElementById('valrTradeHistory');
                if (historyDiv) {
                    historyDiv.innerHTML = '<div style="color: #888; font-size: 14px;">Trade history cleared.</div>';
                }

                showNotification('VALR trade history cleared successfully', 'success');
            } catch (error) {
                console.error('Clear history error:', error);
                showNotification('Failed to clear trade history', 'error');
            }
        }

        // Save form values to localStorage
        function saveTriangularSettings() {
            console.log('üíæ [VALR] Saving settings to localStorage...');
            const settings = {
                maxTrade: document.getElementById('valrMaxTrade').value,
                portfolioPercent: document.getElementById('valrPortfolioPercent').value,
                profitThreshold: document.getElementById('valrProfitThreshold').value
            };

            // Save path set states
            for (let i = 1; i <= 39; i++) {
                const checkbox = document.getElementById(`valrSet${i}Enabled`);
                if (checkbox) {
                    settings[`set${i}Enabled`] = checkbox.checked;
                }
            }

            localStorage.setItem('triangularSettings', JSON.stringify(settings));
            console.log('‚úÖ [VALR] Settings saved:', settings);
        }

        // Load form values from localStorage
        function loadTriangularSettings() {
            console.log('üíæ [VALR] Loading settings from localStorage...');
            const savedSettings = localStorage.getItem('triangularSettings');
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);
                console.log('‚úÖ [VALR] Settings loaded:', settings);

                if (settings.maxTrade) document.getElementById('valrMaxTrade').value = settings.maxTrade;
                if (settings.portfolioPercent) document.getElementById('valrPortfolioPercent').value = settings.portfolioPercent;
                if (settings.profitThreshold) document.getElementById('valrProfitThreshold').value = settings.profitThreshold;

                // Load path set states
                for (let i = 1; i <= 39; i++) {
                    const checkbox = document.getElementById(`valrSet${i}Enabled`);
                    if (checkbox && settings[`set${i}Enabled`] !== undefined) {
                        checkbox.checked = settings[`set${i}Enabled`];
                    }
                }
            } else {
                console.log('‚ÑπÔ∏è [VALR] No saved settings found, using defaults');
            }
        }

        // Auto-save settings when changed
        document.addEventListener('DOMContentLoaded', function() {
            loadTriangularSettings();

            // Add event listeners for auto-save
            const inputs = document.querySelectorAll('#valrMaxTrade, #valrPortfolioPercent, #valrProfitThreshold');
            inputs.forEach(input => {
                input.addEventListener('change', saveTriangularSettings);
            });

            // Add event listeners for checkboxes
            for (let i = 1; i <= 39; i++) {
                const checkbox = document.getElementById(`valrSet${i}Enabled`);
                if (checkbox) {
                    checkbox.addEventListener('change', saveTriangularSettings);
                }
            }
        });

        // ============================================================================
        // LUNO TRIANGULAR ARBITRAGE JAVASCRIPT
        // ============================================================================

        // ========== LUNO AUTOMATED WORKER ==========
        let lunoWorkerRunning = false;
        let lunoWorkerStats = {
            totalScans: 0,
            totalTrades: 0,
            successfulTrades: 0,
            totalProfit: 0
        };

        async function startLunoWorker() {
            console.log('üöÄ [LUNO Worker] Starting automated trading (sequential mode)...');

            // Read settings from card
            const apiKey = localStorage.getItem('luno_triangular_api');
            const apiSecret = localStorage.getItem('luno_triangular_secret');
            const profitThreshold = parseFloat(document.getElementById('lunoProfitThreshold')?.value) || 0.5;
            const maxTradeAmount = parseFloat(document.getElementById('lunoMaxTrade')?.value) || 500;

            // Get selected path sets (7 sets available)
            const selectedSets = [];
            for (let i = 1; i <= 7; i++) {
                const checkbox = document.getElementById(`lunoSet${i}Enabled`);
                if (checkbox && checkbox.checked) {
                    selectedSets.push(i);
                }
            }

            if (selectedSets.length === 0) {
                alert('‚ö†Ô∏è Please select at least one path set to scan');
                return;
            }

            console.log(`üìä [LUNO Worker] Settings: Threshold=${profitThreshold}%, Max Trade=R${maxTradeAmount}, Sets=${selectedSets.join(',')}`);

            // Initialize balance tracking
            await initializeLunoBalance(apiKey, apiSecret);

            lunoWorkerRunning = true;
            let currentSetIndex = 0;

            async function scanAndExecuteSequential() {
                if (!lunoWorkerRunning) {
                    console.log('üõë [LUNO Worker] Stopped');
                    return;
                }

                try {
                    const currentSet = selectedSets[currentSetIndex];
                    lunoWorkerStats.totalScans++;
                    console.log(`\nüîç [LUNO Worker] Scan #${lunoWorkerStats.totalScans}: SET ${currentSet} (${currentSetIndex + 1}/${selectedSets.length})`);

                    // Get risk settings from UI
                    const maxTradeAmount = parseFloat(document.getElementById('lunoMaxTrade')?.value || 100);
                    const portfolioPercent = parseFloat(document.getElementById('lunoPortfolioPercent')?.value || 10);

                    // Get current balances (from balance tracking)
                    const currentBalanceUSDT = lunoBalanceTracking.currentUSDT || 0;
                    const currentBalanceZAR = lunoBalanceTracking.currentZAR || 0;

                    // Scan current set
                    const scanResponse = await fetch(`${API_BASE}/trading/luno/triangular/scan`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify({
                            apiKey,
                            apiSecret,
                            paths: [currentSet],
                            profitThreshold,
                            maxTradeAmount: maxTradeAmount,
                            portfolioPercent: portfolioPercent,
                            currentBalanceUSDT: currentBalanceUSDT,
                            currentBalanceZAR: currentBalanceZAR
                        })
                    });

                    const scanResult = await scanResponse.json();

                    if (scanResult.success && scanResult.data && scanResult.data.opportunities) {
                        const paths = scanResult.data.opportunities;
                        console.log(`‚úÖ [LUNO Worker] SET ${currentSet}: Analyzed ${paths.length} paths`);

                        // Log detailed profit for each path
                        paths.forEach((path, index) => {
                            const profitSign = path.profitPercentage >= 0 ? '+' : '';
                            const profitColor = path.profitPercentage >= profitThreshold ? 'üíö' :
                                              path.profitPercentage >= 0 ? 'üíõ' : '‚ùå';
                            const status = path.profitPercentage >= profitThreshold ? 'OPPORTUNITY' :
                                         path.profitPercentage >= 0 ? 'below threshold' : 'unprofitable';
                            console.log(`   ${profitColor} Path ${index + 1}: ${profitSign}${path.profitPercentage.toFixed(2)}% (${status})`);
                        });

                        // Filter by profit threshold
                        const opportunities = paths.filter(opp => opp.profitPercentage >= profitThreshold);

                        if (opportunities.length > 0) {
                            console.log(`üí∞ [LUNO Worker] SET ${currentSet}: ${opportunities.length} OPPORTUNITIES above ${profitThreshold}% threshold`);

                            // Execute best opportunity
                            const bestOpp = opportunities[0];
                            console.log(`‚ö° [LUNO Worker] Executing: ${bestOpp.pathId} (${bestOpp.profitPercentage.toFixed(2)}% profit)`);

                            const execResponse = await fetch(`${API_BASE}/trading/luno/triangular/execute`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                                },
                                body: JSON.stringify({
                                    apiKey,
                                    apiSecret,
                                    pathId: bestOpp.pathId,
                                    maxInvestment: maxTradeAmount
                                })
                            });

                            const execResult = await execResponse.json();

                            if (execResult.success && execResult.data) {
                                lunoWorkerStats.totalTrades++;
                                lunoWorkerStats.successfulTrades++;

                                const profit = execResult.data.actualProfit || 0;
                                lunoWorkerStats.totalProfit += profit;

                                console.log(`‚úÖ [LUNO Worker] Trade executed successfully! Profit: R ${profit.toFixed(2)}`);
                                showNotification(`‚úÖ LUNO Trade: ${bestOpp.pathId} +R${profit.toFixed(2)}`, 'success', 5000);
                            } else {
                                // Use error handler
                                lunoWorkerStats.totalTrades++;
                                handleLunoExecutionError({ message: execResult.message || 'Unknown error' }, bestOpp);
                            }
                        } else {
                            console.log(`üìä [LUNO Worker] SET ${currentSet}: All paths below ${profitThreshold}% threshold`);
                        }
                    } else {
                        console.log(`üìä [LUNO Worker] SET ${currentSet}: No paths returned from backend`);
                    }

                    // Update displays
                    updateLunoStatsDisplay();
                    await updateLunoBalance(apiKey, apiSecret);
                    document.getElementById('lunoLastScan').textContent = new Date().toLocaleTimeString();

                    // Move to next set (sequential)
                    currentSetIndex = (currentSetIndex + 1) % selectedSets.length;

                    // Continue scanning after delay
                    setTimeout(scanAndExecuteSequential, 8000); // 8 second delay

                } catch (error) {
                    console.error('‚ùå [LUNO Worker] Error:', error);
                    // Continue even on error
                    setTimeout(scanAndExecuteSequential, 8000);
                }
            }

            // Start the scanning loop
            scanAndExecuteSequential();
        }

        function stopLunoWorker() {
            console.log('üõë [LUNO Worker] Stopping...');
            lunoWorkerRunning = false;
        }

        function updateLunoStatsDisplay() {
            document.getElementById('lunoTotalTrades').textContent = lunoWorkerStats.totalTrades;
            document.getElementById('lunoSuccessfulTrades').textContent = lunoWorkerStats.successfulTrades;

            const successRate = lunoWorkerStats.totalTrades > 0
                ? ((lunoWorkerStats.successfulTrades / lunoWorkerStats.totalTrades) * 100).toFixed(1)
                : 0;
            document.getElementById('lunoSuccessRate').textContent = `${successRate}%`;

            document.getElementById('lunoTotalProfit').textContent = `R ${lunoWorkerStats.totalProfit.toFixed(2)}`;
        }

        // Toggle for Luno Triangular trading
        document.getElementById('lunoTriangularEnabled').addEventListener('click', async function() {
            console.log('üîÑ [LUNO] Toggle clicked');

            const willBeActive = !this.classList.contains('active');
            const status = document.getElementById('lunoTriangularStatus');

            if (willBeActive) {
                // Check if credentials are configured before enabling
                const apiKey = localStorage.getItem('luno_triangular_api') || '';
                const apiSecret = localStorage.getItem('luno_triangular_secret') || '';

                if (!apiKey || !apiSecret) {
                    showNotification('‚ö†Ô∏è Please configure LUNO API credentials in Strategic API Configuration first!', 'warning');
                    return; // Don't toggle
                }

                this.classList.add('active');
                status.textContent = 'ON';
                status.style.color = '#00d4ff';
                localStorage.setItem('lunoTriangularEnabled', 'true');

                // Start automated worker
                await startLunoWorker();

                showNotification('‚úÖ LUNO automated trading started! Worker scanning every 8 seconds.', 'success');
            } else {
                this.classList.remove('active');
                status.textContent = 'OFF';
                status.style.color = '#ff6b6b';
                localStorage.setItem('lunoTriangularEnabled', 'false');

                // Stop worker
                stopLunoWorker();

                showNotification('LUNO automated trading stopped', 'info');
            }
        });

        // Load saved Luno toggle state on page load
        document.addEventListener('DOMContentLoaded', async function() {
            const lunoEnabled = localStorage.getItem('lunoTriangularEnabled') === 'true';
            const toggle = document.getElementById('lunoTriangularEnabled');
            const status = document.getElementById('lunoTriangularStatus');

            // Initialize balance display if credentials exist (regardless of worker state)
            const apiKey = localStorage.getItem('luno_triangular_api');
            const apiSecret = localStorage.getItem('luno_triangular_secret');

            if (apiKey && apiSecret) {
                console.log('üí∞ [LUNO Balance] Fetching balance on page load...');
                await initializeLunoBalance(apiKey, apiSecret);
            }

            if (lunoEnabled) {
                toggle.classList.add('active');
                status.textContent = 'ON';
                status.style.color = '#00d4ff';
            }

            // Load Luno settings
            loadLunoTriangularSettings();
        });

        // ========== LUNO TAB SWITCHING ==========
        function switchLunoTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.luno-tab-content').forEach(content => {
                content.style.display = 'none';
            });

            // Remove active class from all buttons and reset styling
            document.querySelectorAll('.luno-tab-btn').forEach(btn => {
                btn.style.background = 'rgba(255,255,255,0.03)';
                btn.style.borderColor = 'transparent';
                btn.style.color = '#888';
                btn.classList.remove('active');
            });

            // Show selected tab content
            if (tabName === 'trades') {
                document.getElementById('lunoTabTrades').style.display = 'block';
            } else if (tabName === 'balance') {
                document.getElementById('lunoTabBalance').style.display = 'block';
            } else if (tabName === 'alerts') {
                document.getElementById('lunoTabAlerts').style.display = 'block';
            }

            // Highlight active button with enhanced styling
            const activeButton = document.querySelector(`.luno-tab-btn[data-tab="${tabName}"]`);
            if (activeButton) {
                activeButton.style.background = 'rgba(0,212,255,0.15)';
                activeButton.style.borderColor = '#00d4ff';
                activeButton.style.color = '#00d4ff';
                activeButton.classList.add('active');
            }
        }

        // ========== LUNO BALANCE TRACKING ==========
        // Balance tracking variables
        let lunoBalanceTracking = {
            startingZAR: null,
            startingUSDT: null,
            currentZAR: 0,
            currentUSDT: 0
        };

        // Alerts tracking
        let lunoAlerts = [];
        const MAX_LUNO_ALERTS = 20;

        // Initialize LUNO balance on page load
        async function initializeLunoBalance(apiKey, apiSecret) {
            try {
                console.log('üí∞ [LUNO Balance] Initializing balance...');

                // Fetch current balance from LUNO (same endpoint as Strategy API Setup page)
                const response = await fetch(`${API_BASE}/trading/luno/balance`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ apiKey, apiSecret })
                });

                const result = await response.json();
                console.log('üí∞ [LUNO Balance] API Response:', result);

                // Handle different response formats
                let balances = null;
                if (result.success && result.data) {
                    balances = result.data.balances || result.data;
                } else if (result.success && result.balances) {
                    balances = result.balances;
                } else if (result.balances) {
                    balances = result.balances;
                }

                console.log('üí∞ [LUNO Balance] Parsed balances:', balances);

                if (balances) {
                    // Balances is an object like { ZAR: "5000.50", XBT: "0.05", ... }
                    const currentZAR = balances.ZAR ? parseFloat(balances.ZAR) : 0;
                    const currentUSDT = balances.USDT ? parseFloat(balances.USDT) : 0;

                    // Check if starting balance is already set (from localStorage)
                    const stored = localStorage.getItem('lunoStartingBalance');
                    if (stored) {
                        const parsed = JSON.parse(stored);
                        lunoBalanceTracking.startingZAR = parsed.zar;
                        lunoBalanceTracking.startingUSDT = parsed.usdt;
                    } else {
                        // First time - set current as starting
                        lunoBalanceTracking.startingZAR = currentZAR;
                        lunoBalanceTracking.startingUSDT = currentUSDT;
                        localStorage.setItem('lunoStartingBalance', JSON.stringify({
                            zar: currentZAR,
                            usdt: currentUSDT
                        }));
                    }

                    lunoBalanceTracking.currentZAR = currentZAR;
                    lunoBalanceTracking.currentUSDT = currentUSDT;

                    updateLunoBalanceDisplay();
                    console.log('‚úÖ [LUNO Balance] Initialized:', lunoBalanceTracking);
                }
            } catch (error) {
                console.error('‚ùå [LUNO Balance] Failed to initialize:', error);
            }
        }

        // Update LUNO balance (called during worker scanning)
        async function updateLunoBalance(apiKey, apiSecret) {
            try {
                const response = await fetch(`${API_BASE}/trading/luno/balance`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ apiKey, apiSecret })
                });

                const result = await response.json();

                // Handle different response formats
                let balances = null;
                if (result.success && result.data) {
                    balances = result.data.balances || result.data;
                } else if (result.success && result.balances) {
                    balances = result.balances;
                } else if (result.balances) {
                    balances = result.balances;
                }

                if (balances) {
                    lunoBalanceTracking.currentZAR = balances.ZAR ? parseFloat(balances.ZAR) : 0;
                    lunoBalanceTracking.currentUSDT = balances.USDT ? parseFloat(balances.USDT) : 0;

                    updateLunoBalanceDisplay();
                }
            } catch (error) {
                console.error('‚ùå [LUNO Balance] Update failed:', error);
            }
        }

        // Update balance display
        function updateLunoBalanceDisplay() {
            // Update starting balances
            document.getElementById('lunoStartingZAR').textContent = `R ${lunoBalanceTracking.startingZAR?.toFixed(2) || '0.00'}`;
            document.getElementById('lunoStartingUSDT').textContent = `$${lunoBalanceTracking.startingUSDT?.toFixed(2) || '0.00'}`;

            // Update current balances
            document.getElementById('lunoCurrentZAR').textContent = `R ${lunoBalanceTracking.currentZAR.toFixed(2)}`;
            document.getElementById('lunoCurrentUSDT').textContent = `$${lunoBalanceTracking.currentUSDT.toFixed(2)}`;

            // Calculate and display changes with color coding
            if (lunoBalanceTracking.startingZAR) {
                const zarChange = lunoBalanceTracking.currentZAR - lunoBalanceTracking.startingZAR;
                const zarChangePercent = (zarChange / lunoBalanceTracking.startingZAR * 100).toFixed(2);
                const zarColor = zarChange >= 0 ? '#00ff00' : '#ff4444';
                const zarSign = zarChange >= 0 ? '+' : '';
                document.getElementById('lunoChangeZAR').innerHTML = `<span style="color: ${zarColor}">${zarSign}R ${zarChange.toFixed(2)} (${zarSign}${zarChangePercent}%)</span>`;
            }

            if (lunoBalanceTracking.startingUSDT) {
                const usdtChange = lunoBalanceTracking.currentUSDT - lunoBalanceTracking.startingUSDT;
                const usdtChangePercent = (usdtChange / lunoBalanceTracking.startingUSDT * 100).toFixed(2);
                const usdtColor = usdtChange >= 0 ? '#00ff00' : '#ff4444';
                const usdtSign = usdtChange >= 0 ? '+' : '';
                document.getElementById('lunoChangeUSDT').innerHTML = `<span style="color: ${usdtColor}">${usdtSign}$${usdtChange.toFixed(2)} (${usdtSign}${usdtChangePercent}%)</span>`;
            }

            // Update last updated time
            document.getElementById('lunoBalanceLastUpdate').textContent = new Date().toLocaleTimeString();
        }

        // Reset starting balance
        function resetLunoStartingBalance() {
            lunoBalanceTracking.startingZAR = lunoBalanceTracking.currentZAR;
            lunoBalanceTracking.startingUSDT = lunoBalanceTracking.currentUSDT;

            localStorage.setItem('lunoStartingBalance', JSON.stringify({
                zar: lunoBalanceTracking.startingZAR,
                usdt: lunoBalanceTracking.startingUSDT
            }));

            updateLunoBalanceDisplay();
            alert('‚úÖ Starting balance reset to current values');
            console.log('üîÑ [LUNO Balance] Reset starting balance:', lunoBalanceTracking);
        }

        // ========== LUNO ERROR HANDLING & ALERTS ==========

        // Categorize error type
        function categorizeLunoError(errorMessage) {
            if (!errorMessage) return 'other';
            const msg = errorMessage.toLowerCase();

            if (msg.includes('insufficient') && (msg.includes('balance') || msg.includes('zar') || msg.includes('usdt') || msg.includes('xbt'))) {
                return 'balance';
            } else if (msg.includes('slippage')) {
                return 'slippage';
            } else if (msg.includes('execution') || msg.includes('order') || msg.includes('trade')) {
                return 'execution';
            } else {
                return 'other';
            }
        }

        // Handle execution errors
        function handleLunoExecutionError(error, opportunity) {
            const errorType = categorizeLunoError(error.message);

            if (errorType === 'balance') {
                // Parse balance info from error message
                const match = error.message.match(/need [R$]([\d,.]+).*have [R$]([\d,.]+)/i);
                const currency = error.message.includes('ZAR') ? 'ZAR' :
                                error.message.includes('XBT') ? 'XBT' : 'USDT';

                let required = 0, available = 0, shortfall = 0;
                if (match) {
                    required = parseFloat(match[1].replace(/,/g, ''));
                    available = parseFloat(match[2].replace(/,/g, ''));
                    shortfall = required - available;
                }

                addLunoAlert('balance', `Insufficient ${currency} Balance`, {
                    path: opportunity.pathId,
                    required: required,
                    available: available,
                    shortfall: shortfall,
                    suggestion: `Top up ${currency} balance or reduce "Max Single Trade" amount`
                });

                showNotification(`‚ö†Ô∏è Insufficient ${currency} - Opportunity skipped`, 'warning', 8000);

            } else if (errorType === 'slippage') {
                addLunoAlert('slippage', 'Price Slippage Detected', {
                    path: opportunity.pathId,
                    error: error.message,
                    suggestion: 'Market moved too quickly. Increase slippage tolerance or reduce trade size.'
                });

                showNotification('‚ö†Ô∏è Slippage - Opportunity skipped', 'warning', 6000);

            } else if (errorType === 'execution') {
                addLunoAlert('execution', 'Trade Execution Failed', {
                    path: opportunity.pathId,
                    error: error.message,
                    suggestion: 'Check API permissions and exchange status'
                });

                showNotification('‚ö†Ô∏è Execution failed - Check alerts', 'error', 6000);

            } else {
                addLunoAlert('other', 'Unknown Error', {
                    path: opportunity.pathId,
                    error: error.message,
                    suggestion: 'Check console logs for details'
                });

                showNotification('‚ö†Ô∏è Error occurred - Check alerts', 'error', 6000);
            }
        }

        // Add alert to alerts tab
        function addLunoAlert(type, title, details) {
            const alert = {
                type: type,
                title: title,
                details: details,
                timestamp: new Date().toISOString()
            };

            lunoAlerts.unshift(alert); // Add to beginning

            if (lunoAlerts.length > MAX_LUNO_ALERTS) {
                lunoAlerts.pop(); // Remove oldest
            }

            updateLunoAlertsDisplay();
            updateLunoAlertBadge();
        }

        // Update alerts display
        function updateLunoAlertsDisplay() {
            const alertsList = document.getElementById('lunoAlertsList');

            if (lunoAlerts.length === 0) {
                alertsList.innerHTML = '<div style="text-align: center; color: #888; padding: 20px;">No alerts yet. Alerts will appear here when errors occur.</div>';
                return;
            }

            alertsList.innerHTML = lunoAlerts.map(alert => {
                const icon = alert.type === 'balance' ? 'üí∞' :
                            alert.type === 'slippage' ? 'üìâ' :
                            alert.type === 'execution' ? '‚ö†Ô∏è' : '‚ùå';
                const color = alert.type === 'balance' ? '#ffa500' :
                             alert.type === 'slippage' ? '#ff6b6b' :
                             alert.type === 'execution' ? '#ff4444' : '#888';
                const time = new Date(alert.timestamp).toLocaleTimeString();

                let detailsHtml = '';
                if (alert.details) {
                    if (alert.details.path) {
                        detailsHtml += `<div style="color: #888; font-size: 0.85rem; margin-top: 5px;">Path: ${alert.details.path}</div>`;
                    }
                    if (alert.details.required) {
                        detailsHtml += `<div style="color: #888; font-size: 0.85rem;">Required: R ${alert.details.required.toFixed(2)} | Available: R ${alert.details.available.toFixed(2)} | Shortfall: R ${alert.details.shortfall.toFixed(2)}</div>`;
                    }
                    if (alert.details.suggestion) {
                        detailsHtml += `<div style="color: #00d4ff; font-size: 0.85rem; margin-top: 5px;">üí° ${alert.details.suggestion}</div>`;
                    }
                }

                return `
                    <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px; margin-bottom: 10px; border-left: 3px solid ${color};">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <div style="color: ${color}; font-weight: bold;">${icon} ${alert.title}</div>
                            <div style="color: #888; font-size: 0.85rem;">${time}</div>
                        </div>
                        ${detailsHtml}
                    </div>
                `;
            }).join('');
        }

        // Update alert badge counter
        function updateLunoAlertBadge() {
            const badge = document.getElementById('lunoAlertBadge');
            if (lunoAlerts.length > 0) {
                badge.textContent = lunoAlerts.length;
                badge.style.display = 'inline';
            } else {
                badge.style.display = 'none';
            }
        }

        // Test Luno Triangular Connection
        async function testLunoTriangularConnection() {
            console.log('üîç [LUNO] Testing connection...');
            try {
                // Get credentials from localStorage (saved from strategy-api-setup.html)
                const apiKey = localStorage.getItem('luno_triangular_api');
                const apiSecret = localStorage.getItem('luno_triangular_secret');
                console.log('üîë [LUNO] API credentials retrieved from localStorage');

                if (!apiKey || !apiSecret) {
                    console.warn('‚ö†Ô∏è [LUNO] Missing API credentials');
                    alert('‚ùå Please set up your Luno API credentials first in the Strategy API Setup page.');
                    return;
                }

                // Show loading message
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '‚è≥ Testing...';
                btn.disabled = true;

                // Call backend test-connection route
                console.log('üì° [LUNO] Sending test connection request to backend...');
                const response = await fetch('/api/v1/trading/luno/triangular/test-connection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        apiKey: apiKey,
                        apiSecret: apiSecret
                    })
                });

                const result = await response.json();
                console.log('‚úÖ [LUNO] Test connection response received:', result);

                btn.textContent = originalText;
                btn.disabled = false;

                if (result.success) {
                    console.log('‚úÖ [LUNO] Connection successful!', result.data);
                    alert(`‚úÖ Luno Connection Successful!\n\n` +
                          `‚Ä¢ Balance Access: ${result.data.balanceAccess ? 'Yes' : 'No'}\n` +
                          `‚Ä¢ Triangular Pairs Available: ${result.data.triangularPairsAvailable ? 'Yes' : 'No'}\n` +
                          `‚Ä¢ Total Pairs: ${result.data.totalPairs}\n` +
                          `‚Ä¢ Required Pairs Found: ${result.data.requiredPairsFound.length}/6`);
                } else {
                    console.error('‚ùå [LUNO] Connection failed:', result.message);
                    alert(`‚ùå Connection Failed: ${result.message || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('‚ùå [LUNO] Connection error:', error);
                alert(`‚ùå Connection Error: ${error.message}`);
            }
        }

        // Scan Luno Triangular Paths
        async function scanLunoTriangularPaths() {
            console.log('üîç [LUNO] Starting path scan...');
            try {
                const apiKey = localStorage.getItem('luno_triangular_api');
                const apiSecret = localStorage.getItem('luno_triangular_secret');

                if (!apiKey || !apiSecret) {
                    console.warn('‚ö†Ô∏è [LUNO] Missing API credentials');
                    alert('‚ùå Please set up your Luno API credentials first.');
                    return;
                }

                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '‚è≥ Scanning...';
                btn.disabled = true;

                // Get enabled path sets
                const enabledSets = [];
                for (let i = 1; i <= 6; i++) {
                    const checkbox = document.getElementById(`lunoSet${i}Enabled`);
                    if (checkbox && checkbox.checked) {
                        enabledSets.push(i);
                    }
                }
                console.log('üìä [LUNO] Enabled path sets:', enabledSets);

                console.log('üì° [LUNO] Sending scan request to backend...');
                const response = await fetch('/api/v1/trading/luno/triangular/scan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        apiKey: apiKey,
                        apiSecret: apiSecret,
                        paths: enabledSets.length > 0 ? enabledSets : 'all'
                    })
                });

                const result = await response.json();
                console.log('‚úÖ [LUNO] Scan response received:', result);

                btn.textContent = originalText;
                btn.disabled = false;

                if (result.success) {
                    document.getElementById('lunoLastScan').textContent = new Date().toLocaleTimeString();
                    console.log(`‚úÖ [LUNO] Scan successful! Found ${result.data.opportunities.length} opportunities`);
                    alert(`‚úÖ Scan Complete!\n\n` +
                          `‚Ä¢ Path Sets Scanned: ${result.data.pathSetsScanned}\n` +
                          `‚Ä¢ Total Paths: ${result.data.totalPathsScanned}\n` +
                          `‚Ä¢ Opportunities Found: ${result.data.opportunities.length}\n\n` +
                          `${result.data.message || 'Full implementation coming soon!'}`);
                } else {
                    console.error('‚ùå [LUNO] Scan failed:', result.message);
                    alert(`‚ùå Scan Failed: ${result.message || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('‚ùå [LUNO] Scan error:', error);
                alert(`‚ùå Scan Error: ${error.message}`);
            }
        }

        // View Luno Path Details - Custom Modal
        function viewLunoPathDetails() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                backdrop-filter: blur(5px);
            `;

            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
                padding: 30px;
                border-radius: 15px;
                max-width: 900px;
                max-height: 80vh;
                overflow-y: auto;
                box-shadow: 0 20px 60px rgba(0, 212, 255, 0.3);
                border: 2px solid #00d4ff;
            `;

            modalContent.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                    <h2 style="color: #00d4ff; margin: 0; font-size: 1.8rem;">
                        üìã LUNO Triangular Arbitrage Paths
                    </h2>
                    <button onclick="this.closest('[style*=\\'position: fixed\\']').remove()"
                            style="background: rgba(255,0,0,0.2); border: 1px solid #ff4444; color: #ff4444;
                                   padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 1.2rem;">
                        ‚úï
                    </button>
                </div>

                <div style="background: rgba(0,212,255,0.1); padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #00d4ff;">
                    <p style="margin: 0; color: #b8c6db; font-size: 0.95rem;">
                        üí° <strong style="color: #00d4ff;">24 Total Paths</strong> across 6 sets (4 paths per set - matching VALR structure).
                        All paths start and end with ZAR or USDT (fundable currencies).
                    </p>
                </div>

                <!-- SET 1: ETH FOCUS (4 paths) -->
                <div style="background: rgba(0,212,255,0.05); padding: 20px; border-radius: 12px; margin-bottom: 15px; border: 1px solid rgba(0,212,255,0.3);">
                    <h3 style="color: #00d4ff; margin-top: 0; font-size: 1.3rem;">
                        üî∑ SET 1: ETH Focus (4 paths)
                    </h3>
                    <p style="color: #b8c6db; font-size: 0.9rem; margin-bottom: 15px;">Ethereum-focused triangular paths</p>
                    <div style="display: grid; gap: 8px; font-family: monospace; font-size: 0.9rem;">
                        <div style="padding: 10px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                            1. <span style="color: #00ff88;">ZAR ‚Üí XBT ‚Üí ETH ‚Üí ZAR</span>
                        </div>
                        <div style="padding: 10px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                            2. <span style="color: #00ff88;">ZAR ‚Üí ETH ‚Üí XBT ‚Üí ZAR</span>
                        </div>
                        <div style="padding: 10px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                            3. <span style="color: #00ff88;">USDT ‚Üí XBT ‚Üí ETH ‚Üí USDT</span>
                        </div>
                        <div style="padding: 10px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                            4. <span style="color: #00ff88;">USDT ‚Üí ETH ‚Üí XBT ‚Üí USDT</span>
                        </div>
                    </div>
                </div>

                <!-- SET 2: SOL FOCUS (4 paths) -->
                <div style="background: rgba(0,212,255,0.05); padding: 20px; border-radius: 12px; margin-bottom: 15px; border: 1px solid rgba(0,212,255,0.3);">
                    <h3 style="color: #00d4ff; margin-top: 0; font-size: 1.3rem;">
                        üî∑ SET 2: SOL Focus (4 paths)
                    </h3>
                    <p style="color: #b8c6db; font-size: 0.9rem; margin-bottom: 15px;">Solana-focused triangular paths</p>
                    <div style="display: grid; gap: 8px; font-family: monospace; font-size: 0.9rem;">
                        <div style="padding: 10px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                            1. <span style="color: #00ff88;">ZAR ‚Üí XBT ‚Üí SOL ‚Üí ZAR</span>
                        </div>
                        <div style="padding: 10px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                            2. <span style="color: #00ff88;">ZAR ‚Üí SOL ‚Üí XBT ‚Üí ZAR</span>
                        </div>
                        <div style="padding: 10px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                            3. <span style="color: #00ff88;">USDT ‚Üí XBT ‚Üí SOL ‚Üí USDT</span>
                        </div>
                        <div style="padding: 10px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                            4. <span style="color: #00ff88;">USDT ‚Üí SOL ‚Üí XBT ‚Üí USDT</span>
                        </div>
                    </div>
                </div>

                <!-- SET 3: XRP FOCUS (4 paths) -->
                <div style="background: rgba(0,212,255,0.05); padding: 20px; border-radius: 12px; margin-bottom: 15px; border: 1px solid rgba(0,212,255,0.3);">
                    <h3 style="color: #00d4ff; margin-top: 0; font-size: 1.3rem;">
                        üî∑ SET 3: XRP Focus (4 paths)
                    </h3>
                    <p style="color: #b8c6db; font-size: 0.9rem; margin-bottom: 15px;">Ripple-focused triangular paths</p>
                    <div style="display: grid; gap: 8px; font-family: monospace; font-size: 0.9rem;">
                        <div style="padding: 10px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                            1. <span style="color: #00ff88;">ZAR ‚Üí XBT ‚Üí XRP ‚Üí ZAR</span>
                        </div>
                        <div style="padding: 10px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                            2. <span style="color: #00ff88;">ZAR ‚Üí XRP ‚Üí XBT ‚Üí ZAR</span>
                        </div>
                        <div style="padding: 10px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                            3. <span style="color: #00ff88;">USDT ‚Üí XBT ‚Üí XRP ‚Üí USDT</span>
                        </div>
                        <div style="padding: 10px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                            4. <span style="color: #00ff88;">USDT ‚Üí XRP ‚Üí XBT ‚Üí USDT</span>
                        </div>
                    </div>
                </div>

                <!-- SET 4: USDT BRIDGE (4 paths) -->
                <div style="background: rgba(0,212,255,0.05); padding: 20px; border-radius: 12px; margin-bottom: 15px; border: 1px solid rgba(0,212,255,0.3);">
                    <h3 style="color: #00d4ff; margin-top: 0; font-size: 1.3rem;">
                        üî∑ SET 4: USDT Bridge (4 paths)
                    </h3>
                    <p style="color: #b8c6db; font-size: 0.9rem; margin-bottom: 15px;">ZAR paths via USDT intermediary</p>
                    <div style="display: grid; gap: 8px; font-family: monospace; font-size: 0.9rem;">
                        <div style="padding: 10px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                            1. <span style="color: #00ff88;">ZAR ‚Üí USDT ‚Üí XBT ‚Üí ZAR</span>
                        </div>
                        <div style="padding: 10px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                            2. <span style="color: #00ff88;">ZAR ‚Üí USDT ‚Üí ETH ‚Üí ZAR</span>
                        </div>
                        <div style="padding: 10px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                            3. <span style="color: #00ff88;">ZAR ‚Üí USDT ‚Üí SOL ‚Üí ZAR</span>
                        </div>
                        <div style="padding: 10px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                            4. <span style="color: #00ff88;">ZAR ‚Üí USDT ‚Üí XRP ‚Üí ZAR</span>
                        </div>
                    </div>
                </div>

                <!-- SET 5: ALTCOINS 1 (4 paths) -->
                <div style="background: rgba(0,212,255,0.05); padding: 20px; border-radius: 12px; margin-bottom: 15px; border: 1px solid rgba(0,212,255,0.3);">
                    <h3 style="color: #00d4ff; margin-top: 0; font-size: 1.3rem;">
                        üî∑ SET 5: Altcoins 1 - ADA/DOT (4 paths)
                    </h3>
                    <p style="color: #b8c6db; font-size: 0.9rem; margin-bottom: 15px;">Cardano and Polkadot paths</p>
                    <div style="display: grid; gap: 8px; font-family: monospace; font-size: 0.9rem;">
                        <div style="padding: 10px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                            1. <span style="color: #00ff88;">ZAR ‚Üí XBT ‚Üí ADA ‚Üí ZAR</span>
                        </div>
                        <div style="padding: 10px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                            2. <span style="color: #00ff88;">ZAR ‚Üí ADA ‚Üí XBT ‚Üí ZAR</span>
                        </div>
                        <div style="padding: 10px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                            3. <span style="color: #00ff88;">ZAR ‚Üí XBT ‚Üí DOT ‚Üí ZAR</span>
                        </div>
                        <div style="padding: 10px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                            4. <span style="color: #00ff88;">ZAR ‚Üí DOT ‚Üí XBT ‚Üí ZAR</span>
                        </div>
                    </div>
                </div>

                <!-- SET 6: ALTCOINS 2 (4 paths) -->
                <div style="background: rgba(0,212,255,0.05); padding: 20px; border-radius: 12px; margin-bottom: 15px; border: 1px solid rgba(0,212,255,0.3);">
                    <h3 style="color: #00d4ff; margin-top: 0; font-size: 1.3rem;">
                        üî∑ SET 6: Altcoins 2 - AVAX/LTC (4 paths)
                    </h3>
                    <p style="color: #b8c6db; font-size: 0.9rem; margin-bottom: 15px;">Avalanche and Litecoin paths</p>
                    <div style="display: grid; gap: 8px; font-family: monospace; font-size: 0.9rem;">
                        <div style="padding: 10px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                            1. <span style="color: #00ff88;">ZAR ‚Üí XBT ‚Üí AVAX ‚Üí ZAR</span>
                        </div>
                        <div style="padding: 10px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                            2. <span style="color: #00ff88;">ZAR ‚Üí AVAX ‚Üí XBT ‚Üí ZAR</span>
                        </div>
                        <div style="padding: 10px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                            3. <span style="color: #00ff88;">ZAR ‚Üí XBT ‚Üí LTC ‚Üí ZAR</span>
                        </div>
                        <div style="padding: 10px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                            4. <span style="color: #00ff88;">ZAR ‚Üí LTC ‚Üí XBT ‚Üí ZAR</span>
                        </div>
                    </div>
                </div>
            `;

            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // Close on background click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // Clear Luno Triangular History
        async function clearLunoTriangularHistory() {
            console.log('üóëÔ∏è [LUNO] Clear history requested');
            if (!confirm('‚ö†Ô∏è Clear all Luno triangular trade history?\n\nThis action cannot be undone.')) {
                console.log('‚ùå [LUNO] Clear history cancelled by user');
                return;
            }

            try {
                console.log('üì° [LUNO] Sending delete request to backend...');
                const response = await fetch('/api/v1/trading/luno/triangular/history', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                console.log('‚úÖ [LUNO] Delete response received:', result);

                if (result.success) {
                    console.log('‚úÖ [LUNO] History cleared, resetting UI stats...');
                    // Reset stats display
                    document.getElementById('lunoTotalTrades').textContent = '0';
                    document.getElementById('lunoSuccessfulTrades').textContent = '0';
                    document.getElementById('lunoSuccessRate').textContent = '0%';
                    document.getElementById('lunoTotalProfit').textContent = '$0.00';
                    document.getElementById('lunoBestPath').textContent = '-';
                    document.getElementById('lunoLastScan').textContent = 'Never';

                    // Clear recent trades display
                    document.getElementById('lunoRecentTrades').innerHTML =
                        '<div style="text-align: center; color: #888; padding: 20px;">No triangular trades yet. Enable live trading to start.</div>';

                    alert('‚úÖ History cleared successfully!');
                } else {
                    console.error('‚ùå [LUNO] Failed to clear history:', result.message);
                    alert(`‚ùå Failed to clear history: ${result.message || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('‚ùå [LUNO] Clear history error:', error);
                alert(`‚ùå Error: ${error.message}`);
            }
        }

        // Save Luno settings to localStorage
        function saveLunoTriangularSettings() {
            console.log('üíæ [LUNO] Saving settings to localStorage...');
            const settings = {
                maxTrade: document.getElementById('lunoMaxTrade').value,
                portfolioPercent: document.getElementById('lunoPortfolioPercent').value,
                profitThreshold: document.getElementById('lunoProfitThreshold').value
            };

            // Save path set states (6 sets for Luno)
            for (let i = 1; i <= 6; i++) {
                const checkbox = document.getElementById(`lunoSet${i}Enabled`);
                if (checkbox) {
                    settings[`set${i}Enabled`] = checkbox.checked;
                }
            }

            localStorage.setItem('lunoTriangularSettings', JSON.stringify(settings));
            console.log('‚úÖ [LUNO] Settings saved:', settings);
        }

        // Load Luno settings from localStorage
        function loadLunoTriangularSettings() {
            console.log('üíæ [LUNO] Loading settings from localStorage...');
            const savedSettings = localStorage.getItem('lunoTriangularSettings');
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);
                console.log('‚úÖ [LUNO] Settings loaded:', settings);

                if (settings.maxTrade) document.getElementById('lunoMaxTrade').value = settings.maxTrade;
                if (settings.portfolioPercent) document.getElementById('lunoPortfolioPercent').value = settings.portfolioPercent;
                if (settings.profitThreshold) document.getElementById('lunoProfitThreshold').value = settings.profitThreshold;

                // Load path set states (7 sets)
                for (let i = 1; i <= 7; i++) {
                    const checkbox = document.getElementById(`lunoSet${i}Enabled`);
                    if (checkbox && settings[`set${i}Enabled`] !== undefined) {
                        checkbox.checked = settings[`set${i}Enabled`];
                    }
                }
            } else {
                console.log('‚ÑπÔ∏è [LUNO] No saved settings found, using defaults');
            }
        }

        // Auto-save Luno settings when changed
        document.addEventListener('DOMContentLoaded', function() {
            // Add event listeners for Luno settings auto-save
            const lunoInputs = document.querySelectorAll('#lunoMaxTrade, #lunoPortfolioPercent, #lunoProfitThreshold');
            lunoInputs.forEach(input => {
                input.addEventListener('change', saveLunoTriangularSettings);
            });

            // Add event listeners for Luno checkboxes (6 sets)
            for (let i = 1; i <= 6; i++) {
                const checkbox = document.getElementById(`lunoSet${i}Enabled`);
                if (checkbox) {
                    checkbox.addEventListener('change', saveLunoTriangularSettings);
                }
            }
        });

        // ============================================================================
        // CHAINEX TRIANGULAR ARBITRAGE JAVASCRIPT
        // ============================================================================

        // Toggle for ChainEX Triangular trading
        document.getElementById('chainexTriangularEnabled').addEventListener('click', function() {
            console.log('üîÑ [CHAINEX] Toggle clicked');
            this.classList.toggle('active');
            const status = document.getElementById('chainexTriangularStatus');

            if (this.classList.contains('active')) {
                console.log('‚úÖ [CHAINEX] Live trading enabled');
                status.textContent = 'ON';
                status.style.color = '#ff9800';
                localStorage.setItem('chainexTriangularEnabled', 'true');
            } else {
                console.log('‚ùå [CHAINEX] Live trading disabled');
                status.textContent = 'OFF';
                status.style.color = '#ff6b6b';
                localStorage.setItem('chainexTriangularEnabled', 'false');
            }
        });

        // Load saved ChainEX toggle state on page load
        document.addEventListener('DOMContentLoaded', function() {
            const chainexEnabled = localStorage.getItem('chainexTriangularEnabled') === 'true';
            const toggle = document.getElementById('chainexTriangularEnabled');
            const status = document.getElementById('chainexTriangularStatus');

            if (chainexEnabled) {
                toggle.classList.add('active');
                status.textContent = 'ON';
                status.style.color = '#ff9800';
            }

            // Load ChainEX settings
            loadChainExTriangularSettings();
        });

        // Test ChainEX Triangular Connection
        async function testChainExTriangularConnection() {
            console.log('üîç [CHAINEX] Testing connection...');
            try {
                // Get credentials from localStorage (saved from strategy-api-setup.html)
                const apiKey = localStorage.getItem('chainex_triangular_api');
                const apiSecret = localStorage.getItem('chainex_triangular_secret');
                console.log('üîë [CHAINEX] API credentials retrieved from localStorage');

                if (!apiKey || !apiSecret) {
                    console.warn('‚ö†Ô∏è [CHAINEX] Missing API credentials');
                    alert('‚ùå Please set up your ChainEX API credentials first in the Strategy API Setup page.');
                    return;
                }

                // Show loading message
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '‚è≥ Testing...';
                btn.disabled = true;

                // Call backend test-connection route
                console.log('üì° [CHAINEX] Sending test connection request to backend...');
                const response = await fetch('/api/v1/trading/chainex/triangular/test-connection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        apiKey: apiKey,
                        apiSecret: apiSecret
                    })
                });

                const result = await response.json();
                console.log('‚úÖ [CHAINEX] Test connection response received:', result);

                btn.textContent = originalText;
                btn.disabled = false;

                if (result.success) {
                    console.log('‚úÖ [CHAINEX] Connection successful!', result.data);
                    alert(`‚úÖ ChainEX Connection Successful!\n\n` +
                          `‚Ä¢ Authenticated: ${result.data.authenticated ? 'Yes' : 'No'}\n` +
                          `‚Ä¢ Available Pairs: ${result.data.availablePairs}\n` +
                          `‚Ä¢ Required Pairs: ${result.data.requiredPairs}\n` +
                          `‚Ä¢ Missing Pairs: ${result.data.missingPairs.length}\n` +
                          `‚Ä¢ Triangular Ready: ${result.data.triangularReady ? 'Yes' : 'No'}`);
                } else {
                    console.error('‚ùå [CHAINEX] Connection failed:', result.message);
                    alert(`‚ùå Connection Failed: ${result.message || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('‚ùå [CHAINEX] Connection error:', error);
                alert(`‚ùå Connection Error: ${error.message}`);
            }
        }

        // Scan ChainEX Triangular Paths
        async function scanChainExTriangularPaths() {
            console.log('üîç [CHAINEX] Starting path scan...');
            try {
                const apiKey = localStorage.getItem('chainex_triangular_api');
                const apiSecret = localStorage.getItem('chainex_triangular_secret');

                if (!apiKey || !apiSecret) {
                    console.warn('‚ö†Ô∏è [CHAINEX] Missing API credentials');
                    alert('‚ùå Please set up your ChainEX API credentials first.');
                    return;
                }

                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '‚è≥ Scanning...';
                btn.disabled = true;

                // Get enabled path sets
                const enabledSets = [];
                for (let i = 1; i <= 6; i++) {
                    const checkbox = document.getElementById(`chainexSet${i}Enabled`);
                    if (checkbox && checkbox.checked) {
                        enabledSets.push(i);
                    }
                }
                console.log('üìä [CHAINEX] Enabled path sets:', enabledSets);

                console.log('üì° [CHAINEX] Sending scan request to backend...');
                const response = await fetch('/api/v1/trading/chainex/triangular/scan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        apiKey: apiKey,
                        apiSecret: apiSecret,
                        paths: enabledSets.length > 0 ? enabledSets : 'all'
                    })
                });

                const result = await response.json();
                console.log('‚úÖ [CHAINEX] Scan response received:', result);

                btn.textContent = originalText;
                btn.disabled = false;

                if (result.success) {
                    document.getElementById('chainexLastScan').textContent = new Date().toLocaleTimeString();
                    console.log(`‚úÖ [CHAINEX] Scan successful! Found ${result.data.opportunities.length} opportunities`);

                    let message = `‚úÖ Scan Complete!\n\n`;
                    message += `‚Ä¢ Paths Scanned: ${result.data.scannedPaths}\n`;
                    message += `‚Ä¢ Opportunities Found: ${result.data.opportunities.length}\n\n`;

                    if (result.data.opportunities.length > 0) {
                        message += `Top 3 Opportunities:\n`;
                        result.data.opportunities.slice(0, 3).forEach((opp, i) => {
                            message += `${i + 1}. ${opp.sequence}\n`;
                            message += `   Profit: ${opp.profitPercent.toFixed(2)}% (R ${opp.profitZar.toFixed(2)})\n`;
                        });
                    } else {
                        message += `No profitable opportunities found at this time.`;
                    }

                    alert(message);
                } else {
                    console.error('‚ùå [CHAINEX] Scan failed:', result.message);
                    alert(`‚ùå Scan Failed: ${result.message || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('‚ùå [CHAINEX] Scan error:', error);
                alert(`‚ùå Scan Error: ${error.message}`);
            }
        }

        // View ChainEX Path Details - Custom Modal
        function viewChainExPathDetails() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                backdrop-filter: blur(5px);
            `;

            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
                padding: 30px;
                border-radius: 15px;
                max-width: 900px;
                max-height: 80vh;
                overflow-y: auto;
                box-shadow: 0 20px 60px rgba(0, 212, 255, 0.3);
                border: 2px solid #00d4ff;
            `;

            modalContent.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                    <h2 style="color: #00d4ff; margin: 0; font-size: 1.8rem;">
                        üìã CHAINEX Triangular Arbitrage Paths
                    </h2>
                    <button onclick="this.closest('[style*=\\'position: fixed\\']').remove()"
                            style="background: rgba(255,0,0,0.2); border: 1px solid #ff4444; color: #ff4444;
                                   padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 1.2rem;">
                        ‚úï
                    </button>
                </div>

                <div style="background: rgba(0,212,255,0.1); padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #00d4ff;">
                    <p style="margin: 0; color: #b8c6db; font-size: 0.95rem;">
                        üí° <strong style="color: #00d4ff;">22 Total Paths</strong> across 5 sets.
                        üáøüá¶ South African exchange - ZAR based paths.
                    </p>
                </div>

                <!-- SET 1: Essential BTC Bridge (6 paths) -->
                <div style="background: rgba(0,212,255,0.05); padding: 20px; border-radius: 12px; margin-bottom: 15px; border: 1px solid rgba(0,212,255,0.3);">
                    <h3 style="color: #00d4ff; margin-top: 0; font-size: 1.3rem;">
                        üî∑ SET 1: Essential BTC Bridge (6 paths) ‚úÖ DEFAULT
                    </h3>
                    <p style="color: #b8c6db; font-size: 0.9rem; margin-bottom: 15px;">Bitcoin-focused triangular paths</p>
                    <div style="display: grid; gap: 8px; font-family: monospace; font-size: 0.9rem;">
                        <div style="padding: 10px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                            1. <span style="color: #00ff88;">ZAR ‚Üí BTC ‚Üí ETH ‚Üí ZAR</span>
                        </div>
                        <div style="padding: 10px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                            2. <span style="color: #00ff88;">ZAR ‚Üí BTC ‚Üí XRP ‚Üí ZAR</span>
                        </div>
                        <div style="padding: 10px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                            3. <span style="color: #00ff88;">ZAR ‚Üí BTC ‚Üí LTC ‚Üí ZAR</span>
                        </div>
                        <div style="padding: 10px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                            4. <span style="color: #00ff88;">ZAR ‚Üí BTC ‚Üí DOGE ‚Üí ZAR</span>
                        </div>
                        <div style="padding: 10px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                            5. <span style="color: #00ff88;">ZAR ‚Üí BTC ‚Üí ADA ‚Üí ZAR</span>
                        </div>
                        <div style="padding: 10px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                            6. <span style="color: #00ff88;">ZAR ‚Üí BTC ‚Üí SOL ‚Üí ZAR</span>
                        </div>
                    </div>
                </div>

                <!-- SET 2: ETH Secondary Bridge (5 paths) -->
                <div style="background: rgba(0,212,255,0.05); padding: 20px; border-radius: 12px; margin-bottom: 15px; border: 1px solid rgba(0,212,255,0.3);">
                    <h3 style="color: #00d4ff; margin-top: 0; font-size: 1.3rem;">
                        üî∑ SET 2: ETH Secondary Bridge (5 paths) ‚úÖ DEFAULT
                    </h3>
                    <p style="color: #b8c6db; font-size: 0.9rem; margin-bottom: 15px;">Ethereum-focused triangular paths</p>
                    <div style="display: grid; gap: 8px; font-family: monospace; font-size: 0.9rem;">
                        <div style="padding: 10px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                            1. <span style="color: #00ff88;">ZAR ‚Üí ETH ‚Üí BTC ‚Üí ZAR</span>
                        </div>
                        <div style="padding: 10px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                            2. <span style="color: #00ff88;">ZAR ‚Üí ETH ‚Üí SOL ‚Üí ZAR</span>
                        </div>
                        <div style="padding: 10px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                            3. <span style="color: #00ff88;">ZAR ‚Üí ETH ‚Üí ADA ‚Üí ZAR</span>
                        </div>
                        <div style="padding: 10px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                            4. <span style="color: #00ff88;">ZAR ‚Üí ETH ‚Üí DOT ‚Üí ZAR</span>
                        </div>
                        <div style="padding: 10px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                            5. <span style="color: #00ff88;">ZAR ‚Üí ETH ‚Üí LINK ‚Üí ZAR</span>
                        </div>
                    </div>
                </div>

                <!-- SET 3: USDT Bridge (5 paths) -->
                <div style="background: rgba(0,212,255,0.05); padding: 20px; border-radius: 12px; margin-bottom: 15px; border: 1px solid rgba(0,212,255,0.3);">
                    <h3 style="color: #00d4ff; margin-top: 0; font-size: 1.3rem;">
                        üî∑ SET 3: USDT Bridge (5 paths)
                    </h3>
                    <p style="color: #b8c6db; font-size: 0.9rem; margin-bottom: 15px;">ZAR paths via USDT intermediary</p>
                    <div style="display: grid; gap: 8px; font-family: monospace; font-size: 0.9rem;">
                        <div style="padding: 10px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                            1. <span style="color: #00ff88;">ZAR ‚Üí USDT ‚Üí BTC ‚Üí ZAR</span>
                        </div>
                        <div style="padding: 10px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                            2. <span style="color: #00ff88;">ZAR ‚Üí USDT ‚Üí ETH ‚Üí ZAR</span>
                        </div>
                        <div style="padding: 10px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                            3. <span style="color: #00ff88;">ZAR ‚Üí USDT ‚Üí XRP ‚Üí ZAR</span>
                        </div>
                        <div style="padding: 10px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                            4. <span style="color: #00ff88;">ZAR ‚Üí USDT ‚Üí SOL ‚Üí ZAR</span>
                        </div>
                        <div style="padding: 10px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                            5. <span style="color: #00ff88;">ZAR ‚Üí USDT ‚Üí ADA ‚Üí ZAR</span>
                        </div>
                    </div>
                </div>

                <!-- SET 4: SOL Bridge (3 paths) -->
                <div style="background: rgba(0,212,255,0.05); padding: 20px; border-radius: 12px; margin-bottom: 15px; border: 1px solid rgba(0,212,255,0.3);">
                    <h3 style="color: #00d4ff; margin-top: 0; font-size: 1.3rem;">
                        üî∑ SET 4: SOL Bridge (3 paths)
                    </h3>
                    <p style="color: #b8c6db; font-size: 0.9rem; margin-bottom: 15px;">Solana-focused triangular paths</p>
                    <div style="display: grid; gap: 8px; font-family: monospace; font-size: 0.9rem;">
                        <div style="padding: 10px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                            1. <span style="color: #00ff88;">ZAR ‚Üí SOL ‚Üí BTC ‚Üí ZAR</span>
                        </div>
                        <div style="padding: 10px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                            2. <span style="color: #00ff88;">ZAR ‚Üí SOL ‚Üí ETH ‚Üí ZAR</span>
                        </div>
                        <div style="padding: 10px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                            3. <span style="color: #00ff88;">ZAR ‚Üí SOL ‚Üí XRP ‚Üí ZAR</span>
                        </div>
                    </div>
                </div>

                <!-- SET 5: Altcoin Extended (3 paths) -->
                <div style="background: rgba(0,212,255,0.05); padding: 20px; border-radius: 12px; margin-bottom: 15px; border: 1px solid rgba(0,212,255,0.3);">
                    <h3 style="color: #00d4ff; margin-top: 0; font-size: 1.3rem;">
                        üî∑ SET 5: Altcoin Extended (3 paths)
                    </h3>
                    <p style="color: #b8c6db; font-size: 0.9rem; margin-bottom: 15px;">Additional altcoin paths</p>
                    <div style="display: grid; gap: 8px; font-family: monospace; font-size: 0.9rem;">
                        <div style="padding: 10px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                            1. <span style="color: #00ff88;">ZAR ‚Üí ADA ‚Üí BTC ‚Üí ZAR</span>
                        </div>
                        <div style="padding: 10px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                            2. <span style="color: #00ff88;">ZAR ‚Üí DOGE ‚Üí BTC ‚Üí ZAR</span>
                        </div>
                        <div style="padding: 10px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                            3. <span style="color: #00ff88;">ZAR ‚Üí DOT ‚Üí ETH ‚Üí ZAR</span>
                        </div>
                    </div>
                </div>

                <div style="background: rgba(255,152,0,0.1); padding: 15px; border-radius: 10px; margin-top: 20px; border-left: 4px solid #ff9800;">
                    <p style="margin: 0; color: #b8c6db; font-size: 0.9rem;">
                        üìù <strong style="color: #ff9800;">Note:</strong> These paths are currently ZAR-only.
                        ChainEX should also support USDT as a fundable currency (matching VALR/Luno pattern of 6 sets √ó 4 paths = 24 total).
                    </p>
                </div>
            `;

            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // Close on background click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });

            console.log('üìã [CHAINEX] Path details modal displayed');
        }

        // Clear ChainEX Triangular History
        async function clearChainExTriangularHistory() {
            console.log('üóëÔ∏è [CHAINEX] Clear history requested');
            if (!confirm('‚ö†Ô∏è Clear all ChainEX triangular trade history?\n\nThis action cannot be undone.')) {
                console.log('‚ùå [CHAINEX] Clear history cancelled by user');
                return;
            }

            try {
                console.log('üì° [CHAINEX] Sending delete request to backend...');
                const response = await fetch('/api/v1/trading/chainex/triangular/history', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                console.log('‚úÖ [CHAINEX] Delete response received:', result);

                if (result.success) {
                    console.log('‚úÖ [CHAINEX] History cleared, resetting UI stats...');
                    // Reset stats display
                    document.getElementById('chainexTotalTrades').textContent = '0';
                    document.getElementById('chainexSuccessfulTrades').textContent = '0';
                    document.getElementById('chainexSuccessRate').textContent = '0%';
                    document.getElementById('chainexTotalProfit').textContent = 'R 0.00';
                    document.getElementById('chainexBestPath').textContent = '-';
                    document.getElementById('chainexLastScan').textContent = 'Never';

                    // Clear recent trades display
                    document.getElementById('chainexRecentTrades').innerHTML =
                        '<div style="text-align: center; color: #888; padding: 20px;">No triangular trades yet. Enable live trading to start.</div>';

                    alert(`‚úÖ History cleared successfully!\n\nDeleted ${result.data.deletedCount} records.`);
                } else {
                    console.error('‚ùå [CHAINEX] Failed to clear history:', result.message);
                    alert(`‚ùå Failed to clear history: ${result.message || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('‚ùå [CHAINEX] Clear history error:', error);
                alert(`‚ùå Error: ${error.message}`);
            }
        }

        // Switch ChainEX tabs
        function switchChainExTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.chainex-tab-content').forEach(content => {
                content.style.display = 'none';
            });

            // Remove active class from all buttons and reset styling
            document.querySelectorAll('.chainex-tab-btn').forEach(btn => {
                btn.style.background = 'rgba(255,255,255,0.03)';
                btn.style.borderColor = 'transparent';
                btn.style.color = '#888';
                btn.classList.remove('active');
            });

            // Show selected tab content
            if (tabName === 'trades') {
                document.getElementById('chainexTabTrades').style.display = 'block';
            } else if (tabName === 'balance') {
                document.getElementById('chainexTabBalance').style.display = 'block';
            } else if (tabName === 'alerts') {
                document.getElementById('chainexTabAlerts').style.display = 'block';
            }

            // Highlight active button with enhanced styling
            const activeButton = document.querySelector(`.chainex-tab-btn[data-tab="${tabName}"]`);
            if (activeButton) {
                activeButton.style.background = 'rgba(255,152,0,0.15)';
                activeButton.style.borderColor = '#ff9800';
                activeButton.style.color = '#ff9800';
                activeButton.classList.add('active');
            }

            console.log(`üìë [CHAINEX] Switched to ${tabName} tab`);
        }

        // Reset ChainEX Starting Balance
        function resetChainExStartingBalance() {
            if (!confirm('‚ö†Ô∏è Reset ChainEX starting balance to current balance?\n\nThis will recalculate profit/loss from this point forward.')) {
                console.log('‚ùå [CHAINEX] Reset starting balance cancelled');
                return;
            }

            // Get current balances
            const currentZAR = document.getElementById('chainexCurrentZAR').textContent;
            const currentUSDT = document.getElementById('chainexCurrentUSDT').textContent;

            // Set as starting balances
            document.getElementById('chainexStartingZAR').textContent = currentZAR;
            document.getElementById('chainexStartingUSDT').textContent = currentUSDT;

            // Reset change to zero
            document.getElementById('chainexChangeZAR').textContent = '+R 0.00 (+0%)';
            document.getElementById('chainexChangeZAR').style.color = '#888';
            document.getElementById('chainexChangeUSDT').textContent = '+$0.00 (+0%)';
            document.getElementById('chainexChangeUSDT').style.color = '#888';

            // Save to localStorage
            localStorage.setItem('chainexStartingZAR', currentZAR);
            localStorage.setItem('chainexStartingUSDT', currentUSDT);

            // Update timestamp
            document.getElementById('chainexBalanceLastUpdate').textContent = new Date().toLocaleString();

            console.log('‚úÖ [CHAINEX] Starting balance reset successfully');
            alert('‚úÖ Starting balance reset successfully!');
        }

        // Clear ChainEX Alerts
        function clearChainExAlerts() {
            const alertsList = document.getElementById('chainexAlertsList');
            alertsList.innerHTML = '<div style="text-align: center; color: #888; padding: 20px;">No alerts. Worker running smoothly. ‚úÖ</div>';

            // Reset badge
            const badge = document.getElementById('chainexAlertBadge');
            badge.style.display = 'none';
            badge.textContent = '0';

            console.log('üóëÔ∏è [CHAINEX] Alerts cleared');
        }

        // Save ChainEX settings to localStorage
        function saveChainExTriangularSettings() {
            console.log('üíæ [CHAINEX] Saving settings to localStorage...');
            const settings = {
                maxTrade: document.getElementById('chainexMaxTrade').value,
                portfolioPercent: document.getElementById('chainexPortfolioPercent').value,
                profitThreshold: document.getElementById('chainexProfitThreshold').value
            };

            // Save path set states (6 sets for ChainEX)
            for (let i = 1; i <= 6; i++) {
                const checkbox = document.getElementById(`chainexSet${i}Enabled`);
                if (checkbox) {
                    settings[`set${i}Enabled`] = checkbox.checked;
                }
            }

            localStorage.setItem('chainexTriangularSettings', JSON.stringify(settings));
            console.log('‚úÖ [CHAINEX] Settings saved:', settings);
        }

        // Load ChainEX settings from localStorage
        function loadChainExTriangularSettings() {
            console.log('üíæ [CHAINEX] Loading settings from localStorage...');
            const savedSettings = localStorage.getItem('chainexTriangularSettings');
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);
                console.log('‚úÖ [CHAINEX] Settings loaded:', settings);

                if (settings.maxTrade) document.getElementById('chainexMaxTrade').value = settings.maxTrade;
                if (settings.portfolioPercent) document.getElementById('chainexPortfolioPercent').value = settings.portfolioPercent;
                if (settings.profitThreshold) document.getElementById('chainexProfitThreshold').value = settings.profitThreshold;

                // Load path set states (10 sets)
                for (let i = 1; i <= 10; i++) {
                    const checkbox = document.getElementById(`chainexSet${i}Enabled`);
                    if (checkbox && settings[`set${i}Enabled`] !== undefined) {
                        checkbox.checked = settings[`set${i}Enabled`];
                    }
                }
            } else {
                console.log('‚ÑπÔ∏è [CHAINEX] No saved settings found, using defaults');
            }
        }

        // Auto-save ChainEX settings when changed
        document.addEventListener('DOMContentLoaded', function() {
            // Add event listeners for ChainEX settings auto-save
            const chainexInputs = document.querySelectorAll('#chainexMaxTrade, #chainexPortfolioPercent, #chainexProfitThreshold');
            chainexInputs.forEach(input => {
                input.addEventListener('change', saveChainExTriangularSettings);
            });

            // Add event listeners for ChainEX checkboxes (6 sets)
            for (let i = 1; i <= 6; i++) {
                const checkbox = document.getElementById(`chainexSet${i}Enabled`);
                if (checkbox) {
                    checkbox.addEventListener('change', saveChainExTriangularSettings);
                }
            }
        });

        // ============================================================================
        // KRAKEN TRIANGULAR ARBITRAGE JAVASCRIPT
        // ============================================================================

        // Worker stats tracking
        let krakenWorkerStats = {
            totalScans: 0,
            totalOpportunities: 0,
            totalTrades: 0,
            successfulTrades: 0,
            totalProfit: 0,
            bestPath: null,
            bestProfit: 0
        };

        // Balance tracking (USD, USDT, USDC)
        let krakenBalanceTracking = {
            startingUSD: null,
            startingUSDT: null,
            startingUSDC: null,
            currentUSD: 0,
            currentUSDT: 0,
            currentUSDC: 0
        };

        // Alerts tracking
        let krakenAlerts = [];
        let krakenWorkerInterval = null;

        // Initialize Kraken balance on page load
        async function initializeKrakenBalance(apiKey, apiSecret) {
            try {
                // Fetch current balance from Kraken
                const response = await fetch('/api/v1/trading/kraken/balance', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ apiKey, apiSecret })
                });

                const result = await response.json();
                console.log('üí∞ [KRAKEN Balance] API Response:', result);

                if (result.success && result.data && result.data.balances) {
                    const balances = result.data.balances;
                    const currentUSD = balances.USD ? parseFloat(balances.USD) : 0;
                    const currentUSDT = balances.USDT ? parseFloat(balances.USDT) : 0;
                    const currentUSDC = balances.USDC ? parseFloat(balances.USDC) : 0;

                    // Check if starting balance is already set
                    const stored = localStorage.getItem('krakenStartingBalance');
                    if (stored) {
                        const parsed = JSON.parse(stored);
                        krakenBalanceTracking.startingUSD = parsed.usd;
                        krakenBalanceTracking.startingUSDT = parsed.usdt;
                        krakenBalanceTracking.startingUSDC = parsed.usdc;
                    } else {
                        // First time - set current as starting
                        krakenBalanceTracking.startingUSD = currentUSD;
                        krakenBalanceTracking.startingUSDT = currentUSDT;
                        krakenBalanceTracking.startingUSDC = currentUSDC;
                        localStorage.setItem('krakenStartingBalance', JSON.stringify({
                            usd: currentUSD,
                            usdt: currentUSDT,
                            usdc: currentUSDC
                        }));
                    }

                    krakenBalanceTracking.currentUSD = currentUSD;
                    krakenBalanceTracking.currentUSDT = currentUSDT;
                    krakenBalanceTracking.currentUSDC = currentUSDC;

                    updateKrakenBalanceDisplay();
                    console.log('‚úÖ [KRAKEN Balance] Initialized:', krakenBalanceTracking);
                }
            } catch (error) {
                console.error('‚ùå [KRAKEN Balance] Failed to initialize:', error);
            }
        }

        // Update Kraken balance
        async function updateKrakenBalance(apiKey, apiSecret) {
            try {
                const response = await fetch('/api/v1/trading/kraken/balance', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ apiKey, apiSecret })
                });

                const result = await response.json();

                if (result.success && result.data && result.data.balances) {
                    const balances = result.data.balances;
                    krakenBalanceTracking.currentUSD = balances.USD ? parseFloat(balances.USD) : 0;
                    krakenBalanceTracking.currentUSDT = balances.USDT ? parseFloat(balances.USDT) : 0;
                    krakenBalanceTracking.currentUSDC = balances.USDC ? parseFloat(balances.USDC) : 0;

                    updateKrakenBalanceDisplay();
                }
            } catch (error) {
                console.error('‚ùå [KRAKEN Balance] Update failed:', error);
            }
        }

        // Update Kraken balance display
        function updateKrakenBalanceDisplay() {
            // Update starting balances
            document.getElementById('krakenStartingUSD').textContent = `$${krakenBalanceTracking.startingUSD?.toFixed(2) || '0.00'}`;
            document.getElementById('krakenStartingUSDT').textContent = `$${krakenBalanceTracking.startingUSDT?.toFixed(2) || '0.00'}`;
            document.getElementById('krakenStartingUSDC').textContent = `$${krakenBalanceTracking.startingUSDC?.toFixed(2) || '0.00'}`;

            // Update current balances
            document.getElementById('krakenCurrentUSD').textContent = `$${krakenBalanceTracking.currentUSD.toFixed(2)}`;
            document.getElementById('krakenCurrentUSDT').textContent = `$${krakenBalanceTracking.currentUSDT.toFixed(2)}`;
            document.getElementById('krakenCurrentUSDC').textContent = `$${krakenBalanceTracking.currentUSDC.toFixed(2)}`;

            // Calculate and display changes for USD
            if (krakenBalanceTracking.startingUSD) {
                const usdChange = krakenBalanceTracking.currentUSD - krakenBalanceTracking.startingUSD;
                const usdChangePercent = (usdChange / krakenBalanceTracking.startingUSD * 100).toFixed(2);
                const usdColor = usdChange >= 0 ? '#00ff00' : '#ff4444';
                const usdSign = usdChange >= 0 ? '+' : '';
                document.getElementById('krakenChangeUSD').innerHTML = `<span style="color: ${usdColor}">${usdSign}$${usdChange.toFixed(2)} (${usdSign}${usdChangePercent}%)</span>`;
            }

            // Calculate and display changes for USDT
            if (krakenBalanceTracking.startingUSDT) {
                const usdtChange = krakenBalanceTracking.currentUSDT - krakenBalanceTracking.startingUSDT;
                const usdtChangePercent = (usdtChange / krakenBalanceTracking.startingUSDT * 100).toFixed(2);
                const usdtColor = usdtChange >= 0 ? '#00ff00' : '#ff4444';
                const usdtSign = usdtChange >= 0 ? '+' : '';
                document.getElementById('krakenChangeUSDT').innerHTML = `<span style="color: ${usdtColor}">${usdtSign}$${usdtChange.toFixed(2)} (${usdtSign}${usdtChangePercent}%)</span>`;
            }

            // Calculate and display changes for USDC
            if (krakenBalanceTracking.startingUSDC) {
                const usdcChange = krakenBalanceTracking.currentUSDC - krakenBalanceTracking.startingUSDC;
                const usdcChangePercent = (usdcChange / krakenBalanceTracking.startingUSDC * 100).toFixed(2);
                const usdcColor = usdcChange >= 0 ? '#00ff00' : '#ff4444';
                const usdcSign = usdcChange >= 0 ? '+' : '';
                document.getElementById('krakenChangeUSDC').innerHTML = `<span style="color: ${usdcColor}">${usdcSign}$${usdcChange.toFixed(2)} (${usdcSign}${usdcChangePercent}%)</span>`;
            }

            // Update last updated time
            document.getElementById('krakenBalanceLastUpdate').textContent = new Date().toLocaleTimeString();
        }

        // Start Kraken automated worker
        async function startKrakenWorker() {
            console.log('üöÄ [KRAKEN Worker] Starting automated scanning...');

            const apiKey = localStorage.getItem('kraken_triangular_api');
            const apiSecret = localStorage.getItem('kraken_triangular_secret');

            if (!apiKey || !apiSecret) {
                console.error('‚ùå [KRAKEN Worker] Missing credentials');
                return;
            }

            // Initialize balance tracking
            await initializeKrakenBalance(apiKey, apiSecret);

            // Scan every 30 seconds (Kraken has stricter rate limits)
            krakenWorkerInterval = setInterval(async () => {
                try {
                    console.log('üîç [KRAKEN Worker] Scanning for opportunities...');

                    // Get enabled sets
                    const enabledSets = [];
                    for (let i = 1; i <= 10; i++) {
                        const checkbox = document.getElementById(`krakenSet${i}Enabled`);
                        if (checkbox && checkbox.checked) {
                            enabledSets.push(i);
                        }
                    }

                    if (enabledSets.length === 0) {
                        console.warn('‚ö†Ô∏è [KRAKEN Worker] No path sets enabled');
                        return;
                    }

                    // Get risk settings from UI
                    const maxTradeAmount = parseFloat(document.getElementById('krakenMaxTrade')?.value || 100);
                    const profitThreshold = parseFloat(document.getElementById('krakenProfitThreshold')?.value || 0.5);
                    const portfolioPercent = parseFloat(document.getElementById('krakenPortfolioPercent')?.value || 10);

                    // Get current balances (from balance tracking)
                    const currentBalanceUSD = krakenBalanceTracking.currentUSD || 0;
                    const currentBalanceUSDT = krakenBalanceTracking.currentUSDT || 0;
                    const currentBalanceUSDC = krakenBalanceTracking.currentUSDC || 0;

                    // Scan for opportunities
                    const response = await fetch('/api/v1/trading/kraken/triangular/scan', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            apiKey,
                            apiSecret,
                            paths: enabledSets,
                            maxTradeAmount: maxTradeAmount,
                            profitThreshold: profitThreshold,
                            portfolioPercent: portfolioPercent,
                            currentBalanceUSD: currentBalanceUSD,
                            currentBalanceUSDT: currentBalanceUSDT,
                            currentBalanceUSDC: currentBalanceUSDC
                        })
                    });

                    const result = await response.json();

                    if (result.success && result.data) {
                        krakenWorkerStats.totalScans++;
                        const opps = result.data.opportunities || [];
                        krakenWorkerStats.totalOpportunities += opps.length;

                        console.log(`‚úÖ [KRAKEN Worker] Scan complete: ${opps.length} opportunities found`);

                        // Log portfolio calculation details
                        if (result.data?.portfolioCalculation) {
                            const calc = result.data.portfolioCalculation;
                            console.log(`üí∞ [KRAKEN Portfolio] USD: $${calc.balanceUSD}, USDT: $${calc.balanceUSDT}, USDC: $${calc.balanceUSDC}`);
                            console.log(`üí∞ [KRAKEN Portfolio] ${calc.portfolioPercent}% = $${calc.portfolioAmount}, Cap: ${calc.appliedCap}, Can Trade: ${calc.canTrade}`);
                        }

                        // Display warnings (non-blocking)
                        if (result.data?.warnings && result.data.warnings.length > 0) {
                            result.data.warnings.forEach(warning => {
                                console.warn(`‚ö†Ô∏è [KRAKEN Portfolio] ${warning}`);
                            });
                        }

                        // Update balance
                        await updateKrakenBalance(apiKey, apiSecret);
                    }
                } catch (error) {
                    console.error('‚ùå [KRAKEN Worker] Scan error:', error);
                }
            }, 30000); // 30 seconds

            console.log('‚úÖ [KRAKEN Worker] Started (scanning every 30 seconds)');
        }

        // Stop Kraken automated worker
        function stopKrakenWorker() {
            if (krakenWorkerInterval) {
                clearInterval(krakenWorkerInterval);
                krakenWorkerInterval = null;
                console.log('üõë [KRAKEN Worker] Stopped');
            }
        }

        // Toggle for Kraken Triangular trading
        document.getElementById('krakenTriangularEnabled').addEventListener('click', async function() {
            console.log('üîÑ [KRAKEN] Toggle clicked');

            const willBeActive = !this.classList.contains('active');
            const status = document.getElementById('krakenTriangularStatus');

            if (willBeActive) {
                // Check if credentials are configured before enabling
                const apiKey = localStorage.getItem('kraken_triangular_api');
                const apiSecret = localStorage.getItem('kraken_triangular_secret');

                if (!apiKey || !apiSecret) {
                    alert('‚ö†Ô∏è Please configure Kraken API credentials in Strategic API Configuration first!');
                    return; // Don't toggle
                }

                // Check if at least one path set is selected
                let hasSelectedPaths = false;
                for (let i = 1; i <= 10; i++) {
                    const checkbox = document.getElementById(`krakenSet${i}Enabled`);
                    if (checkbox && checkbox.checked) {
                        hasSelectedPaths = true;
                        break;
                    }
                }

                if (!hasSelectedPaths) {
                    alert('‚ö†Ô∏è Please select at least one path set before enabling live trading!');
                    return; // Don't toggle
                }

                console.log('‚úÖ [KRAKEN] Live trading enabled');
                this.classList.add('active');
                status.textContent = 'ON';
                status.style.color = '#9966ff';
                localStorage.setItem('krakenTriangularEnabled', 'true');

                // Start automated worker
                await startKrakenWorker();

                console.log('‚úÖ KRAKEN automated trading started! Worker scanning every 30 seconds.');
            } else {
                console.log('‚ùå [KRAKEN] Live trading disabled');

                // Stop automated worker
                stopKrakenWorker();

                this.classList.remove('active');
                status.textContent = 'OFF';
                status.style.color = '#ff6b6b';
                localStorage.setItem('krakenTriangularEnabled', 'false');
                console.log('KRAKEN automated trading stopped');
            }
        });

        // Load saved Kraken toggle state on page load
        document.addEventListener('DOMContentLoaded', async function() {
            const krakenEnabled = localStorage.getItem('krakenTriangularEnabled') === 'true';
            const toggle = document.getElementById('krakenTriangularEnabled');
            const status = document.getElementById('krakenTriangularStatus');

            // Initialize balance display if credentials exist (regardless of worker state)
            const apiKey = localStorage.getItem('kraken_triangular_api');
            const apiSecret = localStorage.getItem('kraken_triangular_secret');

            if (apiKey && apiSecret) {
                console.log('üí∞ [KRAKEN Balance] Fetching balance on page load...');
                await initializeKrakenBalance(apiKey, apiSecret);
            }

            if (krakenEnabled) {
                toggle.classList.add('active');
                status.textContent = 'ON';
                status.style.color = '#9966ff';

                // Auto-start worker if toggle was left ON
                if (apiKey && apiSecret) {
                    console.log('üîÑ [KRAKEN] Auto-starting worker from saved state...');
                    await startKrakenWorker();
                }
            }

            // Load Kraken settings
            loadKrakenTriangularSettings();
        });

        // Test Kraken Triangular Connection
        async function testKrakenTriangularConnection() {
            console.log('üîç [KRAKEN] Testing connection...');
            try {
                // Get credentials from localStorage (saved from strategy-api-setup.html)
                const apiKey = localStorage.getItem('kraken_triangular_api');
                const apiSecret = localStorage.getItem('kraken_triangular_secret');
                console.log('üîë [KRAKEN] API credentials retrieved from localStorage');

                if (!apiKey || !apiSecret) {
                    console.warn('‚ö†Ô∏è [KRAKEN] Missing API credentials');
                    alert('‚ùå Please set up your Kraken API credentials first in the Strategy API Setup page.');
                    return;
                }

                // Show loading message
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '‚è≥ Testing...';
                btn.disabled = true;

                // Call backend test-connection route
                console.log('üì° [KRAKEN] Sending test connection request to backend...');
                const response = await fetch('/api/v1/trading/kraken/triangular/test-connection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        apiKey: apiKey,
                        apiSecret: apiSecret
                    })
                });

                const result = await response.json();
                console.log('‚úÖ [KRAKEN] Test connection response received:', result);

                btn.textContent = originalText;
                btn.disabled = false;

                if (result.success) {
                    console.log('‚úÖ [KRAKEN] Connection successful!', result.data);
                    alert(`‚úÖ Kraken Connection Successful!\n\n` +
                          `‚Ä¢ Authenticated: ${result.data.authenticated ? 'Yes' : 'No'}\n` +
                          `‚Ä¢ Balance Access: ${result.data.balanceAccess ? 'Yes' : 'No'}\n` +
                          `‚Ä¢ Available Pairs: ${result.data.availablePairs}\n` +
                          `‚Ä¢ Required Pairs: ${result.data.requiredPairs}\n` +
                          `‚Ä¢ Triangular Ready: ${result.data.triangularReady ? 'Yes' : 'No'}`);
                } else {
                    console.error('‚ùå [KRAKEN] Connection failed:', result.message);
                    alert(`‚ùå Connection Failed: ${result.message || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('‚ùå [KRAKEN] Connection error:', error);
                alert(`‚ùå Connection Error: ${error.message}`);
            }
        }

        // Scan Kraken Triangular Paths
        async function scanKrakenTriangularPaths() {
            console.log('üîç [KRAKEN] Starting path scan...');
            try {
                const apiKey = localStorage.getItem('kraken_triangular_api');
                const apiSecret = localStorage.getItem('kraken_triangular_secret');

                if (!apiKey || !apiSecret) {
                    console.warn('‚ö†Ô∏è [KRAKEN] Missing API credentials');
                    alert('‚ùå Please set up your Kraken API credentials first.');
                    return;
                }

                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '‚è≥ Scanning...';
                btn.disabled = true;

                // Get enabled path sets
                const enabledSets = [];
                for (let i = 1; i <= 10; i++) {
                    const checkbox = document.getElementById(`krakenSet${i}Enabled`);
                    if (checkbox && checkbox.checked) {
                        enabledSets.push(i);
                    }
                }
                console.log('üìä [KRAKEN] Enabled path sets:', enabledSets);

                console.log('üì° [KRAKEN] Sending scan request to backend...');
                const response = await fetch('/api/v1/trading/kraken/triangular/scan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        apiKey: apiKey,
                        apiSecret: apiSecret,
                        paths: enabledSets.length > 0 ? enabledSets : 'all'
                    })
                });

                const result = await response.json();
                console.log('‚úÖ [KRAKEN] Scan response received:', result);

                btn.textContent = originalText;
                btn.disabled = false;

                if (result.success) {
                    document.getElementById('krakenLastScan').textContent = new Date().toLocaleTimeString();
                    console.log(`‚úÖ [KRAKEN] Scan successful! Found ${result.data.opportunities.length} opportunities`);

                    let message = `‚úÖ Scan Complete!\n\n`;
                    message += `‚Ä¢ Paths Scanned: ${result.data.scannedPaths}\n`;
                    message += `‚Ä¢ Path Sets: ${result.data.pathSetsScanned}\n`;
                    message += `‚Ä¢ Opportunities Found: ${result.data.opportunities.length}\n\n`;
                    message += `${result.data.message || 'Full scanning implementation coming soon!'}`;

                    alert(message);
                } else {
                    console.error('‚ùå [KRAKEN] Scan failed:', result.message);
                    alert(`‚ùå Scan Failed: ${result.message || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('‚ùå [KRAKEN] Scan error:', error);
                alert(`‚ùå Scan Error: ${error.message}`);
            }
        }

        // View Kraken Path Details - Custom Modal
        function viewKrakenPathDetails() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                backdrop-filter: blur(5px);
            `;

            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
                padding: 30px;
                border-radius: 15px;
                max-width: 900px;
                max-height: 80vh;
                overflow-y: auto;
                box-shadow: 0 20px 60px rgba(153,102,255, 0.3);
                border: 2px solid #9966ff;
            `;

            modalContent.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                    <h2 style="color: #9966ff; margin: 0; font-size: 1.8rem;">
                        üìã KRAKEN Triangular Arbitrage Paths
                    </h2>
                    <button onclick="this.closest('[style*=\\'position: fixed\\']').remove()"
                            style="background: rgba(255,0,0,0.2); border: 1px solid #ff4444; color: #ff4444;
                                   padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 1.2rem;">
                        ‚úï
                    </button>
                </div>

                <div style="background: rgba(153,102,255,0.1); padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #9966ff;">
                    <p style="margin: 0; color: #b8c6db; font-size: 0.95rem;">
                        üí° <strong style="color: #9966ff;">114 Total Paths</strong> across 10 sets.
                        üåç International exchange with USD/USDT/USDC support. Each altcoin has BTC+ETH bridges with forward/reverse paths.
                    </p>
                </div>

                <!-- SET 1: ETH Focus (6 paths) -->
                <div style="background: rgba(153,102,255,0.05); padding: 20px; border-radius: 12px; margin-bottom: 15px; border: 1px solid rgba(153,102,255,0.3);">
                    <h3 style="color: #9966ff; margin-top: 0; font-size: 1.3rem;">
                        üî∑ SET 1: ETH Focus (6 paths) ‚úÖ DEFAULT
                    </h3>
                    <p style="color: #b8c6db; font-size: 0.9rem; margin-bottom: 15px;">BTC bridge only (ETH is target)</p>
                    <div style="display: grid; gap: 8px; font-family: monospace; font-size: 0.9rem;">
                        <div style="padding: 10px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                            1. <span style="color: #00ff88;">USD ‚Üí BTC ‚Üí ETH ‚Üí USD</span>
                        </div>
                        <div style="padding: 10px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                            2. <span style="color: #00ff88;">USD ‚Üí ETH ‚Üí BTC ‚Üí USD</span>
                        </div>
                        <div style="padding: 10px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                            3. <span style="color: #00ff88;">USDT ‚Üí BTC ‚Üí ETH ‚Üí USDT</span>
                        </div>
                        <div style="padding: 10px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                            4. <span style="color: #00ff88;">USDT ‚Üí ETH ‚Üí BTC ‚Üí USDT</span>
                        </div>
                        <div style="padding: 10px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                            5. <span style="color: #00ff88;">USDC ‚Üí BTC ‚Üí ETH ‚Üí USDC</span>
                        </div>
                        <div style="padding: 10px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                            6. <span style="color: #00ff88;">USDC ‚Üí ETH ‚Üí BTC ‚Üí USDC</span>
                        </div>
                    </div>
                </div>

                <!-- SET 2: XRP Focus (12 paths) -->
                <div style="background: rgba(153,102,255,0.05); padding: 20px; border-radius: 12px; margin-bottom: 15px; border: 1px solid rgba(153,102,255,0.3);">
                    <h3 style="color: #9966ff; margin-top: 0; font-size: 1.3rem;">
                        üî∑ SET 2: XRP Focus (12 paths) ‚úÖ DEFAULT
                    </h3>
                    <p style="color: #b8c6db; font-size: 0.9rem; margin-bottom: 15px;">Ripple paths via BTC+ETH bridges</p>
                    <div style="display: grid; gap: 8px; font-family: monospace; font-size: 0.85rem;">
                        <div style="padding: 8px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                            <strong style="color: #ffd700;">BTC Bridge:</strong>
                        </div>
                        <div style="padding: 8px; background: rgba(0,0,0,0.3); border-radius: 6px; margin-left: 15px;">
                            1. USD ‚Üí BTC ‚Üí XRP ‚Üí USD &nbsp;|&nbsp; 2. USD ‚Üí XRP ‚Üí BTC ‚Üí USD
                        </div>
                        <div style="padding: 8px; background: rgba(0,0,0,0.3); border-radius: 6px; margin-left: 15px;">
                            3. USDT ‚Üí BTC ‚Üí XRP ‚Üí USDT &nbsp;|&nbsp; 4. USDT ‚Üí XRP ‚Üí BTC ‚Üí USDT
                        </div>
                        <div style="padding: 8px; background: rgba(0,0,0,0.3); border-radius: 6px; margin-left: 15px;">
                            5. USDC ‚Üí BTC ‚Üí XRP ‚Üí USDC &nbsp;|&nbsp; 6. USDC ‚Üí XRP ‚Üí BTC ‚Üí USDC
                        </div>
                        <div style="padding: 8px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                            <strong style="color: #ffd700;">ETH Bridge:</strong>
                        </div>
                        <div style="padding: 8px; background: rgba(0,0,0,0.3); border-radius: 6px; margin-left: 15px;">
                            7. USD ‚Üí ETH ‚Üí XRP ‚Üí USD &nbsp;|&nbsp; 8. USD ‚Üí XRP ‚Üí ETH ‚Üí USD
                        </div>
                        <div style="padding: 8px; background: rgba(0,0,0,0.3); border-radius: 6px; margin-left: 15px;">
                            9. USDT ‚Üí ETH ‚Üí XRP ‚Üí USDT &nbsp;|&nbsp; 10. USDT ‚Üí XRP ‚Üí ETH ‚Üí USDT
                        </div>
                        <div style="padding: 8px; background: rgba(0,0,0,0.3); border-radius: 6px; margin-left: 15px;">
                            11. USDC ‚Üí ETH ‚Üí XRP ‚Üí USDC &nbsp;|&nbsp; 12. USDC ‚Üí XRP ‚Üí ETH ‚Üí USDC
                        </div>
                    </div>
                </div>

                <!-- SET 3: SOL Focus (12 paths) -->
                <div style="background: rgba(153,102,255,0.05); padding: 20px; border-radius: 12px; margin-bottom: 15px; border: 1px solid rgba(153,102,255,0.3);">
                    <h3 style="color: #9966ff; margin-top: 0; font-size: 1.3rem;">
                        üî∑ SET 3: SOL Focus (12 paths) ‚úÖ DEFAULT
                    </h3>
                    <p style="color: #b8c6db; font-size: 0.9rem; margin-bottom: 15px;">Solana paths via BTC+ETH bridges</p>
                    <div style="display: grid; gap: 6px; font-family: monospace; font-size: 0.8rem;">
                        <div style="padding: 6px; background: rgba(0,0,0,0.3); border-radius: 4px;">
                            <strong style="color: #ffd700;">BTC:</strong> USD‚ÜíBTC‚ÜíSOL‚ÜíUSD | USD‚ÜíSOL‚ÜíBTC‚ÜíUSD | USDT‚ÜíBTC‚ÜíSOL‚ÜíUSDT | USDT‚ÜíSOL‚ÜíBTC‚ÜíUSDT | USDC‚ÜíBTC‚ÜíSOL‚ÜíUSDC | USDC‚ÜíSOL‚ÜíBTC‚ÜíUSDC
                        </div>
                        <div style="padding: 6px; background: rgba(0,0,0,0.3); border-radius: 4px;">
                            <strong style="color: #ffd700;">ETH:</strong> USD‚ÜíETH‚ÜíSOL‚ÜíUSD | USD‚ÜíSOL‚ÜíETH‚ÜíUSD | USDT‚ÜíETH‚ÜíSOL‚ÜíUSDT | USDT‚ÜíSOL‚ÜíETH‚ÜíUSDT | USDC‚ÜíETH‚ÜíSOL‚ÜíUSDC | USDC‚ÜíSOL‚ÜíETH‚ÜíUSDC
                        </div>
                    </div>
                </div>

                <!-- SET 4: ADA Focus (12 paths) -->
                <div style="background: rgba(153,102,255,0.05); padding: 20px; border-radius: 12px; margin-bottom: 15px; border: 1px solid rgba(153,102,255,0.3);">
                    <h3 style="color: #9966ff; margin-top: 0; font-size: 1.3rem;">
                        üî∑ SET 4: ADA Focus (12 paths)
                    </h3>
                    <p style="color: #b8c6db; font-size: 0.9rem; margin-bottom: 15px;">Cardano paths via BTC+ETH bridges</p>
                    <div style="display: grid; gap: 6px; font-family: monospace; font-size: 0.8rem;">
                        <div style="padding: 6px; background: rgba(0,0,0,0.3); border-radius: 4px;">
                            <strong style="color: #ffd700;">BTC:</strong> USD‚ÜíBTC‚ÜíADA‚ÜíUSD | USD‚ÜíADA‚ÜíBTC‚ÜíUSD | USDT‚ÜíBTC‚ÜíADA‚ÜíUSDT | USDT‚ÜíADA‚ÜíBTC‚ÜíUSDT | USDC‚ÜíBTC‚ÜíADA‚ÜíUSDC | USDC‚ÜíADA‚ÜíBTC‚ÜíUSDC
                        </div>
                        <div style="padding: 6px; background: rgba(0,0,0,0.3); border-radius: 4px;">
                            <strong style="color: #ffd700;">ETH:</strong> USD‚ÜíETH‚ÜíADA‚ÜíUSD | USD‚ÜíADA‚ÜíETH‚ÜíUSD | USDT‚ÜíETH‚ÜíADA‚ÜíUSDT | USDT‚ÜíADA‚ÜíETH‚ÜíUSDT | USDC‚ÜíETH‚ÜíADA‚ÜíUSDC | USDC‚ÜíADA‚ÜíETH‚ÜíUSDC
                        </div>
                    </div>
                </div>

                <!-- SET 5: DOT Focus (12 paths) -->
                <div style="background: rgba(153,102,255,0.05); padding: 20px; border-radius: 12px; margin-bottom: 15px; border: 1px solid rgba(153,102,255,0.3);">
                    <h3 style="color: #9966ff; margin-top: 0; font-size: 1.3rem;">
                        üî∑ SET 5: DOT Focus (12 paths)
                    </h3>
                    <p style="color: #b8c6db; font-size: 0.9rem; margin-bottom: 15px;">Polkadot paths via BTC+ETH bridges</p>
                    <div style="display: grid; gap: 6px; font-family: monospace; font-size: 0.8rem;">
                        <div style="padding: 6px; background: rgba(0,0,0,0.3); border-radius: 4px;">
                            <strong style="color: #ffd700;">BTC:</strong> USD‚ÜíBTC‚ÜíDOT‚ÜíUSD | USD‚ÜíDOT‚ÜíBTC‚ÜíUSD | USDT‚ÜíBTC‚ÜíDOT‚ÜíUSDT | USDT‚ÜíDOT‚ÜíBTC‚ÜíUSDT | USDC‚ÜíBTC‚ÜíDOT‚ÜíUSDC | USDC‚ÜíDOT‚ÜíBTC‚ÜíUSDC
                        </div>
                        <div style="padding: 6px; background: rgba(0,0,0,0.3); border-radius: 4px;">
                            <strong style="color: #ffd700;">ETH:</strong> USD‚ÜíETH‚ÜíDOT‚ÜíUSD | USD‚ÜíDOT‚ÜíETH‚ÜíUSD | USDT‚ÜíETH‚ÜíDOT‚ÜíUSDT | USDT‚ÜíDOT‚ÜíETH‚ÜíUSDT | USDC‚ÜíETH‚ÜíDOT‚ÜíUSDC | USDC‚ÜíDOT‚ÜíETH‚ÜíUSDC
                        </div>
                    </div>
                </div>

                <!-- SET 6: MATIC Focus (12 paths) -->
                <div style="background: rgba(153,102,255,0.05); padding: 20px; border-radius: 12px; margin-bottom: 15px; border: 1px solid rgba(153,102,255,0.3);">
                    <h3 style="color: #9966ff; margin-top: 0; font-size: 1.3rem;">
                        üî∑ SET 6: MATIC Focus (12 paths)
                    </h3>
                    <p style="color: #b8c6db; font-size: 0.9rem; margin-bottom: 15px;">Polygon paths via BTC+ETH bridges</p>
                    <div style="display: grid; gap: 6px; font-family: monospace; font-size: 0.8rem;">
                        <div style="padding: 6px; background: rgba(0,0,0,0.3); border-radius: 4px;">
                            <strong style="color: #ffd700;">BTC:</strong> USD‚ÜíBTC‚ÜíMATIC‚ÜíUSD | USD‚ÜíMATIC‚ÜíBTC‚ÜíUSD | USDT‚ÜíBTC‚ÜíMATIC‚ÜíUSDT | USDT‚ÜíMATIC‚ÜíBTC‚ÜíUSDT | USDC‚ÜíBTC‚ÜíMATIC‚ÜíUSDC | USDC‚ÜíMATIC‚ÜíBTC‚ÜíUSDC
                        </div>
                        <div style="padding: 6px; background: rgba(0,0,0,0.3); border-radius: 4px;">
                            <strong style="color: #ffd700;">ETH:</strong> USD‚ÜíETH‚ÜíMATIC‚ÜíUSD | USD‚ÜíMATIC‚ÜíETH‚ÜíUSD | USDT‚ÜíETH‚ÜíMATIC‚ÜíUSDT | USDT‚ÜíMATIC‚ÜíETH‚ÜíUSDT | USDC‚ÜíETH‚ÜíMATIC‚ÜíUSDC | USDC‚ÜíMATIC‚ÜíETH‚ÜíUSDC
                        </div>
                    </div>
                </div>

                <!-- SET 7: LINK Focus (12 paths) -->
                <div style="background: rgba(153,102,255,0.05); padding: 20px; border-radius: 12px; margin-bottom: 15px; border: 1px solid rgba(153,102,255,0.3);">
                    <h3 style="color: #9966ff; margin-top: 0; font-size: 1.3rem;">
                        üî∑ SET 7: LINK Focus (12 paths)
                    </h3>
                    <p style="color: #b8c6db; font-size: 0.9rem; margin-bottom: 15px;">Chainlink paths via BTC+ETH bridges</p>
                    <div style="display: grid; gap: 6px; font-family: monospace; font-size: 0.8rem;">
                        <div style="padding: 6px; background: rgba(0,0,0,0.3); border-radius: 4px;">
                            <strong style="color: #ffd700;">BTC:</strong> USD‚ÜíBTC‚ÜíLINK‚ÜíUSD | USD‚ÜíLINK‚ÜíBTC‚ÜíUSD | USDT‚ÜíBTC‚ÜíLINK‚ÜíUSDT | USDT‚ÜíLINK‚ÜíBTC‚ÜíUSDT | USDC‚ÜíBTC‚ÜíLINK‚ÜíUSDC | USDC‚ÜíLINK‚ÜíBTC‚ÜíUSDC
                        </div>
                        <div style="padding: 6px; background: rgba(0,0,0,0.3); border-radius: 4px;">
                            <strong style="color: #ffd700;">ETH:</strong> USD‚ÜíETH‚ÜíLINK‚ÜíUSD | USD‚ÜíLINK‚ÜíETH‚ÜíUSD | USDT‚ÜíETH‚ÜíLINK‚ÜíUSDT | USDT‚ÜíLINK‚ÜíETH‚ÜíUSDT | USDC‚ÜíETH‚ÜíLINK‚ÜíUSDC | USDC‚ÜíLINK‚ÜíETH‚ÜíUSDC
                        </div>
                    </div>
                </div>

                <!-- SET 8: LTC Focus (12 paths) -->
                <div style="background: rgba(153,102,255,0.05); padding: 20px; border-radius: 12px; margin-bottom: 15px; border: 1px solid rgba(153,102,255,0.3);">
                    <h3 style="color: #9966ff; margin-top: 0; font-size: 1.3rem;">
                        üî∑ SET 8: LTC Focus (12 paths)
                    </h3>
                    <p style="color: #b8c6db; font-size: 0.9rem; margin-bottom: 15px;">Litecoin paths via BTC+ETH bridges</p>
                    <div style="display: grid; gap: 6px; font-family: monospace; font-size: 0.8rem;">
                        <div style="padding: 6px; background: rgba(0,0,0,0.3); border-radius: 4px;">
                            <strong style="color: #ffd700;">BTC:</strong> USD‚ÜíBTC‚ÜíLTC‚ÜíUSD | USD‚ÜíLTC‚ÜíBTC‚ÜíUSD | USDT‚ÜíBTC‚ÜíLTC‚ÜíUSDT | USDT‚ÜíLTC‚ÜíBTC‚ÜíUSDT | USDC‚ÜíBTC‚ÜíLTC‚ÜíUSDC | USDC‚ÜíLTC‚ÜíBTC‚ÜíUSDC
                        </div>
                        <div style="padding: 6px; background: rgba(0,0,0,0.3); border-radius: 4px;">
                            <strong style="color: #ffd700;">ETH:</strong> USD‚ÜíETH‚ÜíLTC‚ÜíUSD | USD‚ÜíLTC‚ÜíETH‚ÜíUSD | USDT‚ÜíETH‚ÜíLTC‚ÜíUSDT | USDT‚ÜíLTC‚ÜíETH‚ÜíUSDT | USDC‚ÜíETH‚ÜíLTC‚ÜíUSDC | USDC‚ÜíLTC‚ÜíETH‚ÜíUSDC
                        </div>
                    </div>
                </div>

                <!-- SET 9: ATOM Focus (12 paths) -->
                <div style="background: rgba(153,102,255,0.05); padding: 20px; border-radius: 12px; margin-bottom: 15px; border: 1px solid rgba(153,102,255,0.3);">
                    <h3 style="color: #9966ff; margin-top: 0; font-size: 1.3rem;">
                        üî∑ SET 9: ATOM Focus (12 paths)
                    </h3>
                    <p style="color: #b8c6db; font-size: 0.9rem; margin-bottom: 15px;">Cosmos paths via BTC+ETH bridges</p>
                    <div style="display: grid; gap: 6px; font-family: monospace; font-size: 0.8rem;">
                        <div style="padding: 6px; background: rgba(0,0,0,0.3); border-radius: 4px;">
                            <strong style="color: #ffd700;">BTC:</strong> USD‚ÜíBTC‚ÜíATOM‚ÜíUSD | USD‚ÜíATOM‚ÜíBTC‚ÜíUSD | USDT‚ÜíBTC‚ÜíATOM‚ÜíUSDT | USDT‚ÜíATOM‚ÜíBTC‚ÜíUSDT | USDC‚ÜíBTC‚ÜíATOM‚ÜíUSDC | USDC‚ÜíATOM‚ÜíBTC‚ÜíUSDC
                        </div>
                        <div style="padding: 6px; background: rgba(0,0,0,0.3); border-radius: 4px;">
                            <strong style="color: #ffd700;">ETH:</strong> USD‚ÜíETH‚ÜíATOM‚ÜíUSD | USD‚ÜíATOM‚ÜíETH‚ÜíUSD | USDT‚ÜíETH‚ÜíATOM‚ÜíUSDT | USDT‚ÜíATOM‚ÜíETH‚ÜíUSDT | USDC‚ÜíETH‚ÜíATOM‚ÜíUSDC | USDC‚ÜíATOM‚ÜíETH‚ÜíUSDC
                        </div>
                    </div>
                </div>

                <!-- SET 10: AVAX Focus (12 paths) -->
                <div style="background: rgba(153,102,255,0.05); padding: 20px; border-radius: 12px; margin-bottom: 15px; border: 1px solid rgba(153,102,255,0.3);">
                    <h3 style="color: #9966ff; margin-top: 0; font-size: 1.3rem;">
                        üî∑ SET 10: AVAX Focus (12 paths)
                    </h3>
                    <p style="color: #b8c6db; font-size: 0.9rem; margin-bottom: 15px;">Avalanche paths via BTC+ETH bridges</p>
                    <div style="display: grid; gap: 6px; font-family: monospace; font-size: 0.8rem;">
                        <div style="padding: 6px; background: rgba(0,0,0,0.3); border-radius: 4px;">
                            <strong style="color: #ffd700;">BTC:</strong> USD‚ÜíBTC‚ÜíAVAX‚ÜíUSD | USD‚ÜíAVAX‚ÜíBTC‚ÜíUSD | USDT‚ÜíBTC‚ÜíAVAX‚ÜíUSDT | USDT‚ÜíAVAX‚ÜíBTC‚ÜíUSDT | USDC‚ÜíBTC‚ÜíAVAX‚ÜíUSDC | USDC‚ÜíAVAX‚ÜíBTC‚ÜíUSDC
                        </div>
                        <div style="padding: 6px; background: rgba(0,0,0,0.3); border-radius: 4px;">
                            <strong style="color: #ffd700;">ETH:</strong> USD‚ÜíETH‚ÜíAVAX‚ÜíUSD | USD‚ÜíAVAX‚ÜíETH‚ÜíUSD | USDT‚ÜíETH‚ÜíAVAX‚ÜíUSDT | USDT‚ÜíAVAX‚ÜíETH‚ÜíUSDT | USDC‚ÜíETH‚ÜíAVAX‚ÜíUSDC | USDC‚ÜíAVAX‚ÜíETH‚ÜíUSDC
                        </div>
                    </div>
                </div>

                <div style="background: rgba(0,212,255,0.1); padding: 15px; border-radius: 10px; margin-top: 20px; border-left: 4px solid #00d4ff;">
                    <p style="margin: 0; color: #b8c6db; font-size: 0.9rem;">
                        <strong style="color: #00d4ff;">üí° Path Pattern:</strong> Each SET (except ETH) has 12 paths:
                        <br>‚Ä¢ 6 via BTC bridge (3 currencies √ó 2 directions)
                        <br>‚Ä¢ 6 via ETH bridge (3 currencies √ó 2 directions)
                        <br>‚Ä¢ Covers all funding options: USD, USDT, USDC
                    </p>
                </div>
            `;

            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // Close on background click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });

            console.log('üìã [KRAKEN] Path details modal displayed');
        }

        // Clear Kraken Triangular History
        async function clearKrakenTriangularHistory() {
            console.log('üóëÔ∏è [KRAKEN] Clear history requested');
            if (!confirm('‚ö†Ô∏è Clear all Kraken triangular trade history?\n\nThis action cannot be undone.')) {
                console.log('‚ùå [KRAKEN] Clear history cancelled by user');
                return;
            }

            try {
                console.log('üì° [KRAKEN] Sending delete request to backend...');
                const response = await fetch('/api/v1/trading/kraken/triangular/history', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                console.log('‚úÖ [KRAKEN] Delete response received:', result);

                if (result.success) {
                    console.log('‚úÖ [KRAKEN] History cleared, resetting UI stats...');
                    // Reset stats display
                    document.getElementById('krakenTotalTrades').textContent = '0';
                    document.getElementById('krakenSuccessfulTrades').textContent = '0';
                    document.getElementById('krakenSuccessRate').textContent = '0%';
                    document.getElementById('krakenTotalProfit').textContent = '$0.00';
                    document.getElementById('krakenBestPath').textContent = '-';
                    document.getElementById('krakenLastScan').textContent = 'Never';

                    // Clear recent trades display
                    document.getElementById('krakenRecentTrades').innerHTML =
                        '<div style="text-align: center; color: #888; padding: 20px;">No triangular trades yet. Enable live trading to start.</div>';

                    alert(`‚úÖ History cleared successfully!\n\nDeleted ${result.data.deletedCount} records.`);
                } else {
                    console.error('‚ùå [KRAKEN] Failed to clear history:', result.message);
                    alert(`‚ùå Failed to clear history: ${result.message || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('‚ùå [KRAKEN] Clear history error:', error);
                alert(`‚ùå Error: ${error.message}`);
            }
        }

        // Save Kraken settings to localStorage
        function saveKrakenTriangularSettings() {
            console.log('üíæ [KRAKEN] Saving settings to localStorage...');
            const settings = {
                maxTrade: document.getElementById('krakenMaxTrade').value,
                portfolioPercent: document.getElementById('krakenPortfolioPercent').value,
                profitThreshold: document.getElementById('krakenProfitThreshold').value
            };

            // Save path set states (10 sets for Kraken)
            for (let i = 1; i <= 10; i++) {
                const checkbox = document.getElementById(`krakenSet${i}Enabled`);
                if (checkbox) {
                    settings[`set${i}Enabled`] = checkbox.checked;
                }
            }

            localStorage.setItem('krakenTriangularSettings', JSON.stringify(settings));
            console.log('‚úÖ [KRAKEN] Settings saved:', settings);
        }

        // Load Kraken settings from localStorage
        function loadKrakenTriangularSettings() {
            console.log('üíæ [KRAKEN] Loading settings from localStorage...');
            const savedSettings = localStorage.getItem('krakenTriangularSettings');
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);
                console.log('‚úÖ [KRAKEN] Settings loaded:', settings);

                if (settings.maxTrade) document.getElementById('krakenMaxTrade').value = settings.maxTrade;
                if (settings.portfolioPercent) document.getElementById('krakenPortfolioPercent').value = settings.portfolioPercent;
                if (settings.profitThreshold) document.getElementById('krakenProfitThreshold').value = settings.profitThreshold;

                // Load path set states (10 sets)
                for (let i = 1; i <= 10; i++) {
                    const checkbox = document.getElementById(`krakenSet${i}Enabled`);
                    if (checkbox && settings[`set${i}Enabled`] !== undefined) {
                        checkbox.checked = settings[`set${i}Enabled`];
                    }
                }
            } else {
                console.log('‚ÑπÔ∏è [KRAKEN] No saved settings found, using defaults');
            }
        }

        // Auto-save Kraken settings when changed
        document.addEventListener('DOMContentLoaded', function() {
            // Add event listeners for Kraken settings auto-save
            const krakenInputs = document.querySelectorAll('#krakenMaxTrade, #krakenPortfolioPercent, #krakenProfitThreshold');
            krakenInputs.forEach(input => {
                input.addEventListener('change', saveKrakenTriangularSettings);
            });

            // Add event listeners for Kraken checkboxes (10 sets)
            for (let i = 1; i <= 10; i++) {
                const checkbox = document.getElementById(`krakenSet${i}Enabled`);
                if (checkbox) {
                    checkbox.addEventListener('change', saveKrakenTriangularSettings);
                }
            }
        });

        // ============================================================================
        // KRAKEN TAB SWITCHING & HELPER FUNCTIONS
        // ============================================================================

        /**
         * Switch between Kraken tabs (Trades, Balance, Alerts)
         */
        function switchKrakenTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.kraken-tab-content').forEach(tab => {
                tab.style.display = 'none';
            });

            // Remove active state from all buttons
            document.querySelectorAll('.kraken-tab-btn').forEach(btn => {
                btn.style.background = 'rgba(255,255,255,0.03)';
                btn.style.border = '1px solid transparent';
                btn.style.color = '#888';
            });

            // Show selected tab content
            const tabContent = document.getElementById(`krakenTab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`);
            if (tabContent) {
                tabContent.style.display = 'block';
            }

            // Activate selected button
            const activeBtn = document.querySelector(`.kraken-tab-btn[data-tab="${tabName}"]`);
            if (activeBtn) {
                activeBtn.style.background = 'rgba(153,102,255,0.15)';
                activeBtn.style.border = '1px solid #9966ff';
                activeBtn.style.color = '#9966ff';
            }

            console.log(`üîÑ [KRAKEN] Switched to ${tabName} tab`);
        }

        /**
         * Reset Kraken starting balance to current balance
         */
        function resetKrakenStartingBalance() {
            const confirm = window.confirm('Reset starting balance to current balance?\n\nThis will use the current balance as the new baseline for profit/loss tracking.');

            if (!confirm) return;

            // Get current balances
            const currentUSD = document.getElementById('krakenCurrentUSD').textContent;
            const currentUSDT = document.getElementById('krakenCurrentUSDT').textContent;
            const currentUSDC = document.getElementById('krakenCurrentUSDC').textContent;

            // Set as starting balances
            document.getElementById('krakenStartingUSD').textContent = currentUSD;
            document.getElementById('krakenStartingUSDT').textContent = currentUSDT;
            document.getElementById('krakenStartingUSDC').textContent = currentUSDC;

            // Reset change indicators
            document.getElementById('krakenChangeUSD').textContent = '+$0.00 (+0%)';
            document.getElementById('krakenChangeUSD').style.color = '#888';
            document.getElementById('krakenChangeUSDT').textContent = '+$0.00 (+0%)';
            document.getElementById('krakenChangeUSDT').style.color = '#888';
            document.getElementById('krakenChangeUSDC').textContent = '+$0.00 (+0%)';
            document.getElementById('krakenChangeUSDC').style.color = '#888';

            // Save to localStorage
            const balanceData = {
                startingUSD: currentUSD,
                startingUSDT: currentUSDT,
                startingUSDC: currentUSDC,
                resetTime: new Date().toISOString()
            };
            localStorage.setItem('krakenBalanceBaseline', JSON.stringify(balanceData));

            console.log('‚úÖ [KRAKEN] Starting balance reset', balanceData);

            // Show confirmation
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #9966ff 0%, #7744cc 100%);
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 10000;
                font-weight: bold;
            `;
            notification.textContent = '‚úÖ Starting balance reset successfully';
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.5s';
                setTimeout(() => notification.remove(), 500);
            }, 2000);
        }

        /**
         * Clear all Kraken alerts
         */
        function clearKrakenAlerts() {
            const alertsList = document.getElementById('krakenAlertsList');
            alertsList.innerHTML = `
                <div style="text-align: center; color: #888; padding: 20px;">
                    No alerts. Worker running smoothly. ‚úÖ
                </div>
            `;

            // Reset badge
            const badge = document.getElementById('krakenAlertBadge');
            if (badge) {
                badge.style.display = 'none';
                badge.textContent = '0';
            }

            console.log('üßπ [KRAKEN] Alerts cleared');
        }

        // ============================================================================
        // BYBIT TRIANGULAR ARBITRAGE JAVASCRIPT
        // ============================================================================

        // Tab Switcher for Balance Tracker / Recent Trades
        function switchBybitTab(tab) {
            const balanceTab = document.getElementById('bybitBalanceTab');
            const tradesTab = document.getElementById('bybitTradesTab');
            const balanceContent = document.getElementById('bybitBalanceContent');
            const tradesContent = document.getElementById('bybitTradesContent');

            if (tab === 'balance') {
                // Activate Balance tab
                balanceTab.style.background = 'rgba(255,165,0,0.3)';
                balanceTab.style.color = '#FFA500';
                balanceTab.style.fontWeight = 'bold';
                tradesTab.style.background = 'rgba(255,255,255,0.05)';
                tradesTab.style.color = '#b8c6db';
                tradesTab.style.fontWeight = 'normal';

                balanceContent.style.display = 'block';
                tradesContent.style.display = 'none';
            } else {
                // Activate Trades tab
                tradesTab.style.background = 'rgba(255,165,0,0.3)';
                tradesTab.style.color = '#FFA500';
                tradesTab.style.fontWeight = 'bold';
                balanceTab.style.background = 'rgba(255,255,255,0.05)';
                balanceTab.style.color = '#b8c6db';
                balanceTab.style.fontWeight = 'normal';

                tradesContent.style.display = 'block';
                balanceContent.style.display = 'none';
            }
        }

        // Worker Infrastructure
        let bybitWorkerStats = {
            totalScans: 0,
            totalOpportunities: 0,
            totalTrades: 0,
            successfulTrades: 0,
            totalProfit: 0,
            bestPath: null,
            bestProfit: 0
        };

        let bybitBalanceTracking = {
            startingUSDT: null,
            currentUSDT: 0
        };

        let bybitWorkerInterval = null;
        let bybitWorkerRunning = false;

        // Binance Worker Variables
        let binanceWorkerStats = {
            totalScans: 0,
            totalOpportunities: 0,
            lastScanTime: null
        };
        let binanceWorkerInterval = null;
        let binanceWorkerRunning = false;
        let binanceBalanceTracking = {
            startingUSDT: null,
            currentUSDT: 0
        };

        // OKX Worker Variables
        let okxWorkerStats = {
            totalScans: 0,
            totalOpportunities: 0,
            lastScanTime: null
        };
        let okxWorkerInterval = null;
        let okxWorkerRunning = false;
        let okxBalanceTracking = {
            startingUSDT: null,
            currentUSDT: 0
        };

        // Initialize ByBit balance on page load or worker start
        async function initializeBybitBalance(apiKey, apiSecret) {
            try {
                console.log('üí∞ [BYBIT Balance] Initializing balance tracking...');

                // Fetch current balance from ByBit
                const response = await fetch('/api/v1/trading/bybit/balance', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ apiKey, apiSecret })
                });

                const result = await response.json();

                if (result.success && result.data && result.data.balances) {
                    const balances = result.data.balances;
                    bybitBalanceTracking.currentUSDT = parseFloat(balances.USDT || 0);

                    // Set starting balance if first time
                    const savedStarting = localStorage.getItem('bybitStartingUSDT');
                    if (!savedStarting) {
                        bybitBalanceTracking.startingUSDT = bybitBalanceTracking.currentUSDT;
                        localStorage.setItem('bybitStartingUSDT', bybitBalanceTracking.startingUSDT.toString());
                        console.log(`üí∞ [BYBIT Balance] Starting USDT set: $${bybitBalanceTracking.startingUSDT.toFixed(2)}`);
                    } else {
                        bybitBalanceTracking.startingUSDT = parseFloat(savedStarting);
                        console.log(`üí∞ [BYBIT Balance] Starting USDT loaded: $${bybitBalanceTracking.startingUSDT.toFixed(2)}`);
                    }

                    updateBybitBalanceDisplay();
                } else {
                    console.error('‚ùå [BYBIT Balance] Failed to fetch balance:', result);
                }
            } catch (error) {
                console.error('‚ùå [BYBIT Balance] Error initializing:', error);
            }
        }

        // Update ByBit balance
        async function updateBybitBalance(apiKey, apiSecret) {
            try {
                const response = await fetch('/api/v1/trading/bybit/balance', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ apiKey, apiSecret })
                });

                const result = await response.json();

                if (result.success && result.data && result.data.balances) {
                    const balances = result.data.balances;
                    bybitBalanceTracking.currentUSDT = parseFloat(balances.USDT || 0);
                    updateBybitBalanceDisplay();
                }
            } catch (error) {
                console.error('‚ùå [BYBIT Balance] Error updating:', error);
            }
        }

        // Update ByBit balance display
        function updateBybitBalanceDisplay() {
            const starting = bybitBalanceTracking.startingUSDT || 0;
            const current = bybitBalanceTracking.currentUSDT || 0;
            const change = current - starting;
            const changePercent = starting > 0 ? ((change / starting) * 100) : 0;

            // Update USDT display
            document.getElementById('bybitStartingUSDT').textContent = `$${starting.toFixed(2)}`;
            document.getElementById('bybitCurrentUSDT').textContent = `$${current.toFixed(2)}`;

            const changeColor = change >= 0 ? '#00ff88' : '#ff6b6b';
            const changeSign = change >= 0 ? '+' : '';
            document.getElementById('bybitChangeUSDT').innerHTML = `
                <span style="color: ${changeColor};">${changeSign}$${change.toFixed(2)} (${changeSign}${changePercent.toFixed(2)}%)</span>
            `;
        }

        // ============================================================
        // BINANCE TAB SWITCHING & BALANCE TRACKING
        // ============================================================

        // Switch between Binance tabs
        function switchBinanceTab(tab) {
            const balanceTab = document.getElementById('binanceBalanceTab');
            const tradesTab = document.getElementById('binanceTradesTab');
            const balanceContent = document.getElementById('binanceBalanceContent');
            const tradesContent = document.getElementById('binanceTradesContent');

            if (tab === 'balance') {
                // Activate Balance tab
                balanceTab.style.background = 'rgba(240,185,11,0.3)';
                balanceTab.style.color = '#F0B90B';
                balanceTab.style.fontWeight = 'bold';
                tradesTab.style.background = 'rgba(255,255,255,0.05)';
                tradesTab.style.color = '#b8c6db';
                tradesTab.style.fontWeight = 'normal';

                balanceContent.style.display = 'block';
                tradesContent.style.display = 'none';
            } else {
                // Activate Trades tab
                tradesTab.style.background = 'rgba(240,185,11,0.3)';
                tradesTab.style.color = '#F0B90B';
                tradesTab.style.fontWeight = 'bold';
                balanceTab.style.background = 'rgba(255,255,255,0.05)';
                balanceTab.style.color = '#b8c6db';
                balanceTab.style.fontWeight = 'normal';

                balanceContent.style.display = 'none';
                tradesContent.style.display = 'block';
            }
        }

        // Initialize Binance balance on page load or worker start
        async function initializeBinanceBalance(apiKey, apiSecret) {
            try {
                console.log('üí∞ [BINANCE Balance] Initializing balance tracking...');

                const response = await fetch('/api/v1/trading/binance/balance', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ apiKey, apiSecret })
                });

                const result = await response.json();

                if (result.success && result.data && result.data.balances) {
                    const balances = result.data.balances;
                    binanceBalanceTracking.currentUSDT = parseFloat(balances.USDT || 0);

                    // Set starting balance if first time
                    const savedStarting = localStorage.getItem('binanceStartingUSDT');
                    if (!savedStarting) {
                        binanceBalanceTracking.startingUSDT = binanceBalanceTracking.currentUSDT;
                        localStorage.setItem('binanceStartingUSDT', binanceBalanceTracking.startingUSDT.toString());
                        console.log(`üí∞ [BINANCE Balance] Starting USDT set: $${binanceBalanceTracking.startingUSDT.toFixed(2)}`);
                    } else {
                        binanceBalanceTracking.startingUSDT = parseFloat(savedStarting);
                        console.log(`üí∞ [BINANCE Balance] Starting USDT loaded: $${binanceBalanceTracking.startingUSDT.toFixed(2)}`);
                    }

                    updateBinanceBalanceDisplay();
                } else {
                    console.error('‚ùå [BINANCE Balance] Failed to fetch balance:', result);
                }
            } catch (error) {
                console.error('‚ùå [BINANCE Balance] Error initializing:', error);
            }
        }

        // Update Binance balance
        async function updateBinanceBalance(apiKey, apiSecret) {
            try {
                const response = await fetch('/api/v1/trading/binance/balance', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ apiKey, apiSecret })
                });

                const result = await response.json();

                if (result.success && result.data && result.data.balances) {
                    const balances = result.data.balances;
                    binanceBalanceTracking.currentUSDT = parseFloat(balances.USDT || 0);
                    updateBinanceBalanceDisplay();
                }
            } catch (error) {
                console.error('‚ùå [BINANCE Balance] Error updating:', error);
            }
        }

        // Update Binance balance display
        function updateBinanceBalanceDisplay() {
            const starting = binanceBalanceTracking.startingUSDT || 0;
            const current = binanceBalanceTracking.currentUSDT || 0;
            const change = current - starting;
            const changePercent = starting > 0 ? ((change / starting) * 100) : 0;

            // Update USDT display
            document.getElementById('binanceStartingUSDT').textContent = `$${starting.toFixed(2)}`;
            document.getElementById('binanceCurrentUSDT').textContent = `$${current.toFixed(2)}`;

            const changeColor = change >= 0 ? '#00ff88' : '#ff6b6b';
            const changeSign = change >= 0 ? '+' : '';
            document.getElementById('binanceChangeUSDT').innerHTML = `
                <span style="color: ${changeColor};">${changeSign}$${change.toFixed(2)} (${changeSign}${changePercent.toFixed(2)}%)</span>
            `;
        }

        // ============================================================
        // OKX TAB SWITCHING & BALANCE TRACKING
        // ============================================================

        // Switch between OKX tabs
        function switchOKXTab(tab) {
            const balanceTab = document.getElementById('okxBalanceTab');
            const tradesTab = document.getElementById('okxTradesTab');
            const balanceContent = document.getElementById('okxBalanceContent');
            const tradesContent = document.getElementById('okxTradesContent');

            if (tab === 'balance') {
                // Activate Balance tab
                balanceTab.style.background = 'rgba(0,166,255,0.3)';
                balanceTab.style.color = '#00A6FF';
                balanceTab.style.fontWeight = 'bold';
                tradesTab.style.background = 'rgba(255,255,255,0.05)';
                tradesTab.style.color = '#b8c6db';
                tradesTab.style.fontWeight = 'normal';

                balanceContent.style.display = 'block';
                tradesContent.style.display = 'none';
            } else {
                // Activate Trades tab
                tradesTab.style.background = 'rgba(0,166,255,0.3)';
                tradesTab.style.color = '#00A6FF';
                tradesTab.style.fontWeight = 'bold';
                balanceTab.style.background = 'rgba(255,255,255,0.05)';
                balanceTab.style.color = '#b8c6db';
                balanceTab.style.fontWeight = 'normal';

                balanceContent.style.display = 'none';
                tradesContent.style.display = 'block';
            }
        }

        // Initialize OKX balance on page load or worker start
        async function initializeOKXBalance(apiKey, apiSecret, passphrase) {
            try {
                console.log('üí∞ [OKX Balance] Initializing balance tracking...');

                const response = await fetch('/api/v1/trading/okx/balance', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ apiKey, apiSecret, passphrase })
                });

                const result = await response.json();

                if (result.success && result.data && result.data.balances) {
                    const balances = result.data.balances;
                    okxBalanceTracking.currentUSDT = parseFloat(balances.USDT || 0);

                    // Set starting balance if first time
                    const savedStarting = localStorage.getItem('okxStartingUSDT');
                    if (!savedStarting) {
                        okxBalanceTracking.startingUSDT = okxBalanceTracking.currentUSDT;
                        localStorage.setItem('okxStartingUSDT', okxBalanceTracking.startingUSDT.toString());
                        console.log(`üí∞ [OKX Balance] Starting USDT set: $${okxBalanceTracking.startingUSDT.toFixed(2)}`);
                    } else {
                        okxBalanceTracking.startingUSDT = parseFloat(savedStarting);
                        console.log(`üí∞ [OKX Balance] Starting USDT loaded: $${okxBalanceTracking.startingUSDT.toFixed(2)}`);
                    }

                    updateOKXBalanceDisplay();
                } else {
                    console.error('‚ùå [OKX Balance] Failed to fetch balance:', result);
                }
            } catch (error) {
                console.error('‚ùå [OKX Balance] Error initializing:', error);
            }
        }

        // Update OKX balance
        async function updateOKXBalance(apiKey, apiSecret, passphrase) {
            try {
                const response = await fetch('/api/v1/trading/okx/balance', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ apiKey, apiSecret, passphrase })
                });

                const result = await response.json();

                if (result.success && result.data && result.data.balances) {
                    const balances = result.data.balances;
                    okxBalanceTracking.currentUSDT = parseFloat(balances.USDT || 0);
                    updateOKXBalanceDisplay();
                }
            } catch (error) {
                console.error('‚ùå [OKX Balance] Error updating:', error);
            }
        }

        // Update OKX balance display
        function updateOKXBalanceDisplay() {
            const starting = okxBalanceTracking.startingUSDT || 0;
            const current = okxBalanceTracking.currentUSDT || 0;
            const change = current - starting;
            const changePercent = starting > 0 ? ((change / starting) * 100) : 0;

            // Update USDT display
            document.getElementById('okxStartingUSDT').textContent = `$${starting.toFixed(2)}`;
            document.getElementById('okxCurrentUSDT').textContent = `$${current.toFixed(2)}`;

            const changeColor = change >= 0 ? '#00ff88' : '#ff6b6b';
            const changeSign = change >= 0 ? '+' : '';
            document.getElementById('okxChangeUSDT').innerHTML = `
                <span style="color: ${changeColor};">${changeSign}$${change.toFixed(2)} (${changeSign}${changePercent.toFixed(2)}%)</span>
            `;
        }

        // Scan a single ByBit set
        async function scanBybitSet(apiKey, apiSecret, setNumber) {
            try {
                console.log(`üîç [BYBIT Worker] Scanning SET_${setNumber}...`);

                // Get risk settings from UI
                const maxTradeAmount = parseFloat(document.getElementById('bybitMaxTrade')?.value || 100);
                const profitThreshold = parseFloat(document.getElementById('bybitProfitThreshold')?.value || 0.5);
                const portfolioPercent = parseFloat(document.getElementById('bybitPortfolioPercent')?.value || 10);

                // Get current balance (from balance tracking)
                const currentBalance = bybitBalanceTracking.currentUSDT || 0;

                // Scan for opportunities for this specific set
                const response = await fetch('/api/v1/trading/bybit/triangular/scan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        apiKey,
                        apiSecret,
                        paths: [setNumber],  // Scan only this set
                        maxTradeAmount: maxTradeAmount,
                        profitThreshold: profitThreshold,
                        portfolioPercent: portfolioPercent,
                        currentBalance: currentBalance
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`‚ùå [BYBIT Worker] SET_${setNumber} API error (${response.status}):`, errorText);
                    return;
                }

                const result = await response.json();

                if (result.success) {
                    const oppCount = result.data?.opportunities?.length || 0;
                    bybitWorkerStats.totalOpportunities += oppCount;

                    console.log(`‚úÖ [BYBIT Worker] SET_${setNumber} complete: ${oppCount} opportunities found`);

                    // Log portfolio calculation details
                    if (result.data?.portfolioCalculation) {
                        const calc = result.data.portfolioCalculation;
                        console.log(`üí∞ [BYBIT Portfolio] Balance: $${calc.balance}, ${calc.portfolioPercent}% = $${calc.portfolioAmount}, Cap: ${calc.appliedCap}, Can Trade: ${calc.canTrade}`);
                    }

                    // Display warnings (non-blocking)
                    if (result.data?.warnings && result.data.warnings.length > 0) {
                        result.data.warnings.forEach(warning => {
                            console.warn(`‚ö†Ô∏è [BYBIT Portfolio] ${warning}`);
                        });
                    }

                    if (oppCount > 0) {
                        console.log(`üí∞ [BYBIT Worker] SET_${setNumber} Opportunities:`, result.data.opportunities);
                    }
                } else {
                    console.warn(`‚ö†Ô∏è [BYBIT Worker] SET_${setNumber} unsuccessful:`, result.message || 'Unknown error');
                }

            } catch (error) {
                console.error(`‚ùå [BYBIT Worker] SET_${setNumber} scan error:`, error);
            }
        }

        // Sequential scanning cycle through all enabled sets
        async function performBybitSequentialScan(apiKey, apiSecret) {
            // Check if worker was stopped
            if (!bybitWorkerRunning) {
                console.log('‚èπÔ∏è [BYBIT Worker] Scan cycle aborted - worker stopped');
                return;
            }

            bybitWorkerStats.totalScans++;
            console.log(`\nüîÑ [BYBIT Worker] ‚ïê‚ïê‚ïê Scan Cycle #${bybitWorkerStats.totalScans} Starting ‚ïê‚ïê‚ïê`);

            // Get enabled path sets
            const enabledSets = [];
            for (let i = 1; i <= 5; i++) {
                const checkbox = document.getElementById(`bybitSet${i}Enabled`);
                if (checkbox && checkbox.checked) {
                    enabledSets.push(i);
                }
            }

            if (enabledSets.length === 0) {
                console.warn('‚ö†Ô∏è [BYBIT Worker] No path sets enabled');
                return;
            }

            console.log(`üìã [BYBIT Worker] Enabled sets: [${enabledSets.join(', ')}] - Scanning sequentially...`);

            // Scan each enabled set with 5-second delay between sets
            for (let i = 0; i < enabledSets.length; i++) {
                // Check if worker was stopped before each set
                if (!bybitWorkerRunning) {
                    console.log('‚èπÔ∏è [BYBIT Worker] Scan cycle aborted mid-cycle - worker stopped');
                    return;
                }

                const setNumber = enabledSets[i];
                await scanBybitSet(apiKey, apiSecret, setNumber);

                // Wait 5 seconds before next set (except after last set)
                if (i < enabledSets.length - 1) {
                    console.log(`‚è≥ [BYBIT Worker] Waiting 5 seconds before next set...`);
                    await new Promise(resolve => setTimeout(resolve, 5000));
                }
            }

            // Update balance after completing all sets
            await updateBybitBalance(apiKey, apiSecret);

            document.getElementById('bybitLastScan').textContent = new Date().toLocaleTimeString();
            console.log(`‚úÖ [BYBIT Worker] ‚ïê‚ïê‚ïê Scan Cycle #${bybitWorkerStats.totalScans} Complete ‚ïê‚ïê‚ïê\n`);
        }

        // Start ByBit automated worker (sequential scanning)
        async function startBybitWorker() {
            bybitWorkerRunning = true;  // Enable worker flag
            console.log('üîÑ [BYBIT Worker] Starting sequential scanning...');

            const apiKey = localStorage.getItem('bybit_triangular_api');
            const apiSecret = localStorage.getItem('bybit_triangular_secret');

            if (!apiKey || !apiSecret) {
                console.error('‚ùå [BYBIT Worker] Missing API credentials');
                return;
            }

            // Initialize balance tracking
            await initializeBybitBalance(apiKey, apiSecret);

            // Perform immediate first scan cycle
            console.log('üöÄ [BYBIT Worker] Performing immediate first scan cycle...');
            await performBybitSequentialScan(apiKey, apiSecret);

            // Continue scanning cycles every 30 seconds
            bybitWorkerInterval = setInterval(async () => {
                await performBybitSequentialScan(apiKey, apiSecret);
            }, 30000); // 30 seconds between cycles

            console.log('‚úÖ [BYBIT Worker] Sequential scanning started (cycles every 30s, 5s delay between sets)');
        }

        // Stop ByBit automated worker
        function stopBybitWorker() {
            bybitWorkerRunning = false;  // Disable worker flag to abort any running scan
            if (bybitWorkerInterval) {
                clearInterval(bybitWorkerInterval);
                bybitWorkerInterval = null;
                console.log('‚èπÔ∏è [BYBIT Worker] Automated scanning stopped');
            }
        }

        // Toggle for ByBit Triangular trading
        document.getElementById('bybitTriangularEnabled').addEventListener('click', async function() {
            console.log('üîÑ [BYBIT] Toggle clicked');

            const isCurrentlyActive = this.classList.contains('active');
            const status = document.getElementById('bybitTriangularStatus');

            if (!isCurrentlyActive) {
                // Enabling - validate credentials first
                const apiKey = localStorage.getItem('bybit_triangular_api');
                const apiSecret = localStorage.getItem('bybit_triangular_secret');

                if (!apiKey || !apiSecret) {
                    console.warn('‚ö†Ô∏è [BYBIT] Missing API credentials');
                    alert('‚ùå Please set up your ByBit API credentials first in the Strategy API Setup page.');
                    return;
                }

                // Validate at least one path set is enabled
                const enabledSets = [];
                for (let i = 1; i <= 5; i++) {
                    const checkbox = document.getElementById(`bybitSet${i}Enabled`);
                    if (checkbox && checkbox.checked) {
                        enabledSets.push(i);
                    }
                }

                if (enabledSets.length === 0) {
                    console.warn('‚ö†Ô∏è [BYBIT] No path sets enabled');
                    alert('‚ùå Please enable at least one path set before starting automated trading.');
                    return;
                }

                console.log('‚úÖ [BYBIT] Live trading enabled');
                this.classList.add('active');
                status.textContent = 'ON';
                status.style.color = '#FFA500';
                localStorage.setItem('bybitTriangularEnabled', 'true');

                // Start the worker
                await startBybitWorker();
            } else {
                // Disabling
                console.log('‚ùå [BYBIT] Live trading disabled');
                this.classList.remove('active');
                status.textContent = 'OFF';
                status.style.color = '#ff6b6b';
                localStorage.setItem('bybitTriangularEnabled', 'false');

                // Stop the worker
                stopBybitWorker();
            }
        });

        // Load saved ByBit toggle state on page load
        document.addEventListener('DOMContentLoaded', async function() {
            const bybitEnabled = localStorage.getItem('bybitTriangularEnabled') === 'true';
            const toggle = document.getElementById('bybitTriangularEnabled');
            const status = document.getElementById('bybitTriangularStatus');

            // Load ByBit settings first
            loadByBitTriangularSettings();

            // Initialize balance if credentials exist
            const apiKey = localStorage.getItem('bybit_triangular_api');
            const apiSecret = localStorage.getItem('bybit_triangular_secret');

            if (apiKey && apiSecret) {
                console.log('üí∞ [BYBIT] Initializing balance on page load...');
                await initializeBybitBalance(apiKey, apiSecret);
            }

            // Restore toggle state and auto-start worker if previously enabled
            if (bybitEnabled) {
                toggle.classList.add('active');
                status.textContent = 'ON';
                status.style.color = '#FFA500';

                // Auto-start worker if credentials exist and at least one path set is enabled
                if (apiKey && apiSecret) {
                    const enabledSets = [];
                    for (let i = 1; i <= 5; i++) {
                        const checkbox = document.getElementById(`bybitSet${i}Enabled`);
                        if (checkbox && checkbox.checked) {
                            enabledSets.push(i);
                        }
                    }

                    if (enabledSets.length > 0) {
                        console.log('üöÄ [BYBIT] Auto-starting worker from previous session...');
                        await startBybitWorker();
                    } else {
                        console.warn('‚ö†Ô∏è [BYBIT] Toggle was ON but no path sets enabled - not starting worker');
                    }
                }
            }
        });

        // Test ByBit Triangular Connection
        async function testByBitTriangularConnection() {
            console.log('üîç [BYBIT] Testing connection...');
            try {
                // Get credentials from localStorage (saved from strategy-api-setup.html)
                const apiKey = localStorage.getItem('bybit_triangular_api');
                const apiSecret = localStorage.getItem('bybit_triangular_secret');
                console.log('üîë [BYBIT] API credentials retrieved from localStorage');

                if (!apiKey || !apiSecret) {
                    console.warn('‚ö†Ô∏è [BYBIT] Missing API credentials');
                    alert('‚ùå Please set up your ByBit API credentials first in the Strategy API Setup page.');
                    return;
                }

                // Show loading message
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '‚è≥ Testing...';
                btn.disabled = true;

                // Call backend test-connection route
                console.log('üì° [BYBIT] Sending test connection request to backend...');
                const response = await fetch('/api/v1/trading/bybit/triangular/test-connection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        apiKey: apiKey,
                        apiSecret: apiSecret
                    })
                });

                const result = await response.json();
                console.log('‚úÖ [BYBIT] Test connection response received:', result);

                btn.textContent = originalText;
                btn.disabled = false;

                if (result.success) {
                    console.log('‚úÖ [BYBIT] Connection successful!', result.data);
                    alert(`‚úÖ ByBit Connection Successful!\n\n` +
                          `‚Ä¢ Authenticated: ${result.data.authenticated ? 'Yes' : 'No'}\n` +
                          `‚Ä¢ Balance Access: ${result.data.balanceAccess ? 'Yes' : 'No'}\n` +
                          `‚Ä¢ Available Pairs: ${result.data.availablePairs}\n` +
                          `‚Ä¢ Required Pairs: ${result.data.requiredPairs}\n` +
                          `‚Ä¢ Triangular Ready: ${result.data.triangularReady ? 'Yes' : 'No'}`);
                } else {
                    console.error('‚ùå [BYBIT] Connection failed:', result.message);
                    alert(`‚ùå Connection Failed: ${result.message || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('‚ùå [BYBIT] Connection error:', error);
                alert(`‚ùå Connection Error: ${error.message}`);
            }
        }

        // Scan ByBit Triangular Paths
        async function scanByBitTriangularPaths() {
            console.log('üîç [BYBIT] Starting path scan...');
            try {
                const apiKey = localStorage.getItem('bybit_triangular_api');
                const apiSecret = localStorage.getItem('bybit_triangular_secret');

                if (!apiKey || !apiSecret) {
                    console.warn('‚ö†Ô∏è [BYBIT] Missing API credentials');
                    alert('‚ùå Please set up your ByBit API credentials first.');
                    return;
                }

                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '‚è≥ Scanning...';
                btn.disabled = true;

                // Get enabled path sets
                const enabledSets = [];
                for (let i = 1; i <= 5; i++) {
                    const checkbox = document.getElementById(`bybitSet${i}Enabled`);
                    if (checkbox && checkbox.checked) {
                        enabledSets.push(i);
                    }
                }
                console.log('üìä [BYBIT] Enabled path sets:', enabledSets);

                console.log('üì° [BYBIT] Sending scan request to backend...');
                const response = await fetch('/api/v1/trading/bybit/triangular/scan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        apiKey: apiKey,
                        apiSecret: apiSecret,
                        paths: enabledSets.length > 0 ? enabledSets : 'all'
                    })
                });

                const result = await response.json();
                console.log('‚úÖ [BYBIT] Scan response received:', result);

                btn.textContent = originalText;
                btn.disabled = false;

                if (result.success) {
                    document.getElementById('bybitLastScan').textContent = new Date().toLocaleTimeString();
                    console.log(`‚úÖ [BYBIT] Scan successful! Found ${result.data.opportunities.length} opportunities`);

                    let message = `‚úÖ Scan Complete!\n\n`;
                    message += `‚Ä¢ Paths Scanned: ${result.data.scannedPaths}\n`;
                    message += `‚Ä¢ Path Sets: ${result.data.pathSetsScanned}\n`;
                    message += `‚Ä¢ Opportunities Found: ${result.data.opportunities.length}\n\n`;
                    message += `${result.data.message || 'Full scanning implementation coming soon!'}`;

                    alert(message);
                } else {
                    console.error('‚ùå [BYBIT] Scan failed:', result.message);
                    alert(`‚ùå Scan Failed: ${result.message || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('‚ùå [BYBIT] Scan error:', error);
                alert(`‚ùå Scan Error: ${error.message}`);
            }
        }

        // View ByBit Path Details
        // View ByBit Path Details (Modal)
        function viewByBitPathDetails() {
            console.log('üìã [BYBIT] Opening paths modal');

            // Create modal overlay
            const modal = document.createElement('div');
            modal.id = 'bybitPathsModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.85);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                backdrop-filter: blur(5px);
            `;

            // Create modal content
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
                border: 2px solid #FFA500;
                border-radius: 15px;
                padding: 30px;
                max-width: 900px;
                max-height: 85vh;
                overflow-y: auto;
                box-shadow: 0 10px 50px rgba(255,165,0,0.3);
                position: relative;
            `;

            modalContent.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid rgba(255,165,0,0.3); padding-bottom: 15px;">
                    <h2 style="color: #FFA500; margin: 0; font-size: 1.8rem;">üìã ByBit Triangular Arbitrage Paths</h2>
                    <button onclick="document.getElementById('bybitPathsModal').remove()" style="background: rgba(255,255,255,0.1); border: 1px solid #FFA500; color: #FFA500; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-size: 1.2rem; font-weight: bold;">‚úï</button>
                </div>

                <div style="background: rgba(255,165,0,0.1); padding: 15px; border-radius: 10px; margin-bottom: 25px; border-left: 4px solid #FFA500;">
                    <p style="color: #b8c6db; margin: 0; font-size: 0.95rem;">
                        <strong style="color: #FFA500;">40 Pure 3-Leg Triangular Arbitrage Paths</strong> organized in 5 sets of 8 paths each.
                        <br><br>
                        üí° <strong>All paths include forward and reverse directions</strong> for bidirectional trading opportunities.
                        <br>
                        üåâ <strong>Bridge Currencies:</strong> BTC (Sets 1-3, 5) and ETH (Set 4)
                        <br>
                        üí∞ <strong>Base Currency:</strong> USDT (Tether) - Fund ByBit with USDT only
                    </p>
                </div>

                <!-- SET 1 -->
                <div style="background: rgba(255,215,0,0.1); padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #ffd700;">
                    <h3 style="color: #ffd700; margin: 0 0 15px 0;">SET 1: Major Coins - BTC Bridge (8 paths) ‚úÖ DEFAULT</h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; font-size: 0.9rem;">
                        <div style="color: #b8c6db;">1. USDT ‚Üí ETH ‚Üí BTC ‚Üí USDT</div>
                        <div style="color: #b8c6db;">2. USDT ‚Üí BTC ‚Üí ETH ‚Üí USDT</div>
                        <div style="color: #b8c6db;">3. USDT ‚Üí SOL ‚Üí BTC ‚Üí USDT</div>
                        <div style="color: #b8c6db;">4. USDT ‚Üí BTC ‚Üí SOL ‚Üí USDT</div>
                        <div style="color: #b8c6db;">5. USDT ‚Üí XRP ‚Üí BTC ‚Üí USDT</div>
                        <div style="color: #b8c6db;">6. USDT ‚Üí BTC ‚Üí XRP ‚Üí USDT</div>
                        <div style="color: #b8c6db;">7. USDT ‚Üí LTC ‚Üí BTC ‚Üí USDT</div>
                        <div style="color: #b8c6db;">8. USDT ‚Üí BTC ‚Üí LTC ‚Üí USDT</div>
                    </div>
                </div>

                <!-- SET 2 -->
                <div style="background: rgba(50,205,50,0.1); padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #32cd32;">
                    <h3 style="color: #32cd32; margin: 0 0 15px 0;">SET 2: Top Altcoins - BTC Bridge (8 paths) ‚úÖ DEFAULT</h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; font-size: 0.9rem;">
                        <div style="color: #b8c6db;">1. USDT ‚Üí ADA ‚Üí BTC ‚Üí USDT</div>
                        <div style="color: #b8c6db;">2. USDT ‚Üí BTC ‚Üí ADA ‚Üí USDT</div>
                        <div style="color: #b8c6db;">3. USDT ‚Üí DOT ‚Üí BTC ‚Üí USDT</div>
                        <div style="color: #b8c6db;">4. USDT ‚Üí BTC ‚Üí DOT ‚Üí USDT</div>
                        <div style="color: #b8c6db;">5. USDT ‚Üí MATIC ‚Üí BTC ‚Üí USDT</div>
                        <div style="color: #b8c6db;">6. USDT ‚Üí BTC ‚Üí MATIC ‚Üí USDT</div>
                        <div style="color: #b8c6db;">7. USDT ‚Üí AVAX ‚Üí BTC ‚Üí USDT</div>
                        <div style="color: #b8c6db;">8. USDT ‚Üí BTC ‚Üí AVAX ‚Üí USDT</div>
                    </div>
                </div>

                <!-- SET 3 -->
                <div style="background: rgba(0,212,255,0.1); padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #00d4ff;">
                    <h3 style="color: #00d4ff; margin: 0 0 15px 0;">SET 3: DeFi & Smart Contract - BTC Bridge (8 paths)</h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; font-size: 0.9rem;">
                        <div style="color: #b8c6db;">1. USDT ‚Üí LINK ‚Üí BTC ‚Üí USDT</div>
                        <div style="color: #b8c6db;">2. USDT ‚Üí BTC ‚Üí LINK ‚Üí USDT</div>
                        <div style="color: #b8c6db;">3. USDT ‚Üí UNI ‚Üí BTC ‚Üí USDT</div>
                        <div style="color: #b8c6db;">4. USDT ‚Üí BTC ‚Üí UNI ‚Üí USDT</div>
                        <div style="color: #b8c6db;">5. USDT ‚Üí ATOM ‚Üí BTC ‚Üí USDT</div>
                        <div style="color: #b8c6db;">6. USDT ‚Üí BTC ‚Üí ATOM ‚Üí USDT</div>
                        <div style="color: #b8c6db;">7. USDT ‚Üí ALGO ‚Üí BTC ‚Üí USDT</div>
                        <div style="color: #b8c6db;">8. USDT ‚Üí BTC ‚Üí ALGO ‚Üí USDT</div>
                    </div>
                </div>

                <!-- SET 4 -->
                <div style="background: rgba(255,105,180,0.1); padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #ff69b4;">
                    <h3 style="color: #ff69b4; margin: 0 0 15px 0;">SET 4: Major Coins - ETH Bridge (8 paths)</h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; font-size: 0.9rem;">
                        <div style="color: #b8c6db;">1. USDT ‚Üí ETH ‚Üí SOL ‚Üí USDT</div>
                        <div style="color: #b8c6db;">2. USDT ‚Üí SOL ‚Üí ETH ‚Üí USDT</div>
                        <div style="color: #b8c6db;">3. USDT ‚Üí ETH ‚Üí ADA ‚Üí USDT</div>
                        <div style="color: #b8c6db;">4. USDT ‚Üí ADA ‚Üí ETH ‚Üí USDT</div>
                        <div style="color: #b8c6db;">5. USDT ‚Üí ETH ‚Üí DOT ‚Üí USDT</div>
                        <div style="color: #b8c6db;">6. USDT ‚Üí DOT ‚Üí ETH ‚Üí USDT</div>
                        <div style="color: #b8c6db;">7. USDT ‚Üí ETH ‚Üí MATIC ‚Üí USDT</div>
                        <div style="color: #b8c6db;">8. USDT ‚Üí MATIC ‚Üí ETH ‚Üí USDT</div>
                    </div>
                </div>

                <!-- SET 5 -->
                <div style="background: rgba(119,136,153,0.1); padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #778899;">
                    <h3 style="color: #778899; margin: 0 0 15px 0;">SET 5: Extended Coverage - BTC Bridge (8 paths)</h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; font-size: 0.9rem;">
                        <div style="color: #b8c6db;">1. USDT ‚Üí XLM ‚Üí BTC ‚Üí USDT</div>
                        <div style="color: #b8c6db;">2. USDT ‚Üí BTC ‚Üí XLM ‚Üí USDT</div>
                        <div style="color: #b8c6db;">3. USDT ‚Üí DOGE ‚Üí BTC ‚Üí USDT</div>
                        <div style="color: #b8c6db;">4. USDT ‚Üí BTC ‚Üí DOGE ‚Üí USDT</div>
                        <div style="color: #b8c6db;">5. USDT ‚Üí FIL ‚Üí BTC ‚Üí USDT</div>
                        <div style="color: #b8c6db;">6. USDT ‚Üí BTC ‚Üí FIL ‚Üí USDT</div>
                        <div style="color: #b8c6db;">7. USDT ‚Üí NEAR ‚Üí BTC ‚Üí USDT</div>
                        <div style="color: #b8c6db;">8. USDT ‚Üí BTC ‚Üí NEAR ‚Üí USDT</div>
                    </div>
                </div>

                <div style="background: rgba(255,165,0,0.15); padding: 15px; border-radius: 10px; text-align: center; margin-top: 20px;">
                    <p style="color: #FFA500; margin: 0; font-size: 0.95rem; font-weight: 500;">
                        üí° <strong>Total: 40 paths</strong> | All 3-leg pure triangular arbitrage | No 2-leg or 4-leg paths
                    </p>
                </div>
            `;

            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // Close modal when clicking outside
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });

            console.log('‚úÖ [BYBIT] Paths modal displayed');
        }

        // Clear ByBit Triangular History
        async function clearByBitTriangularHistory() {
            console.log('üóëÔ∏è [BYBIT] Clear history requested');
            if (!confirm('‚ö†Ô∏è Clear all ByBit triangular trade history?\n\nThis action cannot be undone.')) {
                console.log('‚ùå [BYBIT] Clear history cancelled by user');
                return;
            }

            try {
                console.log('üì° [BYBIT] Sending delete request to backend...');
                const response = await fetch('/api/v1/trading/bybit/triangular/history', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                console.log('‚úÖ [BYBIT] Delete response received:', result);

                if (result.success) {
                    console.log('‚úÖ [BYBIT] History cleared, resetting UI stats...');
                    // Reset stats display
                    document.getElementById('bybitTotalTrades').textContent = '0';
                    document.getElementById('bybitSuccessfulTrades').textContent = '0';
                    document.getElementById('bybitSuccessRate').textContent = '0%';
                    document.getElementById('bybitTotalProfit').textContent = '$0.00';
                    document.getElementById('bybitBestPath').textContent = '-';
                    document.getElementById('bybitLastScan').textContent = 'Never';

                    // Clear recent trades display
                    document.getElementById('bybitRecentTrades').innerHTML =
                        '<div style="text-align: center; color: #888; padding: 20px;">No triangular trades yet. Enable live trading to start.</div>';

                    alert(`‚úÖ History cleared successfully!\n\nDeleted ${result.data.deletedCount} records.`);
                } else {
                    console.error('‚ùå [BYBIT] Failed to clear history:', result.message);
                    alert(`‚ùå Failed to clear history: ${result.message || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('‚ùå [BYBIT] Clear history error:', error);
                alert(`‚ùå Error: ${error.message}`);
            }
        }

        // Save ByBit settings to localStorage
        function saveByBitTriangularSettings() {
            console.log('üíæ [BYBIT] Saving settings to localStorage...');
            const settings = {
                maxTrade: document.getElementById('bybitMaxTrade').value,
                portfolioPercent: document.getElementById('bybitPortfolioPercent').value,
                profitThreshold: document.getElementById('bybitProfitThreshold').value
            };

            // Save path set states (5 sets for ByBit)
            for (let i = 1; i <= 5; i++) {
                const checkbox = document.getElementById(`bybitSet${i}Enabled`);
                if (checkbox) {
                    settings[`set${i}Enabled`] = checkbox.checked;
                }
            }

            localStorage.setItem('bybitTriangularSettings', JSON.stringify(settings));
            console.log('‚úÖ [BYBIT] Settings saved:', settings);
        }

        // Load ByBit settings from localStorage
        function loadByBitTriangularSettings() {
            console.log('üíæ [BYBIT] Loading settings from localStorage...');
            const savedSettings = localStorage.getItem('bybitTriangularSettings');
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);
                console.log('‚úÖ [BYBIT] Settings loaded:', settings);

                if (settings.maxTrade) document.getElementById('bybitMaxTrade').value = settings.maxTrade;
                if (settings.portfolioPercent) document.getElementById('bybitPortfolioPercent').value = settings.portfolioPercent;
                if (settings.profitThreshold) document.getElementById('bybitProfitThreshold').value = settings.profitThreshold;

                // Load path set states (5 sets)
                for (let i = 1; i <= 5; i++) {
                    const checkbox = document.getElementById(`bybitSet${i}Enabled`);
                    if (checkbox && settings[`set${i}Enabled`] !== undefined) {
                        checkbox.checked = settings[`set${i}Enabled`];
                    }
                }
            } else {
                console.log('‚ÑπÔ∏è [BYBIT] No saved settings found, using defaults');
            }
        }

        // Auto-save ByBit settings when changed
        document.addEventListener('DOMContentLoaded', function() {
            // Add event listeners for ByBit settings auto-save
            const bybitInputs = document.querySelectorAll('#bybitMaxTrade, #bybitPortfolioPercent, #bybitProfitThreshold');
            bybitInputs.forEach(input => {
                input.addEventListener('change', saveByBitTriangularSettings);
            });

            // Add event listeners for ByBit checkboxes (5 sets)
            for (let i = 1; i <= 5; i++) {
                const checkbox = document.getElementById(`bybitSet${i}Enabled`);
                if (checkbox) {
                    checkbox.addEventListener('change', saveByBitTriangularSettings);
                }
            }
        });

        // ========================================================================
        // BINANCE TRIANGULAR ARBITRAGE FUNCTIONS
        // ========================================================================

        // Scan a single Binance path set
        async function scanBinanceSet(apiKey, apiSecret, setNumber) {
            console.log(`üìä [BINANCE Worker] Scanning SET ${setNumber}...`);

            // Get risk settings from UI
            const maxTradeAmount = parseFloat(document.getElementById('binanceMaxTrade')?.value || 100);
            const profitThreshold = parseFloat(document.getElementById('binanceProfitThreshold')?.value || 0.5);
            const portfolioPercent = parseFloat(document.getElementById('binancePortfolioPercent')?.value || 10);

            // Get current balance (from balance tracking)
            const currentBalance = binanceBalanceTracking.currentUSDT || 0;

            try {
                const response = await fetch(`${API_BASE}/trading/binance/triangular/scan`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        apiKey,
                        apiSecret,
                        paths: [setNumber],  // Scan only this set
                        maxTradeAmount: maxTradeAmount,
                        profitThreshold: profitThreshold,
                        portfolioPercent: portfolioPercent,
                        currentBalance: currentBalance
                    })
                });

                const result = await response.json();

                if (result.success && result.data) {
                    const opps = result.data.opportunities || [];
                    binanceWorkerStats.totalOpportunities += opps.length;

                    // Log portfolio calculation details
                    if (result.data?.portfolioCalculation) {
                        const calc = result.data.portfolioCalculation;
                        console.log(`üí∞ [BINANCE Portfolio] Balance: $${calc.balance}, ${calc.portfolioPercent}% = $${calc.portfolioAmount}, Cap: ${calc.appliedCap}, Can Trade: ${calc.canTrade}`);
                    }

                    // Display warnings (non-blocking)
                    if (result.data?.warnings && result.data.warnings.length > 0) {
                        result.data.warnings.forEach(warning => {
                            console.warn(`‚ö†Ô∏è [BINANCE Portfolio] ${warning}`);
                        });
                    }

                    if (opps.length > 0) {
                        console.log(`üí∞ [BINANCE Worker] SET ${setNumber}: Found ${opps.length} opportunities`);
                        opps.forEach((opp, idx) => {
                            console.log(`   ${idx + 1}. ${opp.path?.id || 'Unknown'}: +${opp.profitPercentage?.toFixed(2)}%`);
                        });
                    } else {
                        console.log(`‚ÑπÔ∏è [BINANCE Worker] SET ${setNumber}: No opportunities found`);
                    }
                } else {
                    console.warn(`‚ö†Ô∏è [BINANCE Worker] SET ${setNumber}: Scan failed -`, result.message);
                }
            } catch (error) {
                console.error(`‚ùå [BINANCE Worker] SET ${setNumber} scan error:`, error.message);
            }
        }

        // Perform sequential scan cycle (scan each enabled set with delays)
        async function performBinanceSequentialScan(apiKey, apiSecret) {
            // Check if worker was stopped
            if (!binanceWorkerRunning) {
                console.log('‚èπÔ∏è [BINANCE Worker] Scan cycle aborted - worker stopped');
                return;
            }

            binanceWorkerStats.totalScans++;
            console.log(`\nüîÑ [BINANCE Worker] ‚ïê‚ïê‚ïê Scan Cycle #${binanceWorkerStats.totalScans} Starting ‚ïê‚ïê‚ïê`);

            // Get enabled path sets
            const enabledSets = [];
            for (let i = 1; i <= 5; i++) {
                const checkbox = document.getElementById(`binanceSet${i}Enabled`);
                if (checkbox && checkbox.checked) {
                    enabledSets.push(i);
                }
            }

            if (enabledSets.length === 0) {
                console.warn('‚ö†Ô∏è [BINANCE Worker] No path sets enabled');
                return;
            }

            console.log(`üìã [BINANCE Worker] Enabled sets: [${enabledSets.join(', ')}] - Scanning sequentially...`);

            // Scan each enabled set with 5-second delay between sets
            for (let i = 0; i < enabledSets.length; i++) {
                // Check if worker was stopped before each set
                if (!binanceWorkerRunning) {
                    console.log('‚èπÔ∏è [BINANCE Worker] Scan cycle aborted mid-cycle - worker stopped');
                    return;
                }

                const setNumber = enabledSets[i];
                await scanBinanceSet(apiKey, apiSecret, setNumber);

                // Wait 5 seconds before next set (except after last set)
                if (i < enabledSets.length - 1) {
                    console.log(`‚è≥ [BINANCE Worker] Waiting 5 seconds before next set...`);
                    await new Promise(resolve => setTimeout(resolve, 5000));
                }
            }

            binanceWorkerStats.lastScanTime = new Date();
            const lastScanElement = document.getElementById('binanceLastScan');
            if (lastScanElement) {
                lastScanElement.textContent = binanceWorkerStats.lastScanTime.toLocaleTimeString();
            }

            // Update balance after scan cycle
            await updateBinanceBalance(apiKey, apiSecret);

            console.log(`‚úÖ [BINANCE Worker] ‚ïê‚ïê‚ïê Scan Cycle #${binanceWorkerStats.totalScans} Complete ‚ïê‚ïê‚ïê\n`);
        }

        // Start Binance automated worker (sequential scanning)
        async function startBinanceWorker() {
            binanceWorkerRunning = true;  // Enable worker flag
            console.log('üîÑ [BINANCE Worker] Starting sequential scanning...');

            const apiKey = localStorage.getItem('binance_triangular_api');
            const apiSecret = localStorage.getItem('binance_triangular_secret');

            if (!apiKey || !apiSecret) {
                console.error('‚ùå [BINANCE Worker] Missing API credentials');
                return;
            }

            // Initialize balance tracking
            console.log('üí∞ [BINANCE Worker] Initializing balance tracking...');
            await initializeBinanceBalance(apiKey, apiSecret);

            // Perform immediate first scan cycle
            console.log('üöÄ [BINANCE Worker] Performing immediate first scan cycle...');
            await performBinanceSequentialScan(apiKey, apiSecret);

            // Continue scanning cycles every 30 seconds
            binanceWorkerInterval = setInterval(async () => {
                await performBinanceSequentialScan(apiKey, apiSecret);
            }, 30000); // 30 seconds between cycles

            console.log('‚úÖ [BINANCE Worker] Sequential scanning started (cycles every 30s, 5s delay between sets)');
        }

        // Stop Binance automated worker
        function stopBinanceWorker() {
            binanceWorkerRunning = false;  // Disable worker flag to abort any running scan
            if (binanceWorkerInterval) {
                clearInterval(binanceWorkerInterval);
                binanceWorkerInterval = null;
                console.log('‚èπÔ∏è [BINANCE Worker] Automated scanning stopped');
            }
        }

        // Binance Toggle Event Listener (Updated with worker)
        document.getElementById('binanceTriangularEnabled').addEventListener('click', async function() {
            console.log('üîÑ [BINANCE] Toggle clicked');

            const isCurrentlyActive = this.classList.contains('active');
            const status = document.getElementById('binanceTriangularStatus');

            if (!isCurrentlyActive) {
                // Enabling - validate credentials first
                const apiKey = localStorage.getItem('binance_triangular_api');
                const apiSecret = localStorage.getItem('binance_triangular_secret');

                if (!apiKey || !apiSecret) {
                    console.warn('‚ö†Ô∏è [BINANCE] Missing API credentials');
                    alert('‚ùå Please set up your Binance API credentials first in the Strategy API Setup page.');
                    return;
                }

                // Validate at least one path set is enabled
                const enabledSets = [];
                for (let i = 1; i <= 5; i++) {
                    const checkbox = document.getElementById(`binanceSet${i}Enabled`);
                    if (checkbox && checkbox.checked) {
                        enabledSets.push(i);
                    }
                }

                if (enabledSets.length === 0) {
                    console.warn('‚ö†Ô∏è [BINANCE] No path sets enabled');
                    alert('‚ùå Please enable at least one path set before starting automated scanning.');
                    return;
                }

                console.log('‚úÖ [BINANCE] Automated scanning enabled');
                this.classList.add('active');
                status.textContent = 'ON';
                status.style.color = '#F0B90B';
                localStorage.setItem('binanceTriangularEnabled', 'true');

                // Start the worker
                await startBinanceWorker();
            } else {
                // Disabling
                console.log('‚ùå [BINANCE] Automated scanning disabled');
                this.classList.remove('active');
                status.textContent = 'OFF';
                status.style.color = '#ff6b6b';
                localStorage.setItem('binanceTriangularEnabled', 'false');

                // Stop the worker
                stopBinanceWorker();
            }
        });

        // Test Binance Connection
        async function testBinanceTriangularConnection() {
            console.log('üîç [BINANCE] Testing connection...');
            const apiKey = localStorage.getItem('binance_triangular_api');
            const apiSecret = localStorage.getItem('binance_triangular_secret');

            if (!apiKey || !apiSecret) {
                alert('‚ùå Please enter your Binance API credentials first and save settings.');
                console.log('‚ö†Ô∏è [BINANCE] API credentials missing');
                return;
            }

            try {
                console.log('üì° [BINANCE] Sending test connection request to backend...');
                const response = await fetch('/api/v1/trading/binance/triangular/test-connection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({
                        apiKey: apiKey,
                        apiSecret: apiSecret
                    })
                });

                const result = await response.json();
                console.log('‚úÖ [BINANCE] Test connection response received:', result);

                if (result.success) {
                    alert(`‚úÖ Binance Connection Successful!\n\n` +
                          `‚Ä¢ Authenticated: ${result.data.authenticated ? 'Yes' : 'No'}\n` +
                          `‚Ä¢ Balance Access: ${result.data.balanceAccess ? 'Yes' : 'No'}\n` +
                          `‚Ä¢ Market Data Access: ${result.data.marketDataAccess ? 'Yes' : 'No'}\n` +
                          `‚Ä¢ Available Pairs: ${result.data.availablePairs}\n` +
                          `‚Ä¢ Triangular Ready: ${result.data.triangularReady ? 'Yes' : 'No'}\n` +
                          `‚Ä¢ Sample Price: ${result.data.samplePrice}`);
                } else {
                    alert(`‚ùå Binance Connection Failed\n\n${result.message}`);
                    console.error('‚ùå [BINANCE] Connection test failed:', result);
                }
            } catch (error) {
                console.error('‚ùå [BINANCE] Connection test error:', error);
                alert(`‚ùå Connection Error: ${error.message}`);
            }
        }

        // Scan Binance Triangular Paths
        async function scanBinanceTriangularPaths() {
            console.log('üîç [BINANCE] Starting path scan...');
            const apiKey = localStorage.getItem('binance_triangular_api');
            const apiSecret = localStorage.getItem('binance_triangular_secret');

            if (!apiKey || !apiSecret) {
                alert('‚ùå Please enter your Binance API credentials first and save settings.');
                console.log('‚ö†Ô∏è [BINANCE] API credentials missing');
                return;
            }

            // Gather enabled sets
            const enabledSets = [];
            for (let i = 1; i <= 5; i++) {
                const checkbox = document.getElementById(`binanceSet${i}Enabled`);
                if (checkbox && checkbox.checked) {
                    enabledSets.push(i);
                }
            }

            console.log('üìä [BINANCE] Enabled path sets:', enabledSets);

            const profitThreshold = parseFloat(document.getElementById('binanceProfitThreshold').value) || 0.5;
            console.log('üìà [BINANCE] Profit threshold:', profitThreshold, '%');

            try {
                console.log('üì° [BINANCE] Sending scan request to backend...');
                const response = await fetch('/api/v1/trading/binance/triangular/scan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({
                        apiKey: apiKey,
                        apiSecret: apiSecret,
                        enabledSets: enabledSets,
                        profitThreshold: profitThreshold
                    })
                });

                const result = await response.json();
                console.log('‚úÖ [BINANCE] Scan response received:', result);

                if (result.success) {
                    const feedDiv = document.getElementById('binanceLiveFeed');
                    const timestamp = new Date().toLocaleTimeString();

                    let feedMessage = `<div style="color: #F0B90B; margin-bottom: 8px;">[${timestamp}] Scan Complete</div>`;
                    feedMessage += `<div style="color: #b8c6db;">‚Ä¢ Scanned: ${result.data.scannedPaths} paths</div>`;
                    feedMessage += `<div style="color: #b8c6db;">‚Ä¢ Opportunities: ${result.data.opportunities.length}</div>`;
                    feedMessage += `<div style="color: #888; margin-top: 4px; font-size: 0.8rem;">${result.data.message}</div>`;

                    feedDiv.innerHTML = feedMessage + feedDiv.innerHTML;

                    if (result.data.opportunities.length > 0) {
                        alert(`üéØ Found ${result.data.opportunities.length} Binance arbitrage opportunities!`);
                    } else {
                        alert(`‚úÖ Scan complete. No opportunities above ${profitThreshold}% threshold found.`);
                    }
                } else {
                    alert(`‚ùå Scan Failed\n\n${result.message}`);
                    console.error('‚ùå [BINANCE] Scan failed:', result);
                }
            } catch (error) {
                console.error('‚ùå [BINANCE] Scan error:', error);
                alert(`‚ùå Scan Error: ${error.message}`);
            }
        }

        // View Binance Path Details
        function viewBinancePathDetails() {
            // Create modal overlay
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                backdrop-filter: blur(5px);
            `;

            // Create modal content
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
                border: 2px solid #F0B90B;
                border-radius: 15px;
                padding: 30px;
                max-width: 800px;
                max-height: 85vh;
                overflow-y: auto;
                box-shadow: 0 10px 50px rgba(240, 185, 11, 0.3);
                color: #fff;
                font-family: 'Courier New', monospace;
            `;

            modalContent.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #F0B90B; padding-bottom: 15px;">
                    <h2 style="margin: 0; color: #F0B90B; font-size: 24px;">üìã BINANCE Triangular Arbitrage Paths</h2>
                    <button id="closeModal" style="background: #ff4444; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 18px;">‚úï</button>
                </div>

                <div style="line-height: 1.8; font-size: 14px;">
                    <div style="background: rgba(240, 185, 11, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <strong style="color: #F0B90B;">üìä SET 1: Major BTC Bridge (8 paths) ‚úÖ DEFAULT</strong><br>
                        1. USDT ‚Üí ETH ‚Üí BTC ‚Üí USDT<br>
                        2. USDT ‚Üí BTC ‚Üí ETH ‚Üí USDT (reverse)<br>
                        3. USDT ‚Üí SOL ‚Üí BTC ‚Üí USDT<br>
                        4. USDT ‚Üí BTC ‚Üí SOL ‚Üí USDT (reverse)<br>
                        5. USDT ‚Üí XRP ‚Üí BTC ‚Üí USDT<br>
                        6. USDT ‚Üí BTC ‚Üí XRP ‚Üí USDT (reverse)<br>
                        7. USDT ‚Üí LTC ‚Üí BTC ‚Üí USDT<br>
                        8. USDT ‚Üí BTC ‚Üí LTC ‚Üí USDT (reverse)
                    </div>

                    <div style="background: rgba(240, 185, 11, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <strong style="color: #F0B90B;">üìä SET 2: Altcoins BTC Bridge (8 paths) ‚úÖ DEFAULT</strong><br>
                        1. USDT ‚Üí ADA ‚Üí BTC ‚Üí USDT<br>
                        2. USDT ‚Üí BTC ‚Üí ADA ‚Üí USDT (reverse)<br>
                        3. USDT ‚Üí DOT ‚Üí BTC ‚Üí USDT<br>
                        4. USDT ‚Üí BTC ‚Üí DOT ‚Üí USDT (reverse)<br>
                        5. USDT ‚Üí MATIC ‚Üí BTC ‚Üí USDT<br>
                        6. USDT ‚Üí BTC ‚Üí MATIC ‚Üí USDT (reverse)<br>
                        7. USDT ‚Üí AVAX ‚Üí BTC ‚Üí USDT<br>
                        8. USDT ‚Üí BTC ‚Üí AVAX ‚Üí USDT (reverse)
                    </div>

                    <div style="background: rgba(240, 185, 11, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <strong style="color: #F0B90B;">üìä SET 3: DeFi BTC Bridge (6 paths)</strong><br>
                        1. USDT ‚Üí LINK ‚Üí BTC ‚Üí USDT<br>
                        2. USDT ‚Üí BTC ‚Üí LINK ‚Üí USDT (reverse)<br>
                        3. USDT ‚Üí UNI ‚Üí BTC ‚Üí USDT<br>
                        4. USDT ‚Üí BTC ‚Üí UNI ‚Üí USDT (reverse)<br>
                        5. USDT ‚Üí ATOM ‚Üí BTC ‚Üí USDT<br>
                        6. USDT ‚Üí BTC ‚Üí ATOM ‚Üí USDT (reverse)
                    </div>

                    <div style="background: rgba(240, 185, 11, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <strong style="color: #F0B90B;">üìä SET 4: ETH/BNB Bridge (varies)</strong><br>
                        Various paths using ETH and BNB as bridge currencies
                    </div>

                    <div style="background: rgba(240, 185, 11, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <strong style="color: #F0B90B;">üìä SET 5: Multi-Bridge (varies)</strong><br>
                        Extended paths with multiple bridge currencies
                    </div>

                    <div style="background: rgba(0, 136, 255, 0.1); padding: 20px; border-radius: 8px; border-left: 4px solid #0088ff; margin-top: 20px;">
                        <strong style="color: #0088ff;">üìå Summary</strong><br>
                        üí° TOTAL: 24+ paths (simplified USDT-focused)<br>
                        üåâ BRIDGE: BTC, ETH, BNB<br>
                        üîÑ PATTERN: USDT-only funding, bidirectional paths<br>
                        üåç GLOBAL: World's largest crypto exchange<br>
                        ‚úÖ OPTIMIZED: High liquidity major coins only<br>
                        üîê AUTH: API Key + Secret
                    </div>
                </div>
            `;

            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // Close modal on click outside or close button
            modal.addEventListener('click', function(e) {
                if (e.target === modal || e.target.id === 'closeModal') {
                    document.body.removeChild(modal);
                }
            });

            console.log('üìã [BINANCE] Path details modal displayed');
        }

        // Clear Binance Trade History
        async function clearBinanceTriangularHistory() {
            console.log('üóëÔ∏è [BINANCE] Clearing trade history...');

            if (!confirm('‚ö†Ô∏è Are you sure you want to clear all Binance triangular trade history?')) {
                console.log('‚ùå [BINANCE] History clear cancelled by user');
                return;
            }

            try {
                console.log('üì° [BINANCE] Sending delete history request to backend...');
                const response = await fetch('/api/v1/trading/binance/triangular/history', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });

                const result = await response.json();
                console.log('‚úÖ [BINANCE] Delete history response received:', result);

                if (result.success) {
                    alert(`‚úÖ Cleared ${result.data.deletedCount} Binance trades from history`);
                    document.getElementById('binanceLiveFeed').innerHTML = '<div style="color: #888;">Trade history cleared. Waiting for scan results...</div>';
                } else {
                    alert(`‚ùå Failed to clear history\n\n${result.message}`);
                    console.error('‚ùå [BINANCE] Clear history failed:', result);
                }
            } catch (error) {
                console.error('‚ùå [BINANCE] Clear history error:', error);
                alert(`‚ùå Error: ${error.message}`);
            }
        }

        // Save Binance Triangular Settings
        function saveBinanceTriangularSettings() {
            console.log('üíæ [BINANCE] Saving settings to localStorage...');

            const maxTrade = document.getElementById('binanceMaxTrade').value;
            const portfolioPercent = document.getElementById('binancePortfolioPercent').value;
            const profitThreshold = document.getElementById('binanceProfitThreshold').value;

            // Save settings
            const settings = {
                maxTrade: maxTrade,
                portfolioPercent: portfolioPercent,
                profitThreshold: profitThreshold
            };

            // Save path set preferences
            for (let i = 1; i <= 5; i++) {
                const checkbox = document.getElementById(`binanceSet${i}Enabled`);
                if (checkbox) {
                    settings[`set${i}Enabled`] = checkbox.checked;
                }
            }

            localStorage.setItem('binanceTriangularSettings', JSON.stringify(settings));
            console.log('‚úÖ [BINANCE] Settings saved:', settings);
        }

        // Load Binance Triangular Settings
        function loadBinanceTriangularSettings() {
            console.log('üì• [BINANCE] Loading settings from localStorage...');

            // Load settings
            const settingsJson = localStorage.getItem('binanceTriangularSettings');
            if (settingsJson) {
                try {
                    const settings = JSON.parse(settingsJson);
                    console.log('‚úÖ [BINANCE] Settings loaded:', settings);

                    if (settings.maxTrade) document.getElementById('binanceMaxTrade').value = settings.maxTrade;
                    if (settings.portfolioPercent) document.getElementById('binancePortfolioPercent').value = settings.portfolioPercent;
                    if (settings.profitThreshold) document.getElementById('binanceProfitThreshold').value = settings.profitThreshold;

                    // Load path set preferences
                    for (let i = 1; i <= 5; i++) {
                        const checkbox = document.getElementById(`binanceSet${i}Enabled`);
                        if (checkbox && settings.hasOwnProperty(`set${i}Enabled`)) {
                            checkbox.checked = settings[`set${i}Enabled`];
                        }
                    }
                } catch (error) {
                    console.error('‚ùå [BINANCE] Failed to parse settings:', error);
                }
            }

            // Load toggle state
            const toggleEnabled = localStorage.getItem('binanceTriangularEnabled') === 'true';
            const toggle = document.getElementById('binanceTriangularEnabled');
            const status = document.getElementById('binanceTriangularStatus');

            if (toggleEnabled) {
                toggle.classList.add('active');
                status.textContent = 'ON';
                status.style.color = '#F0B90B';
                console.log('‚úÖ [BINANCE] Live trading enabled (from localStorage)');
            } else {
                console.log('‚ÑπÔ∏è [BINANCE] Live trading disabled (from localStorage)');
            }
        }

        // Initialize Binance settings on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ [BINANCE] Initializing triangular arbitrage settings...');
            loadBinanceTriangularSettings();

            // Add event listeners for Binance inputs (auto-save)
            const binanceInputs = document.querySelectorAll('#binanceMaxTrade, #binancePortfolioPercent, #binanceProfitThreshold');
            binanceInputs.forEach(input => {
                input.addEventListener('change', saveBinanceTriangularSettings);
            });

            // Add event listeners for Binance checkboxes (5 sets)
            for (let i = 1; i <= 5; i++) {
                const checkbox = document.getElementById(`binanceSet${i}Enabled`);
                if (checkbox) {
                    checkbox.addEventListener('change', saveBinanceTriangularSettings);
                }
            }
        });

        // ========================================================================
        // OKX TRIANGULAR ARBITRAGE FUNCTIONS
        // ========================================================================

        // ============================================================
        // OKX SEQUENTIAL WORKER FUNCTIONS
        // ============================================================

        // Scan a single OKX set
        async function scanOKXSet(apiKey, apiSecret, passphrase, setNumber) {
            try {
                console.log(`üîç [OKX Worker] Scanning SET_${setNumber}...`);

                // Get risk settings from UI
                const maxTradeAmount = parseFloat(document.getElementById('okxMaxTrade')?.value || 100);
                const profitThreshold = parseFloat(document.getElementById('okxProfitThreshold')?.value || 0.5);
                const portfolioPercent = parseFloat(document.getElementById('okxPortfolioPercent')?.value || 10);

                // Get current balance (from balance tracking)
                const currentBalance = okxBalanceTracking.currentUSDT || 0;

                // Scan for opportunities for this specific set
                const response = await fetch('/api/v1/trading/okx/triangular/scan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        apiKey,
                        apiSecret,
                        passphrase,
                        enabledSets: [setNumber],  // Scan only this set
                        maxTradeAmount: maxTradeAmount,
                        profitThreshold: profitThreshold,
                        portfolioPercent: portfolioPercent,
                        currentBalance: currentBalance
                    })
                });

                const result = await response.json();

                if (result.success && result.data && result.data.opportunities) {
                    const opportunities = result.data.opportunities;
                    console.log(`‚úÖ [OKX Worker] SET_${setNumber} scanned: ${opportunities.length} opportunities found`);

                    // Log portfolio calculation details
                    if (result.data?.portfolioCalculation) {
                        const calc = result.data.portfolioCalculation;
                        console.log(`üí∞ [OKX Portfolio] Balance: $${calc.balance}, ${calc.portfolioPercent}% = $${calc.portfolioAmount}, Cap: ${calc.appliedCap}, Can Trade: ${calc.canTrade}`);
                    }

                    // Display warnings (non-blocking)
                    if (result.data?.warnings && result.data.warnings.length > 0) {
                        result.data.warnings.forEach(warning => {
                            console.warn(`‚ö†Ô∏è [OKX Portfolio] ${warning}`);
                        });
                    }

                    if (opportunities.length > 0) {
                        okxWorkerStats.totalOpportunities += opportunities.length;

                        // Display top opportunity in live feed
                        const liveFeed = document.getElementById('okxLiveFeed');
                        if (liveFeed && opportunities[0]) {
                            const opp = opportunities[0];
                            const oppDiv = document.createElement('div');
                            oppDiv.style.cssText = 'padding: 8px; background: rgba(0,166,255,0.1); border-left: 3px solid #00ff88; margin-bottom: 8px; border-radius: 4px;';
                            oppDiv.innerHTML = `
                                <div style="color: #00ff88; font-weight: bold;">SET ${setNumber}: +${opp.profitPercentage.toFixed(3)}%</div>
                                <div style="color: #b8c6db; font-size: 0.85rem;">${opp.path.sequence}</div>
                                <div style="color: #888; font-size: 0.75rem;">${new Date().toLocaleTimeString()}</div>
                            `;
                            liveFeed.insertBefore(oppDiv, liveFeed.firstChild);

                            // Keep only last 10 entries
                            while (liveFeed.children.length > 10) {
                                liveFeed.removeChild(liveFeed.lastChild);
                            }
                        }
                    }
                } else {
                    console.warn(`‚ö†Ô∏è [OKX Worker] SET_${setNumber} scan returned no data`);
                }

            } catch (error) {
                console.error(`‚ùå [OKX Worker] Error scanning SET_${setNumber}:`, error);
            }
        }

        // Perform sequential scan of enabled sets with delays
        async function performOKXSequentialScan(apiKey, apiSecret, passphrase) {
            // Check if worker was stopped
            if (!okxWorkerRunning) {
                console.log('‚èπÔ∏è [OKX Worker] Scan cycle aborted - worker stopped');
                return;
            }

            okxWorkerStats.totalScans++;
            console.log(`\nüîÑ [OKX Worker] ‚ïê‚ïê‚ïê Scan Cycle #${okxWorkerStats.totalScans} Starting ‚ïê‚ïê‚ïê`);

            // Get enabled path sets
            const enabledSets = [];
            for (let i = 1; i <= 5; i++) {
                const checkbox = document.getElementById(`okxSet${i}Enabled`);
                if (checkbox && checkbox.checked) {
                    enabledSets.push(i);
                }
            }

            if (enabledSets.length === 0) {
                console.warn('‚ö†Ô∏è [OKX Worker] No path sets enabled');
                return;
            }

            console.log(`üìã [OKX Worker] Enabled sets: [${enabledSets.join(', ')}] - Scanning sequentially...`);

            // Scan each enabled set with 5-second delay between sets
            for (let i = 0; i < enabledSets.length; i++) {
                // Check if worker was stopped before each set
                if (!okxWorkerRunning) {
                    console.log('‚èπÔ∏è [OKX Worker] Scan cycle aborted mid-cycle - worker stopped');
                    return;
                }

                const setNumber = enabledSets[i];
                await scanOKXSet(apiKey, apiSecret, passphrase, setNumber);

                // Wait 5 seconds before next set (except after last set)
                if (i < enabledSets.length - 1) {
                    console.log(`‚è≥ [OKX Worker] Waiting 5 seconds before next set...`);
                    await new Promise(resolve => setTimeout(resolve, 5000));
                }
            }

            okxWorkerStats.lastScanTime = new Date();
            const lastScanElement = document.getElementById('okxLastScan');
            if (lastScanElement) {
                lastScanElement.textContent = okxWorkerStats.lastScanTime.toLocaleTimeString();
            }

            // Update balance after scan cycle
            await updateOKXBalance(apiKey, apiSecret, passphrase);

            console.log(`‚úÖ [OKX Worker] ‚ïê‚ïê‚ïê Scan Cycle #${okxWorkerStats.totalScans} Complete ‚ïê‚ïê‚ïê\n`);
        }

        // Start OKX automated worker (sequential scanning)
        async function startOKXWorker() {
            okxWorkerRunning = true;  // Enable worker flag
            console.log('üîÑ [OKX Worker] Starting sequential scanning...');

            const apiKey = localStorage.getItem('okx_triangular_api');
            const apiSecret = localStorage.getItem('okx_triangular_secret');
            const passphrase = localStorage.getItem('okx_triangular_passphrase');

            if (!apiKey || !apiSecret || !passphrase) {
                console.error('‚ùå [OKX Worker] Missing API credentials');
                return;
            }

            // Initialize balance tracking
            console.log('üí∞ [OKX Worker] Initializing balance tracking...');
            await initializeOKXBalance(apiKey, apiSecret, passphrase);

            // Perform immediate first scan cycle
            console.log('üöÄ [OKX Worker] Performing immediate first scan cycle...');
            await performOKXSequentialScan(apiKey, apiSecret, passphrase);

            // Continue scanning cycles every 30 seconds
            okxWorkerInterval = setInterval(async () => {
                await performOKXSequentialScan(apiKey, apiSecret, passphrase);
            }, 30000); // 30 seconds between cycles

            console.log('‚úÖ [OKX Worker] Sequential scanning started (cycles every 30s, 5s delay between sets)');
        }

        // Stop OKX automated worker
        function stopOKXWorker() {
            okxWorkerRunning = false;  // Disable worker flag to abort any running scan
            if (okxWorkerInterval) {
                clearInterval(okxWorkerInterval);
                okxWorkerInterval = null;
                console.log('‚èπÔ∏è [OKX Worker] Automated scanning stopped');
            }
        }

        // OKX Toggle Event Listener (Updated with worker)
        document.getElementById('okxTriangularEnabled').addEventListener('click', async function() {
            console.log('üîÑ [OKX] Toggle clicked');

            const isCurrentlyActive = this.classList.contains('active');
            const status = document.getElementById('okxTriangularStatus');

            if (!isCurrentlyActive) {
                // Enabling - validate credentials first
                const apiKey = localStorage.getItem('okx_triangular_api');
                const apiSecret = localStorage.getItem('okx_triangular_secret');
                const passphrase = localStorage.getItem('okx_triangular_passphrase');

                if (!apiKey || !apiSecret || !passphrase) {
                    console.warn('‚ö†Ô∏è [OKX] Missing API credentials');
                    alert('‚ùå Please set up your OKX API credentials first (API Key, Secret, and Passphrase) in the Strategy API Setup page.');
                    return;
                }

                // Validate that at least one path set is enabled
                const enabledSets = [];
                for (let i = 1; i <= 5; i++) {
                    const checkbox = document.getElementById(`okxSet${i}Enabled`);
                    if (checkbox && checkbox.checked) {
                        enabledSets.push(i);
                    }
                }

                if (enabledSets.length === 0) {
                    console.warn('‚ö†Ô∏è [OKX] No path sets enabled');
                    alert('‚ùå Please enable at least one path set before activating the scanner.');
                    return;
                }

                console.log('‚úÖ [OKX] Automated scanning enabled');
                this.classList.add('active');
                status.textContent = 'ON';
                status.style.color = '#00A6FF';
                localStorage.setItem('okxTriangularEnabled', 'true');

                // Start the worker
                await startOKXWorker();
            } else {
                // Disabling
                console.log('‚ùå [OKX] Automated scanning disabled');
                this.classList.remove('active');
                status.textContent = 'OFF';
                status.style.color = '#ff6b6b';
                localStorage.setItem('okxTriangularEnabled', 'false');

                // Stop the worker
                stopOKXWorker();
            }
        });

        // Test OKX Connection
        async function testOKXTriangularConnection() {
            console.log('üîç [OKX] Testing connection...');
            const apiKey = localStorage.getItem('okx_triangular_api');
            const apiSecret = localStorage.getItem('okx_triangular_secret');
            const passphrase = localStorage.getItem('okx_triangular_passphrase');

            if (!apiKey || !apiSecret || !passphrase) {
                alert('‚ùå Please configure your OKX API credentials in platform settings first.');
                console.log('‚ö†Ô∏è [OKX] API credentials missing');
                return;
            }

            try {
                console.log('üì° [OKX] Sending test connection request to backend...');
                const response = await fetch('/api/v1/trading/okx/triangular/test-connection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({
                        apiKey: apiKey,
                        apiSecret: apiSecret,
                        passphrase: passphrase
                    })
                });

                const result = await response.json();
                console.log('‚úÖ [OKX] Test connection response received:', result);

                if (result.success) {
                    alert(`‚úÖ OKX Connection Successful!\n\n` +
                          `‚Ä¢ Authenticated: ${result.data.authenticated ? 'Yes' : 'No'}\n` +
                          `‚Ä¢ Balance Access: ${result.data.balanceAccess ? 'Yes' : 'No'}\n` +
                          `‚Ä¢ Market Data Access: ${result.data.marketDataAccess ? 'Yes' : 'No'}\n` +
                          `‚Ä¢ Available Pairs: ${result.data.availablePairs}\n` +
                          `‚Ä¢ Triangular Ready: ${result.data.triangularReady ? 'Yes' : 'No'}\n` +
                          `‚Ä¢ Sample Price: ${result.data.samplePrice}`);
                } else {
                    alert(`‚ùå OKX Connection Failed\n\n${result.message}`);
                    console.error('‚ùå [OKX] Connection test failed:', result);
                }
            } catch (error) {
                console.error('‚ùå [OKX] Connection test error:', error);
                alert(`‚ùå Connection Error: ${error.message}`);
            }
        }

        // Scan OKX Triangular Paths
        async function scanOKXTriangularPaths() {
            console.log('üîç [OKX] Starting path scan...');
            const apiKey = localStorage.getItem('okx_triangular_api');
            const apiSecret = localStorage.getItem('okx_triangular_secret');
            const passphrase = localStorage.getItem('okx_triangular_passphrase');

            if (!apiKey || !apiSecret || !passphrase) {
                alert('‚ùå Please configure your OKX API credentials in platform settings first.');
                console.log('‚ö†Ô∏è [OKX] API credentials missing');
                return;
            }

            // Gather enabled sets
            const enabledSets = [];
            for (let i = 1; i <= 5; i++) {
                const checkbox = document.getElementById(`okxSet${i}Enabled`);
                if (checkbox && checkbox.checked) {
                    enabledSets.push(i);
                }
            }

            console.log('üìä [OKX] Enabled path sets:', enabledSets);

            const profitThreshold = parseFloat(document.getElementById('okxProfitThreshold').value) || 0.5;
            console.log('üìà [OKX] Profit threshold:', profitThreshold, '%');

            try {
                console.log('üì° [OKX] Sending scan request to backend...');
                const response = await fetch('/api/v1/trading/okx/triangular/scan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({
                        apiKey: apiKey,
                        apiSecret: apiSecret,
                        passphrase: passphrase,
                        enabledSets: enabledSets,
                        profitThreshold: profitThreshold
                    })
                });

                const result = await response.json();
                console.log('‚úÖ [OKX] Scan response received:', result);

                if (result.success) {
                    const feedDiv = document.getElementById('okxLiveFeed');
                    const timestamp = new Date().toLocaleTimeString();

                    let feedMessage = `<div style="color: #00A6FF; margin-bottom: 8px;">[${timestamp}] Scan Complete</div>`;
                    feedMessage += `<div style="color: #b8c6db;">‚Ä¢ Scanned: ${result.data.scannedPaths} paths</div>`;
                    feedMessage += `<div style="color: #b8c6db;">‚Ä¢ Opportunities: ${result.data.opportunities.length}</div>`;
                    feedMessage += `<div style="color: #888; margin-top: 4px; font-size: 0.8rem;">${result.data.message}</div>`;

                    feedDiv.innerHTML = feedMessage + feedDiv.innerHTML;

                    if (result.data.opportunities.length > 0) {
                        alert(`üéØ Found ${result.data.opportunities.length} OKX arbitrage opportunities!`);
                    } else {
                        alert(`‚úÖ Scan complete. No opportunities above ${profitThreshold}% threshold found.`);
                    }
                } else {
                    alert(`‚ùå Scan Failed\n\n${result.message}`);
                    console.error('‚ùå [OKX] Scan failed:', result);
                }
            } catch (error) {
                console.error('‚ùå [OKX] Scan error:', error);
                alert(`‚ùå Scan Error: ${error.message}`);
            }
        }

        // View OKX Path Details
        function viewOKXPathDetails() {
            console.log('üìã [OKX] Displaying path details modal...');

            // Create modal overlay
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                backdrop-filter: blur(5px);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                padding: 20px;
                box-sizing: border-box;
            `;

            // Create modal content
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: linear-gradient(135deg, #1a1a2e 0%, #0a0a14 100%);
                border: 2px solid #00A6FF;
                border-radius: 15px;
                padding: 30px;
                max-width: 800px;
                max-height: 85vh;
                overflow-y: auto;
                box-shadow: 0 10px 50px rgba(0, 166, 255, 0.3);
            `;

            modalContent.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                    <h2 style="color: #00A6FF; margin: 0; font-size: 1.8rem;">üìã OKX Triangular Arbitrage Paths</h2>
                    <button id="closeModal" style="background: none; border: none; color: #ff6b6b; font-size: 2rem; cursor: pointer; padding: 0; line-height: 1;">&times;</button>
                </div>

                <div style="background: rgba(0,166,255,0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #00A6FF;">
                    <div style="color: #00A6FF; font-weight: bold; margin-bottom: 8px;">üìä Overview</div>
                    <div style="color: #b8c6db;">üí° Total: <strong style="color: #00A6FF;">32 paths</strong> (31 three-leg + 1 four-leg)</div>
                    <div style="color: #b8c6db;">üåâ Bridge: <strong style="color: #00A6FF;">USDT</strong> (Tether)</div>
                    <div style="color: #b8c6db;">üåç Exchange: <strong style="color: #00A6FF;">OKX</strong> (Major derivatives platform)</div>
                    <div style="color: #b8c6db;">üîê Auth: <strong style="color: #00A6FF;">API Key + Secret + Passphrase</strong></div>
                </div>

                <div style="background: rgba(255,215,0,0.05); padding: 20px; border-radius: 10px; margin-bottom: 15px; border: 1px solid rgba(255,215,0,0.3);">
                    <strong style="color: #ffd700; font-size: 1.1rem;">SET 1: Major ETH Bridge</strong>
                    <span style="color: #32cd32; font-size: 0.9rem; margin-left: 10px;">‚úÖ DEFAULT (7 paths)</span>
                    <div style="color: #b8c6db; margin-top: 12px; line-height: 1.8;">
                        1. USDT ‚Üí BTC ‚Üí ETH ‚Üí USDT<br>
                        2. USDT ‚Üí SOL ‚Üí ETH ‚Üí USDT<br>
                        3. USDT ‚Üí XRP ‚Üí ETH ‚Üí USDT<br>
                        4. USDT ‚Üí ADA ‚Üí ETH ‚Üí USDT<br>
                        5. USDT ‚Üí DOT ‚Üí ETH ‚Üí USDT<br>
                        6. USDT ‚Üí MATIC ‚Üí ETH ‚Üí USDT<br>
                        7. USDT ‚Üí LINK ‚Üí ETH ‚Üí USDT
                    </div>
                </div>

                <div style="background: rgba(50,205,50,0.05); padding: 20px; border-radius: 10px; margin-bottom: 15px; border: 1px solid rgba(50,205,50,0.3);">
                    <strong style="color: #32cd32; font-size: 1.1rem;">SET 2: Mid-Cap BTC Bridge</strong>
                    <span style="color: #32cd32; font-size: 0.9rem; margin-left: 10px;">‚úÖ DEFAULT (7 paths)</span>
                    <div style="color: #b8c6db; margin-top: 12px; line-height: 1.8;">
                        1. USDT ‚Üí ETH ‚Üí BTC ‚Üí USDT<br>
                        2. USDT ‚Üí SOL ‚Üí BTC ‚Üí USDT<br>
                        3. USDT ‚Üí AVAX ‚Üí BTC ‚Üí USDT<br>
                        4. USDT ‚Üí ATOM ‚Üí BTC ‚Üí USDT<br>
                        5. USDT ‚Üí LTC ‚Üí BTC ‚Üí USDT<br>
                        6. USDT ‚Üí UNI ‚Üí BTC ‚Üí USDT<br>
                        7. USDT ‚Üí FIL ‚Üí BTC ‚Üí USDT
                    </div>
                </div>

                <div style="background: rgba(0,212,255,0.05); padding: 20px; border-radius: 10px; margin-bottom: 15px; border: 1px solid rgba(0,212,255,0.3);">
                    <strong style="color: #00d4ff; font-size: 1.1rem;">SET 3: OKB Native Bridge</strong>
                    <span style="color: #888; font-size: 0.9rem; margin-left: 10px;">(6 paths)</span>
                    <div style="color: #b8c6db; margin-top: 12px; line-height: 1.8;">
                        1. USDT ‚Üí BTC ‚Üí OKB ‚Üí USDT<br>
                        2. USDT ‚Üí ETH ‚Üí OKB ‚Üí USDT<br>
                        3. USDT ‚Üí SOL ‚Üí OKB ‚Üí USDT<br>
                        4. USDT ‚Üí XRP ‚Üí OKB ‚Üí USDT<br>
                        5. USDT ‚Üí ADA ‚Üí OKB ‚Üí USDT<br>
                        6. USDT ‚Üí DOT ‚Üí OKB ‚Üí USDT
                    </div>
                </div>

                <div style="background: rgba(255,105,180,0.05); padding: 20px; border-radius: 10px; margin-bottom: 15px; border: 1px solid rgba(255,105,180,0.3);">
                    <strong style="color: #ff69b4; font-size: 1.1rem;">SET 4: High Volatility</strong>
                    <span style="color: #888; font-size: 0.9rem; margin-left: 10px;">(6 paths)</span>
                    <div style="color: #b8c6db; margin-top: 12px; line-height: 1.8;">
                        1. USDT ‚Üí DOGE ‚Üí ETH ‚Üí USDT<br>
                        2. USDT ‚Üí SHIB ‚Üí ETH ‚Üí USDT<br>
                        3. USDT ‚Üí PEPE ‚Üí ETH ‚Üí USDT<br>
                        4. USDT ‚Üí NEAR ‚Üí BTC ‚Üí USDT<br>
                        5. USDT ‚Üí APT ‚Üí BTC ‚Üí USDT<br>
                        6. USDT ‚Üí FTM ‚Üí BTC ‚Üí USDT
                    </div>
                </div>

                <div style="background: rgba(255,140,0,0.05); padding: 20px; border-radius: 10px; border: 1px solid rgba(255,140,0,0.3);">
                    <strong style="color: #ff8c00; font-size: 1.1rem;">SET 5: Extended Multi-Bridge</strong>
                    <span style="color: #888; font-size: 0.9rem; margin-left: 10px;">(6 paths)</span>
                    <div style="color: #b8c6db; margin-top: 12px; line-height: 1.8;">
                        1. USDT ‚Üí BTC ‚Üí ETH ‚Üí SOL ‚Üí USDT <span style="color: #ff8c00;">(4-leg)</span><br>
                        2. USDT ‚Üí ETH ‚Üí SOL ‚Üí USDT<br>
                        3. USDT ‚Üí SOL ‚Üí ETH ‚Üí USDT (reverse)<br>
                        4. USDT ‚Üí BTC ‚Üí SOL ‚Üí USDT<br>
                        5. USDT ‚Üí OKB ‚Üí ETH ‚Üí USDT <span style="color: #00A6FF;">(Native)</span><br>
                        6. USDT ‚Üí OKB ‚Üí BTC ‚Üí USDT <span style="color: #00A6FF;">(Native)</span>
                    </div>
                </div>
            `;

            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // Close modal on click outside or close button
            modal.addEventListener('click', function(e) {
                if (e.target === modal || e.target.id === 'closeModal') {
                    document.body.removeChild(modal);
                    console.log('üìã [OKX] Path details modal closed');
                }
            });

            console.log('‚úÖ [OKX] Path details modal displayed');
        }

        // Clear OKX Trade History
        async function clearOKXTriangularHistory() {
            console.log('üóëÔ∏è [OKX] Clearing trade history...');

            if (!confirm('‚ö†Ô∏è Are you sure you want to clear all OKX triangular trade history?')) {
                console.log('‚ùå [OKX] History clear cancelled by user');
                return;
            }

            try {
                console.log('üì° [OKX] Sending delete history request to backend...');
                const response = await fetch('/api/v1/trading/okx/triangular/history', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });

                const result = await response.json();
                console.log('‚úÖ [OKX] Delete history response received:', result);

                if (result.success) {
                    alert(`‚úÖ Cleared ${result.data.deletedCount} OKX trades from history`);
                    document.getElementById('okxLiveFeed').innerHTML = '<div style="color: #888;">Trade history cleared. Waiting for scan results...</div>';
                } else {
                    alert(`‚ùå Failed to clear history\n\n${result.message}`);
                    console.error('‚ùå [OKX] Clear history failed:', result);
                }
            } catch (error) {
                console.error('‚ùå [OKX] Clear history error:', error);
                alert(`‚ùå Error: ${error.message}`);
            }
        }

        // Save OKX Triangular Settings
        function saveOKXTriangularSettings() {
            console.log('üíæ [OKX] Saving settings to localStorage...');

            const maxTrade = document.getElementById('okxMaxTrade').value;
            const portfolioPercent = document.getElementById('okxPortfolioPercent').value;
            const profitThreshold = document.getElementById('okxProfitThreshold').value;

            // Save settings
            const settings = {
                maxTrade: maxTrade,
                portfolioPercent: portfolioPercent,
                profitThreshold: profitThreshold
            };

            // Save path set preferences
            for (let i = 1; i <= 5; i++) {
                const checkbox = document.getElementById(`okxSet${i}Enabled`);
                if (checkbox) {
                    settings[`set${i}Enabled`] = checkbox.checked;
                }
            }

            localStorage.setItem('okxTriangularSettings', JSON.stringify(settings));
            console.log('‚úÖ [OKX] Settings saved:', settings);
        }

        // Load OKX Triangular Settings
        function loadOKXTriangularSettings() {
            console.log('üì• [OKX] Loading settings from localStorage...');

            // Load settings
            const settingsJson = localStorage.getItem('okxTriangularSettings');
            if (settingsJson) {
                try {
                    const settings = JSON.parse(settingsJson);
                    console.log('‚úÖ [OKX] Settings loaded:', settings);

                    if (settings.maxTrade) document.getElementById('okxMaxTrade').value = settings.maxTrade;
                    if (settings.portfolioPercent) document.getElementById('okxPortfolioPercent').value = settings.portfolioPercent;
                    if (settings.profitThreshold) document.getElementById('okxProfitThreshold').value = settings.profitThreshold;

                    // Load path set preferences
                    for (let i = 1; i <= 5; i++) {
                        const checkbox = document.getElementById(`okxSet${i}Enabled`);
                        if (checkbox && settings.hasOwnProperty(`set${i}Enabled`)) {
                            checkbox.checked = settings[`set${i}Enabled`];
                        }
                    }
                } catch (error) {
                    console.error('‚ùå [OKX] Failed to parse settings:', error);
                }
            }

            // Load toggle state
            const toggleEnabled = localStorage.getItem('okxTriangularEnabled') === 'true';
            const toggle = document.getElementById('okxTriangularEnabled');
            const status = document.getElementById('okxTriangularStatus');

            if (toggleEnabled) {
                toggle.classList.add('active');
                status.textContent = 'ON';
                status.style.color = '#00A6FF';
                console.log('‚úÖ [OKX] Live trading enabled (from localStorage)');
            } else {
                console.log('‚ÑπÔ∏è [OKX] Live trading disabled (from localStorage)');
            }
        }

        // ============================================================================
        // KUCOIN TRIANGULAR ARBITRAGE FUNCTIONS
        // ============================================================================

        // Balance tracking (USDT only for KuCoin triangular)
        let kucoinBalanceTracking = {
            startingUSDT: null,
            currentUSDT: 0
        };

        // Initialize KuCoin balance on page load
        async function initializeKuCoinBalance(apiKey, apiSecret, passphrase) {
            try {
                const response = await fetch('/api/v1/trading/kucoin/balance', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ apiKey, apiSecret, passphrase })
                });

                const result = await response.json();
                console.log('üí∞ [KUCOIN Balance] API Response:', result);

                if (result.success && result.data && result.data.balances) {
                    const balances = result.data.balances;
                    const currentUSDT = balances.USDT ? parseFloat(balances.USDT) : 0;

                    // Check if starting balance is already set
                    const stored = localStorage.getItem('kucoinStartingBalance');
                    if (stored) {
                        const parsed = JSON.parse(stored);
                        kucoinBalanceTracking.startingUSDT = parsed.usdt;
                    } else {
                        // First time - set current as starting
                        kucoinBalanceTracking.startingUSDT = currentUSDT;
                        localStorage.setItem('kucoinStartingBalance', JSON.stringify({
                            usdt: currentUSDT
                        }));
                    }

                    kucoinBalanceTracking.currentUSDT = currentUSDT;
                    updateKuCoinBalanceDisplay();
                    console.log('‚úÖ [KUCOIN Balance] Initialized:', kucoinBalanceTracking);
                }
            } catch (error) {
                console.error('‚ùå [KUCOIN Balance] Failed to initialize:', error);
            }
        }

        // Update KuCoin balance
        async function updateKuCoinBalance(apiKey, apiSecret, passphrase) {
            try {
                const response = await fetch('/api/v1/trading/kucoin/balance', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ apiKey, apiSecret, passphrase })
                });

                const result = await response.json();

                if (result.success && result.data && result.data.balances) {
                    const balances = result.data.balances;
                    kucoinBalanceTracking.currentUSDT = balances.USDT ? parseFloat(balances.USDT) : 0;
                    updateKuCoinBalanceDisplay();
                    console.log('üí∞ [KUCOIN Balance] Updated:', kucoinBalanceTracking.currentUSDT.toFixed(2));
                }
            } catch (error) {
                console.error('‚ùå [KUCOIN Balance] Update failed:', error);
            }
        }

        function toggleKuCoinTriangular() {
            const toggle = document.getElementById('kucoinTriangularEnabled');
            const status = document.getElementById('kucoinTriangularStatus');
            const isActive = toggle.classList.toggle('active');

            if (isActive) {
                status.textContent = 'ON';
                status.style.color = '#00D092';
                localStorage.setItem('kucoinTriangularEnabled', 'true');
                console.log('‚úÖ [KUCOIN] Live triangular trading enabled');
            } else {
                status.textContent = 'OFF';
                status.style.color = '#ff6b6b';
                localStorage.setItem('kucoinTriangularEnabled', 'false');
                console.log('‚è∏Ô∏è [KUCOIN] Live triangular trading disabled');
            }
        }

        async function testKuCoinTriangularConnection() {
            console.log('üîç [KUCOIN] Testing connection...');

            const apiKey = localStorage.getItem('kucoin_triangular_api');
            const apiSecret = localStorage.getItem('kucoin_triangular_secret');
            const passphrase = localStorage.getItem('kucoin_triangular_passphrase');

            if (!apiKey || !apiSecret || !passphrase) {
                alert('‚ùå Please configure your KuCoin API credentials in platform settings first.');
                return;
            }

            try {
                const response = await fetch('/api/v1/trading/kucoin/triangular/test-connection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({ apiKey, apiSecret, passphrase })
                });

                const data = await response.json();

                if (data.success) {
                    // Initialize balance tracking on successful connection
                    await initializeKuCoinBalance(apiKey, apiSecret, passphrase);

                    alert(`‚úÖ KuCoin Connection Successful!\n\nAccount Type: ${data.accountType}\nBalance Initialized: ${kucoinBalanceTracking.currentUSDT?.toFixed(2) || '0.00'} USDT\nTimestamp: ${new Date(data.timestamp).toLocaleString()}`);
                    console.log('‚úÖ [KUCOIN] Connection test passed:', data);
                } else {
                    alert(`‚ùå Connection Failed: ${data.message}`);
                    console.error('‚ùå [KUCOIN] Connection test failed:', data);
                }
            } catch (error) {
                console.error('‚ùå [KUCOIN] Connection test error:', error);
                alert('‚ùå Connection test failed. Check console for details.');
            }
        }

        async function scanKuCoinTriangularPaths() {
            console.log('üîç [KUCOIN] Starting scan for triangular arbitrage opportunities...');

            const apiKey = localStorage.getItem('kucoin_triangular_api');
            const apiSecret = localStorage.getItem('kucoin_triangular_secret');
            const passphrase = localStorage.getItem('kucoin_triangular_passphrase');

            if (!apiKey || !apiSecret || !passphrase) {
                alert('‚ùå Please configure your KuCoin API credentials in platform settings first.');
                return;
            }

            // Update balance before scanning
            await updateKuCoinBalance(apiKey, apiSecret, passphrase);

            const maxTradeAmount = parseFloat(document.getElementById('kucoinMaxTrade').value);
            const profitThreshold = parseFloat(document.getElementById('kucoinProfitThreshold').value);
            const portfolioPercent = parseFloat(document.getElementById('kucoinPortfolioPercent').value);
            const currentBalance = kucoinBalanceTracking.currentUSDT || 0;

            const enabledSets = {
                SET_1_ESSENTIAL_ETH_BRIDGE: document.getElementById('kucoinSet1Enabled').checked,
                SET_2_MIDCAP_BTC_BRIDGE: document.getElementById('kucoinSet2Enabled').checked,
                SET_3_KCS_NATIVE_BRIDGE: document.getElementById('kucoinSet3Enabled').checked,
                SET_4_HIGH_VOLATILITY: document.getElementById('kucoinSet4Enabled').checked,
                SET_5_EXTENDED_MULTIBRIDGE: document.getElementById('kucoinSet5Enabled').checked
            };

            try {
                const response = await fetch('/api/v1/trading/kucoin/triangular/scan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({
                        apiKey,
                        apiSecret,
                        passphrase,
                        maxTradeAmount,
                        profitThreshold,
                        portfolioPercent: portfolioPercent,
                        currentBalance: currentBalance,
                        paths: enabledSets
                    })
                });

                const result = await response.json();

                if (result.success) {
                    const data = result.data;
                    console.log(`‚úÖ [KUCOIN] Scan complete: ${data.opportunities.length} opportunities found`);

                    // Log portfolio calculation details
                    if (data.portfolioCalculation) {
                        const calc = data.portfolioCalculation;
                        console.log(`üí∞ [KUCOIN Portfolio] Balance: ${calc.balance.toFixed(2)} USDT`);
                        console.log(`üí∞ [KUCOIN Portfolio] ${calc.portfolioPercent}% = ${calc.portfolioAmount} USDT, Cap: ${calc.appliedCap}, Can Trade: ${calc.canTrade}`);
                    }

                    // Display warnings (non-blocking)
                    if (data.warnings && data.warnings.length > 0) {
                        data.warnings.forEach(warning => {
                            console.warn(`‚ö†Ô∏è [KUCOIN Portfolio] ${warning}`);
                        });
                    }

                    const container = document.getElementById('kucoinOpportunities');

                    if (data.opportunities.length === 0) {
                        container.innerHTML = `
                            <p style="color: #888; text-align: center; padding: 20px;">
                                No profitable opportunities found above ${profitThreshold}% threshold.<br>
                                Try lowering the profit threshold or enabling more path sets.
                            </p>
                        `;
                    } else {
                        let html = '<div style="display: flex; flex-direction: column; gap: 15px;">';

                        data.opportunities.slice(0, 10).forEach((opp, index) => {
                            html += `
                                <div style="background: rgba(0,208,146,0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #00D092;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                        <strong style="color: #00D092;">${opp.path?.sequence || opp.id}</strong>
                                        <span style="background: #00D092; color: white; padding: 4px 12px; border-radius: 12px; font-weight: 600;">
                                            +${opp.profitPercentage?.toFixed(2) || 0}%
                                        </span>
                                    </div>
                                    <div style="font-size: 0.9rem; color: #b8c6db;">
                                        <div>Path: ${opp.path?.path?.join(' ‚Üí ') || 'N/A'}</div>
                                        <div>Initial: $${opp.startAmount?.toFixed(2) || 0} USDT ‚Üí Final: $${opp.endAmount?.toFixed(2) || 0} USDT</div>
                                        <div>Profit: $${opp.profitAmount?.toFixed(2) || 0} USDT</div>
                                        <div style="font-size: 0.8rem; color: #888; margin-top: 5px;">${opp.path?.id || opp.id}</div>
                                    </div>
                                </div>
                            `;
                        });

                        if (data.opportunities.length > 10) {
                            html += `<p style="text-align: center; color: #888; font-size: 0.9rem;">Showing top 10 of ${data.opportunities.length} opportunities</p>`;
                        }

                        html += '</div>';
                        container.innerHTML = html;
                    }

                    alert(`‚úÖ Scan Complete!\n\nTotal Scanned: ${data.scannedPaths} paths\nProfitable: ${data.opportunities.length} opportunities\nBest: ${data.opportunities[0]?.profitPercentage?.toFixed(2) || 0}%`);
                } else {
                    alert(`‚ùå Scan Failed: ${data.message}`);
                    console.error('‚ùå [KUCOIN] Scan failed:', data);
                }
            } catch (error) {
                console.error('‚ùå [KUCOIN] Scan error:', error);
                alert('‚ùå Scan failed. Check console for details.');
            }
        }

        function viewKuCoinPathDetails() {
            console.log('üìã [KUCOIN] Opening paths modal');

            // Create modal overlay
            const modal = document.createElement('div');
            modal.id = 'kucoinPathsModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.85);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                backdrop-filter: blur(5px);
            `;

            // Create modal content
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
                border: 2px solid #00D092;
                border-radius: 15px;
                padding: 30px;
                max-width: 900px;
                max-height: 85vh;
                overflow-y: auto;
                box-shadow: 0 10px 50px rgba(0,208,146,0.3);
                position: relative;
            `;

            modalContent.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid rgba(0,208,146,0.3); padding-bottom: 15px;">
                    <h2 style="color: #00D092; margin: 0; font-size: 1.8rem;">üìã KuCoin Triangular Arbitrage Paths</h2>
                    <button onclick="document.getElementById('kucoinPathsModal').remove()" style="background: rgba(255,255,255,0.1); border: 1px solid #00D092; color: #00D092; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-size: 1.2rem; font-weight: bold;">‚úï</button>
                </div>

                <div style="background: rgba(0,208,146,0.1); padding: 15px; border-radius: 10px; margin-bottom: 25px; border-left: 4px solid #00D092;">
                    <p style="color: #b8c6db; margin: 0; font-size: 0.95rem;">
                        <strong style="color: #00D092;">32 Triangular Arbitrage Paths</strong> organized in 5 sets.
                        <br><br>
                        üåâ <strong>Bridge Currencies:</strong> ETH (Set 1), BTC (Set 2), KCS (Set 3), Mixed (Sets 4-5)
                        <br>
                        üí∞ <strong>Base Currency:</strong> USDT (Tether) - Fund KuCoin with USDT only
                        <br>
                        üí° <strong>Default:</strong> Sets 1-2 enabled (14 paths) | Enable Sets 3-5 for 18 additional paths
                    </p>
                </div>

                <!-- SET 1 -->
                <div style="background: rgba(0,255,127,0.1); padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #00ff7f;">
                    <h3 style="color: #00ff7f; margin: 0 0 15px 0;">SET 1: ESSENTIAL ETH BRIDGE (7 paths) ‚úÖ DEFAULT</h3>
                    <div style="display: grid; grid-template-columns: 1fr; gap: 8px; font-size: 0.9rem;">
                        <div style="color: #b8c6db;">1. USDT ‚Üí ETH ‚Üí BTC ‚Üí USDT</div>
                        <div style="color: #b8c6db;">2. USDT ‚Üí ETH ‚Üí SOL ‚Üí USDT</div>
                        <div style="color: #b8c6db;">3. USDT ‚Üí ETH ‚Üí XRP ‚Üí USDT</div>
                        <div style="color: #b8c6db;">4. USDT ‚Üí ETH ‚Üí ADA ‚Üí USDT</div>
                        <div style="color: #b8c6db;">5. USDT ‚Üí ETH ‚Üí DOT ‚Üí USDT</div>
                        <div style="color: #b8c6db;">6. USDT ‚Üí ETH ‚Üí MATIC ‚Üí USDT</div>
                        <div style="color: #b8c6db;">7. USDT ‚Üí ETH ‚Üí LINK ‚Üí USDT</div>
                    </div>
                </div>

                <!-- SET 2 -->
                <div style="background: rgba(0,208,146,0.1); padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #00D092;">
                    <h3 style="color: #00D092; margin: 0 0 15px 0;">SET 2: MIDCAP BTC BRIDGE (7 paths) ‚úÖ DEFAULT</h3>
                    <div style="display: grid; grid-template-columns: 1fr; gap: 8px; font-size: 0.9rem;">
                        <div style="color: #b8c6db;">1. USDT ‚Üí BTC ‚Üí ETH ‚Üí USDT</div>
                        <div style="color: #b8c6db;">2. USDT ‚Üí BTC ‚Üí SOL ‚Üí USDT</div>
                        <div style="color: #b8c6db;">3. USDT ‚Üí BTC ‚Üí AVAX ‚Üí USDT</div>
                        <div style="color: #b8c6db;">4. USDT ‚Üí BTC ‚Üí ATOM ‚Üí USDT</div>
                        <div style="color: #b8c6db;">5. USDT ‚Üí BTC ‚Üí LTC ‚Üí USDT</div>
                        <div style="color: #b8c6db;">6. USDT ‚Üí BTC ‚Üí UNI ‚Üí USDT</div>
                        <div style="color: #b8c6db;">7. USDT ‚Üí BTC ‚Üí FIL ‚Üí USDT</div>
                    </div>
                </div>

                <!-- SET 3 -->
                <div style="background: rgba(0,191,255,0.1); padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #00bfff;">
                    <h3 style="color: #00bfff; margin: 0 0 15px 0;">SET 3: KCS NATIVE BRIDGE (6 paths)</h3>
                    <div style="display: grid; grid-template-columns: 1fr; gap: 8px; font-size: 0.9rem;">
                        <div style="color: #b8c6db;">1. USDT ‚Üí KCS ‚Üí BTC ‚Üí USDT</div>
                        <div style="color: #b8c6db;">2. USDT ‚Üí KCS ‚Üí ETH ‚Üí USDT</div>
                        <div style="color: #b8c6db;">3. USDT ‚Üí KCS ‚Üí SOL ‚Üí USDT</div>
                        <div style="color: #b8c6db;">4. USDT ‚Üí KCS ‚Üí XRP ‚Üí USDT</div>
                        <div style="color: #b8c6db;">5. USDT ‚Üí KCS ‚Üí ADA ‚Üí USDT</div>
                        <div style="color: #b8c6db;">6. USDT ‚Üí KCS ‚Üí DOT ‚Üí USDT</div>
                    </div>
                </div>

                <!-- SET 4 -->
                <div style="background: rgba(255,215,0,0.1); padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #ffd700;">
                    <h3 style="color: #ffd700; margin: 0 0 15px 0;">SET 4: HIGH VOLATILITY (6 paths)</h3>
                    <div style="display: grid; grid-template-columns: 1fr; gap: 8px; font-size: 0.9rem;">
                        <div style="color: #b8c6db;">1. USDT ‚Üí DOGE ‚Üí BTC ‚Üí USDT <span style="color: #888;">(Meme)</span></div>
                        <div style="color: #b8c6db;">2. USDT ‚Üí SHIB ‚Üí ETH ‚Üí USDT <span style="color: #888;">(Meme)</span></div>
                        <div style="color: #b8c6db;">3. USDT ‚Üí PEPE ‚Üí ETH ‚Üí USDT <span style="color: #888;">(Meme)</span></div>
                        <div style="color: #b8c6db;">4. USDT ‚Üí NEAR ‚Üí BTC ‚Üí USDT <span style="color: #888;">(Layer1)</span></div>
                        <div style="color: #b8c6db;">5. USDT ‚Üí APT ‚Üí ETH ‚Üí USDT <span style="color: #888;">(Layer1)</span></div>
                        <div style="color: #b8c6db;">6. USDT ‚Üí FTM ‚Üí BTC ‚Üí USDT <span style="color: #888;">(DeFi)</span></div>
                    </div>
                </div>

                <!-- SET 5 -->
                <div style="background: rgba(138,43,226,0.1); padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #8a2be2;">
                    <h3 style="color: #8a2be2; margin: 0 0 15px 0;">SET 5: EXTENDED MULTIBRIDGE (6 paths)</h3>
                    <div style="display: grid; grid-template-columns: 1fr; gap: 8px; font-size: 0.9rem;">
                        <div style="color: #b8c6db;">1. USDT ‚Üí BNB ‚Üí ETH ‚Üí USDT</div>
                        <div style="color: #b8c6db;">2. USDT ‚Üí TRX ‚Üí BTC ‚Üí USDT</div>
                        <div style="color: #b8c6db;">3. USDT ‚Üí ALGO ‚Üí ETH ‚Üí USDT</div>
                        <div style="color: #b8c6db;">4. USDT ‚Üí VET ‚Üí BTC ‚Üí USDT</div>
                        <div style="color: #b8c6db;">5. USDT ‚Üí HBAR ‚Üí ETH ‚Üí USDT</div>
                        <div style="color: #b8c6db;">6. USDT ‚Üí BTC ‚Üí ETH ‚Üí SOL ‚Üí USDT <span style="color: #888;">(4-leg)</span></div>
                    </div>
                </div>

                <div style="background: rgba(0,208,146,0.1); padding: 12px; border-radius: 8px; text-align: center; margin-top: 20px; border: 1px solid rgba(0,208,146,0.3);">
                    <p style="color: #b8c6db; margin: 0; font-size: 0.9rem;">
                        üí° <strong style="color: #00D092;">Tip:</strong> Enable/disable path sets in the settings above to control which opportunities are scanned.
                    </p>
                </div>
            `;

            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // Close on outside click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });

            console.log('‚úÖ [KUCOIN] Paths modal opened');
        }

        async function clearKuCoinTriangularHistory() {
            if (!confirm('‚ö†Ô∏è Are you sure you want to clear ALL KuCoin triangular trade history? This cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch('/api/v1/trading/kucoin/triangular/history', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    alert(`‚úÖ ${data.message}`);
                    console.log('‚úÖ [KUCOIN] History cleared:', data);
                } else {
                    alert(`‚ùå Failed to clear history: ${data.message}`);
                }
            } catch (error) {
                console.error('‚ùå [KUCOIN] Clear history error:', error);
                alert('‚ùå Failed to clear history. Check console for details.');
            }
        }

        function saveKuCoinTriangularSettings() {
            console.log('üíæ [KUCOIN] Saving settings to localStorage...');

            const maxTrade = document.getElementById('kucoinMaxTrade').value;
            const portfolioPercent = document.getElementById('kucoinPortfolioPercent').value;
            const profitThreshold = document.getElementById('kucoinProfitThreshold').value;

            const settings = {
                maxTrade: maxTrade,
                portfolioPercent: portfolioPercent,
                profitThreshold: profitThreshold,
                set1Enabled: document.getElementById('kucoinSet1Enabled').checked,
                set2Enabled: document.getElementById('kucoinSet2Enabled').checked,
                set3Enabled: document.getElementById('kucoinSet3Enabled').checked,
                set4Enabled: document.getElementById('kucoinSet4Enabled').checked,
                set5Enabled: document.getElementById('kucoinSet5Enabled').checked
            };

            localStorage.setItem('kucoinTriangularSettings', JSON.stringify(settings));
            console.log('‚úÖ [KUCOIN] Settings saved:', settings);
        }

        function loadKuCoinTriangularSettings() {
            console.log('üì• [KUCOIN] Loading settings from localStorage...');

            // Load settings
            const settingsJson = localStorage.getItem('kucoinTriangularSettings');
            if (settingsJson) {
                try {
                    const settings = JSON.parse(settingsJson);
                    console.log('‚úÖ [KUCOIN] Settings loaded:', settings);

                    if (settings.maxTrade) document.getElementById('kucoinMaxTrade').value = settings.maxTrade;
                    if (settings.portfolioPercent) document.getElementById('kucoinPortfolioPercent').value = settings.portfolioPercent;
                    if (settings.profitThreshold) document.getElementById('kucoinProfitThreshold').value = settings.profitThreshold;

                    // Load path set preferences
                    for (let i = 1; i <= 5; i++) {
                        const checkbox = document.getElementById(`kucoinSet${i}Enabled`);
                        if (checkbox && settings.hasOwnProperty(`set${i}Enabled`)) {
                            checkbox.checked = settings[`set${i}Enabled`];
                        }
                    }
                } catch (error) {
                    console.error('‚ùå [KUCOIN] Failed to parse settings:', error);
                }
            }

            // Load toggle state
            const toggleEnabled = localStorage.getItem('kucoinTriangularEnabled') === 'true';
            const toggle = document.getElementById('kucoinTriangularEnabled');
            const status = document.getElementById('kucoinTriangularStatus');

            if (toggleEnabled) {
                toggle.classList.add('active');
                status.textContent = 'ON';
                status.style.color = '#00D092';
                console.log('‚úÖ [KUCOIN] Live trading enabled (from localStorage)');
            } else {
                console.log('‚ÑπÔ∏è [KUCOIN] Live trading disabled (from localStorage)');
            }
        }

        // Update KuCoin balance display
        function updateKuCoinBalanceDisplay() {
            // Update starting balance
            document.getElementById('kucoinStartingUSDT').textContent = `$${kucoinBalanceTracking.startingUSDT?.toFixed(2) || '0.00'}`;

            // Update current balance
            document.getElementById('kucoinCurrentUSDT').textContent = `$${kucoinBalanceTracking.currentUSDT.toFixed(2)}`;

            // Calculate and update change
            if (kucoinBalanceTracking.startingUSDT !== null) {
                const change = kucoinBalanceTracking.currentUSDT - kucoinBalanceTracking.startingUSDT;
                const changePercent = kucoinBalanceTracking.startingUSDT > 0
                    ? ((change / kucoinBalanceTracking.startingUSDT) * 100).toFixed(2)
                    : '0.00';

                const changeSign = change >= 0 ? '+' : '';
                const changeColor = change >= 0 ? '#00D092' : '#ff4444';

                const changeElement = document.getElementById('kucoinChangeUSDT');
                changeElement.textContent = `${changeSign}$${change.toFixed(2)} (${changeSign}${changePercent}%)`;
                changeElement.style.color = changeColor;
            }

            // Update last update time
            document.getElementById('kucoinBalanceLastUpdate').textContent = new Date().toLocaleString();
        }

        // Reset KuCoin starting balance to current balance
        function resetKuCoinStartingBalance() {
            const confirm = window.confirm('Reset starting balance to current balance?\n\nThis will use the current balance as the new baseline for profit/loss tracking.');

            if (!confirm) return;

            // Get current balance
            const currentUSDT = kucoinBalanceTracking.currentUSDT;

            // Set as new starting balance
            kucoinBalanceTracking.startingUSDT = currentUSDT;

            // Save to localStorage
            localStorage.setItem('kucoinStartingBalance', JSON.stringify({
                usdt: currentUSDT
            }));

            // Update display
            updateKuCoinBalanceDisplay();

            console.log('‚úÖ [KUCOIN] Starting balance reset:', kucoinBalanceTracking);
        }

        // Switch KuCoin tabs
        function switchKuCoinTab(tabName) {
            // Hide all content
            document.getElementById('kucoinBalanceContent').style.display = 'none';
            document.getElementById('kucoinTradingContent').style.display = 'none';

            // Reset button styles
            document.getElementById('kucoinBalanceTab').style.background = 'rgba(255,255,255,0.05)';
            document.getElementById('kucoinBalanceTab').style.color = '#b8c6db';
            document.getElementById('kucoinTradingTab').style.background = 'rgba(255,255,255,0.05)';
            document.getElementById('kucoinTradingTab').style.color = '#b8c6db';

            // Show selected content and activate button
            if (tabName === 'balance') {
                document.getElementById('kucoinBalanceContent').style.display = 'block';
                document.getElementById('kucoinBalanceTab').style.background = 'rgba(0,208,146,0.3)';
                document.getElementById('kucoinBalanceTab').style.color = '#00D092';
            } else if (tabName === 'trading') {
                document.getElementById('kucoinTradingContent').style.display = 'block';
                document.getElementById('kucoinTradingTab').style.background = 'rgba(0,208,146,0.3)';
                document.getElementById('kucoinTradingTab').style.color = '#00D092';
            }

            console.log(`üîÑ [KUCOIN] Switched to ${tabName} tab`);
        }

        // Initialize OKX settings on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ [OKX] Initializing triangular arbitrage settings...');
            loadOKXTriangularSettings();

            // Add event listeners for OKX inputs (auto-save)
            const okxInputs = document.querySelectorAll('#okxMaxTrade, #okxPortfolioPercent, #okxProfitThreshold');
            okxInputs.forEach(input => {
                input.addEventListener('change', saveOKXTriangularSettings);
            });

            // Add event listeners for OKX checkboxes (5 sets)
            for (let i = 1; i <= 5; i++) {
                const checkbox = document.getElementById(`okxSet${i}Enabled`);
                if (checkbox) {
                    checkbox.addEventListener('change', saveOKXTriangularSettings);
                }
            }
        });

        // Initialize KuCoin settings on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ [KUCOIN] Initializing triangular arbitrage settings...');
            loadKuCoinTriangularSettings();

            // Add event listeners for KuCoin inputs (auto-save)
            const kucoinInputs = document.querySelectorAll('#kucoinMaxTrade, #kucoinPortfolioPercent, #kucoinProfitThreshold');
            kucoinInputs.forEach(input => {
                input.addEventListener('change', saveKuCoinTriangularSettings);
            });

            // Add event listeners for KuCoin checkboxes (5 sets)
            for (let i = 1; i <= 5; i++) {
                const checkbox = document.getElementById(`kucoinSet${i}Enabled`);
                if (checkbox) {
                    checkbox.addEventListener('change', saveKuCoinTriangularSettings);
                }
            }
        });

        // ============================================================================
        // COINBASE TRIANGULAR ARBITRAGE FUNCTIONS
        // ============================================================================

        function toggleCoinbaseTriangular() {
            const toggle = document.getElementById('coinbaseTriangularEnabled');
            const status = document.getElementById('coinbaseTriangularStatus');
            const isActive = toggle.classList.toggle('active');

            if (isActive) {
                status.textContent = 'ON';
                status.style.color = '#0052FF';
                localStorage.setItem('coinbaseTriangularEnabled', 'true');
                console.log('‚úÖ [COINBASE] Live triangular trading enabled');
            } else {
                status.textContent = 'OFF';
                status.style.color = '#ff6b6b';
                localStorage.setItem('coinbaseTriangularEnabled', 'false');
                console.log('‚è∏Ô∏è [COINBASE] Live triangular trading disabled');
            }
        }

        async function testCoinbaseTriangularConnection() {
            console.log('üîç [COINBASE] Testing connection...');

            const apiKey = localStorage.getItem('coinbase_triangular_api');
            const apiSecret = localStorage.getItem('coinbase_triangular_secret');

            if (!apiKey || !apiSecret) {
                alert('‚ùå Please configure your Coinbase API credentials (EC Private Key) in platform settings first.');
                return;
            }

            try {
                const response = await fetch('/api/v1/trading/coinbase/triangular/test-connection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({ apiKey, apiSecret })
                });

                const data = await response.json();

                if (data.success) {
                    alert(`‚úÖ Coinbase Connection Successful!\n\nAccounts: ${data.accountsCount}\nTimestamp: ${new Date(data.timestamp).toLocaleString()}`);
                    console.log('‚úÖ [COINBASE] Connection test passed:', data);
                } else {
                    alert(`‚ùå Connection Failed: ${data.message}`);
                    console.error('‚ùå [COINBASE] Connection test failed:', data);
                }
            } catch (error) {
                console.error('‚ùå [COINBASE] Connection test error:', error);
                alert('‚ùå Connection test failed. Check console for details.');
            }
        }

        async function scanCoinbaseTriangularPaths() {
            console.log('üîç [COINBASE] Starting scan for triangular arbitrage opportunities...');

            const apiKey = localStorage.getItem('coinbase_triangular_api');
            const apiSecret = localStorage.getItem('coinbase_triangular_secret');

            if (!apiKey || !apiSecret) {
                alert('‚ùå Please configure your Coinbase API credentials in platform settings first.');
                return;
            }

            const maxTradeAmount = parseFloat(document.getElementById('coinbaseMaxTrade').value);
            const profitThreshold = parseFloat(document.getElementById('coinbaseProfitThreshold').value);

            const enabledSets = {
                SET_1_ESSENTIAL_ETH_BRIDGE: document.getElementById('coinbaseSet1Enabled').checked,
                SET_2_MIDCAP_BTC_BRIDGE: document.getElementById('coinbaseSet2Enabled').checked,
                SET_3_DEFI_NATIVE: document.getElementById('coinbaseSet3Enabled').checked,
                SET_4_HIGH_VOLATILITY: document.getElementById('coinbaseSet4Enabled').checked,
                SET_5_EXTENDED_MULTIBRIDGE: document.getElementById('coinbaseSet5Enabled').checked
            };

            try {
                const response = await fetch('/api/v1/trading/coinbase/triangular/scan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({
                        apiKey,
                        apiSecret,
                        maxTradeAmount,
                        profitThreshold,
                        enabledSets
                    })
                });

                const data = await response.json();

                if (data.success) {
                    console.log(`‚úÖ [COINBASE] Scan complete: ${data.profitableCount} opportunities found`);

                    const container = document.getElementById('coinbaseOpportunities');

                    if (data.opportunities.length === 0) {
                        container.innerHTML = `
                            <p style="color: #888; text-align: center; padding: 20px;">
                                No profitable opportunities found above ${profitThreshold}% threshold.<br>
                                Try lowering the profit threshold or enabling more path sets.
                            </p>
                        `;
                    } else {
                        let html = '<div style="display: flex; flex-direction: column; gap: 15px;">';

                        data.opportunities.slice(0, 10).forEach((opp, index) => {
                            html += `
                                <div style="background: rgba(0,82,255,0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #0052FF;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                        <strong style="color: #0052FF;">${opp.description}</strong>
                                        <span style="background: #0052FF; color: white; padding: 4px 12px; border-radius: 12px; font-weight: 600;">
                                            +${opp.profitPercent}%
                                        </span>
                                    </div>
                                    <div style="font-size: 0.9rem; color: #b8c6db;">
                                        <div>Path: ${opp.path.join(' ‚Üí ')}</div>
                                        <div>Initial: $${opp.initialAmount} USDC ‚Üí Final: $${opp.finalAmount.toFixed(2)} USDC</div>
                                        <div>Profit: $${opp.profitAmount.toFixed(2)} USDC</div>
                                        <div style="font-size: 0.8rem; color: #888; margin-top: 5px;">${opp.pathId}</div>
                                    </div>
                                </div>
                            `;
                        });

                        if (data.opportunities.length > 10) {
                            html += `<p style="text-align: center; color: #888; font-size: 0.9rem;">Showing top 10 of ${data.opportunities.length} opportunities</p>`;
                        }

                        html += '</div>';
                        container.innerHTML = html;
                    }

                    alert(`‚úÖ Scan Complete!\n\nTotal Scanned: ${data.totalScanned} paths\nProfitable: ${data.profitableCount} opportunities\nBest: ${data.opportunities[0]?.profitPercent || 0}%\n\nFunding: USDC`);
                } else {
                    alert(`‚ùå Scan Failed: ${data.message}`);
                    console.error('‚ùå [COINBASE] Scan failed:', data);
                }
            } catch (error) {
                console.error('‚ùå [COINBASE] Scan error:', error);
                alert('‚ùå Scan failed. Check console for details.');
            }
        }

        function viewCoinbasePathDetails() {
            console.log('üìã [COINBASE] Viewing all triangular path details...');

            const pathDetails = `
üìã COINBASE Triangular Arbitrage Paths (32 Total) - USDC BRIDGE

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
SET 1: ESSENTIAL ETH BRIDGE (7 paths) ‚úì
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
1. USDC ‚Üí ETH ‚Üí BTC ‚Üí USDC
2. USDC ‚Üí ETH ‚Üí SOL ‚Üí USDC
3. USDC ‚Üí ETH ‚Üí XRP ‚Üí USDC
4. USDC ‚Üí ETH ‚Üí ADA ‚Üí USDC
5. USDC ‚Üí ETH ‚Üí DOT ‚Üí USDC
6. USDC ‚Üí ETH ‚Üí MATIC ‚Üí USDC
7. USDC ‚Üí ETH ‚Üí LINK ‚Üí USDC

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
SET 2: MIDCAP BTC BRIDGE (7 paths) ‚úì
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
1. USDC ‚Üí BTC ‚Üí ETH ‚Üí USDC
2. USDC ‚Üí BTC ‚Üí SOL ‚Üí USDC
3. USDC ‚Üí BTC ‚Üí AVAX ‚Üí USDC
4. USDC ‚Üí BTC ‚Üí ATOM ‚Üí USDC
5. USDC ‚Üí BTC ‚Üí LTC ‚Üí USDC
6. USDC ‚Üí BTC ‚Üí UNI ‚Üí USDC
7. USDC ‚Üí BTC ‚Üí ALGO ‚Üí USDC

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
SET 3: DEFI NATIVE (6 paths)
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
1. USDC ‚Üí AAVE ‚Üí ETH ‚Üí USDC (DeFi)
2. USDC ‚Üí COMP ‚Üí ETH ‚Üí USDC (DeFi)
3. USDC ‚Üí MKR ‚Üí ETH ‚Üí USDC (DeFi)
4. USDC ‚Üí SNX ‚Üí ETH ‚Üí USDC (DeFi)
5. USDC ‚Üí CRV ‚Üí ETH ‚Üí USDC (DeFi)
6. USDC ‚Üí SUSHI ‚Üí ETH ‚Üí USDC (DeFi)

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
SET 4: HIGH VOLATILITY (6 paths)
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
1. USDC ‚Üí DOGE ‚Üí BTC ‚Üí USDC (Meme)
2. USDC ‚Üí SHIB ‚Üí ETH ‚Üí USDC (Meme)
3. USDC ‚Üí APE ‚Üí ETH ‚Üí USDC (Gaming)
4. USDC ‚Üí GALA ‚Üí BTC ‚Üí USDC (Gaming)
5. USDC ‚Üí SAND ‚Üí ETH ‚Üí USDC (Gaming)
6. USDC ‚Üí MANA ‚Üí ETH ‚Üí USDC (Gaming)

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
SET 5: EXTENDED MULTIBRIDGE (6 paths)
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
1. USDC ‚Üí FIL ‚Üí BTC ‚Üí USDC
2. USDC ‚Üí GRT ‚Üí ETH ‚Üí USDC
3. USDC ‚Üí ICP ‚Üí BTC ‚Üí USDC
4. USDC ‚Üí CHZ ‚Üí ETH ‚Üí USDC
5. USDC ‚Üí ENJ ‚Üí BTC ‚Üí USDC
6. USDC ‚Üí BTC ‚Üí ETH ‚Üí SOL ‚Üí USDC (4-leg)

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üí° TIP: Sets 1-2 are enabled by default (14 paths)
‚ö° Enable Sets 3-5 for more opportunities (18 additional paths)
üíµ FUNDING: USDC (237 USDC pairs available)
            `.trim();

            alert(pathDetails);
            console.log(pathDetails);
        }

        async function clearCoinbaseTriangularHistory() {
            if (!confirm('‚ö†Ô∏è Are you sure you want to clear ALL Coinbase triangular trade history? This cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch('/api/v1/trading/coinbase/triangular/history', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    alert(`‚úÖ ${data.message}`);
                    console.log('‚úÖ [COINBASE] History cleared:', data);
                } else {
                    alert(`‚ùå Failed to clear history: ${data.message}`);
                }
            } catch (error) {
                console.error('‚ùå [COINBASE] Clear history error:', error);
                alert('‚ùå Failed to clear history. Check console for details.');
            }
        }

        function saveCoinbaseTriangularSettings() {
            console.log('üíæ [COINBASE] Saving settings to localStorage...');

            const maxTrade = document.getElementById('coinbaseMaxTrade').value;
            const portfolioPercent = document.getElementById('coinbasePortfolioPercent').value;
            const profitThreshold = document.getElementById('coinbaseProfitThreshold').value;

            const settings = {
                maxTrade: maxTrade,
                portfolioPercent: portfolioPercent,
                profitThreshold: profitThreshold,
                set1Enabled: document.getElementById('coinbaseSet1Enabled').checked,
                set2Enabled: document.getElementById('coinbaseSet2Enabled').checked,
                set3Enabled: document.getElementById('coinbaseSet3Enabled').checked,
                set4Enabled: document.getElementById('coinbaseSet4Enabled').checked,
                set5Enabled: document.getElementById('coinbaseSet5Enabled').checked
            };

            localStorage.setItem('coinbaseTriangularSettings', JSON.stringify(settings));
            console.log('‚úÖ [COINBASE] Settings saved:', settings);
        }

        function loadCoinbaseTriangularSettings() {
            console.log('üì• [COINBASE] Loading settings from localStorage...');

            // Load settings
            const settingsJson = localStorage.getItem('coinbaseTriangularSettings');
            if (settingsJson) {
                try {
                    const settings = JSON.parse(settingsJson);
                    console.log('‚úÖ [COINBASE] Settings loaded:', settings);

                    if (settings.maxTrade) document.getElementById('coinbaseMaxTrade').value = settings.maxTrade;
                    if (settings.portfolioPercent) document.getElementById('coinbasePortfolioPercent').value = settings.portfolioPercent;
                    if (settings.profitThreshold) document.getElementById('coinbaseProfitThreshold').value = settings.profitThreshold;

                    // Load path set preferences
                    for (let i = 1; i <= 5; i++) {
                        const checkbox = document.getElementById(`coinbaseSet${i}Enabled`);
                        if (checkbox && settings.hasOwnProperty(`set${i}Enabled`)) {
                            checkbox.checked = settings[`set${i}Enabled`];
                        }
                    }
                } catch (error) {
                    console.error('‚ùå [COINBASE] Failed to parse settings:', error);
                }
            }

            // Load toggle state
            const toggleEnabled = localStorage.getItem('coinbaseTriangularEnabled') === 'true';
            const toggle = document.getElementById('coinbaseTriangularEnabled');
            const status = document.getElementById('coinbaseTriangularStatus');

            if (toggleEnabled) {
                toggle.classList.add('active');
                status.textContent = 'ON';
                status.style.color = '#0052FF';
                console.log('‚úÖ [COINBASE] Live trading enabled (from localStorage)');
            } else {
                console.log('‚ÑπÔ∏è [COINBASE] Live trading disabled (from localStorage)');
            }
        }

        // Initialize Coinbase settings on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ [COINBASE] Initializing triangular arbitrage settings...');
            loadCoinbaseTriangularSettings();

            // Add event listeners for Coinbase inputs (auto-save)
            const coinbaseInputs = document.querySelectorAll('#coinbaseMaxTrade, #coinbasePortfolioPercent, #coinbaseProfitThreshold');
            coinbaseInputs.forEach(input => {
                input.addEventListener('change', saveCoinbaseTriangularSettings);
            });

            // Add event listeners for Coinbase checkboxes (5 sets)
            for (let i = 1; i <= 5; i++) {
                const checkbox = document.getElementById(`coinbaseSet${i}Enabled`);
                if (checkbox) {
                    checkbox.addEventListener('change', saveCoinbaseTriangularSettings);
                }
            }
        });

        // ============================================================================
        // HUOBI (HTX) TRIANGULAR ARBITRAGE FUNCTIONS
        // ============================================================================

        // Worker variables
        let htxWorkerInterval = null;
        let htxWorkerStats = {
            scansCompleted: 0,
            opportunitiesFound: 0,
            tradesExecuted: 0,
            lastScanTime: null
        };

        function toggleHuobiTriangular() {
            const toggle = document.getElementById('huobiTriangularEnabled');
            const status = document.getElementById('huobiTriangularStatus');
            const isActive = toggle.classList.toggle('active');

            if (isActive) {
                status.textContent = 'ON';
                status.style.color = '#2D6CF8';
                localStorage.setItem('huobiTriangularEnabled', 'true');
                console.log('‚úÖ [HUOBI] Live triangular trading enabled');
                startHtxWorker();  // Start worker
            } else {
                status.textContent = 'OFF';
                status.style.color = '#ff6b6b';
                localStorage.setItem('huobiTriangularEnabled', 'false');
                console.log('‚è∏Ô∏è [HUOBI] Live triangular trading disabled');
                stopHtxWorker();  // Stop worker
            }
        }

        async function testHuobiTriangularConnection() {
            console.log('üîç [HUOBI] Testing connection...');

            const apiKey = localStorage.getItem('huobi_triangular_api');
            const apiSecret = localStorage.getItem('huobi_triangular_secret');

            if (!apiKey || !apiSecret) {
                alert('‚ùå Please configure your Huobi API credentials in platform settings first.');
                return;
            }

            try {
                const response = await fetch('/api/v1/trading/huobi/triangular/test-connection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({ apiKey, apiSecret })
                });

                const data = await response.json();

                if (data.success) {
                    alert(`‚úÖ Huobi Connection Successful!\n\nAccounts: ${data.accountsCount}\nTimestamp: ${new Date(data.timestamp).toLocaleString()}`);
                    console.log('‚úÖ [HUOBI] Connection test passed:', data);
                } else {
                    alert(`‚ùå Connection Failed: ${data.message}`);
                    console.error('‚ùå [HUOBI] Connection test failed:', data);
                }
            } catch (error) {
                console.error('‚ùå [HUOBI] Connection test error:', error);
                alert('‚ùå Connection test failed. Check console for details.');
            }
        }

        async function scanHuobiTriangularPaths() {
            console.log('üîç [HUOBI] Starting scan for triangular arbitrage opportunities...');

            const apiKey = localStorage.getItem('huobi_triangular_api');
            const apiSecret = localStorage.getItem('huobi_triangular_secret');

            if (!apiKey || !apiSecret) {
                alert('‚ùå Please configure your Huobi API credentials in platform settings first.');
                return;
            }

            const maxTradeAmount = parseFloat(document.getElementById('huobiMaxTrade').value);
            const portfolioPercent = parseFloat(document.getElementById('huobiPortfolioPercent').value);
            const profitThreshold = parseFloat(document.getElementById('huobiProfitThreshold').value);

            const enabledSets = {
                SET_1_ESSENTIAL_ETH_BRIDGE: document.getElementById('huobiSet1Enabled').checked,
                SET_2_MIDCAP_BTC_BRIDGE: document.getElementById('huobiSet2Enabled').checked,
                SET_3_HT_NATIVE_BRIDGE: document.getElementById('huobiSet3Enabled').checked,
                SET_4_HIGH_VOLATILITY: document.getElementById('huobiSet4Enabled').checked,
                SET_5_EXTENDED_MULTIBRIDGE: document.getElementById('huobiSet5Enabled').checked
            };

            try {
                const response = await fetch('/api/v1/trading/huobi/triangular/scan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({
                        apiKey,
                        apiSecret,
                        maxTradeAmount,
                        portfolioPercent,
                        profitThreshold,
                        enabledSets
                    })
                });

                const data = await response.json();

                if (data.success) {
                    console.log(`‚úÖ [HUOBI] Scan complete: ${data.profitableCount} opportunities found`);

                    const container = document.getElementById('huobiOpportunities');

                    if (data.opportunities.length === 0) {
                        container.innerHTML = `
                            <p style="color: #888; text-align: center; padding: 20px;">
                                No profitable opportunities found above ${profitThreshold}% threshold.<br>
                                Try lowering the profit threshold or enabling more path sets.
                            </p>
                        `;
                    } else {
                        let html = '<div style="display: flex; flex-direction: column; gap: 15px;">';

                        data.opportunities.slice(0, 10).forEach((opp, index) => {
                            html += `
                                <div style="background: rgba(45,108,248,0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #2D6CF8;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                        <strong style="color: #2D6CF8;">${opp.description}</strong>
                                        <span style="background: #2D6CF8; color: white; padding: 4px 12px; border-radius: 12px; font-weight: 600;">
                                            +${opp.profitPercent}%
                                        </span>
                                    </div>
                                    <div style="font-size: 0.9rem; color: #b8c6db;">
                                        <div>Path: ${opp.path.join(' ‚Üí ')}</div>
                                        <div>Initial: $${opp.initialAmount} USDT ‚Üí Final: $${opp.finalAmount.toFixed(2)} USDT</div>
                                        <div>Profit: $${opp.profitAmount.toFixed(2)} USDT</div>
                                        <div style="font-size: 0.8rem; color: #888; margin-top: 5px;">${opp.pathId}</div>
                                    </div>
                                </div>
                            `;
                        });

                        if (data.opportunities.length > 10) {
                            html += `<p style="text-align: center; color: #888; font-size: 0.9rem;">Showing top 10 of ${data.opportunities.length} opportunities</p>`;
                        }

                        html += '</div>';
                        container.innerHTML = html;
                    }

                    alert(`‚úÖ Scan Complete!\n\nTotal Scanned: ${data.totalScanned} paths\nProfitable: ${data.profitableCount} opportunities\nBest: ${data.opportunities[0]?.profitPercent || 0}%`);
                } else {
                    alert(`‚ùå Scan Failed: ${data.message}`);
                    console.error('‚ùå [HUOBI] Scan failed:', data);
                }
            } catch (error) {
                console.error('‚ùå [HUOBI] Scan error:', error);
                alert('‚ùå Scan failed. Check console for details.');
            }
        }

        function viewHuobiPathDetails() {
            console.log('üìã [HTX] Opening paths modal');

            // Create modal overlay
            const modal = document.createElement('div');
            modal.id = 'huobiPathsModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.85);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                backdrop-filter: blur(5px);
            `;

            // Create modal content
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
                border: 2px solid #2D6CF8;
                border-radius: 15px;
                padding: 30px;
                max-width: 900px;
                max-height: 85vh;
                overflow-y: auto;
                box-shadow: 0 10px 50px rgba(45,108,248,0.3);
                position: relative;
            `;

            modalContent.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid rgba(45,108,248,0.3); padding-bottom: 15px;">
                    <h2 style="color: #2D6CF8; margin: 0; font-size: 1.8rem;">üìã HTX (Huobi) Triangular Arbitrage Paths</h2>
                    <button onclick="document.getElementById('huobiPathsModal').remove()" style="background: rgba(255,255,255,0.1); border: 1px solid #2D6CF8; color: #2D6CF8; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-size: 1.2rem; font-weight: bold;">‚úï</button>
                </div>

                <div style="background: rgba(45,108,248,0.1); padding: 15px; border-radius: 10px; margin-bottom: 25px; border-left: 4px solid #2D6CF8;">
                    <p style="color: #b8c6db; margin: 0; font-size: 0.95rem;">
                        <strong style="color: #2D6CF8;">31 Triangular Arbitrage Paths</strong> organized in 5 sets.
                        <br><br>
                        üåâ <strong>Bridge Currencies:</strong> ETH (Set 1), BTC (Set 2), HT (Set 3), Mixed (Sets 4-5)
                        <br>
                        üí∞ <strong>Base Currency:</strong> USDT (Tether) - Fund HTX with USDT only
                        <br>
                        üí° <strong>Default:</strong> Sets 1-2 enabled (14 paths) | Enable Sets 3-5 for 17 additional paths
                    </p>
                </div>

                <!-- SET 1 -->
                <div style="background: rgba(0,255,200,0.1); padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #00ffc8;">
                    <h3 style="color: #00ffc8; margin: 0 0 15px 0;">SET 1: ESSENTIAL ETH BRIDGE (7 paths) ‚úÖ DEFAULT</h3>
                    <div style="display: grid; grid-template-columns: 1fr; gap: 8px; font-size: 0.9rem;">
                        <div style="color: #b8c6db;">1. USDT ‚Üí ETH ‚Üí BTC ‚Üí USDT</div>
                        <div style="color: #b8c6db;">2. USDT ‚Üí ETH ‚Üí SOL ‚Üí USDT</div>
                        <div style="color: #b8c6db;">3. USDT ‚Üí ETH ‚Üí XRP ‚Üí USDT</div>
                        <div style="color: #b8c6db;">4. USDT ‚Üí ETH ‚Üí TRX ‚Üí USDT</div>
                        <div style="color: #b8c6db;">5. USDT ‚Üí ETH ‚Üí DOT ‚Üí USDT</div>
                        <div style="color: #b8c6db;">6. USDT ‚Üí ETH ‚Üí MATIC ‚Üí USDT</div>
                        <div style="color: #b8c6db;">7. USDT ‚Üí ETH ‚Üí LINK ‚Üí USDT</div>
                    </div>
                </div>

                <!-- SET 2 -->
                <div style="background: rgba(45,108,248,0.1); padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #2D6CF8;">
                    <h3 style="color: #2D6CF8; margin: 0 0 15px 0;">SET 2: MIDCAP BTC BRIDGE (7 paths) ‚úÖ DEFAULT</h3>
                    <div style="display: grid; grid-template-columns: 1fr; gap: 8px; font-size: 0.9rem;">
                        <div style="color: #b8c6db;">1. USDT ‚Üí BTC ‚Üí ETH ‚Üí USDT</div>
                        <div style="color: #b8c6db;">2. USDT ‚Üí BTC ‚Üí XRP ‚Üí USDT</div>
                        <div style="color: #b8c6db;">3. USDT ‚Üí BTC ‚Üí LTC ‚Üí USDT</div>
                        <div style="color: #b8c6db;">4. USDT ‚Üí BTC ‚Üí BCH ‚Üí USDT</div>
                        <div style="color: #b8c6db;">5. USDT ‚Üí BTC ‚Üí ADA ‚Üí USDT</div>
                        <div style="color: #b8c6db;">6. USDT ‚Üí BTC ‚Üí AVAX ‚Üí USDT</div>
                        <div style="color: #b8c6db;">7. USDT ‚Üí BTC ‚Üí UNI ‚Üí USDT</div>
                    </div>
                </div>

                <!-- SET 3 -->
                <div style="background: rgba(100,150,255,0.1); padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #6496ff;">
                    <h3 style="color: #6496ff; margin: 0 0 15px 0;">SET 3: HT NATIVE BRIDGE (6 paths)</h3>
                    <div style="display: grid; grid-template-columns: 1fr; gap: 8px; font-size: 0.9rem;">
                        <div style="color: #b8c6db;">1. USDT ‚Üí HT ‚Üí BTC ‚Üí USDT <span style="color: #888;">(Native)</span></div>
                        <div style="color: #b8c6db;">2. USDT ‚Üí HT ‚Üí ETH ‚Üí USDT <span style="color: #888;">(Native)</span></div>
                        <div style="color: #b8c6db;">3. USDT ‚Üí HT ‚Üí XRP ‚Üí USDT <span style="color: #888;">(Native)</span></div>
                        <div style="color: #b8c6db;">4. USDT ‚Üí HT ‚Üí TRX ‚Üí USDT <span style="color: #888;">(Native)</span></div>
                        <div style="color: #b8c6db;">5. USDT ‚Üí HT ‚Üí DOT ‚Üí USDT <span style="color: #888;">(Native)</span></div>
                        <div style="color: #b8c6db;">6. USDT ‚Üí HT ‚Üí SOL ‚Üí USDT <span style="color: #888;">(Native)</span></div>
                    </div>
                </div>

                <!-- SET 4 -->
                <div style="background: rgba(255,165,0,0.1); padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #ffa500;">
                    <h3 style="color: #ffa500; margin: 0 0 15px 0;">SET 4: HIGH VOLATILITY (6 paths)</h3>
                    <div style="display: grid; grid-template-columns: 1fr; gap: 8px; font-size: 0.9rem;">
                        <div style="color: #b8c6db;">1. USDT ‚Üí DOGE ‚Üí BTC ‚Üí USDT <span style="color: #888;">(Meme)</span></div>
                        <div style="color: #b8c6db;">2. USDT ‚Üí SHIB ‚Üí ETH ‚Üí USDT <span style="color: #888;">(Meme)</span></div>
                        <div style="color: #b8c6db;">3. USDT ‚Üí APE ‚Üí ETH ‚Üí USDT <span style="color: #888;">(NFT)</span></div>
                        <div style="color: #b8c6db;">4. USDT ‚Üí NEAR ‚Üí BTC ‚Üí USDT <span style="color: #888;">(Layer1)</span></div>
                        <div style="color: #b8c6db;">5. USDT ‚Üí APT ‚Üí ETH ‚Üí USDT <span style="color: #888;">(Layer1)</span></div>
                        <div style="color: #b8c6db;">6. USDT ‚Üí FTM ‚Üí BTC ‚Üí USDT <span style="color: #888;">(DeFi)</span></div>
                    </div>
                </div>

                <!-- SET 5 -->
                <div style="background: rgba(138,43,226,0.1); padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #8a2be2;">
                    <h3 style="color: #8a2be2; margin: 0 0 15px 0;">SET 5: EXTENDED MULTIBRIDGE (5 paths)</h3>
                    <div style="display: grid; grid-template-columns: 1fr; gap: 8px; font-size: 0.9rem;">
                        <div style="color: #b8c6db;">1. USDT ‚Üí FIL ‚Üí BTC ‚Üí USDT</div>
                        <div style="color: #b8c6db;">2. USDT ‚Üí ATOM ‚Üí ETH ‚Üí USDT</div>
                        <div style="color: #b8c6db;">3. USDT ‚Üí ICP ‚Üí BTC ‚Üí USDT</div>
                        <div style="color: #b8c6db;">4. USDT ‚Üí ALGO ‚Üí ETH ‚Üí USDT</div>
                        <div style="color: #b8c6db;">5. USDT ‚Üí ETC ‚Üí BTC ‚Üí USDT</div>
                    </div>
                </div>

                <div style="background: rgba(45,108,248,0.1); padding: 12px; border-radius: 8px; text-align: center; margin-top: 20px; border: 1px solid rgba(45,108,248,0.3);">
                    <p style="color: #b8c6db; margin: 0; font-size: 0.9rem;">
                        üí° <strong style="color: #2D6CF8;">Tip:</strong> Enable/disable path sets in the settings above to control which opportunities are scanned.
                    </p>
                </div>
            `;

            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // Close on outside click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });

            console.log('‚úÖ [HTX] Paths modal opened');
        }

        // Tab switching function
        function switchHuobiTab(tabName) {
            console.log(`üîÑ [HTX] Switching to ${tabName} tab`);

            // Hide all content divs
            document.getElementById('huobiBalanceContent').style.display = 'none';
            document.getElementById('huobiTradingContent').style.display = 'none';

            // Reset all tab button styles
            document.getElementById('huobiBalanceTab').style.background = 'rgba(255,255,255,0.05)';
            document.getElementById('huobiBalanceTab').style.color = '#b8c6db';
            document.getElementById('huobiTradingTab').style.background = 'rgba(255,255,255,0.05)';
            document.getElementById('huobiTradingTab').style.color = '#b8c6db';

            // Show selected content and activate button
            if (tabName === 'balance') {
                document.getElementById('huobiBalanceContent').style.display = 'block';
                document.getElementById('huobiBalanceTab').style.background = 'rgba(45,108,248,0.3)';
                document.getElementById('huobiBalanceTab').style.color = '#2D6CF8';
            } else if (tabName === 'trading') {
                document.getElementById('huobiTradingContent').style.display = 'block';
                document.getElementById('huobiTradingTab').style.background = 'rgba(45,108,248,0.3)';
                document.getElementById('huobiTradingTab').style.color = '#2D6CF8';
            }
        }

        // Balance tracking object
        const huobiBalanceTracking = {
            startingUSDT: 0,
            currentUSDT: 0
        };

        // Initialize HTX balance tracking
        async function initializeHuobiBalance() {
            console.log('üí∞ [HTX] Initializing balance tracking...');

            const apiKey = localStorage.getItem('huobi_triangular_api');
            const apiSecret = localStorage.getItem('huobi_triangular_secret');

            if (!apiKey || !apiSecret) {
                console.warn('‚ö†Ô∏è [HTX] No API credentials configured - balance tracking disabled');
                return;
            }

            try {
                const response = await fetch('/api/v1/trading/huobi/balance', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({
                        apiKey,
                        apiSecret,
                        currency: 'USDT'
                    })
                });

                const data = await response.json();

                if (data.success) {
                    huobiBalanceTracking.startingUSDT = parseFloat(data.balance);
                    huobiBalanceTracking.currentUSDT = parseFloat(data.balance);
                    updateHuobiBalanceDisplay();
                    console.log(`‚úÖ [HTX] Balance initialized: $${data.balance} USDT`);
                } else {
                    console.error('‚ùå [HTX] Failed to fetch balance:', data.message);
                }
            } catch (error) {
                console.error('‚ùå [HTX] Balance initialization error:', error);
            }
        }

        // Update current HTX balance
        async function updateHuobiBalance() {
            const apiKey = localStorage.getItem('huobi_triangular_api');
            const apiSecret = localStorage.getItem('huobi_triangular_secret');

            if (!apiKey || !apiSecret) {
                return;
            }

            try {
                const response = await fetch('/api/v1/trading/huobi/balance', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({
                        apiKey,
                        apiSecret,
                        currency: 'USDT'
                    })
                });

                const data = await response.json();

                if (data.success) {
                    huobiBalanceTracking.currentUSDT = parseFloat(data.balance);
                    updateHuobiBalanceDisplay();
                }
            } catch (error) {
                console.error('‚ùå [HTX] Balance update error:', error);
            }
        }

        // Update balance display
        function updateHuobiBalanceDisplay() {
            const startingElement = document.getElementById('huobiStartingUSDT');
            const currentElement = document.getElementById('huobiCurrentUSDT');
            const changeElement = document.getElementById('huobiChangeUSDT');

            if (!startingElement || !currentElement || !changeElement) {
                return;
            }

            const starting = huobiBalanceTracking.startingUSDT;
            const current = huobiBalanceTracking.currentUSDT;
            const change = current - starting;
            const changePercent = starting > 0 ? ((change / starting) * 100).toFixed(2) : '0.00';

            startingElement.textContent = `$${starting.toFixed(2)}`;
            currentElement.textContent = `$${current.toFixed(2)}`;

            const changeSign = change >= 0 ? '+' : '';
            changeElement.textContent = `${changeSign}$${change.toFixed(2)} (${changeSign}${changePercent}%)`;
            changeElement.style.color = change >= 0 ? '#00d26a' : '#ff4444';
        }

        // Reset starting balance to current balance
        function resetHuobiStartingBalance() {
            huobiBalanceTracking.startingUSDT = huobiBalanceTracking.currentUSDT;
            updateHuobiBalanceDisplay();
            console.log('üîÑ [HTX] Starting balance reset to current balance');
        }

        async function clearHuobiTriangularHistory() {
            if (!confirm('‚ö†Ô∏è Are you sure you want to clear ALL Huobi triangular trade history? This cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch('/api/v1/trading/huobi/triangular/history', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    alert(`‚úÖ ${data.message}`);
                    console.log('‚úÖ [HUOBI] History cleared:', data);
                } else {
                    alert(`‚ùå Failed to clear history: ${data.message}`);
                }
            } catch (error) {
                console.error('‚ùå [HUOBI] Clear history error:', error);
                alert('‚ùå Failed to clear history. Check console for details.');
            }
        }

        function saveHuobiTriangularSettings() {
            console.log('üíæ [HUOBI] Saving settings to localStorage...');

            const maxTrade = document.getElementById('huobiMaxTrade').value;
            const portfolioPercent = document.getElementById('huobiPortfolioPercent').value;
            const profitThreshold = document.getElementById('huobiProfitThreshold').value;

            const settings = {
                maxTrade: maxTrade,
                portfolioPercent: portfolioPercent,
                profitThreshold: profitThreshold,
                set1Enabled: document.getElementById('huobiSet1Enabled').checked,
                set2Enabled: document.getElementById('huobiSet2Enabled').checked,
                set3Enabled: document.getElementById('huobiSet3Enabled').checked,
                set4Enabled: document.getElementById('huobiSet4Enabled').checked,
                set5Enabled: document.getElementById('huobiSet5Enabled').checked
            };

            localStorage.setItem('huobiTriangularSettings', JSON.stringify(settings));
            console.log('‚úÖ [HUOBI] Settings saved:', settings);
        }

        function loadHuobiTriangularSettings() {
            console.log('üì• [HUOBI] Loading settings from localStorage...');

            const settingsJson = localStorage.getItem('huobiTriangularSettings');
            if (settingsJson) {
                try {
                    const settings = JSON.parse(settingsJson);
                    console.log('‚úÖ [HUOBI] Settings loaded:', settings);

                    if (settings.maxTrade) document.getElementById('huobiMaxTrade').value = settings.maxTrade;
                    if (settings.portfolioPercent) document.getElementById('huobiPortfolioPercent').value = settings.portfolioPercent;
                    if (settings.profitThreshold) document.getElementById('huobiProfitThreshold').value = settings.profitThreshold;

                    for (let i = 1; i <= 5; i++) {
                        const checkbox = document.getElementById(`huobiSet${i}Enabled`);
                        if (checkbox && settings.hasOwnProperty(`set${i}Enabled`)) {
                            checkbox.checked = settings[`set${i}Enabled`];
                        }
                    }
                } catch (error) {
                    console.error('‚ùå [HUOBI] Failed to parse settings:', error);
                }
            }

            const toggleEnabled = localStorage.getItem('huobiTriangularEnabled') === 'true';
            const toggle = document.getElementById('huobiTriangularEnabled');
            const status = document.getElementById('huobiTriangularStatus');

            if (toggleEnabled) {
                toggle.classList.add('active');
                status.textContent = 'ON';
                status.style.color = '#2D6CF8';
                console.log('‚úÖ [HUOBI] Live trading enabled (from localStorage)');
            } else {
                console.log('‚ÑπÔ∏è [HUOBI] Live trading disabled (from localStorage)');
            }
        }

        // Initialize Huobi settings on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ [HUOBI] Initializing triangular arbitrage settings...');
            loadHuobiTriangularSettings();

            const huobiInputs = document.querySelectorAll('#huobiMaxTrade, #huobiPortfolioPercent, #huobiProfitThreshold');
            huobiInputs.forEach(input => {
                input.addEventListener('change', saveHuobiTriangularSettings);
            });

            for (let i = 1; i <= 5; i++) {
                const checkbox = document.getElementById(`huobiSet${i}Enabled`);
                if (checkbox) {
                    checkbox.addEventListener('change', saveHuobiTriangularSettings);
                }
            }
        });

        // ============================================================================
        // HTX WORKER FUNCTIONS (Sequential Scanning)
        // ============================================================================

        // Start HTX Worker (Sequential Scanning - One Set at a Time)
        function startHtxWorker() {
            console.log('üü¢ [HTX] Starting worker with sequential path set scanning...');

            if (htxWorkerInterval) {
                clearInterval(htxWorkerInterval);
            }

            htxWorkerStats = {
                scansCompleted: 0,
                opportunitiesFound: 0,
                tradesExecuted: 0,
                lastScanTime: null
            };

            let currentSetIndex = 0;
            const pathSets = ['SET_1_ESSENTIAL_ETH_BRIDGE', 'SET_2_MIDCAP_BTC_BRIDGE', 'SET_3_HT_NATIVE_BRIDGE', 'SET_4_HIGH_VOLATILITY', 'SET_5_EXTENDED_MULTIBRIDGE'];

            htxWorkerInterval = setInterval(async () => {
                try {
                    const apiKey = localStorage.getItem('huobi_triangular_api');
                    const apiSecret = localStorage.getItem('huobi_triangular_secret');

                    if (!apiKey || !apiSecret) {
                        console.warn('‚ö†Ô∏è [HTX] Missing credentials, worker paused');
                        return;
                    }

                    // Get enabled sets from settings
                    const enabledSets = [];
                    for (let i = 1; i <= 5; i++) {
                        const checkbox = document.getElementById(`huobiSet${i}Enabled`);
                        if (checkbox && checkbox.checked) {
                            enabledSets.push(pathSets[i - 1]);
                        }
                    }

                    if (enabledSets.length === 0) {
                        console.warn('‚ö†Ô∏è [HTX] No path sets enabled');
                        return;
                    }

                    if (currentSetIndex >= enabledSets.length) {
                        currentSetIndex = 0;
                    }
                    const currentSet = enabledSets[currentSetIndex];

                    console.log(`üîç [HTX] Worker scanning ${currentSet} (${currentSetIndex + 1}/${enabledSets.length})...`);

                    const response = await fetch('/api/v1/trading/huobi/triangular/scan', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                        },
                        body: JSON.stringify({
                            apiKey,
                            apiSecret,
                            maxTradeAmount: parseFloat(document.getElementById('huobiMaxTrade')?.value || 1000),
                            portfolioPercent: parseFloat(document.getElementById('huobiPortfolioPercent')?.value || 10),
                            profitThreshold: parseFloat(document.getElementById('huobiProfitThreshold')?.value || 0.5),
                            enabledSets: {
                                [currentSet]: true
                            }
                        })
                    });

                    const data = await response.json();

                    if (data.success && data.opportunities && data.opportunities.length > 0) {
                        console.log(`üíé [HTX] Found ${data.opportunities.length} opportunities in ${currentSet}`);
                        htxWorkerStats.opportunitiesFound += data.opportunities.length;
                        htxWorkerStats.lastScanTime = new Date().toISOString();

                        displayHuobiOpportunities(data.opportunities);

                        const autoExecute = document.getElementById('huobiAutoExecute')?.checked;
                        if (autoExecute) {
                            const bestOpp = data.opportunities[0];
                            await executeAutoTrade('htx', bestOpp, apiKey, apiSecret);
                        }
                    }

                    htxWorkerStats.scansCompleted++;
                    currentSetIndex++;

                } catch (error) {
                    console.error('‚ùå [HTX] Worker error:', error);
                }
            }, 8000);  // 8 second intervals

            console.log(`‚úÖ [HTX] Worker started - scanning ${pathSets.length} path sets sequentially`);
        }

        // Stop HTX Worker
        function stopHtxWorker() {
            if (htxWorkerInterval) {
                clearInterval(htxWorkerInterval);
                htxWorkerInterval = null;
                console.log('‚è∏Ô∏è [HTX] Worker stopped');
                console.log('üìä [HTX] Final stats:', htxWorkerStats);
            }
        }

        // Display HTX opportunities
        function displayHuobiOpportunities(opportunities) {
            const container = document.getElementById('huobiOpportunities');

            if (!container) return;

            if (opportunities.length === 0) {
                container.innerHTML = `
                    <p style="color: #888; text-align: center; padding: 20px;">
                        No profitable opportunities found.<br>
                        Try lowering the profit threshold or enabling more path sets.
                    </p>
                `;
                return;
            }

            let html = '<div style="display: flex; flex-direction: column; gap: 15px;">';

            opportunities.slice(0, 10).forEach((opp, index) => {
                html += `
                    <div style="background: rgba(45,108,248,0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #2D6CF8;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <strong style="color: #2D6CF8;">${opp.description}</strong>
                            <span style="background: #2D6CF8; color: white; padding: 4px 12px; border-radius: 12px; font-weight: 600;">
                                +${opp.profitPercent}%
                            </span>
                        </div>
                        <div style="font-size: 0.9rem; color: #b8c6db;">
                            <div>Path: ${opp.path.join(' ‚Üí ')}</div>
                            <div>Initial: $${opp.initialAmount} USDT ‚Üí Final: $${opp.finalAmount.toFixed(2)} USDT</div>
                            <div>Profit: $${opp.profitAmount.toFixed(2)} USDT</div>
                            <div style="font-size: 0.8rem; color: #888; margin-top: 5px;">${opp.pathId}</div>
                        </div>
                    </div>
                `;
            });

            if (opportunities.length > 10) {
                html += `<p style="text-align: center; color: #888; font-size: 0.9rem;">Showing top 10 of ${opportunities.length} opportunities</p>`;
            }

            html += '</div>';
            container.innerHTML = html;
        }

        // ============================================================================
        // GATE.IO TRIANGULAR ARBITRAGE JAVASCRIPT FUNCTIONS
        // ============================================================================

        // Worker variables
        let gateioWorkerInterval = null;
        let gateioWorkerStats = {
            scansCompleted: 0,
            opportunitiesFound: 0,
            tradesExecuted: 0,
            lastScanTime: null
        };

        // 0. Toggle Gate.io Triangular Trading
        function toggleGateioTriangular() {
            const toggle = document.getElementById('gateioTriangularEnabled');
            const status = document.getElementById('gateioTriangularStatus');
            const isActive = toggle.classList.toggle('active');

            if (isActive) {
                status.textContent = 'ON';
                status.style.color = '#17C784';
                localStorage.setItem('gateioTriangularEnabled', 'true');
                console.log('‚úÖ [GATE.IO] Live triangular trading enabled');
                startGateioWorker();  // Start worker
            } else {
                status.textContent = 'OFF';
                status.style.color = '#ff6b6b';
                localStorage.setItem('gateioTriangularEnabled', 'false');
                console.log('‚è∏Ô∏è [GATE.IO] Live triangular trading disabled');
                stopGateioWorker();  // Stop worker
            }
        }

        // 1. Test Gate.io Connection
        async function testGateioTriangularConnection() {
            try {
                const apiKey = localStorage.getItem('gateio_triangular_api');
                const apiSecret = localStorage.getItem('gateio_triangular_secret');

                if (!apiKey || !apiSecret) {
                    alert('‚ùå Gate.io API credentials not found!\n\nPlease set your API credentials on the SETUP page first.');
                    return;
                }

                document.getElementById('gateioStatusText').textContent = 'Testing connection...';
                document.getElementById('gateioStatusIndicator').style.background = '#FFA500';

                const response = await fetch('/api/v1/trading/gateio/triangular/test-connection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({ apiKey, apiSecret })
                });

                const result = await response.json();

                if (result.success) {
                    document.getElementById('gateioStatusIndicator').style.background = '#17C784';
                    document.getElementById('gateioStatusText').textContent = `Connected | ${result.balances.USDT} USDT`;
                    alert(`‚úÖ Gate.io Connection Successful!\n\nUSDT Balance: ${result.balances.USDT}`);
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('Gate.io connection error:', error);
                document.getElementById('gateioStatusIndicator').style.background = '#FF4444';
                document.getElementById('gateioStatusText').textContent = 'Connection Failed';
                alert(`‚ùå Gate.io Connection Failed\n\n${error.message}`);
            }
        }

        // 2. View Gate.io Path Details
        function viewGateioPathDetails() {
            console.log('üìã [GATE.IO] Opening paths modal');

            // Create modal overlay
            const modal = document.createElement('div');
            modal.id = 'gateioPathsModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.85);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                backdrop-filter: blur(5px);
            `;

            // Create modal content
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
                border: 2px solid #17C784;
                border-radius: 15px;
                padding: 30px;
                max-width: 900px;
                max-height: 85vh;
                overflow-y: auto;
                box-shadow: 0 10px 50px rgba(23,199,132,0.3);
                position: relative;
            `;

            modalContent.innerHTML = `
                <!-- Header with close button -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid rgba(23,199,132,0.3); padding-bottom: 15px;">
                    <h2 style="color: #17C784; margin: 0; font-size: 1.8rem;">üìã Gate.io Triangular Arbitrage Paths</h2>
                    <button onclick="document.getElementById('gateioPathsModal').remove()" style="background: rgba(255,255,255,0.1); border: 1px solid #17C784; color: #17C784; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-size: 1.2rem; font-weight: bold;">‚úï</button>
                </div>

                <!-- Info banner -->
                <div style="background: rgba(23,199,132,0.1); padding: 15px; border-radius: 10px; margin-bottom: 25px; border-left: 4px solid #17C784;">
                    <p style="color: #b8c6db; margin: 0; font-size: 0.95rem;">
                        <strong style="color: #17C784;">32 Triangular Arbitrage Paths</strong> organized in 5 sets.
                        <br><br>
                        üåâ <strong>Bridge Currencies:</strong> ETH (Set 1), BTC (Set 2), GT (Set 3), Mixed (Sets 4-5)
                        <br>
                        üí∞ <strong>Base Currency:</strong> USDT (Tether) - Fund Gate.io with USDT only
                        <br>
                        üí° <strong>Default:</strong> Sets 1-2 enabled (14 paths) | Enable Sets 3-5 for 18 additional paths
                    </p>
                </div>

                <!-- SET 1: ESSENTIAL ETH BRIDGE (7 paths) - Color: #00ffc8 -->
                <div style="background: rgba(0,255,200,0.05); padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #00ffc8;">
                    <h3 style="color: #00ffc8; margin: 0 0 15px 0; font-size: 1.3rem;">üåø SET 1: Essential ETH Bridge (7 paths) ‚úÖ ENABLED BY DEFAULT</h3>
                    <div style="display: grid; gap: 8px; font-size: 0.9rem; color: #b8c6db;">
                        <div>1. <strong style="color: #00ffc8;">USDT ‚Üí ETH ‚Üí BTC ‚Üí USDT</strong> <span style="color: #888;">(ETH_USDT, BTC_ETH, BTC_USDT)</span></div>
                        <div>2. <strong style="color: #00ffc8;">USDT ‚Üí ETH ‚Üí SOL ‚Üí USDT</strong> <span style="color: #888;">(ETH_USDT, SOL_ETH, SOL_USDT)</span></div>
                        <div>3. <strong style="color: #00ffc8;">USDT ‚Üí ETH ‚Üí XRP ‚Üí USDT</strong> <span style="color: #888;">(ETH_USDT, XRP_ETH, XRP_USDT)</span></div>
                        <div>4. <strong style="color: #00ffc8;">USDT ‚Üí ETH ‚Üí ADA ‚Üí USDT</strong> <span style="color: #888;">(ETH_USDT, ADA_ETH, ADA_USDT)</span></div>
                        <div>5. <strong style="color: #00ffc8;">USDT ‚Üí ETH ‚Üí MATIC ‚Üí USDT</strong> <span style="color: #888;">(ETH_USDT, MATIC_ETH, MATIC_USDT)</span></div>
                        <div>6. <strong style="color: #00ffc8;">USDT ‚Üí ETH ‚Üí LINK ‚Üí USDT</strong> <span style="color: #888;">(ETH_USDT, LINK_ETH, LINK_USDT)</span></div>
                        <div>7. <strong style="color: #00ffc8;">USDT ‚Üí ETH ‚Üí AVAX ‚Üí USDT</strong> <span style="color: #888;">(ETH_USDT, AVAX_ETH, AVAX_USDT)</span></div>
                    </div>
                </div>

                <!-- SET 2: MIDCAP BTC BRIDGE (7 paths) - Color: #17C784 -->
                <div style="background: rgba(23,199,132,0.05); padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #17C784;">
                    <h3 style="color: #17C784; margin: 0 0 15px 0; font-size: 1.3rem;">üî∑ SET 2: Mid-Cap BTC Bridge (7 paths) ‚úÖ ENABLED BY DEFAULT</h3>
                    <div style="display: grid; gap: 8px; font-size: 0.9rem; color: #b8c6db;">
                        <div>1. <strong style="color: #17C784;">USDT ‚Üí BTC ‚Üí ETH ‚Üí USDT</strong> <span style="color: #888;">(BTC_USDT, ETH_BTC, ETH_USDT)</span></div>
                        <div>2. <strong style="color: #17C784;">USDT ‚Üí BTC ‚Üí SOL ‚Üí USDT</strong> <span style="color: #888;">(BTC_USDT, SOL_BTC, SOL_USDT)</span></div>
                        <div>3. <strong style="color: #17C784;">USDT ‚Üí BTC ‚Üí LTC ‚Üí USDT</strong> <span style="color: #888;">(BTC_USDT, LTC_BTC, LTC_USDT)</span></div>
                        <div>4. <strong style="color: #17C784;">USDT ‚Üí BTC ‚Üí DOT ‚Üí USDT</strong> <span style="color: #888;">(BTC_USDT, DOT_BTC, DOT_USDT)</span></div>
                        <div>5. <strong style="color: #17C784;">USDT ‚Üí BTC ‚Üí ATOM ‚Üí USDT</strong> <span style="color: #888;">(BTC_USDT, ATOM_BTC, ATOM_USDT)</span></div>
                        <div>6. <strong style="color: #17C784;">USDT ‚Üí BTC ‚Üí UNI ‚Üí USDT</strong> <span style="color: #888;">(BTC_USDT, UNI_BTC, UNI_USDT)</span></div>
                        <div>7. <strong style="color: #17C784;">USDT ‚Üí BTC ‚Üí BCH ‚Üí USDT</strong> <span style="color: #888;">(BTC_USDT, BCH_BTC, BCH_USDT)</span></div>
                    </div>
                </div>

                <!-- SET 3: GT NATIVE BRIDGE (6 paths) - Color: #6496ff -->
                <div style="background: rgba(100,150,255,0.05); padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #6496ff;">
                    <h3 style="color: #6496ff; margin: 0 0 15px 0; font-size: 1.3rem;">üåø SET 3: GT Native Bridge (6 paths) - Gate Token</h3>
                    <div style="display: grid; gap: 8px; font-size: 0.9rem; color: #b8c6db;">
                        <div>1. <strong style="color: #6496ff;">USDT ‚Üí GT ‚Üí BTC ‚Üí USDT</strong> <span style="color: #888;">(GT_USDT, BTC_GT, BTC_USDT)</span></div>
                        <div>2. <strong style="color: #6496ff;">USDT ‚Üí GT ‚Üí ETH ‚Üí USDT</strong> <span style="color: #888;">(GT_USDT, ETH_GT, ETH_USDT)</span></div>
                        <div>3. <strong style="color: #6496ff;">USDT ‚Üí GT ‚Üí SOL ‚Üí USDT</strong> <span style="color: #888;">(GT_USDT, SOL_GT, SOL_USDT)</span></div>
                        <div>4. <strong style="color: #6496ff;">USDT ‚Üí BTC ‚Üí GT ‚Üí USDT</strong> <span style="color: #888;">(BTC_USDT, GT_BTC, GT_USDT)</span></div>
                        <div>5. <strong style="color: #6496ff;">USDT ‚Üí ETH ‚Üí GT ‚Üí USDT</strong> <span style="color: #888;">(ETH_USDT, GT_ETH, GT_USDT)</span></div>
                        <div>6. <strong style="color: #6496ff;">USDT ‚Üí GT ‚Üí TRX ‚Üí USDT</strong> <span style="color: #888;">(GT_USDT, TRX_GT, TRX_USDT)</span></div>
                    </div>
                </div>

                <!-- SET 4: HIGH VOLATILITY (6 paths) - Color: #ffa500 -->
                <div style="background: rgba(255,165,0,0.05); padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #ffa500;">
                    <h3 style="color: #ffa500; margin: 0 0 15px 0; font-size: 1.3rem;">‚ö° SET 4: High Volatility (6 paths)</h3>
                    <div style="display: grid; gap: 8px; font-size: 0.9rem; color: #b8c6db;">
                        <div>1. <strong style="color: #ffa500;">USDT ‚Üí DOGE ‚Üí BTC ‚Üí USDT</strong> <span style="color: #888;">(DOGE_USDT, BTC_DOGE, BTC_USDT)</span></div>
                        <div>2. <strong style="color: #ffa500;">USDT ‚Üí SHIB ‚Üí ETH ‚Üí USDT</strong> <span style="color: #888;">(SHIB_USDT, ETH_SHIB, ETH_USDT)</span></div>
                        <div>3. <strong style="color: #ffa500;">USDT ‚Üí FTM ‚Üí BTC ‚Üí USDT</strong> <span style="color: #888;">(FTM_USDT, BTC_FTM, BTC_USDT)</span></div>
                        <div>4. <strong style="color: #ffa500;">USDT ‚Üí SAND ‚Üí ETH ‚Üí USDT</strong> <span style="color: #888;">(SAND_USDT, ETH_SAND, ETH_USDT)</span></div>
                        <div>5. <strong style="color: #ffa500;">USDT ‚Üí MANA ‚Üí BTC ‚Üí USDT</strong> <span style="color: #888;">(MANA_USDT, BTC_MANA, BTC_USDT)</span></div>
                        <div>6. <strong style="color: #ffa500;">USDT ‚Üí APE ‚Üí ETH ‚Üí USDT</strong> <span style="color: #888;">(APE_USDT, ETH_APE, ETH_USDT)</span></div>
                    </div>
                </div>

                <!-- SET 5: EXTENDED MULTIBRIDGE (6 paths) - Color: #8a2be2 -->
                <div style="background: rgba(138,43,226,0.05); padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #8a2be2;">
                    <h3 style="color: #8a2be2; margin: 0 0 15px 0; font-size: 1.3rem;">üîÅ SET 5: Extended Multi-Bridge (6 paths)</h3>
                    <div style="display: grid; gap: 8px; font-size: 0.9rem; color: #b8c6db;">
                        <div>1. <strong style="color: #8a2be2;">USDT ‚Üí SOL ‚Üí ETH ‚Üí USDT</strong> <span style="color: #888;">(SOL_USDT, ETH_SOL, ETH_USDT)</span></div>
                        <div>2. <strong style="color: #8a2be2;">USDT ‚Üí XRP ‚Üí BTC ‚Üí USDT</strong> <span style="color: #888;">(XRP_USDT, BTC_XRP, BTC_USDT)</span></div>
                        <div>3. <strong style="color: #8a2be2;">USDT ‚Üí TRX ‚Üí BTC ‚Üí USDT</strong> <span style="color: #888;">(TRX_USDT, BTC_TRX, BTC_USDT)</span></div>
                        <div>4. <strong style="color: #8a2be2;">USDT ‚Üí ADA ‚Üí BTC ‚Üí USDT</strong> <span style="color: #888;">(ADA_USDT, BTC_ADA, BTC_USDT)</span></div>
                        <div>5. <strong style="color: #8a2be2;">USDT ‚Üí BTC ‚Üí ETH ‚Üí SOL ‚Üí USDT</strong> ‚≠ê 4-LEG <span style="color: #888;">(BTC_USDT, ETH_BTC, SOL_ETH, SOL_USDT)</span></div>
                        <div>6. <strong style="color: #8a2be2;">USDT ‚Üí ETH ‚Üí BTC ‚Üí XRP ‚Üí USDT</strong> ‚≠ê 4-LEG <span style="color: #888;">(ETH_USDT, BTC_ETH, XRP_BTC, XRP_USDT)</span></div>
                    </div>
                </div>

                <!-- Summary Footer -->
                <div style="background: rgba(23,199,132,0.1); padding: 15px; border-radius: 10px; margin-top: 25px;">
                    <div style="display: grid; gap: 8px; font-size: 0.9rem; color: #b8c6db;">
                        <div>üí° <strong style="color: #17C784;">TOTAL:</strong> 32 paths (30 three-leg + 2 four-leg)</div>
                        <div>üåâ <strong style="color: #17C784;">BRIDGE:</strong> USDT (3,800+ pairs available)</div>
                        <div>üåø <strong style="color: #17C784;">NATIVE:</strong> GT (GateToken) for reduced fees</div>
                        <div>üîê <strong style="color: #17C784;">AUTH:</strong> HMAC-SHA512 signature</div>
                        <div>üìä <strong style="color: #17C784;">LIQUIDITY:</strong> $2.5B+ daily BTC/USDT volume</div>
                    </div>
                </div>
            `;

            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // Close on outside click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });

            console.log('‚úÖ [GATE.IO] Paths modal opened');
        }

        // Tab switching function
        function switchGateioTab(tabName) {
            console.log(`üîÑ [GATE.IO] Switching to ${tabName} tab`);

            // Hide all content divs
            document.getElementById('gateioBalanceContent').style.display = 'none';
            document.getElementById('gateioTradingContent').style.display = 'none';

            // Reset all tab button styles
            document.getElementById('gateioBalanceTab').style.background = 'rgba(255,255,255,0.05)';
            document.getElementById('gateioBalanceTab').style.color = '#b8c6db';
            document.getElementById('gateioTradingTab').style.background = 'rgba(255,255,255,0.05)';
            document.getElementById('gateioTradingTab').style.color = '#b8c6db';

            // Show selected content and activate button
            if (tabName === 'balance') {
                document.getElementById('gateioBalanceContent').style.display = 'block';
                document.getElementById('gateioBalanceTab').style.background = 'rgba(23,199,132,0.3)';
                document.getElementById('gateioBalanceTab').style.color = '#17C784';
            } else if (tabName === 'trading') {
                document.getElementById('gateioTradingContent').style.display = 'block';
                document.getElementById('gateioTradingTab').style.background = 'rgba(23,199,132,0.3)';
                document.getElementById('gateioTradingTab').style.color = '#17C784';
            }
        }

        // Balance tracking object
        const gateioBalanceTracking = {
            startingUSDT: 0,
            currentUSDT: 0
        };

        // Initialize Gate.io balance tracking
        async function initializeGateioBalance() {
            console.log('üí∞ [GATE.IO] Initializing balance tracking...');

            const apiKey = localStorage.getItem('gateio_triangular_api');
            const apiSecret = localStorage.getItem('gateio_triangular_secret');

            if (!apiKey || !apiSecret) {
                console.warn('‚ö†Ô∏è [GATE.IO] No API credentials configured - balance tracking disabled');
                return;
            }

            try {
                const response = await fetch('/api/v1/trading/gateio/balance', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({
                        apiKey,
                        apiSecret,
                        currency: 'USDT'
                    })
                });

                const data = await response.json();

                if (data.success) {
                    gateioBalanceTracking.startingUSDT = parseFloat(data.balance);
                    gateioBalanceTracking.currentUSDT = parseFloat(data.balance);
                    updateGateioBalanceDisplay();
                    console.log(`‚úÖ [GATE.IO] Balance initialized: $${data.balance} USDT`);
                } else {
                    console.error('‚ùå [GATE.IO] Failed to fetch balance:', data.message);
                }
            } catch (error) {
                console.error('‚ùå [GATE.IO] Balance initialization error:', error);
            }
        }

        // Update current Gate.io balance
        async function updateGateioBalance() {
            const apiKey = localStorage.getItem('gateio_triangular_api');
            const apiSecret = localStorage.getItem('gateio_triangular_secret');

            if (!apiKey || !apiSecret) {
                return;
            }

            try {
                const response = await fetch('/api/v1/trading/gateio/balance', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({
                        apiKey,
                        apiSecret,
                        currency: 'USDT'
                    })
                });

                const data = await response.json();

                if (data.success) {
                    gateioBalanceTracking.currentUSDT = parseFloat(data.balance);
                    updateGateioBalanceDisplay();
                }
            } catch (error) {
                console.error('‚ùå [GATE.IO] Balance update error:', error);
            }
        }

        // Update balance display
        function updateGateioBalanceDisplay() {
            const startingElement = document.getElementById('gateioStartingUSDT');
            const currentElement = document.getElementById('gateioCurrentUSDT');
            const changeElement = document.getElementById('gateioChangeUSDT');

            if (!startingElement || !currentElement || !changeElement) {
                return;
            }

            const starting = gateioBalanceTracking.startingUSDT;
            const current = gateioBalanceTracking.currentUSDT;
            const change = current - starting;
            const changePercent = starting > 0 ? ((change / starting) * 100).toFixed(2) : '0.00';

            startingElement.textContent = `$${starting.toFixed(2)}`;
            currentElement.textContent = `$${current.toFixed(2)}`;

            const changeSign = change >= 0 ? '+' : '';
            changeElement.textContent = `${changeSign}$${change.toFixed(2)} (${changeSign}${changePercent}%)`;
            changeElement.style.color = change >= 0 ? '#00d26a' : '#ff4444';
        }

        // Reset starting balance to current balance
        function resetGateioStartingBalance() {
            gateioBalanceTracking.startingUSDT = gateioBalanceTracking.currentUSDT;
            updateGateioBalanceDisplay();
            console.log('üîÑ [GATE.IO] Starting balance reset to current balance');
        }

        // 3. Save Gate.io Settings
        function saveGateioTriangularSettings() {
            const settings = {
                maxTrade: document.getElementById('gateioMaxTrade').value,
                portfolioPercent: document.getElementById('gateioPortfolioPercent').value,
                profitThreshold: document.getElementById('gateioProfitThreshold').value,
                set1Enabled: document.getElementById('gateioSet1Enabled').checked,
                set2Enabled: document.getElementById('gateioSet2Enabled').checked,
                set3Enabled: document.getElementById('gateioSet3Enabled').checked,
                set4Enabled: document.getElementById('gateioSet4Enabled').checked,
                set5Enabled: document.getElementById('gateioSet5Enabled').checked
            };

            localStorage.setItem('gateio_triangular_settings', JSON.stringify(settings));
            console.log('‚úÖ [GATE.IO] Settings saved:', settings);
        }

        // 4. Load Gate.io Settings
        function loadGateioTriangularSettings() {
            const saved = localStorage.getItem('gateio_triangular_settings');
            if (saved) {
                const settings = JSON.parse(saved);
                document.getElementById('gateioMaxTrade').value = settings.maxTrade || 100;
                document.getElementById('gateioPortfolioPercent').value = settings.portfolioPercent || 5;
                document.getElementById('gateioProfitThreshold').value = settings.profitThreshold || 0.3;
                document.getElementById('gateioSet1Enabled').checked = settings.set1Enabled !== false;
                document.getElementById('gateioSet2Enabled').checked = settings.set2Enabled !== false;
                document.getElementById('gateioSet3Enabled').checked = settings.set3Enabled === true;
                document.getElementById('gateioSet4Enabled').checked = settings.set4Enabled === true;
                document.getElementById('gateioSet5Enabled').checked = settings.set5Enabled === true;
                console.log('‚úÖ [GATE.IO] Settings loaded:', settings);
            }
        }

        // 5. Scan Gate.io Triangular Paths
        async function scanGateioTriangularPaths() {
            try {
                const apiKey = localStorage.getItem('gateio_triangular_api');
                const apiSecret = localStorage.getItem('gateio_triangular_secret');

                if (!apiKey || !apiSecret) {
                    alert('‚ùå Gate.io API credentials not found!\n\nPlease set your API credentials on the SETUP page first.');
                    return;
                }

                const maxTradeAmount = parseFloat(document.getElementById('gateioMaxTrade').value);
                const portfolioPercent = parseFloat(document.getElementById('gateioPortfolioPercent').value);
                const profitThreshold = parseFloat(document.getElementById('gateioProfitThreshold').value);

                const enabledSets = {
                    SET_1_ESSENTIAL_ETH_BRIDGE: document.getElementById('gateioSet1Enabled').checked,
                    SET_2_MIDCAP_BTC_BRIDGE: document.getElementById('gateioSet2Enabled').checked,
                    SET_3_GT_NATIVE_BRIDGE: document.getElementById('gateioSet3Enabled').checked,
                    SET_4_HIGH_VOLATILITY: document.getElementById('gateioSet4Enabled').checked,
                    SET_5_EXTENDED_MULTIBRIDGE: document.getElementById('gateioSet5Enabled').checked
                };

                // Switch to trading tab to show results
                switchGateioTab('trading');

                document.getElementById('gateioOpportunities').innerHTML = '<div style="text-align: center; padding: 20px;">‚è≥ Analyzing market data...</div>';

                const response = await fetch('/api/v1/trading/gateio/triangular/scan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({
                        apiKey,
                        apiSecret,
                        maxTradeAmount,
                        portfolioPercent,
                        profitThreshold,
                        enabledSets
                    })
                });

                const result = await response.json();

                if (result.success) {
                    document.getElementById('gateioScanStatus').innerHTML = `‚úÖ Scanned ${result.scanned} paths | Found ${result.opportunities.length} opportunities`;

                    if (result.opportunities.length === 0) {
                        document.getElementById('gateioOpportunities').innerHTML = `
                            <div style="text-align: center; padding: 30px; color: #888;">
                                <div style="font-size: 48px; margin-bottom: 15px;">üìä</div>
                                <div style="font-size: 16px; font-weight: 600; margin-bottom: 10px;">No Opportunities Found</div>
                                <div style="font-size: 14px;">Try lowering the profit threshold or enabling more path sets</div>
                            </div>
                        `;
                    } else {
                        let opportunitiesHtml = '<div style="display: grid; gap: 15px;">';

                        result.opportunities.forEach((opp, index) => {
                            const profitClass = parseFloat(opp.profitPercent) >= 1.0 ? '#17C784' : '#FFA500';

                            opportunitiesHtml += `
                                <div style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: 10px; border-left: 4px solid ${profitClass};">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                        <div>
                                            <div style="color: ${profitClass}; font-weight: 600; font-size: 16px; margin-bottom: 5px;">
                                                ${opp.path}
                                            </div>
                                            <div style="color: #888; font-size: 13px;">${opp.description}</div>
                                        </div>
                                        <div style="text-align: right;">
                                            <div style="color: ${profitClass}; font-weight: 700; font-size: 20px;">+${opp.profitPercent}%</div>
                                            <div style="color: #888; font-size: 13px;">$${opp.profit} USDT</div>
                                        </div>
                                    </div>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1);">
                                        <div>
                                            <div style="color: #888; font-size: 11px;">Initial</div>
                                            <div style="color: white; font-weight: 600;">${opp.initialAmount} USDT</div>
                                        </div>
                                        <div>
                                            <div style="color: #888; font-size: 11px;">Final</div>
                                            <div style="color: white; font-weight: 600;">${opp.finalAmount} USDT</div>
                                        </div>
                                        <div>
                                            <div style="color: #888; font-size: 11px;">Pairs</div>
                                            <div style="color: white; font-size: 12px;">${opp.pairs.join(' ‚Üí ')}</div>
                                        </div>
                                    </div>
                                    <button onclick="executeGateioTriangularTrade('${opp.pathId}', true)" style="width: 100%; margin-top: 12px; padding: 8px; background: rgba(23,199,132,0.2); color: #17C784; border: 1px solid #17C784; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px;">
                                        üß™ DRY RUN TEST
                                    </button>
                                </div>
                            `;
                        });

                        opportunitiesHtml += '</div>';
                        document.getElementById('gateioOpportunities').innerHTML = opportunitiesHtml;
                    }
                } else {
                    throw new Error(result.message);
                }

            } catch (error) {
                console.error('Gate.io scan error:', error);
                document.getElementById('gateioScanStatus').innerHTML = '‚ùå Scan failed';
                document.getElementById('gateioOpportunities').innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #FF4444;">
                        ‚ùå Error: ${error.message}
                    </div>
                `;
            }
        }

        // 6. Execute Gate.io Triangular Trade
        async function executeGateioTriangularTrade(pathId, dryRun = true) {
            try {
                const apiKey = localStorage.getItem('gateio_triangular_api');
                const apiSecret = localStorage.getItem('gateio_triangular_secret');

                if (!apiKey || !apiSecret) {
                    alert('‚ùå API credentials not found');
                    return;
                }

                const confirmed = confirm(`${dryRun ? 'üß™ DRY RUN' : '‚ö†Ô∏è LIVE EXECUTION'}\n\nExecute triangular arbitrage trade?\n\nPath ID: ${pathId}\n\nThis will ${dryRun ? 'simulate' : 'execute'} the trade.`);

                if (!confirmed) return;

                const response = await fetch('/api/v1/trading/gateio/triangular/execute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({
                        apiKey,
                        apiSecret,
                        pathId,
                        dryRun
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert(`‚úÖ ${dryRun ? 'DRY RUN' : 'EXECUTION'} Successful!\n\n${result.message}`);

                    // üìä Log to backend (only real trades, not dry runs)
                    if (!dryRun) {
                        logTriangularTrade('Gate.io', pathId, result.actualProfit || result.profit || 0, result.investmentAmount || 0, result.fees || 0).catch(e => console.warn('Logging failed:', e));
                    }
                } else {
                    throw new Error(result.message);
                }

            } catch (error) {
                console.error('Gate.io execution error:', error);
                alert(`‚ùå Execution Failed\n\n${error.message}`);
            }
        }

        // 7. Load Gate.io Trade History
        async function loadGateioTradeHistory() {
            try {
                const userId = localStorage.getItem('userId');
                if (!userId) return;

                const response = await fetch('/api/v1/trading/gateio/triangular/history', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({ userId, limit: 10 })
                });

                const result = await response.json();

                if (result.success && result.trades.length > 0) {
                    let historyHtml = '<div style="display: grid; gap: 10px;">';

                    result.trades.forEach(trade => {
                        const statusColor = trade.execution_status === 'completed' ? '#17C784' : '#FF4444';
                        const profitColor = parseFloat(trade.actual_profit_zar || 0) > 0 ? '#17C784' : '#FF4444';

                        historyHtml += `
                            <div style="background: rgba(255,255,255,0.03); padding: 12px; border-radius: 8px; border-left: 3px solid ${statusColor};">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span style="color: white; font-weight: 600; font-size: 13px;">${trade.path_sequence}</span>
                                    <span style="color: ${profitColor}; font-weight: 600;">${trade.actual_profit_zar ? '+' + trade.actual_profit_zar : '‚Äî'} USDT</span>
                                </div>
                                <div style="color: #888; font-size: 12px;">${new Date(trade.created_at).toLocaleString()}</div>
                            </div>
                        `;
                    });

                    historyHtml += '</div>';
                    document.getElementById('gateioTradeHistory').innerHTML = historyHtml;
                }
            } catch (error) {
                console.error('Gate.io history error:', error);
            }
        }

        // Initialize Gate.io settings on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ [GATE.IO] Initializing triangular arbitrage settings...');
            loadGateioTriangularSettings();

            const gateioInputs = document.querySelectorAll('#gateioMaxTrade, #gateioPortfolioPercent, #gateioProfitThreshold');
            gateioInputs.forEach(input => {
                input.addEventListener('change', saveGateioTriangularSettings);
            });

            for (let i = 1; i <= 5; i++) {
                const checkbox = document.getElementById(`gateioSet${i}Enabled`);
                if (checkbox) {
                    checkbox.addEventListener('change', saveGateioTriangularSettings);
                }
            }
        });

        // 8. Start Gate.io Worker (Sequential Scanning)
        function startGateioWorker() {
            console.log('üü¢ [GATE.IO] Starting worker with sequential path set scanning...');

            // Stop any existing worker
            if (gateioWorkerInterval) {
                clearInterval(gateioWorkerInterval);
            }

            // Reset stats
            gateioWorkerStats = {
                scansCompleted: 0,
                opportunitiesFound: 0,
                tradesExecuted: 0,
                lastScanTime: null
            };

            let currentSetIndex = 0;
            const pathSets = ['SET_1_ESSENTIAL_ETH_BRIDGE', 'SET_2_MIDCAP_BTC_BRIDGE', 'SET_3_GT_NATIVE_BRIDGE', 'SET_4_HIGH_VOLATILITY', 'SET_5_EXTENDED_MULTIBRIDGE'];

            // Worker loop: Scan one set at a time, wait 8 seconds, move to next set
            gateioWorkerInterval = setInterval(async () => {
                try {
                    const apiKey = localStorage.getItem('gateio_triangular_api');
                    const apiSecret = localStorage.getItem('gateio_triangular_secret');

                    if (!apiKey || !apiSecret) {
                        console.warn('‚ö†Ô∏è [GATE.IO] Missing credentials, worker paused');
                        return;
                    }

                    // Get enabled sets from settings
                    const enabledSets = [];
                    for (let i = 1; i <= 5; i++) {
                        const checkbox = document.getElementById(`gateioSet${i}Enabled`);
                        if (checkbox && checkbox.checked) {
                            enabledSets.push(pathSets[i - 1]);
                        }
                    }

                    if (enabledSets.length === 0) {
                        console.warn('‚ö†Ô∏è [GATE.IO] No path sets enabled');
                        return;
                    }

                    // Get current set to scan (cycle through enabled sets)
                    if (currentSetIndex >= enabledSets.length) {
                        currentSetIndex = 0;
                    }
                    const currentSet = enabledSets[currentSetIndex];

                    console.log(`üîç [GATE.IO] Worker scanning ${currentSet} (${currentSetIndex + 1}/${enabledSets.length})...`);

                    // Scan current set
                    const response = await fetch('/api/v1/trading/gateio/triangular/scan', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                        },
                        body: JSON.stringify({
                            apiKey,
                            apiSecret,
                            sets: [currentSet]  // Scan only one set at a time
                        })
                    });

                    const data = await response.json();

                    if (data.success && data.opportunities && data.opportunities.length > 0) {
                        console.log(`üíé [GATE.IO] Found ${data.opportunities.length} opportunities in ${currentSet}`);
                        gateioWorkerStats.opportunitiesFound += data.opportunities.length;
                        gateioWorkerStats.lastScanTime = new Date().toISOString();

                        // Display opportunities
                        displayGateioOpportunities(data.opportunities);

                        // Auto-execute if enabled
                        const autoExecute = document.getElementById('gateioAutoExecute')?.checked;
                        if (autoExecute) {
                            const bestOpp = data.opportunities[0];
                            await executeAutoTrade('gateio', bestOpp, apiKey, apiSecret);
                        }
                    }

                    gateioWorkerStats.scansCompleted++;

                    // Move to next set
                    currentSetIndex++;

                } catch (error) {
                    console.error('‚ùå [GATE.IO] Worker error:', error);
                }
            }, 8000);  // 8 second intervals between scans

            console.log(`‚úÖ [GATE.IO] Worker started - scanning ${pathSets.length} path sets sequentially`);
        }

        // 9. Stop Gate.io Worker
        function stopGateioWorker() {
            if (gateioWorkerInterval) {
                clearInterval(gateioWorkerInterval);
                gateioWorkerInterval = null;
                console.log('‚è∏Ô∏è [GATE.IO] Worker stopped');
                console.log('üìä [GATE.IO] Final stats:', gateioWorkerStats);
            }
        }

        // ============================================================================
        // CRYPTO.COM TRIANGULAR ARBITRAGE JAVASCRIPT FUNCTIONS
        // ============================================================================

        // Worker variables
        let cryptocomWorkerInterval = null;
        let cryptocomWorkerStats = {
            scansCompleted: 0,
            opportunitiesFound: 0,
            tradesExecuted: 0,
            lastScanTime: null
        };

        // 0. Toggle Crypto.com Triangular Trading
        function toggleCryptocomTriangular() {
            const toggle = document.getElementById('cryptocomTriangularEnabled');
            const status = document.getElementById('cryptocomTriangularStatus');
            const isActive = toggle.classList.toggle('active');

            if (isActive) {
                status.textContent = 'ON';
                status.style.color = '#0066FF';
                localStorage.setItem('cryptocomTriangularEnabled', 'true');
                console.log('‚úÖ [CRYPTO.COM] Live triangular trading enabled');
                startCryptocomWorker();  // Start worker
            } else {
                status.textContent = 'OFF';
                status.style.color = '#ff6b6b';
                localStorage.setItem('cryptocomTriangularEnabled', 'false');
                console.log('‚è∏Ô∏è [CRYPTO.COM] Live triangular trading disabled');
                stopCryptocomWorker();  // Stop worker
            }
        }

        // 1. Test Crypto.com Connection
        async function testCryptocomTriangularConnection() {
            try {
                const apiKey = localStorage.getItem('cryptocom_triangular_api');
                const apiSecret = localStorage.getItem('cryptocom_triangular_secret');

                if (!apiKey || !apiSecret) {
                    alert('‚ùå Crypto.com API credentials not found!\n\nPlease set your API credentials on the SETUP page first.');
                    return;
                }

                document.getElementById('cryptocomStatusText').textContent = 'Testing connection...';
                document.getElementById('cryptocomStatusIndicator').style.background = '#FFA500';

                const response = await fetch('/api/v1/trading/cryptocom/triangular/test-connection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({ apiKey, apiSecret })
                });

                const result = await response.json();

                if (result.success) {
                    document.getElementById('cryptocomStatusIndicator').style.background = '#0066FF';
                    document.getElementById('cryptocomStatusText').textContent = `Connected | ${result.balances.USDT} USDT`;
                    alert(`‚úÖ Crypto.com Connection Successful!\n\nUSDT Balance: ${result.balances.USDT}`);
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('Crypto.com connection error:', error);
                document.getElementById('cryptocomStatusIndicator').style.background = '#FF4444';
                document.getElementById('cryptocomStatusText').textContent = 'Connection Failed';
                alert(`‚ùå Crypto.com Connection Failed\n\n${error.message}`);
            }
        }

        // 2. View Crypto.com Path Details (Modal)
        function viewCryptocomPathDetails() {
            console.log('üìã [CRYPTO.COM] Opening paths modal');

            // Create modal overlay
            const modal = document.createElement('div');
            modal.id = 'cryptocomPathsModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.85);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                backdrop-filter: blur(5px);
            `;

            // Create modal content
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
                border: 2px solid #0066FF;
                border-radius: 15px;
                padding: 30px;
                max-width: 900px;
                max-height: 85vh;
                overflow-y: auto;
                box-shadow: 0 10px 50px rgba(0,102,255,0.3);
                position: relative;
            `;

            modalContent.innerHTML = `
                <!-- Header with close button -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid rgba(0,102,255,0.3); padding-bottom: 15px;">
                    <h2 style="color: #0066FF; margin: 0; font-size: 1.8rem;">üìã Crypto.com Triangular Arbitrage Paths</h2>
                    <button onclick="document.getElementById('cryptocomPathsModal').remove()" style="background: rgba(255,255,255,0.1); border: 1px solid #0066FF; color: #0066FF; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-size: 1.2rem; font-weight: bold;">‚úï</button>
                </div>

                <!-- Info banner -->
                <div style="background: rgba(0,102,255,0.1); padding: 15px; border-radius: 10px; margin-bottom: 25px; border-left: 4px solid #0066FF;">
                    <p style="color: #b8c6db; margin: 0; font-size: 0.95rem;">
                        <strong style="color: #0066FF;">32 Triangular Arbitrage Paths</strong> organized in 5 sets.
                        <br><br>
                        üåâ <strong>Bridge Currencies:</strong> ETH (Set 1), BTC (Set 2), CRO (Set 3), Mixed (Sets 4-5)
                        <br>
                        üí∞ <strong>Base Currency:</strong> USDT (Tether) - Fund Crypto.com with USDT only
                        <br>
                        üí° <strong>Default:</strong> Sets 1-2 enabled (14 paths) | Enable Sets 3-5 for 18 additional paths
                    </p>
                </div>

                <!-- SET 1: ESSENTIAL ETH BRIDGE (7 paths) - Color: #00d4ff -->
                <div style="background: rgba(0,212,255,0.05); padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #00d4ff;">
                    <h3 style="color: #00d4ff; margin: 0 0 15px 0; font-size: 1.3rem;">‚ú® SET 1: Essential ETH Bridge (7 paths) ‚úÖ ENABLED BY DEFAULT</h3>
                    <div style="display: grid; gap: 8px; font-size: 0.9rem; color: #b8c6db;">
                        <div>1. <strong style="color: #00d4ff;">USDT ‚Üí ETH ‚Üí BTC ‚Üí USDT</strong> <span style="color: #888;">(ETH_USDT, BTC_ETH, BTC_USDT)</span></div>
                        <div>2. <strong style="color: #00d4ff;">USDT ‚Üí ETH ‚Üí SOL ‚Üí USDT</strong> <span style="color: #888;">(ETH_USDT, SOL_ETH, SOL_USDT)</span></div>
                        <div>3. <strong style="color: #00d4ff;">USDT ‚Üí ETH ‚Üí XRP ‚Üí USDT</strong> <span style="color: #888;">(ETH_USDT, XRP_ETH, XRP_USDT)</span></div>
                        <div>4. <strong style="color: #00d4ff;">USDT ‚Üí ETH ‚Üí ADA ‚Üí USDT</strong> <span style="color: #888;">(ETH_USDT, ADA_ETH, ADA_USDT)</span></div>
                        <div>5. <strong style="color: #00d4ff;">USDT ‚Üí ETH ‚Üí MATIC ‚Üí USDT</strong> <span style="color: #888;">(ETH_USDT, MATIC_ETH, MATIC_USDT)</span></div>
                        <div>6. <strong style="color: #00d4ff;">USDT ‚Üí ETH ‚Üí DOT ‚Üí USDT</strong> <span style="color: #888;">(ETH_USDT, DOT_ETH, DOT_USDT)</span></div>
                        <div>7. <strong style="color: #00d4ff;">USDT ‚Üí ETH ‚Üí AVAX ‚Üí USDT</strong> <span style="color: #888;">(ETH_USDT, AVAX_ETH, AVAX_USDT)</span></div>
                    </div>
                </div>

                <!-- SET 2: MIDCAP BTC BRIDGE (7 paths) - Color: #0066FF -->
                <div style="background: rgba(0,102,255,0.05); padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #0066FF;">
                    <h3 style="color: #0066FF; margin: 0 0 15px 0; font-size: 1.3rem;">üî∑ SET 2: Mid-Cap BTC Bridge (7 paths) ‚úÖ ENABLED BY DEFAULT</h3>
                    <div style="display: grid; gap: 8px; font-size: 0.9rem; color: #b8c6db;">
                        <div>1. <strong style="color: #0066FF;">USDT ‚Üí BTC ‚Üí ETH ‚Üí USDT</strong> <span style="color: #888;">(BTC_USDT, ETH_BTC, ETH_USDT)</span></div>
                        <div>2. <strong style="color: #0066FF;">USDT ‚Üí BTC ‚Üí SOL ‚Üí USDT</strong> <span style="color: #888;">(BTC_USDT, SOL_BTC, SOL_USDT)</span></div>
                        <div>3. <strong style="color: #0066FF;">USDT ‚Üí BTC ‚Üí ADA ‚Üí USDT</strong> <span style="color: #888;">(BTC_USDT, ADA_BTC, ADA_USDT)</span></div>
                        <div>4. <strong style="color: #0066FF;">USDT ‚Üí BTC ‚Üí DOT ‚Üí USDT</strong> <span style="color: #888;">(BTC_USDT, DOT_BTC, DOT_USDT)</span></div>
                        <div>5. <strong style="color: #0066FF;">USDT ‚Üí BTC ‚Üí ATOM ‚Üí USDT</strong> <span style="color: #888;">(BTC_USDT, ATOM_BTC, ATOM_USDT)</span></div>
                        <div>6. <strong style="color: #0066FF;">USDT ‚Üí BTC ‚Üí LTC ‚Üí USDT</strong> <span style="color: #888;">(BTC_USDT, LTC_BTC, LTC_USDT)</span></div>
                        <div>7. <strong style="color: #0066FF;">USDT ‚Üí BTC ‚Üí XRP ‚Üí USDT</strong> <span style="color: #888;">(BTC_USDT, XRP_BTC, XRP_USDT)</span></div>
                    </div>
                </div>

                <!-- SET 3: CRO NATIVE BRIDGE (6 paths) - Color: #002D74 -->
                <div style="background: rgba(0,45,116,0.05); padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #002D74;">
                    <h3 style="color: #66a3ff; margin: 0 0 15px 0; font-size: 1.3rem;">üíé SET 3: CRO Native Bridge (6 paths) - Cronos Token</h3>
                    <div style="display: grid; gap: 8px; font-size: 0.9rem; color: #b8c6db;">
                        <div>1. <strong style="color: #66a3ff;">USDT ‚Üí CRO ‚Üí BTC ‚Üí USDT</strong> <span style="color: #888;">(CRO_USDT, BTC_CRO, BTC_USDT)</span></div>
                        <div>2. <strong style="color: #66a3ff;">USDT ‚Üí CRO ‚Üí ETH ‚Üí USDT</strong> <span style="color: #888;">(CRO_USDT, ETH_CRO, ETH_USDT)</span></div>
                        <div>3. <strong style="color: #66a3ff;">USDT ‚Üí CRO ‚Üí SOL ‚Üí USDT</strong> <span style="color: #888;">(CRO_USDT, SOL_CRO, SOL_USDT)</span></div>
                        <div>4. <strong style="color: #66a3ff;">USDT ‚Üí BTC ‚Üí CRO ‚Üí USDT</strong> <span style="color: #888;">(BTC_USDT, CRO_BTC, CRO_USDT)</span></div>
                        <div>5. <strong style="color: #66a3ff;">USDT ‚Üí ETH ‚Üí CRO ‚Üí USDT</strong> <span style="color: #888;">(ETH_USDT, CRO_ETH, CRO_USDT)</span></div>
                        <div>6. <strong style="color: #66a3ff;">USDT ‚Üí CRO ‚Üí MATIC ‚Üí USDT</strong> <span style="color: #888;">(CRO_USDT, MATIC_CRO, MATIC_USDT)</span></div>
                    </div>
                </div>

                <!-- SET 4: HIGH VOLATILITY (6 paths) - Color: #ffa500 -->
                <div style="background: rgba(255,165,0,0.05); padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #ffa500;">
                    <h3 style="color: #ffa500; margin: 0 0 15px 0; font-size: 1.3rem;">‚ö° SET 4: High Volatility (6 paths)</h3>
                    <div style="display: grid; gap: 8px; font-size: 0.9rem; color: #b8c6db;">
                        <div>1. <strong style="color: #ffa500;">USDT ‚Üí DOGE ‚Üí BTC ‚Üí USDT</strong> <span style="color: #888;">(DOGE_USDT, BTC_DOGE, BTC_USDT)</span></div>
                        <div>2. <strong style="color: #ffa500;">USDT ‚Üí SHIB ‚Üí ETH ‚Üí USDT</strong> <span style="color: #888;">(SHIB_USDT, ETH_SHIB, ETH_USDT)</span></div>
                        <div>3. <strong style="color: #ffa500;">USDT ‚Üí MATIC ‚Üí BTC ‚Üí USDT</strong> <span style="color: #888;">(MATIC_USDT, BTC_MATIC, BTC_USDT)</span></div>
                        <div>4. <strong style="color: #ffa500;">USDT ‚Üí SOL ‚Üí ETH ‚Üí USDT</strong> <span style="color: #888;">(SOL_USDT, ETH_SOL, ETH_USDT)</span></div>
                        <div>5. <strong style="color: #ffa500;">USDT ‚Üí ADA ‚Üí BTC ‚Üí USDT</strong> <span style="color: #888;">(ADA_USDT, BTC_ADA, BTC_USDT)</span></div>
                        <div>6. <strong style="color: #ffa500;">USDT ‚Üí DOT ‚Üí ETH ‚Üí USDT</strong> <span style="color: #888;">(DOT_USDT, ETH_DOT, ETH_USDT)</span></div>
                    </div>
                </div>

                <!-- SET 5: EXTENDED MULTIBRIDGE (6 paths) - Color: #8a2be2 -->
                <div style="background: rgba(138,43,226,0.05); padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #8a2be2;">
                    <h3 style="color: #8a2be2; margin: 0 0 15px 0; font-size: 1.3rem;">üîÅ SET 5: Extended Multi-Bridge (6 paths)</h3>
                    <div style="display: grid; gap: 8px; font-size: 0.9rem; color: #b8c6db;">
                        <div>1. <strong style="color: #8a2be2;">USDT ‚Üí SOL ‚Üí BTC ‚Üí USDT</strong> <span style="color: #888;">(SOL_USDT, BTC_SOL, BTC_USDT)</span></div>
                        <div>2. <strong style="color: #8a2be2;">USDT ‚Üí XRP ‚Üí ETH ‚Üí USDT</strong> <span style="color: #888;">(XRP_USDT, ETH_XRP, ETH_USDT)</span></div>
                        <div>3. <strong style="color: #8a2be2;">USDT ‚Üí AVAX ‚Üí BTC ‚Üí USDT</strong> <span style="color: #888;">(AVAX_USDT, BTC_AVAX, BTC_USDT)</span></div>
                        <div>4. <strong style="color: #8a2be2;">USDT ‚Üí ATOM ‚Üí ETH ‚Üí USDT</strong> <span style="color: #888;">(ATOM_USDT, ETH_ATOM, ETH_USDT)</span></div>
                        <div>5. <strong style="color: #8a2be2;">USDT ‚Üí BTC ‚Üí ETH ‚Üí SOL ‚Üí USDT</strong> ‚≠ê 4-LEG <span style="color: #888;">(BTC_USDT, ETH_BTC, SOL_ETH, SOL_USDT)</span></div>
                        <div>6. <strong style="color: #8a2be2;">USDT ‚Üí ETH ‚Üí BTC ‚Üí ADA ‚Üí USDT</strong> ‚≠ê 4-LEG <span style="color: #888;">(ETH_USDT, BTC_ETH, ADA_BTC, ADA_USDT)</span></div>
                    </div>
                </div>

                <!-- Summary Footer -->
                <div style="background: rgba(0,102,255,0.1); padding: 15px; border-radius: 10px; margin-top: 25px;">
                    <div style="display: grid; gap: 8px; font-size: 0.9rem; color: #b8c6db;">
                        <div>üí° <strong style="color: #0066FF;">TOTAL:</strong> 32 paths (30 three-leg + 2 four-leg)</div>
                        <div>üåâ <strong style="color: #0066FF;">BRIDGE:</strong> USDT (250+ digital assets)</div>
                        <div>üíé <strong style="color: #0066FF;">NATIVE:</strong> CRO (Cronos) for reduced fees</div>
                        <div>üîê <strong style="color: #0066FF;">AUTH:</strong> HMAC-SHA256 signature</div>
                        <div>üìä <strong style="color: #0066FF;">EXCHANGE:</strong> API v1 (v2.1 deprecated July 2024)</div>
                    </div>
                </div>
            `;

            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // Close on outside click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });

            console.log('‚úÖ [CRYPTO.COM] Paths modal opened');
        }

        // 3. Save Crypto.com Settings
        function saveCryptocomTriangularSettings() {
            const settings = {
                maxTrade: document.getElementById('cryptocomMaxTrade').value,
                portfolioPercent: document.getElementById('cryptocomPortfolioPercent').value,
                profitThreshold: document.getElementById('cryptocomProfitThreshold').value,
                set1Enabled: document.getElementById('cryptocomSet1Enabled').checked,
                set2Enabled: document.getElementById('cryptocomSet2Enabled').checked,
                set3Enabled: document.getElementById('cryptocomSet3Enabled').checked,
                set4Enabled: document.getElementById('cryptocomSet4Enabled').checked,
                set5Enabled: document.getElementById('cryptocomSet5Enabled').checked
            };

            localStorage.setItem('cryptocom_triangular_settings', JSON.stringify(settings));
            console.log('‚úÖ [CRYPTO.COM] Settings saved:', settings);
        }

        // 4. Load Crypto.com Settings
        function loadCryptocomTriangularSettings() {
            const saved = localStorage.getItem('cryptocom_triangular_settings');
            if (saved) {
                const settings = JSON.parse(saved);
                document.getElementById('cryptocomMaxTrade').value = settings.maxTrade || 100;
                document.getElementById('cryptocomPortfolioPercent').value = settings.portfolioPercent || 5;
                document.getElementById('cryptocomProfitThreshold').value = settings.profitThreshold || 0.3;
                document.getElementById('cryptocomSet1Enabled').checked = settings.set1Enabled !== false;
                document.getElementById('cryptocomSet2Enabled').checked = settings.set2Enabled !== false;
                document.getElementById('cryptocomSet3Enabled').checked = settings.set3Enabled === true;
                document.getElementById('cryptocomSet4Enabled').checked = settings.set4Enabled === true;
                document.getElementById('cryptocomSet5Enabled').checked = settings.set5Enabled === true;
                console.log('‚úÖ [CRYPTO.COM] Settings loaded:', settings);
            }
        }

        // 5. Scan Crypto.com Triangular Paths
        async function scanCryptocomTriangularPaths() {
            try {
                const apiKey = localStorage.getItem('cryptocom_triangular_api');
                const apiSecret = localStorage.getItem('cryptocom_triangular_secret');

                if (!apiKey || !apiSecret) {
                    alert('‚ùå Crypto.com API credentials not found!\n\nPlease set your API credentials on the SETUP page first.');
                    return;
                }

                const maxTradeAmount = parseFloat(document.getElementById('cryptocomMaxTrade').value);
                const portfolioPercent = parseFloat(document.getElementById('cryptocomPortfolioPercent').value);
                const profitThreshold = parseFloat(document.getElementById('cryptocomProfitThreshold').value);

                const enabledSets = {
                    SET_1_ESSENTIAL_ETH_BRIDGE: document.getElementById('cryptocomSet1Enabled').checked,
                    SET_2_MIDCAP_BTC_BRIDGE: document.getElementById('cryptocomSet2Enabled').checked,
                    SET_3_CRO_NATIVE_BRIDGE: document.getElementById('cryptocomSet3Enabled').checked,
                    SET_4_HIGH_VOLATILITY: document.getElementById('cryptocomSet4Enabled').checked,
                    SET_5_EXTENDED_MULTIBRIDGE: document.getElementById('cryptocomSet5Enabled').checked
                };

                document.getElementById('cryptocomScanStatus').innerHTML = 'üîç Scanning Crypto.com triangular paths...';
                document.getElementById('cryptocomOpportunities').innerHTML = '<div style="text-align: center; padding: 20px;">‚è≥ Analyzing market data...</div>';

                const response = await fetch('/api/v1/trading/cryptocom/triangular/scan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({
                        apiKey,
                        apiSecret,
                        maxTradeAmount,
                        portfolioPercent,
                        profitThreshold,
                        enabledSets
                    })
                });

                const result = await response.json();

                if (result.success) {
                    document.getElementById('cryptocomScanStatus').innerHTML = `‚úÖ Scanned ${result.scanned} paths | Found ${result.opportunities.length} opportunities`;

                    if (result.opportunities.length === 0) {
                        document.getElementById('cryptocomOpportunities').innerHTML = `
                            <div style="text-align: center; padding: 30px; color: #888;">
                                <div style="font-size: 48px; margin-bottom: 15px;">üìä</div>
                                <div style="font-size: 16px; font-weight: 600; margin-bottom: 10px;">No Opportunities Found</div>
                                <div style="font-size: 14px;">Try lowering the profit threshold or enabling more path sets</div>
                            </div>
                        `;
                    } else {
                        let opportunitiesHtml = '<div style="display: grid; gap: 15px;">';

                        result.opportunities.forEach((opp, index) => {
                            const profitClass = parseFloat(opp.profitPercent) >= 1.0 ? '#0066FF' : '#FFA500';

                            opportunitiesHtml += `
                                <div style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: 10px; border-left: 4px solid ${profitClass};">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                        <div>
                                            <div style="color: ${profitClass}; font-weight: 600; font-size: 16px; margin-bottom: 5px;">
                                                ${opp.path}
                                            </div>
                                            <div style="color: #888; font-size: 13px;">${opp.description}</div>
                                        </div>
                                        <div style="text-align: right;">
                                            <div style="color: ${profitClass}; font-weight: 700; font-size: 20px;">+${opp.profitPercent}%</div>
                                            <div style="color: #888; font-size: 13px;">$${opp.profit} USDT</div>
                                        </div>
                                    </div>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1);">
                                        <div>
                                            <div style="color: #888; font-size: 11px;">Initial</div>
                                            <div style="color: white; font-weight: 600;">${opp.initialAmount} USDT</div>
                                        </div>
                                        <div>
                                            <div style="color: #888; font-size: 11px;">Final</div>
                                            <div style="color: white; font-weight: 600;">${opp.finalAmount} USDT</div>
                                        </div>
                                        <div>
                                            <div style="color: #888; font-size: 11px;">Pairs</div>
                                            <div style="color: white; font-size: 12px;">${opp.pairs.join(' ‚Üí ')}</div>
                                        </div>
                                    </div>
                                    <button onclick="executeCryptocomTriangularTrade('${opp.pathId}', true)" style="width: 100%; margin-top: 12px; padding: 8px; background: rgba(0,102,255,0.2); color: #0066FF; border: 1px solid #0066FF; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px;">
                                        üß™ DRY RUN TEST
                                    </button>
                                </div>
                            `;
                        });

                        opportunitiesHtml += '</div>';
                        document.getElementById('cryptocomOpportunities').innerHTML = opportunitiesHtml;
                    }
                } else {
                    throw new Error(result.message);
                }

            } catch (error) {
                console.error('Crypto.com scan error:', error);
                document.getElementById('cryptocomScanStatus').innerHTML = '‚ùå Scan failed';
                document.getElementById('cryptocomOpportunities').innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #FF4444;">
                        ‚ùå Error: ${error.message}
                    </div>
                `;
            }
        }

        // 6. Execute Crypto.com Triangular Trade
        async function executeCryptocomTriangularTrade(pathId, dryRun = true) {
            try {
                const apiKey = localStorage.getItem('cryptocom_triangular_api');
                const apiSecret = localStorage.getItem('cryptocom_triangular_secret');

                if (!apiKey || !apiSecret) {
                    alert('‚ùå API credentials not found');
                    return;
                }

                const confirmed = confirm(`${dryRun ? 'üß™ DRY RUN' : '‚ö†Ô∏è LIVE EXECUTION'}\n\nExecute triangular arbitrage trade?\n\nPath ID: ${pathId}\n\nThis will ${dryRun ? 'simulate' : 'execute'} the trade.`);

                if (!confirmed) return;

                const response = await fetch('/api/v1/trading/cryptocom/triangular/execute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({
                        apiKey,
                        apiSecret,
                        pathId,
                        dryRun
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert(`‚úÖ ${dryRun ? 'DRY RUN' : 'EXECUTION'} Successful!\n\n${result.message}`);

                    // üìä Log to backend (only real trades, not dry runs)
                    if (!dryRun) {
                        logTriangularTrade('Crypto.com', pathId, result.actualProfit || result.profit || 0, result.investmentAmount || 0, result.fees || 0).catch(e => console.warn('Logging failed:', e));
                    }
                } else {
                    throw new Error(result.message);
                }

            } catch (error) {
                console.error('Crypto.com execution error:', error);
                alert(`‚ùå Execution Failed\n\n${error.message}`);
            }
        }

        // 7. Load Crypto.com Trade History
        async function loadCryptocomTradeHistory() {
            try {
                const userId = localStorage.getItem('userId');
                if (!userId) return;

                const response = await fetch('/api/v1/trading/cryptocom/triangular/history', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({ userId, limit: 10 })
                });

                const result = await response.json();

                if (result.success && result.trades.length > 0) {
                    let historyHtml = '<div style="display: grid; gap: 10px;">';

                    result.trades.forEach(trade => {
                        const statusColor = trade.execution_status === 'completed' ? '#0066FF' : '#FF4444';
                        const profitColor = parseFloat(trade.actual_profit_zar || 0) > 0 ? '#0066FF' : '#FF4444';

                        historyHtml += `
                            <div style="background: rgba(255,255,255,0.03); padding: 12px; border-radius: 8px; border-left: 3px solid ${statusColor};">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span style="color: white; font-weight: 600; font-size: 13px;">${trade.path_sequence}</span>
                                    <span style="color: ${profitColor}; font-weight: 600;">${trade.actual_profit_zar ? '+' + trade.actual_profit_zar : '‚Äî'} USDT</span>
                                </div>
                                <div style="color: #888; font-size: 12px;">${new Date(trade.created_at).toLocaleString()}</div>
                            </div>
                        `;
                    });

                    historyHtml += '</div>';
                    document.getElementById('cryptocomTradeHistory').innerHTML = historyHtml;
                }
            } catch (error) {
                console.error('Crypto.com history error:', error);
            }
        }

        // Tab switching function
        function switchCryptocomTab(tabName) {
            console.log(`üîÑ [CRYPTO.COM] Switching to ${tabName} tab`);

            // Hide all content divs
            document.getElementById('cryptocomBalanceContent').style.display = 'none';
            document.getElementById('cryptocomTradingContent').style.display = 'none';

            // Reset all tab button styles
            document.getElementById('cryptocomBalanceTab').style.background = 'rgba(255,255,255,0.05)';
            document.getElementById('cryptocomBalanceTab').style.color = '#b8c6db';
            document.getElementById('cryptocomTradingTab').style.background = 'rgba(255,255,255,0.05)';
            document.getElementById('cryptocomTradingTab').style.color = '#b8c6db';

            // Show selected content and activate button
            if (tabName === 'balance') {
                document.getElementById('cryptocomBalanceContent').style.display = 'block';
                document.getElementById('cryptocomBalanceTab').style.background = 'rgba(0,102,255,0.3)';
                document.getElementById('cryptocomBalanceTab').style.color = '#0066FF';
            } else if (tabName === 'trading') {
                document.getElementById('cryptocomTradingContent').style.display = 'block';
                document.getElementById('cryptocomTradingTab').style.background = 'rgba(0,102,255,0.3)';
                document.getElementById('cryptocomTradingTab').style.color = '#0066FF';
            }
        }

        // Balance tracking object
        const cryptocomBalanceTracking = {
            startingUSDT: 0,
            currentUSDT: 0
        };

        // Initialize Crypto.com balance tracking
        async function initializeCryptocomBalance() {
            console.log('üí∞ [CRYPTO.COM] Initializing balance tracking...');

            const apiKey = localStorage.getItem('cryptocom_triangular_api');
            const apiSecret = localStorage.getItem('cryptocom_triangular_secret');

            if (!apiKey || !apiSecret) {
                console.warn('‚ö†Ô∏è [CRYPTO.COM] No API credentials configured - balance tracking disabled');
                return;
            }

            try {
                const response = await fetch('/api/v1/trading/cryptocom/balance', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({
                        apiKey,
                        apiSecret,
                        currency: 'USDT'
                    })
                });

                const data = await response.json();

                if (data.success) {
                    cryptocomBalanceTracking.startingUSDT = parseFloat(data.balance);
                    cryptocomBalanceTracking.currentUSDT = parseFloat(data.balance);
                    updateCryptocomBalanceDisplay();
                    console.log('‚úÖ [CRYPTO.COM] Balance tracking initialized:', cryptocomBalanceTracking);
                }
            } catch (error) {
                console.error('‚ùå [CRYPTO.COM] Balance initialization failed:', error);
            }
        }

        // Update Crypto.com balance (fetch current balance)
        async function updateCryptocomBalance() {
            console.log('üîÑ [CRYPTO.COM] Updating balance...');

            const apiKey = localStorage.getItem('cryptocom_triangular_api');
            const apiSecret = localStorage.getItem('cryptocom_triangular_secret');

            if (!apiKey || !apiSecret) {
                return;
            }

            try {
                const response = await fetch('/api/v1/trading/cryptocom/balance', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({
                        apiKey,
                        apiSecret,
                        currency: 'USDT'
                    })
                });

                const data = await response.json();

                if (data.success) {
                    cryptocomBalanceTracking.currentUSDT = parseFloat(data.balance);
                    updateCryptocomBalanceDisplay();
                    console.log('‚úÖ [CRYPTO.COM] Balance updated:', cryptocomBalanceTracking);
                }
            } catch (error) {
                console.error('‚ùå [CRYPTO.COM] Balance update failed:', error);
            }
        }

        // Update balance display in UI
        function updateCryptocomBalanceDisplay() {
            const starting = cryptocomBalanceTracking.startingUSDT;
            const current = cryptocomBalanceTracking.currentUSDT;
            const change = current - starting;
            const changePercent = starting > 0 ? ((change / starting) * 100).toFixed(2) : '0.00';

            document.getElementById('cryptocomStartingUSDT').textContent = `$${starting.toFixed(2)}`;
            document.getElementById('cryptocomCurrentUSDT').textContent = `$${current.toFixed(2)}`;

            const changeSign = change >= 0 ? '+' : '';
            const changeColor = change >= 0 ? '#0066FF' : '#ff4444';
            document.getElementById('cryptocomChangeUSDT').innerHTML = `
                <span style="color: ${changeColor};">
                    ${changeSign}$${change.toFixed(2)} (${changeSign}${changePercent}%)
                </span>
            `;
        }

        // Reset starting balance
        function resetCryptocomStartingBalance() {
            cryptocomBalanceTracking.startingUSDT = cryptocomBalanceTracking.currentUSDT;
            updateCryptocomBalanceDisplay();
            console.log('üîÑ [CRYPTO.COM] Starting balance reset to current:', cryptocomBalanceTracking.currentUSDT);
        }

        // Initialize Crypto.com settings on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ [CRYPTO.COM] Initializing triangular arbitrage settings...');
            loadCryptocomTriangularSettings();

            const cryptocomInputs = document.querySelectorAll('#cryptocomMaxTrade, #cryptocomPortfolioPercent, #cryptocomProfitThreshold');
            cryptocomInputs.forEach(input => {
                input.addEventListener('change', saveCryptocomTriangularSettings);
            });

            for (let i = 1; i <= 5; i++) {
                const checkbox = document.getElementById(`cryptocomSet${i}Enabled`);
                if (checkbox) {
                    checkbox.addEventListener('change', saveCryptocomTriangularSettings);
                }
            }
        });

        // 8. Start Crypto.com Worker (Sequential Scanning)
        function startCryptocomWorker() {
            console.log('üîµ [CRYPTO.COM] Starting worker with sequential path set scanning...');

            // Stop any existing worker
            if (cryptocomWorkerInterval) {
                clearInterval(cryptocomWorkerInterval);
            }

            // Reset stats
            cryptocomWorkerStats = {
                scansCompleted: 0,
                opportunitiesFound: 0,
                tradesExecuted: 0,
                lastScanTime: null
            };

            let currentSetIndex = 0;
            const pathSets = ['SET_1_ESSENTIAL_ETH_BRIDGE', 'SET_2_BTC_BRIDGE', 'SET_3_CRO_NATIVE', 'SET_4_HIGH_VOLATILITY', 'SET_5_EXTENDED_MULTIBRIDGE'];

            // Worker loop: Scan one set at a time, wait 8 seconds, move to next set
            cryptocomWorkerInterval = setInterval(async () => {
                try {
                    const apiKey = localStorage.getItem('cryptocom_triangular_api');
                    const apiSecret = localStorage.getItem('cryptocom_triangular_secret');

                    if (!apiKey || !apiSecret) {
                        console.warn('‚ö†Ô∏è [CRYPTO.COM] Missing credentials, worker paused');
                        return;
                    }

                    // Get enabled sets from settings
                    const enabledSets = [];
                    for (let i = 1; i <= 5; i++) {
                        const checkbox = document.getElementById(`cryptocomSet${i}Enabled`);
                        if (checkbox && checkbox.checked) {
                            enabledSets.push(pathSets[i - 1]);
                        }
                    }

                    if (enabledSets.length === 0) {
                        console.warn('‚ö†Ô∏è [CRYPTO.COM] No path sets enabled');
                        return;
                    }

                    // Get current set to scan (cycle through enabled sets)
                    if (currentSetIndex >= enabledSets.length) {
                        currentSetIndex = 0;
                    }
                    const currentSet = enabledSets[currentSetIndex];

                    console.log(`üîç [CRYPTO.COM] Worker scanning ${currentSet} (${currentSetIndex + 1}/${enabledSets.length})...`);

                    // Scan current set
                    const response = await fetch('/api/v1/trading/cryptocom/triangular/scan', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                        },
                        body: JSON.stringify({
                            apiKey,
                            apiSecret,
                            sets: [currentSet]  // Scan only one set at a time
                        })
                    });

                    const data = await response.json();

                    if (data.success && data.opportunities && data.opportunities.length > 0) {
                        console.log(`üíé [CRYPTO.COM] Found ${data.opportunities.length} opportunities in ${currentSet}`);
                        cryptocomWorkerStats.opportunitiesFound += data.opportunities.length;
                        cryptocomWorkerStats.lastScanTime = new Date().toISOString();

                        // Display opportunities
                        displayCryptocomOpportunities(data.opportunities);

                        // Auto-execute if enabled
                        const autoExecute = document.getElementById('cryptocomAutoExecute')?.checked;
                        if (autoExecute) {
                            const bestOpp = data.opportunities[0];
                            await executeAutoTrade('cryptocom', bestOpp, apiKey, apiSecret);
                        }
                    }

                    cryptocomWorkerStats.scansCompleted++;

                    // Move to next set
                    currentSetIndex++;

                } catch (error) {
                    console.error('‚ùå [CRYPTO.COM] Worker error:', error);
                }
            }, 8000);  // 8 second intervals between scans

            console.log(`‚úÖ [CRYPTO.COM] Worker started - scanning ${pathSets.length} path sets sequentially`);
        }

        // 9. Stop Crypto.com Worker
        function stopCryptocomWorker() {
            if (cryptocomWorkerInterval) {
                clearInterval(cryptocomWorkerInterval);
                cryptocomWorkerInterval = null;
                console.log('‚è∏Ô∏è [CRYPTO.COM] Worker stopped');
                console.log('üìä [CRYPTO.COM] Final stats:', cryptocomWorkerStats);
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // MEXC TRIANGULAR ARBITRAGE FUNCTIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        // Worker variables
        let mexcWorkerInterval = null;
        let mexcWorkerStats = {
            scansCompleted: 0,
            opportunitiesFound: 0,
            tradesExecuted: 0,
            lastScanTime: null
        };

        // 0. Toggle MEXC Triangular Trading
        function toggleMexcTriangular() {
            const toggle = document.getElementById('mexcTriangularEnabled');
            const status = document.getElementById('mexcTriangularStatus');
            const isActive = toggle.classList.toggle('active');

            if (isActive) {
                status.textContent = 'ON';
                status.style.color = '#FFA500';
                localStorage.setItem('mexcTriangularEnabled', 'true');
                console.log('‚úÖ [MEXC] Live triangular trading enabled');
                startMexcWorker();  // Start worker
            } else {
                status.textContent = 'OFF';
                status.style.color = '#ff6b6b';
                localStorage.setItem('mexcTriangularEnabled', 'false');
                console.log('‚è∏Ô∏è [MEXC] Live triangular trading disabled');
                stopMexcWorker();  // Stop worker
            }
        }

        // 1. Test MEXC Connection
        async function testMexcTriangularConnection() {
            try {
                const apiKey = localStorage.getItem('mexc_triangular_api');
                const apiSecret = localStorage.getItem('mexc_triangular_secret');

                if (!apiKey || !apiSecret) {
                    alert('‚ùå MEXC API credentials not found!\n\nPlease set your API credentials on the SETUP page first.');
                    return;
                }

                document.getElementById('mexcStatusText').textContent = 'Testing connection...';
                document.getElementById('mexcStatusIndicator').style.background = '#FFA500';

                const response = await fetch('/api/v1/trading/mexc/triangular/test-connection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({ apiKey, apiSecret })
                });

                const result = await response.json();

                if (result.success) {
                    document.getElementById('mexcStatusIndicator').style.background = '#FFA500';
                    document.getElementById('mexcStatusText').textContent = `Connected | ${result.balances.USDT} USDT`;
                    alert(`‚úÖ MEXC Connection Successful!\n\nUSDT Balance: ${result.balances.USDT}\nüíé MX Balance: ${result.balances.MX}\n\nüéâ 0% Trading Fees Active!`);
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('MEXC connection error:', error);
                document.getElementById('mexcStatusIndicator').style.background = '#FF4444';
                document.getElementById('mexcStatusText').textContent = 'Connection Failed';
                alert(`‚ùå MEXC Connection Failed\n\n${error.message}`);
            }
        }

        // 2. View MEXC Path Details (Modal)
        function viewMexcPathDetails() {
            console.log('üìã [MEXC] Opening paths modal');

            // Create modal overlay
            const modal = document.createElement('div');
            modal.id = 'mexcPathsModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.85);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                backdrop-filter: blur(5px);
            `;

            // Create modal content
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
                border: 2px solid #FFA500;
                border-radius: 15px;
                padding: 30px;
                max-width: 900px;
                max-height: 85vh;
                overflow-y: auto;
                box-shadow: 0 10px 50px rgba(255,165,0,0.3);
                position: relative;
            `;

            modalContent.innerHTML = `
                <!-- Header with close button -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid rgba(255,165,0,0.3); padding-bottom: 15px;">
                    <h2 style="color: #FFA500; margin: 0; font-size: 1.8rem;">üìã MEXC Triangular Arbitrage Paths</h2>
                    <button onclick="document.getElementById('mexcPathsModal').remove()" style="background: rgba(255,255,255,0.1); border: 1px solid #FFA500; color: #FFA500; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-size: 1.2rem; font-weight: bold;">‚úï</button>
                </div>

                <!-- Info banner -->
                <div style="background: rgba(255,165,0,0.1); padding: 15px; border-radius: 10px; margin-bottom: 25px; border-left: 4px solid #FFA500;">
                    <p style="color: #b8c6db; margin: 0; font-size: 0.95rem;">
                        <strong style="color: #FFA500;">32 Triangular Arbitrage Paths</strong> organized in 5 sets.
                        <br><br>
                        üåâ <strong>Bridge Currencies:</strong> ETH (Set 1), BTC (Set 2), MX (Set 3), Mixed (Sets 4-5)
                        <br>
                        üí∞ <strong>Base Currency:</strong> USDT (Tether) - Fund MEXC with USDT only
                        <br>
                        üí° <strong>Default:</strong> Sets 1-2 enabled (14 paths) | Enable Sets 3-5 for 18 additional paths
                    </p>
                </div>

                <!-- SET 1: ESSENTIAL ETH BRIDGE (7 paths) - Color: #ffd700 -->
                <div style="background: rgba(255,215,0,0.05); padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #ffd700;">
                    <h3 style="color: #ffd700; margin: 0 0 15px 0; font-size: 1.3rem;">‚ú® SET 1: Essential ETH Bridge (7 paths) ‚úÖ ENABLED BY DEFAULT</h3>
                    <div style="display: grid; gap: 8px; font-size: 0.9rem; color: #b8c6db;">
                        <div>1. <strong style="color: #ffd700;">USDT ‚Üí ETH ‚Üí BTC ‚Üí USDT</strong> <span style="color: #888;">(ETHUSDT, BTCETH, BTCUSDT)</span></div>
                        <div>2. <strong style="color: #ffd700;">USDT ‚Üí ETH ‚Üí SOL ‚Üí USDT</strong> <span style="color: #888;">(ETHUSDT, SOLETH, SOLUSDT)</span></div>
                        <div>3. <strong style="color: #ffd700;">USDT ‚Üí ETH ‚Üí XRP ‚Üí USDT</strong> <span style="color: #888;">(ETHUSDT, XRPETH, XRPUSDT)</span></div>
                        <div>4. <strong style="color: #ffd700;">USDT ‚Üí ETH ‚Üí ADA ‚Üí USDT</strong> <span style="color: #888;">(ETHUSDT, ADAETH, ADAUSDT)</span></div>
                        <div>5. <strong style="color: #ffd700;">USDT ‚Üí ETH ‚Üí MATIC ‚Üí USDT</strong> <span style="color: #888;">(ETHUSDT, MATICETH, MATICUSDT)</span></div>
                        <div>6. <strong style="color: #ffd700;">USDT ‚Üí ETH ‚Üí DOT ‚Üí USDT</strong> <span style="color: #888;">(ETHUSDT, DOTETH, DOTUSDT)</span></div>
                        <div>7. <strong style="color: #ffd700;">USDT ‚Üí ETH ‚Üí AVAX ‚Üí USDT</strong> <span style="color: #888;">(ETHUSDT, AVAXETH, AVAXUSDT)</span></div>
                    </div>
                </div>

                <!-- SET 2: MIDCAP BTC BRIDGE (7 paths) - Color: #FFA500 -->
                <div style="background: rgba(255,165,0,0.05); padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #FFA500;">
                    <h3 style="color: #FFA500; margin: 0 0 15px 0; font-size: 1.3rem;">üî∑ SET 2: Mid-Cap BTC Bridge (7 paths) ‚úÖ ENABLED BY DEFAULT</h3>
                    <div style="display: grid; gap: 8px; font-size: 0.9rem; color: #b8c6db;">
                        <div>1. <strong style="color: #FFA500;">USDT ‚Üí BTC ‚Üí ETH ‚Üí USDT</strong> <span style="color: #888;">(BTCUSDT, ETHBTC, ETHUSDT)</span></div>
                        <div>2. <strong style="color: #FFA500;">USDT ‚Üí BTC ‚Üí SOL ‚Üí USDT</strong> <span style="color: #888;">(BTCUSDT, SOLBTC, SOLUSDT)</span></div>
                        <div>3. <strong style="color: #FFA500;">USDT ‚Üí BTC ‚Üí XRP ‚Üí USDT</strong> <span style="color: #888;">(BTCUSDT, XRPBTC, XRPUSDT)</span></div>
                        <div>4. <strong style="color: #FFA500;">USDT ‚Üí BTC ‚Üí LTC ‚Üí USDT</strong> <span style="color: #888;">(BTCUSDT, LTCBTC, LTCUSDT)</span></div>
                        <div>5. <strong style="color: #FFA500;">USDT ‚Üí BTC ‚Üí LINK ‚Üí USDT</strong> <span style="color: #888;">(BTCUSDT, LINKBTC, LINKUSDT)</span></div>
                        <div>6. <strong style="color: #FFA500;">USDT ‚Üí BTC ‚Üí ATOM ‚Üí USDT</strong> <span style="color: #888;">(BTCUSDT, ATOMBTC, ATOMUSDT)</span></div>
                        <div>7. <strong style="color: #FFA500;">USDT ‚Üí BTC ‚Üí UNI ‚Üí USDT</strong> <span style="color: #888;">(BTCUSDT, UNIBTC, UNIUSDT)</span></div>
                    </div>
                </div>

                <!-- SET 3: MX NATIVE BRIDGE (6 paths) - Color: #ff8c00 -->
                <div style="background: rgba(255,140,0,0.05); padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #ff8c00;">
                    <h3 style="color: #ff8c00; margin: 0 0 15px 0; font-size: 1.3rem;">üü† SET 3: MX Native Bridge (6 paths) - MX Token (0% Fees!)</h3>
                    <div style="display: grid; gap: 8px; font-size: 0.9rem; color: #b8c6db;">
                        <div>1. <strong style="color: #ff8c00;">USDT ‚Üí MX ‚Üí BTC ‚Üí USDT</strong> <span style="color: #888;">(MXUSDT, BTCMX, BTCUSDT)</span></div>
                        <div>2. <strong style="color: #ff8c00;">USDT ‚Üí MX ‚Üí ETH ‚Üí USDT</strong> <span style="color: #888;">(MXUSDT, ETHMX, ETHUSDT)</span></div>
                        <div>3. <strong style="color: #ff8c00;">USDT ‚Üí MX ‚Üí SOL ‚Üí USDT</strong> <span style="color: #888;">(MXUSDT, SOLMX, SOLUSDT)</span></div>
                        <div>4. <strong style="color: #ff8c00;">USDT ‚Üí BTC ‚Üí MX ‚Üí USDT</strong> <span style="color: #888;">(BTCUSDT, MXBTC, MXUSDT)</span></div>
                        <div>5. <strong style="color: #ff8c00;">USDT ‚Üí ETH ‚Üí MX ‚Üí USDT</strong> <span style="color: #888;">(ETHUSDT, MXETH, MXUSDT)</span></div>
                        <div>6. <strong style="color: #ff8c00;">USDT ‚Üí MX ‚Üí BNB ‚Üí USDT</strong> <span style="color: #888;">(MXUSDT, BNBMX, BNBUSDT)</span></div>
                    </div>
                </div>

                <!-- SET 4: HIGH VOLATILITY (6 paths) - Color: #ff6347 -->
                <div style="background: rgba(255,99,71,0.05); padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #ff6347;">
                    <h3 style="color: #ff6347; margin: 0 0 15px 0; font-size: 1.3rem;">‚ö° SET 4: High Volatility (6 paths)</h3>
                    <div style="display: grid; gap: 8px; font-size: 0.9rem; color: #b8c6db;">
                        <div>1. <strong style="color: #ff6347;">USDT ‚Üí DOGE ‚Üí BTC ‚Üí USDT</strong> <span style="color: #888;">(DOGEUSDT, BTCDOGE, BTCUSDT)</span></div>
                        <div>2. <strong style="color: #ff6347;">USDT ‚Üí SHIB ‚Üí ETH ‚Üí USDT</strong> <span style="color: #888;">(SHIBUSDT, ETHSHIB, ETHUSDT)</span></div>
                        <div>3. <strong style="color: #ff6347;">USDT ‚Üí PEPE ‚Üí ETH ‚Üí USDT</strong> <span style="color: #888;">(PEPEUSDT, ETHPEPE, ETHUSDT)</span></div>
                        <div>4. <strong style="color: #ff6347;">USDT ‚Üí FLOKI ‚Üí BTC ‚Üí USDT</strong> <span style="color: #888;">(FLOKIUSDT, BTCFLOKI, BTCUSDT)</span></div>
                        <div>5. <strong style="color: #ff6347;">USDT ‚Üí TON ‚Üí ETH ‚Üí USDT</strong> <span style="color: #888;">(TONUSDT, ETHTON, ETHUSDT)</span></div>
                        <div>6. <strong style="color: #ff6347;">USDT ‚Üí SUI ‚Üí BTC ‚Üí USDT</strong> <span style="color: #888;">(SUIUSDT, BTCSUI, BTCUSDT)</span></div>
                    </div>
                </div>

                <!-- SET 5: EXTENDED MULTIBRIDGE (6 paths) - Color: #8a2be2 -->
                <div style="background: rgba(138,43,226,0.05); padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #8a2be2;">
                    <h3 style="color: #8a2be2; margin: 0 0 15px 0; font-size: 1.3rem;">üîÅ SET 5: Extended Multi-Bridge (6 paths)</h3>
                    <div style="display: grid; gap: 8px; font-size: 0.9rem; color: #b8c6db;">
                        <div>1. <strong style="color: #8a2be2;">USDT ‚Üí SOL ‚Üí BTC ‚Üí USDT</strong> <span style="color: #888;">(SOLUSDT, BTCSOL, BTCUSDT)</span></div>
                        <div>2. <strong style="color: #8a2be2;">USDT ‚Üí ADA ‚Üí BTC ‚Üí USDT</strong> <span style="color: #888;">(ADAUSDT, BTCADA, BTCUSDT)</span></div>
                        <div>3. <strong style="color: #8a2be2;">USDT ‚Üí AVAX ‚Üí BTC ‚Üí USDT</strong> <span style="color: #888;">(AVAXUSDT, BTCAVAX, BTCUSDT)</span></div>
                        <div>4. <strong style="color: #8a2be2;">USDT ‚Üí MATIC ‚Üí ETH ‚Üí USDT</strong> <span style="color: #888;">(MATICUSDT, ETHMATIC, ETHUSDT)</span></div>
                        <div>5. <strong style="color: #8a2be2;">USDT ‚Üí BTC ‚Üí ETH ‚Üí SOL ‚Üí USDT</strong> ‚≠ê 4-LEG <span style="color: #888;">(BTCUSDT, ETHBTC, SOLETH, SOLUSDT)</span></div>
                        <div>6. <strong style="color: #8a2be2;">USDT ‚Üí ETH ‚Üí BTC ‚Üí XRP ‚Üí USDT</strong> ‚≠ê 4-LEG <span style="color: #888;">(ETHUSDT, BTCETH, XRPBTC, XRPUSDT)</span></div>
                    </div>
                </div>

                <!-- Summary Footer -->
                <div style="background: rgba(255,165,0,0.1); padding: 15px; border-radius: 10px; margin-top: 25px;">
                    <div style="display: grid; gap: 8px; font-size: 0.9rem; color: #b8c6db;">
                        <div>üí° <strong style="color: #FFA500;">TOTAL:</strong> 32 paths (30 three-leg + 2 four-leg)</div>
                        <div>üåâ <strong style="color: #FFA500;">BRIDGE:</strong> USDT (2,908+ trading pairs)</div>
                        <div>üü† <strong style="color: #FFA500;">NATIVE:</strong> MX token for 0% trading fees</div>
                        <div>üîê <strong style="color: #FFA500;">AUTH:</strong> HMAC-SHA256 signature</div>
                        <div>üìä <strong style="color: #FFA500;">EXCHANGE:</strong> MEXC Global (formerly MXC)</div>
                    </div>
                </div>
            `;

            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // Close on outside click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });

            console.log('‚úÖ [MEXC] Paths modal opened');
        }

        // 3. Switch MEXC Tab
        function switchMexcTab(tab) {
            console.log(`üîÑ [MEXC] Switching to tab: ${tab}`);

            if (tab === 'balance') {
                document.getElementById('mexcBalanceTab').classList.add('active');
                document.getElementById('mexcTradingTab').classList.remove('active');
                document.getElementById('mexcBalanceContent').style.display = 'block';
                document.getElementById('mexcTradingContent').style.display = 'none';
                console.log('‚úÖ [MEXC] Balance Tracker tab active');
            } else if (tab === 'trading') {
                document.getElementById('mexcBalanceTab').classList.remove('active');
                document.getElementById('mexcTradingTab').classList.add('active');
                document.getElementById('mexcBalanceContent').style.display = 'none';
                document.getElementById('mexcTradingContent').style.display = 'block';
                console.log('‚úÖ [MEXC] Current Opportunities tab active');
            }
        }

        // 4. MEXC Balance Tracking
        const mexcBalanceTracking = {
            starting: 0,
            current: 0,
            initialized: false
        };

        async function initializeMexcBalance() {
            try {
                const apiKey = localStorage.getItem('mexc_triangular_api');
                const apiSecret = localStorage.getItem('mexc_triangular_secret');

                if (!apiKey || !apiSecret) {
                    console.log('‚è∏Ô∏è [MEXC] API credentials not set - skipping balance initialization');
                    return;
                }

                console.log('üîÑ [MEXC] Fetching initial USDT balance...');

                const response = await fetch('/api/v1/trading/mexc/balance', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({ apiKey, apiSecret, currency: 'USDT' })
                });

                const result = await response.json();

                if (result.success) {
                    const balance = parseFloat(result.balance);
                    mexcBalanceTracking.starting = balance;
                    mexcBalanceTracking.current = balance;
                    mexcBalanceTracking.initialized = true;

                    updateMexcBalanceDisplay();
                    console.log(`‚úÖ [MEXC] Balance initialized: $${balance.toFixed(2)} USDT`);
                } else {
                    console.error('‚ùå [MEXC] Balance fetch failed:', result.error);
                }
            } catch (error) {
                console.error('‚ùå [MEXC] Balance initialization error:', error);
            }
        }

        async function updateMexcBalance() {
            try {
                const apiKey = localStorage.getItem('mexc_triangular_api');
                const apiSecret = localStorage.getItem('mexc_triangular_secret');

                if (!apiKey || !apiSecret) {
                    return;
                }

                const response = await fetch('/api/v1/trading/mexc/balance', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({ apiKey, apiSecret, currency: 'USDT' })
                });

                const result = await response.json();

                if (result.success) {
                    mexcBalanceTracking.current = parseFloat(result.balance);
                    updateMexcBalanceDisplay();
                    console.log(`üîÑ [MEXC] Balance updated: $${mexcBalanceTracking.current.toFixed(2)} USDT`);
                }
            } catch (error) {
                console.error('‚ùå [MEXC] Balance update error:', error);
            }
        }

        function updateMexcBalanceDisplay() {
            const starting = mexcBalanceTracking.starting;
            const current = mexcBalanceTracking.current;
            const change = current - starting;
            const changePercent = starting > 0 ? ((change / starting) * 100).toFixed(2) : '0.00';

            document.getElementById('mexcStartingUSDT').innerHTML = `
                <div style="text-align: center;">
                    <div style="color: #888; font-size: 0.85rem; margin-bottom: 5px;">üí∞ Starting Balance</div>
                    <div style="color: white; font-size: 1.3rem; font-weight: 600;">$${starting.toFixed(2)}</div>
                    <div style="color: #888; font-size: 0.8rem;">USDT</div>
                </div>
            `;

            document.getElementById('mexcCurrentUSDT').innerHTML = `
                <div style="text-align: center;">
                    <div style="color: #888; font-size: 0.85rem; margin-bottom: 5px;">üìä Current Balance</div>
                    <div style="color: white; font-size: 1.3rem; font-weight: 600;">$${current.toFixed(2)}</div>
                    <div style="color: #888; font-size: 0.8rem;">USDT</div>
                </div>
            `;

            const changeColor = change >= 0 ? '#FFA500' : '#ff4444';
            const changeSign = change >= 0 ? '+' : '';

            document.getElementById('mexcChangeUSDT').innerHTML = `
                <div style="text-align: center;">
                    <div style="color: #888; font-size: 0.85rem; margin-bottom: 5px;">üìà Change</div>
                    <div style="color: ${changeColor}; font-size: 1.3rem; font-weight: 600;">${changeSign}$${change.toFixed(2)}</div>
                    <div style="color: ${changeColor}; font-size: 0.9rem;">${changeSign}${changePercent}%</div>
                </div>
            `;
        }

        function resetMexcStartingBalance() {
            if (confirm('üîÑ Reset MEXC Starting Balance?\n\nThis will set your current balance as the new baseline for tracking.')) {
                mexcBalanceTracking.starting = mexcBalanceTracking.current;
                updateMexcBalanceDisplay();
                console.log(`‚úÖ [MEXC] Starting balance reset to $${mexcBalanceTracking.starting.toFixed(2)}`);
            }
        }

        // 5. Save MEXC Settings
        function saveMexcTriangularSettings() {
            const settings = {
                maxTrade: document.getElementById('mexcMaxTrade').value,
                portfolioPercent: document.getElementById('mexcPortfolioPercent').value,
                profitThreshold: document.getElementById('mexcProfitThreshold').value,
                set1Enabled: document.getElementById('mexcSet1Enabled').checked,
                set2Enabled: document.getElementById('mexcSet2Enabled').checked,
                set3Enabled: document.getElementById('mexcSet3Enabled').checked,
                set4Enabled: document.getElementById('mexcSet4Enabled').checked,
                set5Enabled: document.getElementById('mexcSet5Enabled').checked
            };

            localStorage.setItem('mexc_triangular_settings', JSON.stringify(settings));
            console.log('‚úÖ [MEXC] Settings saved:', settings);
        }

        // 4. Load MEXC Settings
        function loadMexcTriangularSettings() {
            const saved = localStorage.getItem('mexc_triangular_settings');
            if (saved) {
                const settings = JSON.parse(saved);
                document.getElementById('mexcMaxTrade').value = settings.maxTrade || 100;
                document.getElementById('mexcPortfolioPercent').value = settings.portfolioPercent || 5;
                document.getElementById('mexcProfitThreshold').value = settings.profitThreshold || 0.3;
                document.getElementById('mexcSet1Enabled').checked = settings.set1Enabled !== false;
                document.getElementById('mexcSet2Enabled').checked = settings.set2Enabled !== false;
                document.getElementById('mexcSet3Enabled').checked = settings.set3Enabled === true;
                document.getElementById('mexcSet4Enabled').checked = settings.set4Enabled === true;
                document.getElementById('mexcSet5Enabled').checked = settings.set5Enabled === true;
                console.log('‚úÖ [MEXC] Settings loaded:', settings);
            }
        }

        // 5. Scan MEXC Triangular Paths
        async function scanMexcTriangularPaths() {
            try {
                const apiKey = localStorage.getItem('mexc_triangular_api');
                const apiSecret = localStorage.getItem('mexc_triangular_secret');

                if (!apiKey || !apiSecret) {
                    alert('‚ùå MEXC API credentials not found!\n\nPlease set your API credentials on the SETUP page first.');
                    return;
                }

                const maxTradeAmount = parseFloat(document.getElementById('mexcMaxTrade').value);
                const portfolioPercent = parseFloat(document.getElementById('mexcPortfolioPercent').value);
                const profitThreshold = parseFloat(document.getElementById('mexcProfitThreshold').value);

                const enabledSets = {
                    SET_1_ESSENTIAL_ETH_BRIDGE: document.getElementById('mexcSet1Enabled').checked,
                    SET_2_MIDCAP_BTC_BRIDGE: document.getElementById('mexcSet2Enabled').checked,
                    SET_3_MX_NATIVE_BRIDGE: document.getElementById('mexcSet3Enabled').checked,
                    SET_4_HIGH_VOLATILITY: document.getElementById('mexcSet4Enabled').checked,
                    SET_5_EXTENDED_MULTIBRIDGE: document.getElementById('mexcSet5Enabled').checked
                };

                document.getElementById('mexcScanStatus').textContent = 'üîç Scanning MEXC paths...';
                document.getElementById('mexcOpportunities').innerHTML = '<div style="text-align: center; padding: 20px; color: #FFA500;">‚è≥ Analyzing 2,908+ pairs...</div>';

                const response = await fetch('/api/v1/trading/mexc/triangular/scan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({ apiKey, apiSecret, maxTradeAmount, portfolioPercent, profitThreshold, enabledSets })
                });

                const result = await response.json();

                if (result.success && result.opportunities.length > 0) {
                    document.getElementById('mexcScanStatus').textContent = `‚úÖ Found ${result.opportunities.length} opportunities`;

                    let oppsHtml = '<div style="display: grid; gap: 15px;">';
                    result.opportunities.forEach(opp => {
                        const profitColor = parseFloat(opp.profitPercent) >= 1 ? '#00ff88' : '#FFA500';
                        const riskColor = opp.risk === 'EXECUTE' ? '#00ff88' : opp.risk === 'CAUTIOUS' ? '#FFA500' : '#FF4444';

                        oppsHtml += `
                            <div style="background: rgba(255,165,0,0.1); padding: 15px; border-radius: 10px; border-left: 4px solid ${profitColor};">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <span style="color: white; font-weight: 600; font-size: 15px;">${opp.path.join(' ‚Üí ')}</span>
                                    <span style="color: ${profitColor}; font-weight: 700; font-size: 16px;">+${opp.profitPercent}%</span>
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px; font-size: 13px;">
                                    <div><span style="color: #888;">Expected:</span> <span style="color: white;">${opp.expectedProfitZAR} USDT</span></div>
                                    <div><span style="color: #888;">Risk:</span> <span style="color: ${riskColor};">${opp.risk}</span></div>
                                    <div><span style="color: #888;">Slippage:</span> <span style="color: white;">${opp.estimatedSlippage}%</span></div>
                                </div>
                                <div style="margin-top: 12px; display: flex; gap: 8px;">
                                    <button onclick='executeMexcTriangularTrade(${JSON.stringify(opp)})' style="flex: 1; padding: 8px; background: #FFA500; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px;">
                                        ‚ö° EXECUTE
                                    </button>
                                    <button onclick='alert("Path: ${opp.pairs.join(" ‚Üí ")}")' style="flex: 1; padding: 8px; background: rgba(255,165,0,0.2); color: #FFA500; border: 1px solid #FFA500; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px;">
                                        üìä Details
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                    oppsHtml += '</div>';

                    document.getElementById('mexcOpportunities').innerHTML = oppsHtml;
                } else {
                    document.getElementById('mexcScanStatus').textContent = '‚ùå No profitable opportunities found';
                    document.getElementById('mexcOpportunities').innerHTML = '<div style="text-align: center; padding: 20px; color: #888;">No opportunities above profit threshold. Try lowering threshold or enabling more path sets.</div>';
                }
            } catch (error) {
                console.error('MEXC scan error:', error);
                document.getElementById('mexcScanStatus').textContent = '‚ùå Scan failed';
                document.getElementById('mexcOpportunities').innerHTML = `<div style="color: #FF4444; padding: 20px; text-align: center;">Error: ${error.message}</div>`;
            }
        }

        // 6. Execute MEXC Triangular Trade
        async function executeMexcTriangularTrade(opportunity) {
            try {
                const confirmation = confirm(`üü† EXECUTE MEXC TRIANGULAR TRADE\n\nPath: ${opportunity.path.join(' ‚Üí ')}\nExpected Profit: ${opportunity.profitPercent}% (+${opportunity.expectedProfitZAR} USDT)\nRisk: ${opportunity.risk}\n\n‚ö†Ô∏è This will execute a real trade on MEXC.\nContinue?`);

                if (!confirmation) {
                    return;
                }

                const apiKey = localStorage.getItem('mexc_triangular_api');
                const apiSecret = localStorage.getItem('mexc_triangular_secret');
                const userId = localStorage.getItem('userId');

                const response = await fetch('/api/v1/trading/mexc/triangular/execute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({
                        apiKey,
                        apiSecret,
                        userId,
                        opportunity,
                        dryRun: false
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert(`‚úÖ MEXC Trade Executed!\n\nPath: ${opportunity.path.join(' ‚Üí ')}\nActual Profit: ${result.actualProfitZAR} USDT (${result.actualProfitPercent}%)\nExecution Time: ${result.executionTime}ms\n\nTrade ID: ${result.tradeId}`);

                    // üìä Log to backend using shared service
                    logTriangularTrade('MEXC', opportunity.path ? opportunity.path.join('‚Üí') : 'MEXC_PATH', result.actualProfitZAR || 0, opportunity.investmentAmount || 0, result.fees || 0).catch(e => console.warn('Logging failed:', e));

                    loadMexcTradeHistory();
                    scanMexcTriangularPaths(); // Refresh opportunities
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('MEXC execution error:', error);
                alert(`‚ùå MEXC Trade Failed\n\n${error.message}`);
            }
        }

        // 7. Load MEXC Trade History
        async function loadMexcTradeHistory() {
            try {
                const userId = localStorage.getItem('userId');
                if (!userId) return;

                const response = await fetch('/api/v1/trading/mexc/triangular/history', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({ userId, limit: 10 })
                });

                const result = await response.json();

                if (result.success && result.trades.length > 0) {
                    let historyHtml = '<div style="display: grid; gap: 10px;">';

                    result.trades.forEach(trade => {
                        const statusColor = trade.execution_status === 'completed' ? '#FFA500' : '#FF4444';
                        const profitColor = parseFloat(trade.actual_profit_zar || 0) > 0 ? '#00ff88' : '#FF4444';

                        historyHtml += `
                            <div style="background: rgba(255,255,255,0.03); padding: 12px; border-radius: 8px; border-left: 3px solid ${statusColor};">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span style="color: white; font-weight: 600; font-size: 13px;">${trade.path_sequence}</span>
                                    <span style="color: ${profitColor}; font-weight: 600;">${trade.actual_profit_zar ? '+' + trade.actual_profit_zar : '‚Äî'} USDT</span>
                                </div>
                                <div style="color: #888; font-size: 12px;">${new Date(trade.created_at).toLocaleString()}</div>
                            </div>
                        `;
                    });

                    historyHtml += '</div>';
                    document.getElementById('mexcTradeHistory').innerHTML = historyHtml;
                }
            } catch (error) {
                console.error('MEXC history error:', error);
            }
        }

        // 8. Start MEXC Worker (Sequential Scanning)
        function startMexcWorker() {
            console.log('üü† [MEXC] Starting worker with sequential path set scanning...');

            // Stop any existing worker
            if (mexcWorkerInterval) {
                clearInterval(mexcWorkerInterval);
            }

            // Reset stats
            mexcWorkerStats = {
                scansCompleted: 0,
                opportunitiesFound: 0,
                tradesExecuted: 0,
                lastScanTime: null
            };

            let currentSetIndex = 0;
            const pathSets = ['SET_1_ESSENTIAL_ETH_BRIDGE', 'SET_2_MIDCAP_BTC_BRIDGE', 'SET_3_MX_NATIVE_BRIDGE', 'SET_4_HIGH_VOLATILITY', 'SET_5_EXTENDED_MULTIBRIDGE'];

            // Worker loop: Scan one set at a time, wait 8 seconds, move to next set
            mexcWorkerInterval = setInterval(async () => {
                try {
                    const apiKey = localStorage.getItem('mexc_triangular_api');
                    const apiSecret = localStorage.getItem('mexc_triangular_secret');

                    if (!apiKey || !apiSecret) {
                        console.warn('‚ö†Ô∏è [MEXC] Missing credentials, worker paused');
                        return;
                    }

                    // Get enabled sets from settings
                    const enabledSets = [];
                    for (let i = 1; i <= 5; i++) {
                        const checkbox = document.getElementById(`mexcSet${i}Enabled`);
                        if (checkbox && checkbox.checked) {
                            enabledSets.push(pathSets[i - 1]);
                        }
                    }

                    if (enabledSets.length === 0) {
                        console.warn('‚ö†Ô∏è [MEXC] No path sets enabled');
                        return;
                    }

                    // Get current set to scan
                    const currentSet = enabledSets[currentSetIndex % enabledSets.length];
                    console.log(`üîç [MEXC] Scanning ${currentSet} (${currentSetIndex % enabledSets.length + 1}/${enabledSets.length})...`);

                    // Scan the current set
                    const response = await fetch('/api/v1/trading/mexc/triangular/scan', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                        },
                        body: JSON.stringify({
                            apiKey,
                            apiSecret,
                            maxTradeAmount: parseFloat(document.getElementById('mexcMaxTrade')?.value || 1000),
                            portfolioPercent: parseFloat(document.getElementById('mexcPortfolioPercent')?.value || 10),
                            profitThreshold: parseFloat(document.getElementById('mexcProfitThreshold')?.value || 0.5),
                            enabledSets: [currentSet]  // Scan only one set at a time
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        mexcWorkerStats.scansCompleted++;
                        mexcWorkerStats.lastScanTime = new Date().toISOString();

                        // Check for profitable opportunities
                        const opportunities = result.opportunities || [];
                        const profitableOpps = opportunities.filter(opp => opp.profitPercentage >= parseFloat(document.getElementById('mexcProfitThreshold')?.value || 0.5));

                        mexcWorkerStats.opportunitiesFound += profitableOpps.length;

                        if (profitableOpps.length > 0) {
                            console.log(`‚úÖ [MEXC] Found ${profitableOpps.length} opportunities in ${currentSet}`);

                            // Auto-execute top opportunity if enabled
                            const autoExecute = localStorage.getItem('mexcAutoExecute') === 'true';
                            if (autoExecute && profitableOpps[0]) {
                                console.log(`ü§ñ [MEXC] Auto-executing top opportunity...`);
                                await executeAutoTrade(profitableOpps[0]);
                                mexcWorkerStats.tradesExecuted++;
                            }
                        }

                        // Update UI with worker stats
                        console.log(`üìä [MEXC] Stats - Scans: ${mexcWorkerStats.scansCompleted}, Opportunities: ${mexcWorkerStats.opportunitiesFound}, Trades: ${mexcWorkerStats.tradesExecuted}`);
                    }

                    // Move to next set
                    currentSetIndex++;

                } catch (error) {
                    console.error(`‚ùå [MEXC] Worker error:`, error);
                }
            }, 8000); // 8 seconds between scans

            console.log('‚úÖ [MEXC] Worker started - scanning every 8 seconds (sequential path sets)');
        }

        // 9. Stop MEXC Worker
        function stopMexcWorker() {
            if (mexcWorkerInterval) {
                clearInterval(mexcWorkerInterval);
                mexcWorkerInterval = null;
                console.log('‚è∏Ô∏è [MEXC] Worker stopped');
                console.log(`üìä [MEXC] Final Stats - Scans: ${mexcWorkerStats.scansCompleted}, Opportunities: ${mexcWorkerStats.opportunitiesFound}, Trades: ${mexcWorkerStats.tradesExecuted}`);
            }
        }

        // Helper: Auto-execute trade
        async function executeAutoTrade(opportunity) {
            try {
                const apiKey = localStorage.getItem('mexc_triangular_api');
                const apiSecret = localStorage.getItem('mexc_triangular_secret');

                const response = await fetch('/api/v1/trading/mexc/triangular/execute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({
                        pathId: opportunity.pathId,
                        amount: opportunity.startAmount,
                        apiKey,
                        apiSecret
                    })
                });

                const result = await response.json();

                if (result.success) {
                    console.log(`‚úÖ [MEXC] Auto-trade executed: ${opportunity.sequence} - Profit: ${result.data.actualProfitPercentage}%`);
                } else {
                    console.error(`‚ùå [MEXC] Auto-trade failed:`, result.message);
                }
            } catch (error) {
                console.error(`‚ùå [MEXC] Auto-execute error:`, error);
            }
        }

        // Initialize MEXC settings on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üü† [MEXC] Initializing triangular arbitrage settings...');
            loadMexcTriangularSettings();

            // Initialize balance tracker
            initializeMexcBalance();

            // Set default tab
            switchMexcTab('balance');

            const mexcInputs = document.querySelectorAll('#mexcMaxTrade, #mexcPortfolioPercent, #mexcProfitThreshold');
            mexcInputs.forEach(input => {
                input.addEventListener('change', saveMexcTriangularSettings);
            });

            for (let i = 1; i <= 5; i++) {
                const checkbox = document.getElementById(`mexcSet${i}Enabled`);
                if (checkbox) {
                    checkbox.addEventListener('change', saveMexcTriangularSettings);
                }
            }
        });

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // XT TRIANGULAR ARBITRAGE FUNCTIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        // Worker Variables
        let xtWorkerInterval = null;
        let xtWorkerStats = {
            totalScans: 0,
            totalOpportunities: 0,
            totalTrades: 0,
            successfulTrades: 0,
            totalProfit: 0,
            bestProfit: 0,
            bestPath: null,
            lastScanTime: null
        };

        // 1. Test XT Connection
        async function testXtTriangularConnection() {
            try {
                const apiKey = localStorage.getItem('xt_triangular_api');
                const apiSecret = localStorage.getItem('xt_triangular_secret');

                if (!apiKey || !apiSecret) {
                    alert('‚ùå XT API credentials not found!\n\nPlease set your API credentials on the SETUP page first.');
                    return;
                }

                document.getElementById('xtStatusText').textContent = 'Testing connection...';
                document.getElementById('xtStatusIndicator').style.background = '#0096FF';

                const response = await fetch('/api/v1/trading/xt/triangular/test-connection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({ apiKey, apiSecret })
                });

                const result = await response.json();

                if (result.success) {
                    document.getElementById('xtStatusIndicator').style.background = '#0096FF';
                    document.getElementById('xtStatusText').textContent = `Connected | ${result.balances.USDT} USDT`;
                    alert(`‚úÖ XT Connection Successful!\n\nUSDT Balance: ${result.balances.USDT}\nBTC Balance: ${result.balances.BTC}\nüöÄ XT Balance: ${result.balances.XT}\n\n‚ú® 7.8M Global Users`);
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('XT connection error:', error);
                document.getElementById('xtStatusIndicator').style.background = '#FF4444';
                document.getElementById('xtStatusText').textContent = 'Connection Failed';
                alert(`‚ùå XT Connection Failed\n\n${error.message}`);
            }
        }

        // 2. Toggle XT Triangular Trading
        function toggleXtTriangular() {
            const toggle = document.getElementById('xtTriangularEnabled');
            const status = document.getElementById('xtTriangularStatus');
            const isActive = toggle.classList.toggle('active');

            if (isActive) {
                status.textContent = 'ON';
                status.style.color = '#0096FF';
                localStorage.setItem('xtTriangularEnabled', 'true');
                console.log('üöÄ [XT] Triangular arbitrage enabled - starting worker...');
                startXtWorker();
            } else {
                status.textContent = 'OFF';
                status.style.color = '#ff6b6b';
                localStorage.setItem('xtTriangularEnabled', 'false');
                console.log('üöÄ [XT] Triangular arbitrage disabled - stopping worker...');
                stopXtWorker();
            }
        }

        // 3. View XT Path Details (Professional Modal)
        function viewXtPathDetails() {
            console.log('üìã [XT] Opening paths modal');

            const modal = document.createElement('div');
            modal.id = 'xtPathsModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.85);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                backdrop-filter: blur(5px);
            `;

            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
                border: 2px solid #0096FF;
                border-radius: 15px;
                padding: 30px;
                max-width: 900px;
                max-height: 85vh;
                overflow-y: auto;
                box-shadow: 0 10px 50px rgba(0,150,255,0.3);
                position: relative;
            `;

            modalContent.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid rgba(0,150,255,0.3); padding-bottom: 15px;">
                    <h3 style="color: #0096FF; margin: 0; font-size: 1.5rem;">üöÄ XT.COM Triangular Arbitrage Paths</h3>
                    <button onclick="document.getElementById('xtPathsModal').remove()"
                            style="background: rgba(255,255,255,0.1); border: 1px solid #666; color: #ddd; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                        ‚úï Close
                    </button>
                </div>

                <!-- SET 1: Essential ETH Bridge -->
                <div style="background: rgba(255,215,0,0.1); border-left: 4px solid #ffd700; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h4 style="color: #ffd700; margin: 0 0 15px 0; font-size: 1.2rem;">‚ú® SET 1: Essential ETH Bridge (7 paths)</h4>
                    <div style="color: #b8c6db; line-height: 1.8; font-size: 0.95rem;">
                        <div style="padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">1. USDT ‚Üí ETH ‚Üí BTC ‚Üí USDT <span style="color: #888; font-size: 0.85rem;">(eth_usdt, btc_eth, btc_usdt)</span></div>
                        <div style="padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">2. USDT ‚Üí ETH ‚Üí SOL ‚Üí USDT <span style="color: #888; font-size: 0.85rem;">(eth_usdt, sol_eth, sol_usdt)</span></div>
                        <div style="padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">3. USDT ‚Üí ETH ‚Üí XRP ‚Üí USDT <span style="color: #888; font-size: 0.85rem;">(eth_usdt, xrp_eth, xrp_usdt)</span></div>
                        <div style="padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">4. USDT ‚Üí ETH ‚Üí ADA ‚Üí USDT <span style="color: #888; font-size: 0.85rem;">(eth_usdt, ada_eth, ada_usdt)</span></div>
                        <div style="padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">5. USDT ‚Üí ETH ‚Üí MATIC ‚Üí USDT <span style="color: #888; font-size: 0.85rem;">(eth_usdt, matic_eth, matic_usdt)</span></div>
                        <div style="padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">6. USDT ‚Üí ETH ‚Üí DOT ‚Üí USDT <span style="color: #888; font-size: 0.85rem;">(eth_usdt, dot_eth, dot_usdt)</span></div>
                        <div style="padding: 8px 0;">7. USDT ‚Üí ETH ‚Üí AVAX ‚Üí USDT <span style="color: #888; font-size: 0.85rem;">(eth_usdt, avax_eth, avax_usdt)</span></div>
                    </div>
                </div>

                <!-- SET 2: Mid-Cap BTC Bridge -->
                <div style="background: rgba(0,150,255,0.1); border-left: 4px solid #0096FF; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h4 style="color: #0096FF; margin: 0 0 15px 0; font-size: 1.2rem;">üî∑ SET 2: Mid-Cap BTC Bridge (7 paths)</h4>
                    <div style="color: #b8c6db; line-height: 1.8; font-size: 0.95rem;">
                        <div style="padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">1. USDT ‚Üí BTC ‚Üí ETH ‚Üí USDT <span style="color: #888; font-size: 0.85rem;">(btc_usdt, eth_btc, eth_usdt)</span></div>
                        <div style="padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">2. USDT ‚Üí BTC ‚Üí SOL ‚Üí USDT <span style="color: #888; font-size: 0.85rem;">(btc_usdt, sol_btc, sol_usdt)</span></div>
                        <div style="padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">3. USDT ‚Üí BTC ‚Üí ADA ‚Üí USDT <span style="color: #888; font-size: 0.85rem;">(btc_usdt, ada_btc, ada_usdt)</span></div>
                        <div style="padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">4. USDT ‚Üí BTC ‚Üí DOT ‚Üí USDT <span style="color: #888; font-size: 0.85rem;">(btc_usdt, dot_btc, dot_usdt)</span></div>
                        <div style="padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">5. USDT ‚Üí BTC ‚Üí ATOM ‚Üí USDT <span style="color: #888; font-size: 0.85rem;">(btc_usdt, atom_btc, atom_usdt)</span></div>
                        <div style="padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">6. USDT ‚Üí BTC ‚Üí LTC ‚Üí USDT <span style="color: #888; font-size: 0.85rem;">(btc_usdt, ltc_btc, ltc_usdt)</span></div>
                        <div style="padding: 8px 0;">7. USDT ‚Üí BTC ‚Üí XRP ‚Üí USDT <span style="color: #888; font-size: 0.85rem;">(btc_usdt, xrp_btc, xrp_usdt)</span></div>
                    </div>
                </div>

                <!-- SET 3: XT Native Bridge -->
                <div style="background: rgba(0,191,255,0.1); border-left: 4px solid #00bfff; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h4 style="color: #00bfff; margin: 0 0 15px 0; font-size: 1.2rem;">üöÄ SET 3: XT Native Bridge (6 paths) - XT Token</h4>
                    <div style="color: #b8c6db; line-height: 1.8; font-size: 0.95rem;">
                        <div style="padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">1. USDT ‚Üí XT ‚Üí BTC ‚Üí USDT <span style="color: #888; font-size: 0.85rem;">(xt_usdt, btc_xt, btc_usdt)</span></div>
                        <div style="padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">2. USDT ‚Üí XT ‚Üí ETH ‚Üí USDT <span style="color: #888; font-size: 0.85rem;">(xt_usdt, eth_xt, eth_usdt)</span></div>
                        <div style="padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">3. USDT ‚Üí XT ‚Üí SOL ‚Üí USDT <span style="color: #888; font-size: 0.85rem;">(xt_usdt, sol_xt, sol_usdt)</span></div>
                        <div style="padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">4. USDT ‚Üí BTC ‚Üí XT ‚Üí USDT <span style="color: #888; font-size: 0.85rem;">(btc_usdt, xt_btc, xt_usdt)</span></div>
                        <div style="padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">5. USDT ‚Üí ETH ‚Üí XT ‚Üí USDT <span style="color: #888; font-size: 0.85rem;">(eth_usdt, xt_eth, xt_usdt)</span></div>
                        <div style="padding: 8px 0;">6. USDT ‚Üí XT ‚Üí MATIC ‚Üí USDT <span style="color: #888; font-size: 0.85rem;">(xt_usdt, matic_xt, matic_usdt)</span></div>
                    </div>
                </div>

                <!-- SET 4: High Volatility -->
                <div style="background: rgba(255,99,71,0.1); border-left: 4px solid #ff6347; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h4 style="color: #ff6347; margin: 0 0 15px 0; font-size: 1.2rem;">‚ö° SET 4: High Volatility (6 paths)</h4>
                    <div style="color: #b8c6db; line-height: 1.8; font-size: 0.95rem;">
                        <div style="padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">1. USDT ‚Üí DOGE ‚Üí BTC ‚Üí USDT <span style="color: #888; font-size: 0.85rem;">(doge_usdt, btc_doge, btc_usdt)</span></div>
                        <div style="padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">2. USDT ‚Üí SHIB ‚Üí ETH ‚Üí USDT <span style="color: #888; font-size: 0.85rem;">(shib_usdt, eth_shib, eth_usdt)</span></div>
                        <div style="padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">3. USDT ‚Üí MATIC ‚Üí BTC ‚Üí USDT <span style="color: #888; font-size: 0.85rem;">(matic_usdt, btc_matic, btc_usdt)</span></div>
                        <div style="padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">4. USDT ‚Üí SOL ‚Üí ETH ‚Üí USDT <span style="color: #888; font-size: 0.85rem;">(sol_usdt, eth_sol, eth_usdt)</span></div>
                        <div style="padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">5. USDT ‚Üí ADA ‚Üí BTC ‚Üí USDT <span style="color: #888; font-size: 0.85rem;">(ada_usdt, btc_ada, btc_usdt)</span></div>
                        <div style="padding: 8px 0;">6. USDT ‚Üí DOT ‚Üí ETH ‚Üí USDT <span style="color: #888; font-size: 0.85rem;">(dot_usdt, eth_dot, eth_usdt)</span></div>
                    </div>
                </div>

                <!-- SET 5: Extended Multi-Bridge -->
                <div style="background: rgba(138,43,226,0.1); border-left: 4px solid #8a2be2; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h4 style="color: #8a2be2; margin: 0 0 15px 0; font-size: 1.2rem;">üîÅ SET 5: Extended Multi-Bridge (6 paths)</h4>
                    <div style="color: #b8c6db; line-height: 1.8; font-size: 0.95rem;">
                        <div style="padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">1. USDT ‚Üí SOL ‚Üí BTC ‚Üí USDT <span style="color: #888; font-size: 0.85rem;">(sol_usdt, btc_sol, btc_usdt)</span></div>
                        <div style="padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">2. USDT ‚Üí XRP ‚Üí ETH ‚Üí USDT <span style="color: #888; font-size: 0.85rem;">(xrp_usdt, eth_xrp, eth_usdt)</span></div>
                        <div style="padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">3. USDT ‚Üí AVAX ‚Üí BTC ‚Üí USDT <span style="color: #888; font-size: 0.85rem;">(avax_usdt, btc_avax, btc_usdt)</span></div>
                        <div style="padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">4. USDT ‚Üí ATOM ‚Üí ETH ‚Üí USDT <span style="color: #888; font-size: 0.85rem;">(atom_usdt, eth_atom, eth_usdt)</span></div>
                        <div style="padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">5. USDT ‚Üí BTC ‚Üí ETH ‚Üí SOL ‚Üí USDT ‚≠ê 4-LEG <span style="color: #888; font-size: 0.85rem;">(btc_usdt, eth_btc, sol_eth, sol_usdt)</span></div>
                        <div style="padding: 8px 0;">6. USDT ‚Üí ETH ‚Üí BTC ‚Üí ADA ‚Üí USDT ‚≠ê 4-LEG <span style="color: #888; font-size: 0.85rem;">(eth_usdt, btc_eth, ada_btc, ada_usdt)</span></div>
                    </div>
                </div>

                <!-- Summary Footer -->
                <div style="background: rgba(0,150,255,0.15); border: 2px solid #0096FF; border-radius: 10px; padding: 20px; text-align: center;">
                    <div style="color: #0096FF; font-size: 1.1rem; font-weight: 600; margin-bottom: 10px;">üí° TOTAL: 32 Triangular Arbitrage Paths</div>
                    <div style="color: #b8c6db; font-size: 0.95rem; line-height: 1.6;">
                        30 three-leg paths + 2 four-leg paths<br>
                        üöÄ XT.COM: 7.8M Global Users | 1,000+ USDT Pairs | Native XT Token
                    </div>
                </div>
            `;

            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });

            console.log('‚úÖ [XT] Paths modal opened');
        }

        // 4. Switch XT Tab
        function switchXtTab(tab) {
            console.log(`üîÑ [XT] Switching to tab: ${tab}`);

            if (tab === 'balance') {
                document.getElementById('xtBalanceTab').classList.add('active');
                document.getElementById('xtTradingTab').classList.remove('active');
                document.getElementById('xtBalanceContent').style.display = 'block';
                document.getElementById('xtTradingContent').style.display = 'none';
                console.log('‚úÖ [XT] Balance Tracker tab active');
            } else if (tab === 'trading') {
                document.getElementById('xtBalanceTab').classList.remove('active');
                document.getElementById('xtTradingTab').classList.add('active');
                document.getElementById('xtBalanceContent').style.display = 'none';
                document.getElementById('xtTradingContent').style.display = 'block';
                console.log('‚úÖ [XT] Current Opportunities tab active');
            }
        }

        // 5. XT Balance Tracking
        const xtBalanceTracking = {
            starting: 0,
            current: 0,
            initialized: false
        };

        async function initializeXtBalance() {
            try {
                const apiKey = localStorage.getItem('xt_triangular_api');
                const apiSecret = localStorage.getItem('xt_triangular_secret');

                if (!apiKey || !apiSecret) {
                    console.log('‚è∏Ô∏è [XT] API credentials not set - skipping balance initialization');
                    return;
                }

                console.log('üîÑ [XT] Fetching initial USDT balance...');

                const response = await fetch('/api/v1/trading/xt/balance', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({ apiKey, apiSecret, currency: 'USDT' })
                });

                const result = await response.json();

                if (result.success) {
                    const balance = parseFloat(result.balance);
                    xtBalanceTracking.starting = balance;
                    xtBalanceTracking.current = balance;
                    xtBalanceTracking.initialized = true;

                    updateXtBalanceDisplay();
                    console.log(`‚úÖ [XT] Balance initialized: $${balance.toFixed(2)} USDT`);
                } else {
                    console.error('‚ùå [XT] Balance fetch failed:', result.error);
                }
            } catch (error) {
                console.error('‚ùå [XT] Balance initialization error:', error);
            }
        }

        async function updateXtBalance() {
            try {
                const apiKey = localStorage.getItem('xt_triangular_api');
                const apiSecret = localStorage.getItem('xt_triangular_secret');

                if (!apiKey || !apiSecret) {
                    return;
                }

                const response = await fetch('/api/v1/trading/xt/balance', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({ apiKey, apiSecret, currency: 'USDT' })
                });

                const result = await response.json();

                if (result.success) {
                    xtBalanceTracking.current = parseFloat(result.balance);
                    updateXtBalanceDisplay();
                    console.log(`üîÑ [XT] Balance updated: $${xtBalanceTracking.current.toFixed(2)} USDT`);
                }
            } catch (error) {
                console.error('‚ùå [XT] Balance update error:', error);
            }
        }

        function updateXtBalanceDisplay() {
            const starting = xtBalanceTracking.starting;
            const current = xtBalanceTracking.current;
            const change = current - starting;
            const changePercent = starting > 0 ? ((change / starting) * 100).toFixed(2) : '0.00';

            document.getElementById('xtStartingUSDT').innerHTML = `
                <div style="text-align: center;">
                    <div style="color: #888; font-size: 0.85rem; margin-bottom: 5px;">üí∞ Starting Balance</div>
                    <div style="color: white; font-size: 1.3rem; font-weight: 600;">$${starting.toFixed(2)}</div>
                    <div style="color: #888; font-size: 0.8rem;">USDT</div>
                </div>
            `;

            document.getElementById('xtCurrentUSDT').innerHTML = `
                <div style="text-align: center;">
                    <div style="color: #888; font-size: 0.85rem; margin-bottom: 5px;">üìä Current Balance</div>
                    <div style="color: white; font-size: 1.3rem; font-weight: 600;">$${current.toFixed(2)}</div>
                    <div style="color: #888; font-size: 0.8rem;">USDT</div>
                </div>
            `;

            const changeColor = change >= 0 ? '#0096FF' : '#ff4444';
            const changeSign = change >= 0 ? '+' : '';

            document.getElementById('xtChangeUSDT').innerHTML = `
                <div style="text-align: center;">
                    <div style="color: #888; font-size: 0.85rem; margin-bottom: 5px;">üìà Change</div>
                    <div style="color: ${changeColor}; font-size: 1.3rem; font-weight: 600;">${changeSign}$${change.toFixed(2)}</div>
                    <div style="color: ${changeColor}; font-size: 0.9rem;">${changeSign}${changePercent}%</div>
                </div>
            `;
        }

        function resetXtStartingBalance() {
            if (confirm('üîÑ Reset XT Starting Balance?\n\nThis will set your current balance as the new baseline for tracking.')) {
                xtBalanceTracking.starting = xtBalanceTracking.current;
                updateXtBalanceDisplay();
                console.log(`‚úÖ [XT] Starting balance reset to $${xtBalanceTracking.starting.toFixed(2)}`);
            }
        }

        // 6. Save XT Settings
        function saveXtTriangularSettings() {
            const settings = {
                maxTrade: document.getElementById('xtMaxTrade').value,
                portfolioPercent: document.getElementById('xtPortfolioPercent').value,
                profitThreshold: document.getElementById('xtProfitThreshold').value,
                set1Enabled: document.getElementById('xtSet1Enabled').checked,
                set2Enabled: document.getElementById('xtSet2Enabled').checked,
                set3Enabled: document.getElementById('xtSet3Enabled').checked,
                set4Enabled: document.getElementById('xtSet4Enabled').checked,
                set5Enabled: document.getElementById('xtSet5Enabled').checked
            };

            localStorage.setItem('xt_triangular_settings', JSON.stringify(settings));
            console.log('‚úÖ [XT] Settings saved:', settings);
        }

        // 7. Load XT Settings
        function loadXtTriangularSettings() {
            const saved = localStorage.getItem('xt_triangular_settings');
            if (saved) {
                const settings = JSON.parse(saved);
                document.getElementById('xtMaxTrade').value = settings.maxTrade || 1000;
                document.getElementById('xtPortfolioPercent').value = settings.portfolioPercent || 10;
                document.getElementById('xtProfitThreshold').value = settings.profitThreshold || 0.5;
                document.getElementById('xtSet1Enabled').checked = settings.set1Enabled !== false;
                document.getElementById('xtSet2Enabled').checked = settings.set2Enabled !== false;
                document.getElementById('xtSet3Enabled').checked = settings.set3Enabled === true;
                document.getElementById('xtSet4Enabled').checked = settings.set4Enabled === true;
                document.getElementById('xtSet5Enabled').checked = settings.set5Enabled === true;
                console.log('‚úÖ [XT] Settings loaded:', settings);
            }
        }

        // 8. Clear XT History
        function clearXtHistory() {
            if (confirm('üóëÔ∏è Clear XT trading history?\n\nThis cannot be undone.')) {
                document.getElementById('xtOpportunities').innerHTML = '<div style="color: #888; font-size: 14px;">No scan results yet. Click "Scan Opportunities" to begin.</div>';
                document.getElementById('xtScanStatus').textContent = '';
                console.log('‚úÖ [XT] History cleared');
            }
        }

        // 10. Scan XT Triangular Paths
        async function scanXtTriangularPaths() {
            try {
                const apiKey = localStorage.getItem('xt_triangular_api');
                const apiSecret = localStorage.getItem('xt_triangular_secret');

                if (!apiKey || !apiSecret) {
                    alert('‚ùå XT API credentials not found!\n\nPlease set your API credentials on the SETUP page first.');
                    return;
                }

                const maxTradeAmount = parseFloat(document.getElementById('xtMaxTrade').value);
                const portfolioPercent = parseFloat(document.getElementById('xtPortfolioPercent').value);
                const profitThreshold = parseFloat(document.getElementById('xtProfitThreshold').value);

                const enabledSets = {
                    SET_1_ESSENTIAL_ETH_BRIDGE: document.getElementById('xtSet1Enabled').checked,
                    SET_2_MIDCAP_BTC_BRIDGE: document.getElementById('xtSet2Enabled').checked,
                    SET_3_XT_NATIVE_BRIDGE: document.getElementById('xtSet3Enabled').checked,
                    SET_4_HIGH_VOLATILITY: document.getElementById('xtSet4Enabled').checked,
                    SET_5_EXTENDED_MULTIBRIDGE: document.getElementById('xtSet5Enabled').checked
                };

                document.getElementById('xtScanStatus').textContent = 'üîç Scanning XT paths...';
                document.getElementById('xtOpportunities').innerHTML = '<div style="text-align: center; padding: 20px; color: #0096FF;">‚è≥ Analyzing 1,000+ pairs...</div>';

                const response = await fetch('/api/v1/trading/xt/triangular/scan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({ apiKey, apiSecret, maxTradeAmount, portfolioPercent, profitThreshold, enabledSets })
                });

                const result = await response.json();

                if (result.success && result.opportunities.length > 0) {
                    document.getElementById('xtScanStatus').textContent = `‚úÖ Found ${result.opportunities.length} opportunities`;

                    let oppsHtml = '<div style="display: grid; gap: 15px;">';
                    result.opportunities.forEach(opp => {
                        const profitColor = parseFloat(opp.profitPercent) >= 1 ? '#00ff88' : '#0096FF';
                        const riskColor = opp.risk === 'EXECUTE' ? '#00ff88' : opp.risk === 'CAUTIOUS' ? '#0096FF' : '#FF4444';

                        oppsHtml += `
                            <div style="background: rgba(0,150,255,0.1); padding: 15px; border-radius: 10px; border-left: 4px solid ${profitColor};">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <span style="color: white; font-weight: 600; font-size: 15px;">${opp.path.join(' ‚Üí ')}</span>
                                    <span style="color: ${profitColor}; font-weight: 700; font-size: 16px;">+${opp.profitPercent}%</span>
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px; font-size: 13px;">
                                    <div><span style="color: #888;">Expected:</span> <span style="color: white;">${opp.expectedProfitZAR} USDT</span></div>
                                    <div><span style="color: #888;">Risk:</span> <span style="color: ${riskColor};">${opp.risk}</span></div>
                                    <div><span style="color: #888;">Slippage:</span> <span style="color: white;">${opp.estimatedSlippage}%</span></div>
                                </div>
                                <div style="margin-top: 12px; display: flex; gap: 8px;">
                                    <button onclick='executeXtTriangularTrade(${JSON.stringify(opp)})' style="flex: 1; padding: 8px; background: #0096FF; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px;">
                                        ‚ö° EXECUTE
                                    </button>
                                    <button onclick='alert("Path: ${opp.pairs.join(" ‚Üí ")}")' style="flex: 1; padding: 8px; background: rgba(0,150,255,0.2); color: #0096FF; border: 1px solid #0096FF; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px;">
                                        üìä Details
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                    oppsHtml += '</div>';

                    document.getElementById('xtOpportunities').innerHTML = oppsHtml;
                } else {
                    document.getElementById('xtScanStatus').textContent = '‚ùå No profitable opportunities found';
                    document.getElementById('xtOpportunities').innerHTML = '<div style="text-align: center; padding: 20px; color: #888;">No opportunities above profit threshold. Try lowering threshold or enabling more path sets.</div>';
                }
            } catch (error) {
                console.error('XT scan error:', error);
                document.getElementById('xtScanStatus').textContent = '‚ùå Scan failed';
                document.getElementById('xtOpportunities').innerHTML = `<div style="color: #FF4444; padding: 20px; text-align: center;">Error: ${error.message}</div>`;
            }
        }

        // 6. Execute XT Triangular Trade
        async function executeXtTriangularTrade(pathId) {
            const apiKey = localStorage.getItem('xt_triangular_api') || '';
            const apiSecret = localStorage.getItem('xt_triangular_secret') || '';
            const maxTrade = parseFloat(document.getElementById('xtMaxTrade').value);

            // Enhanced real money warning
            if (!confirm(`‚ö†Ô∏è REAL MONEY TRADING ‚ö†Ô∏è\n\nExecute REAL triangular arbitrage trade?\n\nPath: ${pathId}\nAmount: ${maxTrade} USDT\n\nThis will execute REAL market orders on XT.COM.\nClick OK to proceed.`)) {
                return;
            }

            try {
                const response = await fetch('/api/v1/trading/xt/triangular/execute', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ apiKey, apiSecret, pathId, amount: maxTrade })
                });

                const result = await response.json();

                if (result.success && result.data) {
                    const execution = result.data;

                    if (execution.status === 'COMPLETED') {
                        const profit = execution.actualProfit || 0;
                        const profitPct = execution.actualProfitPercentage || 0;

                        alert(`‚úÖ Trade Executed Successfully!\n\nExecution ID: ${execution.executionId}\nProfit: ${profit.toFixed(2)} (${profitPct.toFixed(3)}%)\nLegs Completed: ${execution.legs?.length || 0}/3\nTotal Time: ${execution.totalExecutionTime}ms\n\nAll legs executed atomically with slippage monitoring.`);

                        // üìä Log to backend using shared service
                        logTriangularTrade('XT', pathId, profit, maxTrade, execution.totalFees || 0).catch(e => console.warn('Logging failed:', e));

                        // Refresh opportunities and balance
                        scanXtTriangularPaths();
                        initializeXtBalance();
                    } else {
                        alert(`‚ùå Trade Failed!\n\nStatus: ${execution.status}\nError: ${execution.error || 'Unknown error'}\nCompleted Legs: ${execution.legs?.filter(l => l.status === 'COMPLETED').length || 0}/3`);
                    }
                } else {
                    throw new Error(result.message || 'Execution failed');
                }
            } catch (error) {
                alert(`‚ùå Trade execution error:\n\n${error.message}`);
            }
        }

        // 7. Load XT Trade History
        async function loadXtTradeHistory() {
            try {
                const userId = localStorage.getItem('userId');
                if (!userId) return;

                const response = await fetch('/api/v1/trading/xt/triangular/history', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({ userId, limit: 10 })
                });

                const result = await response.json();

                if (result.success && result.trades.length > 0) {
                    let historyHtml = '<div style="display: grid; gap: 10px;">';

                    result.trades.forEach(trade => {
                        const statusColor = trade.execution_status === 'completed' ? '#0096FF' : '#FF4444';
                        const profitColor = parseFloat(trade.actual_profit_zar || 0) > 0 ? '#00ff88' : '#FF4444';

                        historyHtml += `
                            <div style="background: rgba(255,255,255,0.03); padding: 12px; border-radius: 8px; border-left: 3px solid ${statusColor};">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span style="color: white; font-weight: 600; font-size: 13px;">${trade.path_sequence}</span>
                                    <span style="color: ${profitColor}; font-weight: 600;">${trade.actual_profit_zar ? '+' + trade.actual_profit_zar : '‚Äî'} USDT</span>
                                </div>
                                <div style="color: #888; font-size: 12px;">${new Date(trade.created_at).toLocaleString()}</div>
                            </div>
                        `;
                    });

                    historyHtml += '</div>';
                    document.getElementById('xtTradeHistory').innerHTML = historyHtml;
                }
            } catch (error) {
                console.error('XT history error:', error);
            }
        }

        // 8. Start XT Worker
        async function startXtWorker() {
            // Validate credentials
            const apiKey = localStorage.getItem('xt_triangular_api');
            const apiSecret = localStorage.getItem('xt_triangular_secret');

            if (!apiKey || !apiSecret) {
                alert('‚ö†Ô∏è Please configure XT API credentials first!');
                document.getElementById('xtTriangularEnabled').classList.remove('active');
                document.getElementById('xtTriangularStatus').textContent = 'OFF';
                document.getElementById('xtTriangularStatus').style.color = '#ff6b6b';
                return;
            }

            // Check if at least one set is selected
            const set1Enabled = document.getElementById('xtSet1Enabled').checked;
            const set2Enabled = document.getElementById('xtSet2Enabled').checked;
            const set3Enabled = document.getElementById('xtSet3Enabled').checked;
            const set4Enabled = document.getElementById('xtSet4Enabled').checked;
            const set5Enabled = document.getElementById('xtSet5Enabled').checked;

            if (!set1Enabled && !set2Enabled && !set3Enabled && !set4Enabled && !set5Enabled) {
                alert('‚ö†Ô∏è Please enable at least one path set!');
                document.getElementById('xtTriangularEnabled').classList.remove('active');
                document.getElementById('xtTriangularStatus').textContent = 'OFF';
                document.getElementById('xtTriangularStatus').style.color = '#ff6b6b';
                return;
            }

            const portfolioPercent = parseFloat(document.getElementById('xtPortfolioPercent').value) || 5;
            const maxTradeAmount = parseFloat(document.getElementById('xtMaxTrade').value) || 100;
            const profitThreshold = parseFloat(document.getElementById('xtProfitThreshold').value) || 0.3;

            // Build enabled sets object
            const enabledSets = {
                SET_1_ESSENTIAL_ETH_BRIDGE: set1Enabled,
                SET_2_MIDCAP_BTC_BRIDGE: set2Enabled,
                SET_3_XT_NATIVE_BRIDGE: set3Enabled,
                SET_4_HIGH_VOLATILITY: set4Enabled,
                SET_5_EXTENDED_MULTIBRIDGE: set5Enabled
            };

            const selectedSets = Object.keys(enabledSets).filter(key => enabledSets[key]);

            console.log(`üöÄ [XT] Worker started - scanning ${selectedSets.length} sets sequentially`);
            console.log(`üöÄ [XT] Portfolio: ${portfolioPercent}%, Max Trade: ${maxTradeAmount}, Threshold: ${profitThreshold}%`);

            let currentSetIndex = 0;

            // Sequential scan function
            async function scanAndExecuteSequential() {
                try {
                    xtWorkerStats.totalScans++;
                    xtWorkerStats.lastScanTime = new Date().toISOString();

                    const currentSet = selectedSets[currentSetIndex];
                    console.log(`üöÄ [XT] Scanning set ${currentSetIndex + 1}/${selectedSets.length}: ${currentSet}`);

                    // Build enabledSets object for current set only
                    const currentEnabledSets = {};
                    Object.keys(enabledSets).forEach(key => {
                        currentEnabledSets[key] = key === currentSet;
                    });

                    // Scan current set only
                    const response = await fetch('/api/v1/trading/xt/triangular/scan', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            apiKey,
                            apiSecret,
                            enabledSets: currentEnabledSets,
                            portfolioPercent,
                            maxTradeAmount
                        })
                    });

                    const data = await response.json();

                    if (data.success && data.opportunities && data.opportunities.length > 0) {
                        xtWorkerStats.totalOpportunities += data.opportunities.length;

                        // Log opportunities above threshold
                        data.opportunities.forEach(opp => {
                            if (opp.profitPercentage >= profitThreshold) {
                                console.log(`üöÄ [XT] Opportunity found: ${opp.pathId} - ${opp.profitPercentage.toFixed(3)}% profit`);

                                // Track best profit
                                if (opp.profitPercentage > xtWorkerStats.bestProfit) {
                                    xtWorkerStats.bestProfit = opp.profitPercentage;
                                    xtWorkerStats.bestPath = opp.pathId;
                                }
                            }
                        });
                    }

                    // Move to next set (circular)
                    currentSetIndex = (currentSetIndex + 1) % selectedSets.length;

                    // Update balance after completing full cycle
                    if (currentSetIndex === 0) {
                        console.log(`üöÄ [XT] Completed full cycle - updating balance...`);
                        initializeXtBalance();
                    }

                } catch (error) {
                    console.error(`üöÄ [XT] Worker scan error:`, error);
                }
            }

            // Start sequential interval (8 seconds between scans)
            scanAndExecuteSequential(); // Run immediately
            xtWorkerInterval = setInterval(scanAndExecuteSequential, 8000);

            console.log(`üöÄ [XT] Worker active - scanning every 8 seconds`);
        }

        function stopXtWorker() {
            if (xtWorkerInterval) {
                clearInterval(xtWorkerInterval);
                xtWorkerInterval = null;

                console.log(`üöÄ [XT] Worker stopped`);
                console.log(`üöÄ [XT] Stats:`, {
                    totalScans: xtWorkerStats.totalScans,
                    totalOpportunities: xtWorkerStats.totalOpportunities,
                    bestProfit: xtWorkerStats.bestProfit?.toFixed(3) + '%',
                    bestPath: xtWorkerStats.bestPath
                });
            }
        }

        // Initialize XT settings on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ [XT] Initializing triangular arbitrage settings...');
            loadXtTriangularSettings();

            // Initialize balance tracker
            initializeXtBalance();

            // Set default tab
            switchXtTab('balance');

            const xtInputs = document.querySelectorAll('#xtMaxTrade, #xtPortfolioPercent, #xtProfitThreshold');
            xtInputs.forEach(input => {
                input.addEventListener('change', saveXtTriangularSettings);
            });

            for (let i = 1; i <= 5; i++) {
                const checkbox = document.getElementById(`xtSet${i}Enabled`);
                if (checkbox) {
                    checkbox.addEventListener('change', saveXtTriangularSettings);
                }
            }
        });

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // ASCENDEX TRIANGULAR ARBITRAGE FUNCTIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        // Worker Variables
        let ascendexWorkerInterval = null;
        let ascendexWorkerStats = {
            totalScans: 0,
            totalOpportunities: 0,
            totalTrades: 0,
            successfulTrades: 0,
            totalProfit: 0,
            bestProfit: 0,
            bestPath: null,
            lastScanTime: null
        };

        // 1. Toggle AscendEX Triangular
        function toggleAscendexTriangular() {
            const toggle = document.getElementById('ascendexTriangularEnabled');
            const status = document.getElementById('ascendexTriangularStatus');
            const isActive = toggle.classList.toggle('active');

            if (isActive) {
                status.textContent = 'ON';
                status.style.color = '#8A2BE2';
                localStorage.setItem('ascendexTriangularEnabled', 'true');
                console.log('üíé [ASCENDEX] Triangular arbitrage enabled - starting worker...');
                startAscendexWorker();
            } else {
                status.textContent = 'OFF';
                status.style.color = '#ff6b6b';
                localStorage.setItem('ascendexTriangularEnabled', 'false');
                console.log('üíé [ASCENDEX] Triangular arbitrage disabled - stopping worker...');
                stopAscendexWorker();
            }
        }

        // 2. View AscendEX Path Details (Professional Modal)
        function viewAscendexPathDetails() {
            // Create modal overlay
            const modal = document.createElement('div');
            modal.id = 'ascendexPathsModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.85);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                backdrop-filter: blur(5px);
            `;

            // Create modal content
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
                border-radius: 20px;
                max-width: 900px;
                max-height: 90vh;
                overflow-y: auto;
                padding: 30px;
                box-shadow: 0 10px 50px rgba(138,43,226,0.3);
                border: 2px solid #8A2BE2;
            `;

            modalContent.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                    <h2 style="color: #8A2BE2; margin: 0; font-size: 1.8rem;">üíé AscendEX Triangular Arbitrage Paths</h2>
                    <button onclick="document.getElementById('ascendexPathsModal').remove()"
                            style="background: rgba(255,68,68,0.2); color: #ff4444; border: 1px solid #ff4444; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                        ‚úï Close
                    </button>
                </div>

                <div style="background: rgba(138,43,226,0.1); padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #8A2BE2;">
                    <div style="color: #8A2BE2; font-weight: bold; margin-bottom: 8px;">üìä Overview</div>
                    <div style="color: #b8c6db; font-size: 0.9rem; line-height: 1.6;">
                        ‚Ä¢ <strong>32 Total Paths:</strong> 30 three-leg + 2 four-leg cycles<br>
                        ‚Ä¢ <strong>Bridge Currency:</strong> USDT (450+ trading pairs)<br>
                        ‚Ä¢ <strong>Native Token:</strong> ASD for fee discounts<br>
                        ‚Ä¢ <strong>Authentication:</strong> HMAC-SHA256 with account-group routing<br>
                        ‚Ä¢ <strong>Exchange:</strong> AscendEX (formerly BitMax)
                    </div>
                </div>

                <!-- SET 1 -->
                <div style="background: rgba(0,255,0,0.05); border-left: 4px solid #00ff00; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <div style="color: #00ff00; font-weight: bold; font-size: 1.1rem; margin-bottom: 12px;">‚úÖ SET 1: Essential ETH Bridge (7 paths) - ENABLED BY DEFAULT</div>
                    <div style="color: #b8c6db; font-size: 0.9rem; line-height: 1.8;">
                        1. USDT ‚Üí ETH ‚Üí BTC ‚Üí USDT (ETH/USDT, BTC/ETH, BTC/USDT)<br>
                        2. USDT ‚Üí ETH ‚Üí SOL ‚Üí USDT (ETH/USDT, SOL/ETH, SOL/USDT)<br>
                        3. USDT ‚Üí ETH ‚Üí MATIC ‚Üí USDT (ETH/USDT, MATIC/ETH, MATIC/USDT)<br>
                        4. USDT ‚Üí ETH ‚Üí LINK ‚Üí USDT (ETH/USDT, LINK/ETH, LINK/USDT)<br>
                        5. USDT ‚Üí ETH ‚Üí AVAX ‚Üí USDT (ETH/USDT, AVAX/ETH, AVAX/USDT)<br>
                        6. USDT ‚Üí ETH ‚Üí DOT ‚Üí USDT (ETH/USDT, DOT/ETH, DOT/USDT)<br>
                        7. USDT ‚Üí ETH ‚Üí UNI ‚Üí USDT (ETH/USDT, UNI/ETH, UNI/USDT)
                    </div>
                </div>

                <!-- SET 2 -->
                <div style="background: rgba(0,255,0,0.05); border-left: 4px solid #00ff00; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <div style="color: #00ff00; font-weight: bold; font-size: 1.1rem; margin-bottom: 12px;">‚úÖ SET 2: Mid-Cap BTC Bridge (7 paths) - ENABLED BY DEFAULT</div>
                    <div style="color: #b8c6db; font-size: 0.9rem; line-height: 1.8;">
                        1. USDT ‚Üí BTC ‚Üí ETH ‚Üí USDT (BTC/USDT, ETH/BTC, ETH/USDT)<br>
                        2. USDT ‚Üí BTC ‚Üí SOL ‚Üí USDT (BTC/USDT, SOL/BTC, SOL/USDT)<br>
                        3. USDT ‚Üí BTC ‚Üí AVAX ‚Üí USDT (BTC/USDT, AVAX/BTC, AVAX/USDT)<br>
                        4. USDT ‚Üí BTC ‚Üí UNI ‚Üí USDT (BTC/USDT, UNI/BTC, UNI/USDT)<br>
                        5. USDT ‚Üí BTC ‚Üí ATOM ‚Üí USDT (BTC/USDT, ATOM/BTC, ATOM/USDT)<br>
                        6. USDT ‚Üí BTC ‚Üí DOT ‚Üí USDT (BTC/USDT, DOT/BTC, DOT/USDT)<br>
                        7. USDT ‚Üí BTC ‚Üí MATIC ‚Üí USDT (BTC/USDT, MATIC/BTC, MATIC/USDT)
                    </div>
                </div>

                <!-- SET 3 -->
                <div style="background: rgba(255,215,0,0.05); border-left: 4px solid #FFD700; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <div style="color: #FFD700; font-weight: bold; font-size: 1.1rem; margin-bottom: 12px;">üíé SET 3: ASD Native Bridge (6 paths) - AscendEX Token (Fee Discounts!)</div>
                    <div style="color: #b8c6db; font-size: 0.9rem; line-height: 1.8;">
                        1. USDT ‚Üí ASD ‚Üí BTC ‚Üí USDT (ASD/USDT, BTC/ASD, BTC/USDT)<br>
                        2. USDT ‚Üí ASD ‚Üí ETH ‚Üí USDT (ASD/USDT, ETH/ASD, ETH/USDT)<br>
                        3. USDT ‚Üí ASD ‚Üí SOL ‚Üí USDT (ASD/USDT, SOL/ASD, SOL/USDT)<br>
                        4. USDT ‚Üí BTC ‚Üí ASD ‚Üí USDT (BTC/USDT, ASD/BTC, ASD/USDT)<br>
                        5. USDT ‚Üí ETH ‚Üí ASD ‚Üí USDT (ETH/USDT, ASD/ETH, ASD/USDT)<br>
                        6. USDT ‚Üí ASD ‚Üí MATIC ‚Üí USDT (ASD/USDT, MATIC/ASD, MATIC/USDT)
                    </div>
                </div>

                <!-- SET 4 -->
                <div style="background: rgba(255,165,0,0.05); border-left: 4px solid #FFA500; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <div style="color: #FFA500; font-weight: bold; font-size: 1.1rem; margin-bottom: 12px;">‚ö° SET 4: High Volatility (6 paths)</div>
                    <div style="color: #b8c6db; font-size: 0.9rem; line-height: 1.8;">
                        1. USDT ‚Üí FTM ‚Üí BTC ‚Üí USDT (FTM/USDT, BTC/FTM, BTC/USDT)<br>
                        2. USDT ‚Üí NEAR ‚Üí ETH ‚Üí USDT (NEAR/USDT, ETH/NEAR, ETH/USDT)<br>
                        3. USDT ‚Üí AAVE ‚Üí BTC ‚Üí USDT (AAVE/USDT, BTC/AAVE, BTC/USDT)<br>
                        4. USDT ‚Üí ALGO ‚Üí ETH ‚Üí USDT (ALGO/USDT, ETH/ALGO, ETH/USDT)<br>
                        5. USDT ‚Üí FTM ‚Üí SOL ‚Üí USDT (FTM/USDT, SOL/FTM, SOL/USDT)<br>
                        6. USDT ‚Üí NEAR ‚Üí BTC ‚Üí USDT (NEAR/USDT, BTC/NEAR, BTC/USDT)
                    </div>
                </div>

                <!-- SET 5 -->
                <div style="background: rgba(255,0,0,0.05); border-left: 4px solid #ff4444; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <div style="color: #ff4444; font-weight: bold; font-size: 1.1rem; margin-bottom: 12px;">üîÅ SET 5: Extended Multi-Bridge (6 paths) - Includes 2 Four-Leg Paths</div>
                    <div style="color: #b8c6db; font-size: 0.9rem; line-height: 1.8;">
                        1. USDT ‚Üí XRP ‚Üí BTC ‚Üí USDT (XRP/USDT, BTC/XRP, BTC/USDT)<br>
                        2. USDT ‚Üí LTC ‚Üí ETH ‚Üí USDT (LTC/USDT, ETH/LTC, ETH/USDT)<br>
                        3. USDT ‚Üí TRX ‚Üí BTC ‚Üí USDT (TRX/USDT, BTC/TRX, BTC/USDT)<br>
                        4. USDT ‚Üí ADA ‚Üí SOL ‚Üí USDT (ADA/USDT, SOL/ADA, SOL/USDT)<br>
                        5. USDT ‚Üí BTC ‚Üí ETH ‚Üí SOL ‚Üí USDT ‚≠ê <strong style="color: #ff4444;">4-LEG</strong> (BTC/USDT, ETH/BTC, SOL/ETH, SOL/USDT)<br>
                        6. USDT ‚Üí DOGE ‚Üí BTC ‚Üí ETH ‚Üí USDT ‚≠ê <strong style="color: #ff4444;">4-LEG</strong> (DOGE/USDT, BTC/DOGE, ETH/BTC, ETH/USDT)
                    </div>
                </div>

                <div style="background: rgba(138,43,226,0.1); padding: 15px; border-radius: 10px; margin-top: 20px; border-left: 4px solid #8A2BE2;">
                    <div style="color: #8A2BE2; font-weight: bold; margin-bottom: 8px;">üí° Portfolio % Risk Management</div>
                    <div style="color: #b8c6db; font-size: 0.9rem; line-height: 1.6;">
                        Trade Amount = <strong>MIN(portfolioPercent √ó balance, maxTradeAmount)</strong><br>
                        Default: 10% of USDT balance, capped at $1,000<br>
                        Adjust in Risk Management settings above.
                    </div>
                </div>
            `;

            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // Close on background click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // 3. Switch AscendEX Tabs
        function switchAscendexTab(tab) {
            const balanceTab = document.getElementById('ascendexBalanceTab');
            const tradingTab = document.getElementById('ascendexTradingTab');
            const balanceContent = document.getElementById('ascendexBalanceContent');
            const tradingContent = document.getElementById('ascendexTradingContent');

            if (tab === 'balance') {
                balanceTab.style.background = '#8A2BE2';
                balanceTab.style.color = 'white';
                balanceTab.style.border = 'none';
                tradingTab.style.background = 'rgba(138,43,226,0.2)';
                tradingTab.style.color = '#8A2BE2';
                tradingTab.style.border = '1px solid #8A2BE2';

                balanceContent.style.display = 'block';
                tradingContent.style.display = 'none';
            } else {
                tradingTab.style.background = '#8A2BE2';
                tradingTab.style.color = 'white';
                tradingTab.style.border = 'none';
                balanceTab.style.background = 'rgba(138,43,226,0.2)';
                balanceTab.style.color = '#8A2BE2';
                balanceTab.style.border = '1px solid #8A2BE2';

                tradingContent.style.display = 'block';
                balanceContent.style.display = 'none';
            }
        }

        // 4. AscendEX Balance Tracking
        const ascendexBalanceTracking = {
            starting: 0,
            current: 0,
            initialized: false
        };

        async function initializeAscendexBalance() {
            try {
                const apiKey = localStorage.getItem('ascendex_triangular_api');
                const apiSecret = localStorage.getItem('ascendex_triangular_secret');

                if (!apiKey || !apiSecret) {
                    console.log('AscendEX credentials not found, skipping balance initialization');
                    return;
                }

                const response = await fetch('/api/v1/trading/ascendex/balance', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({
                        apiKey,
                        apiSecret,
                        currency: 'USDT'
                    })
                });

                const result = await response.json();

                if (result.success) {
                    const balance = parseFloat(result.balance) || 0;
                    ascendexBalanceTracking.starting = balance;
                    ascendexBalanceTracking.current = balance;
                    ascendexBalanceTracking.initialized = true;
                    updateAscendexBalanceDisplay();
                    console.log('‚úÖ [ASCENDEX] Balance initialized:', balance);
                } else {
                    console.warn('AscendEX balance fetch failed:', result.message);
                    // Set to 0 if failed
                    ascendexBalanceTracking.starting = 0;
                    ascendexBalanceTracking.current = 0;
                    updateAscendexBalanceDisplay();
                }
            } catch (error) {
                console.error('AscendEX balance initialization error:', error);
            }
        }

        async function updateAscendexBalance() {
            try {
                const apiKey = localStorage.getItem('ascendex_triangular_api');
                const apiSecret = localStorage.getItem('ascendex_triangular_secret');

                if (!apiKey || !apiSecret) {
                    alert('‚ùå AscendEX API credentials not found!\n\nPlease set your API credentials on the SETUP page first.');
                    return;
                }

                const response = await fetch('/api/v1/trading/ascendex/balance', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({
                        apiKey,
                        apiSecret,
                        currency: 'USDT'
                    })
                });

                const result = await response.json();

                if (result.success) {
                    const balance = parseFloat(result.balance) || 0;

                    if (!ascendexBalanceTracking.initialized) {
                        ascendexBalanceTracking.starting = balance;
                        ascendexBalanceTracking.initialized = true;
                    }

                    ascendexBalanceTracking.current = balance;
                    updateAscendexBalanceDisplay();
                } else {
                    alert(`‚ùå Failed to fetch AscendEX balance\n\n${result.message}`);
                }
            } catch (error) {
                console.error('AscendEX balance update error:', error);
                alert(`‚ùå Failed to fetch AscendEX balance\n\n${error.message}`);
            }
        }

        function updateAscendexBalanceDisplay() {
            // Ensure we have valid numbers, default to 0 if undefined/null/NaN
            const starting = Number(ascendexBalanceTracking.starting) || 0;
            const current = Number(ascendexBalanceTracking.current) || 0;
            const change = current - starting;
            const changePercent = starting > 0 ? ((change / starting) * 100).toFixed(2) : '0.00';
            const changeSign = change >= 0 ? '+' : '';
            const changeColor = change >= 0 ? '#00d26a' : '#ff4444';

            document.getElementById('ascendexStartingUSDT').textContent = `${starting.toFixed(2)} USDT`;
            document.getElementById('ascendexCurrentUSDT').textContent = `${current.toFixed(2)} USDT`;
            document.getElementById('ascendexChangeUSDT').innerHTML = `<span style="color: ${changeColor}">${changeSign}${change.toFixed(2)} USDT (${changeSign}${changePercent}%)</span>`;
        }

        function resetAscendexStartingBalance() {
            if (confirm('Reset starting balance to current balance?\n\nThis will reset your profit tracking.')) {
                ascendexBalanceTracking.starting = ascendexBalanceTracking.current;
                updateAscendexBalanceDisplay();
            }
        }

        // 5. Save AscendEX Settings
        function saveAscendexTriangularSettings() {
            const settings = {
                maxTrade: document.getElementById('ascendexMaxTrade').value,
                portfolioPercent: document.getElementById('ascendexPortfolioPercent').value,
                profitThreshold: document.getElementById('ascendexProfitThreshold').value,
                set1Enabled: document.getElementById('ascendexSet1Enabled').checked,
                set2Enabled: document.getElementById('ascendexSet2Enabled').checked,
                set3Enabled: document.getElementById('ascendexSet3Enabled').checked,
                set4Enabled: document.getElementById('ascendexSet4Enabled').checked,
                set5Enabled: document.getElementById('ascendexSet5Enabled').checked
            };

            localStorage.setItem('ascendex_triangular_settings', JSON.stringify(settings));
            console.log('‚úÖ [ASCENDEX] Settings saved:', settings);
        }

        // 6. Load AscendEX Settings
        function loadAscendexTriangularSettings() {
            const saved = localStorage.getItem('ascendex_triangular_settings');
            if (saved) {
                const settings = JSON.parse(saved);
                document.getElementById('ascendexMaxTrade').value = settings.maxTrade || 1000;
                document.getElementById('ascendexPortfolioPercent').value = settings.portfolioPercent || 10;
                document.getElementById('ascendexProfitThreshold').value = settings.profitThreshold || 0.5;
                document.getElementById('ascendexSet1Enabled').checked = settings.set1Enabled !== false;
                document.getElementById('ascendexSet2Enabled').checked = settings.set2Enabled !== false;
                document.getElementById('ascendexSet3Enabled').checked = settings.set3Enabled === true;
                document.getElementById('ascendexSet4Enabled').checked = settings.set4Enabled === true;
                document.getElementById('ascendexSet5Enabled').checked = settings.set5Enabled === true;
                console.log('‚úÖ [ASCENDEX] Settings loaded:', settings);
            }

            // Load toggle state
            const enabled = localStorage.getItem('ascendexTriangularEnabled') === 'true';
            const toggle = document.getElementById('ascendexTriangularEnabled');
            const status = document.getElementById('ascendexTriangularStatus');

            if (enabled) {
                toggle.classList.add('active');
                status.textContent = 'ON';
                status.style.color = '#8A2BE2';
            }
        }

        // 7. Clear AscendEX History
        function clearAscendexHistory() {
            if (confirm('Clear all opportunity history?\n\nThis cannot be undone.')) {
                document.getElementById('ascendexOpportunities').innerHTML = '<div style="color: #888; font-size: 14px;">No opportunities found yet. Click "Scan Opportunities Now" to begin scanning.</div>';
                document.getElementById('ascendexScanStatus').textContent = '';
                document.getElementById('ascendexPathsScanned').textContent = '0';
                document.getElementById('ascendexOpportunitiesFound').textContent = '0';
            }
        }

        // 8. Scan AscendEX Triangular Paths (Updated with portfolioPercent)
        async function scanAscendexTriangularPaths() {
            try {
                const apiKey = localStorage.getItem('ascendex_triangular_api');
                const apiSecret = localStorage.getItem('ascendex_triangular_secret');

                if (!apiKey || !apiSecret) {
                    alert('‚ùå AscendEX API credentials not found!\n\nPlease set your API credentials on the SETUP page first.');
                    return;
                }

                const maxTradeAmount = parseFloat(document.getElementById('ascendexMaxTrade').value);
                const portfolioPercent = parseFloat(document.getElementById('ascendexPortfolioPercent').value);
                const profitThreshold = parseFloat(document.getElementById('ascendexProfitThreshold').value);

                const enabledSets = {
                    SET_1_ESSENTIAL_ETH_BRIDGE: document.getElementById('ascendexSet1Enabled').checked,
                    SET_2_MIDCAP_BTC_BRIDGE: document.getElementById('ascendexSet2Enabled').checked,
                    SET_3_ASD_NATIVE_BRIDGE: document.getElementById('ascendexSet3Enabled').checked,
                    SET_4_HIGH_VOLATILITY: document.getElementById('ascendexSet4Enabled').checked,
                    SET_5_EXTENDED_MULTIBRIDGE: document.getElementById('ascendexSet5Enabled').checked
                };

                document.getElementById('ascendexScanStatus').textContent = 'üîç Scanning AscendEX paths...';
                document.getElementById('ascendexOpportunities').innerHTML = '<div style="text-align: center; padding: 20px; color: #8A2BE2;">‚è≥ Analyzing 450+ pairs...</div>';

                const response = await fetch('/api/v1/trading/ascendex/triangular/scan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({ apiKey, apiSecret, maxTradeAmount, portfolioPercent, profitThreshold, enabledSets })
                });

                const result = await response.json();

                // Update performance stats
                if (result.success) {
                    document.getElementById('ascendexPathsScanned').textContent = result.scanned || 0;
                    document.getElementById('ascendexOpportunitiesFound').textContent = result.profitableCount || 0;
                }

                if (result.success && result.opportunities.length > 0) {
                    document.getElementById('ascendexScanStatus').textContent = `‚úÖ Found ${result.opportunities.length} opportunities`;

                    let oppsHtml = '<div style="display: grid; gap: 15px;">';
                    result.opportunities.forEach(opp => {
                        const profitColor = parseFloat(opp.profitPercent) >= 1 ? '#00ff88' : '#8A2BE2';

                        oppsHtml += `
                            <div style="background: rgba(138,43,226,0.1); padding: 15px; border-radius: 10px; border-left: 4px solid ${profitColor};">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <span style="color: white; font-weight: 600; font-size: 15px;">${opp.path.join(' ‚Üí ')}</span>
                                    <span style="color: ${profitColor}; font-weight: 700; font-size: 16px;">+${opp.profitPercent}%</span>
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px; font-size: 13px;">
                                    <div><span style="color: #888;">Initial:</span> <span style="color: white;">$${opp.initialAmount}</span></div>
                                    <div><span style="color: #888;">Final:</span> <span style="color: white;">$${opp.finalAmount}</span></div>
                                    <div><span style="color: #888;">Profit:</span> <span style="color: ${profitColor};">$${opp.profitAmount}</span></div>
                                </div>
                                <div style="margin-top: 12px; font-size: 13px;">
                                    <div><span style="color: #888;">Description:</span> <span style="color: #b8c6db;">${opp.description}</span></div>
                                </div>
                            </div>
                        `;
                    });
                    oppsHtml += '</div>';

                    document.getElementById('ascendexOpportunities').innerHTML = oppsHtml;
                } else {
                    document.getElementById('ascendexScanStatus').textContent = '‚ùå No profitable opportunities found';
                    document.getElementById('ascendexOpportunities').innerHTML = '<div style="text-align: center; padding: 20px; color: #888;">No opportunities above profit threshold. Try lowering threshold or enabling more path sets.</div>';
                }
            } catch (error) {
                console.error('AscendEX scan error:', error);
                document.getElementById('ascendexScanStatus').textContent = '‚ùå Scan failed';
                document.getElementById('ascendexOpportunities').innerHTML = `<div style="color: #FF4444; padding: 20px; text-align: center;">Error: ${error.message}</div>`;
            }
        }

        // 6. Execute AscendEX Triangular Trade
        async function executeAscendexTriangularTrade(pathId) {
            const apiKey = localStorage.getItem('ascendex_triangular_api') || '';
            const apiSecret = localStorage.getItem('ascendex_triangular_secret') || '';
            const maxTrade = parseFloat(document.getElementById('ascendexMaxTrade').value);

            // Enhanced real money warning
            if (!confirm(`‚ö†Ô∏è REAL MONEY TRADING ‚ö†Ô∏è\n\nExecute REAL triangular arbitrage trade?\n\nPath: ${pathId}\nAmount: ${maxTrade} USDT\n\nThis will execute REAL market orders on AscendEX.\nClick OK to proceed.`)) {
                return;
            }

            try {
                const response = await fetch('/api/v1/trading/ascendex/triangular/execute', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ apiKey, apiSecret, pathId, amount: maxTrade })
                });

                const result = await response.json();

                if (result.success && result.data) {
                    const execution = result.data;

                    if (execution.status === 'COMPLETED') {
                        const profit = execution.actualProfit || 0;
                        const profitPct = execution.actualProfitPercentage || 0;

                        alert(`‚úÖ Trade Executed Successfully!\n\nExecution ID: ${execution.executionId}\nProfit: ${profit.toFixed(2)} (${profitPct.toFixed(3)}%)\nLegs Completed: ${execution.legs?.length || 0}/3\nTotal Time: ${execution.totalExecutionTime}ms\n\nAll legs executed atomically with slippage monitoring.`);

                        // üìä Log to backend using shared service
                        logTriangularTrade('AscendEX', pathId, profit, maxTrade, execution.totalFees || 0).catch(e => console.warn('Logging failed:', e));

                        // Refresh opportunities and balance
                        scanAscendexTriangularPaths();
                        initializeAscendexBalance();
                    } else {
                        alert(`‚ùå Trade Failed!\n\nStatus: ${execution.status}\nError: ${execution.error || 'Unknown error'}\nCompleted Legs: ${execution.legs?.filter(l => l.status === 'COMPLETED').length || 0}/3`);
                    }
                } else {
                    throw new Error(result.message || 'Execution failed');
                }
            } catch (error) {
                alert(`‚ùå Trade execution error:\n\n${error.message}`);
            }
        }

        // 7. Load AscendEX Trade History
        async function loadAscendexTradeHistory() {
            try {
                const userId = localStorage.getItem('userId');
                if (!userId) return;

                const response = await fetch('/api/v1/trading/ascendex/triangular/history', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({ userId, limit: 10 })
                });

                const result = await response.json();

                if (result.success && result.trades.length > 0) {
                    let historyHtml = '<div style="display: grid; gap: 10px;">';

                    result.trades.forEach(trade => {
                        const statusColor = trade.execution_status === 'completed' ? '#8A2BE2' : '#FF4444';
                        const profitColor = parseFloat(trade.actual_profit_zar || 0) > 0 ? '#00ff88' : '#FF4444';

                        historyHtml += `
                            <div style="background: rgba(255,255,255,0.03); padding: 12px; border-radius: 8px; border-left: 3px solid ${statusColor};">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span style="color: white; font-weight: 600; font-size: 13px;">${trade.path_sequence}</span>
                                    <span style="color: ${profitColor}; font-weight: 600;">${trade.actual_profit_zar ? '+' + trade.actual_profit_zar : '‚Äî'} USDT</span>
                                </div>
                                <div style="color: #888; font-size: 12px;">${new Date(trade.created_at).toLocaleString()}</div>
                            </div>
                        `;
                    });

                    historyHtml += '</div>';
                    document.getElementById('ascendexTradeHistory').innerHTML = historyHtml;
                }
            } catch (error) {
                console.error('AscendEX history error:', error);
            }
        }

        // 8. Start AscendEX Worker
        async function startAscendexWorker() {
            // Validate credentials
            const apiKey = localStorage.getItem('ascendex_triangular_api');
            const apiSecret = localStorage.getItem('ascendex_triangular_secret');

            if (!apiKey || !apiSecret) {
                alert('‚ö†Ô∏è Please configure AscendEX API credentials first!');
                document.getElementById('ascendexTriangularEnabled').classList.remove('active');
                document.getElementById('ascendexTriangularStatus').textContent = 'OFF';
                document.getElementById('ascendexTriangularStatus').style.color = '#ff6b6b';
                return;
            }

            // Check if at least one set is selected
            const set1Enabled = document.getElementById('ascendexSet1Enabled').checked;
            const set2Enabled = document.getElementById('ascendexSet2Enabled').checked;
            const set3Enabled = document.getElementById('ascendexSet3Enabled').checked;
            const set4Enabled = document.getElementById('ascendexSet4Enabled').checked;
            const set5Enabled = document.getElementById('ascendexSet5Enabled').checked;

            if (!set1Enabled && !set2Enabled && !set3Enabled && !set4Enabled && !set5Enabled) {
                alert('‚ö†Ô∏è Please enable at least one path set!');
                document.getElementById('ascendexTriangularEnabled').classList.remove('active');
                document.getElementById('ascendexTriangularStatus').textContent = 'OFF';
                document.getElementById('ascendexTriangularStatus').style.color = '#ff6b6b';
                return;
            }

            const portfolioPercent = parseFloat(document.getElementById('ascendexPortfolioPercent').value) || 5;
            const maxTradeAmount = parseFloat(document.getElementById('ascendexMaxTrade').value) || 100;
            const profitThreshold = parseFloat(document.getElementById('ascendexProfitThreshold').value) || 0.3;

            // Build enabled sets object
            const enabledSets = {
                SET_1_ESSENTIAL_ETH_BRIDGE: set1Enabled,
                SET_2_MIDCAP_BTC_BRIDGE: set2Enabled,
                SET_3_ASD_NATIVE_BRIDGE: set3Enabled,
                SET_4_HIGH_VOLATILITY: set4Enabled,
                SET_5_EXTENDED_MULTIBRIDGE: set5Enabled
            };

            const selectedSets = Object.keys(enabledSets).filter(key => enabledSets[key]);

            console.log(`üíé [ASCENDEX] Worker started - scanning ${selectedSets.length} sets sequentially`);
            console.log(`üíé [ASCENDEX] Portfolio: ${portfolioPercent}%, Max Trade: ${maxTradeAmount}, Threshold: ${profitThreshold}%`);

            let currentSetIndex = 0;

            // Sequential scan function
            async function scanAndExecuteSequential() {
                try {
                    ascendexWorkerStats.totalScans++;
                    ascendexWorkerStats.lastScanTime = new Date().toISOString();

                    const currentSet = selectedSets[currentSetIndex];
                    console.log(`üíé [ASCENDEX] Scanning set ${currentSetIndex + 1}/${selectedSets.length}: ${currentSet}`);

                    // Build enabledSets object for current set only
                    const currentEnabledSets = {};
                    Object.keys(enabledSets).forEach(key => {
                        currentEnabledSets[key] = key === currentSet;
                    });

                    // Scan current set only
                    const response = await fetch('/api/v1/trading/ascendex/triangular/scan', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            apiKey,
                            apiSecret,
                            enabledSets: currentEnabledSets,
                            portfolioPercent,
                            maxTradeAmount
                        })
                    });

                    const data = await response.json();

                    if (data.success && data.opportunities && data.opportunities.length > 0) {
                        ascendexWorkerStats.totalOpportunities += data.opportunities.length;

                        // Log opportunities above threshold
                        data.opportunities.forEach(opp => {
                            if (opp.profitPercentage >= profitThreshold) {
                                console.log(`üíé [ASCENDEX] Opportunity found: ${opp.pathId} - ${opp.profitPercentage.toFixed(3)}% profit`);

                                // Track best profit
                                if (opp.profitPercentage > ascendexWorkerStats.bestProfit) {
                                    ascendexWorkerStats.bestProfit = opp.profitPercentage;
                                    ascendexWorkerStats.bestPath = opp.pathId;
                                }
                            }
                        });
                    }

                    // Move to next set (circular)
                    currentSetIndex = (currentSetIndex + 1) % selectedSets.length;

                    // Update balance after completing full cycle
                    if (currentSetIndex === 0) {
                        console.log(`üíé [ASCENDEX] Completed full cycle - updating balance...`);
                        initializeAscendexBalance();
                    }

                } catch (error) {
                    console.error(`üíé [ASCENDEX] Worker scan error:`, error);
                }
            }

            // Start sequential interval (8 seconds between scans)
            scanAndExecuteSequential(); // Run immediately
            ascendexWorkerInterval = setInterval(scanAndExecuteSequential, 8000);

            console.log(`üíé [ASCENDEX] Worker active - scanning every 8 seconds`);
        }

        function stopAscendexWorker() {
            if (ascendexWorkerInterval) {
                clearInterval(ascendexWorkerInterval);
                ascendexWorkerInterval = null;

                console.log(`üíé [ASCENDEX] Worker stopped`);
                console.log(`üíé [ASCENDEX] Stats:`, {
                    totalScans: ascendexWorkerStats.totalScans,
                    totalOpportunities: ascendexWorkerStats.totalOpportunities,
                    bestProfit: ascendexWorkerStats.bestProfit?.toFixed(3) + '%',
                    bestPath: ascendexWorkerStats.bestPath
                });
            }
        }

        // 9. Initialize AscendEX on DOMContentLoaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üíé [ASCENDEX] Initializing triangular arbitrage...');
            loadAscendexTriangularSettings();
            initializeAscendexBalance();
            switchAscendexTab('balance');
        });

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // BINGX TRIANGULAR ARBITRAGE FUNCTIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        // Worker Variables
        let bingxWorkerInterval = null;
        let bingxWorkerStats = {
            totalScans: 0,
            totalOpportunities: 0,
            totalTrades: 0,
            successfulTrades: 0,
            totalProfit: 0,
            bestProfit: 0,
            bestPath: null,
            lastScanTime: null
        };

        // 1. Toggle BingX Triangular
        function toggleBingxTriangular() {
            const toggle = document.getElementById('bingxTriangularEnabled');
            const status = document.getElementById('bingxTriangularStatus');
            const isActive = toggle.classList.toggle('active');

            if (isActive) {
                status.textContent = 'ON';
                status.style.color = '#00BFFF';
                localStorage.setItem('bingxTriangularEnabled', 'true');
                console.log('üåä [BINGX] Triangular arbitrage enabled - starting worker...');
                startBingxWorker();
            } else {
                status.textContent = 'OFF';
                status.style.color = '#ff6b6b';
                localStorage.setItem('bingxTriangularEnabled', 'false');
                console.log('üåä [BINGX] Triangular arbitrage disabled - stopping worker...');
                stopBingxWorker();
            }
        }

        // 2. View BingX Path Details (Professional Modal)
        function viewBingxPathDetails() {
            // Create modal overlay
            const modal = document.createElement('div');
            modal.id = 'bingxPathsModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.85);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                backdrop-filter: blur(5px);
            `;

            // Create modal content
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
                border-radius: 20px;
                max-width: 900px;
                max-height: 90vh;
                overflow-y: auto;
                padding: 30px;
                box-shadow: 0 10px 50px rgba(0,191,255,0.3);
                border: 2px solid #00BFFF;
            `;

            modalContent.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                    <h2 style="color: #00BFFF; margin: 0; font-size: 1.8rem;">üåä BingX Triangular Arbitrage Paths</h2>
                    <button onclick="document.getElementById('bingxPathsModal').remove()"
                            style="background: rgba(255,68,68,0.2); color: #ff4444; border: 1px solid #ff4444; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                        ‚úï Close
                    </button>
                </div>

                <div style="background: rgba(0,191,255,0.1); padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #00BFFF;">
                    <div style="color: #00BFFF; font-weight: bold; margin-bottom: 8px;">üìä Overview</div>
                    <div style="color: #b8c6db; font-size: 0.9rem; line-height: 1.6;">
                        ‚Ä¢ <strong>32 Total Paths:</strong> 31 three-leg + 1 four-leg cycles<br>
                        ‚Ä¢ <strong>Bridge Currency:</strong> USDT (200+ trading pairs)<br>
                        ‚Ä¢ <strong>Native Token:</strong> None (uses SOL for high-liquidity paths)<br>
                        ‚Ä¢ <strong>Authentication:</strong> HMAC-SHA256 with X-BX-APIKEY header<br>
                        ‚Ä¢ <strong>Exchange:</strong> BingX (Global derivatives & spot)
                    </div>
                </div>

                <!-- SET 1 -->
                <div style="background: rgba(0,255,0,0.05); border-left: 4px solid #00ff00; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <div style="color: #00ff00; font-weight: bold; font-size: 1.1rem; margin-bottom: 12px;">‚úÖ SET 1: Essential ETH Bridge (7 paths) - ENABLED BY DEFAULT</div>
                    <div style="color: #b8c6db; font-size: 0.9rem; line-height: 1.8;">
                        1. USDT ‚Üí ETH ‚Üí BTC ‚Üí USDT (ETH-USDT, BTC-ETH, BTC-USDT)<br>
                        2. USDT ‚Üí ETH ‚Üí SOL ‚Üí USDT (ETH-USDT, SOL-ETH, SOL-USDT)<br>
                        3. USDT ‚Üí ETH ‚Üí XRP ‚Üí USDT (ETH-USDT, XRP-ETH, XRP-USDT)<br>
                        4. USDT ‚Üí ETH ‚Üí ADA ‚Üí USDT (ETH-USDT, ADA-ETH, ADA-USDT)<br>
                        5. USDT ‚Üí ETH ‚Üí DOT ‚Üí USDT (ETH-USDT, DOT-ETH, DOT-USDT)<br>
                        6. USDT ‚Üí ETH ‚Üí MATIC ‚Üí USDT (ETH-USDT, MATIC-ETH, MATIC-USDT)<br>
                        7. USDT ‚Üí ETH ‚Üí LINK ‚Üí USDT (ETH-USDT, LINK-ETH, LINK-USDT)
                    </div>
                </div>

                <!-- SET 2 -->
                <div style="background: rgba(0,255,0,0.05); border-left: 4px solid #00ff00; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <div style="color: #00ff00; font-weight: bold; font-size: 1.1rem; margin-bottom: 12px;">‚úÖ SET 2: Mid-Cap BTC Bridge (7 paths) - ENABLED BY DEFAULT</div>
                    <div style="color: #b8c6db; font-size: 0.9rem; line-height: 1.8;">
                        1. USDT ‚Üí BTC ‚Üí ETH ‚Üí USDT (BTC-USDT, ETH-BTC, ETH-USDT)<br>
                        2. USDT ‚Üí BTC ‚Üí SOL ‚Üí USDT (BTC-USDT, SOL-BTC, SOL-USDT)<br>
                        3. USDT ‚Üí BTC ‚Üí AVAX ‚Üí USDT (BTC-USDT, AVAX-BTC, AVAX-USDT)<br>
                        4. USDT ‚Üí BTC ‚Üí ATOM ‚Üí USDT (BTC-USDT, ATOM-BTC, ATOM-USDT)<br>
                        5. USDT ‚Üí BTC ‚Üí LTC ‚Üí USDT (BTC-USDT, LTC-BTC, LTC-USDT)<br>
                        6. USDT ‚Üí BTC ‚Üí UNI ‚Üí USDT (BTC-USDT, UNI-BTC, UNI-USDT)<br>
                        7. USDT ‚Üí BTC ‚Üí FIL ‚Üí USDT (BTC-USDT, FIL-BTC, FIL-USDT)
                    </div>
                </div>

                <!-- SET 3 -->
                <div style="background: rgba(255,215,0,0.05); border-left: 4px solid #FFD700; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <div style="color: #FFD700; font-weight: bold; font-size: 1.1rem; margin-bottom: 12px;">üåü SET 3: SOL High-Liquidity (6 paths) - No Native Token</div>
                    <div style="color: #b8c6db; font-size: 0.9rem; line-height: 1.8;">
                        1. USDT ‚Üí SOL ‚Üí BTC ‚Üí USDT (SOL-USDT, BTC-SOL, BTC-USDT)<br>
                        2. USDT ‚Üí SOL ‚Üí ETH ‚Üí USDT (SOL-USDT, ETH-SOL, ETH-USDT)<br>
                        3. USDT ‚Üí SOL ‚Üí XRP ‚Üí USDT (SOL-USDT, XRP-SOL, XRP-USDT)<br>
                        4. USDT ‚Üí SOL ‚Üí ADA ‚Üí USDT (SOL-USDT, ADA-SOL, ADA-USDT)<br>
                        5. USDT ‚Üí SOL ‚Üí DOT ‚Üí USDT (SOL-USDT, DOT-SOL, DOT-USDT)<br>
                        6. USDT ‚Üí SOL ‚Üí AVAX ‚Üí USDT (SOL-USDT, AVAX-SOL, AVAX-USDT)
                    </div>
                </div>

                <!-- SET 4 -->
                <div style="background: rgba(255,165,0,0.05); border-left: 4px solid #FFA500; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <div style="color: #FFA500; font-weight: bold; font-size: 1.1rem; margin-bottom: 12px;">‚ö° SET 4: High Volatility (6 paths)</div>
                    <div style="color: #b8c6db; font-size: 0.9rem; line-height: 1.8;">
                        1. USDT ‚Üí DOGE ‚Üí BTC ‚Üí USDT (DOGE-USDT, BTC-DOGE, BTC-USDT)<br>
                        2. USDT ‚Üí SHIB ‚Üí ETH ‚Üí USDT (SHIB-USDT, ETH-SHIB, ETH-USDT)<br>
                        3. USDT ‚Üí PEPE ‚Üí ETH ‚Üí USDT (PEPE-USDT, ETH-PEPE, ETH-USDT)<br>
                        4. USDT ‚Üí NEAR ‚Üí BTC ‚Üí USDT (NEAR-USDT, BTC-NEAR, BTC-USDT)<br>
                        5. USDT ‚Üí APT ‚Üí ETH ‚Üí USDT (APT-USDT, ETH-APT, ETH-USDT)<br>
                        6. USDT ‚Üí FTM ‚Üí BTC ‚Üí USDT (FTM-USDT, BTC-FTM, BTC-USDT)
                    </div>
                </div>

                <!-- SET 5 -->
                <div style="background: rgba(255,0,0,0.05); border-left: 4px solid #ff4444; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <div style="color: #ff4444; font-weight: bold; font-size: 1.1rem; margin-bottom: 12px;">üîÅ SET 5: Extended Multi-Bridge (6 paths) - Includes 1 Four-Leg Path</div>
                    <div style="color: #b8c6db; font-size: 0.9rem; line-height: 1.8;">
                        1. USDT ‚Üí TRX ‚Üí BTC ‚Üí USDT (TRX-USDT, BTC-TRX, BTC-USDT)<br>
                        2. USDT ‚Üí ALGO ‚Üí ETH ‚Üí USDT (ALGO-USDT, ETH-ALGO, ETH-USDT)<br>
                        3. USDT ‚Üí VET ‚Üí BTC ‚Üí USDT (VET-USDT, BTC-VET, BTC-USDT)<br>
                        4. USDT ‚Üí HBAR ‚Üí ETH ‚Üí USDT (HBAR-USDT, ETH-HBAR, ETH-USDT)<br>
                        5. USDT ‚Üí SAND ‚Üí ETH ‚Üí USDT (SAND-USDT, ETH-SAND, ETH-USDT)<br>
                        6. USDT ‚Üí BTC ‚Üí ETH ‚Üí SOL ‚Üí USDT ‚≠ê <strong style="color: #ff4444;">4-LEG</strong> (BTC-USDT, ETH-BTC, SOL-ETH, SOL-USDT)
                    </div>
                </div>

                <div style="background: rgba(0,191,255,0.1); padding: 15px; border-radius: 10px; margin-top: 20px; border-left: 4px solid #00BFFF;">
                    <div style="color: #00BFFF; font-weight: bold; margin-bottom: 8px;">üí° Portfolio % Risk Management</div>
                    <div style="color: #b8c6db; font-size: 0.9rem; line-height: 1.6;">
                        Trade Amount = <strong>MIN(portfolioPercent √ó balance, maxTradeAmount)</strong><br>
                        Default: 10% of USDT balance, capped at $1,000<br>
                        Adjust in Risk Management settings above.
                    </div>
                </div>
            `;

            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // Close on background click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // 3. Switch BingX Tabs
        function switchBingxTab(tab) {
            const balanceTab = document.getElementById('bingxBalanceTab');
            const tradingTab = document.getElementById('bingxTradingTab');
            const balanceContent = document.getElementById('bingxBalanceContent');
            const tradingContent = document.getElementById('bingxTradingContent');

            if (tab === 'balance') {
                balanceTab.style.background = '#00BFFF';
                balanceTab.style.color = 'white';
                balanceTab.style.border = 'none';
                tradingTab.style.background = 'rgba(0,191,255,0.2)';
                tradingTab.style.color = '#00BFFF';
                tradingTab.style.border = '1px solid #00BFFF';

                balanceContent.style.display = 'block';
                tradingContent.style.display = 'none';
            } else {
                tradingTab.style.background = '#00BFFF';
                tradingTab.style.color = 'white';
                tradingTab.style.border = 'none';
                balanceTab.style.background = 'rgba(0,191,255,0.2)';
                balanceTab.style.color = '#00BFFF';
                balanceTab.style.border = '1px solid #00BFFF';

                tradingContent.style.display = 'block';
                balanceContent.style.display = 'none';
            }
        }

        // 4. BingX Balance Tracking
        const bingxBalanceTracking = {
            starting: 0,
            current: 0,
            initialized: false
        };

        async function initializeBingxBalance() {
            try {
                const apiKey = localStorage.getItem('bingx_triangular_api');
                const apiSecret = localStorage.getItem('bingx_triangular_secret');

                if (!apiKey || !apiSecret) {
                    console.log('BingX credentials not found, skipping balance initialization');
                    return;
                }

                const response = await fetch('/api/v1/trading/bingx/balance', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({
                        apiKey,
                        apiSecret,
                        currency: 'USDT'
                    })
                });

                const result = await response.json();

                if (result.success) {
                    const balance = parseFloat(result.balance) || 0;
                    bingxBalanceTracking.starting = balance;
                    bingxBalanceTracking.current = balance;
                    bingxBalanceTracking.initialized = true;
                    updateBingxBalanceDisplay();
                    console.log('‚úÖ [BINGX] Balance initialized:', balance);
                } else {
                    console.warn('BingX balance fetch failed:', result.message);
                    // Set to 0 if failed
                    bingxBalanceTracking.starting = 0;
                    bingxBalanceTracking.current = 0;
                    updateBingxBalanceDisplay();
                }
            } catch (error) {
                console.error('BingX balance initialization error:', error);
            }
        }

        async function updateBingxBalance() {
            try {
                const apiKey = localStorage.getItem('bingx_triangular_api');
                const apiSecret = localStorage.getItem('bingx_triangular_secret');

                if (!apiKey || !apiSecret) {
                    alert('‚ùå BingX API credentials not found!\n\nPlease set your API credentials on the SETUP page first.');
                    return;
                }

                const response = await fetch('/api/v1/trading/bingx/balance', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({
                        apiKey,
                        apiSecret,
                        currency: 'USDT'
                    })
                });

                const result = await response.json();

                if (result.success) {
                    const balance = parseFloat(result.balance) || 0;

                    if (!bingxBalanceTracking.initialized) {
                        bingxBalanceTracking.starting = balance;
                        bingxBalanceTracking.initialized = true;
                    }

                    bingxBalanceTracking.current = balance;
                    updateBingxBalanceDisplay();
                } else {
                    alert(`‚ùå Failed to fetch BingX balance\n\n${result.message}`);
                }
            } catch (error) {
                console.error('BingX balance update error:', error);
                alert(`‚ùå Failed to fetch BingX balance\n\n${error.message}`);
            }
        }

        function updateBingxBalanceDisplay() {
            // Ensure we have valid numbers, default to 0 if undefined/null/NaN
            const starting = Number(bingxBalanceTracking.starting) || 0;
            const current = Number(bingxBalanceTracking.current) || 0;
            const change = current - starting;
            const changePercent = starting > 0 ? ((change / starting) * 100).toFixed(2) : '0.00';
            const changeSign = change >= 0 ? '+' : '';
            const changeColor = change >= 0 ? '#00d26a' : '#ff4444';

            document.getElementById('bingxStartingUSDT').textContent = `${starting.toFixed(2)} USDT`;
            document.getElementById('bingxCurrentUSDT').textContent = `${current.toFixed(2)} USDT`;
            document.getElementById('bingxChangeUSDT').innerHTML = `<span style="color: ${changeColor}">${changeSign}${change.toFixed(2)} USDT (${changeSign}${changePercent}%)</span>`;
        }

        function resetBingxStartingBalance() {
            if (confirm('Reset starting balance to current balance?\n\nThis will reset your profit tracking.')) {
                bingxBalanceTracking.starting = bingxBalanceTracking.current;
                updateBingxBalanceDisplay();
            }
        }

        // 5. Save BingX Settings
        function saveBingxTriangularSettings() {
            const settings = {
                maxTrade: document.getElementById('bingxMaxTrade').value,
                portfolioPercent: document.getElementById('bingxPortfolioPercent').value,
                profitThreshold: document.getElementById('bingxProfitThreshold').value,
                set1Enabled: document.getElementById('bingxSet1Enabled').checked,
                set2Enabled: document.getElementById('bingxSet2Enabled').checked,
                set3Enabled: document.getElementById('bingxSet3Enabled').checked,
                set4Enabled: document.getElementById('bingxSet4Enabled').checked,
                set5Enabled: document.getElementById('bingxSet5Enabled').checked
            };

            localStorage.setItem('bingx_triangular_settings', JSON.stringify(settings));
            console.log('‚úÖ [BINGX] Settings saved:', settings);
        }

        // 6. Load BingX Settings
        function loadBingxTriangularSettings() {
            const saved = localStorage.getItem('bingx_triangular_settings');
            if (saved) {
                const settings = JSON.parse(saved);
                document.getElementById('bingxMaxTrade').value = settings.maxTrade || 1000;
                document.getElementById('bingxPortfolioPercent').value = settings.portfolioPercent || 10;
                document.getElementById('bingxProfitThreshold').value = settings.profitThreshold || 0.5;
                document.getElementById('bingxSet1Enabled').checked = settings.set1Enabled !== false;
                document.getElementById('bingxSet2Enabled').checked = settings.set2Enabled !== false;
                document.getElementById('bingxSet3Enabled').checked = settings.set3Enabled === true;
                document.getElementById('bingxSet4Enabled').checked = settings.set4Enabled === true;
                document.getElementById('bingxSet5Enabled').checked = settings.set5Enabled === true;
                console.log('‚úÖ [BINGX] Settings loaded:', settings);
            }

            // Load toggle state
            const enabled = localStorage.getItem('bingxTriangularEnabled') === 'true';
            const toggle = document.getElementById('bingxTriangularEnabled');
            const status = document.getElementById('bingxTriangularStatus');

            if (enabled) {
                toggle.classList.add('active');
                status.textContent = 'ON';
                status.style.color = '#00BFFF';
            } else {
                toggle.classList.remove('active');
                status.textContent = 'OFF';
                status.style.color = '#ff6b6b';
            }
        }

        // 7. Clear BingX History
        function clearBingxHistory() {
            if (confirm('Clear all opportunity history?\n\nThis cannot be undone.')) {
                document.getElementById('bingxOpportunities').innerHTML = '<div style="color: #888; font-size: 14px;">No opportunities found yet. Click "Scan Opportunities Now" to begin scanning.</div>';
                document.getElementById('bingxScanStatus').textContent = '';
                document.getElementById('bingxPathsScanned').textContent = '0';
                document.getElementById('bingxOpportunitiesFound').textContent = '0';
            }
        }

        // 8. Scan BingX Triangular Paths (Updated with portfolioPercent)
        async function scanBingxTriangularPaths() {
            try {
                const apiKey = localStorage.getItem('bingx_triangular_api');
                const apiSecret = localStorage.getItem('bingx_triangular_secret');

                if (!apiKey || !apiSecret) {
                    alert('‚ùå BingX API credentials not found!\n\nPlease set your API credentials on the SETUP page first.');
                    return;
                }

                const maxTradeAmount = parseFloat(document.getElementById('bingxMaxTrade').value);
                const portfolioPercent = parseFloat(document.getElementById('bingxPortfolioPercent').value);
                const profitThreshold = parseFloat(document.getElementById('bingxProfitThreshold').value);

                const enabledSets = {
                    SET_1_ESSENTIAL_ETH_BRIDGE: document.getElementById('bingxSet1Enabled').checked,
                    SET_2_MIDCAP_BTC_BRIDGE: document.getElementById('bingxSet2Enabled').checked,
                    SET_3_SOL_HIGH_LIQUIDITY: document.getElementById('bingxSet3Enabled').checked,
                    SET_4_HIGH_VOLATILITY: document.getElementById('bingxSet4Enabled').checked,
                    SET_5_EXTENDED_MULTIBRIDGE: document.getElementById('bingxSet5Enabled').checked
                };

                document.getElementById('bingxScanStatus').textContent = 'üîç Scanning BingX paths...';
                document.getElementById('bingxOpportunities').innerHTML = '<div style="text-align: center; padding: 20px; color: #00BFFF;">‚è≥ Analyzing 200+ pairs...</div>';

                const response = await fetch('/api/v1/trading/bingx/triangular/scan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({ apiKey, apiSecret, maxTradeAmount, portfolioPercent, profitThreshold, enabledSets })
                });

                const result = await response.json();

                // Update performance stats
                if (result.success) {
                    document.getElementById('bingxPathsScanned').textContent = result.scanned || 0;
                    document.getElementById('bingxOpportunitiesFound').textContent = result.profitableCount || 0;
                }

                if (result.success && result.opportunities.length > 0) {
                    document.getElementById('bingxScanStatus').textContent = `‚úÖ Found ${result.opportunities.length} opportunities`;

                    let oppsHtml = '<div style="display: grid; gap: 15px;">';
                    result.opportunities.forEach(opp => {
                        const profitColor = parseFloat(opp.profitPercent) >= 1 ? '#00ff88' : '#00BFFF';

                        oppsHtml += `
                            <div style="background: rgba(0,191,255,0.1); padding: 15px; border-radius: 10px; border-left: 4px solid ${profitColor};">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <span style="color: white; font-weight: 600; font-size: 15px;">${opp.path.join(' ‚Üí ')}</span>
                                    <span style="color: ${profitColor}; font-weight: 700; font-size: 16px;">+${opp.profitPercent}%</span>
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px; font-size: 13px;">
                                    <div><span style="color: #888;">Initial:</span> <span style="color: white;">$${opp.initialAmount}</span></div>
                                    <div><span style="color: #888;">Final:</span> <span style="color: white;">$${opp.finalAmount}</span></div>
                                    <div><span style="color: #888;">Profit:</span> <span style="color: ${profitColor};">$${opp.profitAmount}</span></div>
                                </div>
                                <div style="margin-top: 12px; font-size: 13px;">
                                    <div><span style="color: #888;">Description:</span> <span style="color: #b8c6db;">${opp.description}</span></div>
                                </div>
                            </div>
                        `;
                    });
                    oppsHtml += '</div>';

                    document.getElementById('bingxOpportunities').innerHTML = oppsHtml;
                } else {
                    document.getElementById('bingxScanStatus').textContent = '‚ùå No profitable opportunities found';
                    document.getElementById('bingxOpportunities').innerHTML = '<div style="text-align: center; padding: 20px; color: #888;">No opportunities above profit threshold. Try lowering threshold or enabling more path sets.</div>';
                }
            } catch (error) {
                console.error('BingX scan error:', error);
                document.getElementById('bingxScanStatus').textContent = '‚ùå Scan failed';
                document.getElementById('bingxOpportunities').innerHTML = `<div style="color: #FF4444; padding: 20px; text-align: center;">Error: ${error.message}</div>`;
            }
        }

        // 9. Execute BingX Triangular Trade
        async function executeBingxTriangularTrade(pathId) {
            const apiKey = localStorage.getItem('bingx_triangular_api') || '';
            const apiSecret = localStorage.getItem('bingx_triangular_secret') || '';
            const maxTrade = parseFloat(document.getElementById('bingxMaxTrade').value);

            // Enhanced real money warning
            if (!confirm(`‚ö†Ô∏è REAL MONEY TRADING ‚ö†Ô∏è\n\nExecute REAL triangular arbitrage trade?\n\nPath: ${pathId}\nAmount: ${maxTrade} USDT\n\nThis will execute REAL market orders on BingX.\nClick OK to proceed.`)) {
                return;
            }

            try {
                const response = await fetch('/api/v1/trading/bingx/triangular/execute', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ apiKey, apiSecret, pathId, amount: maxTrade })
                });

                const result = await response.json();

                if (result.success && result.data) {
                    const execution = result.data;

                    if (execution.status === 'COMPLETED') {
                        const profit = execution.actualProfit || 0;
                        const profitPct = execution.actualProfitPercentage || 0;

                        alert(`‚úÖ Trade Executed Successfully!\n\nExecution ID: ${execution.executionId}\nProfit: $${profit.toFixed(2)} (${profitPct.toFixed(3)}%)\nLegs Completed: ${execution.legs?.length || 0}/3\nTotal Time: ${execution.totalExecutionTime}ms\n\nAll legs executed atomically with slippage monitoring.`);

                        // üìä Log to backend using shared service
                        logTriangularTrade('BingX', pathId, profit, maxTrade, execution.totalFees || 0).catch(e => console.warn('Logging failed:', e));

                        // Refresh opportunities and balance
                        scanBingxTriangularPaths();
                        initializeBingxBalance();
                    } else {
                        alert(`‚ùå Trade Failed!\n\nStatus: ${execution.status}\nError: ${execution.error || 'Unknown error'}\nCompleted Legs: ${execution.legs?.filter(l => l.status === 'COMPLETED').length || 0}/3`);
                    }
                } else {
                    alert(`‚ùå Trade execution failed:\n\n${result.message || 'Unknown error'}`);
                }
            } catch (error) {
                alert(`‚ùå Trade execution error:\n\n${error.message}`);
            }
        }

        // Start BingX Worker (Sequential Scanning)
        async function startBingxWorker() {
            // Validate credentials
            const apiKey = localStorage.getItem('bingx_triangular_api');
            const apiSecret = localStorage.getItem('bingx_triangular_secret');

            if (!apiKey || !apiSecret) {
                alert('‚ö†Ô∏è Please configure BingX API credentials first!');
                document.getElementById('bingxTriangularEnabled').classList.remove('active');
                document.getElementById('bingxTriangularStatus').textContent = 'OFF';
                document.getElementById('bingxTriangularStatus').style.color = '#ff6b6b';
                return;
            }

            // Check if at least one set is selected
            const set1Enabled = document.getElementById('bingxSet1Enabled').checked;
            const set2Enabled = document.getElementById('bingxSet2Enabled').checked;
            const set3Enabled = document.getElementById('bingxSet3Enabled').checked;
            const set4Enabled = document.getElementById('bingxSet4Enabled').checked;
            const set5Enabled = document.getElementById('bingxSet5Enabled').checked;

            if (!set1Enabled && !set2Enabled && !set3Enabled && !set4Enabled && !set5Enabled) {
                alert('‚ö†Ô∏è Please enable at least one path set!');
                document.getElementById('bingxTriangularEnabled').classList.remove('active');
                document.getElementById('bingxTriangularStatus').textContent = 'OFF';
                document.getElementById('bingxTriangularStatus').style.color = '#ff6b6b';
                return;
            }

            const portfolioPercent = parseFloat(document.getElementById('bingxPortfolioPercent').value) || 5;
            const maxTradeAmount = parseFloat(document.getElementById('bingxMaxTrade').value) || 100;
            const profitThreshold = parseFloat(document.getElementById('bingxProfitThreshold').value) || 0.3;

            // Build selected sets array
            const selectedSets = [];
            if (set1Enabled) selectedSets.push('SET_1_ESSENTIAL_ETH_BRIDGE');
            if (set2Enabled) selectedSets.push('SET_2_MIDCAP_BTC_BRIDGE');
            if (set3Enabled) selectedSets.push('SET_3_SOL_HIGH_LIQUIDITY');
            if (set4Enabled) selectedSets.push('SET_4_HIGH_VOLATILITY');
            if (set5Enabled) selectedSets.push('SET_5_EXTENDED_MULTIBRIDGE');

            console.log(`üåä [BINGX] Worker started - scanning ${selectedSets.length} sets sequentially`);
            console.log(`üåä [BINGX] Portfolio: ${portfolioPercent}%, Max Trade: $${maxTradeAmount}, Threshold: ${profitThreshold}%`);

            let currentSetIndex = 0;

            // Sequential scan function
            async function scanAndExecuteSequential() {
                try {
                    bingxWorkerStats.totalScans++;
                    bingxWorkerStats.lastScanTime = new Date().toISOString();

                    const currentSet = selectedSets[currentSetIndex];
                    console.log(`üåä [BINGX] Scanning set ${currentSetIndex + 1}/${selectedSets.length}: ${currentSet}`);

                    // Scan current set only
                    const response = await fetch('/api/v1/trading/bingx/triangular/scan', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            apiKey,
                            apiSecret,
                            selectedSets: [currentSet],
                            portfolioPercent,
                            maxTradeAmount
                        })
                    });

                    const data = await response.json();

                    if (data.success && data.opportunities && data.opportunities.length > 0) {
                        bingxWorkerStats.totalOpportunities += data.opportunities.length;

                        // Log opportunities above threshold
                        data.opportunities.forEach(opp => {
                            if (opp.profitPercentage >= profitThreshold) {
                                console.log(`üåä [BINGX] Opportunity found: ${opp.pathId} - ${opp.profitPercentage.toFixed(3)}% profit`);

                                // Track best profit
                                if (opp.profitPercentage > bingxWorkerStats.bestProfit) {
                                    bingxWorkerStats.bestProfit = opp.profitPercentage;
                                    bingxWorkerStats.bestPath = opp.pathId;
                                }
                            }
                        });
                    }

                    // Move to next set (circular)
                    currentSetIndex = (currentSetIndex + 1) % selectedSets.length;

                    // Update balance after completing full cycle
                    if (currentSetIndex === 0) {
                        console.log(`üåä [BINGX] Completed full cycle - updating balance...`);
                        initializeBingxBalance();
                    }

                } catch (error) {
                    console.error(`üåä [BINGX] Worker scan error:`, error);
                }
            }

            // Start sequential interval (8 seconds between scans)
            scanAndExecuteSequential(); // Run immediately
            bingxWorkerInterval = setInterval(scanAndExecuteSequential, 8000);

            console.log(`üåä [BINGX] Worker active - scanning every 8 seconds`);
        }

        // Stop BingX Worker
        function stopBingxWorker() {
            if (bingxWorkerInterval) {
                clearInterval(bingxWorkerInterval);
                bingxWorkerInterval = null;

                console.log(`üåä [BINGX] Worker stopped`);
                console.log(`üåä [BINGX] Stats:`, {
                    totalScans: bingxWorkerStats.totalScans,
                    totalOpportunities: bingxWorkerStats.totalOpportunities,
                    bestProfit: bingxWorkerStats.bestProfit?.toFixed(3) + '%',
                    bestPath: bingxWorkerStats.bestPath
                });
            }
        }

        // 10. Load BingX Trade History
        async function loadBingxTradeHistory() {
            try {
                const userId = localStorage.getItem('userId');
                if (!userId) return;

                const response = await fetch('/api/v1/trading/bingx/triangular/history', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({ userId, limit: 10 })
                });

                const result = await response.json();

                if (result.success && result.trades.length > 0) {
                    let historyHtml = '<div style="display: grid; gap: 10px;">';

                    result.trades.forEach(trade => {
                        const statusColor = trade.execution_status === 'completed' ? '#00BFFF' : '#FF4444';
                        const profitColor = parseFloat(trade.actual_profit_zar || 0) > 0 ? '#00ff88' : '#FF4444';

                        historyHtml += `
                            <div style="background: rgba(255,255,255,0.03); padding: 12px; border-radius: 8px; border-left: 3px solid ${statusColor};">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span style="color: white; font-weight: 600; font-size: 13px;">${trade.path_sequence}</span>
                                    <span style="color: ${profitColor}; font-weight: 600;">${trade.actual_profit_zar ? '+' + trade.actual_profit_zar : '‚Äî'} USDT</span>
                                </div>
                                <div style="color: #888; font-size: 12px;">${new Date(trade.created_at).toLocaleString()}</div>
                            </div>
                        `;
                    });

                    historyHtml += '</div>';
                    document.getElementById('bingxTradeHistory').innerHTML = historyHtml;
                }
            } catch (error) {
                console.error('BingX history error:', error);
            }
        }

        // 11. Initialize BingX on DOMContentLoaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üåä [BINGX] Initializing triangular arbitrage...');
            loadBingxTriangularSettings();
            initializeBingxBalance();
            switchBingxTab('balance');
        });

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // BITGET TRIANGULAR ARBITRAGE FUNCTIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        // Worker Variables
        let bitgetWorkerInterval = null;
        let bitgetWorkerStats = {
            totalScans: 0,
            totalOpportunities: 0,
            totalTrades: 0,
            successfulTrades: 0,
            totalProfit: 0,
            bestProfit: 0,
            bestPath: null,
            lastScanTime: null
        };

        // 1. Toggle Bitget Triangular
        function toggleBitgetTriangular() {
            const toggle = document.getElementById('bitgetTriangularEnabled');
            const status = document.getElementById('bitgetTriangularStatus');
            const isActive = toggle.classList.toggle('active');

            if (isActive) {
                status.textContent = 'ON';
                status.style.color = '#8A2BE2';
                localStorage.setItem('bitgetTriangularEnabled', 'true');
                console.log('üíú [BITGET] Triangular arbitrage enabled - starting worker...');
                startBitgetWorker();
            } else {
                status.textContent = 'OFF';
                status.style.color = '#ff6b6b';
                localStorage.setItem('bitgetTriangularEnabled', 'false');
                console.log('üíú [BITGET] Triangular arbitrage disabled - stopping worker...');
                stopBitgetWorker();
            }
        }

        // 2. View Bitget Path Details (Professional Modal)
        function viewBitgetPathDetails() {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: flex; justify-content: center; align-items: center; z-index: 10000; backdrop-filter: blur(8px);';

            modal.innerHTML = `
                <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); padding: 30px; border-radius: 20px; max-width: 800px; max-height: 85vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(138,43,226,0.4); border: 2px solid rgba(138,43,226,0.3);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid rgba(138,43,226,0.3); padding-bottom: 15px;">
                        <h2 style="color: #8A2BE2; margin: 0; font-size: 24px; display: flex; align-items: center; gap: 10px;">
                            üíú Bitget Triangular Arbitrage Paths
                        </h2>
                        <button onclick="this.closest('div[style*=fixed]').remove()" style="background: rgba(255,107,107,0.2); color: #ff6b6b; border: 1px solid #ff6b6b; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s;">‚úï Close</button>
                    </div>

                    <div style="display: grid; gap: 20px;">
                        <!-- SET 1 -->
                        <div style="background: rgba(0,210,106,0.1); padding: 18px; border-radius: 12px; border-left: 5px solid #00d26a;">
                            <h3 style="color: #00d26a; margin: 0 0 12px 0; font-size: 16px; font-weight: 700;">SET 1: ESSENTIAL ETH BRIDGE (7 paths)</h3>
                            <div style="color: #b8c6db; font-size: 13px; line-height: 1.8; font-family: 'Courier New', monospace;">
                                1. USDT ‚Üí ETH ‚Üí BTC ‚Üí USDT<br>
                                2. USDT ‚Üí ETH ‚Üí USDC ‚Üí USDT<br>
                                3. USDT ‚Üí ETH ‚Üí SOL ‚Üí USDT<br>
                                4. USDT ‚Üí ETH ‚Üí XRP ‚Üí USDT<br>
                                5. USDT ‚Üí ETH ‚Üí ADA ‚Üí USDT<br>
                                6. USDT ‚Üí ETH ‚Üí DOGE ‚Üí USDT<br>
                                7. USDT ‚Üí ETH ‚Üí TRX ‚Üí USDT
                            </div>
                            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(0,210,106,0.2); color: #00d26a; font-weight: 600; font-size: 13px;">
                                üí∞ Funding: $350-700 USDT
                            </div>
                        </div>

                        <!-- SET 2 -->
                        <div style="background: rgba(0,210,106,0.1); padding: 18px; border-radius: 12px; border-left: 5px solid #00d26a;">
                            <h3 style="color: #00d26a; margin: 0 0 12px 0; font-size: 16px; font-weight: 700;">SET 2: MID-CAP BTC BRIDGE (7 paths)</h3>
                            <div style="color: #b8c6db; font-size: 13px; line-height: 1.8; font-family: 'Courier New', monospace;">
                                1. USDT ‚Üí BTC ‚Üí SOL ‚Üí USDT<br>
                                2. USDT ‚Üí BTC ‚Üí XRP ‚Üí USDT<br>
                                3. USDT ‚Üí BTC ‚Üí ADA ‚Üí USDT<br>
                                4. USDT ‚Üí BTC ‚Üí DOGE ‚Üí USDT<br>
                                5. USDT ‚Üí BTC ‚Üí MATIC ‚Üí USDT<br>
                                6. USDT ‚Üí BTC ‚Üí DOT ‚Üí USDT<br>
                                7. USDT ‚Üí BTC ‚Üí LTC ‚Üí USDT
                            </div>
                            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(0,210,106,0.2); color: #00d26a; font-weight: 600; font-size: 13px;">
                                üí∞ Funding: $350-700 USDT
                            </div>
                        </div>

                        <!-- SET 3 - BGB NATIVE TOKEN -->
                        <div style="background: rgba(138,43,226,0.15); padding: 18px; border-radius: 12px; border-left: 5px solid #8A2BE2;">
                            <h3 style="color: #8A2BE2; margin: 0 0 12px 0; font-size: 16px; font-weight: 700;">SET 3: BGB NATIVE TOKEN (6 paths) üíú</h3>
                            <div style="color: #b8c6db; font-size: 13px; line-height: 1.8; font-family: 'Courier New', monospace;">
                                1. USDT ‚Üí BGB ‚Üí BTC ‚Üí USDT<br>
                                2. USDT ‚Üí BGB ‚Üí ETH ‚Üí USDT<br>
                                3. USDT ‚Üí BGB ‚Üí SOL ‚Üí USDT<br>
                                4. USDT ‚Üí BGB ‚Üí XRP ‚Üí USDT<br>
                                5. USDT ‚Üí BGB ‚Üí ADA ‚Üí USDT<br>
                                6. USDT ‚Üí BGB ‚Üí DOGE ‚Üí USDT
                            </div>
                            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(138,43,226,0.3); color: #8A2BE2; font-weight: 600; font-size: 13px;">
                                üí∞ Funding: $300-600 USDT | BGB is Bitget's exchange token - may have fee discounts!
                            </div>
                        </div>

                        <!-- SET 4 -->
                        <div style="background: rgba(255,165,0,0.1); padding: 18px; border-radius: 12px; border-left: 5px solid #FFA500;">
                            <h3 style="color: #FFA500; margin: 0 0 12px 0; font-size: 16px; font-weight: 700;">SET 4: HIGH VOLATILITY (6 paths)</h3>
                            <div style="color: #b8c6db; font-size: 13px; line-height: 1.8; font-family: 'Courier New', monospace;">
                                1. USDT ‚Üí LINK ‚Üí BTC ‚Üí USDT<br>
                                2. USDT ‚Üí LINK ‚Üí ETH ‚Üí USDT<br>
                                3. USDT ‚Üí AVAX ‚Üí BTC ‚Üí USDT<br>
                                4. USDT ‚Üí AVAX ‚Üí ETH ‚Üí USDT<br>
                                5. USDT ‚Üí ATOM ‚Üí BTC ‚Üí USDT<br>
                                6. USDT ‚Üí ATOM ‚Üí ETH ‚Üí USDT
                            </div>
                            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,165,0,0.2); color: #FFA500; font-weight: 600; font-size: 13px;">
                                üí∞ Funding: $300-600 USDT
                            </div>
                        </div>

                        <!-- SET 5 -->
                        <div style="background: rgba(255,68,68,0.1); padding: 18px; border-radius: 12px; border-left: 5px solid #FF4444;">
                            <h3 style="color: #FF4444; margin: 0 0 12px 0; font-size: 16px; font-weight: 700;">SET 5: EXTENDED MULTI-BRIDGE (6 paths) üî•</h3>
                            <div style="color: #b8c6db; font-size: 13px; line-height: 1.8; font-family: 'Courier New', monospace;">
                                1. USDT ‚Üí UNI ‚Üí BTC ‚Üí USDT<br>
                                2. USDT ‚Üí UNI ‚Üí ETH ‚Üí USDT<br>
                                3. USDT ‚Üí SHIB ‚Üí BTC ‚Üí USDT<br>
                                4. USDT ‚Üí SHIB ‚Üí ETH ‚Üí USDT<br>
                                5. USDT ‚Üí BTC ‚Üí ETH ‚Üí SOL ‚Üí USDT (4-leg)<br>
                                6. USDT ‚Üí ETH ‚Üí BTC ‚Üí XRP ‚Üí USDT (4-leg)
                            </div>
                            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,68,68,0.2); color: #FF4444; font-weight: 600; font-size: 13px;">
                                üí∞ Funding: $300-600 USDT | Includes 2 four-leg paths
                            </div>
                        </div>

                        <!-- Total Funding -->
                        <div style="background: rgba(138,43,226,0.15); padding: 20px; border-radius: 12px; border: 2px solid #8A2BE2; text-align: center;">
                            <div style="color: #8A2BE2; font-size: 20px; font-weight: 700; margin-bottom: 10px;">
                                üí∞ TOTAL RECOMMENDED FUNDING
                            </div>
                            <div style="color: white; font-size: 28px; font-weight: 700; margin-bottom: 10px;">
                                $1,600 - $3,200 USDT
                            </div>
                            <div style="color: #b8c6db; font-size: 14px;">
                                (All 5 sets enabled)
                            </div>
                        </div>

                        <!-- Portfolio % Info -->
                        <div style="background: rgba(0,0,0,0.3); padding: 18px; border-radius: 12px; border: 1px solid rgba(138,43,226,0.3);">
                            <h4 style="color: #8A2BE2; margin: 0 0 12px 0; font-size: 15px;">‚öñÔ∏è PORTFOLIO % MODE</h4>
                            <p style="color: #b8c6db; margin: 0; font-size: 13px; line-height: 1.6;">
                                Trade amount = <strong style="color: white;">MIN(portfolioPercent √ó balance, maxTradeAmount)</strong><br>
                                Default: 10% of USDT balance, capped at $1,000<br>
                                <strong style="color: #8A2BE2;">Note:</strong> Passphrase required for Bitget API authentication
                            </p>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Close on outside click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }

        // 3. Switch Bitget Tab
        function switchBitgetTab(tab) {
            const balanceBtn = document.getElementById('bitgetBalanceTab');
            const tradingBtn = document.getElementById('bitgetTradingTab');
            const balanceContent = document.getElementById('bitgetBalanceContent');
            const tradingContent = document.getElementById('bitgetTradingContent');

            if (tab === 'balance') {
                balanceBtn.style.background = 'linear-gradient(135deg, #8A2BE2, #9370DB)';
                balanceBtn.style.color = 'white';
                tradingBtn.style.background = 'rgba(0,0,0,0.3)';
                tradingBtn.style.color = '#888';
                balanceContent.style.display = 'block';
                tradingContent.style.display = 'none';
            } else {
                tradingBtn.style.background = 'linear-gradient(135deg, #8A2BE2, #9370DB)';
                tradingBtn.style.color = 'white';
                balanceBtn.style.background = 'rgba(0,0,0,0.3)';
                balanceBtn.style.color = '#888';
                tradingContent.style.display = 'block';
                balanceContent.style.display = 'none';
            }
        }

        // 4. Balance Tracking with NaN Prevention
        const bitgetBalanceTracking = {
            starting: 0,
            current: 0,
            initialized: false
        };

        async function initializeBitgetBalance() {
            const apiKey = localStorage.getItem('bitget_api') || '';
            const apiSecret = localStorage.getItem('bitget_secret') || '';
            const passphrase = localStorage.getItem('bitget_passphrase') || '';

            if (!apiKey || !apiSecret || !passphrase) {
                console.log('üíú [BITGET] No API credentials - skipping auto-fetch');
                return;
            }

            try {
                const response = await fetch('/api/v1/trading/bitget/balance', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ apiKey, apiSecret, passphrase, currency: 'USDT' })
                });

                const data = await response.json();

                if (data.success) {
                    const balance = Number(data.balance) || 0;

                    if (!bitgetBalanceTracking.initialized) {
                        bitgetBalanceTracking.starting = balance;
                        bitgetBalanceTracking.current = balance;
                        bitgetBalanceTracking.initialized = true;
                        console.log(`üíú [BITGET] Balance initialized: ${balance} USDT`);
                    } else {
                        bitgetBalanceTracking.current = balance;
                    }

                    updateBitgetBalanceDisplay();
                }
            } catch (error) {
                console.error('üíú [BITGET] Auto-fetch failed:', error);
            }
        }

        async function updateBitgetBalance() {
            const apiKey = localStorage.getItem('bitget_api') || '';
            const apiSecret = localStorage.getItem('bitget_secret') || '';
            const passphrase = localStorage.getItem('bitget_passphrase') || '';

            if (!apiKey || !apiSecret || !passphrase) {
                alert('‚ö†Ô∏è Please configure your Bitget API credentials (including passphrase) on the Exchange Connections page first.');
                return;
            }

            try {
                const response = await fetch('/api/v1/trading/bitget/balance', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ apiKey, apiSecret, passphrase, currency: 'USDT' })
                });

                const data = await response.json();

                if (data.success) {
                    const balance = Number(data.balance) || 0;

                    if (!bitgetBalanceTracking.initialized) {
                        bitgetBalanceTracking.starting = balance;
                        bitgetBalanceTracking.initialized = true;
                    }

                    bitgetBalanceTracking.current = balance;
                    updateBitgetBalanceDisplay();
                    alert(`‚úÖ Bitget USDT Balance Updated\n\nCurrent: ${balance.toFixed(2)} USDT`);
                } else {
                    alert(`Balance fetch failed: ${data.message}`);
                }
            } catch (error) {
                console.error('Bitget balance error:', error);
                alert(`Error: ${error.message}`);
            }
        }

        function updateBitgetBalanceDisplay() {
            const starting = Number(bitgetBalanceTracking.starting) || 0;
            const current = Number(bitgetBalanceTracking.current) || 0;
            const change = current - starting;
            const changePercent = starting > 0 ? ((change / starting) * 100) : 0;

            document.getElementById('bitgetStartingUSDT').textContent = `${starting.toFixed(2)} USDT`;
            document.getElementById('bitgetCurrentUSDT').textContent = `${current.toFixed(2)} USDT`;

            const changeDisplay = document.getElementById('bitgetChangeUSDT');
            const changeSign = change >= 0 ? '+' : '';
            const changeColor = change >= 0 ? '#00d26a' : '#FF4444';

            changeDisplay.textContent = `${changeSign}${change.toFixed(2)} USDT (${changeSign}${changePercent.toFixed(2)}%)`;
            changeDisplay.style.color = changeColor;
        }

        function resetBitgetStartingBalance() {
            if (!confirm('Reset starting balance to current balance?\n\nThis will reset your P&L tracking.')) {
                return;
            }

            bitgetBalanceTracking.starting = bitgetBalanceTracking.current;
            updateBitgetBalanceDisplay();
            alert('‚úÖ Bitget starting balance reset!');
        }

        // 5. Clear Bitget History
        function clearBitgetHistory() {
            if (!confirm('Clear all Bitget opportunity history?')) {
                return;
            }

            document.getElementById('bitgetOpportunities').innerHTML = '';
            document.getElementById('bitgetScanStatus').innerHTML = '';
            window.bitgetCurrentOpportunities = [];
            alert('‚úÖ Bitget opportunity history cleared!');
        }

        // 6. Scan Bitget Triangular Paths
        async function scanBitgetTriangularPaths() {
            const apiKey = localStorage.getItem('bitget_api') || '';
            const apiSecret = localStorage.getItem('bitget_secret') || '';
            const passphrase = localStorage.getItem('bitget_passphrase') || '';
            const maxTradeAmount = parseFloat(document.getElementById('bitgetMaxTrade').value) || 1000;
            const portfolioPercent = parseFloat(document.getElementById('bitgetPortfolioPercent').value) || 10;
            const profitThreshold = parseFloat(document.getElementById('bitgetProfitThreshold').value) || 0.5;

            if (!apiKey || !apiSecret || !passphrase) {
                alert('‚ö†Ô∏è Please configure your Bitget API credentials (including passphrase) on the Exchange Connections page first.');
                return;
            }

            const scanButton = event.target;
            const originalText = scanButton.textContent;
            scanButton.textContent = '‚è≥ Scanning...';
            scanButton.disabled = true;

            const enabledSets = {};
            for (let i = 1; i <= 5; i++) {
                const checkbox = document.getElementById(`bitgetSet${i}Enabled`);
                enabledSets[`SET_${i}`] = checkbox ? checkbox.checked : false;
            }

            try {
                const response = await fetch('/api/v1/trading/bitget/triangular/scan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        apiKey,
                        apiSecret,
                        passphrase,
                        maxTradeAmount,
                        portfolioPercent,
                        profitThreshold,
                        enabledSets
                    })
                });

                const result = await response.json();

                if (result.success) {
                    displayBitgetOpportunities(result);
                } else {
                    alert(`Scan failed: ${result.message}`);
                }
            } catch (error) {
                console.error('Bitget scan error:', error);
                alert(`Error: ${error.message}`);
            } finally {
                scanButton.textContent = originalText;
                scanButton.disabled = false;
            }
        }

        function displayBitgetOpportunities(result) {
            const opportunitiesDiv = document.getElementById('bitgetOpportunities');
            const scanStatus = document.getElementById('bitgetScanStatus');

            scanStatus.innerHTML = `
                <div style="color: #8A2BE2; font-weight: 600; margin-bottom: 10px;">
                    ‚úÖ Scan Complete: ${result.scanned} paths scanned, ${result.profitableCount} profitable (>${result.profitThreshold || 0.5}%)
                </div>
            `;

            if (result.opportunities.length === 0) {
                opportunitiesDiv.innerHTML = '<div style="color: #888; padding: 20px; text-align: center;">No profitable opportunities found at this time</div>';
                return;
            }

            let html = '<div style="display: grid; gap: 12px;">';

            result.opportunities.forEach((opp, index) => {
                const profitColor = parseFloat(opp.profitPercent) > 1 ? '#00ff88' : '#8A2BE2';

                html += `
                    <div style="background: rgba(138,43,226,0.1); padding: 15px; border-radius: 10px; border-left: 4px solid ${profitColor};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div>
                                <div style="color: white; font-weight: 600; font-size: 14px; margin-bottom: 5px;">
                                    ${opp.path.join(' ‚Üí ')}
                                </div>
                                <div style="color: #b8c6db; font-size: 12px;">
                                    ${opp.description}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="color: ${profitColor}; font-weight: 700; font-size: 18px;">
                                    +${opp.profitPercent}%
                                </div>
                                <div style="color: #b8c6db; font-size: 12px;">
                                    +$${opp.profitAmount.toFixed(2)}
                                </div>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 10px; font-size: 12px;">
                            <div style="color: #888;">Initial: <span style="color: white;">$${opp.initialAmount.toFixed(2)}</span></div>
                            <div style="color: #888;">Final: <span style="color: white;">$${opp.finalAmount.toFixed(2)}</span></div>
                            <div style="color: #888;">Fees: <span style="color: white;">$${opp.totalFees.toFixed(2)}</span></div>
                            <div style="color: #888;">Time: <span style="color: white;">${new Date(opp.timestamp).toLocaleTimeString()}</span></div>
                        </div>

                        <button onclick="executeBitgetTriangularTrade('${opp.pathId}')"
                                style="width: 100%; padding: 8px; background: linear-gradient(135deg, #8A2BE2, #9370DB); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px;">
                            ‚ö° Execute Trade
                        </button>
                    </div>
                `;
            });

            html += '</div>';
            opportunitiesDiv.innerHTML = html;

            // Store opportunities for execution
            window.bitgetCurrentOpportunities = result.opportunities;
        }

        // 7. Execute Bitget Triangular Trade
        async function executeBitgetTriangularTrade(pathId) {
            const apiKey = localStorage.getItem('bitget_api') || '';
            const apiSecret = localStorage.getItem('bitget_secret') || '';
            const passphrase = localStorage.getItem('bitget_passphrase') || '';
            const maxTrade = parseFloat(document.getElementById('bitgetMaxTrade').value);

            // Enhanced real money warning
            if (!confirm(`‚ö†Ô∏è REAL MONEY TRADING ‚ö†Ô∏è\n\nExecute REAL triangular arbitrage trade?\n\nPath: ${pathId}\nAmount: ${maxTrade} USDT\n\nThis will execute REAL market orders on Bitget.\nClick OK to proceed.`)) {
                return;
            }

            try {
                const response = await fetch('/api/v1/trading/bitget/triangular/execute', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ apiKey, apiSecret, passphrase, pathId, amount: maxTrade })
                });

                const result = await response.json();

                if (result.success && result.data) {
                    const execution = result.data;

                    if (execution.status === 'COMPLETED') {
                        const profit = execution.actualProfit || 0;
                        const profitPct = execution.actualProfitPercentage || 0;

                        alert(`‚úÖ Trade Executed Successfully!\n\nExecution ID: ${execution.executionId}\nProfit: $${profit.toFixed(2)} (${profitPct.toFixed(3)}%)\nLegs Completed: ${execution.legs?.length || 0}/3\nTotal Time: ${execution.totalExecutionTime}ms\n\nAll legs executed atomically with slippage monitoring.`);

                        // üìä Log to backend using shared service
                        logTriangularTrade('Bitget', pathId, profit, maxTrade, execution.totalFees || 0).catch(e => console.warn('Logging failed:', e));

                        // Refresh opportunities and balance
                        scanBitgetTriangularPaths();
                        initializeBitgetBalance();
                    } else {
                        alert(`‚ùå Trade Failed!\n\nStatus: ${execution.status}\nError: ${execution.error || 'Unknown error'}\nCompleted Legs: ${execution.legs?.filter(l => l.status === 'COMPLETED').length || 0}/3`);
                    }
                } else {
                    alert(`‚ùå Trade execution failed:\n\n${result.message || 'Unknown error'}`);
                }
            } catch (error) {
                alert(`‚ùå Trade execution error:\n\n${error.message}`);
            }
        }

        // Start Bitget Worker (Sequential Scanning)
        async function startBitgetWorker() {
            // Validate credentials
            const apiKey = localStorage.getItem('bitget_api');
            const apiSecret = localStorage.getItem('bitget_secret');
            const passphrase = localStorage.getItem('bitget_passphrase');

            if (!apiKey || !apiSecret || !passphrase) {
                alert('‚ö†Ô∏è Please configure Bitget API credentials first (including passphrase)!');
                document.getElementById('bitgetTriangularEnabled').classList.remove('active');
                document.getElementById('bitgetTriangularStatus').textContent = 'OFF';
                document.getElementById('bitgetTriangularStatus').style.color = '#ff6b6b';
                return;
            }

            // Check if at least one set is selected
            const set1Enabled = document.getElementById('bitgetSet1Enabled').checked;
            const set2Enabled = document.getElementById('bitgetSet2Enabled').checked;
            const set3Enabled = document.getElementById('bitgetSet3Enabled').checked;
            const set4Enabled = document.getElementById('bitgetSet4Enabled').checked;
            const set5Enabled = document.getElementById('bitgetSet5Enabled').checked;

            if (!set1Enabled && !set2Enabled && !set3Enabled && !set4Enabled && !set5Enabled) {
                alert('‚ö†Ô∏è Please enable at least one path set!');
                document.getElementById('bitgetTriangularEnabled').classList.remove('active');
                document.getElementById('bitgetTriangularStatus').textContent = 'OFF';
                document.getElementById('bitgetTriangularStatus').style.color = '#ff6b6b';
                return;
            }

            const portfolioPercent = parseFloat(document.getElementById('bitgetPortfolioPercent').value) || 5;
            const maxTradeAmount = parseFloat(document.getElementById('bitgetMaxTrade').value) || 100;
            const profitThreshold = parseFloat(document.getElementById('bitgetProfitThreshold').value) || 0.3;

            // Build selected sets array
            const selectedSets = [];
            if (set1Enabled) selectedSets.push('SET_1_ESSENTIAL_ETH_BRIDGE');
            if (set2Enabled) selectedSets.push('SET_2_MIDCAP_BTC_BRIDGE');
            if (set3Enabled) selectedSets.push('SET_3_BGB_NATIVE_TOKEN');
            if (set4Enabled) selectedSets.push('SET_4_HIGH_VOLATILITY');
            if (set5Enabled) selectedSets.push('SET_5_EXTENDED_MULTIBRIDGE');

            console.log(`üíú [BITGET] Worker started - scanning ${selectedSets.length} sets sequentially`);
            console.log(`üíú [BITGET] Portfolio: ${portfolioPercent}%, Max Trade: $${maxTradeAmount}, Threshold: ${profitThreshold}%`);

            let currentSetIndex = 0;

            // Sequential scan function
            async function scanAndExecuteSequential() {
                try {
                    bitgetWorkerStats.totalScans++;
                    bitgetWorkerStats.lastScanTime = new Date().toISOString();

                    const currentSet = selectedSets[currentSetIndex];
                    console.log(`üíú [BITGET] Scanning set ${currentSetIndex + 1}/${selectedSets.length}: ${currentSet}`);

                    // Scan current set only
                    const response = await fetch('/api/v1/trading/bitget/triangular/scan', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            apiKey,
                            apiSecret,
                            passphrase,
                            selectedSets: [currentSet],
                            portfolioPercent,
                            maxTradeAmount
                        })
                    });

                    const data = await response.json();

                    if (data.success && data.opportunities && data.opportunities.length > 0) {
                        bitgetWorkerStats.totalOpportunities += data.opportunities.length;

                        // Log opportunities above threshold
                        data.opportunities.forEach(opp => {
                            if (opp.profitPercentage >= profitThreshold) {
                                console.log(`üíú [BITGET] Opportunity found: ${opp.pathId} - ${opp.profitPercentage.toFixed(3)}% profit`);

                                // Track best profit
                                if (opp.profitPercentage > bitgetWorkerStats.bestProfit) {
                                    bitgetWorkerStats.bestProfit = opp.profitPercentage;
                                    bitgetWorkerStats.bestPath = opp.pathId;
                                }
                            }
                        });
                    }

                    // Move to next set (circular)
                    currentSetIndex = (currentSetIndex + 1) % selectedSets.length;

                    // Update balance after completing full cycle
                    if (currentSetIndex === 0) {
                        console.log(`üíú [BITGET] Completed full cycle - updating balance...`);
                        initializeBitgetBalance();
                    }

                } catch (error) {
                    console.error(`üíú [BITGET] Worker scan error:`, error);
                }
            }

            // Start sequential interval (8 seconds between scans)
            scanAndExecuteSequential(); // Run immediately
            bitgetWorkerInterval = setInterval(scanAndExecuteSequential, 8000);

            console.log(`üíú [BITGET] Worker active - scanning every 8 seconds`);
        }

        // Stop Bitget Worker
        function stopBitgetWorker() {
            if (bitgetWorkerInterval) {
                clearInterval(bitgetWorkerInterval);
                bitgetWorkerInterval = null;

                console.log(`üíú [BITGET] Worker stopped`);
                console.log(`üíú [BITGET] Stats:`, {
                    totalScans: bitgetWorkerStats.totalScans,
                    totalOpportunities: bitgetWorkerStats.totalOpportunities,
                    bestProfit: bitgetWorkerStats.bestProfit?.toFixed(3) + '%',
                    bestPath: bitgetWorkerStats.bestPath
                });
            }
        }

        // 8. Load Bitget Trade History
        async function loadBitgetTradeHistory() {
            try {
                const userId = localStorage.getItem('userId');
                if (!userId) return;

                const response = await fetch('/api/v1/trading/bitget/triangular/history', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({ userId, limit: 10 })
                });

                const result = await response.json();

                if (result.success && result.trades.length > 0) {
                    let historyHtml = '<div style="display: grid; gap: 10px;">';

                    result.trades.forEach(trade => {
                        const statusColor = trade.execution_status === 'completed' ? '#8A2BE2' : '#FF4444';
                        const profitColor = parseFloat(trade.actual_profit_zar || 0) > 0 ? '#00ff88' : '#FF4444';

                        historyHtml += `
                            <div style="background: rgba(255,255,255,0.03); padding: 12px; border-radius: 8px; border-left: 3px solid ${statusColor};">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span style="color: white; font-weight: 600; font-size: 13px;">${trade.path_sequence}</span>
                                    <span style="color: ${profitColor}; font-weight: 600;">${trade.actual_profit_zar ? '+' + trade.actual_profit_zar : '‚Äî'} USDT</span>
                                </div>
                                <div style="color: #888; font-size: 12px;">${new Date(trade.created_at).toLocaleString()}</div>
                            </div>
                        `;
                    });

                    historyHtml += '</div>';
                    document.getElementById('bitgetTradeHistory').innerHTML = historyHtml;
                }
            } catch (error) {
                console.error('Bitget history error:', error);
            }
        }

        // 9. Settings Management
        function saveBitgetTriangularSettings() {
            const maxTrade = document.getElementById('bitgetMaxTrade').value;
            const portfolioPercent = document.getElementById('bitgetPortfolioPercent').value;
            const profitThreshold = document.getElementById('bitgetProfitThreshold').value;

            localStorage.setItem('bitget_triangular_maxTrade', maxTrade);
            localStorage.setItem('bitget_triangular_portfolioPercent', portfolioPercent);
            localStorage.setItem('bitget_triangular_profitThreshold', profitThreshold);

            for (let i = 1; i <= 5; i++) {
                const checkbox = document.getElementById(`bitgetSet${i}Enabled`);
                if (checkbox) {
                    localStorage.setItem(`bitget_triangular_set${i}`, checkbox.checked);
                }
            }
        }

        function loadBitgetTriangularSettings() {
            document.getElementById('bitgetMaxTrade').value = localStorage.getItem('bitget_triangular_maxTrade') || '1000';
            document.getElementById('bitgetPortfolioPercent').value = localStorage.getItem('bitget_triangular_portfolioPercent') || '10';
            document.getElementById('bitgetProfitThreshold').value = localStorage.getItem('bitget_triangular_profitThreshold') || '0.5';

            for (let i = 1; i <= 5; i++) {
                const checkbox = document.getElementById(`bitgetSet${i}Enabled`);
                if (checkbox) {
                    const saved = localStorage.getItem(`bitget_triangular_set${i}`);
                    checkbox.checked = saved === 'true' || (saved === null && i <= 2);
                }
            }
        }

        // 10. Initialize Bitget on DOMContentLoaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üíú [BITGET] Initializing triangular arbitrage...');
            loadBitgetTriangularSettings();
            initializeBitgetBalance();
            switchBitgetTab('balance');
        });

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // BITMART TRIANGULAR ARBITRAGE FUNCTIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        // 1. Toggle BitMart Triangular
        // Worker Variables
        let bitmartWorkerInterval = null;
        let bitmartWorkerStats = {
            totalScans: 0,
            totalOpportunities: 0,
            totalTrades: 0,
            successfulTrades: 0,
            totalProfit: 0,
            bestProfit: 0,
            bestPath: null,
            lastScanTime: null
        };

        function toggleBitmartTriangular() {
            const toggle = document.getElementById('bitmartTriangularEnabled');
            const status = document.getElementById('bitmartTriangularStatus');
            const isActive = toggle.classList.toggle('active');

            if (isActive) {
                status.textContent = 'ON';
                status.style.color = '#FF8C00';
                localStorage.setItem('bitmartTriangularEnabled', 'true');
                console.log('üß° [BITMART] Triangular arbitrage enabled - starting worker...');
                startBitmartWorker();
            } else {
                status.textContent = 'OFF';
                status.style.color = '#ff6b6b';
                localStorage.setItem('bitmartTriangularEnabled', 'false');
                console.log('üß° [BITMART] Triangular arbitrage disabled - stopping worker...');
                stopBitmartWorker();
            }
        }

        // 2. View BitMart Path Details (Professional Modal)
        function viewBitmartPathDetails() {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: flex; justify-content: center; align-items: center; z-index: 10000; backdrop-filter: blur(8px);';

            modal.innerHTML = `
                <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); padding: 30px; border-radius: 20px; max-width: 800px; max-height: 85vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(255,140,0,0.4); border: 2px solid rgba(255,140,0,0.3);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid rgba(255,140,0,0.3); padding-bottom: 15px;">
                        <h2 style="color: #FF8C00; margin: 0; font-size: 24px; display: flex; align-items: center; gap: 10px;">
                            üß° BitMart Triangular Arbitrage Paths
                        </h2>
                        <button onclick="this.closest('div[style*=fixed]').remove()" style="background: rgba(255,107,107,0.2); color: #ff6b6b; border: 1px solid #ff6b6b; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s;">‚úï Close</button>
                    </div>

                    <div style="display: grid; gap: 20px;">
                        <!-- SET 1 -->
                        <div style="background: rgba(0,210,106,0.1); padding: 18px; border-radius: 12px; border-left: 5px solid #00d26a;">
                            <h3 style="color: #00d26a; margin: 0 0 12px 0; font-size: 16px; font-weight: 700;">SET 1: ESSENTIAL ETH BRIDGE (7 paths)</h3>
                            <div style="color: #b8c6db; font-size: 13px; line-height: 1.8; font-family: 'Courier New', monospace;">
                                1. USDT ‚Üí ETH ‚Üí BTC ‚Üí USDT<br>
                                2. USDT ‚Üí ETH ‚Üí SOL ‚Üí USDT<br>
                                3. USDT ‚Üí ETH ‚Üí XRP ‚Üí USDT<br>
                                4. USDT ‚Üí ETH ‚Üí ADA ‚Üí USDT<br>
                                5. USDT ‚Üí ETH ‚Üí DOT ‚Üí USDT<br>
                                6. USDT ‚Üí ETH ‚Üí MATIC ‚Üí USDT<br>
                                7. USDT ‚Üí ETH ‚Üí LINK ‚Üí USDT
                            </div>
                            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(0,210,106,0.2); color: #00d26a; font-weight: 600; font-size: 13px;">
                                üí∞ Funding: $350-700 USDT
                            </div>
                        </div>

                        <!-- SET 2 -->
                        <div style="background: rgba(0,210,106,0.1); padding: 18px; border-radius: 12px; border-left: 5px solid #00d26a;">
                            <h3 style="color: #00d26a; margin: 0 0 12px 0; font-size: 16px; font-weight: 700;">SET 2: MID-CAP BTC BRIDGE (7 paths)</h3>
                            <div style="color: #b8c6db; font-size: 13px; line-height: 1.8; font-family: 'Courier New', monospace;">
                                1. USDT ‚Üí BTC ‚Üí ETH ‚Üí USDT<br>
                                2. USDT ‚Üí BTC ‚Üí SOL ‚Üí USDT<br>
                                3. USDT ‚Üí BTC ‚Üí XRP ‚Üí USDT<br>
                                4. USDT ‚Üí BTC ‚Üí AVAX ‚Üí USDT<br>
                                5. USDT ‚Üí BTC ‚Üí MATIC ‚Üí USDT<br>
                                6. USDT ‚Üí BTC ‚Üí DOT ‚Üí USDT<br>
                                7. USDT ‚Üí BTC ‚Üí LTC ‚Üí USDT
                            </div>
                            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(0,210,106,0.2); color: #00d26a; font-weight: 600; font-size: 13px;">
                                üí∞ Funding: $350-700 USDT
                            </div>
                        </div>

                        <!-- SET 3 - BMX NATIVE TOKEN -->
                        <div style="background: rgba(255,140,0,0.15); padding: 18px; border-radius: 12px; border-left: 5px solid #FF8C00;">
                            <h3 style="color: #FF8C00; margin: 0 0 12px 0; font-size: 16px; font-weight: 700;">SET 3: BMX NATIVE TOKEN (6 paths) üß°</h3>
                            <div style="color: #b8c6db; font-size: 13px; line-height: 1.8; font-family: 'Courier New', monospace;">
                                1. USDT ‚Üí BMX ‚Üí BTC ‚Üí USDT<br>
                                2. USDT ‚Üí BMX ‚Üí ETH ‚Üí USDT<br>
                                3. USDT ‚Üí BMX ‚Üí SOL ‚Üí USDT<br>
                                4. USDT ‚Üí BMX ‚Üí XRP ‚Üí USDT<br>
                                5. USDT ‚Üí BMX ‚Üí ADA ‚Üí USDT<br>
                                6. USDT ‚Üí BMX ‚Üí DOT ‚Üí USDT
                            </div>
                            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,140,0,0.3); color: #FF8C00; font-weight: 600; font-size: 13px;">
                                üí∞ Funding: $300-600 USDT | BMX is BitMart's exchange token - 0.1% fees (vs 0.25% standard)!
                            </div>
                        </div>

                        <!-- SET 4 -->
                        <div style="background: rgba(255,165,0,0.1); padding: 18px; border-radius: 12px; border-left: 5px solid #FFA500;">
                            <h3 style="color: #FFA500; margin: 0 0 12px 0; font-size: 16px; font-weight: 700;">SET 4: HIGH VOLATILITY (6 paths)</h3>
                            <div style="color: #b8c6db; font-size: 13px; line-height: 1.8; font-family: 'Courier New', monospace;">
                                1. USDT ‚Üí DOGE ‚Üí BTC ‚Üí USDT<br>
                                2. USDT ‚Üí DOGE ‚Üí ETH ‚Üí USDT<br>
                                3. USDT ‚Üí SHIB ‚Üí BTC ‚Üí USDT<br>
                                4. USDT ‚Üí SHIB ‚Üí ETH ‚Üí USDT<br>
                                5. USDT ‚Üí ALGO ‚Üí BTC ‚Üí USDT<br>
                                6. USDT ‚Üí ALGO ‚Üí ETH ‚Üí USDT
                            </div>
                            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,165,0,0.2); color: #FFA500; font-weight: 600; font-size: 13px;">
                                üí∞ Funding: $300-600 USDT
                            </div>
                        </div>

                        <!-- SET 5 -->
                        <div style="background: rgba(255,68,68,0.1); padding: 18px; border-radius: 12px; border-left: 5px solid #FF4444;">
                            <h3 style="color: #FF4444; margin: 0 0 12px 0; font-size: 16px; font-weight: 700;">SET 5: EXTENDED MULTI-BRIDGE (6 paths) üî•</h3>
                            <div style="color: #b8c6db; font-size: 13px; line-height: 1.8; font-family: 'Courier New', monospace;">
                                1. USDT ‚Üí TRX ‚Üí BTC ‚Üí USDT<br>
                                2. USDT ‚Üí TRX ‚Üí ETH ‚Üí USDT<br>
                                3. USDT ‚Üí VET ‚Üí BTC ‚Üí USDT<br>
                                4. USDT ‚Üí VET ‚Üí ETH ‚Üí USDT<br>
                                5. USDT ‚Üí BTC ‚Üí ETH ‚Üí SOL ‚Üí USDT (4-leg)<br>
                                6. USDT ‚Üí ETH ‚Üí BTC ‚Üí XRP ‚Üí USDT (4-leg)
                            </div>
                            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,68,68,0.2); color: #FF4444; font-weight: 600; font-size: 13px;">
                                üí∞ Funding: $300-600 USDT | Includes 2 four-leg paths
                            </div>
                        </div>

                        <!-- Total Funding -->
                        <div style="background: rgba(255,140,0,0.15); padding: 20px; border-radius: 12px; border: 2px solid #FF8C00; text-align: center;">
                            <div style="color: #FF8C00; font-size: 20px; font-weight: 700; margin-bottom: 10px;">
                                üí∞ TOTAL RECOMMENDED FUNDING
                            </div>
                            <div style="color: white; font-size: 28px; font-weight: 700; margin-bottom: 10px;">
                                $1,600 - $3,200 USDT
                            </div>
                            <div style="color: #b8c6db; font-size: 14px;">
                                (All 5 sets enabled)
                            </div>
                        </div>

                        <!-- Portfolio % Info -->
                        <div style="background: rgba(0,0,0,0.3); padding: 18px; border-radius: 12px; border: 1px solid rgba(255,140,0,0.3);">
                            <h4 style="color: #FF8C00; margin: 0 0 12px 0; font-size: 15px;">‚öñÔ∏è PORTFOLIO % MODE</h4>
                            <p style="color: #b8c6db; margin: 0; font-size: 13px; line-height: 1.6;">
                                Trade amount = <strong style="color: white;">MIN(portfolioPercent √ó balance, maxTradeAmount)</strong><br>
                                Default: 10% of USDT balance, capped at $1,000<br>
                                <strong style="color: #FF8C00;">Note:</strong> Memo required for BitMart API authentication (HMAC-SHA256)
                            </p>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Close on outside click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }

        // 3. Switch BitMart Tab
        function switchBitmartTab(tab) {
            const balanceBtn = document.getElementById('bitmartBalanceTab');
            const tradingBtn = document.getElementById('bitmartTradingTab');
            const balanceContent = document.getElementById('bitmartBalanceContent');
            const tradingContent = document.getElementById('bitmartTradingContent');

            if (tab === 'balance') {
                balanceBtn.style.background = 'linear-gradient(135deg, #FF8C00, #FFA500)';
                balanceBtn.style.color = 'white';
                tradingBtn.style.background = 'rgba(0,0,0,0.3)';
                tradingBtn.style.color = '#888';
                balanceContent.style.display = 'block';
                tradingContent.style.display = 'none';
            } else {
                tradingBtn.style.background = 'linear-gradient(135deg, #FF8C00, #FFA500)';
                tradingBtn.style.color = 'white';
                balanceBtn.style.background = 'rgba(0,0,0,0.3)';
                balanceBtn.style.color = '#888';
                tradingContent.style.display = 'block';
                balanceContent.style.display = 'none';
            }
        }

        // 4. Balance Tracking with NaN Prevention
        const bitmartBalanceTracking = {
            starting: 0,
            current: 0,
            initialized: false
        };

        async function initializeBitmartBalance() {
            const apiKey = localStorage.getItem('bitmart_api') || '';
            const apiSecret = localStorage.getItem('bitmart_secret') || '';
            const memo = localStorage.getItem('bitmart_memo') || '';

            if (!apiKey || !apiSecret || !memo) {
                console.log('üß° [BITMART] No API credentials - skipping auto-fetch');
                return;
            }

            try {
                const response = await fetch('/api/v1/trading/bitmart/balance', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ apiKey, apiSecret, memo, currency: 'USDT' })
                });

                const data = await response.json();

                if (data.success) {
                    const balance = Number(data.balance) || 0;

                    if (!bitmartBalanceTracking.initialized) {
                        bitmartBalanceTracking.starting = balance;
                        bitmartBalanceTracking.current = balance;
                        bitmartBalanceTracking.initialized = true;
                        console.log(`üß° [BITMART] Balance initialized: ${balance} USDT`);
                    } else {
                        bitmartBalanceTracking.current = balance;
                    }

                    updateBitmartBalanceDisplay();
                }
            } catch (error) {
                console.error('üß° [BITMART] Auto-fetch failed:', error);
            }
        }

        async function updateBitmartBalance() {
            const apiKey = localStorage.getItem('bitmart_api') || '';
            const apiSecret = localStorage.getItem('bitmart_secret') || '';
            const memo = localStorage.getItem('bitmart_memo') || '';

            if (!apiKey || !apiSecret || !memo) {
                alert('‚ö†Ô∏è Please configure your BitMart API credentials (including memo) on the Exchange Connections page first.');
                return;
            }

            try {
                const response = await fetch('/api/v1/trading/bitmart/balance', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ apiKey, apiSecret, memo, currency: 'USDT' })
                });

                const data = await response.json();

                if (data.success) {
                    const balance = Number(data.balance) || 0;

                    if (!bitmartBalanceTracking.initialized) {
                        bitmartBalanceTracking.starting = balance;
                        bitmartBalanceTracking.initialized = true;
                    }

                    bitmartBalanceTracking.current = balance;
                    updateBitmartBalanceDisplay();
                    alert(`‚úÖ BitMart USDT Balance Updated\n\nCurrent: ${balance.toFixed(2)} USDT`);
                } else {
                    alert(`Balance fetch failed: ${data.message}`);
                }
            } catch (error) {
                console.error('BitMart balance error:', error);
                alert(`Error: ${error.message}`);
            }
        }

        function updateBitmartBalanceDisplay() {
            const starting = Number(bitmartBalanceTracking.starting) || 0;
            const current = Number(bitmartBalanceTracking.current) || 0;
            const change = current - starting;
            const changePercent = starting > 0 ? ((change / starting) * 100) : 0;

            document.getElementById('bitmartStartingUSDT').textContent = `${starting.toFixed(2)} USDT`;
            document.getElementById('bitmartCurrentUSDT').textContent = `${current.toFixed(2)} USDT`;

            const changeDisplay = document.getElementById('bitmartChangeUSDT');
            const changeSign = change >= 0 ? '+' : '';
            const changeColor = change >= 0 ? '#00d26a' : '#FF4444';

            changeDisplay.textContent = `${changeSign}${change.toFixed(2)} USDT (${changeSign}${changePercent.toFixed(2)}%)`;
            changeDisplay.style.color = changeColor;
        }

        function resetBitmartStartingBalance() {
            if (!confirm('Reset starting balance to current balance?\n\nThis will reset your P&L tracking.')) {
                return;
            }

            bitmartBalanceTracking.starting = bitmartBalanceTracking.current;
            updateBitmartBalanceDisplay();
            alert('‚úÖ BitMart starting balance reset!');
        }

        // 5. Clear BitMart History
        function clearBitmartHistory() {
            if (!confirm('Clear all BitMart opportunity history?')) {
                return;
            }

            document.getElementById('bitmartOpportunities').innerHTML = '';
            document.getElementById('bitmartScanStatus').innerHTML = '';
            window.bitmartCurrentOpportunities = [];
            alert('‚úÖ BitMart opportunity history cleared!');
        }

        // 6. Scan BitMart Triangular Paths
        async function scanBitmartTriangularPaths() {
            const apiKey = localStorage.getItem('bitmart_api') || '';
            const apiSecret = localStorage.getItem('bitmart_secret') || '';
            const memo = localStorage.getItem('bitmart_memo') || '';
            const maxTradeAmount = parseFloat(document.getElementById('bitmartMaxTrade').value) || 1000;
            const portfolioPercent = parseFloat(document.getElementById('bitmartPortfolioPercent').value) || 10;
            const profitThreshold = parseFloat(document.getElementById('bitmartProfitThreshold').value) || 0.5;

            if (!apiKey || !apiSecret || !memo) {
                alert('‚ö†Ô∏è Please configure your BitMart API credentials (including memo) on the Exchange Connections page first.');
                return;
            }

            const scanButton = event.target;
            const originalText = scanButton.textContent;
            scanButton.textContent = '‚è≥ Scanning...';
            scanButton.disabled = true;

            const enabledSets = {};
            for (let i = 1; i <= 5; i++) {
                const checkbox = document.getElementById(`bitmartSet${i}Enabled`);
                enabledSets[`SET_${i}`] = checkbox ? checkbox.checked : false;
            }

            try {
                const response = await fetch('/api/v1/trading/bitmart/triangular/scan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        apiKey,
                        apiSecret,
                        memo,
                        maxTradeAmount,
                        portfolioPercent,
                        profitThreshold,
                        enabledSets
                    })
                });

                const result = await response.json();

                if (result.success) {
                    displayBitmartOpportunities(result);
                } else {
                    alert(`Scan failed: ${result.message}`);
                }
            } catch (error) {
                console.error('BitMart scan error:', error);
                alert(`Error: ${error.message}`);
            } finally {
                scanButton.textContent = originalText;
                scanButton.disabled = false;
            }
        }

        function displayBitmartOpportunities(result) {
            const opportunitiesDiv = document.getElementById('bitmartOpportunities');
            const scanStatus = document.getElementById('bitmartScanStatus');

            scanStatus.innerHTML = `
                <div style="color: #FF8C00; font-weight: 600; margin-bottom: 10px;">
                    ‚úÖ Scan Complete: ${result.scanned} paths scanned, ${result.profitableCount} profitable (>${result.profitThreshold || 0.5}%)
                </div>
            `;

            if (result.opportunities.length === 0) {
                opportunitiesDiv.innerHTML = '<div style="color: #888; padding: 20px; text-align: center;">No profitable opportunities found at this time</div>';
                return;
            }

            let html = '<div style="display: grid; gap: 12px;">';

            result.opportunities.forEach((opp, index) => {
                const profitColor = parseFloat(opp.profitPercent || 0) >= 1 ? '#00ff88' : (parseFloat(opp.profitPercent || 0) >= 0.5 ? '#FFA500' : '#888');

                html += `
                    <div style="background: rgba(255,140,0,0.1); padding: 15px; border-radius: 12px; border-left: 4px solid #FF8C00;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <div style="flex: 1;">
                                <div style="color: #FF8C00; font-weight: 700; font-size: 14px; margin-bottom: 5px;">${opp.pathId || 'Unknown Path'}</div>
                                <div style="color: #ddd; font-size: 13px; margin-bottom: 3px;">${opp.description || opp.sequence || ''}</div>
                                <div style="color: #888; font-size: 12px;">${(opp.path || []).join(' ‚Üí ')}</div>
                            </div>
                            <div style="text-align: right; margin-left: 15px;">
                                <div style="color: ${profitColor}; font-size: 20px; font-weight: 700;">${parseFloat(opp.profitPercent || 0).toFixed(3)}%</div>
                                <div style="color: #888; font-size: 11px;">+$${parseFloat(opp.profitAmount || 0).toFixed(2)}</div>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,140,0,0.2); font-size: 11px;">
                            <div style="color: #888;">Start: <span style="color: white;">$${parseFloat(opp.initialAmount || 0).toFixed(2)}</span></div>
                            <div style="color: #888;">End: <span style="color: #00ff88;">$${parseFloat(opp.finalAmount || 0).toFixed(2)}</span></div>
                        </div>
                        <button onclick="executeBitmartTriangularTrade(window.bitmartCurrentOpportunities[${index}])"
                                style="width: 100%; margin-top: 10px; padding: 10px; background: linear-gradient(135deg, #FF8C00, #FFA500); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s;">
                            üß° Execute Trade
                        </button>
                    </div>
                `;
            });

            html += '</div>';
            opportunitiesDiv.innerHTML = html;

            // Store opportunities globally for execution
            window.bitmartCurrentOpportunities = result.opportunities;
        }

        // 7. Execute BitMart Triangular Trade
        async function executeBitmartTriangularTrade(opportunity) {
            const apiKey = localStorage.getItem('bitmart_api') || '';
            const apiSecret = localStorage.getItem('bitmart_secret') || '';
            const maxTrade = parseFloat(document.getElementById('bitmartMaxTrade').value);

            // Enhanced real money warning
            if (!confirm(`‚ö†Ô∏è REAL MONEY TRADING ‚ö†Ô∏è\n\nExecute REAL triangular arbitrage trade?\n\nPath: ${opportunity.path.join(' ‚Üí ')}\nAmount: ${maxTrade} USDT\n\nThis will execute REAL market orders on BitMart.\nClick OK to proceed.`)) {
                return;
            }

            try {
                const response = await fetch('/api/v1/trading/bitmart/triangular/execute', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        apiKey,
                        apiSecret,
                        pathId: opportunity.pathId,
                        amount: maxTrade
                    })
                });

                const result = await response.json();

                if (result.success && result.data) {
                    const execution = result.data;

                    if (execution.status === 'COMPLETED') {
                        const profit = execution.actualProfit || 0;
                        const profitPct = execution.actualProfitPercentage || 0;

                        alert(`‚úÖ Trade Executed Successfully!\n\nExecution ID: ${execution.executionId}\nProfit: $${profit.toFixed(2)} (${profitPct.toFixed(3)}%)\nLegs Completed: ${execution.legs?.length || 0}/3\nTotal Time: ${execution.totalExecutionTime}ms\n\nAll legs executed atomically with slippage monitoring.`);

                        // üìä Log to backend using shared service
                        logTriangularTrade('BitMart', pathId, profit, maxTrade, execution.totalFees || 0).catch(e => console.warn('Logging failed:', e));

                        // Refresh opportunities and balance
                        scanBitmartTriangularPaths();
                        initializeBitmartBalance();
                    } else {
                        alert(`‚ùå Trade Failed!\n\nStatus: ${execution.status}\nError: ${execution.error || 'Unknown error'}\nCompleted Legs: ${execution.legs?.filter(l => l.status === 'COMPLETED').length || 0}/3`);
                    }
                } else {
                    alert(`‚ùå Trade execution failed:\n\n${result.message || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('BitMart execution error:', error);
                alert(`‚ùå Trade execution error:\n\n${error.message}`);
            }
        }

        // Start BitMart Worker (Sequential Scanning)
        async function startBitmartWorker() {
            // Validate credentials
            const apiKey = localStorage.getItem('bitmart_api');
            const apiSecret = localStorage.getItem('bitmart_secret');

            if (!apiKey || !apiSecret) {
                alert('‚ö†Ô∏è Please configure BitMart API credentials first!');
                document.getElementById('bitmartTriangularEnabled').classList.remove('active');
                document.getElementById('bitmartTriangularStatus').textContent = 'OFF';
                document.getElementById('bitmartTriangularStatus').style.color = '#ff6b6b';
                return;
            }

            // Check if at least one set is selected
            const set1Enabled = document.getElementById('bitmartSet1Enabled').checked;
            const set2Enabled = document.getElementById('bitmartSet2Enabled').checked;
            const set3Enabled = document.getElementById('bitmartSet3Enabled').checked;
            const set4Enabled = document.getElementById('bitmartSet4Enabled').checked;
            const set5Enabled = document.getElementById('bitmartSet5Enabled').checked;

            if (!set1Enabled && !set2Enabled && !set3Enabled && !set4Enabled && !set5Enabled) {
                alert('‚ö†Ô∏è Please enable at least one path set!');
                document.getElementById('bitmartTriangularEnabled').classList.remove('active');
                document.getElementById('bitmartTriangularStatus').textContent = 'OFF';
                document.getElementById('bitmartTriangularStatus').style.color = '#ff6b6b';
                return;
            }

            const portfolioPercent = parseFloat(document.getElementById('bitmartPortfolioPercent').value) || 5;
            const maxTradeAmount = parseFloat(document.getElementById('bitmartMaxTrade').value) || 100;
            const profitThreshold = parseFloat(document.getElementById('bitmartProfitThreshold').value) || 0.3;

            // Build selected sets array
            const selectedSets = [];
            if (set1Enabled) selectedSets.push('SET_1_ESSENTIAL_ETH_BRIDGE');
            if (set2Enabled) selectedSets.push('SET_2_MIDCAP_BTC_BRIDGE');
            if (set3Enabled) selectedSets.push('SET_3_BMX_NATIVE_TOKEN');
            if (set4Enabled) selectedSets.push('SET_4_HIGH_VOLATILITY');
            if (set5Enabled) selectedSets.push('SET_5_EXTENDED_MULTIBRIDGE');

            console.log(`üß° [BITMART] Worker started - scanning ${selectedSets.length} sets sequentially`);
            console.log(`üß° [BITMART] Portfolio: ${portfolioPercent}%, Max Trade: $${maxTradeAmount}, Threshold: ${profitThreshold}%`);

            let currentSetIndex = 0;

            // Sequential scan function
            async function scanAndExecuteSequential() {
                try {
                    bitmartWorkerStats.totalScans++;
                    bitmartWorkerStats.lastScanTime = new Date().toISOString();

                    const currentSet = selectedSets[currentSetIndex];
                    console.log(`üß° [BITMART] Scanning set ${currentSetIndex + 1}/${selectedSets.length}: ${currentSet}`);

                    // Scan current set only
                    const response = await fetch('/api/v1/trading/bitmart/triangular/scan', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            apiKey,
                            apiSecret,
                            selectedSets: [currentSet],
                            portfolioPercent,
                            maxTradeAmount
                        })
                    });

                    const data = await response.json();

                    if (data.success && data.opportunities && data.opportunities.length > 0) {
                        bitmartWorkerStats.totalOpportunities += data.opportunities.length;

                        // Log opportunities above threshold
                        data.opportunities.forEach(opp => {
                            if (opp.profitPercentage >= profitThreshold) {
                                console.log(`üß° [BITMART] Opportunity found: ${opp.pathId} - ${opp.profitPercentage.toFixed(3)}% profit`);

                                // Track best profit
                                if (opp.profitPercentage > bitmartWorkerStats.bestProfit) {
                                    bitmartWorkerStats.bestProfit = opp.profitPercentage;
                                    bitmartWorkerStats.bestPath = opp.pathId;
                                }
                            }
                        });
                    }

                    // Move to next set (circular)
                    currentSetIndex = (currentSetIndex + 1) % selectedSets.length;

                    // Update balance after completing full cycle
                    if (currentSetIndex === 0) {
                        console.log(`üß° [BITMART] Completed full cycle - updating balance...`);
                        initializeBitmartBalance();
                    }

                } catch (error) {
                    console.error(`üß° [BITMART] Worker scan error:`, error);
                }
            }

            // Start sequential interval (8 seconds between scans)
            scanAndExecuteSequential(); // Run immediately
            bitmartWorkerInterval = setInterval(scanAndExecuteSequential, 8000);

            console.log(`üß° [BITMART] Worker active - scanning every 8 seconds`);
        }

        // Stop BitMart Worker
        function stopBitmartWorker() {
            if (bitmartWorkerInterval) {
                clearInterval(bitmartWorkerInterval);
                bitmartWorkerInterval = null;

                console.log(`üß° [BITMART] Worker stopped`);
                console.log(`üß° [BITMART] Stats:`, {
                    totalScans: bitmartWorkerStats.totalScans,
                    totalOpportunities: bitmartWorkerStats.totalOpportunities,
                    bestProfit: bitmartWorkerStats.bestProfit?.toFixed(3) + '%',
                    bestPath: bitmartWorkerStats.bestPath
                });
            }
        }

        // 8. Load BitMart Trade History
        async function loadBitmartTradeHistory() {
            try {
                const userId = localStorage.getItem('userId');
                if (!userId) return;

                const response = await fetch('/api/v1/trading/bitmart/triangular/history', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({ userId, limit: 10 })
                });

                const result = await response.json();

                if (result.success && result.trades.length > 0) {
                    let historyHtml = '<div style="display: grid; gap: 10px;">';

                    result.trades.forEach(trade => {
                        const statusColor = trade.execution_status === 'completed' ? '#FF8C00' : '#FF4444';
                        const profitColor = parseFloat(trade.actual_profit_zar || 0) > 0 ? '#00ff88' : '#FF4444';

                        historyHtml += `
                            <div style="background: rgba(255,255,255,0.03); padding: 12px; border-radius: 8px; border-left: 3px solid ${statusColor};">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span style="color: white; font-weight: 600; font-size: 13px;">${trade.path_sequence}</span>
                                    <span style="color: ${profitColor}; font-weight: 600;">${trade.actual_profit_zar ? '+' + trade.actual_profit_zar : '‚Äî'} USDT</span>
                                </div>
                                <div style="color: #888; font-size: 12px;">${new Date(trade.created_at).toLocaleString()}</div>
                            </div>
                        `;
                    });

                    historyHtml += '</div>';
                    document.getElementById('bitmartTradeHistory').innerHTML = historyHtml;
                }
            } catch (error) {
                console.error('BitMart history error:', error);
            }
        }

        // 9. Settings Management
        function saveBitmartTriangularSettings() {
            const maxTrade = document.getElementById('bitmartMaxTrade').value;
            const portfolioPercent = document.getElementById('bitmartPortfolioPercent').value;
            const profitThreshold = document.getElementById('bitmartProfitThreshold').value;

            localStorage.setItem('bitmart_triangular_maxTrade', maxTrade);
            localStorage.setItem('bitmart_triangular_portfolioPercent', portfolioPercent);
            localStorage.setItem('bitmart_triangular_profitThreshold', profitThreshold);

            for (let i = 1; i <= 5; i++) {
                const checkbox = document.getElementById(`bitmartSet${i}Enabled`);
                if (checkbox) {
                    localStorage.setItem(`bitmart_triangular_set${i}`, checkbox.checked);
                }
            }
        }

        function loadBitmartTriangularSettings() {
            document.getElementById('bitmartMaxTrade').value = localStorage.getItem('bitmart_triangular_maxTrade') || '1000';
            document.getElementById('bitmartPortfolioPercent').value = localStorage.getItem('bitmart_triangular_portfolioPercent') || '10';
            document.getElementById('bitmartProfitThreshold').value = localStorage.getItem('bitmart_triangular_profitThreshold') || '0.5';

            for (let i = 1; i <= 5; i++) {
                const checkbox = document.getElementById(`bitmartSet${i}Enabled`);
                if (checkbox) {
                    const saved = localStorage.getItem(`bitmart_triangular_set${i}`);
                    checkbox.checked = saved === 'true' || (saved === null && i <= 2);
                }
            }
        }

        // 10. Initialize BitMart on DOMContentLoaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üß° [BITMART] Initializing triangular arbitrage...');
            loadBitmartTriangularSettings();
            initializeBitmartBalance();
            switchBitmartTab('balance');
        });

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // BITRUE TRIANGULAR ARBITRAGE FUNCTIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        // Worker Variables
        let bitrueWorkerInterval = null;
        let bitrueWorkerStats = {
            totalScans: 0,
            totalOpportunities: 0,
            totalTrades: 0,
            successfulTrades: 0,
            totalProfit: 0,
            bestProfit: 0,
            bestPath: null,
            lastScanTime: null
        };

        // 1. Toggle Bitrue Triangular
        function toggleBitrueTriangular() {
            const toggle = document.getElementById('bitrueTriangularEnabled');
            const status = document.getElementById('bitrueTriangularStatus');
            const isActive = toggle.classList.toggle('active');

            if (isActive) {
                status.textContent = 'ON';
                status.style.color = '#22C55E';
                localStorage.setItem('bitrueTriangularEnabled', 'true');
                console.log('üíö [BITRUE] Triangular arbitrage enabled - starting worker...');
                startBitrueWorker();
            } else {
                status.textContent = 'OFF';
                status.style.color = '#ff6b6b';
                localStorage.setItem('bitrueTriangularEnabled', 'false');
                console.log('üíö [BITRUE] Triangular arbitrage disabled - stopping worker...');
                stopBitrueWorker();
            }
        }

        // 2. View Bitrue Path Details (Professional Modal)
        function viewBitruePathDetails() {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: flex; justify-content: center; align-items: center; z-index: 10000; backdrop-filter: blur(8px);';

            modal.innerHTML = `
                <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); padding: 30px; border-radius: 20px; max-width: 800px; max-height: 85vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(34,197,94,0.4); border: 2px solid rgba(34,197,94,0.3);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid rgba(34,197,94,0.3); padding-bottom: 15px;">
                        <h2 style="color: #22C55E; margin: 0; font-size: 24px; display: flex; align-items: center; gap: 10px;">
                            üíö Bitrue Triangular Arbitrage Paths
                        </h2>
                        <button onclick="this.closest('div[style*=fixed]').remove()" style="background: rgba(255,107,107,0.2); color: #ff6b6b; border: 1px solid #ff6b6b; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s;">‚úï Close</button>
                    </div>

                    <div style="display: grid; gap: 20px;">
                        <!-- SET 1 -->
                        <div style="background: rgba(0,210,106,0.1); padding: 18px; border-radius: 12px; border-left: 5px solid #00d26a;">
                            <h3 style="color: #00d26a; margin: 0 0 12px 0; font-size: 16px; font-weight: 700;">SET 1: ESSENTIAL ETH BRIDGE (7 paths)</h3>
                            <div style="color: #b8c6db; font-size: 13px; line-height: 1.8; font-family: 'Courier New', monospace;">
                                1. USDT ‚Üí ETH ‚Üí BTC ‚Üí USDT<br>
                                2. USDT ‚Üí ETH ‚Üí SOL ‚Üí USDT<br>
                                3. USDT ‚Üí ETH ‚Üí LINK ‚Üí USDT<br>
                                4. USDT ‚Üí ETH ‚Üí AVAX ‚Üí USDT<br>
                                5. USDT ‚Üí ETH ‚Üí MATIC ‚Üí USDT<br>
                                6. USDT ‚Üí ETH ‚Üí UNI ‚Üí USDT<br>
                                7. USDT ‚Üí ETH ‚Üí AAVE ‚Üí USDT
                            </div>
                            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(0,210,106,0.2); color: #00d26a; font-weight: 600; font-size: 13px;">
                                üí∞ Funding: $350-700 USDT
                            </div>
                        </div>

                        <!-- SET 2 -->
                        <div style="background: rgba(0,210,106,0.1); padding: 18px; border-radius: 12px; border-left: 5px solid #00d26a;">
                            <h3 style="color: #00d26a; margin: 0 0 12px 0; font-size: 16px; font-weight: 700;">SET 2: MID-CAP BTC BRIDGE (7 paths)</h3>
                            <div style="color: #b8c6db; font-size: 13px; line-height: 1.8; font-family: 'Courier New', monospace;">
                                1. USDT ‚Üí BTC ‚Üí DOGE ‚Üí USDT<br>
                                2. USDT ‚Üí BTC ‚Üí LTC ‚Üí USDT<br>
                                3. USDT ‚Üí BTC ‚Üí XRP ‚Üí USDT<br>
                                4. USDT ‚Üí BTC ‚Üí ADA ‚Üí USDT<br>
                                5. USDT ‚Üí BTC ‚Üí DOT ‚Üí USDT<br>
                                6. USDT ‚Üí BTC ‚Üí BCH ‚Üí USDT<br>
                                7. USDT ‚Üí BTC ‚Üí TRX ‚Üí USDT
                            </div>
                            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(0,210,106,0.2); color: #00d26a; font-weight: 600; font-size: 13px;">
                                üí∞ Funding: $350-700 USDT
                            </div>
                        </div>

                        <!-- SET 3 - BTR NATIVE TOKEN -->
                        <div style="background: rgba(34,197,94,0.15); padding: 18px; border-radius: 12px; border-left: 5px solid #22C55E;">
                            <h3 style="color: #22C55E; margin: 0 0 12px 0; font-size: 16px; font-weight: 700;">SET 3: BTR NATIVE TOKEN (6 paths) üíö</h3>
                            <div style="color: #b8c6db; font-size: 13px; line-height: 1.8; font-family: 'Courier New', monospace;">
                                1. USDT ‚Üí BTR ‚Üí BTC ‚Üí USDT<br>
                                2. USDT ‚Üí BTR ‚Üí ETH ‚Üí USDT<br>
                                3. USDT ‚Üí BTC ‚Üí BTR ‚Üí USDT<br>
                                4. USDT ‚Üí ETH ‚Üí BTR ‚Üí USDT<br>
                                5. USDT ‚Üí BTR ‚Üí SOL ‚Üí USDT<br>
                                6. USDT ‚Üí SOL ‚Üí BTR ‚Üí USDT
                            </div>
                            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(34,197,94,0.3); color: #22C55E; font-weight: 600; font-size: 13px;">
                                üí∞ Funding: $300-600 USDT | BTR is Bitrue's exchange token - 0.07% fees (30% discount!)
                            </div>
                        </div>

                        <!-- SET 4 -->
                        <div style="background: rgba(255,165,0,0.1); padding: 18px; border-radius: 12px; border-left: 5px solid #FFA500;">
                            <h3 style="color: #FFA500; margin: 0 0 12px 0; font-size: 16px; font-weight: 700;">SET 4: HIGH VOLATILITY (6 paths)</h3>
                            <div style="color: #b8c6db; font-size: 13px; line-height: 1.8; font-family: 'Courier New', monospace;">
                                1. USDT ‚Üí SOL ‚Üí LINK ‚Üí USDT<br>
                                2. USDT ‚Üí SOL ‚Üí MATIC ‚Üí USDT<br>
                                3. USDT ‚Üí LINK ‚Üí BTC ‚Üí USDT<br>
                                4. USDT ‚Üí AVAX ‚Üí SOL ‚Üí USDT<br>
                                5. USDT ‚Üí MATIC ‚Üí BTC ‚Üí USDT<br>
                                6. USDT ‚Üí UNI ‚Üí ETH ‚Üí USDT
                            </div>
                            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,165,0,0.2); color: #FFA500; font-weight: 600; font-size: 13px;">
                                üí∞ Funding: $300-600 USDT
                            </div>
                        </div>

                        <!-- SET 5 -->
                        <div style="background: rgba(255,68,68,0.1); padding: 18px; border-radius: 12px; border-left: 5px solid #FF4444;">
                            <h3 style="color: #FF4444; margin: 0 0 12px 0; font-size: 16px; font-weight: 700;">SET 5: EXTENDED MULTI-BRIDGE (6 paths) üî•</h3>
                            <div style="color: #b8c6db; font-size: 13px; line-height: 1.8; font-family: 'Courier New', monospace;">
                                1. USDT ‚Üí ATOM ‚Üí BTC ‚Üí USDT<br>
                                2. USDT ‚Üí FIL ‚Üí ETH ‚Üí USDT<br>
                                3. USDT ‚Üí XLM ‚Üí BTC ‚Üí USDT<br>
                                4. USDT ‚Üí ALGO ‚Üí ETH ‚Üí USDT<br>
                                5. USDT ‚Üí ETH ‚Üí BTC ‚Üí SOL ‚Üí USDT (4-leg)<br>
                                6. USDT ‚Üí BTC ‚Üí ETH ‚Üí LINK ‚Üí USDT (4-leg)
                            </div>
                            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,68,68,0.2); color: #FF4444; font-weight: 600; font-size: 13px;">
                                üí∞ Funding: $300-600 USDT | Includes 2 four-leg paths
                            </div>
                        </div>

                        <!-- Total Funding -->
                        <div style="background: rgba(34,197,94,0.15); padding: 20px; border-radius: 12px; border: 2px solid #22C55E; text-align: center;">
                            <div style="color: #22C55E; font-size: 20px; font-weight: 700; margin-bottom: 10px;">
                                üí∞ TOTAL RECOMMENDED FUNDING
                            </div>
                            <div style="color: white; font-size: 28px; font-weight: 700; margin-bottom: 10px;">
                                $1,600 - $3,200 USDT
                            </div>
                            <div style="color: #b8c6db; font-size: 14px;">
                                (All 5 sets enabled)
                            </div>
                        </div>

                        <!-- Portfolio % Info -->
                        <div style="background: rgba(0,0,0,0.3); padding: 18px; border-radius: 12px; border: 1px solid rgba(34,197,94,0.3);">
                            <h4 style="color: #22C55E; margin: 0 0 12px 0; font-size: 15px;">‚öñÔ∏è PORTFOLIO % MODE</h4>
                            <p style="color: #b8c6db; margin: 0; font-size: 13px; line-height: 1.6;">
                                Trade amount = <strong style="color: white;">MIN(portfolioPercent √ó balance, maxTradeAmount)</strong><br>
                                Default: 10% of USDT balance, capped at $1,000<br>
                                <strong style="color: #22C55E;">Note:</strong> Binance-compatible API with HMAC-SHA256 authentication
                            </p>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Close on outside click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }

        // 3. Switch Bitrue Tab
        function switchBitrueTab(tab) {
            const balanceBtn = document.getElementById('bitrueBalanceTab');
            const tradingBtn = document.getElementById('bitrueTradingTab');
            const balanceContent = document.getElementById('bitrueBalanceContent');
            const tradingContent = document.getElementById('bitrueTradingContent');

            if (tab === 'balance') {
                balanceBtn.style.background = 'linear-gradient(135deg, #22C55E, #00d26a)';
                balanceBtn.style.color = 'white';
                tradingBtn.style.background = 'rgba(0,0,0,0.3)';
                tradingBtn.style.color = '#888';
                balanceContent.style.display = 'block';
                tradingContent.style.display = 'none';
            } else {
                tradingBtn.style.background = 'linear-gradient(135deg, #22C55E, #00d26a)';
                tradingBtn.style.color = 'white';
                balanceBtn.style.background = 'rgba(0,0,0,0.3)';
                balanceBtn.style.color = '#888';
                tradingContent.style.display = 'block';
                balanceContent.style.display = 'none';
            }
        }

        // 4. Balance Tracking with NaN Prevention
        const bitrueBalanceTracking = {
            starting: 0,
            current: 0,
            initialized: false
        };

        async function initializeBitrueBalance() {
            const apiKey = localStorage.getItem('bitrue_api') || '';
            const apiSecret = localStorage.getItem('bitrue_secret') || '';

            if (!apiKey || !apiSecret) {
                console.log('üíö [BITRUE] No API credentials - skipping auto-fetch');
                return;
            }

            try {
                const response = await fetch('/api/v1/trading/bitrue/balance', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ apiKey, apiSecret, currency: 'USDT' })
                });

                const data = await response.json();

                if (data.success) {
                    const balance = Number(data.balance) || 0;

                    if (!bitrueBalanceTracking.initialized) {
                        bitrueBalanceTracking.starting = balance;
                        bitrueBalanceTracking.current = balance;
                        bitrueBalanceTracking.initialized = true;
                        console.log(`üíö [BITRUE] Balance initialized: ${balance} USDT`);
                    } else {
                        bitrueBalanceTracking.current = balance;
                    }

                    updateBitrueBalanceDisplay();
                }
            } catch (error) {
                console.error('üíö [BITRUE] Auto-fetch failed:', error);
            }
        }

        async function updateBitrueBalance() {
            const apiKey = localStorage.getItem('bitrue_api') || '';
            const apiSecret = localStorage.getItem('bitrue_secret') || '';

            if (!apiKey || !apiSecret) {
                alert('‚ö†Ô∏è Please configure your Bitrue API credentials on the Exchange Connections page first.');
                return;
            }

            try {
                const response = await fetch('/api/v1/trading/bitrue/balance', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ apiKey, apiSecret, currency: 'USDT' })
                });

                const data = await response.json();

                if (data.success) {
                    const balance = Number(data.balance) || 0;

                    if (!bitrueBalanceTracking.initialized) {
                        bitrueBalanceTracking.starting = balance;
                        bitrueBalanceTracking.initialized = true;
                    }

                    bitrueBalanceTracking.current = balance;
                    updateBitrueBalanceDisplay();
                    alert(`‚úÖ Bitrue USDT Balance Updated\n\nCurrent: ${balance.toFixed(2)} USDT`);
                } else {
                    alert(`Balance fetch failed: ${data.message}`);
                }
            } catch (error) {
                console.error('Bitrue balance error:', error);
                alert(`Error: ${error.message}`);
            }
        }

        function updateBitrueBalanceDisplay() {
            const starting = Number(bitrueBalanceTracking.starting) || 0;
            const current = Number(bitrueBalanceTracking.current) || 0;
            const change = current - starting;
            const changePercent = starting > 0 ? ((change / starting) * 100) : 0;

            document.getElementById('bitrueStartingUSDT').textContent = `${starting.toFixed(2)} USDT`;
            document.getElementById('bitrueCurrentUSDT').textContent = `${current.toFixed(2)} USDT`;

            const changeDisplay = document.getElementById('bitrueChangeUSDT');
            const changeSign = change >= 0 ? '+' : '';
            const changeColor = change >= 0 ? '#00d26a' : '#FF4444';

            changeDisplay.textContent = `${changeSign}${change.toFixed(2)} USDT (${changeSign}${changePercent.toFixed(2)}%)`;
            changeDisplay.style.color = changeColor;
        }

        function resetBitrueStartingBalance() {
            if (!confirm('Reset starting balance to current balance?\n\nThis will reset your P&L tracking.')) {
                return;
            }

            bitrueBalanceTracking.starting = bitrueBalanceTracking.current;
            updateBitrueBalanceDisplay();
            alert('‚úÖ Bitrue starting balance reset!');
        }

        // 5. Clear Bitrue History
        function clearBitrueHistory() {
            if (!confirm('Clear all Bitrue opportunity history?')) {
                return;
            }

            document.getElementById('bitrueOpportunities').innerHTML = '';
            document.getElementById('bitrueScanStatus').innerHTML = '';
            window.bitrueCurrentOpportunities = [];
            alert('‚úÖ Bitrue opportunity history cleared!');
        }

        // 6. Scan Bitrue Triangular Paths
        async function scanBitrueTriangularPaths() {
            const apiKey = localStorage.getItem('bitrue_api') || '';
            const apiSecret = localStorage.getItem('bitrue_secret') || '';
            const profitThreshold = parseFloat(document.getElementById('bitrueProfitThreshold').value);
            const maxTradeAmount = parseFloat(document.getElementById('bitrueMaxTrade').value);
            const portfolioPercent = parseFloat(document.getElementById('bitruePortfolioPercent').value);
            const scanStatus = document.getElementById('bitrueScanStatus');
            const opportunitiesDiv = document.getElementById('bitrueOpportunities');

            if (!apiKey || !apiSecret) {
                alert('‚ö†Ô∏è Please configure your Bitrue API credentials on the Exchange Connections page first.');
                return;
            }

            scanStatus.textContent = 'üîÑ Scanning 32 triangular paths...';
            scanStatus.style.color = '#FFA500';
            opportunitiesDiv.innerHTML = '<div style="text-align: center; color: #888; padding: 20px;">Scanning for opportunities...</div>';

            try {
                const enabledSets = {};
                for (let i = 1; i <= 5; i++) {
                    const checkbox = document.getElementById(`bitrueSet${i}Enabled`);
                    if (checkbox && checkbox.checked) {
                        enabledSets[`SET_${i}`] = true;
                    }
                }

                const response = await fetch('/api/v1/trading/bitrue/triangular/scan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        apiKey,
                        apiSecret,
                        profitThreshold,
                        maxTradeAmount,
                        portfolioPercent,
                        enabledSets
                    })
                });

                const data = await response.json();

                if (data.success) {
                    scanStatus.textContent = `‚úÖ Found ${data.profitableCount} opportunities (scanned ${data.scanned} paths)`;
                    scanStatus.style.color = '#00FF00';

                    if (data.opportunities.length > 0) {
                        let opportunitiesHtml = '<div style="display: grid; gap: 15px;">';

                        data.opportunities.forEach((opp, index) => {
                            const profitColor = parseFloat(opp.profitPercent) >= 0.5 ? '#00FF00' : '#FFA500';
                            const pairs = opp.steps.map(s => s.pair).join(', ');

                            opportunitiesHtml += `
                                <div style="padding: 15px; background: rgba(34,197,94,0.1); border-radius: 10px; border: 2px solid #22C55E;">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                        <div>
                                            <div style="color: #22C55E; font-weight: 600; margin-bottom: 5px;">${opp.pathId}</div>
                                            <div style="color: #ddd; margin-bottom: 5px;">${opp.description}</div>
                                            <div style="color: #888; font-size: 14px;">Path: ${opp.path.join(' ‚Üí ')}</div>
                                        </div>
                                        <div style="text-align: right;">
                                            <div style="color: ${profitColor}; font-size: 24px; font-weight: 700;">${opp.profitPercent}%</div>
                                            <div style="color: #888; font-size: 14px;">~$${parseFloat(opp.profitAmount).toFixed(2)} profit</div>
                                        </div>
                                    </div>
                                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #444;">
                                        <div style="color: #888; font-size: 12px; margin-bottom: 5px;">Pairs: ${pairs}</div>
                                        <button onclick="executeBitrueTriangularTrade('${opp.pathId}')" style="width: 100%; padding: 8px; background: #22C55E; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; margin-top: 10px;">
                                            üíö Execute Trade
                                        </button>
                                    </div>
                                </div>
                            `;
                        });

                        opportunitiesHtml += '</div>';
                        opportunitiesDiv.innerHTML = opportunitiesHtml;
                    } else {
                        opportunitiesDiv.innerHTML = '<div style="text-align: center; color: #888; padding: 20px;">No profitable opportunities found. Try lowering the profit threshold.</div>';
                    }
                } else {
                    scanStatus.textContent = '‚ùå Scan failed';
                    scanStatus.style.color = '#FF4444';
                    opportunitiesDiv.innerHTML = `<div style="text-align: center; color: #FF4444; padding: 20px;">${data.message}</div>`;
                }
            } catch (error) {
                scanStatus.textContent = '‚ùå Scan error';
                scanStatus.style.color = '#FF4444';
                opportunitiesDiv.innerHTML = `<div style="text-align: center; color: #FF4444; padding: 20px;">Error: ${error.message}</div>`;
            }
        }

        // Execute Bitrue Triangular Trade
        async function executeBitrueTriangularTrade(pathId) {
            const apiKey = localStorage.getItem('bitrue_api') || '';
            const apiSecret = localStorage.getItem('bitrue_secret') || '';
            const maxTrade = parseFloat(document.getElementById('bitrueMaxTrade').value);

            // Enhanced real money warning
            if (!confirm(`‚ö†Ô∏è REAL MONEY TRADING ‚ö†Ô∏è\n\nExecute REAL triangular arbitrage trade?\n\nPath: ${pathId}\nAmount: ${maxTrade} USDT\n\nThis will execute REAL market orders on Bitrue.\nClick OK to proceed.`)) {
                return;
            }

            try {
                const response = await fetch('/api/v1/trading/bitrue/triangular/execute', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ apiKey, apiSecret, pathId, amount: maxTrade })
                });

                const result = await response.json();

                if (result.success && result.data) {
                    const execution = result.data;

                    if (execution.status === 'COMPLETED') {
                        const profit = execution.actualProfit || 0;
                        const profitPct = execution.actualProfitPercentage || 0;

                        alert(`‚úÖ Trade Executed Successfully!\n\nExecution ID: ${execution.executionId}\nProfit: $${profit.toFixed(2)} (${profitPct.toFixed(3)}%)\nLegs Completed: ${execution.legs?.length || 0}/3\nTotal Time: ${execution.totalExecutionTime}ms\n\nAll legs executed atomically with slippage monitoring.`);

                        // üìä Log to backend using shared service
                        logTriangularTrade('Bitrue', pathId, profit, maxTrade, execution.totalFees || 0).catch(e => console.warn('Logging failed:', e));

                        // Refresh opportunities and balance
                        scanBitrueTriangularPaths();
                        initializeBitrueBalance();
                    } else {
                        alert(`‚ùå Trade Failed!\n\nStatus: ${execution.status}\nError: ${execution.error || 'Unknown error'}\nCompleted Legs: ${execution.legs?.filter(l => l.status === 'COMPLETED').length || 0}/3`);
                    }
                } else {
                    alert(`‚ùå Trade execution failed:\n\n${result.message || 'Unknown error'}`);
                }
            } catch (error) {
                alert(`‚ùå Trade execution error:\n\n${error.message}`);
            }
        }

        // Start Bitrue Worker (Sequential Scanning)
        async function startBitrueWorker() {
            // Validate credentials
            const apiKey = localStorage.getItem('bitrue_api');
            const apiSecret = localStorage.getItem('bitrue_secret');

            if (!apiKey || !apiSecret) {
                alert('‚ö†Ô∏è Please configure Bitrue API credentials first!');
                document.getElementById('bitrueTriangularEnabled').classList.remove('active');
                document.getElementById('bitrueTriangularStatus').textContent = 'OFF';
                document.getElementById('bitrueTriangularStatus').style.color = '#ff6b6b';
                return;
            }

            // Check if at least one set is selected
            const set1Enabled = document.getElementById('bitrueSet1Enabled').checked;
            const set2Enabled = document.getElementById('bitrueSet2Enabled').checked;
            const set3Enabled = document.getElementById('bitrueSet3Enabled').checked;
            const set4Enabled = document.getElementById('bitrueSet4Enabled').checked;
            const set5Enabled = document.getElementById('bitrueSet5Enabled').checked;

            if (!set1Enabled && !set2Enabled && !set3Enabled && !set4Enabled && !set5Enabled) {
                alert('‚ö†Ô∏è Please enable at least one path set!');
                document.getElementById('bitrueTriangularEnabled').classList.remove('active');
                document.getElementById('bitrueTriangularStatus').textContent = 'OFF';
                document.getElementById('bitrueTriangularStatus').style.color = '#ff6b6b';
                return;
            }

            const portfolioPercent = parseFloat(document.getElementById('bitruePortfolioPercent').value) || 5;
            const maxTradeAmount = parseFloat(document.getElementById('bitrueMaxTrade').value) || 100;
            const profitThreshold = parseFloat(document.getElementById('bitrueProfitThreshold').value) || 0.3;

            // Build selected sets array
            const selectedSets = [];
            if (set1Enabled) selectedSets.push('SET_1_ESSENTIAL_ETH_BRIDGE');
            if (set2Enabled) selectedSets.push('SET_2_MIDCAP_BTC_BRIDGE');
            if (set3Enabled) selectedSets.push('SET_3_BTR_NATIVE_TOKEN');
            if (set4Enabled) selectedSets.push('SET_4_HIGH_VOLATILITY');
            if (set5Enabled) selectedSets.push('SET_5_EXTENDED_MULTIBRIDGE');

            console.log(`üíö [BITRUE] Worker started - scanning ${selectedSets.length} sets sequentially`);
            console.log(`üíö [BITRUE] Portfolio: ${portfolioPercent}%, Max Trade: $${maxTradeAmount}, Threshold: ${profitThreshold}%`);

            let currentSetIndex = 0;

            // Sequential scan function
            async function scanAndExecuteSequential() {
                try {
                    bitrueWorkerStats.totalScans++;
                    bitrueWorkerStats.lastScanTime = new Date().toISOString();

                    const currentSet = selectedSets[currentSetIndex];
                    console.log(`üíö [BITRUE] Scanning set ${currentSetIndex + 1}/${selectedSets.length}: ${currentSet}`);

                    // Scan current set only
                    const response = await fetch('/api/v1/trading/bitrue/triangular/scan', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            apiKey,
                            apiSecret,
                            selectedSets: [currentSet],
                            portfolioPercent,
                            maxTradeAmount
                        })
                    });

                    const data = await response.json();

                    if (data.success && data.opportunities && data.opportunities.length > 0) {
                        bitrueWorkerStats.totalOpportunities += data.opportunities.length;

                        // Log opportunities above threshold
                        data.opportunities.forEach(opp => {
                            if (opp.profitPercentage >= profitThreshold) {
                                console.log(`üíö [BITRUE] Opportunity found: ${opp.pathId} - ${opp.profitPercentage.toFixed(3)}% profit`);

                                // Track best profit
                                if (opp.profitPercentage > bitrueWorkerStats.bestProfit) {
                                    bitrueWorkerStats.bestProfit = opp.profitPercentage;
                                    bitrueWorkerStats.bestPath = opp.pathId;
                                }
                            }
                        });
                    }

                    // Move to next set (circular)
                    currentSetIndex = (currentSetIndex + 1) % selectedSets.length;

                    // Update balance after completing full cycle
                    if (currentSetIndex === 0) {
                        console.log(`üíö [BITRUE] Completed full cycle - updating balance...`);
                        initializeBitrueBalance();
                    }

                } catch (error) {
                    console.error(`üíö [BITRUE] Worker scan error:`, error);
                }
            }

            // Start sequential interval (8 seconds between scans)
            scanAndExecuteSequential(); // Run immediately
            bitrueWorkerInterval = setInterval(scanAndExecuteSequential, 8000);

            console.log(`üíö [BITRUE] Worker active - scanning every 8 seconds`);
        }

        // Stop Bitrue Worker
        function stopBitrueWorker() {
            if (bitrueWorkerInterval) {
                clearInterval(bitrueWorkerInterval);
                bitrueWorkerInterval = null;

                console.log(`üíö [BITRUE] Worker stopped`);
                console.log(`üíö [BITRUE] Stats:`, {
                    totalScans: bitrueWorkerStats.totalScans,
                    totalOpportunities: bitrueWorkerStats.totalOpportunities,
                    bestProfit: bitrueWorkerStats.bestProfit?.toFixed(3) + '%',
                    bestPath: bitrueWorkerStats.bestPath
                });
            }
        }

        // Save Bitrue Settings
        function saveBitrueTriangularSettings() {
            const settings = {
                maxTrade: document.getElementById('bitrueMaxTrade').value,
                portfolioPercent: document.getElementById('bitruePortfolioPercent').value,
                profitThreshold: document.getElementById('bitrueProfitThreshold').value,
                set1Enabled: document.getElementById('bitrueSet1Enabled').checked,
                set2Enabled: document.getElementById('bitrueSet2Enabled').checked,
                set3Enabled: document.getElementById('bitrueSet3Enabled').checked,
                set4Enabled: document.getElementById('bitrueSet4Enabled').checked,
                set5Enabled: document.getElementById('bitrueSet5Enabled').checked
            };
            localStorage.setItem('bitrue_triangular_settings', JSON.stringify(settings));
            console.log('üíö [BITRUE] Settings saved:', settings);
        }

        // Load Bitrue Settings
        function loadBitrueTriangularSettings() {
            try {
                const saved = localStorage.getItem('bitrue_triangular_settings');
                if (saved) {
                    const settings = JSON.parse(saved);

                    if (settings.maxTrade) document.getElementById('bitrueMaxTrade').value = settings.maxTrade;
                    if (settings.portfolioPercent) document.getElementById('bitruePortfolioPercent').value = settings.portfolioPercent;
                    if (settings.profitThreshold) document.getElementById('bitrueProfitThreshold').value = settings.profitThreshold;

                    if (settings.set1Enabled !== undefined) document.getElementById('bitrueSet1Enabled').checked = settings.set1Enabled;
                    if (settings.set2Enabled !== undefined) document.getElementById('bitrueSet2Enabled').checked = settings.set2Enabled;
                    if (settings.set3Enabled !== undefined) document.getElementById('bitrueSet3Enabled').checked = settings.set3Enabled;
                    if (settings.set4Enabled !== undefined) document.getElementById('bitrueSet4Enabled').checked = settings.set4Enabled;
                    if (settings.set5Enabled !== undefined) document.getElementById('bitrueSet5Enabled').checked = settings.set5Enabled;

                    console.log('üíö [BITRUE] Settings loaded:', settings);
                }
            } catch (error) {
                console.error('üíö [BITRUE] Error loading settings:', error);
            }
        }

        // Load Bitrue Trade History
        async function loadBitrueTradeHistory() {
            const userId = localStorage.getItem('userId');

            if (!userId) {
                return;
            }

            try {
                const response = await fetch('/api/v1/trading/bitrue/triangular/history', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId, limit: 20 })
                });

                const data = await response.json();

                if (data.success && data.trades.length > 0) {
                    let historyHtml = '<div style="display: grid; gap: 10px;">';

                    data.trades.forEach(trade => {
                        const profitColor = trade.profit >= 0 ? '#00FF00' : '#FF4444';

                        historyHtml += `
                            <div style="padding: 12px; background: rgba(0,0,0,0.3); border-radius: 8px; border-left: 3px solid ${profitColor};">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <div style="color: #22C55E; font-weight: 600;">${trade.path_id}</div>
                                        <div style="color: #888; font-size: 12px;">${trade.path_description}</div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="color: ${profitColor}; font-weight: 600;">${trade.profit_percent?.toFixed(3)}%</div>
                                        <div style="color: #888; font-size: 12px;">$${trade.profit?.toFixed(2)}</div>
                                    </div>
                                </div>
                                <div style="color: #888; font-size: 12px;">${new Date(trade.created_at).toLocaleString()}</div>
                            </div>
                        `;
                    });

                    historyHtml += '</div>';
                    document.getElementById('bitrueTradeHistory').innerHTML = historyHtml;
                }
            } catch (error) {
                console.error('Bitrue history error:', error);
            }
        }

        // Initialize Bitrue settings on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üíö [BITRUE] Initializing triangular arbitrage settings...');
            loadBitrueTriangularSettings();

            // Initialize balance tracking
            initializeBitrueBalance();

            // Set default tab to Balance Tracker
            switchBitrueTab('balance');

            // Restore toggle state
            const toggleEnabled = localStorage.getItem('bitrueTriangularEnabled') === 'true';
            const toggle = document.getElementById('bitrueTriangularEnabled');
            const status = document.getElementById('bitrueTriangularStatus');
            if (toggle && status) {
                if (toggleEnabled) {
                    toggle.classList.add('active');
                    status.textContent = 'ON';
                    status.style.color = '#22C55E';
                } else {
                    toggle.classList.remove('active');
                    status.textContent = 'OFF';
                    status.style.color = '#ff6b6b';
                }
            }

            const bitrueInputs = document.querySelectorAll('#bitrueMaxTrade, #bitruePortfolioPercent, #bitrueProfitThreshold');
            bitrueInputs.forEach(input => {
                input.addEventListener('change', saveBitrueTriangularSettings);
            });

            for (let i = 1; i <= 5; i++) {
                const checkbox = document.getElementById(`bitrueSet${i}Enabled`);
                if (checkbox) {
                    checkbox.addEventListener('change', saveBitrueTriangularSettings);
                }
            }
        });

        // ============================================================================
        // GEMINI TRIANGULAR ARBITRAGE FUNCTIONS
        // ============================================================================

        // 1. Toggle Gemini Triangular
        // Gemini Worker Variables
        let geminiWorkerInterval = null;
        let geminiWorkerStats = {
            totalScans: 0,
            totalOpportunities: 0,
            totalTrades: 0,
            successfulTrades: 0,
            totalProfit: 0,
            bestProfit: 0,
            bestPath: null,
            lastScanTime: null
        };

        function toggleGeminiTriangular() {
            const toggle = document.getElementById('geminiTriangularEnabled');
            const status = document.getElementById('geminiTriangularStatus');
            const isActive = toggle.classList.toggle('active');

            if (isActive) {
                status.textContent = 'ON';
                status.style.color = '#00AADD';
                localStorage.setItem('geminiTriangularEnabled', 'true');
                console.log('üíé [GEMINI] Triangular arbitrage enabled - starting worker...');
                startGeminiWorker();
            } else {
                status.textContent = 'OFF';
                status.style.color = '#ff6b6b';
                localStorage.setItem('geminiTriangularEnabled', 'false');
                console.log('üíé [GEMINI] Triangular arbitrage disabled - stopping worker...');
                stopGeminiWorker();
            }
        }

        // 2. View Gemini Path Details (Professional Modal)
        function viewGeminiPathDetails() {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: flex; justify-content: center; align-items: center; z-index: 10000; backdrop-filter: blur(8px);';

            modal.innerHTML = `
                <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); padding: 30px; border-radius: 20px; max-width: 800px; max-height: 85vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,170,221,0.4); border: 2px solid rgba(0,170,221,0.3);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid rgba(0,170,221,0.3);">
                        <h2 style="color: #00AADD; margin: 0; font-size: 24px; font-weight: 700;">üíé Gemini Triangular Arbitrage Paths</h2>
                        <button onclick="this.closest('div[style*=fixed]').remove()" style="background: rgba(255,87,34,0.2); color: #FF5722; border: 1px solid #FF5722; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px;">
                            ‚úï Close
                        </button>
                    </div>

                    <div style="background: rgba(0,170,221,0.1); padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #00AADD;">
                        <p style="color: #b8c6db; margin: 0; font-size: 14px; line-height: 1.6;">
                            <strong style="color: #00AADD;">Gemini Exchange:</strong> Regulated US exchange founded by Winklevoss twins | HMAC-SHA384 auth | Limited USDT pairs | 10 paths total<br>
                            <strong style="color: #00AADD;">Funding Range:</strong> $1,000-2,000 USDT total (all sets enabled)
                        </p>
                    </div>

                    <!-- SET 1 - BTC-ETH DIRECT -->
                    <div style="background: rgba(0,170,221,0.15); padding: 18px; border-radius: 12px; margin-bottom: 15px; border-left: 5px solid #00AADD;">
                        <h3 style="color: #00AADD; margin: 0 0 12px 0; font-size: 16px; font-weight: 700;">SET 1: BTC-ETH Direct (2 paths) üíé</h3>
                        <div style="color: #b8c6db; font-size: 13px; line-height: 1.8; font-family: 'Courier New', monospace;">
                            1. USDT ‚Üí BTC ‚Üí ETH ‚Üí USDT<br>
                            2. USDT ‚Üí ETH ‚Üí BTC ‚Üí USDT
                        </div>
                        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(0,170,221,0.3); color: #00AADD; font-weight: 600; font-size: 13px;">
                            üí∞ Funding: $200-400 USDT | Direct BTC-ETH bridge (3-leg)
                        </div>
                    </div>

                    <!-- SET 2 - DOGE BRIDGE -->
                    <div style="background: rgba(0,170,221,0.15); padding: 18px; border-radius: 12px; margin-bottom: 15px; border-left: 5px solid #00AADD;">
                        <h3 style="color: #00AADD; margin: 0 0 12px 0; font-size: 16px; font-weight: 700;">SET 2: DOGE Bridge (2 paths) üíé</h3>
                        <div style="color: #b8c6db; font-size: 13px; line-height: 1.8; font-family: 'Courier New', monospace;">
                            1. USDT ‚Üí BTC ‚Üí DOGE ‚Üí ETH ‚Üí USDT<br>
                            2. USDT ‚Üí ETH ‚Üí DOGE ‚Üí BTC ‚Üí USDT
                        </div>
                        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(0,170,221,0.3); color: #00AADD; font-weight: 600; font-size: 13px;">
                            üí∞ Funding: $200-400 USDT | BTC/ETH via DOGE (4-leg)
                        </div>
                    </div>

                    <!-- SET 3 - LINK BRIDGE -->
                    <div style="background: rgba(255,193,7,0.15); padding: 18px; border-radius: 12px; margin-bottom: 15px; border-left: 5px solid #FFC107;">
                        <h3 style="color: #FFC107; margin: 0 0 12px 0; font-size: 16px; font-weight: 700;">SET 3: LINK Bridge (2 paths) ‚ö†Ô∏è</h3>
                        <div style="color: #b8c6db; font-size: 13px; line-height: 1.8; font-family: 'Courier New', monospace;">
                            1. USDT ‚Üí BTC ‚Üí LINK ‚Üí ETH ‚Üí USDT<br>
                            2. USDT ‚Üí ETH ‚Üí LINK ‚Üí BTC ‚Üí USDT
                        </div>
                        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,193,7,0.3); color: #FFC107; font-weight: 600; font-size: 13px;">
                            üí∞ Funding: $200-400 USDT | BTC/ETH via LINK (4-leg)
                        </div>
                    </div>

                    <!-- SET 4 - LTC BRIDGE -->
                    <div style="background: rgba(255,193,7,0.15); padding: 18px; border-radius: 12px; margin-bottom: 15px; border-left: 5px solid #FFC107;">
                        <h3 style="color: #FFC107; margin: 0 0 12px 0; font-size: 16px; font-weight: 700;">SET 4: LTC Bridge (2 paths) ‚ö†Ô∏è</h3>
                        <div style="color: #b8c6db; font-size: 13px; line-height: 1.8; font-family: 'Courier New', monospace;">
                            1. USDT ‚Üí BTC ‚Üí LTC ‚Üí ETH ‚Üí USDT<br>
                            2. USDT ‚Üí ETH ‚Üí LTC ‚Üí BTC ‚Üí USDT
                        </div>
                        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,193,7,0.3); color: #FFC107; font-weight: 600; font-size: 13px;">
                            üí∞ Funding: $200-400 USDT | BTC/ETH via LTC (4-leg)
                        </div>
                    </div>

                    <!-- SET 5 - SOL BRIDGE -->
                    <div style="background: rgba(255,87,34,0.15); padding: 18px; border-radius: 12px; margin-bottom: 15px; border-left: 5px solid #FF5722;">
                        <h3 style="color: #FF5722; margin: 0 0 12px 0; font-size: 16px; font-weight: 700;">SET 5: SOL Bridge (2 paths) üî•</h3>
                        <div style="color: #b8c6db; font-size: 13px; line-height: 1.8; font-family: 'Courier New', monospace;">
                            1. USDT ‚Üí BTC ‚Üí SOL ‚Üí ETH ‚Üí USDT<br>
                            2. USDT ‚Üí ETH ‚Üí SOL ‚Üí BTC ‚Üí USDT
                        </div>
                        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,87,34,0.3); color: #FF5722; font-weight: 600; font-size: 13px;">
                            üí∞ Funding: $200-400 USDT | BTC/ETH via SOL (4-leg, higher volatility)
                        </div>
                    </div>

                    <div style="background: rgba(0,170,221,0.1); padding: 15px; border-radius: 10px; margin-top: 20px;">
                        <p style="color: #00AADD; margin: 0; font-size: 14px; font-weight: 600;">
                            üìä Total: 10 paths | üíé Defaults: SET 1 & SET 2 | üí∞ Total Funding: $1,000-2,000 USDT
                        </p>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }

        // 3. Switch Gemini Tab
        function switchGeminiTab(tab) {
            const balanceBtn = document.getElementById('geminiBalanceTab');
            const tradingBtn = document.getElementById('geminiTradingTab');
            const balanceContent = document.getElementById('geminiBalanceContent');
            const tradingContent = document.getElementById('geminiTradingContent');

            if (tab === 'balance') {
                balanceBtn.style.background = 'linear-gradient(135deg, #00AADD, #0088AA)';
                balanceBtn.style.color = 'white';
                tradingBtn.style.background = 'rgba(0,0,0,0.3)';
                tradingBtn.style.color = '#888';
                balanceContent.style.display = 'block';
                tradingContent.style.display = 'none';
            } else {
                tradingBtn.style.background = 'linear-gradient(135deg, #00AADD, #0088AA)';
                tradingBtn.style.color = 'white';
                balanceBtn.style.background = 'rgba(0,0,0,0.3)';
                balanceBtn.style.color = '#888';
                tradingContent.style.display = 'block';
                balanceContent.style.display = 'none';
            }
        }

        // 4. Balance Tracking with NaN Prevention
        const geminiBalanceTracking = {
            starting: 0,
            current: 0,
            initialized: false
        };

        async function initializeGeminiBalance() {
            const apiKey = localStorage.getItem('gemini_api') || '';
            const apiSecret = localStorage.getItem('gemini_secret') || '';

            if (!apiKey || !apiSecret) {
                console.log('üíé [GEMINI] No API credentials - skipping auto-fetch');
                return;
            }

            try {
                const response = await fetch('/api/v1/trading/gemini/balance', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ apiKey, apiSecret, currency: 'USDT' })
                });

                const data = await response.json();

                if (data.success) {
                    const balance = Number(data.balance) || 0;

                    if (!geminiBalanceTracking.initialized) {
                        geminiBalanceTracking.starting = balance;
                        geminiBalanceTracking.current = balance;
                        geminiBalanceTracking.initialized = true;
                        console.log(`üíé [GEMINI] Balance initialized: ${balance} USDT`);
                    } else {
                        geminiBalanceTracking.current = balance;
                    }

                    updateGeminiBalanceDisplay();
                }
            } catch (error) {
                console.error('üíé [GEMINI] Auto-fetch failed:', error);
            }
        }

        async function updateGeminiBalance() {
            const apiKey = localStorage.getItem('gemini_api') || '';
            const apiSecret = localStorage.getItem('gemini_secret') || '';

            if (!apiKey || !apiSecret) {
                alert('‚ö†Ô∏è Please configure your Gemini API credentials on the Exchange Connections page first.');
                return;
            }

            try {
                const response = await fetch('/api/v1/trading/gemini/balance', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ apiKey, apiSecret, currency: 'USDT' })
                });

                const data = await response.json();

                if (data.success) {
                    const balance = Number(data.balance) || 0;

                    if (!geminiBalanceTracking.initialized) {
                        geminiBalanceTracking.starting = balance;
                        geminiBalanceTracking.initialized = true;
                    }

                    geminiBalanceTracking.current = balance;
                    updateGeminiBalanceDisplay();
                    alert(`‚úÖ Gemini USDT Balance Updated\n\nCurrent: ${balance.toFixed(2)} USDT`);
                } else {
                    alert(`Balance fetch failed: ${data.message}`);
                }
            } catch (error) {
                console.error('Gemini balance error:', error);
                alert(`Error: ${error.message}`);
            }
        }

        function updateGeminiBalanceDisplay() {
            const starting = Number(geminiBalanceTracking.starting) || 0;
            const current = Number(geminiBalanceTracking.current) || 0;
            const change = current - starting;
            const changePercent = starting > 0 ? ((change / starting) * 100) : 0;

            document.getElementById('geminiStartingUSDT').textContent = `${starting.toFixed(2)} USDT`;
            document.getElementById('geminiCurrentUSDT').textContent = `${current.toFixed(2)} USDT`;

            const changeDisplay = document.getElementById('geminiChangeUSDT');
            const changeSign = change >= 0 ? '+' : '';
            const changeColor = change >= 0 ? '#00d26a' : '#FF4444';

            changeDisplay.textContent = `${changeSign}${change.toFixed(2)} USDT (${changeSign}${changePercent.toFixed(2)}%)`;
            changeDisplay.style.color = changeColor;
        }

        function resetGeminiStartingBalance() {
            if (!confirm('Reset starting balance to current balance?\n\nThis will reset your P&L tracking.')) {
                return;
            }

            geminiBalanceTracking.starting = geminiBalanceTracking.current;
            updateGeminiBalanceDisplay();
            alert('‚úÖ Gemini starting balance reset!');
        }

        // 5. Clear Gemini History
        function clearGeminiHistory() {
            if (!confirm('Clear all Gemini opportunity history?')) {
                return;
            }

            document.getElementById('geminiOpportunities').innerHTML = '';
            document.getElementById('geminiScanStatus').innerHTML = '';
            window.geminiCurrentOpportunities = [];
            alert('‚úÖ Gemini opportunity history cleared!');
        }

        // 6. Scan Gemini Triangular Paths
        async function scanGeminiTriangularPaths() {
            const apiKey = localStorage.getItem('gemini_api') || '';
            const apiSecret = localStorage.getItem('gemini_secret') || '';
            const profitThreshold = parseFloat(document.getElementById('geminiProfitThreshold').value);
            const maxTradeAmount = parseFloat(document.getElementById('geminiMaxTrade').value);
            const portfolioPercent = parseFloat(document.getElementById('geminiPortfolioPercent').value);
            const scanStatus = document.getElementById('geminiScanStatus');
            const opportunitiesDiv = document.getElementById('geminiOpportunities');

            if (!apiKey || !apiSecret) {
                alert('‚ö†Ô∏è Please configure your Gemini API credentials on the Exchange Connections page first.');
                return;
            }

            scanStatus.textContent = 'üîÑ Scanning 10 triangular paths...';
            scanStatus.style.color = '#FFA500';
            opportunitiesDiv.innerHTML = '<div style="text-align: center; color: #888; padding: 20px;">Scanning for opportunities...</div>';

            try {
                const enabledSets = {};
                for (let i = 1; i <= 5; i++) {
                    const checkbox = document.getElementById(`geminiSet${i}Enabled`);
                    if (checkbox && checkbox.checked) {
                        enabledSets[`SET_${i}_${['BTC_ETH_DIRECT', 'DOGE_BRIDGE', 'LINK_BRIDGE', 'LTC_BRIDGE', 'SOL_BRIDGE'][i - 1]}`] = true;
                    }
                }

                const response = await fetch('/api/v1/trading/gemini/triangular/scan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        apiKey,
                        apiSecret,
                        profitThreshold,
                        maxTradeAmount,
                        portfolioPercent,
                        enabledSets
                    })
                });

                const data = await response.json();

                if (data.success) {
                    scanStatus.textContent = `‚úÖ Found ${data.profitableCount} opportunities (scanned ${data.scanned} paths)`;
                    scanStatus.style.color = '#00FF00';

                    if (data.opportunities.length > 0) {
                        let opportunitiesHtml = '<div style="display: grid; gap: 15px;">';

                        data.opportunities.forEach((opp, index) => {
                            const profitColor = parseFloat(opp.profitPercent) >= 0.5 ? '#00FF00' : '#FFA500';
                            const pairs = opp.steps.map(s => s.pair).join(', ');

                            opportunitiesHtml += `
                                <div style="padding: 15px; background: rgba(0,170,221,0.1); border-radius: 10px; border: 2px solid #00AADD;">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                        <div>
                                            <div style="color: #00AADD; font-weight: 600; margin-bottom: 5px;">${opp.pathId}</div>
                                            <div style="color: #ddd; margin-bottom: 5px;">${opp.description}</div>
                                            <div style="color: #888; font-size: 14px;">Path: ${opp.path.join(' ‚Üí ')}</div>
                                        </div>
                                        <div style="text-align: right;">
                                            <div style="color: ${profitColor}; font-size: 24px; font-weight: 700;">${opp.profitPercent}%</div>
                                            <div style="color: #888; font-size: 14px;">~$${parseFloat(opp.profitAmount).toFixed(2)} profit</div>
                                        </div>
                                    </div>
                                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #444;">
                                        <div style="color: #888; font-size: 12px; margin-bottom: 5px;">Pairs: ${pairs}</div>
                                        <button onclick="executeGeminiTriangularTrade('${opp.pathId}')" style="width: 100%; padding: 8px; background: #00AADD; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; margin-top: 10px;">
                                            üíé Execute Trade
                                        </button>
                                    </div>
                                </div>
                            `;
                        });

                        opportunitiesHtml += '</div>';
                        opportunitiesDiv.innerHTML = opportunitiesHtml;
                    } else {
                        opportunitiesDiv.innerHTML = '<div style="text-align: center; color: #888; padding: 20px;">No profitable opportunities found. Try lowering the profit threshold.</div>';
                    }
                } else {
                    scanStatus.textContent = '‚ùå Scan failed';
                    scanStatus.style.color = '#FF4444';
                    opportunitiesDiv.innerHTML = `<div style="text-align: center; color: #FF4444; padding: 20px;">${data.message}</div>`;
                }
            } catch (error) {
                scanStatus.textContent = '‚ùå Scan error';
                scanStatus.style.color = '#FF4444';
                opportunitiesDiv.innerHTML = `<div style="text-align: center; color: #FF4444; padding: 20px;">Error: ${error.message}</div>`;
            }
        }

        // Execute Gemini Triangular Trade (REAL ATOMIC EXECUTION)
        async function executeGeminiTriangularTrade(pathId) {
            try {
                const apiKey = localStorage.getItem('gemini_api') || '';
                const apiSecret = localStorage.getItem('gemini_secret') || '';
                const maxTradeAmount = parseFloat(document.getElementById('geminiMaxTrade').value);

                if (!apiKey || !apiSecret) {
                    alert('‚ö†Ô∏è Please configure your Gemini API credentials first.');
                    return;
                }

                if (!confirm(`‚ö†Ô∏è REAL MONEY TRADING ‚ö†Ô∏è\n\nExecute REAL triangular arbitrage trade?\n\nPath: ${pathId}\nAmount: $${maxTradeAmount} USDT\n\nThis will execute REAL market orders on Gemini.\nClick OK to proceed.`)) {
                    return;
                }

                console.log(`üíé [GEMINI] Executing REAL trade: ${pathId}`);

                const response = await fetch(`${API_BASE}/trading/gemini/triangular/execute`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        apiKey,
                        apiSecret,
                        pathId,
                        amount: maxTradeAmount
                    })
                });

                const result = await response.json();

                if (result.success && result.data) {
                    const execution = result.data;
                    const profit = execution.actualProfit || 0;
                    const profitPct = execution.actualProfitPercentage || 0;
                    const status = execution.status || 'UNKNOWN';

                    if (status === 'COMPLETED') {
                        alert(`‚úÖ Trade Executed Successfully!\n\nExecution ID: ${execution.executionId}\nPath: ${pathId}\nStart Amount: $${execution.startAmount}\nEnd Amount: $${execution.endAmount}\nProfit: $${profit.toFixed(2)} (${profitPct.toFixed(2)}%)\nLegs Completed: ${execution.legs?.length || 0}/3\n\nAll legs executed atomically with slippage monitoring.`);

                        console.log('‚úÖ [GEMINI] Trade executed successfully:', execution);

                        // üìä Log to backend using shared service
                        logTriangularTrade('Gemini', pathId, profit, maxTradeAmount, execution.totalFees || 0).catch(e => console.warn('Logging failed:', e));

                        // Update balance after execution
                        await updateGeminiBalance();

                        // Refresh opportunities
                        await scanGeminiTriangularPaths();
                    } else {
                        alert(`‚ùå Trade Execution Failed\n\nExecution ID: ${execution.executionId}\nStatus: ${status}\nError: ${execution.error || 'Unknown error'}\nCompleted Legs: ${execution.legs?.filter(l => l.status === 'COMPLETED').length || 0}/3`);
                        console.error('‚ùå [GEMINI] Trade execution failed:', execution);
                    }
                } else {
                    alert(`‚ùå Trade Execution Failed\n\n${result.message || result.error || 'Unknown error'}`);
                    console.error('‚ùå [GEMINI] Trade execution failed:', result);
                }

            } catch (error) {
                console.error('‚ùå [GEMINI] Trade execution error:', error);
                alert(`‚ùå Error executing trade: ${error.message}`);
            }
        }

        // ============================================================================
        // GEMINI WORKER FUNCTIONS (Sequential Scanning)
        // ============================================================================

        // Start Gemini Worker (Sequential Scanning - One Set at a Time)
        async function startGeminiWorker() {
            console.log('üöÄ [GEMINI Worker] Starting automated trading (sequential mode)...');

            const apiKey = localStorage.getItem('gemini_api') || '';
            const apiSecret = localStorage.getItem('gemini_secret') || '';
            const profitThreshold = parseFloat(document.getElementById('geminiProfitThreshold')?.value) || 0.5;
            const maxTradeAmount = parseFloat(document.getElementById('geminiMaxTrade')?.value) || 1000;

            // Get selected path sets
            const selectedSets = [];
            for (let i = 1; i <= 5; i++) {
                const checkbox = document.getElementById(`geminiSet${i}Enabled`);
                if (checkbox && checkbox.checked) {
                    selectedSets.push(i);
                }
            }

            if (selectedSets.length === 0) {
                console.error('‚ùå [GEMINI Worker] No sets selected!');
                alert('‚ö†Ô∏è Please select at least one path set to scan');
                return;
            }

            if (!apiKey || !apiSecret) {
                console.error('‚ùå [GEMINI Worker] Missing API credentials');
                alert('‚ö†Ô∏è Please configure your Gemini API credentials first');
                return;
            }

            await initializeGeminiBalance();

            let currentSetIndex = 0;

            const setNameMapping = {
                1: 'SET_1_BTC_ETH_DIRECT',
                2: 'SET_2_DOGE_BRIDGE',
                3: 'SET_3_LINK_BRIDGE',
                4: 'SET_4_LTC_BRIDGE',
                5: 'SET_5_SOL_BRIDGE'
            };

            // Sequential scan function - scans ONE set at a time
            async function scanAndExecuteSequential() {
                try {
                    const currentSetNum = selectedSets[currentSetIndex];
                    const currentSet = `SET ${currentSetNum}`;
                    const backendSetName = setNameMapping[currentSetNum];
                    geminiWorkerStats.totalScans++;

                    console.log(`\nüîç [GEMINI Worker] Scan #${geminiWorkerStats.totalScans}: ${currentSet} (${currentSetIndex + 1}/${selectedSets.length})`);

                    const portfolioPercent = parseFloat(document.getElementById('geminiPortfolioPercent')?.value || 10);
                    const profitThresholdUI = parseFloat(document.getElementById('geminiProfitThreshold')?.value || 0.5);

                    // Scan ONE set only
                    const enabledSets = {};
                    enabledSets[backendSetName] = true;

                    const scanResponse = await fetch(`${API_BASE}/trading/gemini/triangular/scan`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            apiKey,
                            apiSecret,
                            enabledSets: enabledSets,
                            maxTradeAmount: maxTradeAmount,
                            profitThreshold: profitThresholdUI,
                            portfolioPercent: portfolioPercent
                        })
                    });

                    const scanResult = await scanResponse.json();

                    if (scanResult.success && scanResult.opportunities) {
                        const paths = scanResult.opportunities;
                        console.log(`‚úÖ [GEMINI Worker] ${currentSet}: Analyzed ${scanResult.scanned} paths, found ${paths.length} opportunities`);

                        // Log detailed profit for each path
                        paths.forEach((path, index) => {
                            const profitPct = parseFloat(path.profitPercent);
                            const profitSign = profitPct >= 0 ? '+' : '';
                            const profitColor = profitPct >= profitThreshold ? 'üíé' :
                                              profitPct >= 0 ? 'üíõ' : '‚ùå';
                            const status = profitPct >= profitThreshold ? 'OPPORTUNITY' :
                                         profitPct >= 0 ? 'below threshold' : 'unprofitable';
                            console.log(`   ${profitColor} Path ${index + 1}: ${profitSign}${profitPct.toFixed(2)}% (${status})`);
                        });

                        const profitable = paths.filter(opp => parseFloat(opp.profitPercent) >= profitThreshold);
                        geminiWorkerStats.totalOpportunities += profitable.length;

                        if (profitable.length > 0) {
                            console.log(`üí∞ [GEMINI Worker] ${currentSet}: ${profitable.length} OPPORTUNITIES above ${profitThreshold}% threshold`);
                            profitable.forEach(opp => {
                                console.log(`‚ö° [GEMINI Worker] Opportunity: ${opp.pathId} (${parseFloat(opp.profitPercent).toFixed(2)}% profit) - execution available`);
                            });
                        }
                    }

                    // Move to next set (circular)
                    currentSetIndex = (currentSetIndex + 1) % selectedSets.length;

                    if (currentSetIndex === 0) {
                        console.log(`üîÑ [GEMINI Worker] Completed full cycle of ${selectedSets.length} sets. Restarting...`);
                        await updateGeminiBalance();
                    }

                } catch (error) {
                    console.error('‚ùå [GEMINI Worker] Scan error:', error);
                    handleGeminiExecutionError(error, null);
                }
            }

            // Start sequential scanning with 8-second intervals
            geminiWorkerInterval = setInterval(scanAndExecuteSequential, 8000);

            console.log('‚úÖ [GEMINI Worker] Automated trading started (8s between sets, sequential scanning)');
        }

        // Stop Gemini Worker
        function stopGeminiWorker() {
            if (geminiWorkerInterval) {
                clearInterval(geminiWorkerInterval);
                geminiWorkerInterval = null;
                console.log('‚èπÔ∏è [GEMINI Worker] Automated trading stopped');
            }
        }

        // Handle Gemini Execution Errors
        function handleGeminiExecutionError(error, pathId) {
            console.error('‚ùå [GEMINI Worker] Execution error:', {
                pathId,
                error: error.message,
                timestamp: new Date().toISOString()
            });
            // Non-blocking - worker continues
        }

        // Save Gemini Settings
        function saveGeminiTriangularSettings() {
            const settings = {
                maxTrade: document.getElementById('geminiMaxTrade').value,
                portfolioPercent: document.getElementById('geminiPortfolioPercent').value,
                profitThreshold: document.getElementById('geminiProfitThreshold').value,
                set1Enabled: document.getElementById('geminiSet1Enabled').checked,
                set2Enabled: document.getElementById('geminiSet2Enabled').checked,
                set3Enabled: document.getElementById('geminiSet3Enabled').checked,
                set4Enabled: document.getElementById('geminiSet4Enabled').checked,
                set5Enabled: document.getElementById('geminiSet5Enabled').checked
            };
            localStorage.setItem('gemini_triangular_settings', JSON.stringify(settings));
            console.log('üíé [GEMINI] Settings saved:', settings);
        }

        // Load Gemini Settings
        function loadGeminiTriangularSettings() {
            try {
                const saved = localStorage.getItem('gemini_triangular_settings');
                if (saved) {
                    const settings = JSON.parse(saved);

                    if (settings.maxTrade) document.getElementById('geminiMaxTrade').value = settings.maxTrade;
                    if (settings.portfolioPercent) document.getElementById('geminiPortfolioPercent').value = settings.portfolioPercent;
                    if (settings.profitThreshold) document.getElementById('geminiProfitThreshold').value = settings.profitThreshold;

                    if (settings.set1Enabled !== undefined) document.getElementById('geminiSet1Enabled').checked = settings.set1Enabled;
                    if (settings.set2Enabled !== undefined) document.getElementById('geminiSet2Enabled').checked = settings.set2Enabled;
                    if (settings.set3Enabled !== undefined) document.getElementById('geminiSet3Enabled').checked = settings.set3Enabled;
                    if (settings.set4Enabled !== undefined) document.getElementById('geminiSet4Enabled').checked = settings.set4Enabled;
                    if (settings.set5Enabled !== undefined) document.getElementById('geminiSet5Enabled').checked = settings.set5Enabled;

                    console.log('üíé [GEMINI] Settings loaded:', settings);
                }
            } catch (error) {
                console.error('üíé [GEMINI] Error loading settings:', error);
            }
        }

        // Load Gemini Trade History
        async function loadGeminiTradeHistory() {
            const userId = localStorage.getItem('userId');

            if (!userId) {
                return;
            }

            try {
                const response = await fetch('/api/v1/trading/gemini/triangular/history', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId, limit: 20 })
                });

                const data = await response.json();

                if (data.success && data.trades.length > 0) {
                    let historyHtml = '<div style="display: grid; gap: 10px;">';

                    data.trades.forEach(trade => {
                        const profitColor = trade.profit >= 0 ? '#00FF00' : '#FF4444';

                        historyHtml += `
                            <div style="padding: 12px; background: rgba(0,0,0,0.3); border-radius: 8px; border-left: 3px solid ${profitColor};">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <div style="color: #00AADD; font-weight: 600;">${trade.path_id}</div>
                                        <div style="color: #888; font-size: 12px;">${trade.path_description}</div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="color: ${profitColor}; font-weight: 600;">${trade.profit_percent?.toFixed(3)}%</div>
                                        <div style="color: #888; font-size: 12px;">$${trade.profit?.toFixed(2)}</div>
                                    </div>
                                </div>
                                <div style="color: #888; font-size: 12px;">${new Date(trade.created_at).toLocaleString()}</div>
                            </div>
                        `;
                    });

                    historyHtml += '</div>';
                    document.getElementById('geminiTradeHistory').innerHTML = historyHtml;
                }
            } catch (error) {
                console.error('Gemini history error:', error);
            }
        }

        // Initialize Gemini settings on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üíé [GEMINI] Initializing triangular arbitrage settings...');
            loadGeminiTriangularSettings();

            // Initialize balance tracking
            initializeGeminiBalance();

            // Set default tab to Balance Tracker
            switchGeminiTab('balance');

            // Restore toggle state
            const toggleEnabled = localStorage.getItem('geminiTriangularEnabled') === 'true';
            const toggle = document.getElementById('geminiTriangularEnabled');
            const status = document.getElementById('geminiTriangularStatus');
            if (toggle && status) {
                if (toggleEnabled) {
                    toggle.classList.add('active');
                    status.textContent = 'ON';
                    status.style.color = '#00AADD';
                } else {
                    toggle.classList.remove('active');
                    status.textContent = 'OFF';
                    status.style.color = '#ff6b6b';
                }
            }

            const geminiInputs = document.querySelectorAll('#geminiMaxTrade, #geminiPortfolioPercent, #geminiProfitThreshold');
            geminiInputs.forEach(input => {
                input.addEventListener('change', saveGeminiTriangularSettings);
            });

            for (let i = 1; i <= 5; i++) {
                const checkbox = document.getElementById(`geminiSet${i}Enabled`);
                if (checkbox) {
                    checkbox.addEventListener('change', saveGeminiTriangularSettings);
                }
            }
        });

        // ============================================================================
        // COINCATCH TRIANGULAR ARBITRAGE FUNCTIONS (FINAL EXCHANGE - 21/21)
        // ============================================================================

        // Worker variables
        let coincatchWorkerInterval = null;
        let coincatchWorkerStats = {
            totalScans: 0,
            totalOpportunities: 0,
            totalTrades: 0,
            successfulTrades: 0,
            totalProfit: 0,
            bestProfit: 0,
            bestPath: null,
            lastScanTime: null
        };

        // 1. Toggle Coincatch Triangular Arbitrage
        function toggleCoincatchTriangular() {
            const toggle = document.getElementById('coincatchTriangularEnabled');
            const status = document.getElementById('coincatchTriangularStatus');
            const isActive = toggle.classList.toggle('active');

            if (isActive) {
                status.textContent = 'ON';
                status.style.color = '#FF5722';
                localStorage.setItem('coincatchTriangularEnabled', 'true');
                console.log('üéØ [COINCATCH] Triangular arbitrage enabled - starting worker...');
                startCoincatchWorker();
            } else {
                status.textContent = 'OFF';
                status.style.color = '#ff6b6b';
                localStorage.setItem('coincatchTriangularEnabled', 'false');
                console.log('üéØ [COINCATCH] Triangular arbitrage disabled - stopping worker...');
                stopCoincatchWorker();
            }
        }

        // 2. View Coincatch Path Details (Professional Modal with 5 color-coded sets)
        function viewCoincatchPathDetails() {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: flex; justify-content: center; align-items: center; z-index: 10000; backdrop-filter: blur(8px);';

            modal.innerHTML = `
                <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); padding: 30px; border-radius: 20px; max-width: 900px; max-height: 85vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(255,87,34,0.4); border: 2px solid rgba(255,87,34,0.3);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid rgba(255,87,34,0.3);">
                        <h2 style="color: #FF5722; margin: 0; font-size: 24px; font-weight: 700;">üéØ Coincatch Triangular Arbitrage Paths (32 Total)</h2>
                        <button onclick="this.closest('div[style*=fixed]').remove()" style="background: rgba(255,87,34,0.2); color: #FF5722; border: 1px solid #FF5722; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px;">
                            ‚úï Close
                        </button>
                    </div>

                    <!-- SET 1: BTC-ETH Direct (2 paths - 3-leg) -->
                    <div style="margin-bottom: 25px; padding: 20px; background: rgba(255,87,34,0.1); border-left: 4px solid #FF5722; border-radius: 10px;">
                        <h3 style="color: #FF5722; margin: 0 0 15px 0; font-size: 18px;">üéØ SET 1: BTC-ETH Direct (2 paths)</h3>
                        <p style="color: #b8c6db; margin: 0 0 15px 0; font-size: 13px;">Direct BTC-ETH bridge using ETHBTC_SPBL cross pair (3-leg)</p>
                        <div style="display: grid; gap: 10px; font-size: 13px;">
                            <div style="padding: 10px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                                <div style="color: #FF5722; font-weight: 600; margin-bottom: 4px;">COINCATCH_BTCETH_1</div>
                                <div style="color: #888;">USDT ‚Üí BTC ‚Üí ETH ‚Üí USDT</div>
                            </div>
                            <div style="padding: 10px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                                <div style="color: #FF5722; font-weight: 600; margin-bottom: 4px;">COINCATCH_ETHBTC_1</div>
                                <div style="color: #888;">USDT ‚Üí ETH ‚Üí BTC ‚Üí USDT</div>
                            </div>
                        </div>
                    </div>

                    <!-- SET 2: GMT-BTC Bridge (2 paths - 3-leg) -->
                    <div style="margin-bottom: 25px; padding: 20px; background: rgba(255,152,0,0.1); border-left: 4px solid #FF9800; border-radius: 10px;">
                        <h3 style="color: #FF9800; margin: 0 0 15px 0; font-size: 18px;">üöÄ SET 2: GMT-BTC Bridge (2 paths)</h3>
                        <p style="color: #b8c6db; margin: 0 0 15px 0; font-size: 13px;">GMT-BTC bridge using GMTBTC_SPBL cross pair (3-leg)</p>
                        <div style="display: grid; gap: 10px; font-size: 13px;">
                            <div style="padding: 10px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                                <div style="color: #FF9800; font-weight: 600; margin-bottom: 4px;">COINCATCH_GMT_1</div>
                                <div style="color: #888;">USDT ‚Üí BTC ‚Üí GMT ‚Üí USDT</div>
                            </div>
                            <div style="padding: 10px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                                <div style="color: #FF9800; font-weight: 600; margin-bottom: 4px;">COINCATCH_GMT_2</div>
                                <div style="color: #888;">USDT ‚Üí GMT ‚Üí BTC ‚Üí USDT</div>
                            </div>
                        </div>
                    </div>

                    <!-- SET 3: Major 4-Leg (8 paths) -->
                    <div style="margin-bottom: 25px; padding: 20px; background: rgba(255,193,7,0.1); border-left: 4px solid #FFC107; border-radius: 10px;">
                        <h3 style="color: #FFC107; margin: 0 0 15px 0; font-size: 18px;">‚ö° SET 3: Major 4-Leg (8 paths)</h3>
                        <p style="color: #b8c6db; margin: 0 0 15px 0; font-size: 13px;">BTC-ETH, BTC-SOL, BTC-LINK, ETH-SOL, ETH-LINK, ETH-AVAX, SOL-LINK, SOL-UNI cycles (4-leg)</p>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 12px;">
                            <div style="padding: 8px; background: rgba(0,0,0,0.3); border-radius: 6px; color: #888;">BTC ‚áÑ ETH</div>
                            <div style="padding: 8px; background: rgba(0,0,0,0.3); border-radius: 6px; color: #888;">BTC ‚áÑ SOL</div>
                            <div style="padding: 8px; background: rgba(0,0,0,0.3); border-radius: 6px; color: #888;">BTC ‚áÑ LINK</div>
                            <div style="padding: 8px; background: rgba(0,0,0,0.3); border-radius: 6px; color: #888;">ETH ‚áÑ SOL</div>
                            <div style="padding: 8px; background: rgba(0,0,0,0.3); border-radius: 6px; color: #888;">ETH ‚áÑ LINK</div>
                            <div style="padding: 8px; background: rgba(0,0,0,0.3); border-radius: 6px; color: #888;">ETH ‚áÑ AVAX</div>
                            <div style="padding: 8px; background: rgba(0,0,0,0.3); border-radius: 6px; color: #888;">SOL ‚áÑ LINK</div>
                            <div style="padding: 8px; background: rgba(0,0,0,0.3); border-radius: 6px; color: #888;">SOL ‚áÑ UNI</div>
                        </div>
                    </div>

                    <!-- SET 4: Altcoin 4-Leg (10 paths) -->
                    <div style="margin-bottom: 25px; padding: 20px; background: rgba(139,195,74,0.1); border-left: 4px solid #8BC34A; border-radius: 10px;">
                        <h3 style="color: #8BC34A; margin: 0 0 15px 0; font-size: 18px;">ü™ô SET 4: Altcoin 4-Leg (10 paths)</h3>
                        <p style="color: #b8c6db; margin: 0 0 15px 0; font-size: 13px;">DOGE, LINK, AVAX, DOT, ATOM, ADA, LTC, XRP, UNI, BNB cycles (4-leg)</p>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 12px;">
                            <div style="padding: 8px; background: rgba(0,0,0,0.3); border-radius: 6px; color: #888;">DOGE ‚áÑ XRP</div>
                            <div style="padding: 8px; background: rgba(0,0,0,0.3); border-radius: 6px; color: #888;">LINK ‚áÑ UNI</div>
                            <div style="padding: 8px; background: rgba(0,0,0,0.3); border-radius: 6px; color: #888;">AVAX ‚áÑ ATOM</div>
                            <div style="padding: 8px; background: rgba(0,0,0,0.3); border-radius: 6px; color: #888;">DOT ‚áÑ UNI</div>
                            <div style="padding: 8px; background: rgba(0,0,0,0.3); border-radius: 6px; color: #888;">ATOM ‚áÑ LINK</div>
                            <div style="padding: 8px; background: rgba(0,0,0,0.3); border-radius: 6px; color: #888;">ADA ‚áÑ DOT</div>
                            <div style="padding: 8px; background: rgba(0,0,0,0.3); border-radius: 6px; color: #888;">LTC ‚áÑ BCH</div>
                            <div style="padding: 8px; background: rgba(0,0,0,0.3); border-radius: 6px; color: #888;">XRP ‚áÑ TRX</div>
                            <div style="padding: 8px; background: rgba(0,0,0,0.3); border-radius: 6px; color: #888;">UNI ‚áÑ AAVE</div>
                            <div style="padding: 8px; background: rgba(0,0,0,0.3); border-radius: 6px; color: #888;">BNB ‚áÑ OP</div>
                        </div>
                    </div>

                    <!-- SET 5: Extended 4-Leg (12 paths) -->
                    <div style="margin-bottom: 0; padding: 20px; background: rgba(33,150,243,0.1); border-left: 4px solid #2196F3; border-radius: 10px;">
                        <h3 style="color: #2196F3; margin: 0 0 15px 0; font-size: 18px;">üíé SET 5: Extended 4-Leg (12 paths)</h3>
                        <p style="color: #b8c6db; margin: 0 0 15px 0; font-size: 13px;">Meme coins, L2 tokens, DeFi tokens cycles (4-leg)</p>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 12px;">
                            <div style="padding: 8px; background: rgba(0,0,0,0.3); border-radius: 6px; color: #888;">PEPE ‚áÑ SHIB</div>
                            <div style="padding: 8px; background: rgba(0,0,0,0.3); border-radius: 6px; color: #888;">APT ‚áÑ SUI</div>
                            <div style="padding: 8px; background: rgba(0,0,0,0.3); border-radius: 6px; color: #888;">INJ ‚áÑ OP</div>
                            <div style="padding: 8px; background: rgba(0,0,0,0.3); border-radius: 6px; color: #888;">ARB ‚áÑ OP</div>
                            <div style="padding: 8px; background: rgba(0,0,0,0.3); border-radius: 6px; color: #888;">FIL ‚áÑ ICP</div>
                            <div style="padding: 8px; background: rgba(0,0,0,0.3); border-radius: 6px; color: #888;">COMP ‚áÑ AAVE</div>
                            <div style="padding: 8px; background: rgba(0,0,0,0.3); border-radius: 6px; color: #888;">SNX ‚áÑ CRV</div>
                            <div style="padding: 8px; background: rgba(0,0,0,0.3); border-radius: 6px; color: #888;">GALA ‚áÑ MANA</div>
                            <div style="padding: 8px; background: rgba(0,0,0,0.3); border-radius: 6px; color: #888;">FLOKI ‚áÑ PEPE</div>
                            <div style="padding: 8px; background: rgba(0,0,0,0.3); border-radius: 6px; color: #888;">GRT ‚áÑ LDO</div>
                            <div style="padding: 8px; background: rgba(0,0,0,0.3); border-radius: 6px; color: #888;">APE ‚áÑ SAND</div>
                            <div style="padding: 8px; background: rgba(0,0,0,0.3); border-radius: 6px; color: #888;">CHZ ‚áÑ STORJ</div>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }

        // 3. Switch Coincatch Tab
        function switchCoincatchTab(tab) {
            const balanceBtn = document.getElementById('coincatchTabBalance');
            const tradingBtn = document.getElementById('coincatchTabTrading');
            const balanceContent = document.getElementById('coincatchBalanceContent');
            const tradingContent = document.getElementById('coincatchTradingContent');

            if (tab === 'balance') {
                balanceBtn.style.background = 'rgba(255,87,34,0.3)';
                balanceBtn.style.color = '#FF5722';
                balanceBtn.style.border = '1px solid #FF5722';
                balanceBtn.style.fontWeight = 'bold';

                tradingBtn.style.background = 'rgba(255,255,255,0.05)';
                tradingBtn.style.color = '#888';
                tradingBtn.style.border = '1px solid #555';
                tradingBtn.style.fontWeight = 'normal';

                balanceContent.style.display = 'block';
                tradingContent.style.display = 'none';
            } else {
                balanceBtn.style.background = 'rgba(255,255,255,0.05)';
                balanceBtn.style.color = '#888';
                balanceBtn.style.border = '1px solid #555';
                balanceBtn.style.fontWeight = 'normal';

                tradingBtn.style.background = 'rgba(255,87,34,0.3)';
                tradingBtn.style.color = '#FF5722';
                tradingBtn.style.border = '1px solid #FF5722';
                tradingBtn.style.fontWeight = 'bold';

                balanceContent.style.display = 'none';
                tradingContent.style.display = 'block';
            }
        }

        // 4. Balance Tracking State
        const coincatchBalanceTracking = {
            starting: 0,
            current: 0,
            initialized: false
        };

        // 5. Initialize Coincatch Balance (Auto-fetch on page load)
        async function initializeCoincatchBalance() {
            const apiKey = localStorage.getItem('coincatch_api') || '';
            const apiSecret = localStorage.getItem('coincatch_secret') || '';
            const passphrase = localStorage.getItem('coincatch_passphrase') || '';

            if (!apiKey || !apiSecret || !passphrase) {
                console.log('üéØ [COINCATCH] No API credentials - skipping auto-fetch');
                return;
            }

            try {
                const response = await fetch('/api/v1/trading/coincatch/balance', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ apiKey, apiSecret, passphrase, currency: 'USDT' })
                });

                const data = await response.json();

                if (data.success) {
                    const balance = Number(data.balance) || 0;

                    if (!coincatchBalanceTracking.initialized) {
                        coincatchBalanceTracking.starting = balance;
                        coincatchBalanceTracking.current = balance;
                        coincatchBalanceTracking.initialized = true;
                        console.log(`üéØ [COINCATCH] Balance initialized: ${balance} USDT`);
                    } else {
                        coincatchBalanceTracking.current = balance;
                    }

                    updateCoincatchBalanceDisplay();
                }
            } catch (error) {
                console.error('üéØ [COINCATCH] Auto-fetch failed:', error);
            }
        }

        // 6. Update Coincatch Balance (Manual Refresh)
        async function updateCoincatchBalance() {
            const apiKey = localStorage.getItem('coincatch_api') || '';
            const apiSecret = localStorage.getItem('coincatch_secret') || '';
            const passphrase = localStorage.getItem('coincatch_passphrase') || '';

            if (!apiKey || !apiSecret || !passphrase) {
                alert('‚ö†Ô∏è Please configure your Coincatch API credentials on the Exchange Connections page first.');
                return;
            }

            try {
                const response = await fetch('/api/v1/trading/coincatch/balance', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ apiKey, apiSecret, passphrase, currency: 'USDT' })
                });

                const data = await response.json();

                if (data.success) {
                    const balance = Number(data.balance) || 0;

                    if (!coincatchBalanceTracking.initialized) {
                        coincatchBalanceTracking.starting = balance;
                        coincatchBalanceTracking.initialized = true;
                    }

                    coincatchBalanceTracking.current = balance;
                    updateCoincatchBalanceDisplay();

                    console.log(`üéØ [COINCATCH] Balance updated: ${balance} USDT`);
                } else {
                    alert(`‚ùå Failed to fetch balance: ${data.error}`);
                }
            } catch (error) {
                console.error('üéØ [COINCATCH] Balance fetch error:', error);
                alert('‚ùå Network error while fetching balance');
            }
        }

        // 7. Update Coincatch Balance Display (with NaN prevention)
        function updateCoincatchBalanceDisplay() {
            const starting = Number(coincatchBalanceTracking.starting) || 0;
            const current = Number(coincatchBalanceTracking.current) || 0;
            const change = current - starting;
            const changePercent = starting > 0 ? ((change / starting) * 100) : 0;

            document.getElementById('coincatchStartingUSDT').textContent = `${starting.toFixed(2)} USDT`;
            document.getElementById('coincatchCurrentUSDT').textContent = `${current.toFixed(2)} USDT`;

            const changeDisplay = document.getElementById('coincatchChangeUSDT');
            const changeSign = change >= 0 ? '+' : '';
            const changeColor = change >= 0 ? '#00d26a' : '#FF4444';

            changeDisplay.textContent = `${changeSign}${change.toFixed(2)} USDT (${changeSign}${changePercent.toFixed(2)}%)`;
            changeDisplay.style.color = changeColor;
        }

        // 8. Reset Coincatch Starting Balance
        function resetCoincatchStartingBalance() {
            if (!confirm('Reset starting balance to current balance? This will reset your P&L tracking.')) {
                return;
            }

            coincatchBalanceTracking.starting = coincatchBalanceTracking.current;
            updateCoincatchBalanceDisplay();

            console.log(`üéØ [COINCATCH] Starting balance reset to ${coincatchBalanceTracking.starting} USDT`);
            alert('‚úÖ Starting balance has been reset to current balance');
        }

        // 9. Clear Coincatch History
        function clearCoincatchHistory() {
            if (!confirm('Clear all opportunity history?')) {
                return;
            }

            document.getElementById('coincatchOpportunities').innerHTML = '<div style="color: #666; font-size: 13px; text-align: center; padding: 20px;">No active opportunities. Run a scan to discover paths.</div>';
            document.getElementById('coincatchScanStatus').textContent = 'Click "Scan Opportunities" to find profitable paths';

            console.log('üéØ [COINCATCH] Opportunity history cleared');
            alert('‚úÖ Opportunity history cleared');
        }

        // 10. Scan Coincatch Triangular Paths
        async function scanCoincatchTriangularPaths() {
            const apiKey = localStorage.getItem('coincatch_api') || '';
            const apiSecret = localStorage.getItem('coincatch_secret') || '';
            const passphrase = localStorage.getItem('coincatch_passphrase') || '';
            const profitThreshold = parseFloat(document.getElementById('coincatchProfitThreshold').value);
            const maxTradeAmount = parseFloat(document.getElementById('coincatchMaxTrade').value);
            const portfolioPercent = parseFloat(document.getElementById('coincatchPortfolioPercent').value);
            const scanStatus = document.getElementById('coincatchScanStatus');
            const opportunitiesDiv = document.getElementById('coincatchOpportunities');

            if (!apiKey || !apiSecret || !passphrase) {
                alert('‚ö†Ô∏è Please configure your Coincatch API credentials on the Exchange Connections page first.');
                return;
            }

            scanStatus.textContent = 'üîÑ Scanning 32 triangular paths...';
            scanStatus.style.color = '#FFA500';
            opportunitiesDiv.innerHTML = '<div style="text-align: center; color: #888; padding: 20px;">Scanning for opportunities...</div>';

            try {
                const enabledSets = {};
                for (let i = 1; i <= 5; i++) {
                    const checkbox = document.getElementById(`coincatchSet${i}Enabled`);
                    if (checkbox && checkbox.checked) {
                        const setNames = ['BTC_ETH_DIRECT', 'GMT_BTC_BRIDGE', 'MAJOR_4LEG', 'ALTCOIN_4LEG', 'EXTENDED_4LEG'];
                        enabledSets[`SET_${i}_${setNames[i - 1]}`] = true;
                    }
                }

                const response = await fetch('/api/v1/trading/coincatch/triangular/scan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        apiKey,
                        apiSecret,
                        passphrase,
                        profitThreshold,
                        maxTradeAmount,
                        portfolioPercent,
                        enabledSets
                    })
                });

                const data = await response.json();

                if (data.success) {
                    scanStatus.textContent = `‚úÖ Found ${data.profitableCount} opportunities (scanned ${data.scanned} paths)`;
                    scanStatus.style.color = '#00FF00';

                    if (data.profitableCount === 0) {
                        opportunitiesDiv.innerHTML = '<div style="text-align: center; color: #888; padding: 20px;">No opportunities found above profit threshold</div>';
                        return;
                    }

                    let html = '<div style="display: grid; gap: 15px;">';
                    data.opportunities.forEach(opp => {
                        const profitColor = parseFloat(opp.profitPercent) >= 1.0 ? '#00FF00' : '#FFA500';

                        html += `
                            <div style="padding: 15px; background: rgba(0,0,0,0.3); border-radius: 10px; border-left: 3px solid ${profitColor};">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <div>
                                        <div style="color: #FF5722; font-weight: 600; font-size: 14px;">${opp.pathId}</div>
                                        <div style="color: #888; font-size: 12px;">${opp.description}</div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="color: ${profitColor}; font-weight: 700; font-size: 18px;">+${opp.profitPercent}%</div>
                                        <div style="color: #888; font-size: 12px;">$${opp.profitAmount} profit</div>
                                    </div>
                                </div>
                                <div style="color: #888; font-size: 12px; margin-bottom: 8px;">
                                    ${opp.path.join(' ‚Üí ')}
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 11px; color: #666;">
                                    <div>Initial: $${opp.initialAmount}</div>
                                    <div>Final: $${opp.finalAmount}</div>
                                </div>
                                <button onclick="executeCoincatchTriangularTrade('${opp.pathId}')"
                                    style="margin-top: 10px; width: 100%; padding: 8px; background: #FF5722; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; font-size: 13px;">
                                    ‚ö° Execute Trade
                                </button>
                            </div>
                        `;
                    });
                    html += '</div>';

                    opportunitiesDiv.innerHTML = html;
                    console.log(`üéØ [COINCATCH] Scan complete: ${data.profitableCount} opportunities found`);

                } else {
                    scanStatus.textContent = '‚ùå Scan failed';
                    scanStatus.style.color = '#FF4444';
                    opportunitiesDiv.innerHTML = `<div style="text-align: center; color: #FF4444; padding: 20px;">Error: ${data.error || 'Scan failed'}</div>`;
                }

            } catch (error) {
                console.error('üéØ [COINCATCH] Scan error:', error);
                scanStatus.textContent = '‚ùå Scan error';
                scanStatus.style.color = '#FF4444';
                opportunitiesDiv.innerHTML = `<div style="text-align: center; color: #FF4444; padding: 20px;">Error: ${error.message}</div>`;
            }
        }

        // 11. Execute Coincatch Triangular Trade
        async function executeCoincatchTriangularTrade(pathId) {
            try {
                const apiKey = localStorage.getItem('coincatch_api') || '';
                const apiSecret = localStorage.getItem('coincatch_secret') || '';
                const passphrase = localStorage.getItem('coincatch_passphrase') || '';
                const maxTradeAmount = parseFloat(document.getElementById('coincatchMaxTrade').value);

                if (!apiKey || !apiSecret || !passphrase) {
                    alert('‚ö†Ô∏è Please configure your Coincatch API credentials first.');
                    return;
                }

                if (!confirm(`‚ö†Ô∏è REAL MONEY TRADING ‚ö†Ô∏è\n\nExecute REAL triangular arbitrage trade?\n\nPath: ${pathId}\nAmount: $${maxTradeAmount} USDT\n\nThis will execute REAL market orders on Coincatch.\nClick OK to proceed.`)) {
                    return;
                }

                console.log(`üéØ [COINCATCH] Executing REAL trade: ${pathId}`);

                const response = await fetch(`${API_BASE}/trading/coincatch/triangular/execute`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        apiKey,
                        apiSecret,
                        passphrase,
                        pathId,
                        amount: maxTradeAmount
                    })
                });

                const result = await response.json();

                if (result.success && result.data) {
                    const execution = result.data;
                    const profit = execution.actualProfit || 0;
                    const profitPct = execution.actualProfitPercentage || 0;
                    const status = execution.status || 'UNKNOWN';

                    if (status === 'COMPLETED') {
                        alert(`‚úÖ Trade Executed Successfully!\n\nExecution ID: ${execution.executionId}\nPath: ${pathId}\nStart Amount: $${execution.startAmount}\nEnd Amount: $${execution.endAmount}\nProfit: $${profit.toFixed(2)} (${profitPct.toFixed(2)}%)\nLegs Completed: ${execution.legs?.length || 0}/3\n\nAll 3 legs executed atomically.`);

                        console.log('‚úÖ [COINCATCH] Trade executed successfully:', execution);

                        // üìä Log to backend using shared service
                        logTriangularTrade('Coincatch', pathId, profit, maxTradeAmount, execution.totalFees || 0).catch(e => console.warn('Logging failed:', e));

                        // Update stats
                        coincatchWorkerStats.totalTrades++;
                        coincatchWorkerStats.successfulTrades++;
                        coincatchWorkerStats.totalProfit += profit;

                        // Update balance after execution
                        await updateCoincatchBalance();

                        // Refresh opportunities
                        await scanCoincatchTriangularPaths();
                    } else {
                        alert(`‚ùå Trade Execution Failed\n\nExecution ID: ${execution.executionId}\nStatus: ${status}\nError: ${execution.error || 'Unknown error'}\nCompleted Legs: ${execution.legs?.filter(l => l.status === 'COMPLETED').length || 0}/3`);
                        console.error('‚ùå [COINCATCH] Trade execution failed:', execution);
                    }
                } else {
                    alert(`‚ùå Trade Execution Failed\n\n${result.message || result.error || 'Unknown error'}`);
                    console.error('‚ùå [COINCATCH] Trade execution failed:', result);
                }

            } catch (error) {
                console.error('‚ùå [COINCATCH] Trade execution error:', error);
                alert(`‚ùå Error executing trade: ${error.message}`);
            }
        }

        // ============================================================================
        // WORKER FUNCTIONS (Sequential Scanning)
        // ============================================================================

        // Start Coincatch Worker (Sequential Scanning - One Set at a Time)
        async function startCoincatchWorker() {
            console.log('üöÄ [COINCATCH Worker] Starting automated trading (sequential mode)...');

            // Read settings from card
            const apiKey = localStorage.getItem('coincatch_api') || '';
            const apiSecret = localStorage.getItem('coincatch_secret') || '';
            const passphrase = localStorage.getItem('coincatch_passphrase') || '';
            const profitThreshold = parseFloat(document.getElementById('coincatchProfitThreshold')?.value) || 0.5;
            const maxTradeAmount = parseFloat(document.getElementById('coincatchMaxTrade')?.value) || 1000;

            // Get selected path sets (5 sets available)
            const selectedSets = [];
            for (let i = 1; i <= 5; i++) {
                const checkbox = document.getElementById(`coincatchSet${i}Enabled`);
                if (checkbox && checkbox.checked) {
                    selectedSets.push(i);
                }
            }

            if (selectedSets.length === 0) {
                console.error('‚ùå [COINCATCH Worker] No sets selected!');
                alert('‚ö†Ô∏è Please select at least one path set to scan');
                return;
            }

            if (!apiKey || !apiSecret || !passphrase) {
                console.error('‚ùå [COINCATCH Worker] Missing API credentials');
                alert('‚ö†Ô∏è Please configure your Coincatch API credentials first');
                return;
            }

            console.log(`üìä [COINCATCH Worker] Configuration:`, {
                profitThreshold: `${profitThreshold}%`,
                maxTradeAmount: `$${maxTradeAmount}`,
                selectedSets: selectedSets.length,
                scanMode: 'Sequential (one set at a time)'
            });

            // Initialize balance tracking
            await initializeCoincatchBalance();

            let currentSetIndex = 0;

            // Set name mapping for backend
            const setNameMapping = {
                1: 'SET_1_BTC_ETH_DIRECT',
                2: 'SET_2_GMT_BTC_BRIDGE',
                3: 'SET_3_MAJOR_4LEG',
                4: 'SET_4_ALTCOIN_4LEG',
                5: 'SET_5_EXTENDED_4LEG'
            };

            // Sequential scan-and-execute function (one set per call)
            async function scanAndExecuteSequential() {
                try {
                    // Get current set to scan
                    const currentSetNum = selectedSets[currentSetIndex];
                    const currentSet = `SET ${currentSetNum}`;
                    const backendSetName = setNameMapping[currentSetNum];
                    coincatchWorkerStats.totalScans++;

                    console.log(`\nüîç [COINCATCH Worker] Scan #${coincatchWorkerStats.totalScans}: ${currentSet} (${currentSetIndex + 1}/${selectedSets.length})`);

                    // Get risk settings from UI
                    const portfolioPercent = parseFloat(document.getElementById('coincatchPortfolioPercent')?.value || 10);
                    const profitThresholdUI = parseFloat(document.getElementById('coincatchProfitThreshold')?.value || 0.5);

                    // 1. Scan ONE set only
                    const enabledSets = {};
                    enabledSets[backendSetName] = true;

                    const scanResponse = await fetch(`${API_BASE}/trading/coincatch/triangular/scan`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            apiKey,
                            apiSecret,
                            passphrase,
                            enabledSets: enabledSets,
                            maxTradeAmount: maxTradeAmount,
                            profitThreshold: profitThresholdUI,
                            portfolioPercent: portfolioPercent
                        })
                    });

                    const scanResult = await scanResponse.json();

                    if (scanResult.success && scanResult.opportunities) {
                        const paths = scanResult.opportunities;
                        console.log(`‚úÖ [COINCATCH Worker] ${currentSet}: Analyzed ${scanResult.scanned} paths, found ${paths.length} opportunities`);

                        // Log detailed profit for each path
                        paths.forEach((path, index) => {
                            const profitPct = parseFloat(path.profitPercent);
                            const profitSign = profitPct >= 0 ? '+' : '';
                            const profitColor = profitPct >= profitThreshold ? 'üíö' :
                                              profitPct >= 0 ? 'üíõ' : '‚ùå';
                            const status = profitPct >= profitThreshold ? 'OPPORTUNITY' :
                                         profitPct >= 0 ? 'below threshold' : 'unprofitable';
                            console.log(`   ${profitColor} Path ${index + 1}: ${profitSign}${profitPct.toFixed(2)}% (${status})`);
                        });

                        // 2. Filter by profit threshold
                        const profitable = paths.filter(
                            opp => parseFloat(opp.profitPercent) >= profitThreshold
                        );

                        coincatchWorkerStats.totalOpportunities += profitable.length;

                        if (profitable.length > 0) {
                            console.log(`üí∞ [COINCATCH Worker] ${currentSet}: ${profitable.length} OPPORTUNITIES above ${profitThreshold}% threshold`);

                            // NOTE: Trade execution not implemented yet - just log opportunities
                            profitable.forEach(opp => {
                                console.log(`‚ö° [COINCATCH Worker] Opportunity: ${opp.pathId} (${parseFloat(opp.profitPercent).toFixed(2)}% profit) - execution pending implementation`);
                            });
                        } else {
                            console.log(`‚ÑπÔ∏è [COINCATCH Worker] ${currentSet}: No opportunities (all ${scanResult.scanned} paths below ${profitThreshold}% threshold)`);
                        }
                    } else {
                        console.log(`‚ÑπÔ∏è [COINCATCH Worker] ${currentSet}: Scan returned no opportunities`);
                    }

                    // Move to next set (circular)
                    currentSetIndex = (currentSetIndex + 1) % selectedSets.length;

                    // Log cycle completion
                    if (currentSetIndex === 0) {
                        console.log(`üîÑ [COINCATCH Worker] Completed full cycle of ${selectedSets.length} sets. Restarting...`);
                    }

                    // Update balance after each cycle
                    if (currentSetIndex === 0) {
                        await updateCoincatchBalance();
                    }

                } catch (error) {
                    console.error('‚ùå [COINCATCH Worker] Scan error:', error);
                    handleCoincatchExecutionError(error, null);
                }
            }

            // Start sequential scanning with 8-second intervals
            coincatchWorkerInterval = setInterval(scanAndExecuteSequential, 8000);

            console.log('‚úÖ [COINCATCH Worker] Automated trading started (8s between sets, sequential scanning)');
        }

        // Stop Coincatch Worker
        function stopCoincatchWorker() {
            if (coincatchWorkerInterval) {
                clearInterval(coincatchWorkerInterval);
                coincatchWorkerInterval = null;
                console.log('‚èπÔ∏è [COINCATCH Worker] Automated trading stopped');
            }
        }

        // Handle Coincatch Execution Errors
        function handleCoincatchExecutionError(error, opportunity) {
            const errorMessage = error.message || 'Unknown error';

            console.error(`‚ùå [COINCATCH Worker] Error: ${errorMessage}`, {
                opportunity: opportunity?.pathId || 'N/A',
                error: error
            });

            // Non-blocking - just log, don't stop worker
            // In production, could add to error log display
        }

        // 12. Save Coincatch Triangular Settings
        function saveCoincatchTriangularSettings() {
            try {
                const settings = {
                    maxTrade: document.getElementById('coincatchMaxTrade').value,
                    portfolioPercent: document.getElementById('coincatchPortfolioPercent').value,
                    profitThreshold: document.getElementById('coincatchProfitThreshold').value,
                    enabledSets: {
                        set1: document.getElementById('coincatchSet1Enabled').checked,
                        set2: document.getElementById('coincatchSet2Enabled').checked,
                        set3: document.getElementById('coincatchSet3Enabled').checked,
                        set4: document.getElementById('coincatchSet4Enabled').checked,
                        set5: document.getElementById('coincatchSet5Enabled').checked
                    }
                };

                localStorage.setItem('coincatch_triangular_settings', JSON.stringify(settings));
                console.log('üéØ [COINCATCH] Settings saved:', settings);
                alert('‚úÖ Settings saved successfully');
            } catch (error) {
                console.error('üéØ [COINCATCH] Error saving settings:', error);
                alert('‚ùå Failed to save settings');
            }
        }

        // 13. Load Coincatch Triangular Settings
        function loadCoincatchTriangularSettings() {
            try {
                const settings = JSON.parse(localStorage.getItem('coincatch_triangular_settings') || '{}');

                if (settings.maxTrade) {
                    document.getElementById('coincatchMaxTrade').value = settings.maxTrade;
                }

                if (settings.portfolioPercent) {
                    document.getElementById('coincatchPortfolioPercent').value = settings.portfolioPercent;
                }

                if (settings.profitThreshold) {
                    document.getElementById('coincatchProfitThreshold').value = settings.profitThreshold;
                }

                if (settings.enabledSets) {
                    document.getElementById('coincatchSet1Enabled').checked = settings.enabledSets.set1 !== false;
                    document.getElementById('coincatchSet2Enabled').checked = settings.enabledSets.set2 !== false;
                    document.getElementById('coincatchSet3Enabled').checked = settings.enabledSets.set3 || false;
                    document.getElementById('coincatchSet4Enabled').checked = settings.enabledSets.set4 || false;
                    document.getElementById('coincatchSet5Enabled').checked = settings.enabledSets.set5 || false;

                    console.log('üéØ [COINCATCH] Settings loaded:', settings);
                }
            } catch (error) {
                console.error('üéØ [COINCATCH] Error loading settings:', error);
            }
        }

        // Initialize Coincatch settings on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üéØ [COINCATCH] Initializing triangular arbitrage settings...');
            loadCoincatchTriangularSettings();

            // Initialize balance tracking
            initializeCoincatchBalance();

            // Set default tab to Balance Tracker
            switchCoincatchTab('balance');

            // Restore toggle state
            const toggleEnabled = localStorage.getItem('coincatchTriangularEnabled') === 'true';
            const toggle = document.getElementById('coincatchTriangularEnabled');
            const status = document.getElementById('coincatchTriangularStatus');
            if (toggle && status) {
                if (toggleEnabled) {
                    toggle.classList.add('active');
                    status.textContent = 'ON';
                    status.style.color = '#FF5722';
                } else {
                    toggle.classList.remove('active');
                    status.textContent = 'OFF';
                    status.style.color = '#ff6b6b';
                }
            }

            const coincatchInputs = document.querySelectorAll('#coincatchMaxTrade, #coincatchPortfolioPercent, #coincatchProfitThreshold');
            coincatchInputs.forEach(input => {
                input.addEventListener('change', saveCoincatchTriangularSettings);
            });

            for (let i = 1; i <= 5; i++) {
                const checkbox = document.getElementById(`coincatchSet${i}Enabled`);
                if (checkbox) {
                    checkbox.addEventListener('change', saveCoincatchTriangularSettings);
                }
            }
        });

        // End of Coincatch Triangular Arbitrage Functions (21/21 - COMPLETE!)

        // ============================================================================
        // EXCHANGE FILTER FUNCTIONALITY
        // ============================================================================

        const allExchanges = [
            { id: 'valr', name: 'VALR', icon: 'üíö' },
            { id: 'luno', name: 'LUNO', icon: 'üî∑' },
            { id: 'chainex', name: 'ChainEX', icon: 'üüß' },
            { id: 'kraken', name: 'Kraken', icon: 'üü£' },
            { id: 'bybit', name: 'ByBit', icon: 'üü°' },
            { id: 'binance', name: 'Binance', icon: 'üü°' },
            { id: 'okx', name: 'OKX', icon: 'üîµ' },
            { id: 'kucoin', name: 'KuCoin', icon: 'üü¢' },
            { id: 'huobi', name: 'HTX', icon: 'üî∑' },
            { id: 'gateio', name: 'Gate.io', icon: 'üåø' },
            { id: 'cryptocom', name: 'Crypto.com', icon: 'üíé' },
            { id: 'mexc', name: 'MEXC', icon: 'üü†' },
            { id: 'xt', name: 'XT.com', icon: 'üöÄ' },
            { id: 'ascendex', name: 'AscendEX', icon: 'üíé' },
            { id: 'bingx', name: 'BingX', icon: 'üåä' },
            { id: 'bitget', name: 'Bitget', icon: 'üíú' },
            { id: 'coinbase', name: 'Coinbase', icon: 'üîµ' },
            { id: 'coincatch', name: 'Coincatch', icon: 'üéØ' },
            { id: 'bitmart', name: 'BitMart', icon: 'üß°' },
            { id: 'bitrue', name: 'Bitrue', icon: 'üíö' },
            { id: 'gemini', name: 'Gemini', icon: 'üíé' }
        ];

        // Initialize exchange filter on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üîß [Exchange Filter] Initializing...');
            initializeExchangeFilter();
        });

        function initializeExchangeFilter() {
            const checkboxGrid = document.getElementById('exchangeCheckboxGrid');
            const dropdown = document.getElementById('exchangeDropdown');

            if (!checkboxGrid) {
                console.error('‚ùå [Exchange Filter] Checkbox grid container not found');
                return;
            }

            if (!dropdown) {
                console.error('‚ùå [Exchange Filter] Dropdown container not found');
                return;
            }

            // Generate checkboxes for all exchanges
            allExchanges.forEach(exchange => {
                // Create checkbox option
                const checkboxContainer = document.createElement('label');
                checkboxContainer.style.cssText = 'display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px; background: rgba(255,255,255,0.05); border-radius: 6px; transition: all 0.2s;';
                checkboxContainer.onmouseover = function() { this.style.background = 'rgba(255,255,255,0.1)'; };
                checkboxContainer.onmouseout = function() { this.style.background = 'rgba(255,255,255,0.05)'; };

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `filter-${exchange.id}`;
                checkbox.style.cssText = 'cursor: pointer;';
                checkbox.addEventListener('change', function() {
                    handleExchangeFilterChange(exchange.id, this.checked);
                    syncDropdownFromCheckboxes(); // Sync dropdown when checkbox changes
                });

                const label = document.createElement('span');
                label.textContent = `${exchange.icon} ${exchange.name}`;
                label.style.cssText = 'color: #b8c6db; font-size: 0.9rem; user-select: none;';

                checkboxContainer.appendChild(checkbox);
                checkboxContainer.appendChild(label);
                checkboxGrid.appendChild(checkboxContainer);

                // Create dropdown option
                const option = document.createElement('option');
                option.value = exchange.id;
                option.textContent = `${exchange.icon} ${exchange.name}`;
                option.style.cssText = 'background: #1a1a2e; color: #fff; padding: 5px;';
                dropdown.appendChild(option);
            });

            // Add dropdown change listener
            dropdown.addEventListener('change', function() {
                syncCheckboxesFromDropdown();
            });

            // Load saved states or apply default (Option C: auto-tick exchanges with credentials)
            loadExchangeFilterStates();

            console.log('‚úÖ [Exchange Filter] Initialized successfully');
        }

        function handleExchangeFilterChange(exchangeId, isChecked) {
            console.log(`üîÑ [Exchange Filter] ${exchangeId}: ${isChecked ? 'SHOW' : 'HIDE'}`);

            // Show or hide the exchange card
            const card = document.getElementById(`${exchangeId}-card`);
            if (card) {
                card.style.display = isChecked ? '' : 'none';
            } else {
                console.warn(`‚ö†Ô∏è [Exchange Filter] Card not found: ${exchangeId}-card`);
            }

            // Save state to localStorage
            localStorage.setItem(`triangular_show_${exchangeId}`, isChecked.toString());

            // Update counter
            updateSelectedExchangeCount();
        }

        function loadExchangeFilterStates() {
            console.log('üìÇ [Exchange Filter] Loading saved states...');

            let hasAnySavedState = false;

            // Check if user has any saved preferences
            allExchanges.forEach(exchange => {
                const saved = localStorage.getItem(`triangular_show_${exchange.id}`);
                if (saved !== null) {
                    hasAnySavedState = true;
                }
            });

            // Apply states
            allExchanges.forEach(exchange => {
                const checkbox = document.getElementById(`filter-${exchange.id}`);
                if (!checkbox) return;

                let shouldShow = false;

                if (hasAnySavedState) {
                    // User has saved preferences - restore them
                    const saved = localStorage.getItem(`triangular_show_${exchange.id}`);
                    shouldShow = saved === 'true';
                } else {
                    // First-time user - Option C: auto-tick exchanges with configured credentials
                    const hasCredentials = localStorage.getItem(`${exchange.id}_triangular_api`) &&
                                          localStorage.getItem(`${exchange.id}_triangular_secret`);
                    shouldShow = hasCredentials;

                    if (hasCredentials) {
                        console.log(`‚úÖ [Exchange Filter] Auto-ticking ${exchange.name} (credentials found)`);
                    }
                }

                // Apply the checkbox state
                checkbox.checked = shouldShow;

                // Show/hide the card
                const card = document.getElementById(`${exchange.id}-card`);
                if (card) {
                    card.style.display = shouldShow ? '' : 'none';
                }

                // Save state if first-time (so we don't re-apply Option C logic next time)
                if (!hasAnySavedState) {
                    localStorage.setItem(`triangular_show_${exchange.id}`, shouldShow.toString());
                }
            });

            updateSelectedExchangeCount();
            syncDropdownFromCheckboxes(); // Sync dropdown with loaded checkbox states
            console.log('‚úÖ [Exchange Filter] States loaded');
        }

        function updateSelectedExchangeCount() {
            const checkedCount = allExchanges.filter(exchange => {
                const checkbox = document.getElementById(`filter-${exchange.id}`);
                return checkbox && checkbox.checked;
            }).length;

            const counterElement = document.getElementById('selectedExchangeCount');
            if (counterElement) {
                counterElement.textContent = checkedCount;
            }

            console.log(`üìä [Exchange Filter] ${checkedCount} of 21 exchanges selected`);
        }

        // Sync dropdown selections from checkboxes
        function syncDropdownFromCheckboxes() {
            const dropdown = document.getElementById('exchangeDropdown');
            if (!dropdown) return;

            // Get all checked exchange IDs
            const checkedExchanges = allExchanges
                .filter(exchange => {
                    const checkbox = document.getElementById(`filter-${exchange.id}`);
                    return checkbox && checkbox.checked;
                })
                .map(exchange => exchange.id);

            // Update dropdown selections
            Array.from(dropdown.options).forEach(option => {
                option.selected = checkedExchanges.includes(option.value);
            });
        }

        // Sync checkboxes from dropdown selections
        function syncCheckboxesFromDropdown() {
            const dropdown = document.getElementById('exchangeDropdown');
            if (!dropdown) return;

            // Get selected exchange IDs from dropdown
            const selectedExchanges = Array.from(dropdown.selectedOptions).map(option => option.value);

            // Update checkboxes
            allExchanges.forEach(exchange => {
                const checkbox = document.getElementById(`filter-${exchange.id}`);
                if (checkbox) {
                    const shouldBeChecked = selectedExchanges.includes(exchange.id);
                    if (checkbox.checked !== shouldBeChecked) {
                        checkbox.checked = shouldBeChecked;
                        handleExchangeFilterChange(exchange.id, shouldBeChecked);
                    }
                }
            });
        }

        // End of Exchange Filter Functionality

        // ============================================================================
        // TRIANGULAR ARBITRAGE ABOUT MODAL
        // ============================================================================

        function openTriangularAboutModal() {
            const modal = document.getElementById('triangularAboutModal');
            if (modal) {
                modal.style.display = 'flex';
                console.log('‚ÑπÔ∏è [About Modal] Opened');
            }
        }

        function closeTriangularAboutModal() {
            const modal = document.getElementById('triangularAboutModal');
            if (modal) {
                modal.style.display = 'none';
                console.log('‚ÑπÔ∏è [About Modal] Closed');
            }
        }

        // Close modal when clicking outside the content
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('triangularAboutModal');
            if (event.target === modal) {
                closeTriangularAboutModal();
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeTriangularAboutModal();
            }
        });

        // End of About Modal Functionality
    </script>
</body>
</html>