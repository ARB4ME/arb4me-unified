<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Currency Swap Arbitrage v2 - ARB4ME</title>
    <style>
        body {
            background: linear-gradient(135deg, #0c0c1e 0%, #161632 100%);
            color: #b8c6db;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .card {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
        }

        .card h3 {
            margin: 0 0 15px 0;
            color: #00d4ff;
        }

        .card h4 {
            margin: 0 0 10px 0;
            color: #ffb347;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .stat-box {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #b8c6db;
        }

        .btn {
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
            font-weight: 600;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-danger {
            background: linear-gradient(45deg, #ff6b6b 0%, #ee5a24 100%);
        }

        .btn-success {
            background: linear-gradient(45deg, #00ff88 0%, #00cc6a 100%);
        }

        .toggle-switch {
            width: 50px;
            height: 25px;
            background: #ff6b6b;
            border-radius: 25px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
        }

        .toggle-switch.active {
            background: #00ff88;
        }

        .toggle-knob {
            width: 21px;
            height: 21px;
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 2px;
            left: 2px;
            transition: all 0.3s;
        }

        .toggle-switch.active .toggle-knob {
            left: 27px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #b8c6db;
            font-size: 0.9rem;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            color: #fff;
            font-size: 0.9rem;
        }

        .form-group select option {
            background: #1a1a2e;
            color: #fff;
            padding: 10px;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.2s;
        }

        .checkbox-group label:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
        }

        .path-card {
            background: rgba(0, 212, 255, 0.05);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .path-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .path-title {
            font-size: 1.1rem;
            color: #00d4ff;
            font-weight: 600;
        }

        .path-legs {
            padding: 10px 0;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin: 10px 0;
        }

        .path-leg {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            font-size: 0.9rem;
        }

        .leg-number {
            background: #667eea;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-content {
            background: #1a1a2e;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 100%;
            border: 2px solid #667eea;
            max-height: 90vh;
            overflow-y: auto;
        }

        .alert {
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }

        .alert-info {
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid #00d4ff;
            color: #00d4ff;
        }

        .alert-warning {
            background: rgba(255, 179, 71, 0.1);
            border: 1px solid #ffb347;
            color: #ffb347;
        }

        .alert-success {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid #00ff88;
            color: #00ff88;
        }

        .declaration-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: rgba(0, 255, 136, 0.05);
            border: 1px solid rgba(0, 255, 136, 0.3);
            border-radius: 6px;
            margin-bottom: 10px;
        }

        .declaration-info {
            flex: 1;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            background: rgba(102, 126, 234, 0.3);
            border-radius: 4px;
            font-size: 0.8rem;
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div>
                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 5px;">
                    <h1 style="color: #00d4ff; margin: 0;">üí± Currency Swap Arbitrage</h1>
                    <button onclick="openCurrencySwapAboutModal()" style="background: rgba(0,212,255,0.2); color: #00d4ff; border: 1px solid #00d4ff; padding: 6px 16px; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 600; transition: all 0.3s;" onmouseover="this.style.background='rgba(0,212,255,0.3)'" onmouseout="this.style.background='rgba(0,212,255,0.2)'">
                        ‚ÑπÔ∏è About
                    </button>
                </div>
                <p style="margin: 0; color: #b8c6db;">Automated Multi-Exchange Currency Arbitrage</p>
            </div>
            <div style="display: flex; align-items: center; gap: 15px;">
                <span style="color: #b8c6db;">Auto-Trading:</span>
                <div class="toggle-switch" id="autoTradingToggle">
                    <div class="toggle-knob"></div>
                </div>
                <button onclick="window.location.href='/'" class="btn btn-danger">‚Üê Return to Dashboard</button>
            </div>
        </div>

        <!-- Stats Overview -->
        <div class="grid-3" style="margin-bottom: 30px;">
            <div class="stat-box">
                <div class="stat-value" style="color: #00ff88;" id="totalPaths">0</div>
                <div class="stat-label">Available Paths</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" style="color: #ffb347;" id="totalExchanges">0</div>
                <div class="stat-label">Connected Exchanges</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" style="color: #00d4ff;" id="totalAssets">0</div>
                <div class="stat-label">Funded Assets</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" style="color: #ff6b6b;" id="swapsToday">0</div>
                <div class="stat-label">Swaps Today</div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid-2">
            <!-- Left Column -->
            <div>
                <!-- Currency Swap Setup (NEW SIMPLIFIED!) -->
                <div class="card">
                    <h3>‚öôÔ∏è Currency Swap Setup</h3>
                    <div class="alert alert-info">
                        Select exchanges and currencies to scan for arbitrage opportunities. Auto-saves your selections.
                    </div>

                    <div class="form-group">
                        <label>üìä Select Exchanges to Trade</label>
                        <div class="checkbox-group" id="exchangeCheckboxes" style="max-height: 300px; overflow-y: auto; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 6px;">
                            <label><input type="checkbox" value="VALR" onchange="saveSetup()"> VALR</label>
                            <label><input type="checkbox" value="Luno" onchange="saveSetup()"> Luno</label>
                            <label><input type="checkbox" value="Kraken" onchange="saveSetup()"> Kraken</label>
                            <label><input type="checkbox" value="ChainEX" onchange="saveSetup()"> ChainEX</label>
                            <label><input type="checkbox" value="Bybit" onchange="saveSetup()"> Bybit</label>
                            <label><input type="checkbox" value="Binance" onchange="saveSetup()"> Binance</label>
                            <label><input type="checkbox" value="OKX" onchange="saveSetup()"> OKX</label>
                            <label><input type="checkbox" value="Kucoin" onchange="saveSetup()"> Kucoin</label>
                            <label><input type="checkbox" value="HTX" onchange="saveSetup()"> HTX</label>
                            <label><input type="checkbox" value="Gate.io" onchange="saveSetup()"> Gate.io</label>
                            <label><input type="checkbox" value="Crypto.com" onchange="saveSetup()"> Crypto.com</label>
                            <label><input type="checkbox" value="MEXC" onchange="saveSetup()"> MEXC</label>
                            <label><input type="checkbox" value="XT" onchange="saveSetup()"> XT</label>
                            <label><input type="checkbox" value="AscendEX" onchange="saveSetup()"> AscendEX</label>
                            <label><input type="checkbox" value="BingX" onchange="saveSetup()"> BingX</label>
                            <label><input type="checkbox" value="Bitget" onchange="saveSetup()"> Bitget</label>
                            <label><input type="checkbox" value="BitMart" onchange="saveSetup()"> BitMart</label>
                            <label><input type="checkbox" value="Bitrue" onchange="saveSetup()"> Bitrue</label>
                            <label><input type="checkbox" value="Gemini" onchange="saveSetup()"> Gemini</label>
                            <label><input type="checkbox" value="Coincatch" onchange="saveSetup()"> Coincatch</label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>üí∞ Select Currencies to Scan</label>
                        <div class="checkbox-group" id="currencyCheckboxes">
                            <label><input type="checkbox" value="USDT" onchange="saveSetup()"> üíµ USDT</label>
                            <label><input type="checkbox" value="USDC" onchange="saveSetup()"> üíµ USDC</label>
                            <label><input type="checkbox" value="ZAR" onchange="saveSetup()"> üáøüá¶ ZAR</label>
                            <label><input type="checkbox" value="XRP" onchange="saveSetup()"> ‚ö° XRP</label>
                            <label><input type="checkbox" value="USD" onchange="saveSetup()"> üá∫üá∏ USD</label>
                            <label><input type="checkbox" value="RLUSD" onchange="saveSetup()"> üíé RLUSD</label>
                            <label><input type="checkbox" value="AUD" onchange="saveSetup()"> üá¶üá∫ AUD</label>
                            <label><input type="checkbox" value="EUR" onchange="saveSetup()"> üá™üá∫ EUR</label>
                            <label><input type="checkbox" value="GBP" onchange="saveSetup()"> üá¨üáß GBP</label>
                            <label><input type="checkbox" value="CAD" onchange="saveSetup()"> üá®üá¶ CAD</label>
                            <label><input type="checkbox" value="AED" onchange="saveSetup()"> üá¶üá™ AED</label>
                        </div>
                    </div>

                    <div class="form-group" id="xrpDepositSection" style="display: none;">
                        <label>‚ö° XRP Deposit Addresses</label>
                        <div style="background: rgba(255,179,71,0.1); border: 1px solid #ffb347; border-radius: 8px; padding: 12px; margin-bottom: 10px;">
                            <div style="font-size: 0.85rem; color: #ffb347; margin-bottom: 8px;">
                                üí° Provide your XRP deposit address & tag for each exchange to enable automatic transfers
                            </div>
                        </div>
                        <div id="xrpDepositInputs" style="display: grid; gap: 15px; max-height: 400px; overflow-y: auto; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 6px;">
                            <!-- XRP inputs will be dynamically added here -->
                        </div>
                    </div>

                    <div style="text-align: center; padding: 10px; color: #00ff88; font-size: 0.9rem;">
                        <span id="saveStatus">‚úÖ Auto-saved</span>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div>
                <!-- Risk Settings (Always Visible) -->
                <div class="card">
                    <h3 style="color: #ff6b6b;">‚öôÔ∏è Risk Settings</h3>
                    <div class="alert alert-warning" style="background: rgba(255, 107, 107, 0.1); border-color: #ff6b6b;">
                        <strong>‚ö†Ô∏è Important:</strong> These settings control your trading limits and risk exposure.
                    </div>

                    <div class="form-group">
                        <label>Minimum Net Profit Threshold (%)</label>
                        <input type="number" id="thresholdPercent" min="0.1" max="10" step="0.1" value="0.5" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.3); color: white;">
                        <small style="color: #888;">Minimum profit percentage AFTER all fees to execute trade</small>
                    </div>

                    <div class="form-group">
                        <label>Max Trade Amount (USDT)</label>
                        <input type="number" id="maxTradeAmountUsdt" min="10" max="100000" step="10" value="5000" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.3); color: white;">
                        <small style="color: #888;">Maximum amount per trade (in USDT equivalent)</small>
                    </div>

                    <div class="form-group">
                        <label>Daily Swap Limit</label>
                        <input type="number" id="dailySwapLimit" min="1" max="1000" step="1" value="50" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.3); color: white;">
                        <small style="color: #888;">Maximum number of trades per day</small>
                    </div>

                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="enableStopLoss" style="width: 20px; height: 20px;">
                            <span>Enable Stop-Loss Protection</span>
                        </label>
                        <small style="color: #888;">Stop trading if daily loss exceeds threshold</small>
                    </div>

                    <div style="text-align: center; margin-top: 15px;">
                        <button onclick="saveRiskSettings()" class="btn btn-success" style="width: 100%;">üíæ Save Risk Settings</button>
                        <div id="riskSaveStatus" style="margin-top: 10px; color: #888; font-size: 0.9rem;">Settings loaded...</div>
                    </div>
                </div>

                <!-- Path Statistics (NEW!) -->
                <div class="card">
                    <h3>üìä Path Statistics</h3>
                    <div id="pathStats">
                        <p style="color: #888;">Declare assets to see statistics...</p>
                    </div>
                </div>

                <!-- Auto-Generated Paths (NEW!) -->
                <div class="card">
                    <h3>üîÑ Auto-Generated Swap Paths</h3>
                    <div class="alert alert-warning">
                        These paths are automatically generated based on your selections. No manual setup needed!
                    </div>

                    <!-- Filters -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                        <select id="filterSourceAsset" onchange="saveFilters()">
                            <option value="">All Source Assets</option>
                            <option value="USDT">USDT</option>
                            <option value="USDC">USDC</option>
                            <option value="ZAR">ZAR</option>
                            <option value="XRP">XRP</option>
                            <option value="USD">USD</option>
                            <option value="RLUSD">RLUSD</option>
                            <option value="AUD">AUD</option>
                            <option value="EUR">EUR</option>
                            <option value="GBP">GBP</option>
                            <option value="CAD">CAD</option>
                            <option value="AED">AED</option>
                        </select>
                        <select id="filterDestAsset" onchange="saveFilters()">
                            <option value="">All Dest Assets</option>
                            <option value="USDT">USDT</option>
                            <option value="USDC">USDC</option>
                            <option value="ZAR">ZAR</option>
                            <option value="XRP">XRP</option>
                            <option value="USD">USD</option>
                            <option value="RLUSD">RLUSD</option>
                            <option value="AUD">AUD</option>
                            <option value="EUR">EUR</option>
                            <option value="GBP">GBP</option>
                            <option value="CAD">CAD</option>
                            <option value="AED">AED</option>
                        </select>
                    </div>

                    <div id="pathsList">
                        <p style="color: #888;">Loading paths...</p>
                    </div>
                </div>
            </div>

            <!-- Trading Activity Card (NEW!) -->
            <div class="card" style="margin-top: 20px;">
                <h3>üìä Trading Activity</h3>

                <!-- Tab Headers -->
                <div style="display: flex; gap: 5px; margin-bottom: 15px; background: rgba(0,0,0,0.3); padding: 5px; border-radius: 8px;">
                    <button class="activity-tab-btn active" data-tab="swaps" style="flex: 1; padding: 12px 10px; background: rgba(0,212,255,0.15); border: 1px solid #00d4ff; border-radius: 6px; color: #00d4ff; cursor: pointer; font-weight: bold; font-size: 0.95rem;">
                        üìú Recent Swaps
                    </button>
                    <button class="activity-tab-btn" data-tab="balances" style="flex: 1; padding: 12px 10px; background: rgba(255,255,255,0.03); border: 1px solid transparent; border-radius: 6px; color: #888; cursor: pointer; font-weight: bold; font-size: 0.95rem;">
                        üí∞ Balance Tracker
                    </button>
                </div>

                <!-- Tab Content -->
                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px;">
                    <!-- Tab 1: Recent Swaps -->
                    <div id="activityTabSwaps" class="activity-tab-content" style="display: block;">
                        <div id="recentSwaps" style="max-height: 300px; overflow-y: auto;">
                            <div style="text-align: center; color: #888; padding: 20px;">
                                No swaps yet. Enable auto-trading to start.
                            </div>
                        </div>
                    </div>

                    <!-- Tab 2: Balance Tracker -->
                    <div id="activityTabBalances" class="activity-tab-content" style="display: none;">
                        <div id="balanceTrackerContent" style="max-height: 400px; overflow-y: auto;">
                            <div style="text-align: center; color: #888; padding: 20px;">
                                Select exchanges and currencies to track balances.
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px; justify-content: space-between; align-items: center; padding-top: 10px; margin-top: 10px; border-top: 1px solid rgba(255,255,255,0.1);">
                            <div style="color: #888; font-size: 0.85rem;">
                                Last Updated: <span id="balanceLastUpdate">Never</span>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button onclick="refreshBalances()" style="padding: 6px 12px; background: rgba(0,255,136,0.1); color: #00ff88; border: 1px solid #00ff88; border-radius: 5px; cursor: pointer; font-size: 0.85rem;">
                                    üîÑ Refresh from Exchanges
                                </button>
                                <button onclick="resetAllBalances()" style="padding: 6px 12px; background: rgba(255,255,255,0.1); color: #00d4ff; border: 1px solid #00d4ff; border-radius: 5px; cursor: pointer; font-size: 0.85rem;">
                                    üîÑ Reset Starting Balances
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Path Details Modal -->
    <div id="pathDetailsModal" class="modal">
        <div class="modal-content">
            <h3 style="color: #00d4ff; margin-bottom: 20px;">üîç Path Details & Execution</h3>
            <div id="pathDetailsContent"></div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button onclick="executeCurrentPath()" class="btn btn-success" style="flex: 1;">Execute Swap</button>
                <button onclick="closePathDetails()" class="btn" style="flex: 1;">Close</button>
            </div>
        </div>
    </div>

    <!-- Currency Swap Arbitrage About Modal -->
    <div id="currencySwapAboutModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; justify-content: center; align-items: center;">
        <div style="background: linear-gradient(135deg, #0c0c1e 0%, #161632 100%); padding: 30px; border-radius: 15px; max-width: 600px; width: 90%; max-height: 90vh; border: 2px solid #00d4ff; box-shadow: 0 10px 40px rgba(0,212,255,0.3); position: relative; overflow-y: auto;">
            <!-- Close Button -->
            <button onclick="closeCurrencySwapAboutModal()" style="position: absolute; top: 15px; right: 15px; background: rgba(255,68,68,0.9); border: none; color: #fff; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; font-size: 1.5rem; font-weight: bold; display: flex; align-items: center; justify-content: center; transition: all 0.3s; z-index: 1;" onmouseover="this.style.background='rgba(255,68,68,1)'; this.style.transform='scale(1.1)'" onmouseout="this.style.background='rgba(255,68,68,0.9)'; this.style.transform='scale(1)'">
                √ó
            </button>

            <!-- Header -->
            <h2 style="color: #00d4ff; margin: 0 0 20px 0; padding-right: 40px; font-size: 1.5rem;">üí± What is Currency Swap Arbitrage?</h2>

            <!-- Content -->
            <div style="color: #b8c6db; line-height: 1.6; font-size: 0.95rem; padding-right: 5px;">
                <p style="margin: 0 0 15px 0;">
                    <strong style="color: #00ff88;">Currency swap arbitrage</strong> exploits price differences between <strong>fiat currencies across different exchanges</strong>. It involves converting between currencies (like ZAR, USD, EUR) through crypto to capture profit.
                </p>

                <div style="background: rgba(0,212,255,0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #00d4ff; margin-bottom: 15px;">
                    <strong style="color: #00d4ff; display: block; margin-bottom: 8px;">Example:</strong>
                    <div style="font-family: monospace; color: #00ff88;">
                        1. Convert 10,000 ZAR ‚Üí BTC on VALR (ZAR rate)<br>
                        2. Transfer BTC to Kraken<br>
                        3. Sell BTC ‚Üí USD on Kraken (USD rate)<br>
                        4. Result: Better ZAR/USD rate than forex!<br>
                        <span style="color: #ffb347;">Profit from rate differences</span>
                    </div>
                </div>

                <p style="margin: 0 0 15px 0;">
                    <strong style="color: #ffb347;">How it works:</strong>
                </p>
                <ol style="margin: 0 0 15px 0; padding-left: 25px;">
                    <li style="margin-bottom: 8px;">System monitors <strong>fiat currency exchange rates</strong> across all exchanges</li>
                    <li style="margin-bottom: 8px;">Identifies favorable <strong>currency conversion paths</strong> through crypto</li>
                    <li style="margin-bottom: 8px;">Converts Currency A ‚Üí Crypto on Exchange 1</li>
                    <li style="margin-bottom: 8px;">Transfers crypto to Exchange 2 (if needed)</li>
                    <li style="margin-bottom: 8px;">Converts Crypto ‚Üí Currency B on Exchange 2</li>
                    <li style="margin-bottom: 8px;">Net result: <strong>Better exchange rate</strong> than traditional forex</li>
                </ol>

                <p style="margin: 0 0 15px 0;">
                    <strong style="color: #ffb347;">Common currency pairs:</strong>
                </p>
                <ul style="margin: 0 0 15px 0; padding-left: 25px;">
                    <li style="margin-bottom: 8px;"><strong style="color: #00ff88;">ZAR ‚Üî USD</strong> - South African Rand to US Dollar</li>
                    <li style="margin-bottom: 8px;"><strong style="color: #00ff88;">ZAR ‚Üî EUR</strong> - South African Rand to Euro</li>
                    <li style="margin-bottom: 8px;"><strong style="color: #00ff88;">USD ‚Üî EUR</strong> - US Dollar to Euro</li>
                    <li style="margin-bottom: 8px;"><strong style="color: #00ff88;">GBP ‚Üî USD</strong> - British Pound to US Dollar</li>
                </ul>

                <p style="margin: 0 0 15px 0;">
                    <strong style="color: #ffb347;">Best for:</strong>
                </p>
                <ul style="margin: 0 0 15px 0; padding-left: 25px;">
                    <li style="margin-bottom: 8px;">Converting between fiat currencies at better rates</li>
                    <li style="margin-bottom: 8px;">International money transfers</li>
                    <li style="margin-bottom: 8px;">Avoiding high forex bank fees</li>
                </ul>

                <div style="background: rgba(255,152,0,0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #ffb347; margin-bottom: 0;">
                    <strong style="color: #ffb347;">Key Advantage:</strong> By routing currency conversions through crypto exchanges, you can often beat traditional forex rates and save significantly on international transfers. The system automatically finds the most profitable currency swap paths!
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api/v1/currency-swap';
        const USER_ID = 1; // TODO: Get from auth

        let currentPath = null;

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üí± Currency Swap v2 loaded');
            console.log('üìç API Base:', API_BASE);
            console.log('üë§ User ID:', USER_ID);

            console.log('‚è≥ Step 1/4: Loading stats...');
            await loadStats();

            console.log('‚è≥ Step 2/4: Loading setup (exchanges & currencies)...');
            await loadSetup();

            console.log('‚è≥ Step 3/4: Loading swap paths...');
            await loadPaths();

            console.log('‚è≥ Step 4/4: Loading path statistics...');
            await loadPathStats();

            console.log('‚è≥ Step 5/6: Loading XRP deposit inputs...');
            await populateXrpDepositInputs();

            console.log('‚è≥ Step 6/6: Loading risk settings...');
            await loadRiskSettings();

            console.log('‚úÖ Currency Swap initialization complete!');

            // Auto-trading toggle
            const toggle = document.getElementById('autoTradingToggle');
            toggle.addEventListener('click', function() {
                this.classList.toggle('active');
                toggleAutoTrading();
            });

            // Auto-start worker loop if auto-trading is already enabled
            if (toggle.classList.contains('active')) {
                console.log('üöÄ Auto-trading is enabled - starting worker loop...');
                startWorkerLoop();
            }
        });

        // Load overall stats
        async function loadStats() {
            try {
                console.log('üìä Fetching stats from:', `${API_BASE}/stats?userId=${USER_ID}`);
                const response = await fetch(`${API_BASE}/stats?userId=${USER_ID}`);
                const data = await response.json();

                console.log('üìä Stats response:', data);

                if (data.success) {
                    document.getElementById('swapsToday').textContent = data.data.dailySwapsToday || 0;
                    document.getElementById('totalPaths').textContent = data.data.availablePaths || 0;
                    if (data.data.autoTradingEnabled) {
                        document.getElementById('autoTradingToggle').classList.add('active');
                        console.log('üü¢ Auto-trading is ENABLED');
                    } else {
                        console.log('üî¥ Auto-trading is DISABLED');
                    }
                    console.log('‚úÖ Stats loaded:', {
                        swapsToday: data.data.dailySwapsToday || 0,
                        totalSwaps: data.data.totalSwaps || 0,
                        availablePaths: data.data.availablePaths || 0,
                        autoTrading: data.data.autoTradingEnabled
                    });
                }
            } catch (error) {
                console.error('‚ùå Failed to load stats:', error);
            }
        }

        // Load setup (selected exchanges and currencies)
        async function loadSetup() {
            try {
                console.log('‚öôÔ∏è Fetching setup from:', `${API_BASE}/settings?userId=${USER_ID}`);
                const response = await fetch(`${API_BASE}/settings?userId=${USER_ID}`);
                const data = await response.json();

                console.log('‚öôÔ∏è Setup response:', data);

                if (data.success) {
                    const s = data.data;

                    // Load selected exchanges
                    const selectedExchanges = s.selected_exchanges || [];
                    console.log('üè¶ Selected exchanges:', selectedExchanges);
                    document.querySelectorAll('#exchangeCheckboxes input[type="checkbox"]').forEach(cb => {
                        cb.checked = selectedExchanges.includes(cb.value);
                    });

                    // Load selected currencies
                    const selectedCurrencies = s.selected_currencies || [];
                    console.log('üí∞ Selected currencies:', selectedCurrencies);
                    document.querySelectorAll('#currencyCheckboxes input[type="checkbox"]').forEach(cb => {
                        cb.checked = selectedCurrencies.includes(cb.value);
                    });

                    // Update stats
                    document.getElementById('totalExchanges').textContent = selectedExchanges.length;
                    document.getElementById('totalAssets').textContent = selectedCurrencies.length;

                    console.log('‚úÖ Setup loaded:', {
                        exchanges: selectedExchanges.length,
                        currencies: selectedCurrencies.length
                    });

                    // Restore saved filter selections from localStorage
                    const savedSourceFilter = localStorage.getItem('currencySwap_filterSourceAsset');
                    const savedDestFilter = localStorage.getItem('currencySwap_filterDestAsset');

                    if (savedSourceFilter) {
                        document.getElementById('filterSourceAsset').value = savedSourceFilter;
                        console.log('üîç Restored source filter:', savedSourceFilter);
                    }

                    if (savedDestFilter) {
                        document.getElementById('filterDestAsset').value = savedDestFilter;
                        console.log('üîç Restored dest filter:', savedDestFilter);
                    }
                }
            } catch (error) {
                console.error('‚ùå Failed to load setup:', error);
            }
        }

        // Save setup (auto-save on checkbox change)
        async function saveSetup() {
            try {
                // Get selected exchanges
                const exchangeCheckboxes = document.querySelectorAll('#exchangeCheckboxes input[type="checkbox"]:checked');
                const selectedExchanges = Array.from(exchangeCheckboxes).map(cb => cb.value);

                // Get selected currencies
                const currencyCheckboxes = document.querySelectorAll('#currencyCheckboxes input[type="checkbox"]:checked');
                const selectedCurrencies = Array.from(currencyCheckboxes).map(cb => cb.value);

                console.log('üíæ Saving setup:', {
                    exchanges: selectedExchanges,
                    currencies: selectedCurrencies
                });

                // Update UI
                document.getElementById('totalExchanges').textContent = selectedExchanges.length;
                document.getElementById('totalAssets').textContent = selectedCurrencies.length;

                // Show saving status
                const saveStatus = document.getElementById('saveStatus');
                saveStatus.textContent = 'üíæ Saving...';
                saveStatus.style.color = '#ffb347';

                // Save to settings
                const response = await fetch(`${API_BASE}/settings`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: USER_ID,
                        selectedExchanges,
                        selectedCurrencies
                    })
                });

                const result = await response.json();
                console.log('üíæ Save response:', result);

                if (result.success) {
                    saveStatus.textContent = '‚úÖ Auto-saved';
                    saveStatus.style.color = '#00ff88';
                    console.log('‚úÖ Setup saved successfully!');

                    // Reload paths with new selections
                    console.log('üîÑ Regenerating paths with new selections...');
                    await loadPaths();
                    await loadPathStats();

                    // Update XRP deposit inputs
                    await populateXrpDepositInputs();
                } else {
                    saveStatus.textContent = '‚ùå Save failed';
                    saveStatus.style.color = '#ff6b6b';
                    console.error('‚ùå Save failed:', result.error);
                }
            } catch (error) {
                console.error('‚ùå Failed to save setup:', error);
                document.getElementById('saveStatus').textContent = '‚ùå Save failed';
                document.getElementById('saveStatus').style.color = '#ff6b6b';
            }
        }

        // Populate XRP deposit inputs for selected exchanges
        async function populateXrpDepositInputs() {
            const exchangeCheckboxes = document.querySelectorAll('#exchangeCheckboxes input[type="checkbox"]:checked');
            const selectedExchanges = Array.from(exchangeCheckboxes).map(cb => cb.value);

            const xrpSection = document.getElementById('xrpDepositSection');
            const xrpInputsDiv = document.getElementById('xrpDepositInputs');

            if (selectedExchanges.length === 0) {
                xrpSection.style.display = 'none';
                return;
            }

            xrpSection.style.display = 'block';

            // Fetch existing XRP deposit info from backend
            let existingXrpData = {};
            try {
                const response = await fetch(`${API_BASE}/credentials?userId=${USER_ID}`);
                const data = await response.json();
                if (data.success) {
                    data.data.forEach(cred => {
                        existingXrpData[cred.exchange] = {
                            address: cred.xrpDepositAddress || '',
                            tag: cred.xrpDepositTag || ''
                        };
                    });
                }
            } catch (error) {
                console.error('Failed to load XRP deposit data:', error);
            }

            // Build input fields for each selected exchange
            xrpInputsDiv.innerHTML = selectedExchanges.map(exchange => `
                <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 6px; border-left: 3px solid #00d4ff;">
                    <div style="font-weight: bold; color: #00d4ff; margin-bottom: 8px;">${exchange}</div>
                    <div style="display: grid; gap: 8px;">
                        <div>
                            <label style="font-size: 0.85rem; color: #b8c6db; display: block; margin-bottom: 4px;">Deposit Address</label>
                            <input
                                type="text"
                                id="xrp_address_${exchange}"
                                placeholder="r......"
                                value="${existingXrpData[exchange]?.address || ''}"
                                onchange="saveXrpDepositInfo('${exchange}')"
                                style="width: 100%; padding: 8px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; color: white; font-family: monospace; font-size: 0.9rem;"
                            >
                        </div>
                        <div>
                            <label style="font-size: 0.85rem; color: #b8c6db; display: block; margin-bottom: 4px;">Destination Tag (optional)</label>
                            <input
                                type="text"
                                id="xrp_tag_${exchange}"
                                placeholder="12345678"
                                value="${existingXrpData[exchange]?.tag || ''}"
                                onchange="saveXrpDepositInfo('${exchange}')"
                                style="width: 100%; padding: 8px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; color: white; font-family: monospace; font-size: 0.9rem;"
                            >
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Auto-save XRP deposit info when user types
        async function saveXrpDepositInfo(exchange) {
            try {
                const address = document.getElementById(`xrp_address_${exchange}`).value.trim();
                const tag = document.getElementById(`xrp_tag_${exchange}`).value.trim();

                console.log(`üíæ Saving XRP deposit info for ${exchange}:`, { address, tag });

                const response = await fetch(`${API_BASE}/credentials/${exchange}/xrp-deposit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: USER_ID,
                        xrpDepositAddress: address || null,
                        xrpDepositTag: tag || null
                    })
                });

                const data = await response.json();

                if (data.success) {
                    console.log(`‚úÖ XRP deposit info saved for ${exchange}`);
                    // Show brief success feedback
                    const saveStatus = document.getElementById('saveStatus');
                    const oldText = saveStatus.textContent;
                    saveStatus.textContent = `‚úÖ ${exchange} XRP info saved`;
                    setTimeout(() => {
                        saveStatus.textContent = oldText;
                    }, 2000);
                } else {
                    console.error(`‚ùå Failed to save XRP info for ${exchange}:`, data.error);
                    alert(`Failed to save XRP info for ${exchange}: ${data.error}`);
                }
            } catch (error) {
                console.error(`‚ùå Error saving XRP info for ${exchange}:`, error);
            }
        }

        // Load paths
        async function loadPaths() {
            try {
                const sourceAsset = document.getElementById('filterSourceAsset').value;
                const destAsset = document.getElementById('filterDestAsset').value;

                let url = `${API_BASE}/paths?userId=${USER_ID}`;
                if (sourceAsset) url += `&sourceAsset=${sourceAsset}`;
                if (destAsset) url += `&destAsset=${destAsset}`;

                console.log('üîÑ Fetching paths from:', url);
                const response = await fetch(url);
                const data = await response.json();

                console.log('üîÑ Paths response:', data);

                if (data.success) {
                    // Note: We don't update totalPaths here - it should only show total from tickbox selections
                    // The filtered count is just for display purposes in the path list
                    console.log(`‚úÖ Found ${data.data.count} paths matching current filters`);

                    const listDiv = document.getElementById('pathsList');
                    if (data.data.paths.length === 0) {
                        listDiv.innerHTML = '<p style="color: #888;">No paths available. Select 2+ exchanges and currencies to generate paths.</p>';
                        console.log('‚ö†Ô∏è No paths generated. Need 2+ exchanges and currencies selected.');
                    } else {
                        console.log('üìã Displaying paths:', data.data.paths.map(p => p.description));
                        listDiv.innerHTML = data.data.paths.map((path, idx) => `
                            <div class="path-card">
                                <div class="path-header">
                                    <div class="path-title">${path.description}</div>
                                </div>
                                <div class="path-legs">
                                    ${path.legs.map(leg => `
                                        <div class="path-leg">
                                            <div class="leg-number">${leg.leg}</div>
                                            <div>${leg.description}</div>
                                        </div>
                                    `).join('')}
                                </div>
                                <button onclick='showPathDetails(${JSON.stringify(path).replace(/'/g, "&apos;")})' class="btn" style="width: 100%; margin-top: 10px;">
                                    View Details & Calculate
                                </button>
                            </div>
                        `).join('');
                    }
                }
            } catch (error) {
                console.error('‚ùå Failed to load paths:', error);
            }
        }

        // Save filter selections to localStorage and reload paths
        function saveFilters() {
            const sourceAsset = document.getElementById('filterSourceAsset').value;
            const destAsset = document.getElementById('filterDestAsset').value;

            console.log('üîç Saving filter selections:', { sourceAsset, destAsset });

            // Save to localStorage
            localStorage.setItem('currencySwap_filterSourceAsset', sourceAsset);
            localStorage.setItem('currencySwap_filterDestAsset', destAsset);

            console.log('‚úÖ Filters saved, reloading paths...');

            // Reload paths with new filters
            loadPaths();
        }

        // Load path statistics
        async function loadPathStats() {
            try {
                console.log('üìä Fetching path statistics from:', `${API_BASE}/paths/stats?userId=${USER_ID}`);
                const response = await fetch(`${API_BASE}/paths/stats?userId=${USER_ID}`);
                const data = await response.json();

                console.log('üìä Path stats response:', data);

                if (data.success) {
                    const stats = data.data;
                    const statsDiv = document.getElementById('pathStats');

                    if (stats.totalPaths === 0) {
                        statsDiv.innerHTML = '<p style="color: #888;">Select exchanges & currencies to see statistics...</p>';
                        console.log('‚ö†Ô∏è No path statistics available yet');
                        return;
                    }

                    const exchangeCount = Object.keys(stats.bySourceExchange).length;
                    const assetPairCount = Object.keys(stats.byAssetPair).length;
                    const pathsPerExchange = exchangeCount > 0 ? Math.round(stats.totalPaths / exchangeCount) : 0;

                    console.log('‚úÖ Path statistics loaded:', {
                        totalPaths: stats.totalPaths,
                        exchanges: exchangeCount,
                        assetPairs: assetPairCount
                    });

                    statsDiv.innerHTML = `
                        <div style="margin-bottom: 15px;">
                            <div style="font-size: 0.9rem; color: #b8c6db; margin-bottom: 5px;">Total Paths</div>
                            <div style="font-size: 1.5rem; color: #00ff88; font-weight: bold;">${stats.totalPaths}</div>
                        </div>

                        <!-- By Source Exchange Collapsible -->
                        <div style="margin-bottom: 15px;">
                            <div
                                onclick="toggleStatsSection('exchangeStats')"
                                style="
                                    font-size: 0.9rem;
                                    color: #00d4ff;
                                    margin-bottom: 5px;
                                    cursor: pointer;
                                    display: flex;
                                    align-items: center;
                                    gap: 8px;
                                    padding: 8px;
                                    background: rgba(0, 212, 255, 0.1);
                                    border-radius: 6px;
                                    transition: all 0.2s;
                                "
                                onmouseover="this.style.background='rgba(0, 212, 255, 0.2)'"
                                onmouseout="this.style.background='rgba(0, 212, 255, 0.1)'"
                            >
                                <span id="exchangeStatsIcon">‚ñ∂</span>
                                <span>By Source Exchange (${exchangeCount} exchanges √ó ~${pathsPerExchange} paths)</span>
                            </div>
                            <div id="exchangeStats" style="display: none; margin-top: 10px; padding-left: 10px;">
                                ${Object.entries(stats.bySourceExchange).map(([ex, count]) =>
                                    `<div style="display: flex; justify-content: space-between; padding: 5px 0;">
                                        <span>${ex}</span>
                                        <span style="color: #00d4ff;">${count} paths</span>
                                    </div>`
                                ).join('')}
                            </div>
                        </div>

                        <!-- By Asset Pair Collapsible -->
                        <div>
                            <div
                                onclick="toggleStatsSection('assetPairStats')"
                                style="
                                    font-size: 0.9rem;
                                    color: #ffb347;
                                    margin-bottom: 5px;
                                    cursor: pointer;
                                    display: flex;
                                    align-items: center;
                                    gap: 8px;
                                    padding: 8px;
                                    background: rgba(255, 179, 71, 0.1);
                                    border-radius: 6px;
                                    transition: all 0.2s;
                                "
                                onmouseover="this.style.background='rgba(255, 179, 71, 0.2)'"
                                onmouseout="this.style.background='rgba(255, 179, 71, 0.1)'"
                            >
                                <span id="assetPairStatsIcon">‚ñ∂</span>
                                <span>By Asset Pair (${assetPairCount} pairs)</span>
                            </div>
                            <div id="assetPairStats" style="display: none; margin-top: 10px; padding-left: 10px;">
                                ${Object.entries(stats.byAssetPair).map(([pair, count]) =>
                                    `<div style="display: flex; justify-content: space-between; padding: 5px 0;">
                                        <span>${pair}</span>
                                        <span style="color: #ffb347;">${count} paths</span>
                                    </div>`
                                ).join('')}
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Failed to load path stats:', error);
            }
        }

        // Toggle stats section visibility
        function toggleStatsSection(sectionId) {
            const section = document.getElementById(sectionId);
            const icon = document.getElementById(sectionId + 'Icon');

            if (section.style.display === 'none') {
                section.style.display = 'block';
                icon.textContent = '‚ñº';
            } else {
                section.style.display = 'none';
                icon.textContent = '‚ñ∂';
            }
        }

        // Show path details
        async function showPathDetails(path) {
            console.log('üîç Showing path details:', path.description);
            console.log('üìä Path info:', path);
            currentPath = path;

            // Calculate trade amount
            try {
                console.log('üí∞ Calculating trade amount for:', {
                    sourceExchange: path.sourceExchange,
                    sourceAsset: path.sourceAsset
                });

                const response = await fetch(`${API_BASE}/calculate-trade-amount`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: USER_ID,
                        sourceExchange: path.sourceExchange,
                        sourceAsset: path.sourceAsset
                    })
                });

                const data = await response.json();
                console.log('üí∞ Trade amount response:', data);

                const content = document.getElementById('pathDetailsContent');
                content.innerHTML = `
                    <div class="alert alert-info">
                        <strong>${path.description}</strong>
                    </div>

                    <div style="margin: 20px 0;">
                        <h4 style="color: #ffb347;">Execution Steps:</h4>
                        ${path.legs.map(leg => `
                            <div style="padding: 10px; background: rgba(255,255,255,0.05); border-radius: 6px; margin-bottom: 8px;">
                                <strong>${leg.leg}. ${leg.action.toUpperCase()}</strong> - ${leg.description}
                            </div>
                        `).join('')}
                    </div>

                    ${data.success ? `
                        <div class="alert alert-success">
                            <h4 style="margin: 0 0 10px 0;">üí∞ Risk-Based Trade Sizing</h4>
                            <div style="display: grid; grid-template-columns: 1fr auto; gap: 10px; font-size: 0.9rem;">
                                <span>Recommended Amount:</span>
                                <strong style="color: #00ff88;">${data.data.recommendedAmount.toFixed(2)} ${path.sourceAsset}</strong>

                                <span>Available Balance:</span>
                                <span>${data.data.availableBalance.toFixed(2)} ${path.sourceAsset}</span>

                                <span>Reserve (${data.data.settings.minReservePercent}%):</span>
                                <span>${data.data.reserveAmount.toFixed(2)} ${path.sourceAsset}</span>

                                <span>Limiting Factor:</span>
                                <span style="color: #ffb347;">${data.data.constraint}</span>
                            </div>
                        </div>
                    ` : `
                        <div class="alert alert-warning">
                            ${data.data.reason}
                        </div>
                    `}
                `;

                document.getElementById('pathDetailsModal').style.display = 'flex';
            } catch (error) {
                console.error('Failed to calculate trade amount:', error);
            }
        }

        function closePathDetails() {
            document.getElementById('pathDetailsModal').style.display = 'none';
            currentPath = null;
        }

        async function executeCurrentPath() {
            if (!currentPath) return;
            alert('üöÄ Execution will be implemented in next phase!\n\nThis will execute:\n' + currentPath.description);
        }

        // Risk Settings (Inline Form)
        async function loadRiskSettings() {
            try {
                const response = await fetch(`${API_BASE}/settings?userId=${USER_ID}`);
                const data = await response.json();

                if (data.success) {
                    const s = data.data;
                    document.getElementById('thresholdPercent').value = s.threshold_percent || 0.5;
                    document.getElementById('maxTradeAmountUsdt').value = s.max_trade_amount_usdt || 5000;
                    document.getElementById('dailySwapLimit').value = s.daily_swap_limit || 50;
                    document.getElementById('enableStopLoss').checked = s.enable_stop_loss || false;

                    const status = document.getElementById('riskSaveStatus');
                    if (status) {
                        status.textContent = '‚úÖ Settings loaded';
                        status.style.color = '#00ff88';
                    }
                }
            } catch (error) {
                console.error('Failed to load risk settings:', error);
                const status = document.getElementById('riskSaveStatus');
                if (status) {
                    status.textContent = '‚ùå Failed to load settings';
                    status.style.color = '#ff6b6b';
                }
            }
        }

        async function saveRiskSettings() {
            try {
                const status = document.getElementById('riskSaveStatus');
                if (status) {
                    status.textContent = 'üíæ Saving...';
                    status.style.color = '#ffb347';
                }

                const settings = {
                    userId: USER_ID,
                    thresholdPercent: parseFloat(document.getElementById('thresholdPercent').value),
                    maxTradeAmountUsdt: parseFloat(document.getElementById('maxTradeAmountUsdt').value),
                    dailySwapLimit: parseInt(document.getElementById('dailySwapLimit').value),
                    enableStopLoss: document.getElementById('enableStopLoss').checked
                };

                const response = await fetch(`${API_BASE}/settings`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });

                const data = await response.json();
                if (data.success) {
                    if (status) {
                        status.textContent = '‚úÖ Settings saved successfully!';
                        status.style.color = '#00ff88';
                    }
                    await loadPaths(); // Reload paths with new settings
                } else {
                    if (status) {
                        status.textContent = '‚ùå Failed to save: ' + data.error;
                        status.style.color = '#ff6b6b';
                    }
                }
            } catch (error) {
                console.error('Failed to save risk settings:', error);
                const status = document.getElementById('riskSaveStatus');
                if (status) {
                    status.textContent = '‚ùå Error saving settings';
                    status.style.color = '#ff6b6b';
                }
            }
        }

        // Worker loop variables
        let workerLoopActive = false;
        let workerLoopTimeout = null;

        async function toggleAutoTrading() {
            const toggle = document.getElementById('autoTradingToggle');
            const enabled = toggle.classList.contains('active');

            console.log(`üîÑ Toggling auto-trading to: ${enabled ? 'ON' : 'OFF'}`);

            try {
                const response = await fetch(`${API_BASE}/settings/toggle-auto`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: USER_ID, enabled })
                });

                const data = await response.json();
                console.log('üîÑ Toggle response:', data);

                if (data.success) {
                    console.log(`‚úÖ Auto-trading ${enabled ? 'ENABLED' : 'DISABLED'} successfully!`);

                    // Start or stop the worker loop
                    if (enabled) {
                        startWorkerLoop();
                    } else {
                        stopWorkerLoop();
                    }
                } else {
                    console.error('‚ùå Failed to toggle auto-trading:', data.error);
                }
            } catch (error) {
                console.error('‚ùå Failed to toggle auto-trading:', error);
            }
        }

        // Start the scan-execute-pause worker loop
        function startWorkerLoop() {
            if (workerLoopActive) {
                console.log('‚ö†Ô∏è Worker loop already active');
                return;
            }

            workerLoopActive = true;
            console.log('üöÄ Starting worker loop...');
            runWorkerCycle();
        }

        // Stop the worker loop
        function stopWorkerLoop() {
            workerLoopActive = false;
            if (workerLoopTimeout) {
                clearTimeout(workerLoopTimeout);
                workerLoopTimeout = null;
            }
            console.log('‚èπÔ∏è Worker loop stopped');
        }

        // Run a single worker cycle: scan ‚Üí execute ‚Üí wait 15s ‚Üí repeat
        async function runWorkerCycle() {
            if (!workerLoopActive) {
                console.log('‚èπÔ∏è Worker loop not active, stopping');
                return;
            }

            console.log('üîÑ [Worker] Starting cycle...');

            try {
                // Step 1: Scan for best opportunity
                console.log('üîç [Worker] Scanning for opportunities...');
                const scanResponse = await fetch(`${API_BASE}/scan?userId=${USER_ID}`);
                const scanData = await scanResponse.json();

                if (!scanData.success) {
                    console.warn('‚ö†Ô∏è [Worker] Scan failed:', scanData.message);
                    scheduleNextCycle();
                    return;
                }

                const opportunity = scanData.data.opportunity;

                if (!opportunity) {
                    console.log('‚ÑπÔ∏è [Worker] No profitable paths found, waiting...');
                    scheduleNextCycle();
                    return;
                }

                console.log(`‚úÖ [Worker] Found opportunity: ${opportunity.id} (${opportunity.profitPercent.toFixed(2)}% profit)`);

                // Step 2: Execute the opportunity
                console.log('‚ö° [Worker] Executing trade...');
                const executeResponse = await fetch(`${API_BASE}/execute`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: USER_ID,
                        path: opportunity,
                        amount: opportunity.inputAmount || 1000 // Use path's input amount or default
                    })
                });

                const executeData = await executeResponse.json();

                if (executeData.success) {
                    const execution = executeData.execution;
                    console.log(`‚úÖ [Worker] Trade executed successfully!`);
                    console.log(`üí∞ [Worker] Profit: ${execution.profit} (${execution.profitPercent.toFixed(2)}%)`);
                    console.log(`‚è±Ô∏è [Worker] Duration: ${execution.duration}ms`);

                    // Update UI with execution results
                    updateExecutionStats(execution);
                } else {
                    console.error('‚ùå [Worker] Trade execution failed:', executeData.error);
                }

            } catch (error) {
                console.error('‚ùå [Worker] Cycle error:', error);
            }

            // Step 3: Wait 15 seconds and repeat
            scheduleNextCycle();
        }

        // Schedule the next worker cycle after 15 seconds
        function scheduleNextCycle() {
            if (!workerLoopActive) return;

            const delaySeconds = 15;
            console.log(`‚è∞ [Worker] Next cycle in ${delaySeconds} seconds...`);

            workerLoopTimeout = setTimeout(() => {
                runWorkerCycle();
            }, delaySeconds * 1000);
        }

        // Update UI with execution stats
        function updateExecutionStats(execution) {
            // Update swaps today count
            const swapsTodayEl = document.getElementById('swapsToday');
            if (swapsTodayEl) {
                const currentCount = parseInt(swapsTodayEl.textContent) || 0;
                swapsTodayEl.textContent = currentCount + 1;
            }

            // Reload stats and paths to reflect changes
            setTimeout(() => {
                loadStats();
                loadPaths();
            }, 1000);
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // TRADING ACTIVITY FUNCTIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        // Tab switching for Trading Activity
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('activity-tab-btn')) {
                const tab = e.target.dataset.tab;

                // Update buttons
                document.querySelectorAll('.activity-tab-btn').forEach(btn => {
                    btn.style.background = 'rgba(255,255,255,0.03)';
                    btn.style.border = '1px solid transparent';
                    btn.style.color = '#888';
                    btn.classList.remove('active');
                });

                e.target.style.background = 'rgba(0,212,255,0.15)';
                e.target.style.border = '1px solid #00d4ff';
                e.target.style.color = '#00d4ff';
                e.target.classList.add('active');

                // Update content
                document.querySelectorAll('.activity-tab-content').forEach(content => {
                    content.style.display = 'none';
                });

                if (tab === 'swaps') {
                    document.getElementById('activityTabSwaps').style.display = 'block';
                    loadRecentSwaps();
                } else if (tab === 'balances') {
                    document.getElementById('activityTabBalances').style.display = 'block';

                    // Check if we have any balances in localStorage
                    const hasBalances = Object.keys(localStorage).some(key => key.includes('_current'));

                    if (!hasBalances) {
                        // First time opening - auto-refresh from exchanges
                        console.log('üí∞ First time opening Balance Tracker - auto-refreshing...');
                        refreshBalances();
                    } else {
                        // Show cached balances
                        loadBalanceTracker();
                    }
                }
            }
        });

        // Load recent currency swaps
        async function loadRecentSwaps() {
            try {
                console.log('üìú Loading recent swaps...');
                const response = await fetch(`${API_BASE}/recent?userId=${USER_ID}&limit=10`);
                const data = await response.json();

                console.log('üìú Recent swaps response:', data);

                const container = document.getElementById('recentSwaps');

                if (data.success && data.data && data.data.length > 0) {
                    container.innerHTML = data.data.map(swap => `
                        <div style="background: rgba(0,212,255,0.05); padding: 12px; border-radius: 8px; border-left: 3px solid ${swap.status === 'completed' ? '#00ff88' : swap.status === 'failed' ? '#ff6b6b' : '#ffb347'}; margin-bottom: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                <div style="font-weight: bold; color: #00d4ff;">
                                    ${swap.from_asset} ‚Üí ${swap.to_asset}
                                </div>
                                <div style="font-size: 0.85rem; color: ${swap.profit_percent >= 0 ? '#00ff88' : '#ff6b6b'};">
                                    ${swap.profit_percent >= 0 ? '+' : ''}${swap.profit_percent}%
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 0.85rem; color: #888;">
                                <span>${swap.from_exchange} ‚Üí ${swap.to_exchange}</span>
                                <span>${new Date(swap.created_at).toLocaleString()}</span>
                            </div>
                            <div style="margin-top: 5px; font-size: 0.8rem; padding: 4px 8px; background: rgba(0,0,0,0.3); border-radius: 4px; display: inline-block; color: ${swap.status === 'completed' ? '#00ff88' : swap.status === 'failed' ? '#ff6b6b' : '#ffb347'};">
                                ${swap.status.toUpperCase()}
                            </div>
                        </div>
                    `).join('');

                    console.log(`‚úÖ Loaded ${data.data.length} recent swaps`);
                } else {
                    container.innerHTML = `
                        <div style="text-align: center; color: #888; padding: 20px;">
                            No swaps yet. Enable auto-trading to start.
                        </div>
                    `;
                    console.log('‚ö†Ô∏è No recent swaps found');
                }
            } catch (error) {
                console.error('‚ùå Failed to load recent swaps:', error);
            }
        }

        // Load balance tracker
        async function loadBalanceTracker() {
            try {
                console.log('üí∞ Loading balance tracker...');

                // Get selected exchanges and currencies from settings
                const settingsResponse = await fetch(`${API_BASE}/settings?userId=${USER_ID}`);
                const settingsData = await settingsResponse.json();

                if (!settingsData.success) {
                    console.error('‚ùå Failed to load settings for balance tracker');
                    return;
                }

                const settings = settingsData.data;
                const selectedExchanges = settings.selected_exchanges || [];
                const selectedCurrencies = settings.selected_currencies || [];

                console.log('üí∞ Tracking balances for:', { exchanges: selectedExchanges, currencies: selectedCurrencies });

                if (selectedExchanges.length === 0 || selectedCurrencies.length === 0) {
                    document.getElementById('balanceTrackerContent').innerHTML = `
                        <div style="text-align: center; color: #888; padding: 20px;">
                            Select exchanges and currencies in the Setup section to track balances.
                        </div>
                    `;
                    return;
                }

                // Calculate totals per currency across all exchanges
                const currencyTotals = {};
                for (const currency of selectedCurrencies) {
                    let totalStarting = 0;
                    let totalCurrent = 0;

                    for (const exchange of selectedExchanges) {
                        const balanceKey = `${exchange}_${currency}`;
                        totalStarting += parseFloat(localStorage.getItem(`${balanceKey}_starting`) || 0);
                        totalCurrent += parseFloat(localStorage.getItem(`${balanceKey}_current`) || 0);
                    }

                    const change = totalCurrent - totalStarting;
                    const changePercent = totalStarting > 0 ? ((change / totalStarting) * 100) : 0;

                    currencyTotals[currency] = {
                        starting: totalStarting,
                        current: totalCurrent,
                        change: change,
                        changePercent: changePercent
                    };
                }

                console.log('üí∞ Currency totals:', currencyTotals);

                // Build HTML starting with Total Overview
                let html = `
                    <!-- Total Overview Section -->
                    <div style="background: linear-gradient(135deg, rgba(0,255,136,0.1) 0%, rgba(0,212,255,0.1) 100%); padding: 20px; border-radius: 12px; margin-bottom: 25px; border: 2px solid rgba(0,255,136,0.3);">
                        <h4 style="color: #00ff88; margin: 0 0 15px 0; display: flex; align-items: center; gap: 10px;">
                            üìä Total Movement Across All Exchanges
                        </h4>

                        <!-- Period Tabs -->
                        <div style="display: flex; gap: 5px; margin-bottom: 15px; background: rgba(0,0,0,0.3); padding: 5px; border-radius: 8px;">
                            <button class="period-tab-btn active" data-period="total" style="flex: 1; padding: 8px 10px; background: rgba(0,255,136,0.15); border: 1px solid #00ff88; border-radius: 6px; color: #00ff88; cursor: pointer; font-weight: bold; font-size: 0.85rem;">
                                All Time
                            </button>
                            <button class="period-tab-btn" data-period="daily" style="flex: 1; padding: 8px 10px; background: rgba(255,255,255,0.03); border: 1px solid transparent; border-radius: 6px; color: #888; cursor: pointer; font-weight: bold; font-size: 0.85rem;">
                                Daily
                            </button>
                            <button class="period-tab-btn" data-period="weekly" style="flex: 1; padding: 8px 10px; background: rgba(255,255,255,0.03); border: 1px solid transparent; border-radius: 6px; color: #888; cursor: pointer; font-weight: bold; font-size: 0.85rem;">
                                Weekly
                            </button>
                            <button class="period-tab-btn" data-period="monthly" style="flex: 1; padding: 8px 10px; background: rgba(255,255,255,0.03); border: 1px solid transparent; border-radius: 6px; color: #888; cursor: pointer; font-weight: bold; font-size: 0.85rem;">
                                Monthly
                            </button>
                        </div>

                        <!-- Currency Summary Cards -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                `;

                // Add a card for each currency showing total movement
                for (const currency of selectedCurrencies) {
                    const totals = currencyTotals[currency];
                    const isProfit = totals.change >= 0;

                    html += `
                        <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; border-left: 4px solid ${isProfit ? '#00ff88' : '#ff6b6b'};">
                            <div style="font-weight: bold; color: #00d4ff; font-size: 1.1rem; margin-bottom: 12px;">${currency}</div>
                            <div style="display: flex; flex-direction: column; gap: 8px; font-size: 0.9rem;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: #888;">Starting:</span>
                                    <span style="color: #00d4ff; font-weight: bold;">${totals.starting.toFixed(2)}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: #888;">Current:</span>
                                    <span style="color: #00d4ff; font-weight: bold;">${totals.current.toFixed(2)}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.1);">
                                    <span style="color: #888; font-weight: bold;">P/L:</span>
                                    <span style="color: ${isProfit ? '#00ff88' : '#ff6b6b'}; font-weight: bold; font-size: 1.1rem;">
                                        ${isProfit ? '+' : ''}${totals.change.toFixed(2)}
                                    </span>
                                </div>
                                <div style="text-align: right;">
                                    <span style="color: ${isProfit ? '#00ff88' : '#ff6b6b'}; font-weight: bold; font-size: 0.95rem;">
                                        (${isProfit ? '+' : ''}${totals.changePercent.toFixed(2)}%)
                                    </span>
                                </div>
                            </div>
                        </div>
                    `;
                }

                html += `
                        </div>
                        <div style="margin-top: 12px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 6px; text-align: center; color: #888; font-size: 0.85rem;">
                            üí° Shows combined balance across all selected exchanges
                        </div>
                    </div>

                    <!-- Individual Exchange Cards -->
                    <h4 style="color: #00d4ff; margin: 20px 0 15px 0; padding-bottom: 10px; border-bottom: 1px solid rgba(0,212,255,0.3);">
                        Per Exchange Breakdown
                    </h4>
                `;

                // Generate individual exchange balance cards
                for (const exchange of selectedExchanges) {
                    html += `
                        <div style="margin-bottom: 25px; background: rgba(0,212,255,0.05); padding: 15px; border-radius: 10px; border: 1px solid rgba(0,212,255,0.3);">
                            <h4 style="color: #00d4ff; margin: 0 0 15px 0;">üè¶ ${exchange}</h4>
                    `;

                    // Add currency cards for this exchange
                    for (const currency of selectedCurrencies) {
                        const balanceKey = `${exchange}_${currency}`;
                        const startingBalance = parseFloat(localStorage.getItem(`${balanceKey}_starting`) || 0);
                        const currentBalance = parseFloat(localStorage.getItem(`${balanceKey}_current`) || 0);
                        const change = currentBalance - startingBalance;
                        const changePercent = startingBalance > 0 ? ((change / startingBalance) * 100) : 0;

                        html += `
                            <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid ${change >= 0 ? '#00ff88' : '#ff6b6b'};">
                                <div style="font-weight: bold; color: #00d4ff; margin-bottom: 8px;">${currency}</div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; font-size: 0.9rem;">
                                    <div>
                                        <div style="color: #888; font-size: 0.8rem;">Starting</div>
                                        <div style="color: #00d4ff; font-weight: bold;">${startingBalance.toFixed(2)}</div>
                                    </div>
                                    <div>
                                        <div style="color: #888; font-size: 0.8rem;">Current</div>
                                        <div style="color: #00d4ff; font-weight: bold;">${currentBalance.toFixed(2)}</div>
                                    </div>
                                    <div>
                                        <div style="color: #888; font-size: 0.8rem;">Change</div>
                                        <div style="color: ${change >= 0 ? '#00ff88' : '#ff6b6b'}; font-weight: bold;">
                                            ${change >= 0 ? '+' : ''}${change.toFixed(2)} (${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(2)}%)
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }

                    html += `</div>`;
                }

                document.getElementById('balanceTrackerContent').innerHTML = html;
                document.getElementById('balanceLastUpdate').textContent = new Date().toLocaleString();

                // Add tab switching for period tabs (placeholder for future daily/weekly/monthly tracking)
                document.querySelectorAll('.period-tab-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        document.querySelectorAll('.period-tab-btn').forEach(b => {
                            b.style.background = 'rgba(255,255,255,0.03)';
                            b.style.border = '1px solid transparent';
                            b.style.color = '#888';
                        });
                        this.style.background = 'rgba(0,255,136,0.15)';
                        this.style.border = '1px solid #00ff88';
                        this.style.color = '#00ff88';

                        const period = this.dataset.period;
                        console.log(`üìä Selected period: ${period}`);
                        // TODO: Implement period filtering (requires timestamp tracking)
                    });
                });

                console.log('‚úÖ Balance tracker loaded with totals');
            } catch (error) {
                console.error('‚ùå Failed to load balance tracker:', error);
            }
        }

        // Refresh balances from exchanges
        async function refreshBalances() {
            try {
                console.log('üîÑ Refreshing balances from exchanges...');

                // Get selected exchanges and currencies from checkboxes
                const exchangeCheckboxes = document.querySelectorAll('#exchangeCheckboxes input[type="checkbox"]:checked');
                const selectedExchanges = Array.from(exchangeCheckboxes).map(cb => cb.value);

                const currencyCheckboxes = document.querySelectorAll('#currencyCheckboxes input[type="checkbox"]:checked');
                const selectedCurrencies = Array.from(currencyCheckboxes).map(cb => cb.value);

                if (selectedExchanges.length === 0) {
                    alert('Please select at least one exchange first');
                    return;
                }

                // Show loading indicator
                document.getElementById('balanceTrackerContent').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #00d4ff;">
                        <div style="font-size: 2rem; margin-bottom: 10px;">‚è≥</div>
                        <div>Fetching live balances from exchanges...</div>
                        <div style="font-size: 0.85rem; color: #888; margin-top: 10px;">This may take a few seconds</div>
                    </div>
                `;

                // Gather credentials from localStorage for each exchange
                const exchangeCredentials = [];
                const missingCredentials = [];

                for (const exchange of selectedExchanges) {
                    const exchangeLower = exchange.toLowerCase();
                    const apiKey = localStorage.getItem(`${exchangeLower}_currency-swap_api`);
                    const apiSecret = localStorage.getItem(`${exchangeLower}_currency-swap_secret`);
                    const apiPassphrase = localStorage.getItem(`${exchangeLower}_currency-swap_passphrase`);
                    const memo = localStorage.getItem(`${exchangeLower}_currency-swap_memo`);

                    console.log(`üîç Checking credentials for ${exchange}:`, {
                        exchangeLower,
                        apiKeyFound: !!apiKey,
                        apiKeyLength: apiKey ? apiKey.length : 0,
                        apiSecretFound: !!apiSecret,
                        apiSecretLength: apiSecret ? apiSecret.length : 0
                    });

                    if (!apiKey || !apiSecret) {
                        missingCredentials.push(exchange);
                        console.warn(`‚ö†Ô∏è No credentials found for ${exchange} in localStorage`);
                        console.log(`üìã localStorage keys:`, Object.keys(localStorage).filter(k => k.includes(exchangeLower)));
                        continue;
                    }

                    exchangeCredentials.push({
                        exchange: exchangeLower,
                        apiKey,
                        apiSecret,
                        apiPassphrase,
                        memo
                    });
                }

                if (exchangeCredentials.length === 0) {
                    throw new Error(`No credentials found. Please connect exchanges in Strategy API Configuration first.\n\nMissing: ${missingCredentials.join(', ')}`);
                }

                console.log(`üí∞ Fetching balances for ${exchangeCredentials.length} exchanges with credentials`);

                // Fetch balances from each exchange using existing trading endpoints (same as Triangular Arb)
                const balances = {};
                const errors = {};

                for (const credData of exchangeCredentials) {
                    try {
                        const { exchange, apiKey, apiSecret, apiPassphrase, memo } = credData;

                        console.log(`üîÑ Fetching ${exchange} balance...`);

                        // Use trading balance endpoints (same as Strategy API Configuration & Triangular Arb)
                        const balanceEndpoint = exchange === 'chainex'
                            ? '/api/v1/trading/chainex/balance'
                            : `/api/v1/trading/${exchange}/balance`;

                        const requestBody = {
                            apiKey: apiKey,
                            apiSecret: apiSecret
                        };

                        // Add passphrase if provided (for OKX, KuCoin, etc.)
                        if (apiPassphrase) {
                            requestBody.passphrase = apiPassphrase;
                        }

                        // Add memo if provided (for BitMart)
                        if (memo) {
                            requestBody.memo = memo;
                        }

                        const response = await fetch(balanceEndpoint, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(requestBody)
                        });

                        const result = await response.json();

                        console.log(`üì• ${exchange} response:`, result);

                        // Handle different response formats (same as Triangular Arb)
                        let rawBalances = null;
                        if (result.success && result.data) {
                            rawBalances = result.data.balances || result.data;
                        } else if (result.success && result.balances) {
                            rawBalances = result.balances;
                        } else if (result.balances) {
                            rawBalances = result.balances;
                        }

                        if (rawBalances) {
                            // Find the display name with correct casing
                            const exchangeDisplay = selectedExchanges.find(e => e.toLowerCase() === exchange) || exchange;

                            // Extract only requested currencies with balance > 0
                            const exchangeBalances = {};
                            for (const currency of selectedCurrencies) {
                                if (rawBalances[currency] && parseFloat(rawBalances[currency]) > 0) {
                                    exchangeBalances[currency] = {
                                        free: parseFloat(rawBalances[currency]),
                                        used: 0,
                                        total: parseFloat(rawBalances[currency])
                                    };
                                }
                            }

                            if (Object.keys(exchangeBalances).length > 0) {
                                balances[exchangeDisplay] = exchangeBalances;
                                console.log(`‚úÖ ${exchange} balances:`, exchangeBalances);
                            }
                        } else {
                            errors[exchange] = 'Invalid response format';
                        }

                    } catch (error) {
                        console.error(`‚ùå Failed to fetch ${credData.exchange} balance:`, error);
                        errors[credData.exchange] = error.message;
                    }
                }

                console.log('üíæ Storing balances to localStorage...');

                // Store balances in localStorage
                let storedCount = 0;
                for (const exchange in balances) {
                    console.log(`üí± Processing balances for ${exchange}:`, balances[exchange]);

                    for (const currency in balances[exchange]) {
                        const balanceKey = `${exchange}_${currency}`;
                        const total = balances[exchange][currency].total;

                        // If starting balance doesn't exist, set it now (first time)
                        if (!localStorage.getItem(`${balanceKey}_starting`)) {
                            localStorage.setItem(`${balanceKey}_starting`, total);
                            console.log(`üìä Set starting balance for ${balanceKey}: ${total}`);
                        }

                        // Update current balance
                        localStorage.setItem(`${balanceKey}_current`, total);
                        console.log(`üìä Updated current balance for ${balanceKey}: ${total}`);
                        storedCount++;
                    }
                }

                console.log(`‚úÖ Stored ${storedCount} balance entries to localStorage`);

                // Show errors if any (including missing credentials)
                if (missingCredentials.length > 0 || Object.keys(errors).length > 0) {
                    const allErrors = { ...errors };
                    missingCredentials.forEach(exchange => {
                        allErrors[exchange] = 'No credentials - connect in Strategy API Configuration';
                    });

                    console.warn('‚ö†Ô∏è Some exchanges had errors:', allErrors);

                    if (storedCount === 0) {
                        // No balances fetched at all
                        let errorMessage = 'Failed to fetch balances:\n\n';
                        for (const exchange in allErrors) {
                            errorMessage += `${exchange}: ${allErrors[exchange]}\n`;
                        }
                        alert(errorMessage);
                    } else {
                        // Some balances fetched successfully
                        console.log(`‚ö†Ô∏è Fetched ${storedCount} balances with ${Object.keys(allErrors).length} errors`);
                    }
                }

                console.log('‚úÖ Balances refreshed successfully');

                // Reload the balance tracker display
                await loadBalanceTracker();

                alert('‚úÖ Balances refreshed from exchanges!');

            } catch (error) {
                console.error('‚ùå Failed to refresh balances:', error);
                alert(`Failed to refresh balances: ${error.message}`);

                // Reload anyway to show what we have
                await loadBalanceTracker();
            }
        }

        // Reset all starting balances
        function resetAllBalances() {
            if (!confirm('Are you sure you want to reset all starting balances? This will set all starting balances to current balances.')) {
                return;
            }

            console.log('üîÑ Resetting all starting balances...');

            // Get all localStorage keys for balances
            const keys = Object.keys(localStorage);
            const balanceKeys = keys.filter(key => key.includes('_current'));

            balanceKeys.forEach(key => {
                const currentValue = localStorage.getItem(key);
                const startingKey = key.replace('_current', '_starting');
                localStorage.setItem(startingKey, currentValue);
                console.log(`Reset ${startingKey} to ${currentValue}`);
            });

            alert('All starting balances have been reset to current balances.');
            loadBalanceTracker();
        }

        // ============================================================================
        // CURRENCY SWAP ARBITRAGE ABOUT MODAL
        // ============================================================================

        function openCurrencySwapAboutModal() {
            const modal = document.getElementById('currencySwapAboutModal');
            if (modal) {
                modal.style.display = 'flex';
                console.log('‚ÑπÔ∏è [About Modal] Currency Swap Arbitrage info opened');
            }
        }

        function closeCurrencySwapAboutModal() {
            const modal = document.getElementById('currencySwapAboutModal');
            if (modal) {
                modal.style.display = 'none';
                console.log('‚ÑπÔ∏è [About Modal] Currency Swap Arbitrage info closed');
            }
        }

        // Close modal when clicking outside the content
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('currencySwapAboutModal');
            if (event.target === modal) {
                closeCurrencySwapAboutModal();
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeCurrencySwapAboutModal();
            }
        });

        // End of About Modal Functionality
    </script>
</body>
</html>
