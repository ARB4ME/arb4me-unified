<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Currency Swap Arbitrage - ARB4ME</title>
    <style>
        body {
            background: linear-gradient(135deg, #0c0c1e 0%, #161632 100%);
            color: #b8c6db;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }

        .currency-swap-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #b8c6db;
            font-size: 0.9rem;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            color: #fff;
            font-size: 0.9rem;
        }

        .toggle-switch {
            width: 50px;
            height: 25px;
            background: #ff6b6b;
            border-radius: 25px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
        }

        .toggle-switch.active {
            background: #00ff88;
        }

        .toggle-knob {
            width: 21px;
            height: 21px;
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 2px;
            left: 2px;
            transition: all 0.3s;
        }

        .toggle-switch.active .toggle-knob {
            left: 27px;
        }

        .btn {
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #b8c6db;
        }

        .warning-box {
            background: rgba(255,107,107,0.1);
            border: 2px solid #ff6b6b;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .info-box {
            background: rgba(0,212,255,0.1);
            border: 2px solid #00d4ff;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .success-box {
            background: rgba(0,255,136,0.1);
            border: 2px solid #00ff88;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .currency-pair {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            margin-bottom: 10px;
        }

        /* Make tab content visible by default on this page */
        #currencySwapTab {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
    </style>
</head>
<body>
    <div class="currency-swap-container">
        <!-- Header with Auto-Trading Toggle -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
            <button onclick="returnToPlatform()" class="btn" style="background: linear-gradient(45deg, #ff6b6b 0%, #ee5a24 100%);">
                ‚Üê Return to Platform
            </button>
            <div style="display: flex; align-items: center; gap: 15px;">
                <span style="color: #b8c6db;">Auto-Trading:</span>
                <div class="toggle-switch" id="autoTradingToggle">
                    <div class="toggle-knob"></div>
                </div>
                <button onclick="openRiskSettings()" class="btn">‚öôÔ∏è Risk Settings</button>
            </div>
        </div>

        <!-- Currency Swap Arbitrage Management Tab -->
        <div id="currencySwapTab" class="tab-content active">
            <h3 style="color: #00d4ff; margin-bottom: 15px;">üí± Currency Swap Arbitrage Management</h3>

            <div style="margin-bottom: 20px; padding: 15px; background: rgba(138,43,226,0.1); border: 2px solid #8a2be2; border-radius: 10px;">
                <div style="font-size: 1.2rem; color: #8a2be2; margin-bottom: 15px; font-weight: bold; text-align: center;">
                    üåç FIAT CURRENCY ARBITRAGE
                </div>
                <div style="color: #b8c6db; text-align: center;">
                    Profit from exchange rate differences between fiat currencies (ZAR, USD, EUR, GBP) across different crypto exchanges.
                </div>
            </div>

            <!-- How It Works -->
            <div class="success-box">
                <h4 style="color: #00ff88; margin-bottom: 10px;">üí° How Currency Swap ARB Works</h4>
                <div style="color: #b8c6db; font-size: 0.9rem; line-height: 1.6;">
                    <p style="margin-bottom: 10px;">
                        <strong>Example:</strong> Buy BTC with ZAR on VALR at favorable ZAR/USD rate,
                        transfer to Binance, sell for USD at better rate. Profit from forex spread!
                    </p>
                    <ol style="padding-left: 20px; margin: 10px 0;">
                        <li>Monitor exchange rates across different platforms</li>
                        <li>Identify when ZAR is stronger on one exchange vs another</li>
                        <li>Buy crypto with undervalued fiat currency</li>
                        <li>Sell on exchange where your target fiat is overvalued</li>
                        <li>Capture the forex arbitrage profit</li>
                    </ol>
                </div>
            </div>

            <!-- Important Considerations -->
            <div class="warning-box">
                <h4 style="color: #ff6b6b; margin-bottom: 10px;">‚ö†Ô∏è Important Considerations</h4>
                <ul style="color: #b8c6db; font-size: 0.9rem; margin: 10px 0; padding-left: 20px;">
                    <li>Exchange rates can vary significantly between exchanges</li>
                    <li>Banking fees for fiat deposits/withdrawals apply</li>
                    <li>Currency conversion fees may reduce profits</li>
                    <li>Regulatory restrictions may apply to forex trading</li>
                    <li>Larger capital required for meaningful profits</li>
                    <li>Settlement times for fiat can be 1-5 business days</li>
                </ul>
            </div>

            <!-- System Overview -->
            <div class="info-box">
                <h4 style="color: #00d4ff; margin-bottom: 10px;">üìä Currency Swap Overview</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                    <div style="padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.5rem; color: #00ff88; font-weight: bold;" id="activePairs">0</div>
                        <div style="font-size: 0.9rem; color: #b8c6db;">Active Currency Pairs</div>
                    </div>
                    <div style="padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.5rem; color: #ffb347; font-weight: bold;" id="avgSpread">0%</div>
                        <div style="font-size: 0.9rem; color: #b8c6db;">Average Spread</div>
                    </div>
                    <div style="padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.5rem; color: #ff6b6b; font-weight: bold;" id="swapsToday">0</div>
                        <div style="font-size: 0.9rem; color: #b8c6db;">Swaps Today</div>
                    </div>
                    <div style="padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.5rem; color: #00d4ff; font-weight: bold;" id="totalForexProfit">$0.00</div>
                        <div style="font-size: 0.9rem; color: #b8c6db;">Total Forex Profit</div>
                    </div>
                </div>
            </div>

            <!-- Currency Configuration -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px;">
                <!-- Currency Pairs -->
                <div class="stat-card">
                    <h4 style="color: #ffb347; margin-bottom: 15px;">üí∞ Currency Pairs to Monitor</h4>
                    <div class="currency-pair">
                        <span>üáøüá¶ ZAR/USD</span>
                        <div class="toggle-switch" id="zarUsdToggle">
                            <div class="toggle-knob"></div>
                        </div>
                    </div>
                    <div class="currency-pair">
                        <span>üá™üá∫ EUR/USD</span>
                        <div class="toggle-switch" id="eurUsdToggle">
                            <div class="toggle-knob"></div>
                        </div>
                    </div>
                    <div class="currency-pair">
                        <span>üá¨üáß GBP/USD</span>
                        <div class="toggle-switch" id="gbpUsdToggle">
                            <div class="toggle-knob"></div>
                        </div>
                    </div>
                    <div class="currency-pair">
                        <span>üáøüá¶ ZAR/EUR</span>
                        <div class="toggle-switch" id="zarEurToggle">
                            <div class="toggle-knob"></div>
                        </div>
                    </div>
                    <div class="currency-pair">
                        <span>üá≥üá¨ NGN/USD</span>
                        <div class="toggle-switch" id="ngnUsdToggle">
                            <div class="toggle-knob"></div>
                        </div>
                    </div>
                    <p style="font-size: 0.85rem; color: #b8c6db; margin-top: 10px;">
                        Enable pairs you can access through your bank accounts
                    </p>
                </div>

                <!-- Exchange Settings -->
                <div class="stat-card">
                    <h4 style="color: #ffb347; margin-bottom: 15px;">üè¶ Exchange Preferences</h4>
                    <div class="form-group">
                        <label>Primary Fiat Currency</label>
                        <select id="primaryCurrency">
                            <option value="ZAR">ZAR - South African Rand</option>
                            <option value="USD">USD - US Dollar</option>
                            <option value="EUR">EUR - Euro</option>
                            <option value="GBP">GBP - British Pound</option>
                            <option value="NGN">NGN - Nigerian Naira</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Min Spread for Alert (%)</label>
                        <input type="number" id="minSpread" value="2" min="0.5" max="10" step="0.5">
                    </div>
                    <div class="form-group">
                        <label>Max Trade Size (USD equiv)</label>
                        <input type="number" id="maxFiatTrade" value="5000" min="100" max="100000">
                    </div>
                    <div class="form-group">
                        <label>Include Banking Fees</label>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="toggle-switch" id="includeBankingFees">
                                <div class="toggle-knob"></div>
                            </div>
                            <span style="font-size: 0.85rem; color: #b8c6db;">Calculate all fees</span>
                        </div>
                    </div>
                </div>

                <!-- Deposit Addresses -->
                <div class="stat-card">
                    <h4 style="color: #61dafb; margin-bottom: 15px;">üì¨ Deposit Addresses</h4>
                    <p style="font-size: 0.85rem; color: #b8c6db; margin-bottom: 15px;">
                        Configure deposit addresses for exchanges connected in Strategy Setup. Required for automated transfers.
                    </p>

                    <div id="depositAddressList" style="display: flex; flex-direction: column; gap: 15px;">
                        <!-- Deposit addresses will be loaded here -->
                        <p style="color: #b8c6db; font-size: 0.85rem;">
                            Loading connected exchanges...
                        </p>
                    </div>

                    <button id="saveDepositAddresses" class="save-btn" style="margin-top: 15px; width: 100%; padding: 12px; background: #00ff88; color: #0a0e1a; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                        Save All Addresses
                    </button>
                </div>

                <!-- Best Opportunities -->
                <div class="stat-card">
                    <h4 style="color: #00ff88; margin-bottom: 15px;">üéØ Best Opportunities</h4>
                    <div style="color: #b8c6db; font-size: 0.85rem; line-height: 1.8;">
                        <p style="margin-bottom: 10px;">
                            <strong style="color: #00ff88;">üáøüá¶ South Africa:</strong><br>
                            VALR ‚Üî Luno (ZAR rates differ)<br>
                            Local ‚Üî International exchanges
                        </p>
                        <p style="margin-bottom: 10px;">
                            <strong style="color: #ffb347;">üåç International:</strong><br>
                            Binance ‚Üî Kraken (EUR/USD)<br>
                            Regional exchanges with local fiat
                        </p>
                        <p style="margin-bottom: 10px;">
                            <strong style="color: #00d4ff;">üí° Pro Tips:</strong><br>
                            ‚Ä¢ Watch forex market volatility<br>
                            ‚Ä¢ Best during market opens<br>
                            ‚Ä¢ Combine with crypto arbitrage
                        </p>
                    </div>
                </div>
            </div>

            <!-- Forex Rate Monitor -->
            <div class="stat-card" style="margin-bottom: 20px;">
                <h4 style="color: #8a2be2; margin-bottom: 15px;">üìà Live Exchange Rate Comparison</h4>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 2px solid #8a2be2;">
                                <th style="padding: 10px; text-align: left; color: #b8c6db;">Exchange</th>
                                <th style="padding: 10px; text-align: center; color: #b8c6db;">ZAR/USD</th>
                                <th style="padding: 10px; text-align: center; color: #b8c6db;">EUR/USD</th>
                                <th style="padding: 10px; text-align: center; color: #b8c6db;">GBP/USD</th>
                                <th style="padding: 10px; text-align: center; color: #b8c6db;">Spread</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <td style="padding: 10px; color: #00ff88;">VALR</td>
                                <td style="padding: 10px; text-align: center;">18.50</td>
                                <td style="padding: 10px; text-align: center;">-</td>
                                <td style="padding: 10px; text-align: center;">-</td>
                                <td style="padding: 10px; text-align: center; color: #ffb347;">+0.5%</td>
                            </tr>
                            <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <td style="padding: 10px; color: #00ff88;">Luno</td>
                                <td style="padding: 10px; text-align: center;">18.35</td>
                                <td style="padding: 10px; text-align: center;">1.08</td>
                                <td style="padding: 10px; text-align: center;">-</td>
                                <td style="padding: 10px; text-align: center; color: #ff6b6b;">-0.3%</td>
                            </tr>
                            <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <td style="padding: 10px; color: #00ff88;">Binance</td>
                                <td style="padding: 10px; text-align: center;">-</td>
                                <td style="padding: 10px; text-align: center;">1.09</td>
                                <td style="padding: 10px; text-align: center;">1.27</td>
                                <td style="padding: 10px; text-align: center; color: #00ff88;">+0.8%</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <p style="font-size: 0.85rem; color: #888; margin-top: 10px; text-align: center;">
                    * Sample data - Connect exchanges for live rates
                </p>
            </div>

            <!-- Control Buttons -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                <button onclick="scanForexOpportunities()" class="btn">
                    üîç Scan Forex Rates
                </button>
                <button onclick="calculateSwapProfit()" class="btn">
                    üí∞ Calculate Profit
                </button>
                <button onclick="viewSwapHistory()" class="btn">
                    üìä Swap History
                </button>
                <button onclick="setupAlerts()" class="btn">
                    üîî Setup Alerts
                </button>
            </div>

            <!-- Quick Calculator -->
            <div class="stat-card">
                <h4 style="color: #00d4ff; margin-bottom: 15px;">üßÆ Currency Swap Calculator</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div class="form-group">
                        <label>Amount</label>
                        <input type="number" id="swapAmount" placeholder="1000" step="1">
                    </div>
                    <div class="form-group">
                        <label>From Currency</label>
                        <select id="fromCurrency">
                            <option value="ZAR">ZAR</option>
                            <option value="USD">USD</option>
                            <option value="EUR">EUR</option>
                            <option value="GBP">GBP</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Exchange A Rate</label>
                        <input type="number" id="rateA" placeholder="18.50" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>Exchange B Rate</label>
                        <input type="number" id="rateB" placeholder="18.35" step="0.01">
                    </div>
                </div>
                <button onclick="calculateForexArbitrage()" class="btn" style="width: 100%; margin-top: 15px;">
                    Calculate Currency Arbitrage
                </button>
                <div id="forexResult" style="margin-top: 15px; padding: 15px; background: rgba(0,255,136,0.1); border-radius: 8px; display: none;">
                    <!-- Results will appear here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Risk Settings Modal -->
    <div id="riskSettingsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: #1a1a2e; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%; border: 2px solid #667eea;">
            <h3 style="color: #00d4ff; margin-bottom: 20px;">‚öôÔ∏è Currency Swap Risk Settings</h3>

            <div class="form-group">
                <label>Minimum Net Profit Threshold (%)</label>
                <input type="number" id="thresholdPercent" min="0.1" max="10" step="0.1" value="0.5">
                <small style="color: #888;">Guaranteed profit AFTER all fees</small>
            </div>

            <div class="form-group">
                <label>Max Trade Amount (USDT)</label>
                <input type="number" id="maxTradeAmountUSDT" min="100" max="100000" step="100" value="5000">
            </div>

            <div class="form-group">
                <label>Max Daily Swaps</label>
                <input type="number" id="maxDailySwaps" min="1" max="100" value="10">
            </div>

            <div class="form-group">
                <label>Preferred Bridge Currency</label>
                <select id="preferredBridge">
                    <option value="AUTO">Auto (Best Rate)</option>
                    <option value="XRP">XRP (Fastest, Cheapest)</option>
                    <option value="USDT">USDT (Most Liquid)</option>
                </select>
            </div>

            <div class="form-group">
                <label>Enable Categories</label>
                <div style="display: flex; gap: 15px; margin-top: 5px;">
                    <label style="display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" id="enableZAR" checked> ZAR Conversions
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" id="enableInternational"> International
                    </label>
                </div>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button onclick="saveRiskSettings()" class="btn" style="flex: 1;">Save Settings</button>
                <button onclick="closeRiskSettings()" class="btn" style="flex: 1; background: #ff6b6b;">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // API Base URL
        const API_BASE = '/api/v1/currency-swap';
        const USER_ID = 1; // TODO: Get from auth

        // Return to Platform Function
        function returnToPlatform() {
            // Set currency swap toggle state to OFF
            localStorage.setItem('currencySwapActive', 'false');

            // Navigate back to main platform
            window.location.href = '/';
        }

        // Initialize toggles
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üí± Currency Swap Strategy page loaded');
            console.log('üì° API Base URL:', API_BASE);
            console.log('üë§ User ID:', USER_ID);

            // Load stats from API
            loadStats();

            // Load deposit addresses
            loadDepositAddresses();

            // Wire up save button
            const saveButton = document.getElementById('saveDepositAddresses');
            if (saveButton) {
                saveButton.addEventListener('click', saveDepositAddresses);
            }

            // Auto-trading toggle
            const autoTradingToggle = document.getElementById('autoTradingToggle');
            if (autoTradingToggle) {
                autoTradingToggle.addEventListener('click', function() {
                    this.classList.toggle('active');
                    toggleAutoTrading();
                });
            }

            // Currency pair toggles
            const currencyToggles = [
                'zarUsdToggle', 'eurUsdToggle', 'gbpUsdToggle',
                'zarEurToggle', 'ngnUsdToggle', 'includeBankingFees'
            ];

            currencyToggles.forEach(toggleId => {
                const toggle = document.getElementById(toggleId);
                if (toggle) {
                    // Load saved state
                    if (localStorage.getItem(toggleId) === 'true') {
                        toggle.classList.add('active');
                    }

                    // Add click handler
                    toggle.addEventListener('click', function() {
                        this.classList.toggle('active');
                        localStorage.setItem(toggleId, this.classList.contains('active'));
                    });
                }
            });

            // Load saved form values
            const primaryCurrency = localStorage.getItem('primaryCurrency');
            if (primaryCurrency) document.getElementById('primaryCurrency').value = primaryCurrency;

            const minSpread = localStorage.getItem('minSpread');
            if (minSpread) document.getElementById('minSpread').value = minSpread;

            const maxFiatTrade = localStorage.getItem('maxFiatTrade');
            if (maxFiatTrade) document.getElementById('maxFiatTrade').value = maxFiatTrade;
        });

        // Save settings when changed
        document.getElementById('primaryCurrency').addEventListener('change', function() {
            localStorage.setItem('primaryCurrency', this.value);
        });

        document.getElementById('minSpread').addEventListener('change', function() {
            localStorage.setItem('minSpread', this.value);
        });

        document.getElementById('maxFiatTrade').addEventListener('change', function() {
            localStorage.setItem('maxFiatTrade', this.value);
        });

        // Risk Settings Modal Functions
        function openRiskSettings() {
            document.getElementById('riskSettingsModal').style.display = 'flex';
            loadRiskSettings();
        }

        function closeRiskSettings() {
            document.getElementById('riskSettingsModal').style.display = 'none';
        }

        async function loadRiskSettings() {
            try {
                const response = await fetch(`${API_BASE}/settings?userId=${USER_ID}`);
                const data = await response.json();

                if (data.success) {
                    const settings = data.data;
                    document.getElementById('thresholdPercent').value = settings.threshold_percent || 0.5;
                    document.getElementById('maxTradeAmountUSDT').value = settings.max_trade_amount_usdt || 5000;
                    document.getElementById('maxDailySwaps').value = settings.max_daily_swaps || 10;
                    document.getElementById('preferredBridge').value = settings.preferred_bridge || 'AUTO';

                    const categories = typeof settings.enabled_categories === 'string'
                        ? JSON.parse(settings.enabled_categories)
                        : settings.enabled_categories;
                    document.getElementById('enableZAR').checked = categories?.ZAR !== false;
                    document.getElementById('enableInternational').checked = categories?.INTERNATIONAL === true;
                }
            } catch (error) {
                console.error('Failed to load settings:', error);
            }
        }

        async function saveRiskSettings() {
            try {
                const settings = {
                    userId: USER_ID,
                    thresholdPercent: parseFloat(document.getElementById('thresholdPercent').value),
                    maxTradeAmountUSDT: parseFloat(document.getElementById('maxTradeAmountUSDT').value),
                    maxDailySwaps: parseInt(document.getElementById('maxDailySwaps').value),
                    preferredBridge: document.getElementById('preferredBridge').value,
                    enabledCategories: {
                        ZAR: document.getElementById('enableZAR').checked,
                        INTERNATIONAL: document.getElementById('enableInternational').checked
                    }
                };

                const response = await fetch(`${API_BASE}/settings`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });

                const data = await response.json();
                if (data.success) {
                    alert('‚úÖ Settings saved successfully!');
                    closeRiskSettings();
                } else {
                    alert('‚ùå Failed to save settings: ' + data.error);
                }
            } catch (error) {
                console.error('Failed to save settings:', error);
                alert('‚ùå Error saving settings');
            }
        }

        // Auto-Trading Toggle
        async function toggleAutoTrading() {
            const toggle = document.getElementById('autoTradingToggle');
            const enabled = toggle.classList.contains('active');

            try {
                const response = await fetch(`${API_BASE}/settings/toggle-auto`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: USER_ID, enabled })
                });

                const data = await response.json();
                if (data.success) {
                    console.log(`Auto-trading ${enabled ? 'enabled' : 'disabled'}`);
                }
            } catch (error) {
                console.error('Failed to toggle auto-trading:', error);
            }
        }

        // Scan for opportunities
        async function scanForexOpportunities() {
            const category = 'ZAR'; // TODO: Make selectable
            try {
                const response = await fetch(`${API_BASE}/opportunities/${category}?userId=${USER_ID}`);
                const data = await response.json();

                if (data.success) {
                    console.log(`Found ${data.data.count} opportunities:`, data.data.opportunities);
                    alert(`Found ${data.data.count} currency swap opportunities!\n\nCheck console for details.`);

                    // Update stats
                    document.getElementById('activePairs').textContent = data.data.opportunities.length;
                } else {
                    alert('Failed to scan opportunities: ' + data.error);
                }
            } catch (error) {
                console.error('Scan failed:', error);
                alert('Error scanning opportunities');
            }
        }

        // Calculate route
        async function calculateSwapProfit() {
            const from = document.getElementById('fromCurrency').value;
            const amount = parseFloat(document.getElementById('swapAmount').value) || 10000;

            try {
                const response = await fetch(`${API_BASE}/calculate-route`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ from, to: 'USDT', amount })
                });

                const data = await response.json();
                if (data.success) {
                    console.log('Best route:', data.data.bestRoute);
                    alert(`Best route found!\nRate: ${data.data.bestRoute.effectiveRate.toFixed(4)}\nFees: $${data.data.bestRoute.fees.total.toFixed(2)}`);
                }
            } catch (error) {
                console.error('Calculate failed:', error);
            }
        }

        // View swap history
        async function viewSwapHistory() {
            try {
                const response = await fetch(`${API_BASE}/history?userId=${USER_ID}&limit=20`);
                const data = await response.json();

                if (data.success) {
                    console.log('Swap history:', data.data);
                    alert(`Total swaps: ${data.data.count}\nCompleted: ${data.data.stats.completed_swaps}\nTotal profit: ${data.data.stats.total_profit}%`);

                    document.getElementById('swapsToday').textContent = data.data.swaps.length;
                }
            } catch (error) {
                console.error('History failed:', error);
            }
        }

        // Setup alerts (placeholder)
        function setupAlerts() {
            const minSpread = document.getElementById('minSpread').value;
            alert(`Setting up alerts for spreads above ${minSpread}%...\n\n(Coming soon)`);
        }

        // Load stats on page load
        async function loadStats() {
            console.log('üîÑ Loading Currency Swap stats...');
            try {
                const response = await fetch(`${API_BASE}/stats?userId=${USER_ID}`);
                const data = await response.json();

                console.log('‚úÖ Stats loaded:', data);

                if (data.success) {
                    document.getElementById('activePairs').textContent = data.data.totalSwaps || 0;
                    document.getElementById('swapsToday').textContent = data.data.dailySwapsToday || 0;
                    document.getElementById('totalForexProfit').textContent = `${data.data.totalProfit?.toFixed(2) || 0}%`;
                    document.getElementById('avgSpread').textContent = `${data.data.avgProfit?.toFixed(2) || 0}%`;

                    // Set auto-trading toggle state
                    if (data.data.autoTradingEnabled) {
                        document.getElementById('autoTradingToggle').classList.add('active');
                    }

                    console.log('üìä Stats updated on page:', {
                        totalSwaps: data.data.totalSwaps,
                        dailySwaps: data.data.dailySwapsToday,
                        autoTrading: data.data.autoTradingEnabled
                    });
                }
            } catch (error) {
                console.error('‚ùå Failed to load stats:', error);
            }
        }

        // Load deposit addresses for connected exchanges
        async function loadDepositAddresses() {
            console.log('üì¨ Loading deposit addresses...');
            try {
                const response = await fetch(`${API_BASE}/connected-exchanges?userId=${USER_ID}`);
                const data = await response.json();

                console.log('‚úÖ Connected exchanges loaded:', data);

                if (data.success && data.data.length > 0) {
                    const depositListDiv = document.getElementById('depositAddressList');
                    depositListDiv.innerHTML = '';

                    for (const exchange of data.data) {
                        const exchangeDiv = document.createElement('div');
                        exchangeDiv.style.cssText = 'padding: 15px; background: rgba(97, 218, 251, 0.1); border-radius: 8px; border: 1px solid rgba(97, 218, 251, 0.3);';

                        // Get existing addresses if any
                        let depositAddresses = {};
                        try {
                            const credResponse = await fetch(`${API_BASE}/credentials/${exchange.exchange}?userId=${USER_ID}`);
                            const credData = await credResponse.json();
                            depositAddresses = credData.success && credData.data ? credData.data.depositAddresses : {};
                        } catch (error) {
                            console.warn(`Could not load deposit addresses for ${exchange.exchange}:`, error);
                            depositAddresses = {};
                        }

                        exchangeDiv.innerHTML = `
                            <h5 style="color: #61dafb; margin-bottom: 10px;">
                                ${exchange.exchange.toUpperCase()}
                                ${exchange.isConnected ? '<span style="color: #00ff88;">‚úì</span>' : '<span style="color: #ff6b6b;">‚úó</span>'}
                            </h5>
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                <!-- XRP Address -->
                                <div>
                                    <label style="color: #b8c6db; font-size: 0.85rem; display: block; margin-bottom: 5px;">
                                        XRP Deposit Address
                                    </label>
                                    <input
                                        type="text"
                                        id="${exchange.exchange}-xrp-address"
                                        data-exchange="${exchange.exchange}"
                                        data-field="XRP"
                                        value="${depositAddresses.XRP || ''}"
                                        placeholder="rXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"
                                        class="deposit-address-input"
                                        style="width: 100%; padding: 8px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; color: #fff; font-family: monospace; font-size: 0.85rem;"
                                    />
                                </div>

                                <!-- XRP Destination Tag -->
                                <div>
                                    <label style="color: #b8c6db; font-size: 0.85rem; display: block; margin-bottom: 5px;">
                                        XRP Destination Tag (if required)
                                    </label>
                                    <input
                                        type="text"
                                        id="${exchange.exchange}-xrp-tag"
                                        data-exchange="${exchange.exchange}"
                                        data-field="XRP_TAG"
                                        value="${depositAddresses.XRP_TAG || ''}"
                                        placeholder="12345678"
                                        class="deposit-address-input"
                                        style="width: 100%; padding: 8px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; color: #fff; font-family: monospace; font-size: 0.85rem;"
                                    />
                                </div>

                                <!-- USDT Address -->
                                <div>
                                    <label style="color: #b8c6db; font-size: 0.85rem; display: block; margin-bottom: 5px;">
                                        USDT Deposit Address (TRC20)
                                    </label>
                                    <input
                                        type="text"
                                        id="${exchange.exchange}-usdt-address"
                                        data-exchange="${exchange.exchange}"
                                        data-field="USDT"
                                        value="${depositAddresses.USDT || ''}"
                                        placeholder="TXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"
                                        class="deposit-address-input"
                                        style="width: 100%; padding: 8px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; color: #fff; font-family: monospace; font-size: 0.85rem;"
                                    />
                                </div>
                            </div>
                        `;

                        depositListDiv.appendChild(exchangeDiv);
                    }

                    // Add auto-save on input change (debounced)
                    let autoSaveTimeout;
                    document.querySelectorAll('.deposit-address-input').forEach(input => {
                        input.addEventListener('input', () => {
                            clearTimeout(autoSaveTimeout);
                            autoSaveTimeout = setTimeout(() => {
                                autoSaveDepositAddress(input.dataset.exchange, input.dataset.field, input.value);
                            }, 1000); // Save 1 second after user stops typing
                        });
                    });

                    console.log('üì¨ Deposit address UI created for', data.data.length, 'exchanges');
                } else {
                    const depositListDiv = document.getElementById('depositAddressList');
                    depositListDiv.innerHTML = `
                        <p style="color: #ff6b6b; font-size: 0.85rem;">
                            No exchanges connected yet. Go to <a href="strategy-api-setup.html" style="color: #61dafb;">Strategy API Setup</a> to connect exchanges first.
                        </p>
                    `;
                }

            } catch (error) {
                console.error('‚ùå Failed to load deposit addresses:', error);
            }
        }

        // Auto-save single deposit address field (debounced)
        async function autoSaveDepositAddress(exchange, field, value) {
            try {
                console.log(`üíæ Auto-saving ${field} for ${exchange}...`);

                // Get current values for this exchange
                const xrpAddress = document.getElementById(`${exchange}-xrp-address`)?.value.trim() || '';
                const xrpTag = document.getElementById(`${exchange}-xrp-tag`)?.value.trim() || '';
                const usdtAddress = document.getElementById(`${exchange}-usdt-address`)?.value.trim() || '';

                const depositAddresses = {
                    XRP: xrpAddress,
                    XRP_TAG: xrpTag,
                    USDT: usdtAddress
                };

                const response = await fetch(`${API_BASE}/credentials/${exchange}/deposit-addresses`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        userId: USER_ID,
                        depositAddresses
                    })
                });

                const data = await response.json();

                if (data.success) {
                    console.log(`‚úÖ Auto-saved ${field} for ${exchange}`);
                } else {
                    console.error(`‚ùå Failed to auto-save for ${exchange}:`, data.error);
                }

            } catch (error) {
                console.error(`‚ùå Error auto-saving for ${exchange}:`, error);
            }
        }

        // Save all deposit addresses
        async function saveDepositAddresses() {
            console.log('üíæ Saving deposit addresses...');

            try {
                const response = await fetch(`${API_BASE}/connected-exchanges?userId=${USER_ID}`);
                const data = await response.json();

                if (!data.success || data.data.length === 0) {
                    alert('No connected exchanges found');
                    return;
                }

                let savedCount = 0;
                let errorCount = 0;

                for (const exchange of data.data) {
                    const xrpAddress = document.getElementById(`${exchange.exchange}-xrp-address`)?.value.trim() || '';
                    const xrpTag = document.getElementById(`${exchange.exchange}-xrp-tag`)?.value.trim() || '';
                    const usdtAddress = document.getElementById(`${exchange.exchange}-usdt-address`)?.value.trim() || '';

                    const depositAddresses = {
                        XRP: xrpAddress,
                        XRP_TAG: xrpTag,
                        USDT: usdtAddress
                    };

                    try {
                        const saveResponse = await fetch(`${API_BASE}/credentials/${exchange.exchange}/deposit-addresses`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                userId: USER_ID,
                                depositAddresses
                            })
                        });

                        const saveData = await saveResponse.json();

                        if (saveData.success) {
                            savedCount++;
                            console.log(`‚úÖ Saved addresses for ${exchange.exchange}`);
                        } else {
                            errorCount++;
                            console.error(`‚ùå Failed to save addresses for ${exchange.exchange}:`, saveData.error);
                        }

                    } catch (error) {
                        errorCount++;
                        console.error(`‚ùå Error saving addresses for ${exchange.exchange}:`, error);
                    }
                }

                if (errorCount === 0) {
                    alert(`‚úÖ Successfully saved deposit addresses for ${savedCount} exchange(s)!`);
                } else {
                    alert(`‚ö†Ô∏è Saved ${savedCount} exchange(s), but ${errorCount} failed. Check console for details.`);
                }

            } catch (error) {
                console.error('‚ùå Failed to save deposit addresses:', error);
                alert('Failed to save deposit addresses. Check console for details.');
            }
        }

        function calculateForexArbitrage() {
            const amount = parseFloat(document.getElementById('swapAmount').value) || 0;
            const rateA = parseFloat(document.getElementById('rateA').value) || 0;
            const rateB = parseFloat(document.getElementById('rateB').value) || 0;
            const fromCurrency = document.getElementById('fromCurrency').value;

            if (!amount || !rateA || !rateB) {
                alert('Please fill in all fields');
                return;
            }

            // Calculate arbitrage opportunity
            const usdAmountA = amount / rateA;
            const usdAmountB = amount / rateB;
            const difference = Math.abs(usdAmountA - usdAmountB);
            const percentDiff = (difference / Math.min(usdAmountA, usdAmountB)) * 100;

            // Determine which exchange is better
            const betterExchange = rateA > rateB ? 'Exchange B' : 'Exchange A';
            const worseExchange = rateA > rateB ? 'Exchange A' : 'Exchange B';
            const profit = rateA > rateB ?
                (amount / rateB - amount / rateA) :
                (amount / rateA - amount / rateB);

            const resultDiv = document.getElementById('forexResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `
                <h5 style="color: #00ff88; margin-bottom: 10px;">üìä Forex Arbitrage Analysis</h5>
                <div style="display: grid; grid-template-columns: 1fr auto; gap: 10px; font-size: 0.9rem;">
                    <span style="color: #b8c6db;">Amount:</span>
                    <span style="color: #fff;">${amount.toFixed(2)} ${fromCurrency}</span>

                    <span style="color: #b8c6db;">Exchange A Rate (${fromCurrency}/USD):</span>
                    <span style="color: #fff;">${rateA.toFixed(4)}</span>

                    <span style="color: #b8c6db;">Exchange B Rate (${fromCurrency}/USD):</span>
                    <span style="color: #fff;">${rateB.toFixed(4)}</span>

                    <span style="color: #b8c6db;">Rate Difference:</span>
                    <span style="color: #ffb347;">${percentDiff.toFixed(2)}%</span>

                    <span style="color: #b8c6db; font-weight: bold;">Strategy:</span>
                    <span style="color: #00d4ff; font-weight: bold;">
                        Buy on ${betterExchange}, Sell on ${worseExchange}
                    </span>

                    <span style="color: #b8c6db; font-weight: bold;">Potential Profit:</span>
                    <span style="color: ${profit > 0 ? '#00ff88' : '#ff6b6b'}; font-weight: bold;">
                        ${profit > 0 ? '+' : ''}$${Math.abs(profit).toFixed(2)} USD
                    </span>
                </div>
                ${percentDiff < 1 ? '<p style="color: #ff6b6b; margin-top: 10px; font-size: 0.85rem;">‚ö†Ô∏è Low spread - may not cover fees!</p>' : ''}
                ${percentDiff > 3 ? '<p style="color: #00ff88; margin-top: 10px; font-size: 0.85rem;">‚úÖ Good opportunity - significant spread detected!</p>' : ''}
                <p style="color: #888; margin-top: 10px; font-size: 0.8rem;">
                    * Remember to account for banking fees, withdrawal limits, and processing times
                </p>
            `;
        }
    </script>
</body>
</html>