<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Currency Swap Arbitrage v2 - ARB4ME</title>
    <style>
        body {
            background: linear-gradient(135deg, #0c0c1e 0%, #161632 100%);
            color: #b8c6db;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .card {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
        }

        .card h3 {
            margin: 0 0 15px 0;
            color: #00d4ff;
        }

        .card h4 {
            margin: 0 0 10px 0;
            color: #ffb347;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .stat-box {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #b8c6db;
        }

        .btn {
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
            font-weight: 600;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-danger {
            background: linear-gradient(45deg, #ff6b6b 0%, #ee5a24 100%);
        }

        .btn-success {
            background: linear-gradient(45deg, #00ff88 0%, #00cc6a 100%);
        }

        .toggle-switch {
            width: 50px;
            height: 25px;
            background: #ff6b6b;
            border-radius: 25px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
        }

        .toggle-switch.active {
            background: #00ff88;
        }

        .toggle-knob {
            width: 21px;
            height: 21px;
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 2px;
            left: 2px;
            transition: all 0.3s;
        }

        .toggle-switch.active .toggle-knob {
            left: 27px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #b8c6db;
            font-size: 0.9rem;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            color: #fff;
            font-size: 0.9rem;
        }

        .form-group select option {
            background: #1a1a2e;
            color: #fff;
            padding: 10px;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.2s;
        }

        .checkbox-group label:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
        }

        .path-card {
            background: rgba(0, 212, 255, 0.05);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .path-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .path-title {
            font-size: 1.1rem;
            color: #00d4ff;
            font-weight: 600;
        }

        .path-legs {
            padding: 10px 0;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin: 10px 0;
        }

        .path-leg {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            font-size: 0.9rem;
        }

        .leg-number {
            background: #667eea;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-content {
            background: #1a1a2e;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 100%;
            border: 2px solid #667eea;
            max-height: 90vh;
            overflow-y: auto;
        }

        .alert {
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }

        .alert-info {
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid #00d4ff;
            color: #00d4ff;
        }

        .alert-warning {
            background: rgba(255, 179, 71, 0.1);
            border: 1px solid #ffb347;
            color: #ffb347;
        }

        .alert-success {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid #00ff88;
            color: #00ff88;
        }

        .declaration-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: rgba(0, 255, 136, 0.05);
            border: 1px solid rgba(0, 255, 136, 0.3);
            border-radius: 6px;
            margin-bottom: 10px;
        }

        .declaration-info {
            flex: 1;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            background: rgba(102, 126, 234, 0.3);
            border-radius: 4px;
            font-size: 0.8rem;
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div>
                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 5px;">
                    <h1 style="color: #00d4ff; margin: 0;">üí± Currency Swap Arbitrage</h1>
                    <button onclick="openCurrencySwapAboutModal()" style="background: rgba(0,212,255,0.2); color: #00d4ff; border: 1px solid #00d4ff; padding: 6px 16px; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 600; transition: all 0.3s;" onmouseover="this.style.background='rgba(0,212,255,0.3)'" onmouseout="this.style.background='rgba(0,212,255,0.2)'">
                        ‚ÑπÔ∏è About
                    </button>
                </div>
                <p style="margin: 0; color: #b8c6db;">Automated Multi-Exchange Currency Arbitrage</p>
            </div>
            <div style="display: flex; align-items: center; gap: 15px;">
                <span style="color: #b8c6db;">Auto-Trading:</span>
                <div class="toggle-switch" id="autoTradingToggle">
                    <div class="toggle-knob"></div>
                </div>
                <button onclick="window.location.href='/'" class="btn btn-danger">‚Üê Return to Dashboard</button>
            </div>
        </div>

        <!-- Stats Overview -->
        <div class="grid-3" style="margin-bottom: 30px;">
            <div class="stat-box">
                <div class="stat-value" style="color: #00ff88;" id="totalPaths">0</div>
                <div class="stat-label">Available Paths</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" style="color: #ffb347;" id="totalExchanges">0</div>
                <div class="stat-label">Connected Exchanges</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" style="color: #00d4ff;" id="totalAssets">0</div>
                <div class="stat-label">Funded Assets</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" style="color: #ff6b6b;" id="swapsToday">0</div>
                <div class="stat-label">Swaps Today</div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid-2">
            <!-- Left Column -->
            <div>
                <!-- Currency Swap Setup (NEW SIMPLIFIED!) -->
                <div class="card">
                    <h3>‚öôÔ∏è Currency Swap Setup</h3>
                    <div class="alert alert-info">
                        Select exchanges and currencies to scan for arbitrage opportunities. Auto-saves your selections.
                    </div>

                    <div class="form-group">
                        <label>üìä Select Exchanges to Trade</label>
                        <div class="checkbox-group" id="exchangeCheckboxes" style="max-height: 300px; overflow-y: auto; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 6px;">
                            <label><input type="checkbox" value="VALR" onchange="saveSetup()"> VALR</label>
                            <label><input type="checkbox" value="Luno" onchange="saveSetup()"> Luno</label>
                            <label><input type="checkbox" value="Kraken" onchange="saveSetup()"> Kraken</label>
                            <label><input type="checkbox" value="ChainEX" onchange="saveSetup()"> ChainEX</label>
                            <label><input type="checkbox" value="Bybit" onchange="saveSetup()"> Bybit</label>
                            <label><input type="checkbox" value="Binance" onchange="saveSetup()"> Binance</label>
                            <label><input type="checkbox" value="OKX" onchange="saveSetup()"> OKX</label>
                            <label><input type="checkbox" value="Kucoin" onchange="saveSetup()"> Kucoin</label>
                            <label><input type="checkbox" value="HTX" onchange="saveSetup()"> HTX</label>
                            <label><input type="checkbox" value="Gate.io" onchange="saveSetup()"> Gate.io</label>
                            <label><input type="checkbox" value="Crypto.com" onchange="saveSetup()"> Crypto.com</label>
                            <label><input type="checkbox" value="MEXC" onchange="saveSetup()"> MEXC</label>
                            <label><input type="checkbox" value="XT" onchange="saveSetup()"> XT</label>
                            <label><input type="checkbox" value="AscendEX" onchange="saveSetup()"> AscendEX</label>
                            <label><input type="checkbox" value="BingX" onchange="saveSetup()"> BingX</label>
                            <label><input type="checkbox" value="Bitget" onchange="saveSetup()"> Bitget</label>
                            <label><input type="checkbox" value="BitMart" onchange="saveSetup()"> BitMart</label>
                            <label><input type="checkbox" value="Bitrue" onchange="saveSetup()"> Bitrue</label>
                            <label><input type="checkbox" value="Gemini" onchange="saveSetup()"> Gemini</label>
                            <label><input type="checkbox" value="Coincatch" onchange="saveSetup()"> Coincatch</label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>üí∞ Select Currencies to Scan</label>
                        <div class="checkbox-group" id="currencyCheckboxes">
                            <label><input type="checkbox" value="USDT" onchange="saveSetup()"> üíµ USDT</label>
                            <label><input type="checkbox" value="USDC" onchange="saveSetup()"> üíµ USDC</label>
                            <label><input type="checkbox" value="ZAR" onchange="saveSetup()"> üáøüá¶ ZAR</label>
                            <label><input type="checkbox" value="XRP" onchange="saveSetup()"> ‚ö° XRP</label>
                            <label><input type="checkbox" value="USD" onchange="saveSetup()"> üá∫üá∏ USD</label>
                            <label><input type="checkbox" value="RLUSD" onchange="saveSetup()"> üíé RLUSD</label>
                            <label><input type="checkbox" value="AUD" onchange="saveSetup()"> üá¶üá∫ AUD</label>
                            <label><input type="checkbox" value="EUR" onchange="saveSetup()"> üá™üá∫ EUR</label>
                            <label><input type="checkbox" value="GBP" onchange="saveSetup()"> üá¨üáß GBP</label>
                            <label><input type="checkbox" value="CAD" onchange="saveSetup()"> üá®üá¶ CAD</label>
                            <label><input type="checkbox" value="AED" onchange="saveSetup()"> üá¶üá™ AED</label>
                        </div>
                    </div>

                    <div class="form-group" id="xrpDepositSection" style="display: none;">
                        <label>‚ö° XRP Deposit Addresses</label>
                        <div style="background: rgba(255,179,71,0.1); border: 1px solid #ffb347; border-radius: 8px; padding: 12px; margin-bottom: 10px;">
                            <div style="font-size: 0.85rem; color: #ffb347; margin-bottom: 8px;">
                                üí° Provide your XRP deposit address & tag for each exchange to enable automatic transfers
                            </div>
                        </div>
                        <div id="xrpDepositInputs" style="display: grid; gap: 15px; max-height: 400px; overflow-y: auto; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 6px;">
                            <!-- XRP inputs will be dynamically added here -->
                        </div>
                    </div>

                    <div style="text-align: center; padding: 10px; color: #00ff88; font-size: 0.9rem;">
                        <span id="saveStatus">‚úÖ Auto-saved</span>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div>
                <!-- Risk Settings (Always Visible) -->
                <div class="card">
                    <h3 style="color: #ff6b6b;">‚öôÔ∏è Risk Settings</h3>
                    <div class="alert alert-warning" style="background: rgba(255, 107, 107, 0.1); border-color: #ff6b6b;">
                        <strong>‚ö†Ô∏è Important:</strong> These settings control your trading limits and risk exposure.
                    </div>

                    <div class="form-group">
                        <label>Minimum Net Profit Threshold (%)</label>
                        <input type="number" id="thresholdPercent" min="0.1" max="10" step="0.1" value="0.5" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.3); color: white;">
                        <small style="color: #888;">Minimum profit percentage AFTER all fees to execute trade</small>
                    </div>

                    <div class="form-group">
                        <label>Max Trade Amount (USDT)</label>
                        <input type="number" id="maxTradeAmountUsdt" min="10" max="100000" step="10" value="5000" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.3); color: white;">
                        <small style="color: #888;">Maximum amount per trade (in USDT equivalent)</small>
                    </div>

                    <div class="form-group">
                        <label>Daily Swap Limit</label>
                        <input type="number" id="dailySwapLimit" min="1" max="1000" step="1" value="50" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.3); color: white;">
                        <small style="color: #888;">Maximum number of trades per day</small>
                    </div>

                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="enableStopLoss" style="width: 20px; height: 20px;">
                            <span>Enable Stop-Loss Protection</span>
                        </label>
                        <small style="color: #888;">Stop trading if daily loss exceeds threshold</small>
                    </div>

                    <div style="text-align: center; margin-top: 15px;">
                        <button onclick="saveRiskSettings()" class="btn btn-success" style="width: 100%;">üíæ Save Risk Settings</button>
                        <div id="riskSaveStatus" style="margin-top: 10px; color: #888; font-size: 0.9rem;">Settings loaded...</div>
                    </div>
                </div>

                <!-- Path Statistics (NEW!) -->
                <div class="card">
                    <h3>üìä Path Statistics</h3>
                    <div id="pathStats">
                        <p style="color: #888;">Declare assets to see statistics...</p>
                    </div>
                </div>

                <!-- Auto-Generated Paths (NEW!) -->
                <div class="card">
                    <h3>üîÑ Auto-Generated Swap Paths</h3>
                    <div class="alert alert-warning">
                        These paths are automatically generated based on your selections. No manual setup needed!
                    </div>

                    <!-- Filters -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                        <select id="filterSourceAsset" onchange="saveFilters()">
                            <option value="">All Source Assets</option>
                            <option value="USDT">USDT</option>
                            <option value="USDC">USDC</option>
                            <option value="ZAR">ZAR</option>
                            <option value="XRP">XRP</option>
                            <option value="USD">USD</option>
                            <option value="RLUSD">RLUSD</option>
                            <option value="AUD">AUD</option>
                            <option value="EUR">EUR</option>
                            <option value="GBP">GBP</option>
                            <option value="CAD">CAD</option>
                            <option value="AED">AED</option>
                        </select>
                        <select id="filterDestAsset" onchange="saveFilters()">
                            <option value="">All Dest Assets</option>
                            <option value="USDT">USDT</option>
                            <option value="USDC">USDC</option>
                            <option value="ZAR">ZAR</option>
                            <option value="XRP">XRP</option>
                            <option value="USD">USD</option>
                            <option value="RLUSD">RLUSD</option>
                            <option value="AUD">AUD</option>
                            <option value="EUR">EUR</option>
                            <option value="GBP">GBP</option>
                            <option value="CAD">CAD</option>
                            <option value="AED">AED</option>
                        </select>
                    </div>

                    <div id="pathsList">
                        <p style="color: #888;">Loading paths...</p>
                    </div>
                </div>
            </div>

            <!-- Trading Activity Card (NEW!) -->
            <div class="card" style="margin-top: 20px;">
                <h3>üìä Trading Activity</h3>

                <!-- Tab Headers -->
                <div style="display: flex; gap: 5px; margin-bottom: 15px; background: rgba(0,0,0,0.3); padding: 5px; border-radius: 8px;">
                    <button class="activity-tab-btn active" data-tab="swaps" style="flex: 1; padding: 12px 10px; background: rgba(0,212,255,0.15); border: 1px solid #00d4ff; border-radius: 6px; color: #00d4ff; cursor: pointer; font-weight: bold; font-size: 0.95rem;">
                        üìú Recent Swaps
                    </button>
                    <button class="activity-tab-btn" data-tab="balances" style="flex: 1; padding: 12px 10px; background: rgba(255,255,255,0.03); border: 1px solid transparent; border-radius: 6px; color: #888; cursor: pointer; font-weight: bold; font-size: 0.95rem;">
                        üí∞ Balance Tracker
                    </button>
                </div>

                <!-- Tab Content -->
                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px;">
                    <!-- Tab 1: Recent Swaps -->
                    <div id="activityTabSwaps" class="activity-tab-content" style="display: block;">
                        <div id="recentSwaps" style="max-height: 300px; overflow-y: auto;">
                            <div style="text-align: center; color: #888; padding: 20px;">
                                No swaps yet. Enable auto-trading to start.
                            </div>
                        </div>
                    </div>

                    <!-- Tab 2: Balance Tracker -->
                    <div id="activityTabBalances" class="activity-tab-content" style="display: none;">
                        <div id="balanceTrackerContent" style="max-height: 400px; overflow-y: auto;">
                            <div style="text-align: center; color: #888; padding: 20px;">
                                Select exchanges and currencies to track balances.
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px; justify-content: space-between; align-items: center; padding-top: 10px; margin-top: 10px; border-top: 1px solid rgba(255,255,255,0.1);">
                            <div style="color: #888; font-size: 0.85rem;">
                                Last Updated: <span id="balanceLastUpdate">Never</span>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button onclick="refreshBalances()" style="padding: 6px 12px; background: rgba(0,255,136,0.1); color: #00ff88; border: 1px solid #00ff88; border-radius: 5px; cursor: pointer; font-size: 0.85rem;">
                                    üîÑ Refresh from Exchanges
                                </button>
                                <button onclick="resetAllBalances()" style="padding: 6px 12px; background: rgba(255,255,255,0.1); color: #00d4ff; border: 1px solid #00d4ff; border-radius: 5px; cursor: pointer; font-size: 0.85rem;">
                                    üîÑ Reset Starting Balances
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Test Scan Mode Card (Full Width Below) -->
        <div class="card" style="margin-top: 20px; border: 2px solid #ffb347;">
                <h3 style="color: #ffb347;">üî¨ Test Scan Mode (Research Tool)</h3>
                <p style="color: #b8c6db; font-size: 0.9rem; margin-bottom: 20px;">
                    Scan for currency swap opportunities over time to analyze patterns, best pairs, and profitability.
                    <strong style="color: #00ff88;">No credentials required</strong> - uses public market data only.
                </p>

                <!-- Scan Status -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div class="stat-box" style="background: rgba(255,179,71,0.1); border: 1px solid #ffb347;">
                        <div style="font-size: 0.9rem; color: #b8c6db; margin-bottom: 5px;">Status</div>
                        <div id="testScanStatusText" style="font-size: 1.3rem; font-weight: bold; color: #888;">‚ö™ READY TO SCAN</div>
                    </div>
                    <div class="stat-box" style="background: rgba(0,212,255,0.1); border: 1px solid #00d4ff;">
                        <div style="font-size: 0.9rem; color: #b8c6db; margin-bottom: 5px;">Scan Cycles</div>
                        <div id="testScanCycles" style="font-size: 1.3rem; font-weight: bold; color: #00d4ff;">0</div>
                    </div>
                    <div class="stat-box" style="background: rgba(0,255,136,0.1); border: 1px solid #00ff88;">
                        <div style="font-size: 0.9rem; color: #b8c6db; margin-bottom: 5px;">Running Time</div>
                        <div id="testScanRunTime" style="font-size: 1.3rem; font-weight: bold; color: #00ff88;">0:00</div>
                    </div>
                    <div class="stat-box" style="background: rgba(255,107,107,0.1); border: 1px solid #ff6b6b;">
                        <div style="font-size: 0.9rem; color: #b8c6db; margin-bottom: 5px;">Next Scan In</div>
                        <div id="testScanCountdown" style="font-size: 1.3rem; font-weight: bold; color: #ff6b6b;">--</div>
                    </div>
                </div>

                <!-- Storage Capacity -->
                <div style="background: rgba(255,179,71,0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ffb347;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span style="color: #ffb347; font-weight: bold;">üì¶ Storage Capacity</span>
                        <span id="testScanStoragePercent" style="color: #00ff88; font-weight: bold;">0%</span>
                    </div>
                    <div style="width: 100%; height: 20px; background: rgba(0,0,0,0.3); border-radius: 10px; overflow: hidden; border: 1px solid rgba(255,255,255,0.2);">
                        <div id="testScanStorageBar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #00ff88 0%, #ffb347 70%, #ff6b6b 100%); transition: width 0.3s;"></div>
                    </div>
                    <div style="color: #b8c6db; font-size: 0.85rem; margin-top: 5px;">
                        <span id="testScanRouteCount">0</span> / 5,000 routes collected
                    </div>
                </div>

                <!-- Exchange & Currency Selection for Test Scan -->
                <div style="background: rgba(0,212,255,0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #00d4ff;">
                    <div style="color: #00d4ff; font-weight: bold; margin-bottom: 15px;">üéØ Select Exchanges & Currencies to Test Scan</div>

                    <!-- Exchange Checkboxes -->
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; color: #ffb347; font-weight: bold; margin-bottom: 8px;">üìä Exchanges:</label>
                        <div id="testScanExchangeCheckboxes" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 8px; max-height: 200px; overflow-y: auto; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                            <label style="color: #b8c6db; cursor: pointer; padding: 5px;"><input type="checkbox" value="VALR" onchange="saveTestScanSelections()"> VALR</label>
                            <label style="color: #b8c6db; cursor: pointer; padding: 5px;"><input type="checkbox" value="Luno" onchange="saveTestScanSelections()"> Luno</label>
                            <label style="color: #b8c6db; cursor: pointer; padding: 5px;"><input type="checkbox" value="Kraken" onchange="saveTestScanSelections()"> Kraken</label>
                            <label style="color: #b8c6db; cursor: pointer; padding: 5px;"><input type="checkbox" value="ChainEX" onchange="saveTestScanSelections()"> ChainEX</label>
                            <label style="color: #b8c6db; cursor: pointer; padding: 5px;"><input type="checkbox" value="Bybit" onchange="saveTestScanSelections()"> Bybit</label>
                            <label style="color: #b8c6db; cursor: pointer; padding: 5px;"><input type="checkbox" value="Binance" onchange="saveTestScanSelections()"> Binance</label>
                            <label style="color: #b8c6db; cursor: pointer; padding: 5px;"><input type="checkbox" value="OKX" onchange="saveTestScanSelections()"> OKX</label>
                            <label style="color: #b8c6db; cursor: pointer; padding: 5px;"><input type="checkbox" value="Kucoin" onchange="saveTestScanSelections()"> Kucoin</label>
                            <label style="color: #b8c6db; cursor: pointer; padding: 5px;"><input type="checkbox" value="HTX" onchange="saveTestScanSelections()"> HTX</label>
                            <label style="color: #b8c6db; cursor: pointer; padding: 5px;"><input type="checkbox" value="Gate.io" onchange="saveTestScanSelections()"> Gate.io</label>
                            <label style="color: #b8c6db; cursor: pointer; padding: 5px;"><input type="checkbox" value="Crypto.com" onchange="saveTestScanSelections()"> Crypto.com</label>
                            <label style="color: #b8c6db; cursor: pointer; padding: 5px;"><input type="checkbox" value="MEXC" onchange="saveTestScanSelections()"> MEXC</label>
                            <label style="color: #b8c6db; cursor: pointer; padding: 5px;"><input type="checkbox" value="XT" onchange="saveTestScanSelections()"> XT</label>
                            <label style="color: #b8c6db; cursor: pointer; padding: 5px;"><input type="checkbox" value="AscendEX" onchange="saveTestScanSelections()"> AscendEX</label>
                            <label style="color: #b8c6db; cursor: pointer; padding: 5px;"><input type="checkbox" value="BingX" onchange="saveTestScanSelections()"> BingX</label>
                            <label style="color: #b8c6db; cursor: pointer; padding: 5px;"><input type="checkbox" value="Bitget" onchange="saveTestScanSelections()"> Bitget</label>
                            <label style="color: #b8c6db; cursor: pointer; padding: 5px;"><input type="checkbox" value="BitMart" onchange="saveTestScanSelections()"> BitMart</label>
                            <label style="color: #b8c6db; cursor: pointer; padding: 5px;"><input type="checkbox" value="Bitrue" onchange="saveTestScanSelections()"> Bitrue</label>
                            <label style="color: #b8c6db; cursor: pointer; padding: 5px;"><input type="checkbox" value="Gemini" onchange="saveTestScanSelections()"> Gemini</label>
                            <label style="color: #b8c6db; cursor: pointer; padding: 5px;"><input type="checkbox" value="Coincatch" onchange="saveTestScanSelections()"> Coincatch</label>
                        </div>
                    </div>

                    <!-- Currency Checkboxes -->
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; color: #ffb347; font-weight: bold; margin-bottom: 8px;">üí∞ Currencies:</label>
                        <div id="testScanCurrencyCheckboxes" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 8px; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                            <label style="color: #b8c6db; cursor: pointer; padding: 5px;"><input type="checkbox" value="USDT" onchange="saveTestScanSelections()"> üíµ USDT</label>
                            <label style="color: #b8c6db; cursor: pointer; padding: 5px;"><input type="checkbox" value="USDC" onchange="saveTestScanSelections()"> üíµ USDC</label>
                            <label style="color: #b8c6db; cursor: pointer; padding: 5px;"><input type="checkbox" value="ZAR" onchange="saveTestScanSelections()"> üáøüá¶ ZAR</label>
                            <label style="color: #b8c6db; cursor: pointer; padding: 5px;"><input type="checkbox" value="XRP" onchange="saveTestScanSelections()"> ‚ö° XRP</label>
                            <label style="color: #b8c6db; cursor: pointer; padding: 5px;"><input type="checkbox" value="USD" onchange="saveTestScanSelections()"> üá∫üá∏ USD</label>
                            <label style="color: #b8c6db; cursor: pointer; padding: 5px;"><input type="checkbox" value="RLUSD" onchange="saveTestScanSelections()"> üíé RLUSD</label>
                            <label style="color: #b8c6db; cursor: pointer; padding: 5px;"><input type="checkbox" value="AUD" onchange="saveTestScanSelections()"> üá¶üá∫ AUD</label>
                            <label style="color: #b8c6db; cursor: pointer; padding: 5px;"><input type="checkbox" value="EUR" onchange="saveTestScanSelections()"> üá™üá∫ EUR</label>
                            <label style="color: #b8c6db; cursor: pointer; padding: 5px;"><input type="checkbox" value="GBP" onchange="saveTestScanSelections()"> üá¨üáß GBP</label>
                            <label style="color: #b8c6db; cursor: pointer; padding: 5px;"><input type="checkbox" value="CAD" onchange="saveTestScanSelections()"> üá®üá¶ CAD</label>
                            <label style="color: #b8c6db; cursor: pointer; padding: 5px;"><input type="checkbox" value="AED" onchange="saveTestScanSelections()"> üá¶üá™ AED</label>
                        </div>
                    </div>

                    <!-- Possible Paths Display -->
                    <div style="padding: 10px; background: rgba(0,255,136,0.1); border-radius: 6px; border: 1px solid rgba(0,255,136,0.3);">
                        <strong style="color: #ffb347;">Possible Paths:</strong>
                        <span id="testScanPathCount" style="color: #00ff88; font-family: monospace; font-weight: bold; font-size: 1.1rem; margin-left: 10px;">0</span>
                    </div>

                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1); color: #b8c6db; font-size: 0.85rem;">
                        üí° Test scan selections are independent from your live trading settings. Select at least 2 exchanges and 2 currencies to enable scanning.
                    </div>
                </div>

                <!-- Scan Settings -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <div>
                        <label style="display: block; color: #b8c6db; font-size: 0.9rem; margin-bottom: 5px;">Min Profit Threshold (%)</label>
                        <input type="number" id="testScanMinProfit" value="0.5" step="0.1" min="0" max="10" style="width: 100%; padding: 10px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white;">
                    </div>
                    <div>
                        <label style="display: block; color: #b8c6db; font-size: 0.9rem; margin-bottom: 5px;">Scan Interval (seconds)</label>
                        <select id="testScanInterval" style="width: 100%; padding: 10px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white;">
                            <option value="30">30 seconds</option>
                            <option value="60" selected>60 seconds (Recommended)</option>
                            <option value="120">120 seconds</option>
                            <option value="300">300 seconds (5 minutes)</option>
                        </select>
                    </div>
                </div>

                <!-- Control Buttons -->
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                    <button id="startTestScanBtn" onclick="startCurrencySwapTestScan()" class="btn btn-success" style="background: linear-gradient(45deg, #00ff88 0%, #00cc6a 100%);">
                        ‚ñ∂Ô∏è Start Scanning
                    </button>
                    <button id="stopTestScanBtn" onclick="stopCurrencySwapTestScan()" class="btn btn-danger" disabled style="background: rgba(255,107,107,0.2); cursor: not-allowed;">
                        ‚è∏Ô∏è Stop Scanning
                    </button>
                    <button onclick="resetCurrencySwapTestScan()" class="btn" style="background: rgba(255,179,71,0.2); border: 1px solid #ffb347; color: #ffb347;">
                        üîÑ Reset Data
                    </button>
                </div>

                <!-- Current Scan Info -->
                <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="color: #b8c6db; font-size: 0.85rem; margin-bottom: 5px;">Current Scan:</div>
                    <div id="testScanCurrentInfo" style="color: #00d4ff; font-family: monospace; font-size: 0.9rem;">Waiting to start...</div>
                </div>

                <!-- Export CSV Button -->
                <div style="margin-bottom: 20px;">
                    <button onclick="exportCurrencySwapTestScanToCSV()" class="btn" style="width: 100%; background: rgba(0,212,255,0.15); border: 1px solid #00d4ff; color: #00d4ff;">
                        üì• Download CSV Export
                    </button>
                </div>

                <!-- Info Banner -->
                <div style="background: rgba(0,212,255,0.1); padding: 12px; border-radius: 8px; margin-bottom: 30px; border-left: 4px solid #00d4ff;">
                    <strong style="color: #00d4ff;">‚ÑπÔ∏è How it works:</strong>
                    <ul style="margin: 10px 0 0 0; padding-left: 20px; color: #b8c6db; font-size: 0.85rem;">
                        <li>Repeatedly scans for currency swap opportunities</li>
                        <li>Collects data over time (up to 5,000 routes)</li>
                        <li>Analyzes best currency pairs, most profitable times, consistency</li>
                        <li>Export to CSV for offline analysis</li>
                        <li><strong style="color: #00ff88;">No trading - research only!</strong></li>
                    </ul>
                </div>

                <!-- Live Analytics Report -->
                <div id="testScanReports">
                    <h4 style="color: #ffc107; margin-bottom: 20px; font-size: 1.2rem; text-align: center;">üìä Live Analysis Report</h4>

                    <!-- Top Routes by Profit % -->
                    <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                        <h5 style="color: #00ff88; margin-bottom: 15px;">üèÜ Top 20 Routes by Average Profit %</h5>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; color: #b8c6db; font-size: 0.85rem;">
                                <thead>
                                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                                        <th style="text-align: left; padding: 10px; color: #888;">#</th>
                                        <th style="text-align: left; padding: 10px; color: #888;">Source Exchange</th>
                                        <th style="text-align: left; padding: 10px; color: #888;">Dest Exchange</th>
                                        <th style="text-align: left; padding: 10px; color: #888;">Source Currency</th>
                                        <th style="text-align: left; padding: 10px; color: #888;">Dest Currency</th>
                                        <th style="text-align: right; padding: 10px; color: #888;">Avg Profit %</th>
                                        <th style="text-align: right; padding: 10px; color: #888;">Best Profit %</th>
                                        <th style="text-align: right; padding: 10px; color: #888;">Times Found</th>
                                        <th style="text-align: right; padding: 10px; color: #888;">Last Seen</th>
                                    </tr>
                                </thead>
                                <tbody id="testScanTopProfitBody">
                                    <tr><td colspan="9" style="text-align: center; padding: 30px; color: #888; font-style: italic;">Waiting for scan data... Click "Start Scanning" above.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Top Routes by Consistency -->
                    <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                        <h5 style="color: #00d4ff; margin-bottom: 15px;">üìà Top 20 Routes by Consistency (Most Reliable)</h5>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; color: #b8c6db; font-size: 0.85rem;">
                                <thead>
                                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                                        <th style="text-align: left; padding: 10px; color: #888;">#</th>
                                        <th style="text-align: left; padding: 10px; color: #888;">Route</th>
                                        <th style="text-align: right; padding: 10px; color: #888;">Times Found</th>
                                        <th style="text-align: right; padding: 10px; color: #888;">Avg Profit %</th>
                                        <th style="text-align: right; padding: 10px; color: #888;">Min/Max Profit</th>
                                        <th style="text-align: center; padding: 10px; color: #888;">Consistency</th>
                                    </tr>
                                </thead>
                                <tbody id="testScanTopConsistencyBody">
                                    <tr><td colspan="6" style="text-align: center; padding: 30px; color: #888; font-style: italic;">Waiting for scan data... Click "Start Scanning" above.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Best Currency Pairs & Best Exchanges Side by Side -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <!-- Best Currency Pairs -->
                        <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 20px;">
                            <h5 style="color: #667eea; margin-bottom: 15px;">üí± Best Currency Pairs</h5>
                            <div style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse; color: #b8c6db; font-size: 0.85rem;">
                                    <thead>
                                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                                            <th style="text-align: left; padding: 10px; color: #888;">Pair</th>
                                            <th style="text-align: right; padding: 10px; color: #888;">Opps</th>
                                            <th style="text-align: right; padding: 10px; color: #888;">Avg Profit</th>
                                        </tr>
                                    </thead>
                                    <tbody id="testScanBestPairsBody">
                                        <tr><td colspan="3" style="text-align: center; padding: 20px; color: #888;">Waiting for scan data...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Best Exchanges -->
                        <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 20px;">
                            <h5 style="color: #ffb347; margin-bottom: 15px;">üè¶ Best Exchange Pairs</h5>
                            <div style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse; color: #b8c6db; font-size: 0.85rem;">
                                    <thead>
                                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                                            <th style="text-align: left; padding: 10px; color: #888;">Route</th>
                                            <th style="text-align: right; padding: 10px; color: #888;">Opps</th>
                                            <th style="text-align: right; padding: 10px; color: #888;">Avg Profit</th>
                                        </tr>
                                    </thead>
                                    <tbody id="testScanBestExchangesBody">
                                        <tr><td colspan="3" style="text-align: center; padding: 20px; color: #888;">Waiting for scan data...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Data Availability Analysis (Full Width) -->
                    <div style="background: rgba(0,212,255,0.05); border: 1px solid rgba(0,212,255,0.3); border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                        <h5 style="color: #00d4ff; margin-bottom: 15px;">üîç Data Availability Analysis (Live Trading Intelligence)</h5>
                        <p style="color: #888; font-size: 0.85rem; margin-bottom: 20px;">Shows which exchange-currency combinations have price data available. Use this to configure your live trading settings.</p>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <!-- Per-Exchange Coverage -->
                            <div>
                                <h6 style="color: #667eea; margin-bottom: 10px;">üìä Per-Exchange Coverage</h6>
                                <div id="exchangeCoverageTable" style="font-size: 0.85rem; color: #b8c6db;">
                                    <div style="text-align: center; padding: 20px; color: #888;">Waiting for scan data...</div>
                                </div>
                            </div>

                            <!-- Per-Currency Coverage -->
                            <div>
                                <h6 style="color: #667eea; margin-bottom: 10px;">üìä Per-Currency Coverage</h6>
                                <div id="currencyCoverageTable" style="font-size: 0.85rem; color: #b8c6db;">
                                    <div style="text-align: center; padding: 20px; color: #888;">Waiting for scan data...</div>
                                </div>
                            </div>
                        </div>

                        <!-- Live Trading Recommendations (Full Width) -->
                        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                            <h6 style="color: #00ff88; margin-bottom: 10px;">üí° Live Trading Recommendations</h6>
                            <div id="tradingRecommendations" style="font-size: 0.85rem; color: #b8c6db;">
                                <div style="text-align: center; padding: 20px; color: #888;">Waiting for scan data...</div>
                            </div>
                        </div>
                    </div>
                </div>
        </div>
    </div>  <!-- Close main container -->

    <!-- Path Details Modal -->
    <div id="pathDetailsModal" class="modal">
        <div class="modal-content">
            <h3 style="color: #00d4ff; margin-bottom: 20px;">üîç Path Details & Execution</h3>
            <div id="pathDetailsContent"></div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button onclick="executeCurrentPath()" class="btn btn-success" style="flex: 1;">Execute Swap</button>
                <button onclick="closePathDetails()" class="btn" style="flex: 1;">Close</button>
            </div>
        </div>
    </div>

    <!-- Currency Swap Arbitrage About Modal -->
    <div id="currencySwapAboutModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; justify-content: center; align-items: center;">
        <div style="background: linear-gradient(135deg, #0c0c1e 0%, #161632 100%); padding: 30px; border-radius: 15px; max-width: 600px; width: 90%; max-height: 90vh; border: 2px solid #00d4ff; box-shadow: 0 10px 40px rgba(0,212,255,0.3); position: relative; overflow-y: auto;">
            <!-- Close Button -->
            <button onclick="closeCurrencySwapAboutModal()" style="position: absolute; top: 15px; right: 15px; background: rgba(255,68,68,0.9); border: none; color: #fff; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; font-size: 1.5rem; font-weight: bold; display: flex; align-items: center; justify-content: center; transition: all 0.3s; z-index: 1;" onmouseover="this.style.background='rgba(255,68,68,1)'; this.style.transform='scale(1.1)'" onmouseout="this.style.background='rgba(255,68,68,0.9)'; this.style.transform='scale(1)'">
                √ó
            </button>

            <!-- Header -->
            <h2 style="color: #00d4ff; margin: 0 0 20px 0; padding-right: 40px; font-size: 1.5rem;">üí± What is Currency Swap Arbitrage?</h2>

            <!-- Content -->
            <div style="color: #b8c6db; line-height: 1.6; font-size: 0.95rem; padding-right: 5px;">
                <p style="margin: 0 0 15px 0;">
                    <strong style="color: #00ff88;">Currency swap arbitrage</strong> exploits price differences between <strong>fiat currencies across different exchanges</strong>. It involves converting between currencies (like ZAR, USD, EUR) through crypto to capture profit.
                </p>

                <div style="background: rgba(0,212,255,0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #00d4ff; margin-bottom: 15px;">
                    <strong style="color: #00d4ff; display: block; margin-bottom: 8px;">Example:</strong>
                    <div style="font-family: monospace; color: #00ff88;">
                        1. Convert 10,000 ZAR ‚Üí BTC on VALR (ZAR rate)<br>
                        2. Transfer BTC to Kraken<br>
                        3. Sell BTC ‚Üí USD on Kraken (USD rate)<br>
                        4. Result: Better ZAR/USD rate than forex!<br>
                        <span style="color: #ffb347;">Profit from rate differences</span>
                    </div>
                </div>

                <p style="margin: 0 0 15px 0;">
                    <strong style="color: #ffb347;">How it works:</strong>
                </p>
                <ol style="margin: 0 0 15px 0; padding-left: 25px;">
                    <li style="margin-bottom: 8px;">System monitors <strong>fiat currency exchange rates</strong> across all exchanges</li>
                    <li style="margin-bottom: 8px;">Identifies favorable <strong>currency conversion paths</strong> through crypto</li>
                    <li style="margin-bottom: 8px;">Converts Currency A ‚Üí Crypto on Exchange 1</li>
                    <li style="margin-bottom: 8px;">Transfers crypto to Exchange 2 (if needed)</li>
                    <li style="margin-bottom: 8px;">Converts Crypto ‚Üí Currency B on Exchange 2</li>
                    <li style="margin-bottom: 8px;">Net result: <strong>Better exchange rate</strong> than traditional forex</li>
                </ol>

                <p style="margin: 0 0 15px 0;">
                    <strong style="color: #ffb347;">Common currency pairs:</strong>
                </p>
                <ul style="margin: 0 0 15px 0; padding-left: 25px;">
                    <li style="margin-bottom: 8px;"><strong style="color: #00ff88;">ZAR ‚Üî USD</strong> - South African Rand to US Dollar</li>
                    <li style="margin-bottom: 8px;"><strong style="color: #00ff88;">ZAR ‚Üî EUR</strong> - South African Rand to Euro</li>
                    <li style="margin-bottom: 8px;"><strong style="color: #00ff88;">USD ‚Üî EUR</strong> - US Dollar to Euro</li>
                    <li style="margin-bottom: 8px;"><strong style="color: #00ff88;">GBP ‚Üî USD</strong> - British Pound to US Dollar</li>
                </ul>

                <p style="margin: 0 0 15px 0;">
                    <strong style="color: #ffb347;">Best for:</strong>
                </p>
                <ul style="margin: 0 0 15px 0; padding-left: 25px;">
                    <li style="margin-bottom: 8px;">Converting between fiat currencies at better rates</li>
                    <li style="margin-bottom: 8px;">International money transfers</li>
                    <li style="margin-bottom: 8px;">Avoiding high forex bank fees</li>
                </ul>

                <div style="background: rgba(255,152,0,0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #ffb347; margin-bottom: 0;">
                    <strong style="color: #ffb347;">Key Advantage:</strong> By routing currency conversions through crypto exchanges, you can often beat traditional forex rates and save significantly on international transfers. The system automatically finds the most profitable currency swap paths!
                </div>
            </div>
        </div>
    </div>

    <!-- Execution Confirmation Modal -->
    <div id="executionConfirmationModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; justify-content: center; align-items: center;">
        <div style="background: linear-gradient(135deg, #0c0c1e 0%, #161632 100%); padding: 30px; border-radius: 15px; max-width: 600px; width: 90%; max-height: 90vh; border: 2px solid #ffb347; box-shadow: 0 10px 40px rgba(255,179,71,0.3); position: relative; overflow-y: auto;">
            <!-- Close Button -->
            <button onclick="closeExecutionConfirmation()" style="position: absolute; top: 15px; right: 15px; background: rgba(255,68,68,0.9); border: none; color: #fff; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; font-size: 1.5rem; font-weight: bold; display: flex; align-items: center; justify-content: center; transition: all 0.3s; z-index: 1;" onmouseover="this.style.background='rgba(255,68,68,1)'; this.style.transform='scale(1.1)'" onmouseout="this.style.background='rgba(255,68,68,0.9)'; this.style.transform='scale(1)'">
                √ó
            </button>

            <!-- Header -->
            <h2 style="color: #ffb347; margin: 0 0 20px 0; padding-right: 40px; font-size: 1.5rem;">‚ö†Ô∏è Confirm Live Execution</h2>

            <!-- Warning Banner -->
            <div style="background: rgba(255,68,68,0.15); padding: 15px; border-radius: 8px; border-left: 4px solid #ff4444; margin-bottom: 20px;">
                <strong style="color: #ff4444; display: block; margin-bottom: 8px;">üö® IMPORTANT - READ CAREFULLY</strong>
                <div style="color: #ffb8b8; font-size: 0.9rem; line-height: 1.5;">
                    This will execute a REAL 3-leg currency swap trade with REAL money on live exchanges. This action is <strong>IRREVERSIBLE</strong>. Please review all details carefully before proceeding.
                </div>
            </div>

            <!-- Trade Details -->
            <div id="confirmationDetails" style="color: #b8c6db; line-height: 1.6; font-size: 0.95rem;">
                <!-- Will be populated dynamically -->
            </div>

            <!-- Estimated Timeline -->
            <div style="background: rgba(0,212,255,0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #00d4ff; margin-top: 20px;">
                <strong style="color: #00d4ff; display: block; margin-bottom: 8px;">‚è±Ô∏è Estimated Timeline</strong>
                <div style="color: #b8c6db; font-size: 0.9rem; font-family: monospace; line-height: 1.8;">
                    1. <strong style="color: #00d4ff;">Buy XRP</strong> (~5-10 seconds)<br>
                    2. <strong style="color: #00d4ff;">Withdraw XRP</strong> (~10-30 seconds)<br>
                    3. <strong style="color: #ffb347;">Blockchain Transfer</strong> (~3-5 minutes)<br>
                    4. <strong style="color: #ffb347;">Wait for Deposit</strong> (~2-5 minutes)<br>
                    5. <strong style="color: #00ff88;">Sell XRP</strong> (~5-10 seconds)<br>
                    <br>
                    <strong style="color: #00ff88;">Total Estimated Time: 6-11 minutes</strong>
                </div>
            </div>

            <!-- Action Buttons -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 25px;">
                <button onclick="closeExecutionConfirmation()" style="background: rgba(255,68,68,0.2); border: 2px solid #ff4444; color: #ff4444; padding: 15px 20px; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: bold; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,68,68,0.3)'" onmouseout="this.style.background='rgba(255,68,68,0.2)'">
                    ‚ùå Cancel
                </button>
                <button onclick="confirmAndExecute()" style="background: linear-gradient(135deg, #00ff88 0%, #00d4ff 100%); border: none; color: #0c0c1e; padding: 15px 20px; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: bold; transition: all 0.3s; box-shadow: 0 4px 15px rgba(0,255,136,0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(0,255,136,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(0,255,136,0.3)'">
                    ‚úÖ Confirm & Execute
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api/v1/currency-swap';
        const USER_ID = 1; // TODO: Get from auth

        let currentPath = null;
        let pendingExecution = null;

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üí± Currency Swap v2 loaded');
            console.log('üìç API Base:', API_BASE);
            console.log('üë§ User ID:', USER_ID);

            console.log('‚è≥ Step 1/4: Loading stats...');
            await loadStats();

            console.log('‚è≥ Step 2/4: Loading setup (exchanges & currencies)...');
            await loadSetup();

            console.log('‚è≥ Step 3/4: Loading swap paths...');
            await loadPaths();

            console.log('‚è≥ Step 4/4: Loading path statistics...');
            await loadPathStats();

            console.log('‚è≥ Step 5/6: Loading XRP deposit inputs...');
            await populateXrpDepositInputs();

            console.log('‚è≥ Step 6/7: Loading risk settings...');
            await loadRiskSettings();

            console.log('‚è≥ Step 7/7: Loading test scan selections...');
            loadTestScanSelections();

            console.log('‚úÖ Currency Swap initialization complete!');

            // Auto-trading toggle
            const toggle = document.getElementById('autoTradingToggle');
            toggle.addEventListener('click', function() {
                this.classList.toggle('active');
                toggleAutoTrading();
            });

            // Auto-start worker loop if auto-trading is already enabled
            if (toggle.classList.contains('active')) {
                console.log('üöÄ Auto-trading is enabled - starting worker loop...');
                startWorkerLoop();
            }
        });

        // Load overall stats
        async function loadStats() {
            try {
                console.log('üìä Fetching stats from:', `${API_BASE}/stats?userId=${USER_ID}`);
                const response = await fetch(`${API_BASE}/stats?userId=${USER_ID}`);
                const data = await response.json();

                console.log('üìä Stats response:', data);

                if (data.success) {
                    document.getElementById('swapsToday').textContent = data.data.dailySwapsToday || 0;
                    document.getElementById('totalPaths').textContent = data.data.availablePaths || 0;
                    if (data.data.autoTradingEnabled) {
                        document.getElementById('autoTradingToggle').classList.add('active');
                        console.log('üü¢ Auto-trading is ENABLED');
                    } else {
                        console.log('üî¥ Auto-trading is DISABLED');
                    }
                    console.log('‚úÖ Stats loaded:', {
                        swapsToday: data.data.dailySwapsToday || 0,
                        totalSwaps: data.data.totalSwaps || 0,
                        availablePaths: data.data.availablePaths || 0,
                        autoTrading: data.data.autoTradingEnabled
                    });
                }
            } catch (error) {
                console.error('‚ùå Failed to load stats:', error);
            }
        }

        // Load setup (selected exchanges and currencies)
        async function loadSetup() {
            try {
                console.log('‚öôÔ∏è Fetching setup from:', `${API_BASE}/settings?userId=${USER_ID}`);
                const response = await fetch(`${API_BASE}/settings?userId=${USER_ID}`);
                const data = await response.json();

                console.log('‚öôÔ∏è Setup response:', data);

                if (data.success) {
                    const s = data.data;

                    // Load selected exchanges
                    const selectedExchanges = s.selected_exchanges || [];
                    console.log('üè¶ Selected exchanges:', selectedExchanges);
                    document.querySelectorAll('#exchangeCheckboxes input[type="checkbox"]').forEach(cb => {
                        cb.checked = selectedExchanges.includes(cb.value);
                    });

                    // Load selected currencies
                    const selectedCurrencies = s.selected_currencies || [];
                    console.log('üí∞ Selected currencies:', selectedCurrencies);
                    document.querySelectorAll('#currencyCheckboxes input[type="checkbox"]').forEach(cb => {
                        cb.checked = selectedCurrencies.includes(cb.value);
                    });

                    // Save to localStorage for Test Scan to read
                    localStorage.setItem('currencySwap_selectedExchanges', JSON.stringify(selectedExchanges));
                    localStorage.setItem('currencySwap_selectedCurrencies', JSON.stringify(selectedCurrencies));

                    // Update stats
                    document.getElementById('totalExchanges').textContent = selectedExchanges.length;
                    document.getElementById('totalAssets').textContent = selectedCurrencies.length;

                    console.log('‚úÖ Setup loaded:', {
                        exchanges: selectedExchanges.length,
                        currencies: selectedCurrencies.length
                    });

                    // Restore saved filter selections from localStorage
                    const savedSourceFilter = localStorage.getItem('currencySwap_filterSourceAsset');
                    const savedDestFilter = localStorage.getItem('currencySwap_filterDestAsset');

                    if (savedSourceFilter) {
                        document.getElementById('filterSourceAsset').value = savedSourceFilter;
                        console.log('üîç Restored source filter:', savedSourceFilter);
                    }

                    if (savedDestFilter) {
                        document.getElementById('filterDestAsset').value = savedDestFilter;
                        console.log('üîç Restored dest filter:', savedDestFilter);
                    }
                }
            } catch (error) {
                console.error('‚ùå Failed to load setup:', error);
            }
        }

        // Save setup (auto-save on checkbox change)
        async function saveSetup() {
            try {
                // Get selected exchanges
                const exchangeCheckboxes = document.querySelectorAll('#exchangeCheckboxes input[type="checkbox"]:checked');
                const selectedExchanges = Array.from(exchangeCheckboxes).map(cb => cb.value);

                // Get selected currencies
                const currencyCheckboxes = document.querySelectorAll('#currencyCheckboxes input[type="checkbox"]:checked');
                const selectedCurrencies = Array.from(currencyCheckboxes).map(cb => cb.value);

                console.log('üíæ Saving setup:', {
                    exchanges: selectedExchanges,
                    currencies: selectedCurrencies
                });

                // Update UI
                document.getElementById('totalExchanges').textContent = selectedExchanges.length;
                document.getElementById('totalAssets').textContent = selectedCurrencies.length;

                // Show saving status
                const saveStatus = document.getElementById('saveStatus');
                saveStatus.textContent = 'üíæ Saving...';
                saveStatus.style.color = '#ffb347';

                // Save to settings
                const response = await fetch(`${API_BASE}/settings`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: USER_ID,
                        selectedExchanges,
                        selectedCurrencies
                    })
                });

                const result = await response.json();
                console.log('üíæ Save response:', result);

                if (result.success) {
                    saveStatus.textContent = '‚úÖ Auto-saved';
                    saveStatus.style.color = '#00ff88';
                    console.log('‚úÖ Setup saved successfully!');

                    // Save to localStorage for Test Scan to read
                    localStorage.setItem('currencySwap_selectedExchanges', JSON.stringify(selectedExchanges));
                    localStorage.setItem('currencySwap_selectedCurrencies', JSON.stringify(selectedCurrencies));
                    console.log('üíæ Saved to localStorage for Test Scan:', {
                        exchanges: selectedExchanges,
                        currencies: selectedCurrencies
                    });

                    // Reload paths with new selections
                    console.log('üîÑ Regenerating paths with new selections...');
                    await loadPaths();
                    await loadPathStats();

                    // Update XRP deposit inputs
                    await populateXrpDepositInputs();
                } else {
                    saveStatus.textContent = '‚ùå Save failed';
                    saveStatus.style.color = '#ff6b6b';
                    console.error('‚ùå Save failed:', result.error);
                }
            } catch (error) {
                console.error('‚ùå Failed to save setup:', error);
                document.getElementById('saveStatus').textContent = '‚ùå Save failed';
                document.getElementById('saveStatus').style.color = '#ff6b6b';
            }
        }

        // Populate XRP deposit inputs for selected exchanges
        async function populateXrpDepositInputs() {
            const exchangeCheckboxes = document.querySelectorAll('#exchangeCheckboxes input[type="checkbox"]:checked');
            const selectedExchanges = Array.from(exchangeCheckboxes).map(cb => cb.value);

            const xrpSection = document.getElementById('xrpDepositSection');
            const xrpInputsDiv = document.getElementById('xrpDepositInputs');

            if (selectedExchanges.length === 0) {
                xrpSection.style.display = 'none';
                return;
            }

            xrpSection.style.display = 'block';

            // Fetch existing XRP deposit info from backend
            let existingXrpData = {};
            try {
                const response = await fetch(`${API_BASE}/credentials?userId=${USER_ID}`);
                const data = await response.json();
                if (data.success) {
                    data.data.forEach(cred => {
                        existingXrpData[cred.exchange] = {
                            address: cred.xrpDepositAddress || '',
                            tag: cred.xrpDepositTag || ''
                        };
                    });
                }
            } catch (error) {
                console.error('Failed to load XRP deposit data:', error);
            }

            // Build input fields for each selected exchange
            xrpInputsDiv.innerHTML = selectedExchanges.map(exchange => {
                // Check if this exchange requires a destination tag
                const exchangesRequiringTag = ['VALR', 'valr', 'Binance', 'binance', 'Kraken', 'kraken', 'OKX', 'okx', 'Bybit', 'bybit', 'KuCoin', 'kucoin', 'Coinbase', 'coinbase', 'Gate.io', 'gateio', 'HTX', 'htx', 'Bitget', 'bitget'];
                const requiresTag = exchangesRequiringTag.some(ex => exchange.toLowerCase() === ex.toLowerCase());
                const tagLabel = requiresTag ? 'üö® Destination Tag (REQUIRED)' : 'Destination Tag (optional)';

                return `
                    <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 6px; border-left: 3px solid #00d4ff;">
                        <div style="font-weight: bold; color: #00d4ff; margin-bottom: 8px;">${exchange}</div>
                        <div style="display: grid; gap: 12px;">
                            <div>
                                <label style="font-size: 0.85rem; color: #b8c6db; display: block; margin-bottom: 4px;">
                                    XRP Deposit Address
                                    <span style="color: #ff6b6b; font-size: 0.75rem; margin-left: 4px;">(must start with 'r', 25-35 chars)</span>
                                </label>
                                <input
                                    type="text"
                                    id="xrp_address_${exchange}"
                                    placeholder="rXXXXXXXXXXXXXXXXXXXXXXXXXXXX"
                                    value="${existingXrpData[exchange]?.address || ''}"
                                    oninput="validateXrpInputs('${exchange}')"
                                    onchange="saveXrpDepositInfo('${exchange}')"
                                    style="width: 100%; padding: 8px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; color: white; font-family: monospace; font-size: 0.9rem; transition: border 0.3s;"
                                >
                                <div id="xrp_address_feedback_${exchange}" style="font-size: 0.8rem; margin-top: 4px; min-height: 18px;"></div>
                            </div>
                            <div>
                                <label style="font-size: 0.85rem; color: ${requiresTag ? '#ff6b6b' : '#b8c6db'}; display: block; margin-bottom: 4px; font-weight: ${requiresTag ? 'bold' : 'normal'};">
                                    ${tagLabel}
                                </label>
                                <input
                                    type="text"
                                    id="xrp_tag_${exchange}"
                                    placeholder="${requiresTag ? 'REQUIRED - Numeric tag' : '12345678 (if required)'}"
                                    value="${existingXrpData[exchange]?.tag || ''}"
                                    oninput="validateXrpInputs('${exchange}')"
                                    onchange="saveXrpDepositInfo('${exchange}')"
                                    style="width: 100%; padding: 8px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; color: white; font-family: monospace; font-size: 0.9rem; transition: border 0.3s;"
                                >
                                <div id="xrp_tag_feedback_${exchange}" style="font-size: 0.8rem; margin-top: 4px; min-height: 18px;"></div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Trigger initial validation for existing values
            setTimeout(() => {
                selectedExchanges.forEach(exchange => {
                    const addressInput = document.getElementById(`xrp_address_${exchange}`);
                    const tagInput = document.getElementById(`xrp_tag_${exchange}`);
                    if ((addressInput && addressInput.value) || (tagInput && tagInput.value)) {
                        validateXrpInputs(exchange);
                    }
                });
            }, 100);
        }

        /**
         * Validate XRP address format
         * XRP addresses must:
         * - Start with 'r'
         * - Be 25-35 characters long
         * - Contain only alphanumeric characters (base58: rpshnaf39wBUDNEGHJKLM4PQRST7VWXYZ2bcdeCg65jkm8oFqi1tuvAxyz)
         */
        function validateXrpAddress(address) {
            if (!address || address.trim() === '') {
                return {
                    valid: false,
                    error: 'Address is required'
                };
            }

            const trimmedAddress = address.trim();

            // Must start with 'r'
            if (!trimmedAddress.startsWith('r')) {
                return {
                    valid: false,
                    error: 'XRP addresses must start with "r"'
                };
            }

            // Must be 25-35 characters
            if (trimmedAddress.length < 25 || trimmedAddress.length > 35) {
                return {
                    valid: false,
                    error: `Invalid length (${trimmedAddress.length} chars). Must be 25-35 characters`
                };
            }

            // Must contain only valid base58 characters (no 0, O, I, l)
            const base58Regex = /^[rpshnaf39wBUDNEGHJKLM4PQRST7VWXYZ2bcdeCg65jkm8oFqi1tuvAxyz]+$/;
            if (!base58Regex.test(trimmedAddress)) {
                return {
                    valid: false,
                    error: 'Contains invalid characters. XRP addresses use base58 (no 0, O, I, or l)'
                };
            }

            return {
                valid: true,
                message: '‚úÖ Valid XRP address format'
            };
        }

        /**
         * Validate XRP destination tag and show warnings for exchanges that require it
         */
        function validateXrpTag(exchange, tag) {
            const exchangesRequiringTag = [
                'VALR', 'valr',
                'Binance', 'binance',
                'Kraken', 'kraken',
                'OKX', 'okx',
                'Bybit', 'bybit',
                'KuCoin', 'kucoin',
                'Coinbase', 'coinbase',
                'Gate.io', 'gateio',
                'HTX', 'htx',
                'Bitget', 'bitget'
            ];

            const requiresTag = exchangesRequiringTag.some(ex =>
                exchange.toLowerCase() === ex.toLowerCase()
            );

            if (requiresTag) {
                if (!tag || tag.trim() === '') {
                    return {
                        valid: false,
                        error: `‚ö†Ô∏è ${exchange} REQUIRES a destination tag! Missing tag = PERMANENT FUND LOSS!`,
                        critical: true
                    };
                }

                // Tag should be numeric
                if (!/^\d+$/.test(tag.trim())) {
                    return {
                        valid: false,
                        error: 'Destination tag must be numeric',
                        critical: false
                    };
                }

                return {
                    valid: true,
                    message: '‚úÖ Destination tag configured'
                };
            }

            // Exchange doesn't require tag
            if (tag && tag.trim() !== '') {
                return {
                    valid: true,
                    message: '‚ÑπÔ∏è Optional for this exchange'
                };
            }

            return {
                valid: true,
                message: '‚ÑπÔ∏è Not required for this exchange'
            };
        }

        /**
         * Real-time validation as user types
         */
        function validateXrpInputs(exchange) {
            const addressInput = document.getElementById(`xrp_address_${exchange}`);
            const tagInput = document.getElementById(`xrp_tag_${exchange}`);
            const addressFeedback = document.getElementById(`xrp_address_feedback_${exchange}`);
            const tagFeedback = document.getElementById(`xrp_tag_feedback_${exchange}`);

            // Validate address
            const addressValidation = validateXrpAddress(addressInput.value);
            if (addressValidation.valid) {
                addressInput.style.border = '2px solid #00ff88';
                addressFeedback.innerHTML = `<span style="color: #00ff88;">${addressValidation.message}</span>`;
            } else {
                addressInput.style.border = '2px solid #ff6b6b';
                addressFeedback.innerHTML = `<span style="color: #ff6b6b;">‚ùå ${addressValidation.error}</span>`;
            }

            // Validate tag
            const tagValidation = validateXrpTag(exchange, tagInput.value);
            if (tagValidation.valid) {
                if (tagValidation.critical === false) {
                    tagInput.style.border = '2px solid #00ff88';
                } else {
                    tagInput.style.border = '1px solid rgba(255,255,255,0.2)';
                }
                tagFeedback.innerHTML = `<span style="color: ${tagValidation.message.includes('‚úÖ') ? '#00ff88' : '#b8c6db'};">${tagValidation.message}</span>`;
            } else {
                tagInput.style.border = tagValidation.critical ? '2px solid #ff3333' : '2px solid #ffb347';
                tagFeedback.innerHTML = `<span style="color: ${tagValidation.critical ? '#ff3333' : '#ffb347'};">${tagValidation.error}</span>`;
            }
        }

        // Auto-save XRP deposit info when user types
        async function saveXrpDepositInfo(exchange) {
            try {
                const address = document.getElementById(`xrp_address_${exchange}`).value.trim();
                const tag = document.getElementById(`xrp_tag_${exchange}`).value.trim();

                console.log(`üíæ Saving XRP deposit info for ${exchange}:`, { address, tag });

                const response = await fetch(`${API_BASE}/credentials/${exchange}/xrp-deposit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: USER_ID,
                        xrpDepositAddress: address || null,
                        xrpDepositTag: tag || null
                    })
                });

                const data = await response.json();

                if (data.success) {
                    console.log(`‚úÖ XRP deposit info saved for ${exchange}`);
                    // Show brief success feedback
                    const saveStatus = document.getElementById('saveStatus');
                    const oldText = saveStatus.textContent;
                    saveStatus.textContent = `‚úÖ ${exchange} XRP info saved`;
                    setTimeout(() => {
                        saveStatus.textContent = oldText;
                    }, 2000);
                } else {
                    console.error(`‚ùå Failed to save XRP info for ${exchange}:`, data.error);
                    alert(`Failed to save XRP info for ${exchange}: ${data.error}`);
                }
            } catch (error) {
                console.error(`‚ùå Error saving XRP info for ${exchange}:`, error);
            }
        }

        // Load paths
        async function loadPaths() {
            try {
                const sourceAsset = document.getElementById('filterSourceAsset').value;
                const destAsset = document.getElementById('filterDestAsset').value;

                let url = `${API_BASE}/paths?userId=${USER_ID}`;
                if (sourceAsset) url += `&sourceAsset=${sourceAsset}`;
                if (destAsset) url += `&destAsset=${destAsset}`;

                console.log('üîÑ Fetching paths from:', url);
                const response = await fetch(url);
                const data = await response.json();

                console.log('üîÑ Paths response:', data);

                if (data.success) {
                    // Note: We don't update totalPaths here - it should only show total from tickbox selections
                    // The filtered count is just for display purposes in the path list
                    console.log(`‚úÖ Found ${data.data.count} paths matching current filters`);

                    const listDiv = document.getElementById('pathsList');
                    if (data.data.paths.length === 0) {
                        listDiv.innerHTML = '<p style="color: #888;">No paths available. Select 2+ exchanges and currencies to generate paths.</p>';
                        console.log('‚ö†Ô∏è No paths generated. Need 2+ exchanges and currencies selected.');
                    } else {
                        console.log('üìã Displaying paths:', data.data.paths.map(p => p.description));
                        listDiv.innerHTML = data.data.paths.map((path, idx) => `
                            <div class="path-card">
                                <div class="path-header">
                                    <div class="path-title">${path.description}</div>
                                </div>
                                <div class="path-legs">
                                    ${path.legs.map(leg => `
                                        <div class="path-leg">
                                            <div class="leg-number">${leg.leg}</div>
                                            <div>${leg.description}</div>
                                        </div>
                                    `).join('')}
                                </div>
                                <button onclick='showPathDetails(${JSON.stringify(path).replace(/'/g, "&apos;")})' class="btn" style="width: 100%; margin-top: 10px;">
                                    View Details & Calculate
                                </button>
                            </div>
                        `).join('');
                    }
                }
            } catch (error) {
                console.error('‚ùå Failed to load paths:', error);
            }
        }

        // Save filter selections to localStorage and reload paths
        function saveFilters() {
            const sourceAsset = document.getElementById('filterSourceAsset').value;
            const destAsset = document.getElementById('filterDestAsset').value;

            console.log('üîç Saving filter selections:', { sourceAsset, destAsset });

            // Save to localStorage
            localStorage.setItem('currencySwap_filterSourceAsset', sourceAsset);
            localStorage.setItem('currencySwap_filterDestAsset', destAsset);

            console.log('‚úÖ Filters saved, reloading paths...');

            // Reload paths with new filters
            loadPaths();
        }

        // Load path statistics
        async function loadPathStats() {
            try {
                console.log('üìä Fetching path statistics from:', `${API_BASE}/paths/stats?userId=${USER_ID}`);
                const response = await fetch(`${API_BASE}/paths/stats?userId=${USER_ID}`);
                const data = await response.json();

                console.log('üìä Path stats response:', data);

                if (data.success) {
                    const stats = data.data;
                    const statsDiv = document.getElementById('pathStats');

                    if (stats.totalPaths === 0) {
                        statsDiv.innerHTML = '<p style="color: #888;">Select exchanges & currencies to see statistics...</p>';
                        console.log('‚ö†Ô∏è No path statistics available yet');
                        return;
                    }

                    const exchangeCount = Object.keys(stats.bySourceExchange).length;
                    const assetPairCount = Object.keys(stats.byAssetPair).length;
                    const pathsPerExchange = exchangeCount > 0 ? Math.round(stats.totalPaths / exchangeCount) : 0;

                    console.log('‚úÖ Path statistics loaded:', {
                        totalPaths: stats.totalPaths,
                        exchanges: exchangeCount,
                        assetPairs: assetPairCount
                    });

                    statsDiv.innerHTML = `
                        <div style="margin-bottom: 15px;">
                            <div style="font-size: 0.9rem; color: #b8c6db; margin-bottom: 5px;">Total Paths</div>
                            <div style="font-size: 1.5rem; color: #00ff88; font-weight: bold;">${stats.totalPaths}</div>
                        </div>

                        <!-- By Source Exchange Collapsible -->
                        <div style="margin-bottom: 15px;">
                            <div
                                onclick="toggleStatsSection('exchangeStats')"
                                style="
                                    font-size: 0.9rem;
                                    color: #00d4ff;
                                    margin-bottom: 5px;
                                    cursor: pointer;
                                    display: flex;
                                    align-items: center;
                                    gap: 8px;
                                    padding: 8px;
                                    background: rgba(0, 212, 255, 0.1);
                                    border-radius: 6px;
                                    transition: all 0.2s;
                                "
                                onmouseover="this.style.background='rgba(0, 212, 255, 0.2)'"
                                onmouseout="this.style.background='rgba(0, 212, 255, 0.1)'"
                            >
                                <span id="exchangeStatsIcon">‚ñ∂</span>
                                <span>By Source Exchange (${exchangeCount} exchanges √ó ~${pathsPerExchange} paths)</span>
                            </div>
                            <div id="exchangeStats" style="display: none; margin-top: 10px; padding-left: 10px;">
                                ${Object.entries(stats.bySourceExchange).map(([ex, count]) =>
                                    `<div style="display: flex; justify-content: space-between; padding: 5px 0;">
                                        <span>${ex}</span>
                                        <span style="color: #00d4ff;">${count} paths</span>
                                    </div>`
                                ).join('')}
                            </div>
                        </div>

                        <!-- By Asset Pair Collapsible -->
                        <div>
                            <div
                                onclick="toggleStatsSection('assetPairStats')"
                                style="
                                    font-size: 0.9rem;
                                    color: #ffb347;
                                    margin-bottom: 5px;
                                    cursor: pointer;
                                    display: flex;
                                    align-items: center;
                                    gap: 8px;
                                    padding: 8px;
                                    background: rgba(255, 179, 71, 0.1);
                                    border-radius: 6px;
                                    transition: all 0.2s;
                                "
                                onmouseover="this.style.background='rgba(255, 179, 71, 0.2)'"
                                onmouseout="this.style.background='rgba(255, 179, 71, 0.1)'"
                            >
                                <span id="assetPairStatsIcon">‚ñ∂</span>
                                <span>By Asset Pair (${assetPairCount} pairs)</span>
                            </div>
                            <div id="assetPairStats" style="display: none; margin-top: 10px; padding-left: 10px;">
                                ${Object.entries(stats.byAssetPair).map(([pair, count]) =>
                                    `<div style="display: flex; justify-content: space-between; padding: 5px 0;">
                                        <span>${pair}</span>
                                        <span style="color: #ffb347;">${count} paths</span>
                                    </div>`
                                ).join('')}
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Failed to load path stats:', error);
            }
        }

        // Toggle stats section visibility
        function toggleStatsSection(sectionId) {
            const section = document.getElementById(sectionId);
            const icon = document.getElementById(sectionId + 'Icon');

            if (section.style.display === 'none') {
                section.style.display = 'block';
                icon.textContent = '‚ñº';
            } else {
                section.style.display = 'none';
                icon.textContent = '‚ñ∂';
            }
        }

        // Show path details
        async function showPathDetails(path) {
            console.log('üîç Showing path details:', path.description);
            console.log('üìä Path info:', path);
            currentPath = path;

            // Calculate trade amount
            try {
                console.log('üí∞ Calculating trade amount for:', {
                    sourceExchange: path.sourceExchange,
                    sourceAsset: path.sourceAsset
                });

                const response = await fetch(`${API_BASE}/calculate-trade-amount`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: USER_ID,
                        sourceExchange: path.sourceExchange,
                        sourceAsset: path.sourceAsset
                    })
                });

                const data = await response.json();
                console.log('üí∞ Trade amount response:', data);

                const content = document.getElementById('pathDetailsContent');
                content.innerHTML = `
                    <div class="alert alert-info">
                        <strong>${path.description}</strong>
                    </div>

                    <div style="margin: 20px 0;">
                        <h4 style="color: #ffb347;">Execution Steps:</h4>
                        ${path.legs.map(leg => `
                            <div style="padding: 10px; background: rgba(255,255,255,0.05); border-radius: 6px; margin-bottom: 8px;">
                                <strong>${leg.leg}. ${leg.action.toUpperCase()}</strong> - ${leg.description}
                            </div>
                        `).join('')}
                    </div>

                    ${data.success ? `
                        <div class="alert alert-success">
                            <h4 style="margin: 0 0 10px 0;">üí∞ Risk-Based Trade Sizing</h4>
                            <div style="display: grid; grid-template-columns: 1fr auto; gap: 10px; font-size: 0.9rem;">
                                <span>Recommended Amount:</span>
                                <strong style="color: #00ff88;">${data.data.recommendedAmount.toFixed(2)} ${path.sourceAsset}</strong>

                                <span>Available Balance:</span>
                                <span>${data.data.availableBalance.toFixed(2)} ${path.sourceAsset}</span>

                                <span>Reserve (${data.data.settings.minReservePercent}%):</span>
                                <span>${data.data.reserveAmount.toFixed(2)} ${path.sourceAsset}</span>

                                <span>Limiting Factor:</span>
                                <span style="color: #ffb347;">${data.data.constraint}</span>
                            </div>
                        </div>
                    ` : `
                        <div class="alert alert-warning">
                            ${data.data.reason}
                        </div>
                    `}
                `;

                document.getElementById('pathDetailsModal').style.display = 'flex';
            } catch (error) {
                console.error('Failed to calculate trade amount:', error);
            }
        }

        function closePathDetails() {
            document.getElementById('pathDetailsModal').style.display = 'none';
            currentPath = null;
        }

        async function executeCurrentPath() {
            if (!currentPath) return;

            console.log('‚ö†Ô∏è Showing confirmation dialog for path:', currentPath.id);
            showExecutionConfirmation(currentPath);
        }

        // ============================================================================
        // EXECUTION CONFIRMATION MODAL FUNCTIONS
        // ============================================================================

        function showExecutionConfirmation(path) {
            console.log('‚ö†Ô∏è [Confirmation Modal] Showing execution confirmation...', path);

            // Store the path for later execution
            pendingExecution = path;

            // Get trade amount from settings (default $100)
            const tradeAmount = parseFloat(document.getElementById('maxTradeAmountUsdt')?.value || 100);

            // Populate confirmation details
            const detailsDiv = document.getElementById('confirmationDetails');
            detailsDiv.innerHTML = `
                <div style="background: rgba(0,212,255,0.1); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <div style="color: #00d4ff; font-weight: bold; margin-bottom: 10px;">üìä Swap Path Details</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; color: #b8c6db;">
                        <div><strong>Route:</strong></div>
                        <div style="text-align: right;">${path.sourceExchange} ‚Üí ${path.destExchange}</div>

                        <div><strong>Source Currency:</strong></div>
                        <div style="text-align: right;">${path.sourceCurrency}</div>

                        <div><strong>Destination Currency:</strong></div>
                        <div style="text-align: right;">${path.destCurrency}</div>

                        <div><strong>Bridge Asset:</strong></div>
                        <div style="text-align: right;">${path.bridgeAsset || 'XRP'}</div>

                        <div><strong>Trade Amount:</strong></div>
                        <div style="text-align: right;">${tradeAmount.toFixed(2)} ${path.sourceCurrency}</div>
                    </div>
                </div>

                <div style="background: rgba(0,255,136,0.1); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <div style="color: #00ff88; font-weight: bold; margin-bottom: 10px;">üí∞ Expected Profit</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; color: #b8c6db;">
                        <div><strong>Input Amount:</strong></div>
                        <div style="text-align: right;">${path.inputAmount?.toFixed(2) || tradeAmount.toFixed(2)} ${path.sourceCurrency}</div>

                        <div><strong>Expected Output:</strong></div>
                        <div style="text-align: right;">${path.outputAmount?.toFixed(2) || (tradeAmount * 1.005).toFixed(2)} ${path.destCurrency}</div>

                        <div style="padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.1);"><strong>Net Profit:</strong></div>
                        <div style="text-align: right; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.1); font-size: 1.2rem;">
                            <strong style="color: ${path.profitPercent >= 0 ? '#00ff88' : '#ff6b6b'};">
                                ${path.profitPercent >= 0 ? '+' : ''}${path.profitPercent?.toFixed(2) || '0.50'}%
                            </strong>
                        </div>
                    </div>
                </div>

                <div style="background: rgba(255,179,71,0.1); padding: 15px; border-radius: 8px;">
                    <div style="color: #ffb347; font-weight: bold; margin-bottom: 10px;">üìù Execution Steps</div>
                    <div style="color: #b8c6db; font-size: 0.9rem;">
                        <strong>Leg 1:</strong> Buy XRP with ${path.sourceCurrency} on ${path.sourceExchange}<br>
                        <strong>Leg 2:</strong> Withdraw XRP from ${path.sourceExchange} to ${path.destExchange}<br>
                        <strong>Leg 3:</strong> Sell XRP for ${path.destCurrency} on ${path.destExchange}
                    </div>
                </div>
            `;

            // Show modal
            const modal = document.getElementById('executionConfirmationModal');
            if (modal) {
                modal.style.display = 'flex';
                console.log('‚úÖ [Confirmation Modal] Confirmation dialog displayed');
            }
        }

        function closeExecutionConfirmation() {
            console.log('‚ùå [Confirmation Modal] User cancelled execution');
            const modal = document.getElementById('executionConfirmationModal');
            if (modal) {
                modal.style.display = 'none';
            }
            pendingExecution = null;
        }

        async function confirmAndExecute() {
            console.log('‚úÖ [Confirmation Modal] User confirmed execution');

            if (!pendingExecution) {
                alert('‚ö†Ô∏è No pending execution found');
                return;
            }

            // Close the confirmation modal
            closeExecutionConfirmation();

            // Execute the swap (call backend API)
            await executeSwapDirect(pendingExecution);

            // Clear pending execution
            pendingExecution = null;
        }

        // Execute currency swap via backend API (after confirmation)
        async function executeSwapDirect(path) {
            console.log('üöÄ EXECUTING CURRENCY SWAP:', path);

            try {
                // Get credentials from localStorage
                const sourceExchangeCreds = {
                    apiKey: localStorage.getItem(`${path.sourceExchange}_api`) || '',
                    apiSecret: localStorage.getItem(`${path.sourceExchange}_secret`) || '',
                    apiPassphrase: localStorage.getItem(`${path.sourceExchange}_passphrase`) || ''
                };

                const destExchangeCreds = {
                    apiKey: localStorage.getItem(`${path.destExchange}_api`) || '',
                    apiSecret: localStorage.getItem(`${path.destExchange}_secret`) || '',
                    apiPassphrase: localStorage.getItem(`${path.destExchange}_passphrase`) || '',
                    xrpDepositAddress: localStorage.getItem(`${path.destExchange}_xrp_deposit`) || '',
                    xrpDepositTag: localStorage.getItem(`${path.destExchange}_xrp_tag`) || ''
                };

                // Get trade amount
                const tradeAmount = parseFloat(document.getElementById('maxTradeAmountUsdt')?.value || 100);

                // Validate credentials
                if (!sourceExchangeCreds.apiKey || !sourceExchangeCreds.apiSecret) {
                    throw new Error(`Missing API credentials for ${path.sourceExchange}`);
                }

                if (!destExchangeCreds.apiKey || !destExchangeCreds.apiSecret) {
                    throw new Error(`Missing API credentials for ${path.destExchange}`);
                }

                if (!destExchangeCreds.xrpDepositAddress) {
                    throw new Error(`Missing XRP deposit address for ${path.destExchange}`);
                }

                console.log('‚úÖ Credentials validated, calling execution API...');

                // Call execution API
                const response = await fetch(`${API_BASE}/execute`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: USER_ID,
                        path: path,
                        amount: tradeAmount,
                        credentials: {
                            sourceCredentials: sourceExchangeCreds,
                            destCredentials: destExchangeCreds
                        }
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || `Execution failed: ${response.status}`);
                }

                const result = await response.json();

                if (result.success) {
                    console.log('‚úÖ CURRENCY SWAP EXECUTED SUCCESSFULLY:', result.data);
                    alert(`‚úÖ Currency Swap Executed Successfully!\n\nProfit: ${result.data.profitPercent?.toFixed(2)}%\nDuration: ${result.data.duration}ms`);
                } else {
                    throw new Error(result.error || 'Execution failed');
                }

            } catch (error) {
                console.error('‚ùå Currency Swap execution failed:', error);
                alert(`‚ùå Execution Failed\n\n${error.message}\n\nPlease check:\n- API credentials are configured\n- XRP deposit address is set\n- Sufficient balance available`);
            }
        }

        // Close modal when clicking outside the content
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('executionConfirmationModal');
            if (event.target === modal) {
                closeExecutionConfirmation();
            }
        });

        // Risk Settings (Inline Form)
        async function loadRiskSettings() {
            try {
                const response = await fetch(`${API_BASE}/settings?userId=${USER_ID}`);
                const data = await response.json();

                if (data.success) {
                    const s = data.data;
                    document.getElementById('thresholdPercent').value = s.threshold_percent || 0.5;
                    document.getElementById('maxTradeAmountUsdt').value = s.max_trade_amount_usdt || 5000;
                    document.getElementById('dailySwapLimit').value = s.daily_swap_limit || 50;
                    document.getElementById('enableStopLoss').checked = s.enable_stop_loss || false;

                    const status = document.getElementById('riskSaveStatus');
                    if (status) {
                        status.textContent = '‚úÖ Settings loaded';
                        status.style.color = '#00ff88';
                    }
                }
            } catch (error) {
                console.error('Failed to load risk settings:', error);
                const status = document.getElementById('riskSaveStatus');
                if (status) {
                    status.textContent = '‚ùå Failed to load settings';
                    status.style.color = '#ff6b6b';
                }
            }
        }

        async function saveRiskSettings() {
            try {
                const status = document.getElementById('riskSaveStatus');
                if (status) {
                    status.textContent = 'üíæ Saving...';
                    status.style.color = '#ffb347';
                }

                const settings = {
                    userId: USER_ID,
                    thresholdPercent: parseFloat(document.getElementById('thresholdPercent').value),
                    maxTradeAmountUsdt: parseFloat(document.getElementById('maxTradeAmountUsdt').value),
                    dailySwapLimit: parseInt(document.getElementById('dailySwapLimit').value),
                    enableStopLoss: document.getElementById('enableStopLoss').checked
                };

                const response = await fetch(`${API_BASE}/settings`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });

                const data = await response.json();
                if (data.success) {
                    if (status) {
                        status.textContent = '‚úÖ Settings saved successfully!';
                        status.style.color = '#00ff88';
                    }
                    await loadPaths(); // Reload paths with new settings
                } else {
                    if (status) {
                        status.textContent = '‚ùå Failed to save: ' + data.error;
                        status.style.color = '#ff6b6b';
                    }
                }
            } catch (error) {
                console.error('Failed to save risk settings:', error);
                const status = document.getElementById('riskSaveStatus');
                if (status) {
                    status.textContent = '‚ùå Error saving settings';
                    status.style.color = '#ff6b6b';
                }
            }
        }

        // Worker loop variables
        let workerLoopActive = false;
        let workerLoopTimeout = null;

        async function toggleAutoTrading() {
            const toggle = document.getElementById('autoTradingToggle');
            const enabled = toggle.classList.contains('active');

            console.log(`üîÑ Toggling auto-trading to: ${enabled ? 'ON' : 'OFF'}`);

            try {
                const response = await fetch(`${API_BASE}/settings/toggle-auto`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: USER_ID, enabled })
                });

                const data = await response.json();
                console.log('üîÑ Toggle response:', data);

                if (data.success) {
                    console.log(`‚úÖ Auto-trading ${enabled ? 'ENABLED' : 'DISABLED'} successfully!`);

                    // Start or stop the worker loop
                    if (enabled) {
                        startWorkerLoop();
                    } else {
                        stopWorkerLoop();
                    }
                } else {
                    console.error('‚ùå Failed to toggle auto-trading:', data.error);
                }
            } catch (error) {
                console.error('‚ùå Failed to toggle auto-trading:', error);
            }
        }

        // Start the scan-execute-pause worker loop
        function startWorkerLoop() {
            if (workerLoopActive) {
                console.log('‚ö†Ô∏è Worker loop already active');
                return;
            }

            workerLoopActive = true;
            console.log('üöÄ Starting worker loop...');
            runWorkerCycle();
        }

        // Stop the worker loop
        function stopWorkerLoop() {
            workerLoopActive = false;
            if (workerLoopTimeout) {
                clearTimeout(workerLoopTimeout);
                workerLoopTimeout = null;
            }
            console.log('‚èπÔ∏è Worker loop stopped');
        }

        // Run a single worker cycle: scan ‚Üí execute ‚Üí wait 15s ‚Üí repeat
        async function runWorkerCycle() {
            if (!workerLoopActive) {
                console.log('‚èπÔ∏è Worker loop not active, stopping');
                return;
            }

            console.log('üîÑ [Worker] Starting cycle...');

            try {
                // Step 1: Scan for best opportunity
                console.log('üîç [Worker] Scanning for opportunities...');
                const scanResponse = await fetch(`${API_BASE}/scan?userId=${USER_ID}`);
                const scanData = await scanResponse.json();

                if (!scanData.success) {
                    console.warn('‚ö†Ô∏è [Worker] Scan failed:', scanData.message);
                    scheduleNextCycle();
                    return;
                }

                const opportunity = scanData.data.opportunity;

                if (!opportunity) {
                    console.log('‚ÑπÔ∏è [Worker] No profitable paths found, waiting...');
                    scheduleNextCycle();
                    return;
                }

                console.log(`‚úÖ [Worker] Found opportunity: ${opportunity.id} (${opportunity.profitPercent.toFixed(2)}% profit)`);

                // Step 2: Execute the opportunity
                console.log('‚ö° [Worker] Executing trade...');
                const executeResponse = await fetch(`${API_BASE}/execute`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: USER_ID,
                        path: opportunity,
                        amount: opportunity.inputAmount || 1000 // Use path's input amount or default
                    })
                });

                const executeData = await executeResponse.json();

                if (executeData.success) {
                    const execution = executeData.execution;
                    console.log(`‚úÖ [Worker] Trade executed successfully!`);
                    console.log(`üí∞ [Worker] Profit: ${execution.profit} (${execution.profitPercent.toFixed(2)}%)`);
                    console.log(`‚è±Ô∏è [Worker] Duration: ${execution.duration}ms`);

                    // Update UI with execution results
                    updateExecutionStats(execution);
                } else {
                    console.error('‚ùå [Worker] Trade execution failed:', executeData.error);
                }

            } catch (error) {
                console.error('‚ùå [Worker] Cycle error:', error);
            }

            // Step 3: Wait 15 seconds and repeat
            scheduleNextCycle();
        }

        // Schedule the next worker cycle after 15 seconds
        function scheduleNextCycle() {
            if (!workerLoopActive) return;

            const delaySeconds = 15;
            console.log(`‚è∞ [Worker] Next cycle in ${delaySeconds} seconds...`);

            workerLoopTimeout = setTimeout(() => {
                runWorkerCycle();
            }, delaySeconds * 1000);
        }

        // Update UI with execution stats
        function updateExecutionStats(execution) {
            // Update swaps today count
            const swapsTodayEl = document.getElementById('swapsToday');
            if (swapsTodayEl) {
                const currentCount = parseInt(swapsTodayEl.textContent) || 0;
                swapsTodayEl.textContent = currentCount + 1;
            }

            // Reload stats and paths to reflect changes
            setTimeout(() => {
                loadStats();
                loadPaths();
            }, 1000);
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // TRADING ACTIVITY FUNCTIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        // Tab switching for Trading Activity
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('activity-tab-btn')) {
                const tab = e.target.dataset.tab;

                // Update buttons
                document.querySelectorAll('.activity-tab-btn').forEach(btn => {
                    btn.style.background = 'rgba(255,255,255,0.03)';
                    btn.style.border = '1px solid transparent';
                    btn.style.color = '#888';
                    btn.classList.remove('active');
                });

                e.target.style.background = 'rgba(0,212,255,0.15)';
                e.target.style.border = '1px solid #00d4ff';
                e.target.style.color = '#00d4ff';
                e.target.classList.add('active');

                // Update content
                document.querySelectorAll('.activity-tab-content').forEach(content => {
                    content.style.display = 'none';
                });

                if (tab === 'swaps') {
                    document.getElementById('activityTabSwaps').style.display = 'block';
                    loadRecentSwaps();
                } else if (tab === 'balances') {
                    document.getElementById('activityTabBalances').style.display = 'block';

                    // Check if we have any balances in localStorage
                    const hasBalances = Object.keys(localStorage).some(key => key.includes('_current'));

                    if (!hasBalances) {
                        // First time opening - auto-refresh from exchanges
                        console.log('üí∞ First time opening Balance Tracker - auto-refreshing...');
                        refreshBalances();
                    } else {
                        // Show cached balances
                        loadBalanceTracker();
                    }
                }
            }
        });

        // Load recent currency swaps
        async function loadRecentSwaps() {
            try {
                console.log('üìú Loading recent swaps...');
                const response = await fetch(`${API_BASE}/recent?userId=${USER_ID}&limit=10`);
                const data = await response.json();

                console.log('üìú Recent swaps response:', data);

                const container = document.getElementById('recentSwaps');

                if (data.success && data.data && data.data.length > 0) {
                    container.innerHTML = data.data.map(swap => `
                        <div style="background: rgba(0,212,255,0.05); padding: 12px; border-radius: 8px; border-left: 3px solid ${swap.status === 'completed' ? '#00ff88' : swap.status === 'failed' ? '#ff6b6b' : '#ffb347'}; margin-bottom: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                <div style="font-weight: bold; color: #00d4ff;">
                                    ${swap.from_asset} ‚Üí ${swap.to_asset}
                                </div>
                                <div style="font-size: 0.85rem; color: ${swap.profit_percent >= 0 ? '#00ff88' : '#ff6b6b'};">
                                    ${swap.profit_percent >= 0 ? '+' : ''}${swap.profit_percent}%
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 0.85rem; color: #888;">
                                <span>${swap.from_exchange} ‚Üí ${swap.to_exchange}</span>
                                <span>${new Date(swap.created_at).toLocaleString()}</span>
                            </div>
                            <div style="margin-top: 5px; font-size: 0.8rem; padding: 4px 8px; background: rgba(0,0,0,0.3); border-radius: 4px; display: inline-block; color: ${swap.status === 'completed' ? '#00ff88' : swap.status === 'failed' ? '#ff6b6b' : '#ffb347'};">
                                ${swap.status.toUpperCase()}
                            </div>
                        </div>
                    `).join('');

                    console.log(`‚úÖ Loaded ${data.data.length} recent swaps`);
                } else {
                    container.innerHTML = `
                        <div style="text-align: center; color: #888; padding: 20px;">
                            No swaps yet. Enable auto-trading to start.
                        </div>
                    `;
                    console.log('‚ö†Ô∏è No recent swaps found');
                }
            } catch (error) {
                console.error('‚ùå Failed to load recent swaps:', error);
            }
        }

        // Load balance tracker
        async function loadBalanceTracker() {
            try {
                console.log('üí∞ Loading balance tracker...');

                // Get selected exchanges and currencies from settings
                const settingsResponse = await fetch(`${API_BASE}/settings?userId=${USER_ID}`);
                const settingsData = await settingsResponse.json();

                if (!settingsData.success) {
                    console.error('‚ùå Failed to load settings for balance tracker');
                    return;
                }

                const settings = settingsData.data;
                const selectedExchanges = settings.selected_exchanges || [];
                const selectedCurrencies = settings.selected_currencies || [];

                console.log('üí∞ Tracking balances for:', { exchanges: selectedExchanges, currencies: selectedCurrencies });

                if (selectedExchanges.length === 0 || selectedCurrencies.length === 0) {
                    document.getElementById('balanceTrackerContent').innerHTML = `
                        <div style="text-align: center; color: #888; padding: 20px;">
                            Select exchanges and currencies in the Setup section to track balances.
                        </div>
                    `;
                    return;
                }

                // Calculate totals per currency across all exchanges
                const currencyTotals = {};
                for (const currency of selectedCurrencies) {
                    let totalStarting = 0;
                    let totalCurrent = 0;

                    for (const exchange of selectedExchanges) {
                        const balanceKey = `${exchange}_${currency}`;
                        totalStarting += parseFloat(localStorage.getItem(`${balanceKey}_starting`) || 0);
                        totalCurrent += parseFloat(localStorage.getItem(`${balanceKey}_current`) || 0);
                    }

                    const change = totalCurrent - totalStarting;
                    const changePercent = totalStarting > 0 ? ((change / totalStarting) * 100) : 0;

                    currencyTotals[currency] = {
                        starting: totalStarting,
                        current: totalCurrent,
                        change: change,
                        changePercent: changePercent
                    };
                }

                console.log('üí∞ Currency totals:', currencyTotals);

                // Build HTML starting with Total Overview
                let html = `
                    <!-- Total Overview Section -->
                    <div style="background: linear-gradient(135deg, rgba(0,255,136,0.1) 0%, rgba(0,212,255,0.1) 100%); padding: 20px; border-radius: 12px; margin-bottom: 25px; border: 2px solid rgba(0,255,136,0.3);">
                        <h4 style="color: #00ff88; margin: 0 0 15px 0; display: flex; align-items: center; gap: 10px;">
                            üìä Total Movement Across All Exchanges
                        </h4>

                        <!-- Period Tabs -->
                        <div style="display: flex; gap: 5px; margin-bottom: 15px; background: rgba(0,0,0,0.3); padding: 5px; border-radius: 8px;">
                            <button class="period-tab-btn active" data-period="total" style="flex: 1; padding: 8px 10px; background: rgba(0,255,136,0.15); border: 1px solid #00ff88; border-radius: 6px; color: #00ff88; cursor: pointer; font-weight: bold; font-size: 0.85rem;">
                                All Time
                            </button>
                            <button class="period-tab-btn" data-period="daily" style="flex: 1; padding: 8px 10px; background: rgba(255,255,255,0.03); border: 1px solid transparent; border-radius: 6px; color: #888; cursor: pointer; font-weight: bold; font-size: 0.85rem;">
                                Daily
                            </button>
                            <button class="period-tab-btn" data-period="weekly" style="flex: 1; padding: 8px 10px; background: rgba(255,255,255,0.03); border: 1px solid transparent; border-radius: 6px; color: #888; cursor: pointer; font-weight: bold; font-size: 0.85rem;">
                                Weekly
                            </button>
                            <button class="period-tab-btn" data-period="monthly" style="flex: 1; padding: 8px 10px; background: rgba(255,255,255,0.03); border: 1px solid transparent; border-radius: 6px; color: #888; cursor: pointer; font-weight: bold; font-size: 0.85rem;">
                                Monthly
                            </button>
                        </div>

                        <!-- Currency Summary Cards -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                `;

                // Add a card for each currency showing total movement
                for (const currency of selectedCurrencies) {
                    const totals = currencyTotals[currency];
                    const isProfit = totals.change >= 0;

                    html += `
                        <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; border-left: 4px solid ${isProfit ? '#00ff88' : '#ff6b6b'};">
                            <div style="font-weight: bold; color: #00d4ff; font-size: 1.1rem; margin-bottom: 12px;">${currency}</div>
                            <div style="display: flex; flex-direction: column; gap: 8px; font-size: 0.9rem;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: #888;">Starting:</span>
                                    <span style="color: #00d4ff; font-weight: bold;">${totals.starting.toFixed(2)}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: #888;">Current:</span>
                                    <span style="color: #00d4ff; font-weight: bold;">${totals.current.toFixed(2)}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.1);">
                                    <span style="color: #888; font-weight: bold;">P/L:</span>
                                    <span style="color: ${isProfit ? '#00ff88' : '#ff6b6b'}; font-weight: bold; font-size: 1.1rem;">
                                        ${isProfit ? '+' : ''}${totals.change.toFixed(2)}
                                    </span>
                                </div>
                                <div style="text-align: right;">
                                    <span style="color: ${isProfit ? '#00ff88' : '#ff6b6b'}; font-weight: bold; font-size: 0.95rem;">
                                        (${isProfit ? '+' : ''}${totals.changePercent.toFixed(2)}%)
                                    </span>
                                </div>
                            </div>
                        </div>
                    `;
                }

                html += `
                        </div>
                        <div style="margin-top: 12px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 6px; text-align: center; color: #888; font-size: 0.85rem;">
                            üí° Shows combined balance across all selected exchanges
                        </div>
                    </div>

                    <!-- Individual Exchange Cards -->
                    <h4 style="color: #00d4ff; margin: 20px 0 15px 0; padding-bottom: 10px; border-bottom: 1px solid rgba(0,212,255,0.3);">
                        Per Exchange Breakdown
                    </h4>
                `;

                // Generate individual exchange balance cards
                for (const exchange of selectedExchanges) {
                    html += `
                        <div style="margin-bottom: 25px; background: rgba(0,212,255,0.05); padding: 15px; border-radius: 10px; border: 1px solid rgba(0,212,255,0.3);">
                            <h4 style="color: #00d4ff; margin: 0 0 15px 0;">üè¶ ${exchange}</h4>
                    `;

                    // Add currency cards for this exchange
                    for (const currency of selectedCurrencies) {
                        const balanceKey = `${exchange}_${currency}`;
                        const startingBalance = parseFloat(localStorage.getItem(`${balanceKey}_starting`) || 0);
                        const currentBalance = parseFloat(localStorage.getItem(`${balanceKey}_current`) || 0);
                        const change = currentBalance - startingBalance;
                        const changePercent = startingBalance > 0 ? ((change / startingBalance) * 100) : 0;

                        html += `
                            <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid ${change >= 0 ? '#00ff88' : '#ff6b6b'};">
                                <div style="font-weight: bold; color: #00d4ff; margin-bottom: 8px;">${currency}</div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; font-size: 0.9rem;">
                                    <div>
                                        <div style="color: #888; font-size: 0.8rem;">Starting</div>
                                        <div style="color: #00d4ff; font-weight: bold;">${startingBalance.toFixed(2)}</div>
                                    </div>
                                    <div>
                                        <div style="color: #888; font-size: 0.8rem;">Current</div>
                                        <div style="color: #00d4ff; font-weight: bold;">${currentBalance.toFixed(2)}</div>
                                    </div>
                                    <div>
                                        <div style="color: #888; font-size: 0.8rem;">Change</div>
                                        <div style="color: ${change >= 0 ? '#00ff88' : '#ff6b6b'}; font-weight: bold;">
                                            ${change >= 0 ? '+' : ''}${change.toFixed(2)} (${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(2)}%)
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }

                    html += `</div>`;
                }

                document.getElementById('balanceTrackerContent').innerHTML = html;
                document.getElementById('balanceLastUpdate').textContent = new Date().toLocaleString();

                // Add tab switching for period tabs (placeholder for future daily/weekly/monthly tracking)
                document.querySelectorAll('.period-tab-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        document.querySelectorAll('.period-tab-btn').forEach(b => {
                            b.style.background = 'rgba(255,255,255,0.03)';
                            b.style.border = '1px solid transparent';
                            b.style.color = '#888';
                        });
                        this.style.background = 'rgba(0,255,136,0.15)';
                        this.style.border = '1px solid #00ff88';
                        this.style.color = '#00ff88';

                        const period = this.dataset.period;
                        console.log(`üìä Selected period: ${period}`);
                        // TODO: Implement period filtering (requires timestamp tracking)
                    });
                });

                console.log('‚úÖ Balance tracker loaded with totals');
            } catch (error) {
                console.error('‚ùå Failed to load balance tracker:', error);
            }
        }

        // Refresh balances from exchanges
        async function refreshBalances() {
            try {
                console.log('üîÑ Refreshing balances from exchanges...');

                // Get selected exchanges and currencies from checkboxes
                const exchangeCheckboxes = document.querySelectorAll('#exchangeCheckboxes input[type="checkbox"]:checked');
                const selectedExchanges = Array.from(exchangeCheckboxes).map(cb => cb.value);

                const currencyCheckboxes = document.querySelectorAll('#currencyCheckboxes input[type="checkbox"]:checked');
                const selectedCurrencies = Array.from(currencyCheckboxes).map(cb => cb.value);

                if (selectedExchanges.length === 0) {
                    alert('Please select at least one exchange first');
                    return;
                }

                // Show loading indicator
                document.getElementById('balanceTrackerContent').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #00d4ff;">
                        <div style="font-size: 2rem; margin-bottom: 10px;">‚è≥</div>
                        <div>Fetching live balances from exchanges...</div>
                        <div style="font-size: 0.85rem; color: #888; margin-top: 10px;">This may take a few seconds</div>
                    </div>
                `;

                // Gather credentials from localStorage for each exchange
                const exchangeCredentials = [];
                const missingCredentials = [];

                for (const exchange of selectedExchanges) {
                    const exchangeLower = exchange.toLowerCase();
                    const apiKey = localStorage.getItem(`${exchangeLower}_currency-swap_api`);
                    const apiSecret = localStorage.getItem(`${exchangeLower}_currency-swap_secret`);
                    const apiPassphrase = localStorage.getItem(`${exchangeLower}_currency-swap_passphrase`);
                    const memo = localStorage.getItem(`${exchangeLower}_currency-swap_memo`);

                    console.log(`üîç Checking credentials for ${exchange}:`, {
                        exchangeLower,
                        apiKeyFound: !!apiKey,
                        apiKeyLength: apiKey ? apiKey.length : 0,
                        apiSecretFound: !!apiSecret,
                        apiSecretLength: apiSecret ? apiSecret.length : 0
                    });

                    if (!apiKey || !apiSecret) {
                        missingCredentials.push(exchange);
                        console.warn(`‚ö†Ô∏è No credentials found for ${exchange} in localStorage`);
                        console.log(`üìã localStorage keys:`, Object.keys(localStorage).filter(k => k.includes(exchangeLower)));
                        continue;
                    }

                    exchangeCredentials.push({
                        exchange: exchangeLower,
                        apiKey,
                        apiSecret,
                        apiPassphrase,
                        memo
                    });
                }

                if (exchangeCredentials.length === 0) {
                    throw new Error(`No credentials found. Please connect exchanges in Strategy API Configuration first.\n\nMissing: ${missingCredentials.join(', ')}`);
                }

                console.log(`üí∞ Fetching balances for ${exchangeCredentials.length} exchanges with credentials`);

                // Fetch balances from each exchange using existing trading endpoints (same as Triangular Arb)
                const balances = {};
                const errors = {};

                for (const credData of exchangeCredentials) {
                    try {
                        const { exchange, apiKey, apiSecret, apiPassphrase, memo } = credData;

                        console.log(`üîÑ Fetching ${exchange} balance...`);

                        // Use trading balance endpoints (same as Strategy API Configuration & Triangular Arb)
                        const balanceEndpoint = exchange === 'chainex'
                            ? '/api/v1/trading/chainex/balance'
                            : `/api/v1/trading/${exchange}/balance`;

                        const requestBody = {
                            apiKey: apiKey,
                            apiSecret: apiSecret
                        };

                        // Add passphrase if provided (for OKX, KuCoin, etc.)
                        if (apiPassphrase) {
                            requestBody.passphrase = apiPassphrase;
                        }

                        // Add memo if provided (for BitMart)
                        if (memo) {
                            requestBody.memo = memo;
                        }

                        const response = await fetch(balanceEndpoint, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(requestBody)
                        });

                        const result = await response.json();

                        console.log(`üì• ${exchange} response:`, result);

                        // Handle different response formats (same as Triangular Arb)
                        let rawBalances = null;
                        if (result.success && result.data) {
                            rawBalances = result.data.balances || result.data;
                        } else if (result.success && result.balances) {
                            rawBalances = result.balances;
                        } else if (result.balances) {
                            rawBalances = result.balances;
                        }

                        if (rawBalances) {
                            // Find the display name with correct casing
                            const exchangeDisplay = selectedExchanges.find(e => e.toLowerCase() === exchange) || exchange;

                            // Extract only requested currencies with balance > 0
                            const exchangeBalances = {};
                            for (const currency of selectedCurrencies) {
                                if (rawBalances[currency] && parseFloat(rawBalances[currency]) > 0) {
                                    exchangeBalances[currency] = {
                                        free: parseFloat(rawBalances[currency]),
                                        used: 0,
                                        total: parseFloat(rawBalances[currency])
                                    };
                                }
                            }

                            if (Object.keys(exchangeBalances).length > 0) {
                                balances[exchangeDisplay] = exchangeBalances;
                                console.log(`‚úÖ ${exchange} balances:`, exchangeBalances);
                            }
                        } else {
                            errors[exchange] = 'Invalid response format';
                        }

                    } catch (error) {
                        console.error(`‚ùå Failed to fetch ${credData.exchange} balance:`, error);
                        errors[credData.exchange] = error.message;
                    }
                }

                console.log('üíæ Storing balances to localStorage...');

                // Store balances in localStorage
                let storedCount = 0;
                for (const exchange in balances) {
                    console.log(`üí± Processing balances for ${exchange}:`, balances[exchange]);

                    for (const currency in balances[exchange]) {
                        const balanceKey = `${exchange}_${currency}`;
                        const total = balances[exchange][currency].total;

                        // If starting balance doesn't exist, set it now (first time)
                        if (!localStorage.getItem(`${balanceKey}_starting`)) {
                            localStorage.setItem(`${balanceKey}_starting`, total);
                            console.log(`üìä Set starting balance for ${balanceKey}: ${total}`);
                        }

                        // Update current balance
                        localStorage.setItem(`${balanceKey}_current`, total);
                        console.log(`üìä Updated current balance for ${balanceKey}: ${total}`);
                        storedCount++;
                    }
                }

                console.log(`‚úÖ Stored ${storedCount} balance entries to localStorage`);

                // Show errors if any (including missing credentials)
                if (missingCredentials.length > 0 || Object.keys(errors).length > 0) {
                    const allErrors = { ...errors };
                    missingCredentials.forEach(exchange => {
                        allErrors[exchange] = 'No credentials - connect in Strategy API Configuration';
                    });

                    console.warn('‚ö†Ô∏è Some exchanges had errors:', allErrors);

                    if (storedCount === 0) {
                        // No balances fetched at all
                        let errorMessage = 'Failed to fetch balances:\n\n';
                        for (const exchange in allErrors) {
                            errorMessage += `${exchange}: ${allErrors[exchange]}\n`;
                        }
                        alert(errorMessage);
                    } else {
                        // Some balances fetched successfully
                        console.log(`‚ö†Ô∏è Fetched ${storedCount} balances with ${Object.keys(allErrors).length} errors`);
                    }
                }

                console.log('‚úÖ Balances refreshed successfully');

                // Reload the balance tracker display
                await loadBalanceTracker();

                alert('‚úÖ Balances refreshed from exchanges!');

            } catch (error) {
                console.error('‚ùå Failed to refresh balances:', error);
                alert(`Failed to refresh balances: ${error.message}`);

                // Reload anyway to show what we have
                await loadBalanceTracker();
            }
        }

        // Reset all starting balances
        function resetAllBalances() {
            if (!confirm('Are you sure you want to reset all starting balances? This will set all starting balances to current balances.')) {
                return;
            }

            console.log('üîÑ Resetting all starting balances...');

            // Get all localStorage keys for balances
            const keys = Object.keys(localStorage);
            const balanceKeys = keys.filter(key => key.includes('_current'));

            balanceKeys.forEach(key => {
                const currentValue = localStorage.getItem(key);
                const startingKey = key.replace('_current', '_starting');
                localStorage.setItem(startingKey, currentValue);
                console.log(`Reset ${startingKey} to ${currentValue}`);
            });

            alert('All starting balances have been reset to current balances.');
            loadBalanceTracker();
        }

        // ============================================================================
        // CURRENCY SWAP ARBITRAGE ABOUT MODAL
        // ============================================================================

        function openCurrencySwapAboutModal() {
            const modal = document.getElementById('currencySwapAboutModal');
            if (modal) {
                modal.style.display = 'flex';
                console.log('‚ÑπÔ∏è [About Modal] Currency Swap Arbitrage info opened');
            }
        }

        function closeCurrencySwapAboutModal() {
            const modal = document.getElementById('currencySwapAboutModal');
            if (modal) {
                modal.style.display = 'none';
                console.log('‚ÑπÔ∏è [About Modal] Currency Swap Arbitrage info closed');
            }
        }

        // Close modal when clicking outside the content
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('currencySwapAboutModal');
            if (event.target === modal) {
                closeCurrencySwapAboutModal();
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeCurrencySwapAboutModal();
            }
        });

        // End of About Modal Functionality

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // TEST SCAN MODE FUNCTIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        // Global variables for test scan state
        let currencySwapTestScanInterval = null;
        let currencySwapTestScanCountdownInterval = null;
        let currencySwapTestScanStartTime = null;
        let currencySwapTestScanCycleCount = 0;
        let currencySwapTestScanNextScanTime = null;

        /**
         * Save Test Scan Selections to localStorage (separate from main trading settings)
         * Called when checkboxes change
         */
        function saveTestScanSelections() {
            try {
                // Get selected exchanges
                const exchangeCheckboxes = document.querySelectorAll('#testScanExchangeCheckboxes input[type="checkbox"]:checked');
                const selectedExchanges = Array.from(exchangeCheckboxes).map(cb => cb.value);

                // Get selected currencies
                const currencyCheckboxes = document.querySelectorAll('#testScanCurrencyCheckboxes input[type="checkbox"]:checked');
                const selectedCurrencies = Array.from(currencyCheckboxes).map(cb => cb.value);

                // Save to localStorage with TEST SCAN specific keys
                localStorage.setItem('currencySwapTestScan_selectedExchanges', JSON.stringify(selectedExchanges));
                localStorage.setItem('currencySwapTestScan_selectedCurrencies', JSON.stringify(selectedCurrencies));

                console.log('üíæ Test Scan selections saved:', {
                    exchanges: selectedExchanges,
                    currencies: selectedCurrencies
                });

                // Update possible paths display
                updateTestScanPossiblePaths(selectedExchanges, selectedCurrencies);

            } catch (error) {
                console.error('Failed to save test scan selections:', error);
            }
        }

        /**
         * Load Test Scan Selections from localStorage
         * Called on page load
         */
        function loadTestScanSelections() {
            try {
                // Load saved selections from localStorage
                const selectedExchanges = JSON.parse(localStorage.getItem('currencySwapTestScan_selectedExchanges') || '[]');
                const selectedCurrencies = JSON.parse(localStorage.getItem('currencySwapTestScan_selectedCurrencies') || '[]');

                console.log('üìÇ Loading Test Scan selections:', {
                    exchanges: selectedExchanges,
                    currencies: selectedCurrencies
                });

                // Restore exchange checkboxes
                document.querySelectorAll('#testScanExchangeCheckboxes input[type="checkbox"]').forEach(cb => {
                    cb.checked = selectedExchanges.includes(cb.value);
                });

                // Restore currency checkboxes
                document.querySelectorAll('#testScanCurrencyCheckboxes input[type="checkbox"]').forEach(cb => {
                    cb.checked = selectedCurrencies.includes(cb.value);
                });

                // Update possible paths display
                updateTestScanPossiblePaths(selectedExchanges, selectedCurrencies);

                console.log('‚úÖ Test Scan selections loaded');

            } catch (error) {
                console.error('Failed to load test scan selections:', error);
            }
        }

        /**
         * Update Possible Paths calculation and display
         */
        function updateTestScanPossiblePaths(selectedExchanges, selectedCurrencies) {
            try {
                // Calculate possible paths
                // Formula: (E √ó (E-1)) √ó (C √ó (C-1)) / 2
                const possiblePaths = selectedExchanges.length >= 2 && selectedCurrencies.length >= 2
                    ? (selectedExchanges.length * (selectedExchanges.length - 1)) * (selectedCurrencies.length * (selectedCurrencies.length - 1)) / 2
                    : 0;

                const pathCountEl = document.getElementById('testScanPathCount');
                if (possiblePaths > 0) {
                    pathCountEl.textContent = Math.floor(possiblePaths).toLocaleString();
                    pathCountEl.style.color = '#00ff88';
                } else {
                    pathCountEl.textContent = '0 (select 2+ exchanges & 2+ currencies)';
                    pathCountEl.style.color = '#ff6b6b';
                }

                console.log(`üìä Possible paths: ${possiblePaths}`);

            } catch (error) {
                console.error('Failed to update possible paths:', error);
            }
        }

        /**
         * Start Currency Swap Test Scan
         */
        async function startCurrencySwapTestScan() {
            console.log('üî¨ Starting Currency Swap Test Scan...');

            // Validate selections
            const selectedExchanges = JSON.parse(localStorage.getItem('currencySwap_selectedExchanges') || '[]');
            const selectedCurrencies = JSON.parse(localStorage.getItem('currencySwap_selectedCurrencies') || '[]');

            if (selectedExchanges.length < 2) {
                alert('‚ö†Ô∏è Please select at least 2 exchanges to scan currency swap opportunities');
                return;
            }

            if (selectedCurrencies.length < 2) {
                alert('‚ö†Ô∏è Please select at least 2 currencies to scan currency swap opportunities');
                return;
            }

            // Get settings
            const minProfit = parseFloat(document.getElementById('testScanMinProfit').value);
            const scanInterval = parseInt(document.getElementById('testScanInterval').value) * 1000; // Convert to ms

            // Store config
            localStorage.setItem('currencySwapTestScan_config', JSON.stringify({
                exchanges: selectedExchanges,
                currencies: selectedCurrencies,
                minProfit,
                scanInterval: scanInterval / 1000
            }));

            // Initialize scan state
            currencySwapTestScanStartTime = Date.now();
            currencySwapTestScanCycleCount = 0;

            // UI updates
            document.getElementById('startTestScanBtn').disabled = true;
            document.getElementById('startTestScanBtn').style.cursor = 'not-allowed';
            document.getElementById('startTestScanBtn').style.opacity = '0.5';

            document.getElementById('stopTestScanBtn').disabled = false;
            document.getElementById('stopTestScanBtn').style.cursor = 'pointer';
            document.getElementById('stopTestScanBtn').style.background = 'rgba(255,107,107,0.8)';

            // Run first scan immediately
            await runCurrencySwapTestScanCycle();

            // Set up recurring scans
            currencySwapTestScanInterval = setInterval(async () => {
                await runCurrencySwapTestScanCycle();
            }, scanInterval);

            // Set up countdown timer
            currencySwapTestScanNextScanTime = Date.now() + scanInterval;
            currencySwapTestScanCountdownInterval = setInterval(updateCurrencySwapTestScanCountdown, 1000);
        }

        /**
         * Stop Currency Swap Test Scan
         */
        function stopCurrencySwapTestScan() {
            console.log('‚è∏Ô∏è Stopping Currency Swap Test Scan...');

            // Clear intervals
            if (currencySwapTestScanInterval) clearInterval(currencySwapTestScanInterval);
            if (currencySwapTestScanCountdownInterval) clearInterval(currencySwapTestScanCountdownInterval);

            // UI updates
            document.getElementById('startTestScanBtn').disabled = false;
            document.getElementById('startTestScanBtn').style.cursor = 'pointer';
            document.getElementById('startTestScanBtn').style.opacity = '1';

            document.getElementById('stopTestScanBtn').disabled = true;
            document.getElementById('stopTestScanBtn').style.cursor = 'not-allowed';
            document.getElementById('stopTestScanBtn').style.background = 'rgba(255,107,107,0.2)';

            document.getElementById('testScanStatusText').innerHTML = 'üü° STOPPED';
            document.getElementById('testScanStatusText').style.color = '#ffb347';
            document.getElementById('testScanCountdown').textContent = '--';

            console.log('‚úÖ Currency Swap Test Scan stopped');
        }

        /**
         * Reset Currency Swap Test Scan (clear all data)
         */
        function resetCurrencySwapTestScan() {
            if (!confirm('‚ö†Ô∏è This will clear all test scan results. Continue?')) {
                return;
            }

            console.log('üîÑ Resetting Currency Swap Test Scan data...');

            // Clear localStorage
            localStorage.removeItem('currencySwapTestScan_data');
            localStorage.removeItem('currencySwapTestScan_config');

            // Reset counters
            currencySwapTestScanCycleCount = 0;
            currencySwapTestScanStartTime = null;
            window.currencySwapTestScan90PercentWarningShown = false; // Reset warning flag

            // Stop scanning if active
            if (currencySwapTestScanInterval) {
                stopCurrencySwapTestScan();
            }

            // Reset UI
            document.getElementById('testScanStatusText').innerHTML = '‚ö™ READY TO SCAN';
            document.getElementById('testScanStatusText').style.color = '#888';
            document.getElementById('testScanCycles').textContent = '0';
            document.getElementById('testScanRunTime').textContent = '0:00';
            document.getElementById('testScanCountdown').textContent = '--';
            document.getElementById('testScanCurrentInfo').textContent = 'Waiting to start...';

            // Clear analytics tables - reset them to "Waiting for data..." state
            ['topRoutesByProfit', 'routeConsistency', 'bestCurrencyPairs', 'bestExchanges'].forEach(tableId => {
                const tbody = document.getElementById(tableId);
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #888; padding: 20px;">Waiting for scan data...</td></tr>';
                }
            });

            // Clear data availability analysis sections
            document.getElementById('exchangeCoverageTable').innerHTML = '<div style="text-align: center; padding: 20px; color: #888;">Waiting for scan data...</div>';
            document.getElementById('currencyCoverageTable').innerHTML = '<div style="text-align: center; padding: 20px; color: #888;">Waiting for scan data...</div>';
            document.getElementById('tradingRecommendations').innerHTML = '<div style="text-align: center; padding: 20px; color: #888;">Waiting for scan data...</div>';

            // Update storage display
            updateTestScanStorageDisplay();

            console.log('‚úÖ Currency Swap Test Scan data cleared');
        }

        /**
         * Update countdown timer for next scan
         */
        function updateCurrencySwapTestScanCountdown() {
            if (!currencySwapTestScanNextScanTime) return;

            const now = Date.now();
            const timeUntilNext = Math.max(0, currencySwapTestScanNextScanTime - now);
            const seconds = Math.ceil(timeUntilNext / 1000);

            document.getElementById('testScanCountdown').textContent = seconds + 's';
        }

        /**
         * Run Currency Swap Test Scan Cycle
         * Core scanning logic - calls API and stores results
         */
        async function runCurrencySwapTestScanCycle() {
            // Check storage capacity before running scan
            const MAX_TEST_RESULTS = 5000;
            const currentData = JSON.parse(localStorage.getItem('currencySwapTestScan_data') || '[]');
            const storagePercent = (currentData.length / MAX_TEST_RESULTS * 100);

            // AUTO-PAUSE at 100% capacity (Step 9.8)
            if (storagePercent >= 100) {
                console.log('üõë Storage FULL (100%) - Auto-pausing scan');
                alert('‚ö†Ô∏è TEST SCAN STORAGE FULL!\n\n' +
                      `You have collected ${currentData.length.toLocaleString()} routes (maximum capacity).\n\n` +
                      'Please DOWNLOAD your results before continuing.\n\n' +
                      'The scan has been automatically paused.');
                stopCurrencySwapTestScan();
                return;
            }

            // WARNING at 90% capacity (only show once per session) (Step 9.8)
            if (storagePercent >= 90 && !window.currencySwapTestScan90PercentWarningShown) {
                window.currencySwapTestScan90PercentWarningShown = true;
                console.log('‚ö†Ô∏è Storage at 90% - Warning user');
                setTimeout(() => {
                    if (confirm('‚ö†Ô∏è TEST SCAN STORAGE WARNING\n\n' +
                               `You have collected ${currentData.length.toLocaleString()} / ${MAX_TEST_RESULTS.toLocaleString()} routes (${storagePercent.toFixed(1)}%).\n\n` +
                               'Storage is filling up! Consider downloading results soon.\n\n' +
                               'Continue scanning?')) {
                        console.log('User chose to continue scanning');
                    } else {
                        stopCurrencySwapTestScan();
                    }
                }, 100);
            }

            currencySwapTestScanCycleCount++;
            const config = JSON.parse(localStorage.getItem('currencySwapTestScan_config') || '{}');

            console.log(`üîç Currency Swap Test Scan Cycle #${currencySwapTestScanCycleCount}`);

            // Update status UI
            document.getElementById('testScanStatusText').innerHTML = 'üü¢ SCANNING';
            document.getElementById('testScanStatusText').style.color = '#00ff88';
            document.getElementById('testScanCycles').textContent = currencySwapTestScanCycleCount;

            // Update running time
            const elapsedSeconds = Math.floor((Date.now() - currencySwapTestScanStartTime) / 1000);
            const minutes = Math.floor(elapsedSeconds / 60);
            const seconds = elapsedSeconds % 60;
            document.getElementById('testScanRunTime').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;

            try {
                // Get selected exchanges and currencies from Test Scan localStorage
                const selectedExchanges = JSON.parse(localStorage.getItem('currencySwapTestScan_selectedExchanges') || '[]');
                const selectedCurrencies = JSON.parse(localStorage.getItem('currencySwapTestScan_selectedCurrencies') || '[]');

                if (selectedExchanges.length === 0 || selectedCurrencies.length === 0) {
                    console.warn('‚ùå No exchanges or currencies selected for test scan');
                    return;
                }

                console.log(`üîç Scanning ${selectedExchanges.length} exchanges √ó ${selectedCurrencies.length} currencies`);

                // Call Currency Swap realtime scanner API (public endpoint - uses cached prices)
                const response = await fetch(`${API_BASE}/scan-realtime`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        exchanges: selectedExchanges,
                        currencies: selectedCurrencies,
                        minProfitPercent: config.minProfit || 0.5,
                        maxTradeAmount: 5000
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Backend error:', errorText);
                    throw new Error('Scan failed');
                }

                const result = await response.json();

                // DEBUG: Show full backend response to understand structure
                console.log('üîç RAW Backend Response:', JSON.stringify(result, null, 2));
                console.log('üì¶ Response structure:', {
                    hasSuccess: 'success' in result,
                    successValue: result.success,
                    hasData: 'data' in result,
                    dataType: typeof result.data,
                    hasOpportunity: result.data ? ('opportunity' in result.data) : 'N/A',
                    hasOpportunities: result.data ? ('opportunities' in result.data) : 'N/A',
                    opportunitiesCount: result.data?.opportunities?.length || 0
                });

                // Extract scan statistics
                const scannedPaths = result.data?.scannedPaths || 0;
                const totalPossiblePaths = result.data?.totalPossiblePaths || 0;
                const scanCoverage = totalPossiblePaths > 0 ? ((scannedPaths / totalPossiblePaths) * 100).toFixed(1) : 0;

                console.log(`üìä SCAN COVERAGE: ${scannedPaths.toLocaleString()} / ${totalPossiblePaths.toLocaleString()} paths (${scanCoverage}%)`);

                // Extract top 20 opportunities from response (NEW: now processing array instead of single)
                const opportunities = result.data?.opportunities || [];
                const bestOpportunity = result.data?.opportunity || null;

                // Enhanced logging - show what was actually found (including negative/losses)
                if (opportunities.length > 0) {
                    console.log(`üìä Backend found ${opportunities.length} opportunities (top 20):`);

                    let storedCount = 0;
                    let profitableCount = 0;
                    let lossCount = 0;
                    let belowThresholdCount = 0;

                    // Process all top 20 opportunities
                    for (const opportunity of opportunities) {
                        const profit = opportunity.profitPercent;
                        const isProfitable = profit > 0;
                        const meetsThreshold = profit >= config.minProfit;

                        if (isProfitable) {
                            profitableCount++;
                            if (meetsThreshold) {
                                storedCount++;
                                storeCurrencySwapOpportunity(opportunity);
                                console.log(`‚úÖ STORED #${storedCount}: ${opportunity.sourceExchange} ‚Üí ${opportunity.destExchange} | ${opportunity.sourceCurrency} | ${profit.toFixed(4)}%`);
                            } else {
                                belowThresholdCount++;
                                console.log(`‚ö†Ô∏è SKIP: ${opportunity.sourceExchange} ‚Üí ${opportunity.destExchange} | ${opportunity.sourceCurrency} | ${profit.toFixed(4)}% (below ${config.minProfit}%)`);
                            }
                        } else {
                            lossCount++;
                            console.log(`üìâ LOSS: ${opportunity.sourceExchange} ‚Üí ${opportunity.destExchange} | ${opportunity.sourceCurrency} | ${profit.toFixed(4)}%`);
                        }
                    }

                    // Summary of top 20
                    console.log(`‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`);
                    console.log(`üìä TOP 20 SUMMARY:`, {
                        scannedPaths: `${scannedPaths.toLocaleString()} / ${totalPossiblePaths.toLocaleString()} (${scanCoverage}%)`,
                        total: opportunities.length,
                        profitable: profitableCount,
                        meetsThreshold: storedCount,
                        belowThreshold: belowThresholdCount,
                        losses: lossCount,
                        profitRange: opportunities.length > 0 ?
                            `${opportunities[opportunities.length - 1].profitPercent.toFixed(4)}% to ${opportunities[0].profitPercent.toFixed(4)}%` :
                            'N/A'
                    });
                    console.log(`‚úÖ Stored ${storedCount} opportunities that meet ${config.minProfit}% threshold`);
                    console.log(`‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`);

                    // DATA AVAILABILITY ANALYSIS - Critical for understanding viable trading pairs
                    console.log(`\nüîç DATA AVAILABILITY ANALYSIS (for live trading decisions):`);
                    console.log(`‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`);

                    // Get selected exchanges and currencies
                    const selectedExchanges = JSON.parse(localStorage.getItem('currencySwapTestScan_selectedExchanges') || '[]');
                    const selectedCurrencies = JSON.parse(localStorage.getItem('currencySwapTestScan_selectedCurrencies') || '[]');

                    // Get available pairs from backend (ALL scanned paths, not just top 20)
                    const availablePairs = result.data?.availablePairs || {};

                    console.log(`üìã Available pairs from backend (${Object.keys(availablePairs).length} exchanges):`, availablePairs);

                    // Analyze which exchange-currency combinations have data
                    const exchangeCurrencyMatrix = {};
                    selectedExchanges.forEach(exchange => {
                        exchangeCurrencyMatrix[exchange] = {};
                        selectedCurrencies.forEach(currency => {
                            // Check if this exchange-currency combo is in availablePairs
                            exchangeCurrencyMatrix[exchange][currency] =
                                availablePairs[exchange] && availablePairs[exchange].includes(currency);
                        });
                    });

                    // Per-Exchange Coverage
                    console.log(`\nüìä PER-EXCHANGE COVERAGE:`);
                    let exchangeCoverageHTML = '';
                    selectedExchanges.forEach(exchange => {
                        const available = selectedCurrencies.filter(curr => exchangeCurrencyMatrix[exchange][curr]).length;
                        const total = selectedCurrencies.length;
                        const percentage = ((available / total) * 100).toFixed(0);
                        const availableCurrencies = selectedCurrencies.filter(curr => exchangeCurrencyMatrix[exchange][curr]);
                        const missingCurrencies = selectedCurrencies.filter(curr => !exchangeCurrencyMatrix[exchange][curr]);

                        // Console logging
                        console.log(`${exchange}: ${available}/${total} currencies (${percentage}%)`);
                        if (availableCurrencies.length > 0) {
                            console.log(`  ‚úÖ Available: ${availableCurrencies.join(', ')}`);
                        }
                        if (missingCurrencies.length > 0) {
                            console.log(`  ‚ùå Missing: ${missingCurrencies.join(', ')}`);
                        }

                        // UI HTML
                        const barColor = percentage >= 60 ? '#00ff88' : percentage >= 30 ? '#ffb347' : '#ff6b6b';
                        exchangeCoverageHTML += `
                            <div style="margin-bottom: 15px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 6px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span style="font-weight: bold; color: #00d4ff;">${exchange}</span>
                                    <span style="color: ${barColor};">${available}/${total} (${percentage}%)</span>
                                </div>
                                <div style="background: rgba(255,255,255,0.1); height: 6px; border-radius: 3px; margin-bottom: 8px;">
                                    <div style="background: ${barColor}; width: ${percentage}%; height: 100%; border-radius: 3px;"></div>
                                </div>
                                ${availableCurrencies.length > 0 ? `<div style="color: #00ff88; font-size: 0.8rem;">‚úÖ ${availableCurrencies.join(', ')}</div>` : ''}
                                ${missingCurrencies.length > 0 ? `<div style="color: #888; font-size: 0.8rem; margin-top: 3px;">‚ùå ${missingCurrencies.join(', ')}</div>` : ''}
                            </div>
                        `;
                    });
                    document.getElementById('exchangeCoverageTable').innerHTML = exchangeCoverageHTML;

                    // Per-Currency Coverage
                    console.log(`\nüìä PER-CURRENCY COVERAGE:`);
                    let currencyCoverageHTML = '';
                    selectedCurrencies.forEach(currency => {
                        const available = selectedExchanges.filter(ex => exchangeCurrencyMatrix[ex][currency]).length;
                        const total = selectedExchanges.length;
                        const percentage = ((available / total) * 100).toFixed(0);
                        const availableExchanges = selectedExchanges.filter(ex => exchangeCurrencyMatrix[ex][currency]);

                        // Console logging
                        console.log(`${currency}: ${available}/${total} exchanges (${percentage}%)`);
                        if (availableExchanges.length > 0) {
                            console.log(`  ‚úÖ Available on: ${availableExchanges.join(', ')}`);
                        }
                        if (available === 0) {
                            console.log(`  ‚ö†Ô∏è NO EXCHANGES support ${currency} - consider removing from selection`);
                        } else if (available < 3) {
                            console.log(`  ‚ö†Ô∏è LOW AVAILABILITY - limited arbitrage opportunities`);
                        }

                        // UI HTML
                        const barColor = percentage >= 60 ? '#00ff88' : percentage >= 30 ? '#ffb347' : '#ff6b6b';
                        let warningIcon = '';
                        if (available === 0) {
                            warningIcon = '<span style="color: #ff6b6b; font-size: 0.8rem;">‚ö†Ô∏è NO SUPPORT - Remove</span>';
                        } else if (available < 3) {
                            warningIcon = '<span style="color: #ffb347; font-size: 0.8rem;">‚ö†Ô∏è LOW - Limited Arb</span>';
                        }

                        currencyCoverageHTML += `
                            <div style="margin-bottom: 15px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 6px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span style="font-weight: bold; color: #ffb347;">${currency}</span>
                                    <span style="color: ${barColor};">${available}/${total} (${percentage}%)</span>
                                </div>
                                <div style="background: rgba(255,255,255,0.1); height: 6px; border-radius: 3px; margin-bottom: 8px;">
                                    <div style="background: ${barColor}; width: ${percentage}%; height: 100%; border-radius: 3px;"></div>
                                </div>
                                ${availableExchanges.length > 0 ? `<div style="color: #00ff88; font-size: 0.8rem;">‚úÖ ${availableExchanges.join(', ')}</div>` : ''}
                                ${warningIcon ? `<div style="margin-top: 5px;">${warningIcon}</div>` : ''}
                            </div>
                        `;
                    });
                    document.getElementById('currencyCoverageTable').innerHTML = currencyCoverageHTML;

                    // Best Pairs for Live Trading
                    console.log(`\nüí° LIVE TRADING RECOMMENDATIONS:`);
                    const viableCurrencies = selectedCurrencies.filter(currency => {
                        const available = selectedExchanges.filter(ex => exchangeCurrencyMatrix[ex][currency]).length;
                        return available >= 3; // Need at least 3 exchanges for arbitrage
                    });

                    let recommendationsHTML = '';
                    if (viableCurrencies.length > 0) {
                        // Console logging
                        console.log(`‚úÖ Viable currencies (3+ exchanges): ${viableCurrencies.join(', ')}`);
                        viableCurrencies.forEach(currency => {
                            const exchanges = selectedExchanges.filter(ex => exchangeCurrencyMatrix[ex][currency]);
                            console.log(`   ${currency}: ${exchanges.join(' ‚Üî ')}`);
                        });

                        // UI HTML
                        recommendationsHTML = `
                            <div style="background: rgba(0,255,136,0.1); padding: 15px; border-radius: 6px; border: 1px solid rgba(0,255,136,0.3);">
                                <div style="color: #00ff88; font-weight: bold; margin-bottom: 10px;">‚úÖ Viable Currencies for Live Trading (3+ exchanges):</div>
                                ${viableCurrencies.map(currency => {
                                    const exchanges = selectedExchanges.filter(ex => exchangeCurrencyMatrix[ex][currency]);
                                    return `
                                        <div style="margin-bottom: 10px; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 4px;">
                                            <div style="color: #ffb347; font-weight: bold; margin-bottom: 5px;">${currency} (${exchanges.length} exchanges)</div>
                                            <div style="color: #b8c6db; font-size: 0.85rem;">${exchanges.join(' ‚Üî ')}</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        `;
                    } else {
                        console.log(`‚ö†Ô∏è No currencies have 3+ exchanges - limited arbitrage opportunities`);
                        recommendationsHTML = `
                            <div style="background: rgba(255,107,107,0.1); padding: 15px; border-radius: 6px; border: 1px solid rgba(255,107,107,0.3); text-align: center;">
                                <div style="color: #ff6b6b; font-weight: bold;">‚ö†Ô∏è No Viable Currencies Found</div>
                                <div style="color: #888; font-size: 0.85rem; margin-top: 5px;">No currencies have 3+ exchanges. Select more exchanges or currencies.</div>
                            </div>
                        `;
                    }
                    document.getElementById('tradingRecommendations').innerHTML = recommendationsHTML;

                    console.log(`‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`);

                    // Update UI with best opportunity info
                    if (bestOpportunity) {
                        const profit = bestOpportunity.profitPercent;
                        const isProfitable = profit > 0;
                        const meetsThreshold = profit >= config.minProfit;

                        if (meetsThreshold) {
                            document.getElementById('testScanCurrentInfo').textContent =
                                `Scanned ${scannedPaths}/${totalPossiblePaths} (${scanCoverage}%) | ` +
                                `Best: ${bestOpportunity.sourceExchange} ‚Üí ${bestOpportunity.destExchange} | ` +
                                `${bestOpportunity.sourceCurrency} | ` +
                                `${profit.toFixed(4)}% | Stored ${storedCount}/20`;
                        } else if (isProfitable) {
                            document.getElementById('testScanCurrentInfo').textContent =
                                `Scanned ${scannedPaths}/${totalPossiblePaths} (${scanCoverage}%) | ` +
                                `Best: ${bestOpportunity.sourceExchange} ‚Üí ${bestOpportunity.destExchange} | ${bestOpportunity.sourceCurrency} | ` +
                                `+${profit.toFixed(4)}% (below ${config.minProfit}% threshold) | Stored ${storedCount}/20`;
                        } else {
                            document.getElementById('testScanCurrentInfo').textContent =
                                `Scanned ${scannedPaths}/${totalPossiblePaths} (${scanCoverage}%) | ` +
                                `Best: ${bestOpportunity.sourceExchange} ‚Üí ${bestOpportunity.destExchange} | ${bestOpportunity.sourceCurrency} | ` +
                                `${profit.toFixed(4)}% LOSS | Stored ${storedCount}/20`;
                        }
                    }
                } else {
                    console.log('‚ùå Backend returned no opportunities at all (this is unusual - backend should always return best path)');
                    document.getElementById('testScanCurrentInfo').textContent =
                        'No swap opportunities found in this cycle';
                }

            } catch (error) {
                console.error('‚ùå Test scan cycle failed:', error);
                document.getElementById('testScanCurrentInfo').textContent =
                    `Error: ${error.message}`;
            }

            // Reset countdown for next scan
            const scanInterval = config.scanInterval * 1000;
            currencySwapTestScanNextScanTime = Date.now() + scanInterval;
        }

        /**
         * Store Currency Swap Opportunity in localStorage
         * Step 9.5: Data storage with unique routeKey
         */
        function storeCurrencySwapOpportunity(opportunity) {
            try {
                let data = JSON.parse(localStorage.getItem('currencySwapTestScan_data') || '[]');

                // Create unique route key: sourceExchange_destExchange_sourceCurrency_destCurrency
                const routeKey = `${opportunity.sourceExchange}_${opportunity.destExchange}_${opportunity.sourceCurrency}_${opportunity.destCurrency}`;

                // Add metadata
                const enrichedOpportunity = {
                    ...opportunity,
                    timestamp: Date.now(),
                    routeKey: routeKey,
                    hour: new Date().getHours(),
                    date: new Date().toISOString()
                };

                data.push(enrichedOpportunity);

                // Keep last 5000 opportunities (localStorage quota limit)
                if (data.length > 5000) {
                    data = data.slice(-5000);
                }

                localStorage.setItem('currencySwapTestScan_data', JSON.stringify(data));

                console.log(`üíæ Stored opportunity: ${routeKey} (${data.length} total)`);

                // Update storage display
                updateTestScanStorageDisplay();

                // Update analytics tables
                updateTestScanAnalytics();

            } catch (error) {
                console.error('Failed to store opportunity:', error);
            }
        }

        /**
         * Export Currency Swap Test Scan data to CSV
         * Step 9.7: Download results for offline analysis
         */
        function exportCurrencySwapTestScanToCSV() {
            try {
                const data = JSON.parse(localStorage.getItem('currencySwapTestScan_data') || '[]');

                if (data.length === 0) {
                    alert('‚ö†Ô∏è No test scan data to export.\n\nStart a test scan first to collect opportunities.');
                    return;
                }

                console.log(`üì• Exporting ${data.length} opportunities to CSV...`);

                // CSV headers
                const headers = [
                    'Timestamp',
                    'Date',
                    'Hour',
                    'Source Exchange',
                    'Dest Exchange',
                    'Source Currency',
                    'Dest Currency',
                    'Profit %',
                    'Route Key'
                ];

                // Build CSV rows
                const rows = data.map(opp => [
                    opp.timestamp || '',
                    opp.date || new Date(opp.timestamp).toISOString(),
                    opp.hour !== undefined ? opp.hour : '',
                    opp.sourceExchange || '',
                    opp.destExchange || '',
                    opp.sourceCurrency || '',
                    opp.destCurrency || '',
                    opp.profitPercent !== undefined ? opp.profitPercent.toFixed(4) : '',
                    opp.routeKey || ''
                ]);

                // Combine headers and rows
                const csvContent = [
                    headers.join(','),
                    ...rows.map(row => row.join(','))
                ].join('\n');

                // Create download link
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');

                // Filename format: currency-swap-test-scan_YYYY-MM-DD_N-routes.csv
                const today = new Date().toISOString().split('T')[0];
                const filename = `currency-swap-test-scan_${today}_${data.length}-routes.csv`;

                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.display = 'none';

                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                console.log(`‚úÖ CSV exported: ${filename}`);
                alert(`‚úÖ CSV Export Successful!\n\nFile: ${filename}\nRoutes: ${data.length.toLocaleString()}\n\nCheck your Downloads folder.`);

            } catch (error) {
                console.error('Failed to export CSV:', error);
                alert(`‚ùå Export failed: ${error.message}`);
            }
        }

        /**
         * View Test Scan Analytics
         * Step 9.6: Display aggregated statistics and insights
         */
        function viewTestScanAnalytics() {
            try {
                const data = JSON.parse(localStorage.getItem('currencySwapTestScan_data') || '[]');

                if (data.length === 0) {
                    alert('‚ö†Ô∏è No test scan data available.\n\nStart a test scan first to collect opportunities and view analytics.');
                    return;
                }

                console.log(`üìä Analyzing ${data.length} opportunities...`);

                // Aggregate by routeKey
                const routeStats = {};
                data.forEach(opp => {
                    const key = opp.routeKey;
                    if (!routeStats[key]) {
                        routeStats[key] = {
                            routeKey: key,
                            sourceExchange: opp.sourceExchange,
                            destExchange: opp.destExchange,
                            sourceCurrency: opp.sourceCurrency,
                            destCurrency: opp.destCurrency,
                            profits: [],
                            count: 0,
                            firstSeen: opp.timestamp,
                            lastSeen: opp.timestamp
                        };
                    }
                    routeStats[key].profits.push(opp.profitPercent);
                    routeStats[key].count++;
                    routeStats[key].lastSeen = Math.max(routeStats[key].lastSeen, opp.timestamp);
                });

                // Calculate averages and sort
                const routes = Object.values(routeStats).map(route => {
                    const avgProfit = route.profits.reduce((a, b) => a + b, 0) / route.profits.length;
                    const maxProfit = Math.max(...route.profits);
                    const minProfit = Math.min(...route.profits);
                    return { ...route, avgProfit, maxProfit, minProfit };
                });

                // Top 10 by average profit
                const topByProfit = routes
                    .sort((a, b) => b.avgProfit - a.avgProfit)
                    .slice(0, 10);

                // Top 10 by consistency (most frequent)
                const topByConsistency = routes
                    .sort((a, b) => b.count - a.count)
                    .slice(0, 10);

                // Overall stats
                const totalOpportunities = data.length;
                const uniqueRoutes = routes.length;
                const avgProfit = data.reduce((sum, opp) => sum + opp.profitPercent, 0) / data.length;
                const maxProfit = Math.max(...data.map(opp => opp.profitPercent));
                const timeRange = {
                    start: Math.min(...data.map(opp => opp.timestamp)),
                    end: Math.max(...data.map(opp => opp.timestamp))
                };
                const durationHours = (timeRange.end - timeRange.start) / (1000 * 60 * 60);

                // Build analytics display
                let analyticsHTML = `
                    <div style="color: #b8c6db; line-height: 1.6;">
                        <h3 style="color: #00d4ff; margin-bottom: 20px;">üìä Currency Swap Test Scan Analytics</h3>

                        <div style="background: rgba(0,212,255,0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #00d4ff;">
                            <h4 style="color: #ffb347; margin: 0 0 10px 0;">Summary</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.9rem;">
                                <div><strong>Total Opportunities:</strong> ${totalOpportunities.toLocaleString()}</div>
                                <div><strong>Unique Routes:</strong> ${uniqueRoutes}</div>
                                <div><strong>Average Profit:</strong> ${avgProfit.toFixed(2)}%</div>
                                <div><strong>Best Profit:</strong> ${maxProfit.toFixed(2)}%</div>
                                <div><strong>Scan Duration:</strong> ${durationHours.toFixed(1)} hours</div>
                                <div><strong>Avg per Hour:</strong> ${(totalOpportunities / Math.max(durationHours, 0.1)).toFixed(1)}</div>
                            </div>
                        </div>

                        <div style="background: rgba(0,255,136,0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #00ff88;">
                            <h4 style="color: #00ff88; margin: 0 0 10px 0;">üèÜ Top 10 Routes by Average Profit</h4>
                            <div style="max-height: 300px; overflow-y: auto;">
                                ${topByProfit.map((route, i) => `
                                    <div style="background: rgba(0,0,0,0.2); padding: 10px; margin-bottom: 8px; border-radius: 6px; font-size: 0.85rem;">
                                        <div style="color: #ffb347; font-weight: bold;">#${i + 1} - ${route.avgProfit.toFixed(2)}% avg</div>
                                        <div>${route.sourceExchange} ‚Üí ${route.destExchange}</div>
                                        <div>${route.sourceCurrency} ‚Üí ${route.destCurrency}</div>
                                        <div style="color: #888; font-size: 0.8rem;">
                                            Count: ${route.count} |
                                            Max: ${route.maxProfit.toFixed(2)}% |
                                            Min: ${route.minProfit.toFixed(2)}%
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <div style="background: rgba(255,179,71,0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #ffb347;">
                            <h4 style="color: #ffb347; margin: 0 0 10px 0;">üîÅ Top 10 Most Consistent Routes</h4>
                            <div style="max-height: 300px; overflow-y: auto;">
                                ${topByConsistency.map((route, i) => `
                                    <div style="background: rgba(0,0,0,0.2); padding: 10px; margin-bottom: 8px; border-radius: 6px; font-size: 0.85rem;">
                                        <div style="color: #00d4ff; font-weight: bold;">#${i + 1} - ${route.count} times found</div>
                                        <div>${route.sourceExchange} ‚Üí ${route.destExchange}</div>
                                        <div>${route.sourceCurrency} ‚Üí ${route.destCurrency}</div>
                                        <div style="color: #888; font-size: 0.8rem;">
                                            Avg: ${route.avgProfit.toFixed(2)}% |
                                            Max: ${route.maxProfit.toFixed(2)}% |
                                            Min: ${route.minProfit.toFixed(2)}%
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;

                // Display in alert (simple version) or could create a modal
                const analyticsWindow = window.open('', 'Currency Swap Analytics', 'width=800,height=600');
                analyticsWindow.document.write(`
                    <html>
                    <head>
                        <title>Currency Swap Test Scan Analytics</title>
                        <style>
                            body {
                                font-family: 'Inter', -apple-system, sans-serif;
                                background: linear-gradient(135deg, #0c0c1e 0%, #161632 100%);
                                color: #b8c6db;
                                padding: 20px;
                                margin: 0;
                            }
                        </style>
                    </head>
                    <body>
                        ${analyticsHTML}
                        <div style="text-align: center; margin-top: 20px;">
                            <button onclick="window.print()" style="padding: 10px 20px; background: #00d4ff; color: #0c0c1e; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">
                                üñ®Ô∏è Print
                            </button>
                            <button onclick="window.close()" style="padding: 10px 20px; background: #ff6b6b; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin-left: 10px;">
                                ‚úñÔ∏è Close
                            </button>
                        </div>
                    </body>
                    </html>
                `);

                console.log('‚úÖ Analytics displayed in new window');

            } catch (error) {
                console.error('Failed to view analytics:', error);
                alert(`‚ùå Analytics failed: ${error.message}`);
            }
        }

        function updateTestScanStorageDisplay() {
            const data = JSON.parse(localStorage.getItem('currencySwapTestScan_data') || '[]');
            const routeCount = data.length;
            const storagePercent = (routeCount / 5000) * 100;

            document.getElementById('testScanRouteCount').textContent = routeCount.toLocaleString();
            document.getElementById('testScanStoragePercent').textContent = storagePercent.toFixed(1) + '%';
            document.getElementById('testScanStorageBar').style.width = storagePercent + '%';
        }

        /**
         * Update Test Scan Analytics Tables in Real-Time
         * Calculates and displays: top routes by profit, consistency, best pairs, best exchanges
         */
        function updateTestScanAnalytics() {
            try {
                const data = JSON.parse(localStorage.getItem('currencySwapTestScan_data') || '[]');

                if (data.length === 0) {
                    return; // Keep waiting message
                }

                // Aggregate by routeKey
                const routeStats = {};
                data.forEach(opp => {
                    const key = opp.routeKey;
                    if (!routeStats[key]) {
                        routeStats[key] = {
                            routeKey: key,
                            sourceExchange: opp.sourceExchange,
                            destExchange: opp.destExchange,
                            sourceCurrency: opp.sourceCurrency,
                            destCurrency: opp.destCurrency,
                            profits: [],
                            timestamps: [],
                            count: 0
                        };
                    }
                    routeStats[key].profits.push(opp.profitPercent);
                    routeStats[key].timestamps.push(opp.timestamp);
                    routeStats[key].count++;
                });

                // Calculate stats for each route
                const routes = Object.values(routeStats).map(route => {
                    const avgProfit = route.profits.reduce((a, b) => a + b, 0) / route.profits.length;
                    const maxProfit = Math.max(...route.profits);
                    const minProfit = Math.min(...route.profits);
                    const lastSeen = Math.max(...route.timestamps);
                    const consistency = route.count >= 5 ? ((1 - (maxProfit - minProfit) / avgProfit) * 100) : 50;

                    return {
                        ...route,
                        avgProfit,
                        maxProfit,
                        minProfit,
                        lastSeen,
                        consistency: Math.max(0, Math.min(100, consistency))
                    };
                });

                // 1. Top 20 Routes by Average Profit
                const topByProfit = routes.sort((a, b) => b.avgProfit - a.avgProfit).slice(0, 20);
                let profitHTML = '';
                topByProfit.forEach((route, idx) => {
                    const timeSince = Math.floor((Date.now() - route.lastSeen) / 60000);
                    profitHTML += `
                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                            <td style="padding: 10px; color: #666;">${idx + 1}</td>
                            <td style="padding: 10px;">${route.sourceExchange}</td>
                            <td style="padding: 10px;">${route.destExchange}</td>
                            <td style="padding: 10px; color: #00d4ff;">${route.sourceCurrency}</td>
                            <td style="padding: 10px; color: #00d4ff;">${route.destCurrency}</td>
                            <td style="padding: 10px; text-align: right; color: #00ff88; font-weight: bold;">${route.avgProfit.toFixed(2)}%</td>
                            <td style="padding: 10px; text-align: right; color: #ffb347;">${route.maxProfit.toFixed(2)}%</td>
                            <td style="padding: 10px; text-align: right;">${route.count}</td>
                            <td style="padding: 10px; text-align: right; color: #888; font-size: 0.8rem;">${timeSince}m ago</td>
                        </tr>
                    `;
                });
                document.getElementById('testScanTopProfitBody').innerHTML = profitHTML || '<tr><td colspan="9" style="text-align: center; padding: 20px; color: #888;">No data yet...</td></tr>';

                // 2. Top 20 Routes by Consistency
                const topByConsistency = routes.sort((a, b) => b.count - a.count).slice(0, 20);
                let consistencyHTML = '';
                topByConsistency.forEach((route, idx) => {
                    const routeDisplay = `${route.sourceExchange} ‚Üí ${route.destExchange} (${route.sourceCurrency}/${route.destCurrency})`;
                    const consistencyBar = `<div style="background: rgba(0,255,136,${route.consistency/100}); width: ${route.consistency}%; height: 8px; border-radius: 4px;"></div>`;
                    consistencyHTML += `
                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                            <td style="padding: 10px; color: #666;">${idx + 1}</td>
                            <td style="padding: 10px;">${routeDisplay}</td>
                            <td style="padding: 10px; text-align: right; color: #00d4ff; font-weight: bold;">${route.count}</td>
                            <td style="padding: 10px; text-align: right; color: #00ff88;">${route.avgProfit.toFixed(2)}%</td>
                            <td style="padding: 10px; text-align: right; font-size: 0.8rem;">${route.minProfit.toFixed(2)}% / ${route.maxProfit.toFixed(2)}%</td>
                            <td style="padding: 10px;">${consistencyBar}</td>
                        </tr>
                    `;
                });
                document.getElementById('testScanTopConsistencyBody').innerHTML = consistencyHTML || '<tr><td colspan="6" style="text-align: center; padding: 20px; color: #888;">No data yet...</td></tr>';

                // 3. Best Currency Pairs
                const pairStats = {};
                data.forEach(opp => {
                    const pair = `${opp.sourceCurrency}/${opp.destCurrency}`;
                    if (!pairStats[pair]) {
                        pairStats[pair] = { count: 0, profits: [] };
                    }
                    pairStats[pair].count++;
                    pairStats[pair].profits.push(opp.profitPercent);
                });

                const topPairs = Object.entries(pairStats)
                    .map(([pair, stats]) => ({
                        pair,
                        count: stats.count,
                        avgProfit: stats.profits.reduce((a, b) => a + b, 0) / stats.profits.length
                    }))
                    .sort((a, b) => b.avgProfit - a.avgProfit)
                    .slice(0, 20);

                let pairsHTML = '';
                topPairs.forEach(pair => {
                    pairsHTML += `
                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                            <td style="padding: 10px; color: #00d4ff; font-weight: bold;">${pair.pair}</td>
                            <td style="padding: 10px; text-align: right;">${pair.count}</td>
                            <td style="padding: 10px; text-align: right; color: #00ff88;">${pair.avgProfit.toFixed(2)}%</td>
                        </tr>
                    `;
                });
                document.getElementById('testScanBestPairsBody').innerHTML = pairsHTML || '<tr><td colspan="3" style="text-align: center; padding: 20px; color: #888;">No data yet...</td></tr>';

                // 4. Best Exchange Pairs
                const exchangePairStats = {};
                data.forEach(opp => {
                    const exchangePair = `${opp.sourceExchange} ‚Üí ${opp.destExchange}`;
                    if (!exchangePairStats[exchangePair]) {
                        exchangePairStats[exchangePair] = { count: 0, profits: [] };
                    }
                    exchangePairStats[exchangePair].count++;
                    exchangePairStats[exchangePair].profits.push(opp.profitPercent);
                });

                const topExchangePairs = Object.entries(exchangePairStats)
                    .map(([pair, stats]) => ({
                        pair,
                        count: stats.count,
                        avgProfit: stats.profits.reduce((a, b) => a + b, 0) / stats.profits.length
                    }))
                    .sort((a, b) => b.avgProfit - a.avgProfit)
                    .slice(0, 20);

                let exchangesHTML = '';
                topExchangePairs.forEach(pair => {
                    exchangesHTML += `
                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                            <td style="padding: 10px; color: #ffb347; font-weight: bold;">${pair.pair}</td>
                            <td style="padding: 10px; text-align: right;">${pair.count}</td>
                            <td style="padding: 10px; text-align: right; color: #00ff88;">${pair.avgProfit.toFixed(2)}%</td>
                        </tr>
                    `;
                });
                document.getElementById('testScanBestExchangesBody').innerHTML = exchangesHTML || '<tr><td colspan="3" style="text-align: center; padding: 20px; color: #888;">No data yet...</td></tr>';

            } catch (error) {
                console.error('Failed to update analytics:', error);
            }
        }

    </script>
</body>
</html>
