<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strategy API Configuration - ARB4ME</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2c3e50">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: white;
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            color: rgba(255,255,255,0.9);
            font-size: 1.1rem;
        }

        .back-button {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.3s;
            backdrop-filter: blur(10px);
        }

        .back-button:hover {
            background: rgba(255,255,255,0.3);
        }

        .strategy-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 5px;
            backdrop-filter: blur(10px);
        }

        .strategy-tab {
            flex: 1;
            padding: 15px 20px;
            background: transparent;
            border: none;
            color: rgba(255,255,255,0.8);
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.3s;
            font-size: 1rem;
            font-weight: 500;
        }

        .strategy-tab.active {
            background: rgba(255,255,255,0.2);
            color: white;
            transform: translateY(-2px);
        }

        .strategy-content {
            display: none;
        }

        .strategy-content.active {
            display: block;
        }

        .exchange-card {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
        }

        .exchange-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .exchange-name {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .connection-status {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .status-disconnected {
            background: #fee;
            color: #d32f2f;
        }

        .status-connected {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .status-connecting {
            background: #fff3cd;
            color: #856404;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #495057;
        }

        .form-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
            transform: translateY(-2px);
        }

        .info-panel {
            background: rgba(255,255,255,0.9);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .info-panel h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .info-panel p {
            color: #6c757d;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .benefits-list {
            list-style: none;
            padding-left: 0;
        }

        .benefits-list li {
            padding: 8px 0;
            padding-left: 25px;
            position: relative;
            color: #495057;
        }

        .benefits-list li:before {
            content: "✓";
            position: absolute;
            left: 0;
            color: #28a745;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .strategy-tabs {
                flex-direction: column;
            }

            .strategy-tab {
                margin-bottom: 5px;
            }

            .button-group {
                flex-direction: column;
            }

            .header h1 {
                font-size: 2rem;
            }

            .back-button {
                position: relative;
                top: 0;
                left: 0;
                margin-bottom: 20px;
            }
        }
    </style>
</head>
<body>
    <button class="back-button" onclick="window.close(); if(!window.closed) { window.location.href='/'; }">← Back to Dashboard</button>

    <div class="container">
        <div class="header">
            <h1>Strategy API Configuration</h1>
            <p>Configure dedicated API credentials for each trading strategy to enable parallel execution</p>

        </div>

        <div class="info-panel">
            <h3>Parallel Strategy Execution</h3>
            <p>By configuring separate API credentials for each trading strategy, you can run multiple arbitrage strategies simultaneously without hitting exchange rate limits.</p>
            <ul class="benefits-list">
                <li>Cross-Exchange Arbitrage: Independent API for cross-exchange opportunities</li>
                <li>Triangular Arbitrage: Dedicated API for triangular trading loops</li>
                <li>Transfer Arbitrage: Separate API for transfer-based opportunities</li>
                <li>Currency Swap Arbitrage: Independent API for currency swap strategies</li>
                <li>4x Rate Limit Capacity: 1200 req/min per strategy = 4800 req/min total</li>
            </ul>
        </div>

        <div class="strategy-tabs">
            <button class="strategy-tab active" onclick="switchStrategyTab('cross-exchange')">Cross-Exchange</button>
            <button class="strategy-tab" onclick="switchStrategyTab('triangular')">Triangular</button>
            <button class="strategy-tab" onclick="switchStrategyTab('transfer')">Transfer</button>
            <button class="strategy-tab" onclick="switchStrategyTab('currency-swap')">Currency Swap</button>
        </div>

        <!-- Cross-Exchange Strategy -->
        <div id="cross-exchange-content" class="strategy-content active">
            <form autocomplete="off" onsubmit="return false;">
            <div class="exchange-card">
                <div class="exchange-header">
                    <div class="exchange-name">ChainEX - Cross-Exchange Strategy</div>
                    <div id="chainex-cross-exchange-status" class="connection-status status-disconnected">Disconnected</div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="chainex-cross-api">API Key</label>
                    <input type="text" id="chainex-cross-exchange-api" class="form-input" placeholder="Enter ChainEX API Key" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" name="chainex-cross-api-key">
                </div>
                <div class="form-group">
                    <label class="form-label" for="chainex-cross-secret">Secret Key</label>
                    <input type="password" id="chainex-cross-exchange-secret" class="form-input" placeholder="Enter ChainEX Secret Key" autocomplete="new-password" autocorrect="off" autocapitalize="off" spellcheck="false" name="chainex-cross-secret-key">
                </div>
                <div class="form-group">
                    <label class="form-label">Balance</label>
                    <div id="chainex-cross-exchange-balance" style="padding: 12px; background: rgba(0,0,0,0.1); border-radius: 8px; font-family: monospace; color: #333;">$0.00</div>
                </div>
                <div class="button-group">
                    <button class="btn btn-primary" onclick="connectStrategyExchange('chainex', 'cross-exchange')">Connect</button>
                    <button class="btn btn-secondary" onclick="testStrategyConnection('chainex', 'cross-exchange')">Test Connection</button>
                    <button class="btn btn-danger" onclick="disconnectStrategyExchange('chainex', 'cross-exchange')">Disconnect</button>
                </div>
            </div>
            </form>

            <!-- VALR Cross-Exchange -->
            <form autocomplete="off" onsubmit="return false;">
            <div class="exchange-card">
                <div class="exchange-header">
                    <div class="exchange-name">VALR - Cross-Exchange Strategy</div>
                    <div id="valr-cross-exchange-status" class="connection-status status-disconnected">Disconnected</div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="valr-cross-exchange-api">API Key</label>
                    <input type="text" id="valr-cross-exchange-api" class="form-input" placeholder="Enter VALR API Key" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" name="valr-cross-api-key">
                </div>
                <div class="form-group">
                    <label class="form-label" for="valr-cross-exchange-secret">Secret Key</label>
                    <input type="password" id="valr-cross-exchange-secret" class="form-input" placeholder="Enter VALR Secret Key" autocomplete="new-password" autocorrect="off" autocapitalize="off" spellcheck="false" name="valr-cross-secret-key">
                </div>
                <div class="form-group">
                    <label class="form-label">Balance</label>
                    <div id="valr-cross-exchange-balance" style="padding: 12px; background: rgba(0,0,0,0.1); border-radius: 8px; font-family: monospace; color: #333;">$0.00</div>
                </div>
                <div class="button-group">
                    <button class="btn btn-primary" onclick="connectStrategyExchange('valr', 'cross-exchange')">Connect</button>
                    <button class="btn btn-secondary" onclick="testStrategyConnection('valr', 'cross-exchange')">Test Connection</button>
                    <button class="btn btn-danger" onclick="disconnectStrategyExchange('valr', 'cross-exchange')">Disconnect</button>
                </div>
            </div>
            </form>

            <!-- Luno Cross-Exchange -->
            <form autocomplete="off" onsubmit="return false;">
            <div class="exchange-card">
                <div class="exchange-header">
                    <div class="exchange-name">Luno - Cross-Exchange Strategy</div>
                    <div id="luno-cross-exchange-status" class="connection-status status-disconnected">Disconnected</div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="luno-cross-exchange-api">API Key</label>
                    <input type="text" id="luno-cross-exchange-api" class="form-input" placeholder="Enter Luno API Key" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" name="luno-cross-api-key">
                </div>
                <div class="form-group">
                    <label class="form-label" for="luno-cross-exchange-secret">Secret Key</label>
                    <input type="password" id="luno-cross-exchange-secret" class="form-input" placeholder="Enter Luno Secret Key" autocomplete="new-password" autocorrect="off" autocapitalize="off" spellcheck="false" name="luno-cross-secret-key">
                </div>
                <div class="form-group">
                    <label class="form-label">Balance</label>
                    <div id="luno-cross-exchange-balance" style="padding: 12px; background: rgba(0,0,0,0.1); border-radius: 8px; font-family: monospace; color: #333;">$0.00</div>
                </div>
                <div class="button-group">
                    <button class="btn btn-primary" onclick="connectStrategyExchange('luno', 'cross-exchange')">Connect</button>
                    <button class="btn btn-secondary" onclick="testStrategyConnection('luno', 'cross-exchange')">Test Connection</button>
                    <button class="btn btn-danger" onclick="disconnectStrategyExchange('luno', 'cross-exchange')">Disconnect</button>
                </div>
            </div>
            </form>

            <!-- Kraken Cross-Exchange -->
            <form autocomplete="off" onsubmit="return false;">
            <div class="exchange-card">
                <div class="exchange-header">
                    <div class="exchange-name">Kraken - Cross-Exchange Strategy</div>
                    <div id="kraken-cross-exchange-status" class="connection-status status-disconnected">Disconnected</div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="kraken-cross-exchange-api">API Key</label>
                    <input type="text" id="kraken-cross-exchange-api" class="form-input" placeholder="Enter Kraken API Key" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" name="kraken-cross-api-key">
                </div>
                <div class="form-group">
                    <label class="form-label" for="kraken-cross-exchange-secret">Secret Key</label>
                    <input type="password" id="kraken-cross-exchange-secret" class="form-input" placeholder="Enter Kraken Secret Key" autocomplete="new-password" autocorrect="off" autocapitalize="off" spellcheck="false" name="kraken-cross-secret-key">
                </div>
                <div class="form-group">
                    <label class="form-label">Balance</label>
                    <div id="kraken-cross-exchange-balance" style="padding: 12px; background: rgba(0,0,0,0.1); border-radius: 8px; font-family: monospace; color: #333;">$0.00</div>
                </div>
                <div class="button-group">
                    <button class="btn btn-primary" onclick="connectStrategyExchange('kraken', 'cross-exchange')">Connect</button>
                    <button class="btn btn-secondary" onclick="testStrategyConnection('kraken', 'cross-exchange')">Test Connection</button>
                    <button class="btn btn-danger" onclick="disconnectStrategyExchange('kraken', 'cross-exchange')">Disconnect</button>
                </div>
            </div>
            </form>

            <!-- Binance Cross Exchange -->
            <form autocomplete="off" onsubmit="return false;">
            <div class="exchange-card">
                <div class="exchange-header">
                    <div class="exchange-name">Binance - Cross Exchange Strategy</div>
                    <div id="binance-cross-exchange-status" class="connection-status status-disconnected">Disconnected</div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="binance-cross-exchange-api">API Key</label>
                    <input type="text" id="binance-cross-exchange-api" class="form-input" placeholder="Enter Binance API Key" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" name="binance-cross-api-key">
                </div>
                <div class="form-group">
                    <label class="form-label" for="binance-cross-exchange-secret">Secret Key</label>
                    <input type="password" id="binance-cross-exchange-secret" class="form-input" placeholder="Enter Binance Secret Key" autocomplete="new-password" autocorrect="off" autocapitalize="off" spellcheck="false" name="binance-cross-secret-key">
                </div>
                <div class="form-group">
                    <label class="form-label">Balance</label>
                    <div id="binance-cross-exchange-balance" style="padding: 12px; background: rgba(0,0,0,0.1); border-radius: 8px; font-family: monospace; color: #333;">$0.00</div>
                </div>
                <div class="button-group">
                    <button class="btn btn-primary" onclick="connectStrategyExchange('binance', 'cross-exchange')">Connect</button>
                    <button class="btn btn-secondary" onclick="testStrategyConnection('binance', 'cross-exchange')">Test Connection</button>
                    <button class="btn btn-danger" onclick="disconnectStrategyExchange('binance', 'cross-exchange')">Disconnect</button>
                </div>
            </div>
            </form>
        </div>

        <!-- Triangular Strategy -->
        <div id="triangular-content" class="strategy-content">
            <form autocomplete="off" onsubmit="return false;">
            <div class="exchange-card">
                <div class="exchange-header">
                    <div class="exchange-name">ChainEX - Triangular Strategy</div>
                    <div id="chainex-triangular-status" class="connection-status status-disconnected">Disconnected</div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="chainex-triangular-api">API Key</label>
                    <input type="text" id="chainex-triangular-api" class="form-input" placeholder="Enter ChainEX API Key" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" name="chainex-tri-api-key">
                </div>
                <div class="form-group">
                    <label class="form-label" for="chainex-triangular-secret">Secret Key</label>
                    <input type="password" id="chainex-triangular-secret" class="form-input" placeholder="Enter ChainEX Secret Key" autocomplete="new-password" autocorrect="off" autocapitalize="off" spellcheck="false" name="chainex-tri-secret-key">
                </div>
                <div class="form-group">
                    <label class="form-label">Balance</label>
                    <div id="chainex-triangular-balance" style="padding: 12px; background: rgba(0,0,0,0.1); border-radius: 8px; font-family: monospace; color: #333;">$0.00</div>
                </div>
                <div class="button-group">
                    <button class="btn btn-primary" onclick="connectStrategyExchange('chainex', 'triangular')">Connect</button>
                    <button class="btn btn-secondary" onclick="testStrategyConnection('chainex', 'triangular')">Test Connection</button>
                    <button class="btn btn-danger" onclick="disconnectStrategyExchange('chainex', 'triangular')">Disconnect</button>
                </div>
            </div>
            </form>

            <!-- VALR Triangular -->
            <form autocomplete="off" onsubmit="return false;">
            <div class="exchange-card">
                <div class="exchange-header">
                    <div class="exchange-name">VALR - Triangular Strategy</div>
                    <div id="valr-triangular-status" class="connection-status status-disconnected">Disconnected</div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="valr-triangular-api">API Key</label>
                    <input type="text" id="valr-triangular-api" class="form-input" placeholder="Enter VALR API Key" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" name="valr-tri-api-key">
                </div>
                <div class="form-group">
                    <label class="form-label" for="valr-triangular-secret">Secret Key</label>
                    <input type="password" id="valr-triangular-secret" class="form-input" placeholder="Enter VALR Secret Key" autocomplete="new-password" autocorrect="off" autocapitalize="off" spellcheck="false" name="valr-tri-secret-key">
                </div>
                <div class="form-group">
                    <label class="form-label">Balance</label>
                    <div id="valr-triangular-balance" style="padding: 12px; background: rgba(0,0,0,0.1); border-radius: 8px; font-family: monospace; color: #333;">$0.00</div>
                </div>
                <div class="button-group">
                    <button class="btn btn-primary" onclick="connectStrategyExchange('valr', 'triangular')">Connect</button>
                    <button class="btn btn-secondary" onclick="testStrategyConnection('valr', 'triangular')">Test Connection</button>
                    <button class="btn btn-danger" onclick="disconnectStrategyExchange('valr', 'triangular')">Disconnect</button>
                </div>
            </div>
            </form>

            <!-- Luno Triangular -->
            <form autocomplete="off" onsubmit="return false;">
            <div class="exchange-card">
                <div class="exchange-header">
                    <div class="exchange-name">Luno - Triangular Strategy</div>
                    <div id="luno-triangular-status" class="connection-status status-disconnected">Disconnected</div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="luno-triangular-api">API Key</label>
                    <input type="text" id="luno-triangular-api" class="form-input" placeholder="Enter Luno API Key" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" name="luno-tri-api-key">
                </div>
                <div class="form-group">
                    <label class="form-label" for="luno-triangular-secret">Secret Key</label>
                    <input type="password" id="luno-triangular-secret" class="form-input" placeholder="Enter Luno Secret Key" autocomplete="new-password" autocorrect="off" autocapitalize="off" spellcheck="false" name="luno-tri-secret-key">
                </div>
                <div class="form-group">
                    <label class="form-label">Balance</label>
                    <div id="luno-triangular-balance" style="padding: 12px; background: rgba(0,0,0,0.1); border-radius: 8px; font-family: monospace; color: #333;">$0.00</div>
                </div>
                <div class="button-group">
                    <button class="btn btn-primary" onclick="connectStrategyExchange('luno', 'triangular')">Connect</button>
                    <button class="btn btn-secondary" onclick="testStrategyConnection('luno', 'triangular')">Test Connection</button>
                    <button class="btn btn-danger" onclick="disconnectStrategyExchange('luno', 'triangular')">Disconnect</button>
                </div>
            </div>
            </form>

            <!-- Kraken Triangular -->
            <form autocomplete="off" onsubmit="return false;">
            <div class="exchange-card">
                <div class="exchange-header">
                    <div class="exchange-name">Kraken - Triangular Strategy</div>
                    <div id="kraken-triangular-status" class="connection-status status-disconnected">Disconnected</div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="kraken-triangular-api">API Key</label>
                    <input type="text" id="kraken-triangular-api" class="form-input" placeholder="Enter Kraken API Key" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" name="kraken-tri-api-key">
                </div>
                <div class="form-group">
                    <label class="form-label" for="kraken-triangular-secret">Secret Key</label>
                    <input type="password" id="kraken-triangular-secret" class="form-input" placeholder="Enter Kraken Secret Key" autocomplete="new-password" autocorrect="off" autocapitalize="off" spellcheck="false" name="kraken-tri-secret-key">
                </div>
                <div class="form-group">
                    <label class="form-label">Balance</label>
                    <div id="kraken-triangular-balance" style="padding: 12px; background: rgba(0,0,0,0.1); border-radius: 8px; font-family: monospace; color: #333;">$0.00</div>
                </div>
                <div class="button-group">
                    <button class="btn btn-primary" onclick="connectStrategyExchange('kraken', 'triangular')">Connect</button>
                    <button class="btn btn-secondary" onclick="testStrategyConnection('kraken', 'triangular')">Test Connection</button>
                    <button class="btn btn-danger" onclick="disconnectStrategyExchange('kraken', 'triangular')">Disconnect</button>
                </div>
            </div>
            </form>

            <!-- Binance Triangular -->
            <form autocomplete="off" onsubmit="return false;">
            <div class="exchange-card">
                <div class="exchange-header">
                    <div class="exchange-name">Binance - Triangular Strategy</div>
                    <div id="binance-triangular-status" class="connection-status status-disconnected">Disconnected</div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="binance-triangular-api">API Key</label>
                    <input type="text" id="binance-triangular-api" class="form-input" placeholder="Enter Binance API Key" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" name="binance-tri-api-key">
                </div>
                <div class="form-group">
                    <label class="form-label" for="binance-triangular-secret">Secret Key</label>
                    <input type="password" id="binance-triangular-secret" class="form-input" placeholder="Enter Binance Secret Key" autocomplete="new-password" autocorrect="off" autocapitalize="off" spellcheck="false" name="binance-tri-secret-key">
                </div>
                <div class="form-group">
                    <label class="form-label">Balance</label>
                    <div id="binance-triangular-balance" style="padding: 12px; background: rgba(0,0,0,0.1); border-radius: 8px; font-family: monospace; color: #333;">$0.00</div>
                </div>
                <div class="button-group">
                    <button class="btn btn-primary" onclick="connectStrategyExchange('binance', 'triangular')">Connect</button>
                    <button class="btn btn-secondary" onclick="testStrategyConnection('binance', 'triangular')">Test Connection</button>
                    <button class="btn btn-danger" onclick="disconnectStrategyExchange('binance', 'triangular')">Disconnect</button>
                </div>
            </div>
            </form>
        </div>

        <!-- Transfer Strategy -->
        <div id="transfer-content" class="strategy-content">
            <form autocomplete="off" onsubmit="return false;">
            <div class="exchange-card">
                <div class="exchange-header">
                    <div class="exchange-name">ChainEX - Transfer Strategy</div>
                    <div id="chainex-transfer-status" class="connection-status status-disconnected">Disconnected</div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="chainex-transfer-api">API Key</label>
                    <input type="text" id="chainex-transfer-api" class="form-input" placeholder="Enter ChainEX API Key" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" name="chainex-trans-api-key">
                </div>
                <div class="form-group">
                    <label class="form-label" for="chainex-transfer-secret">Secret Key</label>
                    <input type="password" id="chainex-transfer-secret" class="form-input" placeholder="Enter ChainEX Secret Key" autocomplete="new-password" autocorrect="off" autocapitalize="off" spellcheck="false" name="chainex-trans-secret-key">
                </div>
                <div class="form-group">
                    <label class="form-label">Balance</label>
                    <div id="chainex-transfer-balance" style="padding: 12px; background: rgba(0,0,0,0.1); border-radius: 8px; font-family: monospace; color: #333;">$0.00</div>
                </div>
                <div class="button-group">
                    <button class="btn btn-primary" onclick="connectStrategyExchange('chainex', 'transfer')">Connect</button>
                    <button class="btn btn-secondary" onclick="testStrategyConnection('chainex', 'transfer')">Test Connection</button>
                    <button class="btn btn-danger" onclick="disconnectStrategyExchange('chainex', 'transfer')">Disconnect</button>
                </div>
            </div>
            </form>

            <!-- VALR Transfer -->
            <form autocomplete="off" onsubmit="return false;">
            <div class="exchange-card">
                <div class="exchange-header">
                    <div class="exchange-name">VALR - Transfer Strategy</div>
                    <div id="valr-transfer-status" class="connection-status status-disconnected">Disconnected</div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="valr-transfer-api">API Key</label>
                    <input type="text" id="valr-transfer-api" class="form-input" placeholder="Enter VALR API Key" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" name="valr-trans-api-key">
                </div>
                <div class="form-group">
                    <label class="form-label" for="valr-transfer-secret">Secret Key</label>
                    <input type="password" id="valr-transfer-secret" class="form-input" placeholder="Enter VALR Secret Key" autocomplete="new-password" autocorrect="off" autocapitalize="off" spellcheck="false" name="valr-trans-secret-key">
                </div>
                <div class="form-group">
                    <label class="form-label">Balance</label>
                    <div id="valr-transfer-balance" style="padding: 12px; background: rgba(0,0,0,0.1); border-radius: 8px; font-family: monospace; color: #333;">$0.00</div>
                </div>
                <div class="button-group">
                    <button class="btn btn-primary" onclick="connectStrategyExchange('valr', 'transfer')">Connect</button>
                    <button class="btn btn-secondary" onclick="testStrategyConnection('valr', 'transfer')">Test Connection</button>
                    <button class="btn btn-danger" onclick="disconnectStrategyExchange('valr', 'transfer')">Disconnect</button>
                </div>
            </div>
            </form>

            <!-- Luno Transfer -->
            <form autocomplete="off" onsubmit="return false;">
            <div class="exchange-card">
                <div class="exchange-header">
                    <div class="exchange-name">Luno - Transfer Strategy</div>
                    <div id="luno-transfer-status" class="connection-status status-disconnected">Disconnected</div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="luno-transfer-api">API Key</label>
                    <input type="text" id="luno-transfer-api" class="form-input" placeholder="Enter Luno API Key" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" name="luno-trans-api-key">
                </div>
                <div class="form-group">
                    <label class="form-label" for="luno-transfer-secret">Secret Key</label>
                    <input type="password" id="luno-transfer-secret" class="form-input" placeholder="Enter Luno Secret Key" autocomplete="new-password" autocorrect="off" autocapitalize="off" spellcheck="false" name="luno-trans-secret-key">
                </div>
                <div class="form-group">
                    <label class="form-label">Balance</label>
                    <div id="luno-transfer-balance" style="padding: 12px; background: rgba(0,0,0,0.1); border-radius: 8px; font-family: monospace; color: #333;">$0.00</div>
                </div>
                <div class="button-group">
                    <button class="btn btn-primary" onclick="connectStrategyExchange('luno', 'transfer')">Connect</button>
                    <button class="btn btn-secondary" onclick="testStrategyConnection('luno', 'transfer')">Test Connection</button>
                    <button class="btn btn-danger" onclick="disconnectStrategyExchange('luno', 'transfer')">Disconnect</button>
                </div>
            </div>
            </form>

            <!-- Kraken Transfer -->
            <form autocomplete="off" onsubmit="return false;">
            <div class="exchange-card">
                <div class="exchange-header">
                    <div class="exchange-name">Kraken - Transfer Strategy</div>
                    <div id="kraken-transfer-status" class="connection-status status-disconnected">Disconnected</div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="kraken-transfer-api">API Key</label>
                    <input type="text" id="kraken-transfer-api" class="form-input" placeholder="Enter Kraken API Key" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" name="kraken-trans-api-key">
                </div>
                <div class="form-group">
                    <label class="form-label" for="kraken-transfer-secret">Secret Key</label>
                    <input type="password" id="kraken-transfer-secret" class="form-input" placeholder="Enter Kraken Secret Key" autocomplete="new-password" autocorrect="off" autocapitalize="off" spellcheck="false" name="kraken-trans-secret-key">
                </div>
                <div class="form-group">
                    <label class="form-label">Balance</label>
                    <div id="kraken-transfer-balance" style="padding: 12px; background: rgba(0,0,0,0.1); border-radius: 8px; font-family: monospace; color: #333;">$0.00</div>
                </div>
                <div class="button-group">
                    <button class="btn btn-primary" onclick="connectStrategyExchange('kraken', 'transfer')">Connect</button>
                    <button class="btn btn-secondary" onclick="testStrategyConnection('kraken', 'transfer')">Test Connection</button>
                    <button class="btn btn-danger" onclick="disconnectStrategyExchange('kraken', 'transfer')">Disconnect</button>
                </div>
            </div>
            </form>

            <!-- Binance Transfer -->
            <form autocomplete="off" onsubmit="return false;">
            <div class="exchange-card">
                <div class="exchange-header">
                    <div class="exchange-name">Binance - Transfer Strategy</div>
                    <div id="binance-transfer-status" class="connection-status status-disconnected">Disconnected</div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="binance-transfer-api">API Key</label>
                    <input type="text" id="binance-transfer-api" class="form-input" placeholder="Enter Binance API Key" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" name="binance-trans-api-key">
                </div>
                <div class="form-group">
                    <label class="form-label" for="binance-transfer-secret">Secret Key</label>
                    <input type="password" id="binance-transfer-secret" class="form-input" placeholder="Enter Binance Secret Key" autocomplete="new-password" autocorrect="off" autocapitalize="off" spellcheck="false" name="binance-trans-secret-key">
                </div>
                <div class="form-group">
                    <label class="form-label">Balance</label>
                    <div id="binance-transfer-balance" style="padding: 12px; background: rgba(0,0,0,0.1); border-radius: 8px; font-family: monospace; color: #333;">$0.00</div>
                </div>
                <div class="button-group">
                    <button class="btn btn-primary" onclick="connectStrategyExchange('binance', 'transfer')">Connect</button>
                    <button class="btn btn-secondary" onclick="testStrategyConnection('binance', 'transfer')">Test Connection</button>
                    <button class="btn btn-danger" onclick="disconnectStrategyExchange('binance', 'transfer')">Disconnect</button>
                </div>
            </div>
            </form>
        </div>

        <!-- Currency Swap Strategy -->
        <div id="currency-swap-content" class="strategy-content">
            <form autocomplete="off" onsubmit="return false;">
            <div class="exchange-card">
                <div class="exchange-header">
                    <div class="exchange-name">ChainEX - Currency Swap Strategy</div>
                    <div id="chainex-currency-swap-status" class="connection-status status-disconnected">Disconnected</div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="chainex-swap-api">API Key</label>
                    <input type="text" id="chainex-currency-swap-api" class="form-input" placeholder="Enter ChainEX API Key" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" name="chainex-swap-api-key">
                </div>
                <div class="form-group">
                    <label class="form-label" for="chainex-swap-secret">Secret Key</label>
                    <input type="password" id="chainex-currency-swap-secret" class="form-input" placeholder="Enter ChainEX Secret Key" autocomplete="new-password" autocorrect="off" autocapitalize="off" spellcheck="false" name="chainex-swap-secret-key">
                </div>
                <div class="form-group">
                    <label class="form-label">Balance</label>
                    <div id="chainex-currency-swap-balance" style="padding: 12px; background: rgba(0,0,0,0.1); border-radius: 8px; font-family: monospace; color: #333;">$0.00</div>
                </div>
                <div class="button-group">
                    <button class="btn btn-primary" onclick="connectStrategyExchange('chainex', 'currency-swap')">Connect</button>
                    <button class="btn btn-secondary" onclick="testStrategyConnection('chainex', 'currency-swap')">Test Connection</button>
                    <button class="btn btn-danger" onclick="disconnectStrategyExchange('chainex', 'currency-swap')">Disconnect</button>
                </div>
            </div>
            </form>

            <!-- VALR Currency Swap -->
            <form autocomplete="off" onsubmit="return false;">
            <div class="exchange-card">
                <div class="exchange-header">
                    <div class="exchange-name">VALR - Currency Swap Strategy</div>
                    <div id="valr-currency-swap-status" class="connection-status status-disconnected">Disconnected</div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="valr-currency-swap-api">API Key</label>
                    <input type="text" id="valr-currency-swap-api" class="form-input" placeholder="Enter VALR API Key" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" name="valr-swap-api-key">
                </div>
                <div class="form-group">
                    <label class="form-label" for="valr-currency-swap-secret">Secret Key</label>
                    <input type="password" id="valr-currency-swap-secret" class="form-input" placeholder="Enter VALR Secret Key" autocomplete="new-password" autocorrect="off" autocapitalize="off" spellcheck="false" name="valr-swap-secret-key">
                </div>
                <div class="form-group">
                    <label class="form-label">Balance</label>
                    <div id="valr-currency-swap-balance" style="padding: 12px; background: rgba(0,0,0,0.1); border-radius: 8px; font-family: monospace; color: #333;">$0.00</div>
                </div>
                <div class="button-group">
                    <button class="btn btn-primary" onclick="connectStrategyExchange('valr', 'currency-swap')">Connect</button>
                    <button class="btn btn-secondary" onclick="testStrategyConnection('valr', 'currency-swap')">Test Connection</button>
                    <button class="btn btn-danger" onclick="disconnectStrategyExchange('valr', 'currency-swap')">Disconnect</button>
                </div>
            </div>
            </form>

            <!-- Luno Currency Swap -->
            <form autocomplete="off" onsubmit="return false;">
            <div class="exchange-card">
                <div class="exchange-header">
                    <div class="exchange-name">Luno - Currency Swap Strategy</div>
                    <div id="luno-currency-swap-status" class="connection-status status-disconnected">Disconnected</div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="luno-currency-swap-api">API Key</label>
                    <input type="text" id="luno-currency-swap-api" class="form-input" placeholder="Enter Luno API Key" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" name="luno-swap-api-key">
                </div>
                <div class="form-group">
                    <label class="form-label" for="luno-currency-swap-secret">Secret Key</label>
                    <input type="password" id="luno-currency-swap-secret" class="form-input" placeholder="Enter Luno Secret Key" autocomplete="new-password" autocorrect="off" autocapitalize="off" spellcheck="false" name="luno-swap-secret-key">
                </div>
                <div class="form-group">
                    <label class="form-label">Balance</label>
                    <div id="luno-currency-swap-balance" style="padding: 12px; background: rgba(0,0,0,0.1); border-radius: 8px; font-family: monospace; color: #333;">$0.00</div>
                </div>
                <div class="button-group">
                    <button class="btn btn-primary" onclick="connectStrategyExchange('luno', 'currency-swap')">Connect</button>
                    <button class="btn btn-secondary" onclick="testStrategyConnection('luno', 'currency-swap')">Test Connection</button>
                    <button class="btn btn-danger" onclick="disconnectStrategyExchange('luno', 'currency-swap')">Disconnect</button>
                </div>
            </div>
            </form>

            <!-- Kraken Currency Swap -->
            <form autocomplete="off" onsubmit="return false;">
            <div class="exchange-card">
                <div class="exchange-header">
                    <div class="exchange-name">Kraken - Currency Swap Strategy</div>
                    <div id="kraken-currency-swap-status" class="connection-status status-disconnected">Disconnected</div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="kraken-currency-swap-api">API Key</label>
                    <input type="text" id="kraken-currency-swap-api" class="form-input" placeholder="Enter Kraken API Key" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" name="kraken-swap-api-key">
                </div>
                <div class="form-group">
                    <label class="form-label" for="kraken-currency-swap-secret">Secret Key</label>
                    <input type="password" id="kraken-currency-swap-secret" class="form-input" placeholder="Enter Kraken Secret Key" autocomplete="new-password" autocorrect="off" autocapitalize="off" spellcheck="false" name="kraken-swap-secret-key">
                </div>
                <div class="form-group">
                    <label class="form-label">Balance</label>
                    <div id="kraken-currency-swap-balance" style="padding: 12px; background: rgba(0,0,0,0.1); border-radius: 8px; font-family: monospace; color: #333;">$0.00</div>
                </div>
                <div class="button-group">
                    <button class="btn btn-primary" onclick="connectStrategyExchange('kraken', 'currency-swap')">Connect</button>
                    <button class="btn btn-secondary" onclick="testStrategyConnection('kraken', 'currency-swap')">Test Connection</button>
                    <button class="btn btn-danger" onclick="disconnectStrategyExchange('kraken', 'currency-swap')">Disconnect</button>
                </div>
            </div>
            </form>

            <!-- Binance Currency Swap -->
            <form autocomplete="off" onsubmit="return false;">
            <div class="exchange-card">
                <div class="exchange-header">
                    <div class="exchange-name">Binance - Currency Swap Strategy</div>
                    <div id="binance-currency-swap-status" class="connection-status status-disconnected">Disconnected</div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="binance-currency-swap-api">API Key</label>
                    <input type="text" id="binance-currency-swap-api" class="form-input" placeholder="Enter Binance API Key" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" name="binance-swap-api-key">
                </div>
                <div class="form-group">
                    <label class="form-label" for="binance-currency-swap-secret">Secret Key</label>
                    <input type="password" id="binance-currency-swap-secret" class="form-input" placeholder="Enter Binance Secret Key" autocomplete="new-password" autocorrect="off" autocapitalize="off" spellcheck="false" name="binance-swap-secret-key">
                </div>
                <div class="form-group">
                    <label class="form-label">Balance</label>
                    <div id="binance-currency-swap-balance" style="padding: 12px; background: rgba(0,0,0,0.1); border-radius: 8px; font-family: monospace; color: #333;">$0.00</div>
                </div>
                <div class="button-group">
                    <button class="btn btn-primary" onclick="connectStrategyExchange('binance', 'currency-swap')">Connect</button>
                    <button class="btn btn-secondary" onclick="testStrategyConnection('binance', 'currency-swap')">Test Connection</button>
                    <button class="btn btn-danger" onclick="disconnectStrategyExchange('binance', 'currency-swap')">Disconnect</button>
                </div>
            </div>
            </form>
        </div>
    </div>

    <script>
        // Initialize strategy-specific state
        if (!window.strategyExchanges) {
            window.strategyExchanges = {
                'chainex-cross-exchange': { connected: false, balance: null },
                'chainex-triangular': { connected: false, balance: null },
                'chainex-transfer': { connected: false, balance: null },
                'chainex-currency-swap': { connected: false, balance: null },
                'valr-cross-exchange': { connected: false, balance: null },
                'valr-triangular': { connected: false, balance: null },
                'valr-transfer': { connected: false, balance: null },
                'valr-currency-swap': { connected: false, balance: null },
                'luno-cross-exchange': { connected: false, balance: null },
                'luno-triangular': { connected: false, balance: null },
                'luno-transfer': { connected: false, balance: null },
                'luno-currency-swap': { connected: false, balance: null },
                'kraken-cross-exchange': { connected: false, balance: null },
                'kraken-triangular': { connected: false, balance: null },
                'kraken-transfer': { connected: false, balance: null },
                'kraken-currency-swap': { connected: false, balance: null },
                'binance-cross-exchange': { connected: false, balance: null },
                'binance-triangular': { connected: false, balance: null },
                'binance-transfer': { connected: false, balance: null },
                'binance-currency-swap': { connected: false, balance: null }
            };
        }

        // Format balance display function (similar to original implementation)
        function formatStrategyBalance(balances) {
            if (!balances || typeof balances !== 'object') {
                return '$0.00';
            }

            // Get major currencies for display
            const majorCurrencies = ['USDT', 'BTC', 'ETH', 'BNB', 'ADA', 'DOT', 'SOL'];
            let displayParts = [];
            let totalUSDValue = 0;

            // Show USDT first if available
            if (balances.USDT && parseFloat(balances.USDT) > 0) {
                const usdtAmount = parseFloat(balances.USDT);
                displayParts.push(`$${usdtAmount.toFixed(2)} USDT`);
                totalUSDValue += usdtAmount;
            }

            // Show other major currencies
            majorCurrencies.slice(1).forEach(currency => {
                if (balances[currency] && parseFloat(balances[currency]) > 0.001) {
                    const amount = parseFloat(balances[currency]);
                    displayParts.push(`${amount.toFixed(4)} ${currency}`);
                }
            });

            // If no major currencies, show first available currency
            if (displayParts.length === 0) {
                const firstCurrency = Object.keys(balances).find(key => parseFloat(balances[key]) > 0);
                if (firstCurrency) {
                    const amount = parseFloat(balances[firstCurrency]);
                    displayParts.push(`${amount.toFixed(4)} ${firstCurrency}`);
                }
            }

            // Limit display to first 3 currencies
            if (displayParts.length > 3) {
                const extra = displayParts.length - 3;
                displayParts = displayParts.slice(0, 3);
                displayParts.push(`+${extra} more`);
            }

            return displayParts.length > 0 ? displayParts.join(' • ') : '$0.00';
        }

        // Fetch balance for a specific strategy
        async function fetchStrategyBalance(exchange, strategy, apiKey, secretKey) {
            try {
                // Use the appropriate endpoint for each exchange
                const endpoint = exchange === 'chainex'
                    ? '/api/v1/trading/chainex/balance'
                    : `/api/v1/trading/${exchange}/balance`;

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        apiKey: apiKey,
                        apiSecret: secretKey
                    })
                });

                if (response.ok) {
                    const balanceData = await response.json();
                    if (balanceData.success && balanceData.balances) {
                        const balanceDisplay = formatStrategyBalance(balanceData.balances);
                        const balanceElement = document.getElementById(`${exchange}-${strategy}-balance`);
                        if (balanceElement) {
                            balanceElement.innerHTML = balanceDisplay;
                        }

                        // Update state
                        if (window.strategyExchanges[`${exchange}-${strategy}`]) {
                            window.strategyExchanges[`${exchange}-${strategy}`].balance = balanceData.balances;
                        }
                    }
                } else {
                    console.error('Failed to fetch balance:', response.status);
                }
            } catch (error) {
                console.error('Error fetching strategy balance:', error);
            }
        }

        // Tab switching functionality
        function switchStrategyTab(strategy) {
            // Remove active class from all tabs and contents
            document.querySelectorAll('.strategy-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.strategy-content').forEach(content => content.classList.remove('active'));

            // Add active class to selected tab and content
            event.target.classList.add('active');
            document.getElementById(strategy + '-content').classList.add('active');
        }

        // Connect strategy-specific exchange
        async function connectStrategyExchange(exchange, strategy) {
            const apiKey = document.getElementById(`${exchange}-${strategy}-api`).value;
            const secretKey = document.getElementById(`${exchange}-${strategy}-secret`).value;

            if (!apiKey || !secretKey) {
                alert('Please enter both API key and Secret key');
                return;
            }

            const statusElement = document.getElementById(`${exchange}-${strategy}-status`);
            if (statusElement) {
                statusElement.textContent = 'Connecting...';
                statusElement.className = 'connection-status status-connecting';
            }

            try {
                // Test connection by fetching balance directly (like original setup)
                const balanceEndpoint = exchange === 'chainex'
                    ? '/api/v1/trading/chainex/balance'
                    : `/api/v1/trading/${exchange}/balance`;

                const response = await fetch(balanceEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        apiKey: apiKey,
                        apiSecret: secretKey
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // Store credentials in localStorage with strategy prefix
                    localStorage.setItem(`${exchange}_${strategy}_api`, apiKey);
                    localStorage.setItem(`${exchange}_${strategy}_secret`, secretKey);
                    localStorage.setItem(`${exchange}_${strategy}_connected`, 'true');

                    // MIGRATION: Also store in original format for dashboard compatibility (only for first strategy)
                    if (strategy === 'cross-exchange') {
                        if (exchange === 'chainex') {
                            localStorage.setItem('chainexApiKey', apiKey);
                            localStorage.setItem('chainexSecretKey', secretKey);
                        } else if (exchange === 'valr') {
                            localStorage.setItem('valrApiKey', apiKey);
                            localStorage.setItem('valrSecretKey', secretKey);
                        } else if (exchange === 'luno') {
                            localStorage.setItem('lunoApiKey', apiKey);
                            localStorage.setItem('lunoSecretKey', secretKey);
                        } else if (exchange === 'kraken') {
                            localStorage.setItem('krakenApiKey', apiKey);
                            localStorage.setItem('krakenSecretKey', secretKey);
                        } else if (exchange === 'binance') {
                            localStorage.setItem('binanceApiKey', apiKey);
                            localStorage.setItem('binanceSecretKey', secretKey);
                        }
                    }

                    // Get balances from the response (balance endpoint returns data directly)
                    const balances = result.data?.balances || result.balances || result.data || result;

                    // Update strategy-specific state
                    window.strategyExchanges[`${exchange}-${strategy}`] = {
                        connected: true,
                        balance: balances
                    };

                    // MIGRATION: Update main dashboard state (accessing parent window)
                    if (window.opener && window.opener.state && strategy === 'cross-exchange') {
                        window.opener.state.exchanges[exchange] = {
                            connected: true,
                            api: {
                                key: apiKey,
                                secret: secretKey
                            }
                        };
                        // Save the state in parent window
                        if (window.opener.saveToStorage) {
                            window.opener.saveToStorage();
                        }
                    }

                    if (statusElement) {
                        statusElement.textContent = 'Connected';
                        statusElement.className = 'connection-status status-connected';
                    }

                    // Display balance (already fetched in connection test)
                    if (balances) {
                        // Format balance display like the original implementation
                        const balanceDisplay = formatStrategyBalance(balances);
                        const balanceElement = document.getElementById(`${exchange}-${strategy}-balance`);
                        if (balanceElement) {
                            balanceElement.innerHTML = balanceDisplay;
                        }

                        // MIGRATION: Update main dashboard balance and state
                        if (window.opener && strategy === 'cross-exchange') {
                            if (window.opener.state && window.opener.state.balances) {
                                window.opener.state.balances[exchange] = balances;
                            }

                            // Update dashboard balance display
                            let balanceElementId, statusElementId, priceStatusElementId;
                            if (exchange === 'chainex') {
                                balanceElementId = 'chainexBalance';
                                statusElementId = 'chainexStatus';
                                priceStatusElementId = 'chainexPriceStatus';
                            } else if (exchange === 'valr') {
                                balanceElementId = 'valrBalance';
                                statusElementId = 'valrStatus';
                                priceStatusElementId = 'valrPriceStatus';
                            } else if (exchange === 'luno') {
                                balanceElementId = 'lunoBalance';
                                statusElementId = 'lunoStatus';
                                priceStatusElementId = 'lunoPriceStatus';
                            } else if (exchange === 'kraken') {
                                balanceElementId = 'krakenBalance';
                                statusElementId = 'krakenStatus';
                                priceStatusElementId = 'krakenPriceStatus';
                            } else if (exchange === 'binance') {
                                balanceElementId = 'binanceBalance';
                                statusElementId = 'binanceStatus';
                                priceStatusElementId = 'binancePriceStatus';
                            }

                                    const dashboardBalanceElement = window.opener.document.getElementById(balanceElementId);
                                    if (dashboardBalanceElement && window.opener.formatMultiCurrencyBalance) {
                                        const dashboardBalanceDisplay = window.opener.formatMultiCurrencyBalance(balances, exchange);
                                        dashboardBalanceElement.textContent = dashboardBalanceDisplay;
                                    }

                                    // Update dashboard status
                                    const dashboardStatusElement = window.opener.document.getElementById(statusElementId);
                                    if (dashboardStatusElement) {
                                        dashboardStatusElement.textContent = 'Connected (Live)';
                                        dashboardStatusElement.className = 'status-connected';
                                    }

                                    // Update price status
                                    const priceStatusElement = window.opener.document.getElementById(priceStatusElementId);
                                    if (priceStatusElement) {
                                        priceStatusElement.textContent = 'LIVE';
                                        priceStatusElement.className = 'price-status price-live';
                                    }
                                }
                            }
                        }

                    alert(`${exchange.toUpperCase()} ${strategy} strategy connected successfully!`);
                } else {
                    throw new Error(result.error?.message || 'Connection failed');
                }
            } catch (error) {
                console.error('Connection error:', error);
                if (statusElement) {
                    statusElement.textContent = 'Disconnected';
                    statusElement.className = 'connection-status status-disconnected';
                }
                alert(`Connection failed: ${error.message}`);
            }
        }

        // Test strategy connection
        async function testStrategyConnection(exchange, strategy) {
            const apiKey = document.getElementById(`${exchange}-${strategy}-api`).value;
            const secretKey = document.getElementById(`${exchange}-${strategy}-secret`).value;

            if (!apiKey || !secretKey) {
                alert('Please enter both API key and Secret key');
                return;
            }

            try {
                const response = await fetch('/api/v1/trading/test-connection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        exchange: exchange,
                        strategy: strategy,
                        apiKey: apiKey,
                        secretKey: secretKey
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert(`${exchange.toUpperCase()} ${strategy} connection test successful!`);
                } else {
                    throw new Error(result.error?.message || 'Test failed');
                }
            } catch (error) {
                console.error('Test error:', error);
                alert(`Connection test failed: ${error.message}`);
            }
        }

        // Disconnect strategy exchange
        function disconnectStrategyExchange(exchange, strategy) {
            console.log(`🔌 Disconnecting ${exchange} ${strategy}`);

            // Only clear connection status, keep API credentials for easy reconnection
            localStorage.removeItem(`${exchange}_${strategy}_connected`);

            console.log(`🗑️ Cleared connection status for ${exchange} ${strategy} (kept credentials)`);

            // MIGRATION: Also clear original format connection (only if this was the primary strategy)
            if (strategy === 'cross-exchange') {
                // Don't clear the credentials, just mark as disconnected
                console.log(`🔌 Kept original format credentials for dashboard compatibility`);
            }

            // DON'T clear form fields - keep API credentials visible for easy reconnection
            // This matches the behavior of the original setup page
            console.log(`💾 Keeping API credentials in form fields for easy reconnection`);

            // Update strategy state
            window.strategyExchanges[`${exchange}-${strategy}`] = {
                connected: false,
                balance: null
            };

            // MIGRATION: Update main dashboard state (only for cross-exchange strategy)
            if (strategy === 'cross-exchange' && window.opener) {
                if (window.opener.state && window.opener.state.exchanges) {
                    // Keep API credentials but mark as disconnected
                    const currentApi = window.opener.state.exchanges[exchange]?.api;
                    window.opener.state.exchanges[exchange] = {
                        connected: false,
                        api: currentApi // Keep the API credentials
                    };
                    if (window.opener.state.balances) {
                        window.opener.state.balances[exchange] = {};
                    }
                    // Save the state in parent window
                    if (window.opener.saveToStorage) {
                        window.opener.saveToStorage();
                    }
                }

                // Update dashboard UI
                let balanceElementId, statusElementId, priceStatusElementId;
                if (exchange === 'chainex') {
                    balanceElementId = 'chainexBalance';
                    statusElementId = 'chainexStatus';
                    priceStatusElementId = 'chainexPriceStatus';
                } else if (exchange === 'valr') {
                    balanceElementId = 'valrBalance';
                    statusElementId = 'valrStatus';
                    priceStatusElementId = 'valrPriceStatus';
                } else if (exchange === 'luno') {
                    balanceElementId = 'lunoBalance';
                    statusElementId = 'lunoStatus';
                    priceStatusElementId = 'lunoPriceStatus';
                } else if (exchange === 'kraken') {
                    balanceElementId = 'krakenBalance';
                    statusElementId = 'krakenStatus';
                    priceStatusElementId = 'krakenPriceStatus';
                }

                const dashboardStatusElement = window.opener.document.getElementById(statusElementId);
                if (dashboardStatusElement) {
                    dashboardStatusElement.textContent = 'Disconnected';
                    dashboardStatusElement.className = 'status-disconnected';
                }

                // Update dashboard balance
                const dashboardBalanceElement = window.opener.document.getElementById(balanceElementId);
                if (dashboardBalanceElement) {
                    dashboardBalanceElement.textContent = '$0.00';
                }

                // Update price status
                const priceStatusElement = window.opener.document.getElementById(priceStatusElementId);
                if (priceStatusElement) {
                    priceStatusElement.textContent = 'OFFLINE';
                    priceStatusElement.className = 'price-status price-disconnected';
                }
            }

            // Update local status
            const statusElement = document.getElementById(`${exchange}-${strategy}-status`);
            if (statusElement) {
                statusElement.textContent = 'Disconnected';
                statusElement.className = 'connection-status status-disconnected';
            }

            // Clear balance display
            const balanceElement = document.getElementById(`${exchange}-${strategy}-balance`);
            if (balanceElement) {
                balanceElement.textContent = '$0.00';
            }

            alert(`${exchange.toUpperCase()} ${strategy} strategy disconnected`);
        }

        // Exact copy of original handleApiKeyInput function for 100% compatibility
        function handleApiKeyInput(event) {
            const fieldId = event.target.id;
            const value = event.target.value.trim();

            // Extract exchange name and field type from input ID (original logic)
            let exchange, fieldType;

            if (fieldId.includes('Api')) {
                fieldType = 'api';
                exchange = fieldId.replace('ApiKey', '').replace('Api', '');
            } else if (fieldId.includes('Secret')) {
                fieldType = 'secret';
                exchange = fieldId.replace('SecretKey', '').replace('Secret', '');
            } else if (fieldId.includes('Passphrase')) {
                fieldType = 'passphrase';
                exchange = fieldId.replace('Passphrase', '');
            }

            // For strategy-specific fields, extract strategy from field ID
            let strategy = null;
            if (fieldId.includes('cross-exchange')) {
                strategy = 'cross-exchange';
                fieldType = fieldId.includes('-api') ? 'api' : 'secret';
                // Determine exchange from field ID
                if (fieldId.includes('chainex')) {
                    exchange = 'chainex';
                } else if (fieldId.includes('valr')) {
                    exchange = 'valr';
                } else if (fieldId.includes('luno')) {
                    exchange = 'luno';
                } else if (fieldId.includes('kraken')) {
                    exchange = 'kraken';
                } else if (fieldId.includes('binance')) {
                    exchange = 'binance';
                }
            } else if (fieldId.includes('triangular')) {
                strategy = 'triangular';
                fieldType = fieldId.includes('-api') ? 'api' : 'secret';
                if (fieldId.includes('chainex')) {
                    exchange = 'chainex';
                } else if (fieldId.includes('valr')) {
                    exchange = 'valr';
                } else if (fieldId.includes('luno')) {
                    exchange = 'luno';
                } else if (fieldId.includes('kraken')) {
                    exchange = 'kraken';
                } else if (fieldId.includes('binance')) {
                    exchange = 'binance';
                }
            } else if (fieldId.includes('transfer')) {
                strategy = 'transfer';
                fieldType = fieldId.includes('-api') ? 'api' : 'secret';
                if (fieldId.includes('chainex')) {
                    exchange = 'chainex';
                } else if (fieldId.includes('valr')) {
                    exchange = 'valr';
                } else if (fieldId.includes('luno')) {
                    exchange = 'luno';
                } else if (fieldId.includes('kraken')) {
                    exchange = 'kraken';
                } else if (fieldId.includes('binance')) {
                    exchange = 'binance';
                }
            } else if (fieldId.includes('currency-swap')) {
                strategy = 'currency-swap';
                fieldType = fieldId.includes('-api') ? 'api' : 'secret';
                if (fieldId.includes('chainex')) {
                    exchange = 'chainex';
                } else if (fieldId.includes('valr')) {
                    exchange = 'valr';
                } else if (fieldId.includes('luno')) {
                    exchange = 'luno';
                } else if (fieldId.includes('kraken')) {
                    exchange = 'kraken';
                } else if (fieldId.includes('binance')) {
                    exchange = 'binance';
                }
            }

            if (exchange && fieldType) {
                // Strategy-specific storage
                if (strategy) {
                    const storageKey = `${exchange}_${strategy}_${fieldType}`;
                    localStorage.setItem(storageKey, value);
                    console.log(`💾 Stored strategy-specific: ${storageKey} = ${value.substring(0, 10)}...`);

                    // Also store in original format for dashboard compatibility (cross-exchange only)
                    if (strategy === 'cross-exchange') {
                        if (exchange === 'chainex') {
                            const originalKey = fieldType === 'api' ? 'chainexApiKey' : 'chainexSecretKey';
                            localStorage.setItem(originalKey, value);
                            console.log(`💾 Stored original format: ${originalKey} = ${value.substring(0, 10)}...`);
                        } else if (exchange === 'valr') {
                            const originalKey = fieldType === 'api' ? 'valrApiKey' : 'valrSecretKey';
                            localStorage.setItem(originalKey, value);
                            console.log(`💾 Stored original format: ${originalKey} = ${value.substring(0, 10)}...`);
                        } else if (exchange === 'luno') {
                            const originalKey = fieldType === 'api' ? 'lunoApiKey' : 'lunoSecretKey';
                            localStorage.setItem(originalKey, value);
                            console.log(`💾 Stored original format: ${originalKey} = ${value.substring(0, 10)}...`);
                        } else if (exchange === 'kraken') {
                            const originalKey = fieldType === 'api' ? 'krakenApiKey' : 'krakenSecretKey';
                            localStorage.setItem(originalKey, value);
                            console.log(`💾 Stored original format: ${originalKey} = ${value.substring(0, 10)}...`);
                        }
                    }
                } else {
                    // Original format storage
                    const storageKey = fieldType === 'api' ? `${exchange}ApiKey` :
                                    fieldType === 'secret' ? `${exchange}SecretKey` :
                                    `${exchange}Passphrase`;
                    localStorage.setItem(storageKey, value);
                    console.log(`💾 Stored original: ${storageKey} = ${value.substring(0, 10)}...`);
                }
            }
        }

        // Setup auto-save using exact original mechanism
        function setupAutoSave() {
            const apiKeyFields = [
                'chainex-cross-exchange-api', 'chainex-cross-exchange-secret',
                'chainex-triangular-api', 'chainex-triangular-secret',
                'chainex-transfer-api', 'chainex-transfer-secret',
                'chainex-currency-swap-api', 'chainex-currency-swap-secret',
                'valr-cross-exchange-api', 'valr-cross-exchange-secret',
                'valr-triangular-api', 'valr-triangular-secret',
                'valr-transfer-api', 'valr-transfer-secret',
                'valr-currency-swap-api', 'valr-currency-swap-secret',
                'luno-cross-exchange-api', 'luno-cross-exchange-secret',
                'luno-triangular-api', 'luno-triangular-secret',
                'luno-transfer-api', 'luno-transfer-secret',
                'luno-currency-swap-api', 'luno-currency-swap-secret',
                'kraken-cross-exchange-api', 'kraken-cross-exchange-secret',
                'kraken-triangular-api', 'kraken-triangular-secret',
                'kraken-transfer-api', 'kraken-transfer-secret',
                'kraken-currency-swap-api', 'kraken-currency-swap-secret',
                'binance-cross-exchange-api', 'binance-cross-exchange-secret',
                'binance-triangular-api', 'binance-triangular-secret',
                'binance-transfer-api', 'binance-transfer-secret',
                'binance-currency-swap-api', 'binance-currency-swap-secret'
            ];

            apiKeyFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    // Add both 'input' and 'change' event listeners for immediate and on-blur saving
                    field.addEventListener('input', handleApiKeyInput);
                    field.addEventListener('change', handleApiKeyInput);
                    console.log(`✅ Added event listeners to ${fieldId}`);
                } else {
                    console.warn(`⚠️ API key field not found: ${fieldId}`);
                }
            });
        }

        // Load saved credentials using original storage format
        function loadStrategyCredentials() {
            console.log('🔄 Loading strategy credentials...');

            const exchanges = ['chainex', 'valr', 'luno', 'kraken', 'binance'];
            const strategies = ['cross-exchange', 'triangular', 'transfer', 'currency-swap'];

            exchanges.forEach(exchange => {
                strategies.forEach(strategy => {
                    // Try to load from strategy-specific storage first
                    let apiKey = localStorage.getItem(`${exchange}_${strategy}_api`);
                    let secretKey = localStorage.getItem(`${exchange}_${strategy}_secret`);

                    // For cross-exchange, also try original format as fallback
                    if (!apiKey && strategy === 'cross-exchange') {
                        if (exchange === 'chainex') {
                            apiKey = localStorage.getItem('chainexApiKey');
                            secretKey = localStorage.getItem('chainexSecretKey');
                        } else if (exchange === 'valr') {
                            apiKey = localStorage.getItem('valrApiKey');
                            secretKey = localStorage.getItem('valrSecretKey');
                        } else if (exchange === 'luno') {
                            apiKey = localStorage.getItem('lunoApiKey');
                            secretKey = localStorage.getItem('lunoSecretKey');
                        } else if (exchange === 'kraken') {
                            apiKey = localStorage.getItem('krakenApiKey');
                            secretKey = localStorage.getItem('krakenSecretKey');
                        } else if (exchange === 'binance') {
                            apiKey = localStorage.getItem('binanceApiKey');
                            secretKey = localStorage.getItem('binanceSecretKey');
                        }
                        if (apiKey) {
                            console.log(`📄 Loaded from original format for ${exchange} ${strategy}`);
                        }
                    }

                    if (apiKey || secretKey) {
                        console.log(`📊 Found credentials for ${exchange} ${strategy}`);
                    }

                    const apiInput = document.getElementById(`${exchange}-${strategy}-api`);
                    const secretInput = document.getElementById(`${exchange}-${strategy}-secret`);

                    if (apiKey && apiInput) {
                        apiInput.value = apiKey;
                        console.log(`✅ Loaded ${exchange} ${strategy} API key`);
                    }

                    if (secretKey && secretInput) {
                        secretInput.value = secretKey;
                        console.log(`✅ Loaded ${exchange} ${strategy} secret key`);
                    }

                    // Check connection status
                    if (apiKey && secretKey) {
                        const statusElement = document.getElementById(`${exchange}-${strategy}-status`);
                        const balanceElement = document.getElementById(`${exchange}-${strategy}-balance`);

                        if (statusElement) {
                            // Check if marked as connected in localStorage
                            const isConnected = localStorage.getItem(`${exchange}_${strategy}_connected`) === 'true';
                            if (isConnected) {
                                statusElement.textContent = 'Connected';
                                statusElement.className = 'connection-status status-connected';

                                // Try to fetch fresh balance if connected
                                if (balanceElement) {
                                    fetchStrategyBalance(exchange, strategy, apiKey, secretKey);
                                }
                            } else {
                                statusElement.textContent = 'Disconnected';
                                statusElement.className = 'connection-status status-disconnected';
                                if (balanceElement) {
                                    balanceElement.textContent = '$0.00';
                                }
                            }
                        }
                    }
                });
            });
        }

        // Test localStorage functionality
        function testLocalStorage() {
            console.log('🧪 Testing localStorage functionality...');

            // Test write
            localStorage.setItem('test_key', 'test_value');
            const testRead = localStorage.getItem('test_key');

            console.log('✅ localStorage test:', {
                canWrite: testRead === 'test_value',
                domain: window.location.hostname,
                protocol: window.location.protocol,
                currentStorage: Object.keys(localStorage).length,
                testValue: testRead
            });

            // Clean up test
            localStorage.removeItem('test_key');

            // Show all existing localStorage keys for debugging
            const allKeys = Object.keys(localStorage);
            console.log('📦 All localStorage keys:', allKeys);

            // Show strategy-specific keys
            const strategyKeys = allKeys.filter(key => key.includes('chainex_'));
            console.log('🔑 Strategy keys found:', strategyKeys);
        }


        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            testLocalStorage();
            loadStrategyCredentials();
            setupAutoSave();
        });
    </script>
</body>
</html>