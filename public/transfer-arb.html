<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transfer Arbitrage - ARB4ME</title>
    <style>
        body {
            background: linear-gradient(135deg, #0c0c1e 0%, #161632 100%);
            color: #b8c6db;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }

        .transfer-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #b8c6db;
            font-size: 0.9rem;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            color: #fff;
            font-size: 0.9rem;
        }

        .form-group select option {
            background: #1a1a2e;
            color: #fff;
            padding: 10px;
        }

        .form-group select option:hover {
            background: #667eea;
            color: #fff;
        }

        .toggle-switch {
            width: 50px;
            height: 25px;
            background: #ff6b6b;
            border-radius: 25px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
        }

        .toggle-switch.active {
            background: #00ff88;
        }

        .toggle-knob {
            width: 21px;
            height: 21px;
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 2px;
            left: 2px;
            transition: all 0.3s;
        }

        .toggle-switch.active .toggle-knob {
            left: 27px;
        }

        .btn {
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #b8c6db;
        }

        .warning-box {
            background: rgba(255,107,107,0.1);
            border: 2px solid #ff6b6b;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .info-box {
            background: rgba(0,212,255,0.1);
            border: 2px solid #00d4ff;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        /* Make tab content visible by default on this page */
        #transferTab {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            /* Force single column layout on mobile */
            .stats-grid {
                grid-template-columns: 1fr !important;
            }

            /* Header explanation boxes - stack vertically on mobile */
            div[style*="minmax(400px"] {
                grid-template-columns: 1fr !important;
            }

            /* Auto-trading configuration - stack vertically */
            div[style*="minmax(300px"] {
                grid-template-columns: 1fr !important;
            }

            /* Rebalance form - stack vertically or 2 columns max */
            div[style*="minmax(250px"] {
                grid-template-columns: 1fr !important;
            }

            /* Payment Gateway form - change from 3 columns to 1 column on mobile */
            #payment-form > div[style*="repeat(3, 1fr)"] {
                grid-template-columns: 1fr !important;
                margin-bottom: 10px !important;
            }

            /* Calculator fields - allow wrapping to 2 columns on mobile */
            div[style*="minmax(140px"] {
                grid-template-columns: repeat(2, 1fr) !important;
            }

            /* Tab buttons - stack vertically on very small screens */
            div[style*="flex"][style*="gap: 15px"] {
                flex-direction: column !important;
            }

            /* Reduce padding on mobile */
            .stat-card {
                padding: 15px !important;
            }

            /* Reduce font sizes slightly on mobile */
            h3 {
                font-size: 1.2rem !important;
            }

            h4 {
                font-size: 1rem !important;
            }

            /* Crypto grid - reduce columns on mobile */
            .crypto-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)) !important;
            }

            /* Opportunity cards - single column */
            div[style*="minmax(200px"] {
                grid-template-columns: 1fr !important;
            }
        }

        /* Very small phones (below 400px) */
        @media (max-width: 400px) {
            /* Calculator - single column on very small screens */
            div[style*="minmax(140px"] {
                grid-template-columns: 1fr !important;
            }

            /* Reduce gaps */
            .stats-grid,
            div[style*="gap: 30px"],
            div[style*="gap: 20px"] {
                gap: 10px !important;
            }

            /* Smaller buttons */
            .btn {
                padding: 10px 16px !important;
                font-size: 0.85rem !important;
            }
        }

        /* Mobile fixes for TEST SCAN MODE */
        @media (max-width: 768px) {
            /* TEST scan configuration - stack vertically on mobile */
            div[style*="grid-template-columns: 2fr 1fr"] {
                grid-template-columns: 1fr !important;
            }

            /* Asset grid - reduce from 4 to 2 columns on mobile */
            div[style*="repeat(4, 1fr)"][style*="max-height: 400px"] {
                grid-template-columns: repeat(2, 1fr) !important;
                max-height: 300px !important;
            }

            /* Tables - enable horizontal scroll on mobile */
            div[style*="overflow-x: auto"] table {
                min-width: 600px;
            }

            /* TEST scan status cards - reduce padding */
            #testScanModeSection div[style*="padding: 30px"] {
                padding: 15px !important;
            }

            /* Buttons - make full width on mobile */
            #testScanModeSection button {
                width: 100% !important;
                margin-bottom: 10px;
            }

            /* Asset counter badge - smaller on mobile */
            #assetCountBadge {
                display: block !important;
                margin-left: 0 !important;
                margin-top: 5px !important;
            }

            /* Warning banner - smaller text */
            #assetWarning {
                font-size: 0.75rem !important;
                padding: 8px !important;
            }

            /* Stats display - stack vertically */
            div[style*="grid-template-columns: repeat(3, 1fr)"] {
                grid-template-columns: 1fr !important;
            }
        }

        /* Very small phones - further optimize */
        @media (max-width: 400px) {
            /* Asset grid - single column on tiny screens */
            div[style*="repeat(4, 1fr)"][style*="max-height: 400px"],
            div[style*="repeat(2, 1fr)"] {
                grid-template-columns: 1fr !important;
            }

            /* Reduce all font sizes */
            h3 {
                font-size: 1.1rem !important;
            }

            h4, h5 {
                font-size: 0.9rem !important;
            }

            /* Tables - even smaller min-width */
            div[style*="overflow-x: auto"] table {
                min-width: 500px;
                font-size: 0.75rem !important;
            }

            /* Tighter spacing everywhere */
            #testScanModeSection {
                padding: 10px !important;
            }
        }

        /* Mobile modal fixes */
        @media (max-width: 768px) {
            /* Modals - add padding and make responsive */
            #depositAddressModal > div,
            #transferAboutModal > div {
                margin: 20px 10px !important;
                padding: 20px !important;
                max-width: calc(100% - 20px) !important;
            }

            /* Modal headers - smaller on mobile */
            #depositAddressModal h2,
            #transferAboutModal h2 {
                font-size: 1.3rem !important;
            }

            /* Modal close buttons */
            #depositAddressModal button,
            #transferAboutModal button {
                padding: 6px 12px !important;
                font-size: 0.85rem !important;
            }
        }
    </style>
</head>
<body>
    <!-- Deposit Address Modal -->
    <div id="depositAddressModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; overflow-y: auto;">
        <div style="max-width: 900px; margin: 50px auto; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border-radius: 15px; padding: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.5);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="color: #00ff88; margin: 0;">üì¨ Configure Deposit Addresses</h2>
                <button onclick="closeDepositAddressModal()" style="background: rgba(255,107,107,0.2); border: 1px solid #ff6b6b; color: #ff6b6b; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: bold;">
                    ‚úï Close
                </button>
            </div>
            <p style="color: #b8c6db; margin-bottom: 20px;">
                Enter deposit addresses for your selected cryptocurrencies. Changes are saved automatically.
            </p>

            <!-- Bulk Network Copy Feature -->
            <div id="bulk-network-copy-section" style="display: none; background: linear-gradient(45deg, rgba(102,126,234,0.2) 0%, rgba(118,75,162,0.2) 100%); border: 2px solid #667eea; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="flex: 1;">
                        <h4 style="color: #ffb347; margin: 0 0 8px 0; font-size: 1rem;">
                            üöÄ Quick Network Configuration
                        </h4>
                        <p style="color: #b8c6db; font-size: 0.85rem; margin: 0; line-height: 1.4;">
                            Copy network selections from <strong style="color: #00ff88;">ChainEX</strong> to all other exchanges.<br>
                            <span style="color: #00d4ff;">Saves you from configuring networks 17 times!</span>
                        </p>
                    </div>
                    <button onclick="copyNetworksFromChainEX()"
                            style="background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
                                   border: none; padding: 12px 24px; border-radius: 8px;
                                   color: white; font-weight: bold; cursor: pointer;
                                   white-space: nowrap; margin-left: 20px; font-size: 0.95rem;
                                   box-shadow: 0 4px 15px rgba(102,126,234,0.4);">
                        üîÑ Copy Networks from ChainEX
                    </button>
                </div>
            </div>

            <div id="modal-deposit-fields" style="max-height: 60vh; overflow-y: auto; padding-right: 10px;">
                <!-- Will be populated dynamically -->
            </div>
        </div>
    </div>

    <div class="transfer-container">
        <!-- Return to Dashboard Button -->
        <div style="margin-bottom: 20px; text-align: center;">
            <button onclick="returnToPlatform()" class="btn" style="background: linear-gradient(45deg, #ff6b6b 0%, #ee5a24 100%); font-size: 1rem; padding: 15px 30px;">
                ‚Üê Return to Dashboard
            </button>
        </div>

        <!-- Transfer Arbitrage Management Tab -->
        <div id="transferTab" class="tab-content active">
            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                <h3 style="color: #00d4ff; margin: 0;">üì¶ Transfer Arbitrage Management</h3>
                <button onclick="openTransferAboutModal()" style="background: rgba(0,212,255,0.2); color: #00d4ff; border: 1px solid #00d4ff; padding: 6px 16px; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 600; transition: all 0.3s;" onmouseover="this.style.background='rgba(0,212,255,0.3)'" onmouseout="this.style.background='rgba(0,212,255,0.2)'">
                    ‚ÑπÔ∏è About
                </button>
            </div>

            <div style="margin-bottom: 20px; padding: 15px; background: rgba(255,179,71,0.1); border: 2px solid #ffb347; border-radius: 10px;">
                <div style="font-size: 1.2rem; color: #ffb347; margin-bottom: 15px; font-weight: bold; text-align: center;">
                    üöÄ TRANSFER ARBITRAGE (PHYSICAL ARBITRAGE)
                </div>
                <div style="color: #b8c6db; text-align: center;">
                    Buy crypto on one exchange, transfer to another exchange where the price is higher, and sell for profit.
                </div>
            </div>

            <!-- Important Warning -->
            <div class="warning-box">
                <h4 style="color: #ff6b6b; margin-bottom: 10px;">‚ö†Ô∏è Important Considerations</h4>
                <ul style="color: #b8c6db; font-size: 0.9rem; margin: 10px 0; padding-left: 20px;">
                    <li>Transfer fees can reduce or eliminate profits</li>
                    <li>Network congestion may cause delays (15 mins to 2 hours)</li>
                    <li>Price may change during transfer time</li>
                    <li>Requires larger price differences to be profitable (typically 2-5%)</li>
                    <li>Best for stable, low-fee cryptocurrencies</li>
                </ul>
            </div>

            <!-- System Overview -->
            <div class="info-box">
                <h4 style="color: #00d4ff; margin-bottom: 10px;">üìä Transfer ARB Overview</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                    <div style="padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.5rem; color: #00ff88; font-weight: bold;" id="activeRoutes">0</div>
                        <div style="font-size: 0.9rem; color: #b8c6db;">Active Routes</div>
                    </div>
                    <div style="padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.5rem; color: #ffb347; font-weight: bold;" id="pendingTransfers">0</div>
                        <div style="font-size: 0.9rem; color: #b8c6db;">Pending Transfers</div>
                    </div>
                    <div style="padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.5rem; color: #ff6b6b; font-weight: bold;" id="completedToday">0</div>
                        <div style="font-size: 0.9rem; color: #b8c6db;">Completed Today</div>
                    </div>
                    <div style="padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.5rem; color: #00d4ff; font-weight: bold;" id="totalTransferProfit">$0.00</div>
                        <div style="font-size: 0.9rem; color: #b8c6db;">Total Profit</div>
                    </div>
                </div>
            </div>

            <!-- Active Trades Dashboard -->
            <div id="activeTradesDashboard" style="display: none; margin-bottom: 30px;">
                <div class="stat-card">
                    <h3 style="color: #00d4ff; margin: 0 0 15px 0;">
                        <span style="font-size: 1.2rem;">üî•</span> Active Transfers
                        <span style="font-size: 0.9rem; color: #b8c6db; font-weight: normal; margin-left: 10px;">
                            (<span id="activeTradesCount">0</span>/<span id="maxTradesCount">5</span>)
                        </span>
                    </h3>
                    <div id="activeTradesDetail">
                        <div style="text-align: center; padding: 40px 20px; color: #888;">
                            <div style="font-size: 3rem; margin-bottom: 10px;">üí§</div>
                            <div style="font-size: 1.1rem; margin-bottom: 5px;">No Active Trades</div>
                            <div style="font-size: 0.85rem;">Waiting for profitable opportunities...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Crypto Selection Section -->
            <div id="crypto-selection-section" style="margin-bottom: 30px;">
                <!-- Will be populated with crypto selector component -->
            </div>

            <!-- Deposit Address Configuration (Generated based on selected cryptos) -->
            <div id="deposit-address-section" style="display: none; margin-bottom: 30px;">
                <!-- Dynamically generated deposit address fields -->
            </div>

            <!-- Auto-Trading Configuration -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 20px;">
                <!-- Auto-Trading Risk Settings -->
                <div class="stat-card">
                    <h4 style="color: #ffb347; margin-bottom: 15px;">ü§ñ Auto-Trading Risk Settings</h4>
                    <div class="form-group">
                        <label>Min Price Difference (%)</label>
                        <input type="number" id="minPriceDiff" value="3" min="1" max="10" step="0.5">
                    </div>
                    <div class="form-group">
                        <label>Max Transfer Amount (USDT)</label>
                        <input type="number" id="maxTransferAmount" value="1000" min="100" max="50000">
                    </div>
                    <div class="form-group">
                        <label>Max Transfer Time (minutes)</label>
                        <input type="number" id="maxTransferTime" value="30" min="10" max="120">
                    </div>
                    <div class="form-group">
                        <label>Include Network Fees</label>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="toggle-switch" id="includeFeesToggle">
                                <div class="toggle-knob"></div>
                            </div>
                            <span style="font-size: 0.85rem; color: #b8c6db;">Calculate fees in profit</span>
                        </div>
                    </div>
                    <div class="form-group" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.2);">
                        <label style="font-size: 1.1rem; font-weight: bold; color: #00ff88;">ü§ñ Auto-Execute Trades</label>
                        <div style="display: flex; align-items: center; gap: 15px; margin-top: 10px;">
                            <div class="toggle-switch" id="autoExecuteToggle">
                                <div class="toggle-knob"></div>
                            </div>
                            <div>
                                <span id="autoExecuteLabel" style="font-size: 0.95rem; font-weight: bold; color: #ff6b6b;">OFF - Manual Trading</span>
                                <div style="font-size: 0.75rem; color: #b8c6db; margin-top: 3px;">
                                    When ON: Automatically executes profitable opportunities
                                </div>
                            </div>
                        </div>
                        <div id="autoExecuteWarning" style="display: none; background: rgba(255,107,107,0.2); border: 1px solid #ff6b6b; border-radius: 8px; padding: 12px; margin-top: 10px;">
                            <div style="color: #ff6b6b; font-weight: bold; margin-bottom: 5px;">‚ö†Ô∏è Auto-Execute Active</div>
                            <div style="color: #b8c6db; font-size: 0.85rem; line-height: 1.4;">
                                System will automatically execute trades meeting your risk criteria. Scanning every <span id="scanInterval">60</span> seconds.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Best Practices -->
                <div class="stat-card">
                    <h4 style="color: #00ff88; margin-bottom: 15px;">üí° Best Practices</h4>
                    <div style="color: #b8c6db; font-size: 0.85rem; line-height: 1.6;">
                        <p style="margin-bottom: 10px;">
                            <strong style="color: #00ff88;">Recommended Cryptos:</strong><br>
                            XRP, XLM, TRX - Fast (3-5 mins), Low fees
                        </p>
                        <p style="margin-bottom: 10px;">
                            <strong style="color: #ffb347;">Medium Risk:</strong><br>
                            LTC, BCH - Medium speed (15-30 mins)
                        </p>
                        <p style="margin-bottom: 10px;">
                            <strong style="color: #ff6b6b;">High Risk:</strong><br>
                            BTC, ETH - Slow (30-60+ mins), High fees
                        </p>
                        <p style="margin-bottom: 10px;">
                            <strong style="color: #00d4ff;">Pro Tip:</strong><br>
                            Always test with small amounts first!
                        </p>
                    </div>
                </div>
            </div>

            <!-- ============================================ -->
            <!-- MANUAL TRADING Section -->
            <!-- ============================================ -->
            <div id="manual-trading-section" style="display: none; margin-bottom: 40px; margin-top: 40px;">
                <div style="background: linear-gradient(135deg, rgba(255,179,71,0.1) 0%, rgba(255,107,107,0.1) 100%); border: 2px solid #ffb347; border-radius: 12px; padding: 25px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <div>
                            <h3 style="color: #ffb347; margin: 0 0 8px 0;">üí∞ MANUAL TRADING Opportunities</h3>
                            <p style="color: #b8c6db; font-size: 0.9rem; margin: 0; line-height: 1.4;">
                                Additional 113 assets from TEST scan ‚Ä¢ Configure deposits on-demand ‚Ä¢ Cherry-pick high-profit trades
                            </p>
                        </div>
                        <button onclick="toggleManualTrading()"
                                id="toggle-manual-trading-btn"
                                style="background: linear-gradient(45deg, #ffb347 0%, #ff6b6b 100%);
                                       border: none; padding: 12px 24px; border-radius: 8px;
                                       color: white; font-weight: bold; cursor: pointer;
                                       white-space: nowrap; font-size: 0.95rem;
                                       box-shadow: 0 4px 15px rgba(255,179,71,0.4);">
                            üëÅÔ∏è Show Manual Opportunities
                        </button>
                    </div>

                    <!-- Manual Trading Stats -->
                    <div id="manual-trading-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                        <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 1.8rem; font-weight: bold; color: #ffb347;" id="manual-opp-count">0</div>
                            <div style="font-size: 0.85rem; color: #b8c6db;">Opportunities Found</div>
                        </div>
                        <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 1.8rem; font-weight: bold; color: #00ff88;" id="manual-ready-count">0</div>
                            <div style="font-size: 0.85rem; color: #b8c6db;">Ready to Execute</div>
                        </div>
                        <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 1.8rem; font-weight: bold; color: #00d4ff;" id="manual-best-profit">0%</div>
                            <div style="font-size: 0.85rem; color: #b8c6db;">Best Profit</div>
                        </div>
                    </div>
                </div>

                <!-- Manual Opportunities List (Hidden by default) -->
                <div id="manual-opportunities-container" style="display: none;">
                    <!-- Filters and Sort Controls -->
                    <div style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; align-items: end;">
                            <div>
                                <label style="color: #b8c6db; font-size: 0.85rem; display: block; margin-bottom: 6px;">Sort By</label>
                                <select id="manual-sort" onchange="scanManualOpportunities()"
                                        style="background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.3);
                                               border-radius: 6px; padding: 10px; color: white; width: 100%; font-size: 0.9rem;">
                                    <option value="profit-desc">üí∞ Highest Profit %</option>
                                    <option value="profit-asc">üìâ Lowest Profit %</option>
                                    <option value="time-asc">‚ö° Fastest Transfer</option>
                                    <option value="ready-first">‚úÖ Ready to Execute</option>
                                </select>
                            </div>
                            <div>
                                <label style="color: #b8c6db; font-size: 0.85rem; display: block; margin-bottom: 6px;">Min Profit %</label>
                                <input type="number" id="manual-min-profit" value="2" min="0" max="20" step="0.5" onchange="scanManualOpportunities()"
                                       style="background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.3);
                                              border-radius: 6px; padding: 10px; color: white; width: 100%; font-size: 0.9rem;">
                            </div>
                            <div>
                                <label style="color: #b8c6db; font-size: 0.85rem; display: block; margin-bottom: 6px;">Status Filter</label>
                                <select id="manual-status-filter" onchange="scanManualOpportunities()"
                                        style="background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.3);
                                               border-radius: 6px; padding: 10px; color: white; width: 100%; font-size: 0.9rem;">
                                    <option value="all">All Opportunities</option>
                                    <option value="ready">‚úÖ Ready to Execute</option>
                                    <option value="partial">üü° Partially Configured</option>
                                    <option value="not-configured">‚ö†Ô∏è Not Configured</option>
                                </select>
                            </div>
                            <div>
                                <button onclick="scanManualOpportunities()"
                                        style="background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
                                               border: none; padding: 10px 20px; border-radius: 6px;
                                               color: white; font-weight: bold; cursor: pointer; width: 100%;">
                                    üîÑ Refresh
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Opportunities List -->
                    <div id="manual-opportunities-list">
                        <!-- Will be populated with manual opportunities -->
                    </div>
                </div>
            </div>

            <!-- ============================================ -->
            <!-- TEST SCAN MODE - Opportunity Research Tool -->
            <!-- ============================================ -->
            <div id="testScanModeSection" style="margin-bottom: 40px; margin-top: 40px;">
                <div style="background: rgba(255,193,7,0.1); border: 2px solid #ffc107; border-radius: 12px; padding: 30px;">
                    <h3 style="color: #ffc107; margin-bottom: 10px; font-size: 1.5rem;">üî¨ TEST SCAN MODE - Opportunity Research</h3>
                    <p style="color: #b8c6db; font-size: 0.9rem; margin-bottom: 25px;">
                        Run continuous scans across exchanges to identify profitable transfer routes. No trading - just data collection and analysis.
                    </p>

                    <!-- Configuration Panel -->
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 25px;">

                        <!-- Left Column: Asset Selection -->
                        <div>
                            <div style="background: rgba(0,255,136,0.05); border: 1px solid rgba(0,255,136,0.3); border-radius: 8px; padding: 20px;">
                                <h4 style="color: #00ff88; margin-bottom: 10px; font-size: 1rem;">
                                    üìä Select Assets to Scan
                                    <span id="assetCountBadge" style="margin-left: 10px; padding: 3px 8px; border-radius: 4px; font-size: 0.85rem; background: rgba(0,255,136,0.2); color: #00ff88;">0 selected</span>
                                </h4>
                                <div id="assetWarning" style="display: none; background: rgba(255,179,71,0.2); border: 1px solid #ffb347; border-radius: 6px; padding: 10px; margin-bottom: 10px;">
                                    <strong style="color: #ffb347;">‚ö†Ô∏è Warning:</strong>
                                    <span style="color: #b8c6db; font-size: 0.85rem;">More than 10 assets selected! For longer scanning sessions (6-9 hours), select 10 or fewer assets. With many assets, you'll hit the 5,000 route limit faster.</span>
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; max-height: 400px; overflow-y: auto; padding: 5px;">
                                    <!-- Stablecoins (Fast) -->
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="USDT" checked style="margin-right: 6px;">
                                        <span style="color: #00ff88;">üíµ USDT</span> <span style="color: #888; font-size: 0.7rem; margin-left: 4px;">(3m)</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="USDC" checked style="margin-right: 6px;">
                                        <span style="color: #00ff88;">üíµ USDC</span> <span style="color: #888; font-size: 0.7rem; margin-left: 4px;">(3m)</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="DAI" style="margin-right: 6px;">
                                        <span style="color: #00ff88;">üíµ DAI</span> <span style="color: #888; font-size: 0.7rem; margin-left: 4px;">(3m)</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="BUSD" style="margin-right: 6px;">
                                        <span style="color: #00ff88;">üíµ BUSD</span> <span style="color: #888; font-size: 0.7rem; margin-left: 4px;">(3m)</span>
                                    </label>

                                    <!-- Fast Transfer Coins -->
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="XRP" checked style="margin-right: 6px;">
                                        <span style="color: #00ff88;">‚ö° XRP</span> <span style="color: #888; font-size: 0.7rem; margin-left: 4px;">(3m)</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="XLM" checked style="margin-right: 6px;">
                                        <span style="color: #00ff88;">‚ö° XLM</span> <span style="color: #888; font-size: 0.7rem; margin-left: 4px;">(5m)</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="TRX" checked style="margin-right: 6px;">
                                        <span style="color: #00ff88;">‚ö° TRX</span> <span style="color: #888; font-size: 0.7rem; margin-left: 4px;">(3m)</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="SOL" checked style="margin-right: 6px;">
                                        <span style="color: #00ff88;">‚ö° SOL</span> <span style="color: #888; font-size: 0.7rem; margin-left: 4px;">(5m)</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="ALGO" checked style="margin-right: 6px;">
                                        <span style="color: #00ff88;">‚ö° ALGO</span> <span style="color: #888; font-size: 0.7rem; margin-left: 4px;">(4m)</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="MATIC" checked style="margin-right: 6px;">
                                        <span style="color: #00ff88;">‚ö° MATIC</span> <span style="color: #888; font-size: 0.7rem; margin-left: 4px;">(3m)</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="NEAR" style="margin-right: 6px;">
                                        <span style="color: #00ff88;">‚ö° NEAR</span> <span style="color: #888; font-size: 0.7rem; margin-left: 4px;">(5m)</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="HBAR" style="margin-right: 6px;">
                                        <span style="color: #00ff88;">‚ö° HBAR</span> <span style="color: #888; font-size: 0.7rem; margin-left: 4px;">(3m)</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="ARB" style="margin-right: 6px;">
                                        <span style="color: #00ff88;">‚ö° ARB</span> <span style="color: #888; font-size: 0.7rem; margin-left: 4px;">(3m)</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="OP" style="margin-right: 6px;">
                                        <span style="color: #00ff88;">‚ö° OP</span> <span style="color: #888; font-size: 0.7rem; margin-left: 4px;">(3m)</span>
                                    </label>

                                    <!-- Medium Speed Coins -->
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="LTC" checked style="margin-right: 6px;">
                                        <span style="color: #ffb347;">‚ö° LTC</span> <span style="color: #888; font-size: 0.7rem; margin-left: 4px;">(15m)</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="BCH" checked style="margin-right: 6px;">
                                        <span style="color: #ffb347;">‚ö° BCH</span> <span style="color: #888; font-size: 0.7rem; margin-left: 4px;">(15m)</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="DOGE" checked style="margin-right: 6px;">
                                        <span style="color: #ffb347;">‚ö° DOGE</span> <span style="color: #888; font-size: 0.7rem; margin-left: 4px;">(10m)</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="ADA" checked style="margin-right: 6px;">
                                        <span style="color: #ffb347;">‚ö° ADA</span> <span style="color: #888; font-size: 0.7rem; margin-left: 4px;">(10m)</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="AVAX" checked style="margin-right: 6px;">
                                        <span style="color: #ffb347;">‚ö° AVAX</span> <span style="color: #888; font-size: 0.7rem; margin-left: 4px;">(5m)</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="ATOM" checked style="margin-right: 6px;">
                                        <span style="color: #ffb347;">‚ö° ATOM</span> <span style="color: #888; font-size: 0.7rem; margin-left: 4px;">(7m)</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="FTM" style="margin-right: 6px;">
                                        <span style="color: #ffb347;">‚ö° FTM</span> <span style="color: #888; font-size: 0.7rem; margin-left: 4px;">(10m)</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="LINK" style="margin-right: 6px;">
                                        <span style="color: #ffb347;">‚ö° LINK</span> <span style="color: #888; font-size: 0.7rem; margin-left: 4px;">(12m)</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="UNI" style="margin-right: 6px;">
                                        <span style="color: #ffb347;">‚ö° UNI</span> <span style="color: #888; font-size: 0.7rem; margin-left: 4px;">(12m)</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="AAVE" style="margin-right: 6px;">
                                        <span style="color: #ffb347;">‚ö° AAVE</span> <span style="color: #888; font-size: 0.7rem; margin-left: 4px;">(12m)</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="VET" style="margin-right: 6px;">
                                        <span style="color: #ffb347;">‚ö° VET</span> <span style="color: #888; font-size: 0.7rem; margin-left: 4px;">(10m)</span>
                                    </label>

                                    <!-- Slower Coins (Unchecked by default) -->
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="BTC" style="margin-right: 6px;">
                                        <span style="color: #ff6b6b;">‚ö° BTC</span> <span style="color: #888; font-size: 0.7rem; margin-left: 4px;">(30m)</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="ETH" style="margin-right: 6px;">
                                        <span style="color: #ff6b6b;">‚ö° ETH</span> <span style="color: #888; font-size: 0.7rem; margin-left: 4px;">(10m)</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="DOT" checked style="margin-right: 6px;">
                                        <span style="color: #ffb347;">‚ö° DOT</span> <span style="color: #888; font-size: 0.7rem; margin-left: 4px;">(12m)</span>
                                    </label>

                                    <!-- BATCH 1: Popular Meme & DeFi -->
                                    <div style="grid-column: 1 / -1; margin-top: 15px; padding: 8px 0; border-top: 2px solid rgba(255,215,0,0.3); border-bottom: 1px solid rgba(255,215,0,0.2);">
                                        <strong style="color: #ffd700; font-size: 0.9rem;">üì¶ BATCH 1 - Popular Meme & DeFi</strong>
                                        <span style="color: #888; font-size: 0.75rem; margin-left: 10px;">Test these together (10 assets)</span>
                                    </div>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="SHIB" style="margin-right: 6px;">
                                        <span style="color: #00ff88;">üé≠ SHIB</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="PEPE" style="margin-right: 6px;">
                                        <span style="color: #00ff88;">üé≠ PEPE</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="FLOKI" style="margin-right: 6px;">
                                        <span style="color: #00ff88;">üé≠ FLOKI</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="BONK" style="margin-right: 6px;">
                                        <span style="color: #00ff88;">üé≠ BONK</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="WIF" style="margin-right: 6px;">
                                        <span style="color: #00ff88;">üé≠ WIF</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="CRV" style="margin-right: 6px;">
                                        <span style="color: #ffb347;">üíé CRV</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="SNX" style="margin-right: 6px;">
                                        <span style="color: #ffb347;">üíé SNX</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="SUSHI" style="margin-right: 6px;">
                                        <span style="color: #ffb347;">üíé SUSHI</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="1INCH" style="margin-right: 6px;">
                                        <span style="color: #ffb347;">üíé 1INCH</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="COMP" style="margin-right: 6px;">
                                        <span style="color: #ffb347;">üíé COMP</span>
                                    </label>

                                    <!-- BATCH 2: Emerging L1s & L2s -->
                                    <div style="grid-column: 1 / -1; margin-top: 15px; padding: 8px 0; border-top: 2px solid rgba(255,215,0,0.3); border-bottom: 1px solid rgba(255,215,0,0.2);">
                                        <strong style="color: #ffd700; font-size: 0.9rem;">üì¶ BATCH 2 - Emerging L1s & L2s</strong>
                                        <span style="color: #888; font-size: 0.75rem; margin-left: 10px;">Test these together (10 assets)</span>
                                    </div>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="BNB" style="margin-right: 6px;">
                                        <span style="color: #00ff88;">üöÄ BNB</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="SEI" style="margin-right: 6px;">
                                        <span style="color: #00ff88;">üöÄ SEI</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="SUI" style="margin-right: 6px;">
                                        <span style="color: #00ff88;">üöÄ SUI</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="APT" style="margin-right: 6px;">
                                        <span style="color: #00ff88;">üöÄ APT</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="INJ" style="margin-right: 6px;">
                                        <span style="color: #00ff88;">üöÄ INJ</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="FET" style="margin-right: 6px;">
                                        <span style="color: #00ff88;">üöÄ FET</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="RNDR" style="margin-right: 6px;">
                                        <span style="color: #00ff88;">üöÄ RNDR</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="GRT" style="margin-right: 6px;">
                                        <span style="color: #00ff88;">üöÄ GRT</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="THETA" style="margin-right: 6px;">
                                        <span style="color: #00ff88;">üöÄ THETA</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="EGLD" style="margin-right: 6px;">
                                        <span style="color: #00ff88;">üöÄ EGLD</span>
                                    </label>

                                    <!-- BATCH 3: Mid-cap Alts -->
                                    <div style="grid-column: 1 / -1; margin-top: 15px; padding: 8px 0; border-top: 2px solid rgba(255,215,0,0.3); border-bottom: 1px solid rgba(255,215,0,0.2);">
                                        <strong style="color: #ffd700; font-size: 0.9rem;">üì¶ BATCH 3 - Mid-cap Alts</strong>
                                        <span style="color: #888; font-size: 0.75rem; margin-left: 10px;">Test these together (10 assets)</span>
                                    </div>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="IMX" style="margin-right: 6px;">
                                        <span style="color: #ffb347;">‚ö° IMX</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="SAND" style="margin-right: 6px;">
                                        <span style="color: #ffb347;">‚ö° SAND</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="MANA" style="margin-right: 6px;">
                                        <span style="color: #ffb347;">‚ö° MANA</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="AXS" style="margin-right: 6px;">
                                        <span style="color: #ffb347;">‚ö° AXS</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="GALA" style="margin-right: 6px;">
                                        <span style="color: #ffb347;">‚ö° GALA</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="ENJ" style="margin-right: 6px;">
                                        <span style="color: #ffb347;">‚ö° ENJ</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="CHZ" style="margin-right: 6px;">
                                        <span style="color: #ffb347;">‚ö° CHZ</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="ROSE" style="margin-right: 6px;">
                                        <span style="color: #ffb347;">‚ö° ROSE</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="LRC" style="margin-right: 6px;">
                                        <span style="color: #ffb347;">‚ö° LRC</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="ZIL" style="margin-right: 6px;">
                                        <span style="color: #ffb347;">‚ö° ZIL</span>
                                    </label>

                                    <!-- BATCH 4: DeFi Protocols -->
                                    <div style="grid-column: 1 / -1; margin-top: 15px; padding: 8px 0; border-top: 2px solid rgba(255,215,0,0.3); border-bottom: 1px solid rgba(255,215,0,0.2);">
                                        <strong style="color: #ffd700; font-size: 0.9rem;">üì¶ BATCH 4 - DeFi Protocols</strong>
                                        <span style="color: #888; font-size: 0.75rem; margin-left: 10px;">Test these together (10 assets)</span>
                                    </div>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="MKR" style="margin-right: 6px;">
                                        <span style="color: #ffb347;">üíé MKR</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="BAL" style="margin-right: 6px;">
                                        <span style="color: #ffb347;">üíé BAL</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="YFI" style="margin-right: 6px;">
                                        <span style="color: #ffb347;">üíé YFI</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="CAKE" style="margin-right: 6px;">
                                        <span style="color: #ffb347;">üíé CAKE</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="RUNE" style="margin-right: 6px;">
                                        <span style="color: #ffb347;">üíé RUNE</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="KAVA" style="margin-right: 6px;">
                                        <span style="color: #ffb347;">üíé KAVA</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="OSMO" style="margin-right: 6px;">
                                        <span style="color: #ffb347;">üíé OSMO</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="SCRT" style="margin-right: 6px;">
                                        <span style="color: #ffb347;">üíé SCRT</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="OCEAN" style="margin-right: 6px;">
                                        <span style="color: #ffb347;">üíé OCEAN</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="LDO" style="margin-right: 6px;">
                                        <span style="color: #ffb347;">üíé LDO</span>
                                    </label>

                                    <!-- BATCH 5: Gaming & Metaverse -->
                                    <div style="grid-column: 1 / -1; margin-top: 15px; padding: 8px 0; border-top: 2px solid rgba(255,215,0,0.3); border-bottom: 1px solid rgba(255,215,0,0.2);">
                                        <strong style="color: #ffd700; font-size: 0.9rem;">üì¶ BATCH 5 - Gaming & Metaverse</strong>
                                        <span style="color: #888; font-size: 0.75rem; margin-left: 10px;">Test these together (10 assets)</span>
                                    </div>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="ALICE" style="margin-right: 6px;">
                                        <span style="color: #ffb347;">üéÆ ALICE</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="TLM" style="margin-right: 6px;">
                                        <span style="color: #ffb347;">üéÆ TLM</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="ILV" style="margin-right: 6px;">
                                        <span style="color: #ffb347;">üéÆ ILV</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="GODS" style="margin-right: 6px;">
                                        <span style="color: #ffb347;">üéÆ GODS</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="PYR" style="margin-right: 6px;">
                                        <span style="color: #ffb347;">üéÆ PYR</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="VOXEL" style="margin-right: 6px;">
                                        <span style="color: #ffb347;">üéÆ VOXEL</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="WAXP" style="margin-right: 6px;">
                                        <span style="color: #ffb347;">üéÆ WAXP</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="FLOW" style="margin-right: 6px;">
                                        <span style="color: #ffb347;">üéÆ FLOW</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="LOOKS" style="margin-right: 6px;">
                                        <span style="color: #ffb347;">üéÆ LOOKS</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="BLUR" style="margin-right: 6px;">
                                        <span style="color: #ffb347;">üéÆ BLUR</span>
                                    </label>

                                    <!-- BATCH 6: Infrastructure & Low-cap 1 -->
                                    <div style="grid-column: 1 / -1; margin-top: 15px; padding: 8px 0; border-top: 2px solid rgba(255,215,0,0.3); border-bottom: 1px solid rgba(255,215,0,0.2);">
                                        <strong style="color: #ffd700; font-size: 0.9rem;">üì¶ BATCH 6 - Infrastructure & Low-cap 1</strong>
                                        <span style="color: #888; font-size: 0.75rem; margin-left: 10px;">Test these together (10 assets)</span>
                                    </div>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="ONDO" style="margin-right: 6px;">
                                        <span style="color: #888;">üß™ ONDO</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="CKB" style="margin-right: 6px;">
                                        <span style="color: #888;">üß™ CKB</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="TLOS" style="margin-right: 6px;">
                                        <span style="color: #888;">üß™ TLOS</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="EVMOS" style="margin-right: 6px;">
                                        <span style="color: #888;">üß™ EVMOS</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="XDC" style="margin-right: 6px;">
                                        <span style="color: #888;">üß™ XDC</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="CELO" style="margin-right: 6px;">
                                        <span style="color: #888;">üß™ CELO</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="QTUM" style="margin-right: 6px;">
                                        <span style="color: #888;">üß™ QTUM</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="ZEN" style="margin-right: 6px;">
                                        <span style="color: #888;">üß™ ZEN</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="RVN" style="margin-right: 6px;">
                                        <span style="color: #888;">üß™ RVN</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="FLUX" style="margin-right: 6px;">
                                        <span style="color: #888;">üß™ FLUX</span>
                                    </label>

                                    <!-- BATCH 7: Newer Meme Tokens -->
                                    <div style="grid-column: 1 / -1; margin-top: 15px; padding: 8px 0; border-top: 2px solid rgba(255,215,0,0.3); border-bottom: 1px solid rgba(255,215,0,0.2);">
                                        <strong style="color: #ffd700; font-size: 0.9rem;">üì¶ BATCH 7 - Newer Meme Tokens</strong>
                                        <span style="color: #888; font-size: 0.75rem; margin-left: 10px;">Test these together (10 assets)</span>
                                    </div>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="MOG" style="margin-right: 6px;">
                                        <span style="color: #888;">üé≠ MOG</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="TURBO" style="margin-right: 6px;">
                                        <span style="color: #888;">üé≠ TURBO</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="BRETT" style="margin-right: 6px;">
                                        <span style="color: #888;">üé≠ BRETT</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="MYRO" style="margin-right: 6px;">
                                        <span style="color: #888;">üé≠ MYRO</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="WEN" style="margin-right: 6px;">
                                        <span style="color: #888;">üé≠ WEN</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="BOME" style="margin-right: 6px;">
                                        <span style="color: #888;">üé≠ BOME</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="SLERF" style="margin-right: 6px;">
                                        <span style="color: #888;">üé≠ SLERF</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="MEME" style="margin-right: 6px;">
                                        <span style="color: #888;">üé≠ MEME</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="SMOG" style="margin-right: 6px;">
                                        <span style="color: #888;">üé≠ SMOG</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="COQ" style="margin-right: 6px;">
                                        <span style="color: #888;">üé≠ COQ</span>
                                    </label>

                                    <!-- BATCH 8: Perpetual DEXs & Derivatives -->
                                    <div style="grid-column: 1 / -1; margin-top: 15px; padding: 8px 0; border-top: 2px solid rgba(255,215,0,0.3); border-bottom: 1px solid rgba(255,215,0,0.2);">
                                        <strong style="color: #ffd700; font-size: 0.9rem;">üì¶ BATCH 8 - Perpetual DEXs & Derivatives</strong>
                                        <span style="color: #888; font-size: 0.75rem; margin-left: 10px;">Test these together (10 assets)</span>
                                    </div>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="DYDX" style="margin-right: 6px;">
                                        <span style="color: #ffb347;">üíé DYDX</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="GMX" style="margin-right: 6px;">
                                        <span style="color: #ffb347;">üíé GMX</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="PERP" style="margin-right: 6px;">
                                        <span style="color: #ffb347;">üíé PERP</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="JOE" style="margin-right: 6px;">
                                        <span style="color: #ffb347;">üíé JOE</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="SSV" style="margin-right: 6px;">
                                        <span style="color: #ffb347;">üíé SSV</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="RPL" style="margin-right: 6px;">
                                        <span style="color: #ffb347;">üíé RPL</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="PENDLE" style="margin-right: 6px;">
                                        <span style="color: #ffb347;">üíé PENDLE</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="CVX" style="margin-right: 6px;">
                                        <span style="color: #ffb347;">üíé CVX</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="FXS" style="margin-right: 6px;">
                                        <span style="color: #ffb347;">üíé FXS</span>
                                    </label>
                                    <label style="color: #b8c6db; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" class="test-scan-asset" value="STRK" style="margin-right: 6px;">
                                        <span style="color: #ffb347;">üíé STRK</span>
                                    </label>
                                </div>
                                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
                                    <h5 style="color: #00d4ff; margin-bottom: 10px; font-size: 0.9rem;">üè¶ Scanning Connected Exchanges:</h5>
                                    <div id="testScanExchangesList" style="color: #b8c6db; font-size: 0.85rem; line-height: 1.6;">
                                        <em style="color: #888;">Loading...</em>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column: Settings & Controls -->
                        <div>
                            <!-- Settings -->
                            <div style="background: rgba(102,126,234,0.05); border: 1px solid rgba(102,126,234,0.3); border-radius: 8px; padding: 20px; margin-bottom: 15px;">
                                <h4 style="color: #667eea; margin-bottom: 15px; font-size: 1rem;">‚öôÔ∏è Settings</h4>

                                <div style="margin-bottom: 15px;">
                                    <label style="color: #b8c6db; font-size: 0.9rem; display: block; margin-bottom: 5px;">Min Profit % (after fees):</label>
                                    <input type="number" id="testScanMinProfit" min="0" max="20" step="0.1" value="1.0"
                                           style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; color: #fff; font-size: 1rem;">
                                    <div style="color: #888; font-size: 0.75rem; margin-top: 5px;">Show all opportunities above this %</div>
                                </div>

                                <div>
                                    <label style="color: #b8c6db; font-size: 0.9rem; display: block; margin-bottom: 5px;">Scan Interval:</label>
                                    <select id="testScanInterval" style="width: 100%; padding: 10px; background: #2a2f45; border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; color: #fff; font-size: 1rem;">
                                        <option value="30" style="background: #2a2f45; color: #fff;">30 seconds</option>
                                        <option value="60" selected style="background: #2a2f45; color: #fff;">60 seconds (1 min)</option>
                                        <option value="120" style="background: #2a2f45; color: #fff;">2 minutes</option>
                                        <option value="300" style="background: #2a2f45; color: #fff;">5 minutes</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Control Buttons -->
                            <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 20px;">
                                <h4 style="color: #ffc107; margin-bottom: 15px; font-size: 1rem;">üéÆ Controls</h4>

                                <button id="startTestScanBtn" onclick="startTestScan()"
                                        style="width: 100%; padding: 14px; background: linear-gradient(135deg, #00ff88, #00d4ff); color: #1a1f36; font-weight: bold; border: none; border-radius: 6px; cursor: pointer; margin-bottom: 10px; font-size: 1rem;">
                                    ‚ñ∂Ô∏è Start Test Scan
                                </button>

                                <button id="stopTestScanBtn" onclick="stopTestScan()" disabled
                                        style="width: 100%; padding: 14px; background: rgba(255,107,107,0.2); color: #ff6b6b; font-weight: bold; border: 1px solid #ff6b6b; border-radius: 6px; cursor: not-allowed; margin-bottom: 10px; font-size: 1rem;">
                                    ‚è∏Ô∏è Stop Scan
                                </button>

                                <button id="downloadTestScanBtn" onclick="downloadTestScanResults()"
                                        style="width: 100%; padding: 12px; background: linear-gradient(135deg, #00d4ff, #0099ff); color: #fff; font-weight: bold; border: none; border-radius: 6px; cursor: pointer; margin-bottom: 10px; font-size: 0.9rem;">
                                    üì• Download Results (CSV)
                                </button>

                                <button id="resetTestScanBtn" onclick="resetTestScan()"
                                        style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); color: #888; font-weight: bold; border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; cursor: pointer; font-size: 0.9rem;">
                                    üîÑ Reset Results
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Live Status Display -->
                    <div id="testScanStatus" style="background: rgba(0,255,136,0.1); border: 1px solid #00ff88; border-radius: 8px; padding: 20px; margin-bottom: 25px;">
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 15px;">
                            <div>
                                <div style="color: #888; font-size: 0.75rem; text-transform: uppercase; margin-bottom: 5px;">Status</div>
                                <div id="testScanStatusText" style="color: #888; font-weight: bold; font-size: 1.1rem;">‚ö™ READY TO SCAN</div>
                            </div>
                            <div>
                                <div style="color: #888; font-size: 0.75rem; text-transform: uppercase; margin-bottom: 5px;">Scan Cycles</div>
                                <div id="testScanCycles" style="color: #fff; font-weight: bold; font-size: 1.1rem;">0</div>
                            </div>
                            <div>
                                <div style="color: #888; font-size: 0.75rem; text-transform: uppercase; margin-bottom: 5px;">Data Collected</div>
                                <div id="testScanOppsFound" style="color: #ffc107; font-weight: bold; font-size: 1.1rem;">0 / 50,000</div>
                                <div id="testScanStoragePercent" style="color: #888; font-size: 0.7rem; margin-top: 2px;">0%</div>
                            </div>
                            <div>
                                <div style="color: #888; font-size: 0.75rem; text-transform: uppercase; margin-bottom: 5px;">Running Time</div>
                                <div id="testScanRunTime" style="color: #fff; font-weight: bold; font-size: 1.1rem;">0:00</div>
                            </div>
                        </div>
                        <div style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px;">
                            <div style="color: #888; font-size: 0.75rem; text-transform: uppercase; margin-bottom: 5px;">Current Scan</div>
                            <div id="testScanCurrentSet" style="color: #888; font-size: 0.9rem;">Click "Start Test Scan" to begin...</div>
                            <div style="margin-top: 10px; color: #888; font-size: 0.85rem;">
                                Next scan in: <span id="testScanCountdown" style="color: #00d4ff; font-weight: bold;">--</span>
                            </div>
                        </div>
                        <div style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px; margin-top: 15px;">
                            <div style="color: #888; font-size: 0.75rem; text-transform: uppercase; margin-bottom: 5px;">Best Opportunity Found</div>
                            <div id="testScanBestOpp" style="color: #ffc107; font-size: 0.95rem; font-weight: bold;">None yet</div>
                        </div>
                    </div>

                    <!-- Report Tables -->
                    <div id="testScanReports">
                        <h4 style="color: #ffc107; margin-bottom: 20px; font-size: 1.2rem; text-align: center;">üìä Live Analysis Report</h4>

                        <!-- Top Routes by Profit % -->
                        <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                            <h5 style="color: #00ff88; margin-bottom: 15px;">üèÜ Top 20 Routes by Profit %</h5>
                            <div style="overflow-x: auto;">
                                <table id="testScanTopProfitTable" style="width: 100%; border-collapse: collapse; color: #b8c6db; font-size: 0.85rem;">
                                    <thead>
                                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                                            <th style="text-align: left; padding: 10px; color: #888;">#</th>
                                            <th style="text-align: left; padding: 10px; color: #888;">Route</th>
                                            <th style="text-align: left; padding: 10px; color: #888;">Crypto</th>
                                            <th style="text-align: right; padding: 10px; color: #888;">Avg Profit %</th>
                                            <th style="text-align: right; padding: 10px; color: #888;">Best Profit %</th>
                                            <th style="text-align: right; padding: 10px; color: #888;">Times Found</th>
                                            <th style="text-align: center; padding: 10px; color: #888;">Risk</th>
                                            <th style="text-align: center; padding: 10px; color: #888;">Liquidity</th>
                                            <th style="text-align: center; padding: 10px; color: #888;">Networks</th>
                                            <th style="text-align: center; padding: 10px; color: #888;">Transfer Time</th>
                                            <th style="text-align: right; padding: 10px; color: #888;">Last Seen</th>
                                        </tr>
                                    </thead>
                                    <tbody id="testScanTopProfitBody">
                                        <tr><td colspan="11" style="text-align: center; padding: 30px; color: #888; font-style: italic;">Waiting for scan data... Click "Start Test Scan" above.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Top Routes by Consistency -->
                        <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                            <h5 style="color: #00d4ff; margin-bottom: 15px;">üìà Top 20 Routes by Consistency (Most Reliable)</h5>
                            <div style="overflow-x: auto;">
                                <table id="testScanTopConsistencyTable" style="width: 100%; border-collapse: collapse; color: #b8c6db; font-size: 0.85rem;">
                                    <thead>
                                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                                            <th style="text-align: left; padding: 10px; color: #888;">#</th>
                                            <th style="text-align: left; padding: 10px; color: #888;">Route</th>
                                            <th style="text-align: left; padding: 10px; color: #888;">Crypto</th>
                                            <th style="text-align: right; padding: 10px; color: #888;">Times Found</th>
                                            <th style="text-align: right; padding: 10px; color: #888;">Avg Profit %</th>
                                            <th style="text-align: right; padding: 10px; color: #888;">Min/Max Profit</th>
                                            <th style="text-align: center; padding: 10px; color: #888;">Consistency</th>
                                        </tr>
                                    </thead>
                                    <tbody id="testScanTopConsistencyBody">
                                        <tr><td colspan="7" style="text-align: center; padding: 30px; color: #888; font-style: italic;">Waiting for scan data... Click "Start Test Scan" above.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Best Cryptos & Best Exchanges Side by Side -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <!-- Best Cryptos -->
                            <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 20px;">
                                <h5 style="color: #667eea; margin-bottom: 15px;">‚ö° Best Cryptos for Transfer Arb</h5>
                                <div style="overflow-x: auto;">
                                    <table id="testScanBestCryptosTable" style="width: 100%; border-collapse: collapse; color: #b8c6db; font-size: 0.85rem;">
                                        <thead>
                                            <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                                                <th style="text-align: left; padding: 10px; color: #888;">Crypto</th>
                                                <th style="text-align: right; padding: 10px; color: #888;">Opps</th>
                                                <th style="text-align: right; padding: 10px; color: #888;">Avg Profit</th>
                                            </tr>
                                        </thead>
                                        <tbody id="testScanBestCryptosBody">
                                            <tr><td colspan="3" style="text-align: center; padding: 20px; color: #888;">Waiting for scan data...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Best Exchanges -->
                            <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 20px;">
                                <h5 style="color: #ffb347; margin-bottom: 15px;">üè¶ Best Exchange Pairs</h5>
                                <div style="overflow-x: auto;">
                                    <table id="testScanBestExchangesTable" style="width: 100%; border-collapse: collapse; color: #b8c6db; font-size: 0.85rem;">
                                        <thead>
                                            <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                                                <th style="text-align: left; padding: 10px; color: #888;">Exchange Pair</th>
                                                <th style="text-align: right; padding: 10px; color: #888;">Opps</th>
                                                <th style="text-align: right; padding: 10px; color: #888;">Avg Profit</th>
                                            </tr>
                                        </thead>
                                        <tbody id="testScanBestExchangesBody">
                                            <tr><td colspan="3" style="text-align: center; padding: 20px; color: #888;">Waiting for scan data...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Time of Day Analysis -->
                        <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 20px;">
                            <h5 style="color: #ffc107; margin-bottom: 15px;">üïê Best Times to Trade (Hourly Analysis)</h5>
                            <div style="overflow-x: auto;">
                                <table id="testScanTimeAnalysisTable" style="width: 100%; border-collapse: collapse; color: #b8c6db; font-size: 0.85rem;">
                                    <thead>
                                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                                            <th style="text-align: left; padding: 10px; color: #888;">Hour (Local Time)</th>
                                            <th style="text-align: right; padding: 10px; color: #888;">Opportunities</th>
                                            <th style="text-align: right; padding: 10px; color: #888;">Avg Profit %</th>
                                            <th style="text-align: left; padding: 10px; color: #888;">Most Common Route</th>
                                        </tr>
                                    </thead>
                                    <tbody id="testScanTimeAnalysisBody">
                                        <tr><td colspan="4" style="text-align: center; padding: 20px; color: #888;">Waiting for scan data...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Smart Money Transfer - Payment Gateway Section -->
            <div style="margin-bottom: 30px; margin-top: 40px;">
                <div style="background: rgba(0,212,255,0.1); border: 2px solid #00d4ff; border-radius: 12px; padding: 30px; margin-bottom: 20px; text-align: center;">
                    <h3 style="color: #00d4ff; margin-bottom: 25px; font-size: 1.5rem;">üí∏ SMART MONEY TRANSFER - PAYMENT GATEWAY</h3>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 30px; text-align: left; margin-top: 20px;">
                        <!-- Smart Money Transfer -->
                        <div style="background: rgba(0,255,136,0.1); border: 1px solid #00ff88; border-radius: 8px; padding: 20px;">
                            <h4 style="color: #00ff88; margin-bottom: 15px;">üìä Smart Money Transfer</h4>
                            <p style="color: #b8c6db; font-size: 0.9rem; line-height: 1.6;">
                                Need to move funds between exchanges or rebalance exchange accounts or fund a new exchange?
                                Efficiently transfer crypto between your connected exchanges with full control.
                            </p>
                        </div>

                        <!-- Payment Gateway -->
                        <div style="background: rgba(102,126,234,0.1); border: 1px solid #667eea; border-radius: 8px; padding: 20px;">
                            <h4 style="color: #667eea; margin-bottom: 15px;">üí≥ Payment Gateway</h4>
                            <ul style="color: #b8c6db; font-size: 0.85rem; line-height: 1.8; margin: 0; padding-left: 20px;">
                                <li>International Payments - Skip banks, send crypto direct</li>
                                <li>Remittances - Cross-border transfers</li>
                                <li>Pay Contractors - Send USDT to contractor's wallet</li>
                                <li>Pay Suppliers - Send BTC to supplier's address</li>
                                <li>Employee Payments - Pay salary in crypto</li>
                                <li>Send to Friends/Family - Send XRP to anyone's wallet</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Tab Switcher -->
                <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                    <button id="tab-rebalance" onclick="switchTab('rebalance')" class="btn" style="flex: 1; padding: 15px; background: linear-gradient(45deg, #00ff88 0%, #00d4ff 100%); font-size: 1rem;">
                        üìä Rebalance My Exchanges
                    </button>
                    <button id="tab-payment" onclick="switchTab('payment')" class="btn" style="flex: 1; padding: 15px; background: rgba(102,126,234,0.3); font-size: 1rem;">
                        üí≥ Send External Payment
                    </button>
                </div>

                <!-- Tab 1: Rebalance My Exchanges -->
                <div id="rebalance-form" class="stat-card">
                    <h4 style="color: #00ff88; margin-bottom: 25px;">üìä Rebalance Between My Exchanges</h4>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 30px;">
                        <div class="form-group">
                            <label>From Exchange (Source)</label>
                            <select id="rebalanceFromExchange" onchange="autoCalculateTransfer()">
                                <option value="">Select Source Exchange</option>
                                <option value="chainex">ChainEX</option>
                                <option value="valr">VALR</option>
                                <option value="luno">Luno</option>
                                <option value="altcointrader">AltCoinTrader</option>
                                <option value="binance">Binance</option>
                                <option value="kraken">Kraken</option>
                                <option value="bybit">Bybit</option>
                                <option value="okx">OKX</option>
                                <option value="mexc">MEXC</option>
                                <option value="kucoin">KuCoin</option>
                                <option value="htx">HTX</option>
                                <option value="bitget">Bitget</option>
                                <option value="bitmart">BitMart</option>
                                <option value="bitrue">Bitrue</option>
                                <option value="gemini">Gemini</option>
                                <option value="coincatch">CoinCatch</option>
                                <option value="bingx">BingX</option>
                                <option value="ascendex">AscendEX</option>
                                <option value="gateio">Gate.io</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>To Exchange (Destination)</label>
                            <select id="rebalanceToExchange" onchange="autoCalculateTransfer()">
                                <option value="">Select Destination Exchange</option>
                                <option value="chainex">ChainEX</option>
                                <option value="valr">VALR</option>
                                <option value="luno">Luno</option>
                                <option value="altcointrader">AltCoinTrader</option>
                                <option value="binance">Binance</option>
                                <option value="kraken">Kraken</option>
                                <option value="bybit">Bybit</option>
                                <option value="okx">OKX</option>
                                <option value="mexc">MEXC</option>
                                <option value="kucoin">KuCoin</option>
                                <option value="htx">HTX</option>
                                <option value="bitget">Bitget</option>
                                <option value="bitmart">BitMart</option>
                                <option value="bitrue">Bitrue</option>
                                <option value="gemini">Gemini</option>
                                <option value="coincatch">CoinCatch</option>
                                <option value="bingx">BingX</option>
                                <option value="ascendex">AscendEX</option>
                                <option value="gateio">Gate.io</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Cryptocurrency to Transfer</label>
                            <select id="rebalanceCrypto" onchange="autoCalculateTransfer()">
                                <option value="XRP">XRP (Fast, Low Fees)</option>
                                <option value="XLM">XLM (Fast, Low Fees)</option>
                                <option value="TRX">TRX (Fast, Low Fees)</option>
                                <option value="LTC">LTC (Medium Speed)</option>
                                <option value="USDT">USDT-TRC20 (Stable)</option>
                                <option value="BTC">BTC</option>
                                <option value="ETH">ETH</option>
                                <option value="USDT">USDT-TRC20</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Amount (in crypto units)</label>
                            <input type="number" id="rebalanceAmount" placeholder="e.g., 1000 XRP" min="1" step="0.01" oninput="autoCalculateTransfer()">
                            <div style="color: #888; font-size: 0.7rem; margin-top: 4px;">
                                Enter amount in the cryptocurrency selected above
                            </div>
                        </div>
                    </div>

                    <button onclick="executeRebalance()" class="btn" style="width: 100%; margin-top: 22px; background: linear-gradient(45deg, #00ff88 0%, #00d4ff 100%); font-size: 0.95rem; padding: 10px;">
                        üîÑ Transfer & Rebalance
                    </button>
                </div>

                <!-- Tab 2: Send External Payment -->
                <div id="payment-form" class="stat-card" style="display: none;">
                    <h4 style="color: #667eea; margin-bottom: 25px;">üí≥ Send Crypto Payment</h4>

                    <!-- Row 1: From, Crypto, Amount -->
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 30px; margin-bottom: 20px;">
                        <div class="form-group">
                            <label>From Exchange (Source)</label>
                            <select id="paymentFromExchange" onchange="savePaymentField('fromExchange', this.value); autoCalculateTransfer();">
                                <option value="">Select Source Exchange</option>
                                <option value="chainex">ChainEX</option>
                                <option value="valr">VALR</option>
                                <option value="luno">Luno</option>
                                <option value="altcointrader">AltCoinTrader</option>
                                <option value="binance">Binance</option>
                                <option value="kraken">Kraken</option>
                                <option value="bybit">Bybit</option>
                                <option value="okx">OKX</option>
                                <option value="mexc">MEXC</option>
                                <option value="kucoin">KuCoin</option>
                                <option value="htx">HTX</option>
                                <option value="bitget">Bitget</option>
                                <option value="bitmart">BitMart</option>
                                <option value="bitrue">Bitrue</option>
                                <option value="gemini">Gemini</option>
                                <option value="coincatch">CoinCatch</option>
                                <option value="bingx">BingX</option>
                                <option value="ascendex">AscendEX</option>
                                <option value="gateio">Gate.io</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Cryptocurrency to Send</label>
                            <select id="paymentCrypto" onchange="savePaymentField('crypto', this.value); autoCalculateTransfer();">
                                <option value="XRP">XRP (Fast, Low Fees)</option>
                                <option value="XLM">XLM (Fast, Low Fees)</option>
                                <option value="TRX">TRX (Fast, Low Fees)</option>
                                <option value="LTC">LTC</option>
                                <option value="BTC">BTC</option>
                                <option value="ETH">ETH</option>
                                <option value="USDT">USDT-TRC20</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Amount (in crypto units)</label>
                            <input type="number" id="paymentAmount" placeholder="e.g., 500 USDT" min="1" step="0.01" oninput="savePaymentField('amount', this.value); autoCalculateTransfer();">
                            <div style="color: #888; font-size: 0.7rem; margin-top: 4px;">
                                Enter amount in the cryptocurrency selected above
                            </div>
                        </div>
                    </div>

                    <!-- Row 2: Recipient Address, Tag, Description -->
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 30px;">
                        <div class="form-group">
                            <label>Recipient Address</label>
                            <input type="text" id="paymentAddress" placeholder="Enter recipient's wallet address" oninput="savePaymentField('address', this.value)">
                        </div>

                        <div class="form-group">
                            <label>Recipient Tag/Memo (Optional)</label>
                            <input type="text" id="paymentTag" placeholder="Required for XRP, XLM" oninput="savePaymentField('tag', this.value)">
                            <div style="color: #888; font-size: 0.7rem; margin-top: 4px;">
                                Required for XRP and XLM transfers
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Payment Description (Optional)</label>
                            <input type="text" id="paymentDescription" placeholder="e.g., Invoice #123 - Contractor payment" oninput="savePaymentField('description', this.value)">
                            <div style="color: #888; font-size: 0.7rem; margin-top: 4px;">
                                For your records only
                            </div>
                        </div>
                    </div>

                    <button onclick="executeCryptoPayment()" class="btn" style="width: 100%; margin-top: 22px; background: linear-gradient(45deg, #667eea 0%, #764ba2 100%); font-size: 0.95rem; padding: 10px;">
                        üöÄ Send Payment
                    </button>
                </div>

                <!-- Smart Transfer Results -->
                <div id="smart-transfer-results" style="display: none; margin-top: 20px;">
                    <!-- Results will be populated here -->
                </div>
            </div>

            <!-- AUTO-TRADING Opportunities Display -->
            <div id="opportunities-section" style="display: none; margin-bottom: 30px;">
                <h3 style="color: #00ff88; margin-bottom: 15px;">ü§ñ AUTO-TRADING Opportunities (17 Assets)</h3>
                <div id="opportunities-list">
                    <!-- Will be populated with opportunities -->
                </div>
            </div>

            <!-- Transfer History -->
            <div id="transfer-history-section" style="display: none; margin-bottom: 30px;">
                <h3 style="color: #ffb347; margin-bottom: 15px;">üìä Transfer History</h3>
                <div id="transfer-history-list">
                    <!-- Will be populated with transfer history -->
                </div>
            </div>

            <!-- Active Transfers Monitor -->
            <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                <h4 style="color: #ffb347; margin-bottom: 15px;">üîÑ Active Transfers</h4>
                <div id="activeTransfers" style="max-height: 200px; overflow-y: auto;">
                    <div style="text-align: center; color: #888; padding: 20px;">
                        No active transfers. Configure routes and enable transfer arbitrage to start.
                    </div>
                </div>
            </div>

            <!-- Transfer Calculator - Auto-calculating -->
            <div class="stat-card">
                <h4 style="color: #00d4ff; margin-bottom: 15px;">üßÆ Live Transfer Calculator</h4>
                <div id="calculatorSource" style="color: #888; font-size: 0.85rem; margin-bottom: 15px; padding: 10px; background: rgba(0,212,255,0.1); border-radius: 6px; display: none;">
                    <!-- Will show active calculation source -->
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px;">
                    <div class="form-group">
                        <label>Buy Price (Source)</label>
                        <input type="number" id="buyPrice" placeholder="Auto-fetching..." step="0.01" readonly style="background: rgba(255,255,255,0.05); cursor: not-allowed;">
                        <div style="color: #888; font-size: 0.7rem; margin-top: 4px;">
                            Live price from source exchange
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Sell Price (Destination)</label>
                        <input type="number" id="sellPrice" placeholder="Auto-fetching..." step="0.01" readonly style="background: rgba(255,255,255,0.05); cursor: not-allowed;">
                        <div style="color: #888; font-size: 0.7rem; margin-top: 4px;">
                            Live price from destination exchange
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Amount</label>
                        <input type="number" id="calcAmount" placeholder="Auto-fetching..." step="1" readonly style="background: rgba(255,255,255,0.05); cursor: not-allowed;">
                        <div style="color: #888; font-size: 0.7rem; margin-top: 4px;">
                            From transfer form above
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Network Fee (Est.)</label>
                        <input type="number" id="networkFee" placeholder="Auto-calculating..." step="0.01" readonly style="background: rgba(255,255,255,0.05); cursor: not-allowed;">
                        <div style="color: #888; font-size: 0.7rem; margin-top: 4px;">
                            Estimated withdrawal fee
                        </div>
                    </div>
                </div>
                <div id="calculationResult" style="margin-top: 15px; padding: 15px; background: rgba(0,255,136,0.1); border-radius: 8px; display: none;">
                    <!-- Results will appear here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Transfer Arbitrage About Modal -->
    <div id="transferAboutModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; justify-content: center; align-items: center;">
        <div style="background: linear-gradient(135deg, #0c0c1e 0%, #161632 100%); padding: 30px; border-radius: 15px; max-width: 600px; width: 90%; max-height: 90vh; border: 2px solid #00d4ff; box-shadow: 0 10px 40px rgba(0,212,255,0.3); position: relative; overflow-y: auto;">
            <!-- Close Button -->
            <button onclick="closeTransferAboutModal()" style="position: absolute; top: 15px; right: 15px; background: rgba(255,68,68,0.9); border: none; color: #fff; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; font-size: 1.5rem; font-weight: bold; display: flex; align-items: center; justify-content: center; transition: all 0.3s; z-index: 1;" onmouseover="this.style.background='rgba(255,68,68,1)'; this.style.transform='scale(1.1)'" onmouseout="this.style.background='rgba(255,68,68,0.9)'; this.style.transform='scale(1)'">
                √ó
            </button>

            <!-- Header -->
            <h2 style="color: #00d4ff; margin: 0 0 20px 0; padding-right: 40px; font-size: 1.5rem;">üì¶ Transfer Arbitrage Explained</h2>

            <!-- Content -->
            <div style="color: #b8c6db; line-height: 1.6; font-size: 0.95rem; padding-right: 5px;">
                <!-- Core Concept -->
                <div style="background: rgba(0,255,136,0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #00ff88; margin-bottom: 15px;">
                    <strong style="color: #00ff88; display: block; margin-bottom: 8px;">üéØ Core Concept: Physical Arbitrage</strong>
                    <div style="font-size: 0.9rem;">
                        <strong>Transfer Arbitrage</strong> means physically moving crypto between exchanges to profit from price differences. You temporarily convert USDT ‚Üí Crypto ‚Üí Transfer ‚Üí Crypto ‚Üí USDT (with MORE profit!)
                    </div>
                </div>

                <!-- Complete Example -->
                <div style="background: rgba(0,212,255,0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #00d4ff; margin-bottom: 15px;">
                    <strong style="color: #00d4ff; display: block; margin-bottom: 8px;">üí∞ Complete Example - XRP Arbitrage:</strong>
                    <div style="font-family: monospace; font-size: 0.85rem; line-height: 1.8;">
                        <strong style="color: #ffb347;">Setup:</strong><br>
                        ‚Ä¢ You have $2,000 USDT on Binance<br>
                        ‚Ä¢ You have XRP deposit address configured on Kraken<br><br>

                        <strong style="color: #00ff88;">üìä Step 1: Scanner Finds Opportunity</strong><br>
                        ‚Ä¢ XRP on Binance: $2.00 (cheaper)<br>
                        ‚Ä¢ XRP on Kraken: $2.08 (4% higher)<br><br>

                        <strong style="color: #00ff88;">üõí Step 2: Buy on Binance</strong><br>
                        ‚Ä¢ Buy 1,000 XRP @ $2.00 = $2,000 USDT spent<br><br>

                        <strong style="color: #00ff88;">üì§ Step 3: Transfer to Kraken</strong><br>
                        ‚Ä¢ Withdraw 1,000 XRP from Binance<br>
                        ‚Ä¢ Send to your Kraken XRP deposit address<br>
                        ‚Ä¢ Network fee: $0.02 | Time: 3 minutes<br><br>

                        <strong style="color: #00ff88;">üí∏ Step 4: Sell on Kraken</strong><br>
                        ‚Ä¢ 1,000 XRP arrives on Kraken<br>
                        ‚Ä¢ Sell @ $2.08 = $2,080 USDT received<br><br>

                        <strong style="color: #ffb347;">‚úÖ Profit:</strong><br>
                        Revenue: $2,080 - Cost: $2,000.02 = <strong>$79.98 profit (4%)</strong>
                    </div>
                </div>

                <!-- Key Requirements -->
                <p style="margin: 0 0 10px 0;">
                    <strong style="color: #ffb347; font-size: 1.1rem;">üîë What You Need:</strong>
                </p>
                <ol style="margin: 0 0 15px 0; padding-left: 25px; font-size: 0.9rem;">
                    <li style="margin-bottom: 8px;"><strong style="color: #00ff88;">USDT Funded on Exchanges</strong> - Need $2,000+ USDT per exchange to buy crypto when opportunities appear</li>
                    <li style="margin-bottom: 8px;"><strong style="color: #00ff88;">Deposit Addresses Configured</strong> - Must set up XRP/XLM/TRX deposit addresses on each exchange (this is where transfers arrive!)</li>
                    <li style="margin-bottom: 8px;"><strong style="color: #00ff88;">API Keys</strong> - Exchange API access for automated trading</li>
                    <li style="margin-bottom: 8px;"><strong style="color: #00ff88;">Fast/Cheap Cryptos</strong> - Use XRP, XLM, or TRX for quick, low-cost transfers</li>
                </ol>

                <!-- Money Flow -->
                <div style="background: rgba(255,179,71,0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #ffb347; margin-bottom: 15px;">
                    <strong style="color: #ffb347; display: block; margin-bottom: 8px;">üí° Money Flow (You're NOT permanently holding crypto!):</strong>
                    <div style="font-family: monospace; font-size: 0.85rem; text-align: center; color: #00ff88;">
                        USDT (Binance) ‚Üí Buy XRP ‚Üí Transfer XRP ‚Üí Sell XRP ‚Üí USDT (Kraken)<br>
                        <span style="color: #ffb347;">‚Üë Start with $2,000 | End with $2,080 = $80 profit! ‚Üë</span>
                    </div>
                </div>

                <!-- Best Cryptos -->
                <p style="margin: 0 0 10px 0;">
                    <strong style="color: #ffb347;">‚ö° Best Cryptos for Transfer Arb:</strong>
                </p>
                <ul style="margin: 0 0 15px 0; padding-left: 25px; font-size: 0.9rem;">
                    <li style="margin-bottom: 8px;"><strong style="color: #00ff88;">ü•á XRP</strong> - 3 min transfer, $0.02 fee (BEST CHOICE)</li>
                    <li style="margin-bottom: 8px;"><strong style="color: #00ff88;">ü•á XLM</strong> - 5 min transfer, $0.01 fee (BEST CHOICE)</li>
                    <li style="margin-bottom: 8px;"><strong style="color: #00ff88;">ü•á TRX</strong> - 3 min transfer, $1 fee (GOOD)</li>
                    <li style="margin-bottom: 8px;"><strong style="color: #ffb347;">ü•à LTC</strong> - 15 min transfer, $0.10 fee (OK)</li>
                    <li style="margin-bottom: 8px;"><strong style="color: #ff6b6b;">‚ùå BTC</strong> - 30+ min, $5+ fee (TOO SLOW)</li>
                    <li style="margin-bottom: 8px;"><strong style="color: #ff6b6b;">‚ùå ETH</strong> - 10 min, $8+ fee (TOO EXPENSIVE)</li>
                </ul>

                <!-- Key Risks -->
                <div style="background: rgba(255,107,107,0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #ff6b6b; margin-bottom: 0;">
                    <strong style="color: #ff6b6b; display: block; margin-bottom: 8px;">‚ö†Ô∏è Important Risks:</strong>
                    <ul style="margin: 5px 0 0 0; padding-left: 20px; font-size: 0.85rem;">
                        <li style="margin-bottom: 5px;"><strong>Price Movement</strong> - Price may drop during transfer (XRP 3 min = lower risk)</li>
                        <li style="margin-bottom: 5px;"><strong>Transfer Delays</strong> - Network congestion could slow transfers</li>
                        <li style="margin-bottom: 5px;"><strong>Fees Add Up</strong> - Exchange fees + network fees reduce profit</li>
                        <li style="margin-bottom: 5px;"><strong>Need Liquidity</strong> - Must be able to sell on destination exchange</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Execution Confirmation Modal -->
    <div id="executionConfirmationModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; justify-content: center; align-items: center;">
        <div style="background: linear-gradient(135deg, #0c0c1e 0%, #161632 100%); padding: 30px; border-radius: 15px; max-width: 600px; width: 90%; max-height: 90vh; border: 2px solid #ffb347; box-shadow: 0 10px 40px rgba(255,179,71,0.3); position: relative; overflow-y: auto;">
            <!-- Close Button -->
            <button onclick="closeExecutionConfirmation()" style="position: absolute; top: 15px; right: 15px; background: rgba(255,68,68,0.9); border: none; color: #fff; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; font-size: 1.5rem; font-weight: bold; display: flex; align-items: center; justify-content: center; transition: all 0.3s; z-index: 1;" onmouseover="this.style.background='rgba(255,68,68,1)'; this.style.transform='scale(1.1)'" onmouseout="this.style.background='rgba(255,68,68,0.9)'; this.style.transform='scale(1)'">
                √ó
            </button>

            <!-- Header -->
            <h2 style="color: #ffb347; margin: 0 0 20px 0; padding-right: 40px; font-size: 1.5rem;">‚ö†Ô∏è Confirm Live Execution</h2>

            <!-- Warning Banner -->
            <div style="background: rgba(255,68,68,0.15); padding: 15px; border-radius: 8px; border-left: 4px solid #ff4444; margin-bottom: 20px;">
                <strong style="color: #ff4444; display: block; margin-bottom: 8px;">üö® IMPORTANT - READ CAREFULLY</strong>
                <div style="color: #ffb8b8; font-size: 0.9rem; line-height: 1.5;">
                    This will execute a REAL trade with REAL money on live exchanges. This action is <strong>IRREVERSIBLE</strong>. Please review all details carefully before proceeding.
                </div>
            </div>

            <!-- Trade Details -->
            <div id="confirmationDetails" style="color: #b8c6db; line-height: 1.6; font-size: 0.95rem;">
                <!-- Will be populated dynamically -->
            </div>

            <!-- Estimated Timeline -->
            <div style="background: rgba(0,212,255,0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #00d4ff; margin-top: 20px;">
                <strong style="color: #00d4ff; display: block; margin-bottom: 8px;">‚è±Ô∏è Estimated Timeline</strong>
                <div id="confirmationTimeline" style="color: #b8c6db; font-size: 0.9rem;">
                    <!-- Will be populated dynamically -->
                </div>
            </div>

            <!-- Action Buttons -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 25px;">
                <button onclick="closeExecutionConfirmation()" style="background: rgba(255,68,68,0.2); border: 2px solid #ff4444; color: #ff4444; padding: 15px 20px; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: bold; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,68,68,0.3)'" onmouseout="this.style.background='rgba(255,68,68,0.2)'">
                    ‚ùå Cancel
                </button>
                <button onclick="confirmAndExecute()" style="background: linear-gradient(135deg, #00ff88 0%, #00d4ff 100%); border: none; color: #0c0c1e; padding: 15px 20px; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: bold; transition: all 0.3s; box-shadow: 0 4px 15px rgba(0,255,136,0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(0,255,136,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(0,255,136,0.3)'">
                    ‚úÖ Confirm & Execute
                </button>
            </div>
        </div>
    </div>

    <!-- Trade Logger Service (Shared across all strategies and 20 exchanges) -->
    <script src="/utils/trade-logger.js"></script>

    <script>
        // Transfer ARB Configuration
        const TRANSFER_CRYPTOS = [
            { symbol: 'XRP', meta: '‚ö° 3 min, $0.02 fee', fast: true, lowFee: true },
            { symbol: 'XLM', meta: '‚ö° 5 min, $0.01 fee', fast: true, lowFee: true },
            { symbol: 'TRX', meta: '‚ö° 3 min, $1 fee', fast: true, lowFee: true },
            { symbol: 'LTC', meta: '‚è±Ô∏è 15 min, $0.10 fee', fast: false, lowFee: true },
            { symbol: 'DOGE', meta: '‚è±Ô∏è 10 min, $2 fee', fast: true, lowFee: false },
            { symbol: 'BCH', meta: '‚è±Ô∏è 15 min, $0.05 fee', fast: false, lowFee: true },
            { symbol: 'USDT', meta: 'üíµ Stable, $1 fee', fast: true, lowFee: true },
            { symbol: 'USDC', meta: 'üíµ Stable, $3 fee', fast: true, lowFee: false },
            { symbol: 'BTC', meta: 'üê¢ 30+ min, $5+ fee', fast: false, lowFee: false },
            { symbol: 'ETH', meta: 'üê¢ 10 min, $8+ fee', fast: false, lowFee: false },
            { symbol: 'ADA', meta: '‚è±Ô∏è 10 min, $0.50 fee', fast: true, lowFee: true },
            { symbol: 'DOT', meta: '‚è±Ô∏è 12 min, $0.10 fee', fast: false, lowFee: true },
            { symbol: 'SOL', meta: '‚ö° 5 min, $0.01 fee', fast: true, lowFee: true },
            { symbol: 'ALGO', meta: '‚ö° 5 min, $0.01 fee', fast: true, lowFee: true },
            { symbol: 'MATIC', meta: '‚ö° 5 min, $0.10 fee', fast: true, lowFee: true },
            { symbol: 'AVAX', meta: '‚ö° 5 min, $0.20 fee', fast: true, lowFee: true },
            { symbol: 'ATOM', meta: '‚ö° 7 min, $0.02 fee', fast: true, lowFee: true }
        ];

        const TRANSFER_PRESETS = {
            'fast-cheap': {
                name: 'üöÄ Fast & Cheap',
                description: 'Recommended for Transfer ARB (3-5 min, low fees)',
                cryptos: ['XRP', 'XLM', 'TRX', 'SOL', 'ALGO', 'MATIC', 'AVAX', 'ATOM']
            },
            'stablecoins': {
                name: 'üíµ Stablecoins',
                description: 'No price risk during transfer',
                cryptos: ['USDT', 'USDC']
            },
            'all': {
                name: 'üìä All Cryptos',
                description: 'Maximum opportunities (includes slow transfers)',
                cryptos: TRANSFER_CRYPTOS.map(c => c.symbol)
            }
        };

        // Return to Platform Function
        function returnToPlatform() {
            // Set transfer toggle state to OFF
            localStorage.setItem('transferActive', 'false');

            // Navigate back to main platform
            window.location.href = '/';
        }

        // Initialize Crypto Selector
        function initializeCryptoSelector() {
            const section = document.getElementById('crypto-selection-section');

            section.innerHTML = `
                <!-- Include crypto selector component -->
                <div class="crypto-selection-container">
                    <div class="selection-header">
                        <h3>üì¶ Transfer ARB - Cryptocurrency Selection</h3>
                        <p class="selection-description">Select cryptocurrencies to scan for Transfer Arbitrage opportunities</p>
                    </div>

                    <div class="preset-section" style="margin-bottom: 20px;">
                        <h4 style="color: #ffb347;">üéØ Quick Select Presets</h4>
                        <div class="preset-buttons" style="display: flex; gap: 10px; flex-wrap: wrap;">
                            ${Object.entries(TRANSFER_PRESETS).map(([key, preset]) => `
                                <button onclick="selectPreset('${key}')" style="background: rgba(102,126,234,0.2); border: 1px solid #667eea; color: #667eea; padding: 10px 20px; border-radius: 8px; cursor: pointer;">
                                    <div><strong>${preset.name}</strong></div>
                                    <div style="font-size: 0.75rem; margin-top: 3px;">${preset.description}</div>
                                </button>
                            `).join('')}
                        </div>
                    </div>

                    <div class="crypto-grid" id="crypto-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 10px; margin-bottom: 20px; max-height: 400px; overflow-y: auto; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                        ${TRANSFER_CRYPTOS.map(crypto => `
                            <div class="crypto-item" onclick="toggleCryptoSelection('${crypto.symbol}')" style="background: rgba(255,255,255,0.05); border: 2px solid transparent; border-radius: 8px; padding: 12px; cursor: pointer; display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="crypto-${crypto.symbol}" onclick="event.stopPropagation();" onchange="toggleCryptoSelection('${crypto.symbol}')">
                                <div style="flex: 1;">
                                    <div style="color: white; font-weight: 600;">${crypto.symbol}</div>
                                    <div style="color: #888; font-size: 0.75rem;">${crypto.meta}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <div class="selection-summary" style="background: rgba(0,212,255,0.1); border: 1px solid #00d4ff; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                            <div style="text-align: center;">
                                <span style="display: block; font-size: 2rem; font-weight: bold; color: #00ff88;" id="selected-count">0</span>
                                <span style="display: block; font-size: 0.85rem; color: #b8c6db;">Cryptocurrencies Selected</span>
                            </div>
                            <div style="text-align: center;">
                                <span style="display: block; font-size: 2rem; font-weight: bold; color: #00d4ff;" id="exchanges-count">0</span>
                                <span style="display: block; font-size: 0.85rem; color: #b8c6db;">Exchanges Connected</span>
                            </div>
                            <div style="text-align: center;">
                                <span style="display: block; font-size: 2rem; font-weight: bold; color: #ffb347;" id="deposit-count">0</span>
                                <span style="display: block; font-size: 0.85rem; color: #b8c6db;">Deposit Addresses Needed</span>
                            </div>
                            <div style="text-align: center;">
                                <span style="display: block; font-size: 2rem; font-weight: bold; color: #ff6b6b;" id="routes-count">0</span>
                                <span style="display: block; font-size: 0.85rem; color: #b8c6db;">Possible Routes</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Load saved selection
            loadCryptoSelection();
        }

        let selectedCryptos = [];

        function loadCryptoSelection() {
            console.log('üì• Loading crypto selection from localStorage...');
            const saved = localStorage.getItem('cryptos_transfer');
            console.log('üíæ Saved cryptos:', saved);

            if (saved) {
                selectedCryptos = JSON.parse(saved);
                console.log('‚úÖ Loaded selected cryptos:', selectedCryptos);

                selectedCryptos.forEach(crypto => {
                    const checkbox = document.getElementById(`crypto-${crypto}`);
                    if (checkbox) {
                        checkbox.checked = true;
                        checkbox.closest('.crypto-item').style.background = 'rgba(102,126,234,0.2)';
                        checkbox.closest('.crypto-item').style.borderColor = '#667eea';
                    }
                });
                updateSelectionSummary();

                // Show deposit address section if cryptos already selected
                if (selectedCryptos.length > 0) {
                    console.log('üì¨ Generating deposit address section for', selectedCryptos.length, 'cryptos');
                    generateDepositAddressSection();
                }
            } else {
                console.log('‚ÑπÔ∏è No saved crypto selection found');
            }
        }

        function selectPreset(presetKey) {
            console.log('üéØ Preset selected:', presetKey);
            const preset = TRANSFER_PRESETS[presetKey];
            selectedCryptos = [...preset.cryptos];
            console.log('üìã Preset cryptos:', selectedCryptos);

            // Uncheck all first
            document.querySelectorAll('.crypto-item input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
                cb.closest('.crypto-item').style.background = 'rgba(255,255,255,0.05)';
                cb.closest('.crypto-item').style.borderColor = 'transparent';
            });

            // Check selected
            selectedCryptos.forEach(crypto => {
                const checkbox = document.getElementById(`crypto-${crypto}`);
                if (checkbox) {
                    checkbox.checked = true;
                    checkbox.closest('.crypto-item').style.background = 'rgba(102,126,234,0.2)';
                    checkbox.closest('.crypto-item').style.borderColor = '#667eea';
                }
            });

            updateSelectionSummary();

            // Auto-save to localStorage
            console.log('üíæ Auto-saving preset selection:', selectedCryptos);
            localStorage.setItem('cryptos_transfer', JSON.stringify(selectedCryptos));

            // Auto-trigger deposit section if exchanges are connected
            if (selectedCryptos.length > 0 && getConnectedExchanges().length > 0) {
                console.log('üì¨ Auto-generating deposit address section...');
                generateDepositAddressSection();
            }
        }

        function toggleCryptoSelection(symbol) {
            const checkbox = document.getElementById(`crypto-${symbol}`);
            checkbox.checked = !checkbox.checked;

            if (checkbox.checked) {
                if (!selectedCryptos.includes(symbol)) {
                    selectedCryptos.push(symbol);
                }
                checkbox.closest('.crypto-item').style.background = 'rgba(102,126,234,0.2)';
                checkbox.closest('.crypto-item').style.borderColor = '#667eea';
            } else {
                selectedCryptos = selectedCryptos.filter(c => c !== symbol);
                checkbox.closest('.crypto-item').style.background = 'rgba(255,255,255,0.05)';
                checkbox.closest('.crypto-item').style.borderColor = 'transparent';
            }

            updateSelectionSummary();

            // Auto-save to localStorage
            console.log('üíæ Auto-saving crypto selection:', selectedCryptos);
            localStorage.setItem('cryptos_transfer', JSON.stringify(selectedCryptos));

            // Auto-trigger deposit section if exchanges are connected and cryptos selected
            if (selectedCryptos.length > 0 && getConnectedExchanges().length > 0) {
                console.log('üì¨ Auto-generating deposit address section...');
                generateDepositAddressSection();
            }
        }

        function updateSelectionSummary() {
            const connectedExchanges = getConnectedExchanges().length;
            console.log(`üìä Updating summary: ${selectedCryptos.length} cryptos, ${connectedExchanges} exchanges`);

            document.getElementById('selected-count').textContent = selectedCryptos.length;
            document.getElementById('exchanges-count').textContent = connectedExchanges;
            document.getElementById('deposit-count').textContent = selectedCryptos.length * connectedExchanges;
            document.getElementById('routes-count').textContent = (connectedExchanges * (connectedExchanges - 1)) * selectedCryptos.length;
        }

        // Scan for transfer opportunities
        async function scanTransferOpportunities() {
            console.log('üîç Starting Transfer ARB scan...');

            const connectedExchanges = getConnectedExchanges();

            if (connectedExchanges.length < 2) {
                alert('‚ö†Ô∏è Please connect at least 2 exchanges to scan for opportunities.\n\nGo to Strategy API Setup ‚Üí Transfer ARB');
                return;
            }

            if (selectedCryptos.length === 0) {
                alert('‚ö†Ô∏è Please select cryptocurrencies first');
                return;
            }

            // Show loading state
            const btn = document.getElementById('scanOpportunitiesBtn');
            btn.innerHTML = '‚è≥ Scanning opportunities...';
            btn.disabled = true;

            // Get risk settings for filtering
            const minPriceDiff = parseFloat(document.getElementById('minPriceDiff').value);
            const maxTransferAmount = parseFloat(document.getElementById('maxTransferAmount').value);
            const maxTransferTime = parseFloat(document.getElementById('maxTransferTime').value);

            try {
                // This would normally call backend API to get real prices
                // For now, show the structure with placeholder data
                const allOpportunities = await getMockOpportunities(connectedExchanges);

                // Filter by risk settings
                const filteredOpportunities = allOpportunities.filter(opp => {
                    const meetsProfit = opp.netProfitPercent >= minPriceDiff;
                    const meetsAmount = opp.usdtToSpend <= maxTransferAmount;
                    const meetsTime = opp.estimatedTransferTime <= maxTransferTime;

                    return meetsProfit && meetsAmount && meetsTime && opp.profitable;
                });

                console.log(`üìä Filtered ${filteredOpportunities.length} of ${allOpportunities.length} opportunities based on risk settings`);

                displayOpportunities(filteredOpportunities);

                btn.innerHTML = `‚úÖ Scan Complete - Found ${filteredOpportunities.length} opportunities`;
                setTimeout(() => {
                    btn.innerHTML = 'üîç Scan Transfer Opportunities';
                    btn.disabled = false;
                }, 3000);

            } catch (error) {
                console.error('‚ùå Scan failed:', error);
                alert('Scan failed: ' + error.message);
                btn.innerHTML = 'üîç Scan Transfer Opportunities';
                btn.disabled = false;
            }
        }

        // Get REAL opportunities from backend scanner
        async function getMockOpportunities(connectedExchanges) {
            console.log('üìä Fetching REAL opportunities for', connectedExchanges.length, 'exchanges');

            try {
                // Get risk settings
                const minProfit = parseFloat(document.getElementById('minPriceDiff').value);

                // Build query params
                const params = new URLSearchParams({
                    cryptos: JSON.stringify(selectedCryptos),
                    exchanges: JSON.stringify(connectedExchanges),
                    minProfit: minProfit
                });

                console.log('üîç Calling real scanner API...');
                console.log('   Cryptos:', selectedCryptos);
                console.log('   Exchanges:', connectedExchanges);
                console.log('   Min Profit:', minProfit + '%');

                // Call REAL backend scanner API with GET
                const response = await fetch(`/api/v1/transfer-arb/scan?${params.toString()}`);

                if (!response.ok) {
                    throw new Error(`Scanner API error: ${response.status}`);
                }

                const data = await response.json();

                if (data.success) {
                    console.log(`‚úÖ Found ${data.data.opportunities.length} REAL opportunities`);
                    console.log(`üìä Scanned ${data.data.routesScanned} routes`);

                    if (data.data.opportunities.length > 0) {
                        console.log(`üíé Best opportunity: ${data.data.opportunities[0].crypto} from ${data.data.opportunities[0].fromExchange} ‚Üí ${data.data.opportunities[0].toExchange}`);
                        console.log(`   Profit: $${data.data.opportunities[0].netProfit.toFixed(2)} (${data.data.opportunities[0].netProfitPercent.toFixed(2)}%)`);
                    }

                    return data.data.opportunities;
                } else {
                    throw new Error(data.error || 'Scanner failed');
                }

            } catch (error) {
                console.error('‚ùå Real scanner failed:', error);

                // ‚ö†Ô∏è SAFETY: Never show placeholder data for real money trading
                // Stop auto-execute if it's running
                if (isAutoExecuteActive) {
                    stopContinuousScan();
                    alert('‚ö†Ô∏è AUTO-EXECUTE STOPPED\n\nScanner Error: ' + error.message + '\n\nCannot scan for opportunities. Please check:\n- Exchange API configuration\n- Internet connection\n- Server status');
                } else {
                    alert('‚ö†Ô∏è Scanner Error\n\n' + error.message + '\n\nCannot show opportunities. Please check your exchange API configuration.');
                }

                return []; // Return empty array, never fake data
            }
        }

        // Show confirmation dialog before executing
        async function executeTransfer(opportunity) {
            console.log('‚ö†Ô∏è Showing confirmation dialog for:', opportunity);
            showExecutionConfirmation(opportunity);
        }

        // Execute transfer arbitrage opportunity (direct execution after confirmation)
        async function executeTransferDirect(opportunity) {
            console.log('üöÄ EXECUTING TRANSFER:', opportunity);

            try {
                // Get exchange credentials from localStorage
                const fromExchangeCreds = {
                    apiKey: localStorage.getItem(`${opportunity.fromExchange}_transfer_api`) || '',
                    apiSecret: localStorage.getItem(`${opportunity.fromExchange}_transfer_secret`) || ''
                };

                const toExchangeCreds = {
                    apiKey: localStorage.getItem(`${opportunity.toExchange}_transfer_api`) || '',
                    apiSecret: localStorage.getItem(`${opportunity.toExchange}_transfer_secret`) || ''
                };

                // Get deposit address and network
                const depositAddress = localStorage.getItem(`deposit_${opportunity.toExchange}_${opportunity.crypto}_deposit`) || '';
                const depositTag = localStorage.getItem(`deposit_${opportunity.toExchange}_${opportunity.crypto}_tag`) || '';
                const fromNetwork = localStorage.getItem(`deposit_${opportunity.fromExchange}_${opportunity.crypto}_network`) || '';
                const toNetwork = localStorage.getItem(`deposit_${opportunity.toExchange}_${opportunity.crypto}_network`) || '';

                // Validate credentials and deposit address
                if (!fromExchangeCreds.apiKey || !fromExchangeCreds.apiSecret) {
                    throw new Error(`Missing API credentials for ${opportunity.fromExchange}`);
                }

                if (!toExchangeCreds.apiKey || !toExchangeCreds.apiSecret) {
                    throw new Error(`Missing API credentials for ${opportunity.toExchange}`);
                }

                if (!depositAddress) {
                    throw new Error(`Missing deposit address for ${opportunity.toExchange} ${opportunity.crypto}`);
                }

                // CRITICAL: Validate network configuration
                if (!fromNetwork) {
                    throw new Error(`‚ö†Ô∏è NETWORK NOT CONFIGURED!\n\nPlease configure the withdrawal network for ${opportunity.fromExchange} ${opportunity.crypto} in deposit settings.\n\nGo to: Configure Deposit Addresses ‚Üí Select network`);
                }

                if (!toNetwork) {
                    throw new Error(`‚ö†Ô∏è NETWORK NOT CONFIGURED!\n\nPlease configure the deposit network for ${opportunity.toExchange} ${opportunity.crypto} in deposit settings.\n\nGo to: Configure Deposit Addresses ‚Üí Select network`);
                }

                // CRITICAL: Validate network match
                if (fromNetwork !== toNetwork) {
                    throw new Error(`üö® NETWORK MISMATCH - EXECUTION BLOCKED!\n\n` +
                        `Withdrawal Network: ${fromNetwork}\n` +
                        `Deposit Network: ${toNetwork}\n\n` +
                        `These networks MUST match or funds will be PERMANENTLY LOST!\n\n` +
                        `Please update your deposit address configuration to use matching networks.`);
                }

                console.log(`‚úÖ Network validation passed: ${fromNetwork} ‚Üí ${toNetwork}`);

                console.log('‚úÖ Credentials validated, calling execution API...');

                // Call execution API
                const response = await fetch('/api/v1/transfer-arb/execute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        opportunity: opportunity,
                        credentials: {
                            fromExchange: fromExchangeCreds,
                            toExchange: toExchangeCreds,
                            depositAddress: depositAddress,
                            depositTag: depositTag || undefined,
                            fromNetwork: fromNetwork,
                            toNetwork: toNetwork
                        }
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || `Execution failed: ${response.status}`);
                }

                const result = await response.json();

                if (result.success) {
                    console.log('‚úÖ TRANSFER EXECUTED SUCCESSFULLY:', result.data);

                    // Show success notification
                    showNotification('success', `Transfer executed! Profit: $${result.data.actualProfit.toFixed(2)}`);

                    // üìä Log to backend using shared service
                    logTradeToBackend({
                        strategy: 'transfer',
                        exchange: opportunity.fromExchange,
                        asset: opportunity.crypto,
                        buyExchange: opportunity.fromExchange,
                        sellExchange: opportunity.toExchange,
                        buyPrice: result.data.buyPrice || 0,
                        sellPrice: result.data.sellPrice || 0,
                        amount: result.data.amount || opportunity.amount || 0,
                        profit: result.data.actualProfit || 0,
                        fees: result.data.totalFees || 0,
                        metadata: {
                            transferTime: result.data.transferTime,
                            network: result.data.network
                        }
                    }).catch(e => console.warn('Logging failed:', e));

                    // Refresh transfer history
                    loadTransferHistory();
                } else {
                    throw new Error(result.error?.message || 'Execution failed');
                }

            } catch (error) {
                console.error('‚ùå EXECUTION FAILED:', error);
                showNotification('error', `Execution failed: ${error.message}`);
            }
        }

        // Show notification to user
        function showNotification(type, message) {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? 'rgba(0,255,136,0.2)' : 'rgba(255,107,107,0.2)'};
                border: 1px solid ${type === 'success' ? '#00ff88' : '#ff6b6b'};
                border-radius: 8px;
                padding: 15px 20px;
                color: ${type === 'success' ? '#00ff88' : '#ff6b6b'};
                font-weight: bold;
                z-index: 10000;
                animation: slideIn 0.3s ease-out;
            `;
            notification.textContent = message;

            document.body.appendChild(notification);

            // Remove after 5 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }

        // Display opportunities
        function displayOpportunities(opportunities) {
            const section = document.getElementById('opportunities-section');
            const list = document.getElementById('opportunities-list');

            if (opportunities.length === 0) {
                section.style.display = 'block';
                list.innerHTML = `
                    <div style="background: rgba(255,179,71,0.1); border: 1px solid #ffb347; border-radius: 8px; padding: 20px; text-align: center;">
                        <p style="color: #ffb347; margin-bottom: 10px;">üìä No profitable opportunities found</p>
                        <p style="color: #b8c6db; font-size: 0.9rem;">
                            This could mean:<br>
                            ‚Ä¢ Price spreads are too small<br>
                            ‚Ä¢ Network fees exceed potential profit<br>
                            ‚Ä¢ No API keys configured (showing demo mode)
                        </p>
                    </div>
                `;

                // Also show manual trading section
                const manualSection = document.getElementById('manual-trading-section');
                if (manualSection) manualSection.style.display = 'block';

                return;
            }

            section.style.display = 'block';

            // Also show manual trading section when auto-trading opportunities are shown
            const manualSection = document.getElementById('manual-trading-section');
            if (manualSection) manualSection.style.display = 'block';

            list.innerHTML = opportunities.map(opp => `
                <div class="stat-card" style="margin-bottom: 15px; ${opp.isPlaceholder ? 'border: 2px dashed #ffb347;' : ''}">
                    ${opp.isPlaceholder ? '<div style="background: rgba(255,179,71,0.2); padding: 5px; text-align: center; color: #ffb347; font-size: 0.85rem; border-radius: 5px; margin-bottom: 10px;">üìã PLACEHOLDER - Configure API keys for real data</div>' : ''}
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <div>
                            <h4 style="color: #00ff88; margin: 0;">${opp.crypto} Transfer</h4>
                            <p style="color: #b8c6db; margin: 5px 0; font-size: 0.9rem;">
                                ${opp.fromExchange.toUpperCase()} ‚Üí ${opp.toExchange.toUpperCase()}
                            </p>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #00ff88;">
                                +$${opp.netProfit.toFixed(2)}
                            </div>
                            <div style="font-size: 0.9rem; color: #ffb347;">
                                ${opp.netProfitPercent.toFixed(2)}% profit
                            </div>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 15px;">
                        <div>
                            <div style="color: #888; font-size: 0.75rem;">Buy Price</div>
                            <div style="color: white; font-weight: 600;">$${opp.buyPrice.toFixed(4)}</div>
                        </div>
                        <div>
                            <div style="color: #888; font-size: 0.75rem;">Sell Price</div>
                            <div style="color: white; font-weight: 600;">$${opp.sellPrice.toFixed(4)}</div>
                        </div>
                        <div>
                            <div style="color: #888; font-size: 0.75rem;">Transfer Time</div>
                            <div style="color: white; font-weight: 600;">~${opp.estimatedTransferTime} min</div>
                        </div>
                        <div>
                            <div style="color: #888; font-size: 0.75rem;">Risk Score</div>
                            <div style="color: ${opp.riskScore <= 3 ? '#00ff88' : opp.riskScore <= 6 ? '#ffb347' : '#ff6b6b'}; font-weight: 600;">
                                ${opp.riskScore}/10 ${opp.riskScore <= 3 ? '‚úÖ' : opp.riskScore <= 6 ? '‚ö†Ô∏è' : '‚ùå'}
                            </div>
                        </div>
                    </div>

                    <button onclick="executeTransfer(${JSON.stringify(opp).replace(/"/g, '&quot;')})"
                            style="width: 100%; padding: 12px; background: linear-gradient(45deg, #00ff88 0%, #00d4ff 100%);
                                   color: #000; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">
                        üöÄ Execute Transfer ($${opp.usdtToSpend})
                    </button>
                </div>
            `).join('');
        }

        // Get connected exchanges from Strategy API Setup
        function getConnectedExchanges() {
            console.log('üîç Checking for connected Transfer ARB exchanges...');
            const strategy = 'transfer';
            const allExchanges = ['chainex', 'valr', 'luno', 'kraken', 'binance', 'bybit', 'okx', 'mexc',
                                  'kucoin', 'htx', 'bitget', 'bitmart', 'bitrue', 'gemini', 'coincatch',
                                  'bingx', 'ascendex', 'gateio'];

            const connectedExchanges = [];

            allExchanges.forEach(exchange => {
                // Check if exchange has API credentials for transfer strategy
                const apiKey = localStorage.getItem(`${exchange}_${strategy}_api`);
                const secretKey = localStorage.getItem(`${exchange}_${strategy}_secret`);
                const isConnected = localStorage.getItem(`${exchange}_${strategy}_connected`) === 'true';

                if (apiKey && secretKey && isConnected) {
                    connectedExchanges.push(exchange);
                    console.log(`‚úÖ ${exchange} connected for Transfer ARB`);
                }
            });

            console.log(`üìä Total connected exchanges: ${connectedExchanges.length}`, connectedExchanges);

            if (connectedExchanges.length === 0) {
                console.warn('‚ö†Ô∏è No exchanges connected for Transfer ARB. Please configure in Strategy API Setup.');
            }

            return connectedExchanges;
        }

        function generateDepositAddressSection() {
            const section = document.getElementById('deposit-address-section');
            section.style.display = 'block';

            const connectedExchanges = getConnectedExchanges();

            if (connectedExchanges.length === 0) {
                section.innerHTML = `
                    <h3 style="color: #00ff88;">üì¨ Deposit Address Configuration</h3>
                    <div style="background: rgba(255,107,107,0.2); border: 1px solid #ff6b6b; border-radius: 8px; padding: 20px; margin-top: 15px;">
                        <p style="color: #ff6b6b; margin-bottom: 10px;">‚ö†Ô∏è No exchanges connected for Transfer ARB</p>
                        <p style="color: #b8c6db; margin-bottom: 15px;">Please configure your exchanges in Strategy API Setup first.</p>
                        <div style="display: flex; gap: 15px;">
                            <button onclick="window.location.href='/strategy-api-setup.html?strategy=transfer'"
                                    style="padding: 10px 20px; background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
                                           color: white; border: none; border-radius: 8px; cursor: pointer; flex: 1;">
                                üîß Configure Exchanges
                            </button>
                            <button onclick="openDepositAddressModal()"
                                    style="padding: 10px 20px; background: linear-gradient(45deg, #00d4ff 0%, #00ff88 100%);
                                           color: white; border: none; border-radius: 8px; cursor: pointer; flex: 1;">
                                üì¨ Configure Deposit Addresses
                            </button>
                        </div>
                    </div>
                `;
                return;
            }

            // Calculate how many addresses are configured (both network AND deposit address required)
            let configuredCount = 0;
            let totalNeeded = selectedCryptos.length * connectedExchanges.length;

            connectedExchanges.forEach(exchange => {
                selectedCryptos.forEach(crypto => {
                    const networkKey = `deposit_${exchange}_${crypto}_network`;
                    const depositKey = `deposit_${exchange}_${crypto}_deposit`;
                    const hasNetwork = localStorage.getItem(networkKey);
                    const hasDeposit = localStorage.getItem(depositKey);

                    // Both network and deposit address must be configured
                    if (hasNetwork && hasDeposit) {
                        configuredCount++;
                    }
                });
            });

            section.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="color: #00ff88; margin: 0;">üì¨ Deposit Address Configuration</h3>
                    <button onclick="openDepositAddressModal()"
                            style="padding: 10px 20px; background: linear-gradient(45deg, #00d4ff 0%, #00ff88 100%);
                                   color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                        üì¨ Configure Deposit Addresses
                    </button>
                </div>
                <div style="background: rgba(0,212,255,0.1); border: 1px solid #00d4ff; border-radius: 8px; padding: 20px;">
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 15px;">
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: bold; color: #00ff88;">${selectedCryptos.length}</div>
                            <div style="font-size: 0.85rem; color: #b8c6db;">Cryptocurrencies</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: bold; color: #00d4ff;">${connectedExchanges.length}</div>
                            <div style="font-size: 0.85rem; color: #b8c6db;">Exchanges Connected</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: bold; color: ${configuredCount === totalNeeded ? '#00ff88' : '#ffb347'};">
                                ${configuredCount}/${totalNeeded}
                            </div>
                            <div style="font-size: 0.85rem; color: #b8c6db;">Addresses Configured</div>
                        </div>
                    </div>
                    <p style="color: #b8c6db; text-align: center; margin: 0;">
                        ${configuredCount === totalNeeded
                            ? '‚úÖ All deposit addresses configured!'
                            : `‚ö†Ô∏è ${totalNeeded - configuredCount} deposit address(es) still needed. Click "Configure Deposit Addresses" above to set them up.`}
                    </p>
                </div>
            `;
        }

        // ============================================================================
        // ADDRESS FORMAT VALIDATION
        // ============================================================================

        /**
         * Validate if deposit address format matches the selected network
         * Returns { valid: boolean, warning: string | null, network: string }
         */
        function validateAddressFormat(address, network, crypto) {
            if (!address || address.trim() === '') {
                return { valid: false, warning: 'Address cannot be empty', network };
            }

            const addr = address.trim();

            // Network-specific validation rules
            const validationRules = {
                // Bitcoin networks
                'BTC': {
                    pattern: /^(1|3|bc1)[a-zA-HJ-NP-Z0-9]{25,62}$/,
                    description: 'Bitcoin address (starts with 1, 3, or bc1)',
                    minLength: 26,
                    maxLength: 62
                },
                'Bitcoin': {
                    pattern: /^(1|3|bc1)[a-zA-HJ-NP-Z0-9]{25,62}$/,
                    description: 'Bitcoin address (starts with 1, 3, or bc1)',
                    minLength: 26,
                    maxLength: 62
                },

                // Ethereum & EVM networks
                'ERC20': {
                    pattern: /^0x[a-fA-F0-9]{40}$/,
                    description: 'Ethereum address (starts with 0x, 42 characters)',
                    minLength: 42,
                    maxLength: 42
                },
                'Ethereum': {
                    pattern: /^0x[a-fA-F0-9]{40}$/,
                    description: 'Ethereum address (starts with 0x, 42 characters)',
                    minLength: 42,
                    maxLength: 42
                },
                'BEP20': {
                    pattern: /^(0x[a-fA-F0-9]{40}|bnb1[a-z0-9]{38})$/,
                    description: 'BSC address (starts with 0x or bnb1)',
                    minLength: 39,
                    maxLength: 42
                },
                'BSC': {
                    pattern: /^(0x[a-fA-F0-9]{40}|bnb1[a-z0-9]{38})$/,
                    description: 'BSC address (starts with 0x or bnb1)',
                    minLength: 39,
                    maxLength: 42
                },
                'Polygon': {
                    pattern: /^0x[a-fA-F0-9]{40}$/,
                    description: 'Polygon address (starts with 0x, 42 characters)',
                    minLength: 42,
                    maxLength: 42
                },
                'Arbitrum': {
                    pattern: /^0x[a-fA-F0-9]{40}$/,
                    description: 'Arbitrum address (starts with 0x, 42 characters)',
                    minLength: 42,
                    maxLength: 42
                },
                'Optimism': {
                    pattern: /^0x[a-fA-F0-9]{40}$/,
                    description: 'Optimism address (starts with 0x, 42 characters)',
                    minLength: 42,
                    maxLength: 42
                },
                'Avalanche': {
                    pattern: /^(0x[a-fA-F0-9]{40}|X-avax1[a-z0-9]{38})$/,
                    description: 'Avalanche address (starts with 0x or X-avax1)',
                    minLength: 39,
                    maxLength: 45
                },

                // Tron network
                'TRC20': {
                    pattern: /^T[a-zA-Z0-9]{33}$/,
                    description: 'Tron address (starts with T, 34 characters)',
                    minLength: 34,
                    maxLength: 34
                },
                'Tron': {
                    pattern: /^T[a-zA-Z0-9]{33}$/,
                    description: 'Tron address (starts with T, 34 characters)',
                    minLength: 34,
                    maxLength: 34
                },

                // Ripple (XRP)
                'XRP': {
                    pattern: /^r[a-zA-Z0-9]{24,34}$/,
                    description: 'XRP address (starts with r)',
                    minLength: 25,
                    maxLength: 35
                },

                // Stellar (XLM)
                'XLM': {
                    pattern: /^G[A-Z2-7]{55}$/,
                    description: 'Stellar address (starts with G, 56 characters)',
                    minLength: 56,
                    maxLength: 56
                },

                // Litecoin
                'LTC': {
                    pattern: /^(L|M|ltc1)[a-zA-Z0-9]{26,62}$/,
                    description: 'Litecoin address (starts with L, M, or ltc1)',
                    minLength: 26,
                    maxLength: 62
                },
                'Litecoin': {
                    pattern: /^(L|M|ltc1)[a-zA-Z0-9]{26,62}$/,
                    description: 'Litecoin address (starts with L, M, or ltc1)',
                    minLength: 26,
                    maxLength: 62
                },

                // Solana
                'SOL': {
                    pattern: /^[1-9A-HJ-NP-Za-km-z]{32,44}$/,
                    description: 'Solana address (base58, 32-44 characters)',
                    minLength: 32,
                    maxLength: 44
                },
                'Solana': {
                    pattern: /^[1-9A-HJ-NP-Za-km-z]{32,44}$/,
                    description: 'Solana address (base58, 32-44 characters)',
                    minLength: 32,
                    maxLength: 44
                },

                // Cardano
                'ADA': {
                    pattern: /^(addr1|DdzFF)[a-zA-Z0-9]{50,104}$/,
                    description: 'Cardano address (starts with addr1 or DdzFF)',
                    minLength: 50,
                    maxLength: 104
                },
                'Cardano': {
                    pattern: /^(addr1|DdzFF)[a-zA-Z0-9]{50,104}$/,
                    description: 'Cardano address (starts with addr1 or DdzFF)',
                    minLength: 50,
                    maxLength: 104
                },

                // Algorand
                'ALGO': {
                    pattern: /^[A-Z2-7]{58}$/,
                    description: 'Algorand address (58 uppercase characters)',
                    minLength: 58,
                    maxLength: 58
                },
                'Algorand': {
                    pattern: /^[A-Z2-7]{58}$/,
                    description: 'Algorand address (58 uppercase characters)',
                    minLength: 58,
                    maxLength: 58
                },

                // Cosmos
                'ATOM': {
                    pattern: /^cosmos1[a-z0-9]{38}$/,
                    description: 'Cosmos address (starts with cosmos1)',
                    minLength: 45,
                    maxLength: 45
                },
                'Cosmos': {
                    pattern: /^cosmos1[a-z0-9]{38}$/,
                    description: 'Cosmos address (starts with cosmos1)',
                    minLength: 45,
                    maxLength: 45
                },

                // Polkadot
                'DOT': {
                    pattern: /^1[a-zA-Z0-9]{47}$/,
                    description: 'Polkadot address (starts with 1, 48 characters)',
                    minLength: 48,
                    maxLength: 48
                },
                'Polkadot': {
                    pattern: /^1[a-zA-Z0-9]{47}$/,
                    description: 'Polkadot address (starts with 1, 48 characters)',
                    minLength: 48,
                    maxLength: 48
                }
            };

            // Get validation rule for this network
            const rule = validationRules[network];

            if (!rule) {
                // Unknown network - perform basic validation
                if (addr.length < 20) {
                    return {
                        valid: false,
                        warning: `‚ö†Ô∏è Address appears too short (${addr.length} characters). Most crypto addresses are at least 20 characters.`,
                        network
                    };
                }
                return {
                    valid: true,
                    warning: `‚ö†Ô∏è Cannot validate address format for network '${network}'. Please double-check manually.`,
                    network
                };
            }

            // Validate length
            if (addr.length < rule.minLength || addr.length > rule.maxLength) {
                return {
                    valid: false,
                    warning: `‚ùå Invalid address length for ${network}. Expected ${rule.minLength}-${rule.maxLength} characters, got ${addr.length}.`,
                    network
                };
            }

            // Validate pattern
            if (!rule.pattern.test(addr)) {
                return {
                    valid: false,
                    warning: `‚ùå Address format does not match ${network} network. Expected: ${rule.description}`,
                    network
                };
            }

            // All checks passed
            return {
                valid: true,
                warning: null,
                network
            };
        }

        /**
         * Show address validation warning/error in UI
         */
        function showAddressValidationFeedback(inputElement, validation) {
            // Remove existing feedback
            const existingFeedback = inputElement.parentElement.querySelector('.address-validation-feedback');
            if (existingFeedback) {
                existingFeedback.remove();
            }

            if (validation.warning) {
                const feedbackDiv = document.createElement('div');
                feedbackDiv.className = 'address-validation-feedback';
                feedbackDiv.style.cssText = `
                    margin-top: 8px;
                    padding: 10px;
                    border-radius: 6px;
                    font-size: 0.85rem;
                    line-height: 1.4;
                    background: ${validation.valid ? 'rgba(255,179,71,0.15)' : 'rgba(255,68,68,0.15)'};
                    border-left: 3px solid ${validation.valid ? '#ffb347' : '#ff4444'};
                    color: ${validation.valid ? '#ffb347' : '#ff6b6b'};
                `;
                feedbackDiv.textContent = validation.warning;
                inputElement.parentElement.appendChild(feedbackDiv);

                // Update input border color
                inputElement.style.borderColor = validation.valid ? '#ffb347' : '#ff4444';
            } else {
                // Valid address - green border
                inputElement.style.borderColor = '#00ff88';
            }
        }

        // Network cache to avoid repeated API calls
        const networkCache = new Map();

        // Fetch available networks from API for specific exchange pair and crypto
        async function fetchNetworksFromAPI(fromExchange, toExchange, crypto) {
            const cacheKey = `${fromExchange}_${toExchange}_${crypto}`;

            // Check cache first
            if (networkCache.has(cacheKey)) {
                console.log(`üì¶ Using cached networks for ${cacheKey}`);
                return networkCache.get(cacheKey);
            }

            try {
                console.log(`üîç Fetching networks from API: ${fromExchange} ‚Üí ${toExchange} for ${crypto}`);

                const response = await fetch(`/api/v1/transfer-arb/networks/${fromExchange}/${toExchange}/${crypto}`);
                const data = await response.json();

                if (data.success && data.data) {
                    const networkData = {
                        fromNetworks: data.data.fromNetworks || [],
                        toNetworks: data.data.toNetworks || [],
                        matchingNetworks: data.data.matchingNetworks || [],
                        bestNetwork: data.data.bestNetwork || null,
                        isViable: data.data.isViable || false
                    };

                    // Cache the result
                    networkCache.set(cacheKey, networkData);
                    console.log(`‚úÖ Fetched ${networkData.matchingNetworks.length} matching networks for ${crypto}`);

                    return networkData;
                }
            } catch (error) {
                console.warn(`‚ö†Ô∏è Failed to fetch networks from API: ${error.message}`);
            }

            // Return null if API fails (will fallback to static list)
            return null;
        }

        // Get available networks for a crypto
        function getAvailableNetworks(crypto) {
            const networkOptions = {
                'BTC': [
                    { id: 'BTC', name: 'Bitcoin', fee: '~0.0005 BTC' },
                    { id: 'BTC-Lightning', name: 'Lightning Network', fee: 'Very low' }
                ],
                'ETH': [
                    { id: 'ERC20', name: 'Ethereum (ERC20)', fee: '~0.005 ETH' },
                    { id: 'Arbitrum', name: 'Arbitrum One', fee: 'Low' },
                    { id: 'Optimism', name: 'Optimism', fee: 'Low' }
                ],
                'USDT': [
                    { id: 'TRC20', name: 'Tron (TRC20)', fee: '~1 USDT' },
                    { id: 'ERC20', name: 'Ethereum (ERC20)', fee: '~15 USDT' },
                    { id: 'BEP20', name: 'BSC (BEP20)', fee: '~0.5 USDT' },
                    { id: 'Polygon', name: 'Polygon', fee: '~0.1 USDT' },
                    { id: 'Arbitrum', name: 'Arbitrum One', fee: '~0.1 USDT' },
                    { id: 'Optimism', name: 'Optimism', fee: '~0.1 USDT' },
                    { id: 'Avalanche', name: 'Avalanche C-Chain', fee: '~0.5 USDT' },
                    { id: 'SOL', name: 'Solana', fee: '~0.01 USDT' }
                ],
                'USDC': [
                    { id: 'ERC20', name: 'Ethereum (ERC20)', fee: '~15 USDC' },
                    { id: 'TRC20', name: 'Tron (TRC20)', fee: '~1 USDC' },
                    { id: 'BEP20', name: 'BSC (BEP20)', fee: '~0.5 USDC' },
                    { id: 'Polygon', name: 'Polygon', fee: '~0.1 USDC' },
                    { id: 'Arbitrum', name: 'Arbitrum One', fee: '~0.1 USDC' },
                    { id: 'Optimism', name: 'Optimism', fee: '~0.1 USDC' },
                    { id: 'Avalanche', name: 'Avalanche C-Chain', fee: '~0.5 USDC' },
                    { id: 'SOL', name: 'Solana (SPL)', fee: '~0.01 USDC' }
                ],
                'XRP': [
                    { id: 'XRP', name: 'XRP Ledger', fee: '~0.25 XRP' }
                ],
                'XLM': [
                    { id: 'XLM', name: 'Stellar Network', fee: '~0.01 XLM' }
                ],
                'TRX': [
                    { id: 'TRC20', name: 'Tron (TRC20)', fee: '~1 TRX' }
                ],
                'LTC': [
                    { id: 'LTC', name: 'Litecoin', fee: '~0.001 LTC' }
                ],
                'BCH': [
                    { id: 'BCH', name: 'Bitcoin Cash', fee: '~0.0005 BCH' }
                ],
                'ADA': [
                    { id: 'ADA', name: 'Cardano', fee: '~1 ADA' }
                ],
                'ALGO': [
                    { id: 'ALGO', name: 'Algorand', fee: '~0.001 ALGO' }
                ],
                'ATOM': [
                    { id: 'ATOM', name: 'Cosmos Hub', fee: '~0.01 ATOM' }
                ],
                'DOT': [
                    { id: 'DOT', name: 'Polkadot', fee: '~0.1 DOT' }
                ],
                'DOGE': [
                    { id: 'DOGE', name: 'Dogecoin', fee: '~2 DOGE' }
                ],
                'MATIC': [
                    { id: 'Polygon', name: 'Polygon', fee: '~0.1 MATIC' },
                    { id: 'ERC20', name: 'Ethereum (ERC20)', fee: '~5 MATIC' }
                ],
                'SOL': [
                    { id: 'SOL', name: 'Solana', fee: '~0.01 SOL' }
                ],
                'AVAX': [
                    { id: 'Avalanche-C', name: 'Avalanche C-Chain', fee: '~0.01 AVAX' },
                    { id: 'Avalanche-X', name: 'Avalanche X-Chain', fee: '~0.001 AVAX' }
                ]
            };

            return networkOptions[crypto] || [
                { id: 'UNKNOWN', name: `${crypto} Native Network`, fee: 'Check exchange' }
            ];
        }

        // Save deposit address to localStorage
        function saveDepositAddress(exchange, crypto, type, value) {
            const key = `deposit_${exchange}_${crypto}_${type}`;
            localStorage.setItem(key, value);
            console.log(`üíæ Auto-saved: ${key} = ${value.substring(0, 10)}...`);

            // Validate address format when saving deposit address
            if (type === 'deposit' && value && value.trim() !== '') {
                validateDepositAddressForNetwork(exchange, crypto);
            }

            // If network was just changed, re-validate the existing address
            if (type === 'network' && value && value.trim() !== '') {
                validateDepositAddressForNetwork(exchange, crypto);
            }
        }

        // Validate deposit address against selected network
        function validateDepositAddressForNetwork(exchange, crypto) {
            const depositKey = `deposit_${exchange}_${crypto}_deposit`;
            const networkKey = `deposit_${exchange}_${crypto}_network`;

            const address = localStorage.getItem(depositKey);
            const network = localStorage.getItem(networkKey);

            if (!address || address.trim() === '') {
                // No address to validate yet
                return;
            }

            if (!network || network.trim() === '') {
                console.warn(`‚ö†Ô∏è Cannot validate address for ${exchange} ${crypto} - network not selected yet`);
                return;
            }

            // Validate address against selected network
            const validation = validateAddressFormat(address, network, crypto);
            const inputElement = document.getElementById(`modal-${exchange}-${crypto}-deposit`);

            if (inputElement) {
                showAddressValidationFeedback(inputElement, validation);

                if (!validation.valid) {
                    console.warn(`‚ö†Ô∏è Address validation failed for ${exchange} ${crypto}:`, validation.warning);
                } else if (validation.warning) {
                    console.warn(`‚ö†Ô∏è Address validation warning for ${exchange} ${crypto}:`, validation.warning);
                } else {
                    console.log(`‚úÖ Address validation passed for ${exchange} ${crypto} on ${network}`);
                }
            }
        }

        // Load saved deposit addresses
        function loadDepositAddresses() {
            console.log('üîÑ Loading saved deposit addresses...');

            const connectedExchanges = getConnectedExchanges();

            connectedExchanges.forEach(exchange => {
                selectedCryptos.forEach(crypto => {
                    // Load deposit address
                    const depositKey = `deposit_${exchange}_${crypto}_deposit`;
                    const depositValue = localStorage.getItem(depositKey);
                    const depositInput = document.getElementById(`${exchange}-${crypto}-deposit`);

                    if (depositValue && depositInput) {
                        depositInput.value = depositValue;
                        console.log(`‚úÖ Loaded ${exchange} ${crypto} deposit address`);
                    }

                    // Load tag/memo for XRP and XLM
                    if (['XRP', 'XLM'].includes(crypto)) {
                        const tagKey = `deposit_${exchange}_${crypto}_tag`;
                        const tagValue = localStorage.getItem(tagKey);
                        const tagInput = document.getElementById(`${exchange}-${crypto}-tag`);

                        if (tagValue && tagInput) {
                            tagInput.value = tagValue;
                            console.log(`‚úÖ Loaded ${exchange} ${crypto} tag/memo`);
                        }
                    }
                });
            });
        }

        // Open deposit address modal
        function openDepositAddressModal() {
            console.log('üì¨ Opening deposit address modal...');

            const modal = document.getElementById('depositAddressModal');
            const modalFields = document.getElementById('modal-deposit-fields');

            // Check if we have selected cryptos
            if (selectedCryptos.length === 0) {
                alert('‚ö†Ô∏è Please select cryptocurrencies first');
                return;
            }

            const connectedExchanges = getConnectedExchanges();

            if (connectedExchanges.length === 0) {
                // Show message to connect exchanges
                modalFields.innerHTML = `
                    <div style="background: rgba(255,107,107,0.2); border: 1px solid #ff6b6b; border-radius: 8px; padding: 30px; text-align: center;">
                        <h3 style="color: #ff6b6b; margin-bottom: 15px;">‚ö†Ô∏è No Exchanges Connected</h3>
                        <p style="color: #b8c6db; margin-bottom: 20px;">
                            You need to connect exchanges in Strategy API Setup before configuring deposit addresses.
                        </p>
                        <button onclick="window.location.href='/strategy-api-setup.html?strategy=transfer'"
                                style="padding: 12px 24px; background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
                                       color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                            üîß Go to Strategy API Setup
                        </button>
                    </div>
                `;
            } else {
                // Populate modal with deposit address fields
                modalFields.innerHTML = connectedExchanges.map(exchange => `
                    <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                        <h4 style="color: #ffb347; text-transform: uppercase; margin-bottom: 15px;">
                            ${exchange}
                            <span style="color: #00ff88; font-size: 0.8rem; font-weight: normal;">‚úì Connected</span>
                        </h4>
                        ${selectedCryptos.map(crypto => {
                            // Get available networks for this crypto
                            const networks = getAvailableNetworks(crypto);

                            return `
                            <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                                    <div style="background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
                                                padding: 6px 12px; border-radius: 6px; font-weight: 700; font-size: 0.9rem;">
                                        ${crypto}
                                    </div>
                                    <div style="color: #b8c6db; font-size: 0.8rem;">
                                        Configure deposit details for ${exchange}
                                    </div>
                                </div>

                                <!-- Network Selection (CRITICAL) -->
                                <div style="background: rgba(0,212,255,0.1); border: 2px solid #00d4ff; border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                        <label style="color: #00d4ff; font-weight: 700; font-size: 0.85rem; margin: 0;">
                                            üîó NETWORK/CHAIN (CRITICAL - Must Match Withdrawal Network!)
                                        </label>
                                        <button onclick="checkNetworkCompatibility('${exchange}', '${crypto}')"
                                                style="background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
                                                       border: none; padding: 4px 10px; border-radius: 4px;
                                                       color: white; font-size: 0.75rem; cursor: pointer; font-weight: 600;">
                                            üîç Check All Exchanges
                                        </button>
                                    </div>
                                    <select id="modal-${exchange}-${crypto}-network"
                                            onchange="saveDepositAddress('${exchange}', '${crypto}', 'network', this.value)"
                                            style="background: rgba(0,0,0,0.4); border: 2px solid #00d4ff; border-radius: 6px;
                                                   padding: 10px; color: white; width: 100%; font-size: 0.9rem; cursor: pointer;">
                                        <option value="">‚ö†Ô∏è SELECT NETWORK (REQUIRED)</option>
                                        ${networks.map(net => `
                                            <option value="${net.id}">${net.name} ${net.fee ? `(Fee: ${net.fee})` : ''}</option>
                                        `).join('')}
                                    </select>
                                    <div id="compat-hint-${exchange}-${crypto}" style="display: none; margin-top: 8px; padding: 8px;
                                         background: rgba(0,255,136,0.1); border: 1px solid #00ff88; border-radius: 4px;">
                                        <!-- Compatibility hint will be inserted here -->
                                    </div>
                                    <div style="color: #00d4ff; font-size: 0.75rem; line-height: 1.4; margin-top: 8px;">
                                        <strong>‚ö†Ô∏è CRITICAL:</strong> Network must match the network used for withdrawal.<br>
                                        <strong>Sending to wrong network = PERMANENT FUND LOSS!</strong><br>
                                        Example: If withdrawing via TRC20, deposit address MUST be TRC20.
                                    </div>
                                </div>

                                <!-- Deposit Address -->
                                <label style="display: block; color: #b8c6db; margin-bottom: 8px; font-weight: 600;">
                                    üì¨ Deposit Address
                                </label>
                                <input type="text" id="modal-${exchange}-${crypto}-deposit"
                                       placeholder="${exchange} ${crypto} deposit address"
                                       oninput="saveDepositAddress('${exchange}', '${crypto}', 'deposit', this.value)"
                                       style="background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.3);
                                              border-radius: 6px; padding: 10px; color: white; width: 100%; font-size: 0.9rem;
                                              margin-bottom: 12px;">

                                ${['XRP', 'XLM'].includes(crypto) ? `
                                    <!-- Destination Tag/Memo for XRP/XLM -->
                                    <div style="background: rgba(255,107,107,0.15); border: 2px solid #ff6b6b; border-radius: 8px; padding: 12px;">
                                        <label style="display: block; color: #ff6b6b; margin-bottom: 8px; font-weight: 700; font-size: 0.85rem;">
                                            ‚ö†Ô∏è DESTINATION TAG/MEMO (REQUIRED FOR ${crypto})
                                        </label>
                                        <input type="text" id="modal-${exchange}-${crypto}-tag"
                                               placeholder="Enter ${crypto} destination tag (numbers only)"
                                               required
                                               pattern="[0-9]+"
                                               oninput="saveDepositAddress('${exchange}', '${crypto}', 'tag', this.value)"
                                               style="background: rgba(0,0,0,0.4); border: 2px solid #ff6b6b; border-radius: 6px;
                                                      padding: 10px; color: white; width: 100%; font-size: 0.9rem; margin-bottom: 8px;">
                                        <div style="color: #ff6b6b; font-size: 0.75rem; line-height: 1.4;">
                                            <strong>CRITICAL:</strong> ${crypto} transfers REQUIRE a destination tag/memo.<br>
                                            <strong>Without it, your funds will be PERMANENTLY LOST!</strong><br>
                                            Get this from your ${exchange} ${crypto} deposit page.
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        `}).join('')}
                    </div>
                `).join('');

                // Load saved values into modal fields
                setTimeout(() => loadModalDepositAddresses(), 100);

                // Check if ChainEX has networks configured to show bulk copy button
                setTimeout(() => {
                    const bulkCopySection = document.getElementById('bulk-network-copy-section');
                    if (bulkCopySection && connectedExchanges.includes('chainex') && connectedExchanges.length > 1) {
                        // Check if ChainEX has any networks configured
                        let chainexHasNetworks = false;
                        for (const crypto of selectedCryptos) {
                            if (localStorage.getItem(`deposit_chainex_${crypto}_network`)) {
                                chainexHasNetworks = true;
                                break;
                            }
                        }

                        if (chainexHasNetworks) {
                            bulkCopySection.style.display = 'block';
                        } else {
                            bulkCopySection.style.display = 'none';
                        }
                    }
                }, 150);
            }

            // Show modal
            modal.style.display = 'block';
            console.log('‚úÖ Modal opened');
        }

        // Load saved deposit addresses into modal
        function loadModalDepositAddresses() {
            console.log('üîÑ Loading saved addresses into modal...');

            const connectedExchanges = getConnectedExchanges();

            connectedExchanges.forEach(exchange => {
                selectedCryptos.forEach(crypto => {
                    // Load network selection
                    const networkKey = `deposit_${exchange}_${crypto}_network`;
                    const networkValue = localStorage.getItem(networkKey);
                    const networkSelect = document.getElementById(`modal-${exchange}-${crypto}-network`);

                    if (networkValue && networkSelect) {
                        networkSelect.value = networkValue;
                        console.log(`‚úÖ Loaded ${exchange} ${crypto} network: ${networkValue}`);
                    }

                    // Load deposit address
                    const depositKey = `deposit_${exchange}_${crypto}_deposit`;
                    const depositValue = localStorage.getItem(depositKey);
                    const depositInput = document.getElementById(`modal-${exchange}-${crypto}-deposit`);

                    if (depositValue && depositInput) {
                        depositInput.value = depositValue;
                        console.log(`‚úÖ Loaded ${exchange} ${crypto} deposit into modal`);
                    }

                    // Load tag/memo for XRP and XLM
                    if (['XRP', 'XLM'].includes(crypto)) {
                        const tagKey = `deposit_${exchange}_${crypto}_tag`;
                        const tagValue = localStorage.getItem(tagKey);
                        const tagInput = document.getElementById(`modal-${exchange}-${crypto}-tag`);

                        if (tagValue && tagInput) {
                            tagInput.value = tagValue;
                            console.log(`‚úÖ Loaded ${exchange} ${crypto} tag into modal`);
                        }
                    }
                });
            });
        }

        // Check network compatibility across all connected exchanges for a crypto
        async function checkNetworkCompatibility(currentExchange, crypto) {
            console.log(`üîç Checking network compatibility for ${crypto} from ${currentExchange}...`);

            const connectedExchanges = getConnectedExchanges();
            const hintDiv = document.getElementById(`compat-hint-${currentExchange}-${crypto}`);

            if (connectedExchanges.length < 2) {
                hintDiv.style.display = 'block';
                hintDiv.innerHTML = `
                    <div style="color: #ffb347; font-size: 0.75rem;">
                        ‚ÑπÔ∏è Connect more exchanges to check compatibility
                    </div>
                `;
                return;
            }

            // Check cache first (5 minute TTL)
            const cacheKey = `network_compat_${currentExchange}_${crypto}`;
            const cached = localStorage.getItem(cacheKey);
            if (cached) {
                const { timestamp, data } = JSON.parse(cached);
                if (Date.now() - timestamp < 5 * 60 * 1000) { // 5 minutes
                    console.log(`‚úÖ Using cached compatibility data for ${crypto} from ${currentExchange}`);
                    displayCompatibilityResult(hintDiv, currentExchange, crypto, data);
                    return;
                }
            }

            // Show loading state
            hintDiv.style.display = 'block';
            hintDiv.innerHTML = `
                <div style="color: #00d4ff; font-size: 0.75rem;">
                    ‚è≥ Checking compatibility with ${connectedExchanges.length - 1} exchanges...
                </div>
            `;

            try {
                // Only check CURRENT exchange against all others (not all pairs)
                // This reduces API calls from O(n¬≤) to O(n)
                // For 18 exchanges: 153 calls ‚Üí 17 calls (90% reduction!)

                const otherExchanges = connectedExchanges.filter(ex => ex !== currentExchange);
                const compatibleExchanges = [];
                const commonNetworks = new Map(); // network ‚Üí count
                let checkedCount = 0;

                for (const otherExchange of otherExchanges) {
                    // Update progress
                    checkedCount++;
                    hintDiv.innerHTML = `
                        <div style="color: #00d4ff; font-size: 0.75rem;">
                            ‚è≥ Checking... ${checkedCount}/${otherExchanges.length} exchanges
                        </div>
                    `;

                    // Fetch network compatibility for this pair
                    const networkData = await fetchNetworksFromAPI(currentExchange, otherExchange, crypto);

                    if (networkData && networkData.matchingNetworks && networkData.matchingNetworks.length > 0) {
                        compatibleExchanges.push(otherExchange);

                        // Track which networks are common
                        networkData.matchingNetworks.forEach(network => {
                            const netId = network.network || network.id || network.name;
                            commonNetworks.set(netId, (commonNetworks.get(netId) || 0) + 1);
                        });
                    }

                    // Rate limiting: 200ms delay between calls
                    if (checkedCount < otherExchanges.length) {
                        await new Promise(resolve => setTimeout(resolve, 200));
                    }
                }

                // Prepare result data
                const resultData = {
                    compatibleExchanges,
                    totalExchanges: otherExchanges.length,
                    commonNetworks: Array.from(commonNetworks.entries())
                        .sort((a, b) => b[1] - a[1]) // Sort by frequency
                };

                // Cache the result
                localStorage.setItem(cacheKey, JSON.stringify({
                    timestamp: Date.now(),
                    data: resultData
                }));

                displayCompatibilityResult(hintDiv, currentExchange, crypto, resultData);

            } catch (error) {
                console.error('Network compatibility check failed:', error);
                hintDiv.style.background = 'rgba(255,107,107,0.1)';
                hintDiv.style.borderColor = '#ff6b6b';
                hintDiv.innerHTML = `
                    <div style="color: #ff6b6b; font-size: 0.75rem;">
                        ‚ùå Failed to check compatibility: ${error.message}
                    </div>
                    <div style="color: #b8c6db; font-size: 0.7rem; margin-top: 4px;">
                        You can still manually select networks from the dropdown
                    </div>
                `;
            }
        }

        // Display compatibility result helper function
        function displayCompatibilityResult(hintDiv, currentExchange, crypto, resultData) {
            const { compatibleExchanges, totalExchanges, commonNetworks } = resultData;
            const compatCount = compatibleExchanges.length;
            const compatPercent = Math.round((compatCount / totalExchanges) * 100);

            if (compatCount === totalExchanges) {
                // Perfect compatibility
                hintDiv.style.background = 'rgba(0,255,136,0.1)';
                hintDiv.style.borderColor = '#00ff88';
                hintDiv.innerHTML = `
                    <div style="color: #00ff88; font-size: 0.75rem; font-weight: 600;">
                        ‚úÖ ${crypto}: Compatible with ALL ${totalExchanges} exchanges (100%)
                    </div>
                    <div style="color: #b8c6db; font-size: 0.75rem; margin-top: 4px;">
                        Common networks: ${commonNetworks.slice(0, 3).map(([net]) => net).join(', ')}
                    </div>
                `;
            } else if (compatCount >= totalExchanges * 0.7) {
                // Good compatibility (70%+)
                hintDiv.style.background = 'rgba(0,255,136,0.1)';
                hintDiv.style.borderColor = '#00ff88';
                hintDiv.innerHTML = `
                    <div style="color: #00ff88; font-size: 0.75rem; font-weight: 600;">
                        ‚úÖ ${crypto}: Compatible with ${compatCount}/${totalExchanges} exchanges (${compatPercent}%)
                    </div>
                    <div style="color: #b8c6db; font-size: 0.75rem; margin-top: 4px;">
                        Common networks: ${commonNetworks.slice(0, 3).map(([net]) => net).join(', ')}
                    </div>
                    ${compatCount < totalExchanges ? `
                        <div style="color: #ffb347; font-size: 0.7rem; margin-top: 4px;">
                            ‚ö†Ô∏è Not compatible with: ${getIncompatibleExchanges(currentExchange, compatibleExchanges).join(', ')}
                        </div>
                    ` : ''}
                `;
            } else if (compatCount > 0) {
                // Partial compatibility
                hintDiv.style.background = 'rgba(255,179,71,0.1)';
                hintDiv.style.borderColor = '#ffb347';
                hintDiv.innerHTML = `
                    <div style="color: #ffb347; font-size: 0.75rem; font-weight: 600;">
                        ‚ö†Ô∏è ${crypto}: Limited compatibility (${compatCount}/${totalExchanges} exchanges, ${compatPercent}%)
                    </div>
                    <div style="color: #b8c6db; font-size: 0.75rem; margin-top: 4px;">
                        Compatible with: ${compatibleExchanges.slice(0, 5).join(', ')}${compatibleExchanges.length > 5 ? '...' : ''}
                    </div>
                    <div style="color: #b8c6db; font-size: 0.75rem; margin-top: 4px;">
                        Common networks: ${commonNetworks.slice(0, 3).map(([net]) => net).join(', ')}
                    </div>
                `;
            } else {
                // No compatibility
                hintDiv.style.background = 'rgba(255,107,107,0.1)';
                hintDiv.style.borderColor = '#ff6b6b';
                hintDiv.innerHTML = `
                    <div style="color: #ff6b6b; font-size: 0.75rem; font-weight: 600;">
                        ‚ùå ${crypto}: No compatible networks found with other exchanges
                    </div>
                    <div style="color: #b8c6db; font-size: 0.7rem; margin-top: 4px;">
                        This asset may not support transfers from ${currentExchange}
                    </div>
                `;
            }

            // Highlight compatible networks in dropdown if we found some
            if (commonNetworks.length > 0) {
                const select = document.getElementById(`modal-${currentExchange}-${crypto}-network`);
                if (select) {
                    const topNetworks = commonNetworks.slice(0, 3).map(([net]) => net);
                    Array.from(select.options).forEach(option => {
                        if (topNetworks.includes(option.value)) {
                            if (!option.text.startsWith('‚úÖ')) {
                                option.text = `‚úÖ ${option.text}`;
                            }
                        }
                    });
                }
            }
        }

        // Helper to get incompatible exchanges
        function getIncompatibleExchanges(currentExchange, compatibleExchanges) {
            const allExchanges = getConnectedExchanges().filter(ex => ex !== currentExchange);
            return allExchanges.filter(ex => !compatibleExchanges.includes(ex));
        }

        // Copy network selections from ChainEX to all other exchanges
        function copyNetworksFromChainEX() {
            console.log('üîÑ Copying networks from ChainEX to all exchanges...');

            const connectedExchanges = getConnectedExchanges();

            if (!connectedExchanges.includes('chainex')) {
                alert('‚ö†Ô∏è ChainEX is not connected. Please configure ChainEX first.');
                return;
            }

            // Count how many networks are configured for ChainEX
            let chainexNetworkCount = 0;
            const networksToCopy = {};

            for (const crypto of selectedCryptos) {
                const chainexNetwork = localStorage.getItem(`deposit_chainex_${crypto}_network`);
                if (chainexNetwork) {
                    networksToCopy[crypto] = chainexNetwork;
                    chainexNetworkCount++;
                }
            }

            if (chainexNetworkCount === 0) {
                alert('‚ö†Ô∏è No networks configured for ChainEX yet.\n\nPlease configure ChainEX networks first, then use this button to copy them to other exchanges.');
                return;
            }

            // Confirm with user
            const otherExchanges = connectedExchanges.filter(ex => ex !== 'chainex');
            const message = `üîÑ Copy Networks from ChainEX?\n\n` +
                `This will copy ${chainexNetworkCount} network selections from ChainEX to ${otherExchanges.length} other exchanges:\n\n` +
                `${Object.entries(networksToCopy).map(([crypto, network]) => `‚Ä¢ ${crypto}: ${network}`).join('\n')}\n\n` +
                `Target exchanges: ${otherExchanges.join(', ')}\n\n` +
                `This will OVERWRITE any existing network selections on those exchanges.\n\n` +
                `Continue?`;

            if (!confirm(message)) {
                return;
            }

            // Copy networks
            let copiedCount = 0;
            for (const exchange of otherExchanges) {
                for (const [crypto, network] of Object.entries(networksToCopy)) {
                    const key = `deposit_${exchange}_${crypto}_network`;
                    localStorage.setItem(key, network);
                    copiedCount++;

                    // Update the dropdown if it exists
                    const dropdown = document.getElementById(`modal-${exchange}-${crypto}-network`);
                    if (dropdown) {
                        dropdown.value = network;
                    }
                }
            }

            // Show success message
            const successMsg = `‚úÖ Network Configuration Copied!\n\n` +
                `Copied ${chainexNetworkCount} networks to ${otherExchanges.length} exchanges.\n` +
                `Total: ${copiedCount} network configurations updated.\n\n` +
                `You can now just enter deposit addresses for each exchange!`;

            alert(successMsg);
            console.log(`‚úÖ Copied ${copiedCount} network configurations from ChainEX`);
        }

        // Close deposit address modal
        function closeDepositAddressModal() {
            console.log('üì¨ Closing deposit address modal...');
            const modal = document.getElementById('depositAddressModal');
            modal.style.display = 'none';

            // Refresh the main deposit section to show updated values
            if (selectedCryptos.length > 0 && getConnectedExchanges().length > 0) {
                generateDepositAddressSection();
            }
        }

        // Load saved settings
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Transfer ARB page loaded');
            console.log('üìç Current URL:', window.location.href);

            // Initialize crypto selector
            console.log('üîÑ Initializing crypto selector...');
            initializeCryptoSelector();
            console.log('‚úÖ Crypto selector initialized');

            // Load configuration from localStorage
            const sourceExchange = localStorage.getItem('transferSourceExchange');
            if (sourceExchange) document.getElementById('sourceExchange').value = sourceExchange;

            const destExchange = localStorage.getItem('transferDestExchange');
            if (destExchange) document.getElementById('destExchange').value = destExchange;

            const transferCrypto = localStorage.getItem('transferCrypto');
            if (transferCrypto) document.getElementById('transferCrypto').value = transferCrypto;

            const minPriceDiff = localStorage.getItem('minPriceDiff');
            if (minPriceDiff) document.getElementById('minPriceDiff').value = minPriceDiff;

            const maxTransferAmount = localStorage.getItem('maxTransferAmount');
            if (maxTransferAmount) document.getElementById('maxTransferAmount').value = maxTransferAmount;

            // Toggle for fees
            document.getElementById('includeFeesToggle').addEventListener('click', function() {
                this.classList.toggle('active');
                localStorage.setItem('includeTransferFees', this.classList.contains('active'));
            });

            // Load toggle state
            if (localStorage.getItem('includeTransferFees') === 'true') {
                document.getElementById('includeFeesToggle').classList.add('active');
            }

            // Smart Transfer Fees Toggle
            const smartFeesToggle = document.getElementById('smartIncludeFeesToggle');
            if (smartFeesToggle) {
                smartFeesToggle.addEventListener('click', function() {
                    this.classList.toggle('active');
                    localStorage.setItem('smartTransferIncludeFees', this.classList.contains('active'));
                    console.log('üí∏ Smart Transfer fees toggle:', this.classList.contains('active') ? 'ON' : 'OFF');
                });
            }

            // Load smart transfer toggle state (default ON)
            const smartIncludeFeesToggle = document.getElementById('smartIncludeFeesToggle');
            if (smartIncludeFeesToggle && localStorage.getItem('smartTransferIncludeFees') !== 'false') {
                smartIncludeFeesToggle.classList.add('active');
            }

            // Auto-Execute Toggle
            const autoExecuteToggle = document.getElementById('autoExecuteToggle');
            const autoExecuteLabel = document.getElementById('autoExecuteLabel');
            const autoExecuteWarning = document.getElementById('autoExecuteWarning');

            autoExecuteToggle.addEventListener('click', function() {
                this.classList.toggle('active');
                const isActive = this.classList.contains('active');

                localStorage.setItem('transferAutoExecute', isActive);

                if (isActive) {
                    autoExecuteLabel.textContent = 'ON - Auto Trading Active';
                    autoExecuteLabel.style.color = '#00ff88';
                    autoExecuteWarning.style.display = 'block';
                    console.log('ü§ñ Auto-Execute ENABLED for Transfer ARB');
                    startContinuousScan();
                } else {
                    autoExecuteLabel.textContent = 'OFF - Manual Trading';
                    autoExecuteLabel.style.color = '#ff6b6b';
                    autoExecuteWarning.style.display = 'none';
                    console.log('‚è∏Ô∏è Auto-Execute DISABLED for Transfer ARB');
                    stopContinuousScan();
                }
            });

            // Load auto-execute state
            if (localStorage.getItem('transferAutoExecute') === 'true') {
                autoExecuteToggle.classList.add('active');
                autoExecuteLabel.textContent = 'ON - Auto Trading Active';
                autoExecuteLabel.style.color = '#00ff88';
                autoExecuteWarning.style.display = 'block';
                console.log('ü§ñ Auto-Execute was ON, starting continuous scan...');
                // Start continuous scan after page loads
                setTimeout(() => startContinuousScan(), 2000);
            }

            // Handle URL hash navigation from dashboard buttons
            const urlHash = window.location.hash.substring(1); // Remove # character
            if (urlHash === 'rebalance') {
                console.log('üîó Navigated from dashboard - opening Rebalance tab');
                // Scroll to Smart Money section
                const smartMoneySection = document.querySelector('h3[style*="SMART MONEY TRANSFER"]')?.parentElement?.parentElement;
                if (smartMoneySection) {
                    smartMoneySection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
                // Switch to rebalance tab after a short delay to ensure DOM is ready
                setTimeout(() => switchTab('rebalance'), 300);
            } else if (urlHash === 'payment') {
                console.log('üîó Navigated from dashboard - opening Payment Gateway tab');
                // Scroll to Smart Money section
                const smartMoneySection = document.querySelector('h3[style*="SMART MONEY TRANSFER"]')?.parentElement?.parentElement;
                if (smartMoneySection) {
                    smartMoneySection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
                // Switch to payment tab after a short delay to ensure DOM is ready
                setTimeout(() => switchTab('payment'), 300);
            }
        });

        // Save settings when changed
        const sourceExchange = document.getElementById('sourceExchange');
        if (sourceExchange) {
            sourceExchange.addEventListener('change', function() {
                localStorage.setItem('transferSourceExchange', this.value);
            });
        }

        const destExchange = document.getElementById('destExchange');
        if (destExchange) {
            destExchange.addEventListener('change', function() {
                localStorage.setItem('transferDestExchange', this.value);
            });
        }

        const transferCrypto = document.getElementById('transferCrypto');
        if (transferCrypto) {
            transferCrypto.addEventListener('change', function() {
                localStorage.setItem('transferCrypto', this.value);
            });
        }

        const minPriceDiff = document.getElementById('minPriceDiff');
        if (minPriceDiff) {
            minPriceDiff.addEventListener('change', function() {
                localStorage.setItem('minPriceDiff', this.value);
            });
        }

        const maxTransferAmount = document.getElementById('maxTransferAmount');
        if (maxTransferAmount) {
            maxTransferAmount.addEventListener('change', function() {
                localStorage.setItem('maxTransferAmount', this.value);
            });
        }

        // Placeholder functions
        function scanTransferOpportunities() {
            alert('Scanning for transfer arbitrage opportunities across exchanges...');
        }

        function calculateTransferProfit() {
            alert('Opening detailed profit calculator...');
        }

        async function viewTransferHistory() {
            await loadTransferHistory();
            // Scroll to history section
            document.getElementById('transfer-history-section')?.scrollIntoView({ behavior: 'smooth' });
        }

        async function loadTransferHistory() {
            console.log('üìä Loading transfer history...');

            try {
                const response = await fetch('/api/v1/transfer-arb/history?limit=50');

                if (!response.ok) {
                    throw new Error(`Failed to load history: ${response.status}`);
                }

                const result = await response.json();

                if (result.success && result.data.transfers) {
                    displayTransferHistory(result.data.transfers);
                } else {
                    console.warn('No transfer history available');
                }

            } catch (error) {
                console.error('‚ùå Failed to load transfer history:', error);
            }
        }

        function displayTransferHistory(transfers) {
            const historySection = document.getElementById('transfer-history-section');
            const historyList = document.getElementById('transfer-history-list');

            if (!historySection || !historyList) {
                console.warn('Transfer history UI elements not found');
                return;
            }

            if (transfers.length === 0) {
                historyList.innerHTML = `
                    <div style="background: rgba(255,255,255,0.05); border-radius: 8px; padding: 20px; text-align: center;">
                        <p style="color: #b8c6db;">No transfer history yet</p>
                        <p style="color: #7f8fa6; font-size: 0.85rem; margin-top: 10px;">
                            Executed transfers will appear here
                        </p>
                    </div>
                `;
                historySection.style.display = 'block';
                return;
            }

            // Display transfers
            historyList.innerHTML = transfers.map(transfer => {
                const statusColor = transfer.status === 'COMPLETED' ? '#00ff88' :
                                  transfer.status === 'FAILED' ? '#ff6b6b' : '#ffb347';
                const statusIcon = transfer.status === 'COMPLETED' ? '‚úÖ' :
                                 transfer.status === 'FAILED' ? '‚ùå' : '‚è≥';

                const duration = transfer.endTime ?
                    `${((transfer.endTime - transfer.startTime) / 1000).toFixed(0)}s` :
                    'In progress...';

                return `
                    <div style="background: rgba(255,255,255,0.05); border-radius: 8px; padding: 15px; margin-bottom: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div>
                                <span style="color: ${statusColor}; font-weight: bold;">${statusIcon} ${transfer.status}</span>
                                <span style="color: #7f8fa6; margin-left: 10px; font-size: 0.85rem;">${transfer.id}</span>
                            </div>
                            <div style="color: #b8c6db; font-size: 0.85rem;">
                                ${new Date(transfer.startTime).toLocaleString()}
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                            <div>
                                <div style="color: #7f8fa6; font-size: 0.75rem;">Route</div>
                                <div style="color: white; font-weight: bold;">
                                    ${transfer.opportunity.crypto}: ${transfer.opportunity.fromExchange} ‚Üí ${transfer.opportunity.toExchange}
                                </div>
                            </div>
                            <div>
                                <div style="color: #7f8fa6; font-size: 0.75rem;">Expected Profit</div>
                                <div style="color: #ffb347;">$${transfer.opportunity.netProfit.toFixed(2)}</div>
                            </div>
                            ${transfer.actualProfit !== null ? `
                                <div>
                                    <div style="color: #7f8fa6; font-size: 0.75rem;">Actual Profit</div>
                                    <div style="color: ${transfer.actualProfit > 0 ? '#00ff88' : '#ff6b6b'}; font-weight: bold;">
                                        $${transfer.actualProfit.toFixed(2)}
                                    </div>
                                </div>
                            ` : ''}
                            <div>
                                <div style="color: #7f8fa6; font-size: 0.75rem;">Duration</div>
                                <div style="color: #b8c6db;">${duration}</div>
                            </div>
                        </div>
                        ${transfer.error ? `
                            <div style="background: rgba(255,107,107,0.1); border: 1px solid #ff6b6b; border-radius: 5px; padding: 10px; margin-top: 10px;">
                                <div style="color: #ff6b6b; font-size: 0.85rem;">${transfer.error}</div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');

            historySection.style.display = 'block';
        }

        function testTransferRoute() {
            const source = document.getElementById('sourceExchange').value;
            const dest = document.getElementById('destExchange').value;
            if (!source || !dest) {
                alert('Please select both source and destination exchanges');
                return;
            }
            alert(`Testing transfer route from ${source} to ${dest}...`);
        }

        // Continuous Scan Variables
        let continuousScanInterval = null;
        let isAutoExecuteActive = false;
        const SCAN_INTERVAL_MS = 60000; // 60 seconds (changed from 30s to reduce API load)

        // Trade Locking System - Prevent Duplicate Trades
        const activeTrades = new Map(); // { "XRP_binance_kraken": { startTime, crypto, route, estimatedCompletion } }
        const routeCooldowns = new Map(); // { "XRP_binance_kraken": cooldownUntilTimestamp }
        const MAX_CONCURRENT_TRADES = 5; // Maximum simultaneous transfers
        const ROUTE_COOLDOWN_MS = 10 * 60 * 1000; // 10 minutes cooldown after trade completes

        // Trade Locking Helper Functions
        function getTradeKey(crypto, fromExchange, toExchange) {
            return `${crypto}_${fromExchange}_${toExchange}`;
        }

        function isTradeActive(tradeKey) {
            return activeTrades.has(tradeKey);
        }

        function isRouteCoolingDown(tradeKey) {
            if (!routeCooldowns.has(tradeKey)) return false;

            const cooldownUntil = routeCooldowns.get(tradeKey);
            const now = Date.now();

            if (now >= cooldownUntil) {
                // Cooldown expired, remove it
                routeCooldowns.delete(tradeKey);
                return false;
            }

            return true;
        }

        function canExecuteTrade(opportunity) {
            const tradeKey = getTradeKey(opportunity.crypto, opportunity.fromExchange, opportunity.toExchange);

            // Check if this exact route is already executing
            if (isTradeActive(tradeKey)) {
                console.log(`‚è∏Ô∏è Skipping ${tradeKey} - already executing`);
                return false;
            }

            // Check if route is in cooldown
            if (isRouteCoolingDown(tradeKey)) {
                const cooldownUntil = routeCooldowns.get(tradeKey);
                const remainingSeconds = Math.ceil((cooldownUntil - Date.now()) / 1000);
                console.log(`‚ùÑÔ∏è Skipping ${tradeKey} - cooling down for ${remainingSeconds}s`);
                return false;
            }

            // Check max concurrent trades limit
            if (activeTrades.size >= MAX_CONCURRENT_TRADES) {
                console.log(`‚è∏Ô∏è Skipping ${tradeKey} - max concurrent trades (${MAX_CONCURRENT_TRADES}) reached`);
                return false;
            }

            return true;
        }

        function lockTrade(opportunity) {
            const tradeKey = getTradeKey(opportunity.crypto, opportunity.fromExchange, opportunity.toExchange);
            const now = Date.now();
            const transferTimeMs = (opportunity.estimatedTransferTime || 15) * 60 * 1000; // Convert minutes to ms
            const bufferMs = 2 * 60 * 1000; // 2 minute buffer
            const estimatedCompletion = now + transferTimeMs + bufferMs;

            activeTrades.set(tradeKey, {
                startTime: now,
                crypto: opportunity.crypto,
                route: `${opportunity.fromExchange} ‚Üí ${opportunity.toExchange}`,
                fromExchange: opportunity.fromExchange,
                toExchange: opportunity.toExchange,
                estimatedCompletion: estimatedCompletion,
                transferTimeMinutes: opportunity.estimatedTransferTime || 15,
                profit: opportunity.netProfit,
                profitPercent: opportunity.netProfitPercent
            });

            console.log(`üîí Locked ${tradeKey} for ${Math.ceil((estimatedCompletion - now) / 1000 / 60)} minutes`);

            // Auto-unlock after estimated time + buffer
            setTimeout(() => {
                if (activeTrades.has(tradeKey)) {
                    unlockTrade(tradeKey);
                }
            }, transferTimeMs + bufferMs);
        }

        function unlockTrade(tradeKey) {
            if (activeTrades.has(tradeKey)) {
                const trade = activeTrades.get(tradeKey);
                activeTrades.delete(tradeKey);

                // Start cooldown period
                const cooldownUntil = Date.now() + ROUTE_COOLDOWN_MS;
                routeCooldowns.set(tradeKey, cooldownUntil);

                console.log(`üîì Unlocked ${tradeKey}, cooldown until ${new Date(cooldownUntil).toLocaleTimeString()}`);

                // Auto-remove cooldown after period expires
                setTimeout(() => {
                    routeCooldowns.delete(tradeKey);
                    console.log(`‚úÖ Cooldown expired for ${tradeKey}`);
                }, ROUTE_COOLDOWN_MS);

                // Update UI
                updateActiveTradesUI();
            }
        }

        function getActiveTradesInfo() {
            const trades = [];
            const now = Date.now();

            for (const [key, trade] of activeTrades.entries()) {
                const elapsedSeconds = Math.floor((now - trade.startTime) / 1000);
                const remainingSeconds = Math.max(0, Math.floor((trade.estimatedCompletion - now) / 1000));

                trades.push({
                    key,
                    ...trade,
                    elapsedSeconds,
                    remainingSeconds,
                    elapsedMinutes: Math.floor(elapsedSeconds / 60),
                    remainingMinutes: Math.ceil(remainingSeconds / 60)
                });
            }

            return trades;
        }

        // Update Active Trades UI
        function updateActiveTradesUI() {
            const pendingElement = document.getElementById('pendingTransfers');
            if (pendingElement) {
                pendingElement.textContent = activeTrades.size;
            }

            // Update active trades count
            const countElement = document.getElementById('activeTradesCount');
            if (countElement) {
                countElement.textContent = activeTrades.size;
            }

            const maxCountElement = document.getElementById('maxTradesCount');
            if (maxCountElement) {
                maxCountElement.textContent = MAX_CONCURRENT_TRADES;
            }

            // Show/hide dashboard based on auto-execute status
            const dashboard = document.getElementById('activeTradesDashboard');
            if (dashboard && isAutoExecuteActive) {
                dashboard.style.display = 'block';
            } else if (dashboard && !isAutoExecuteActive) {
                dashboard.style.display = 'none';
            }

            // Update active trades detail section if it exists
            const activeTradesSection = document.getElementById('activeTradesDetail');
            if (!activeTradesSection) return;

            const trades = getActiveTradesInfo();

            if (trades.length === 0) {
                activeTradesSection.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: #888;">
                        <div style="font-size: 3rem; margin-bottom: 10px;">üí§</div>
                        <div style="font-size: 1.1rem; margin-bottom: 5px;">No Active Trades</div>
                        <div style="font-size: 0.85rem;">Waiting for profitable opportunities...</div>
                    </div>
                `;
                return;
            }

            activeTradesSection.innerHTML = `
                <div style="display: grid; gap: 15px;">
                    ${trades.map(trade => `
                        <div style="background: rgba(0,212,255,0.1); border: 2px solid #00d4ff; border-radius: 12px; padding: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <div>
                                    <div style="font-size: 1.1rem; font-weight: bold; color: #00ff88;">
                                        ${trade.crypto}
                                    </div>
                                    <div style="font-size: 0.85rem; color: #b8c6db; margin-top: 2px;">
                                        ${trade.route}
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 1rem; font-weight: bold; color: #00ff88;">
                                        +${trade.profitPercent.toFixed(2)}%
                                    </div>
                                    <div style="font-size: 0.8rem; color: #b8c6db;">
                                        $${trade.profit.toFixed(2)}
                                    </div>
                                </div>
                            </div>

                            <div style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 10px; margin-top: 10px;">
                                <div style="display: flex; justify-content: space-between; font-size: 0.85rem; color: #b8c6db;">
                                    <span>‚è±Ô∏è Elapsed: ${trade.elapsedMinutes}m ${trade.elapsedSeconds % 60}s</span>
                                    <span>‚è≥ Remaining: ~${trade.remainingMinutes}m</span>
                                </div>
                                <div style="margin-top: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; height: 6px; overflow: hidden;">
                                    <div style="background: linear-gradient(90deg, #00ff88, #00d4ff); height: 100%; width: ${Math.min(100, (trade.elapsedSeconds / (trade.transferTimeMinutes * 60)) * 100)}%; transition: width 1s;"></div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Start continuous scanning
        function startContinuousScan() {
            if (continuousScanInterval) {
                console.log('‚ö†Ô∏è Continuous scan already running');
                return;
            }

            isAutoExecuteActive = true;
            console.log('üöÄ Starting continuous scan every', SCAN_INTERVAL_MS / 1000, 'seconds');
            console.log(`   Max concurrent trades: ${MAX_CONCURRENT_TRADES}`);
            console.log(`   Route cooldown: ${ROUTE_COOLDOWN_MS / 1000 / 60} minutes`);

            // Show active trades dashboard
            updateActiveTradesUI();

            // Run first scan immediately
            scanWithAutoExecute();

            // Then schedule recurring scans
            continuousScanInterval = setInterval(() => {
                scanWithAutoExecute();
            }, SCAN_INTERVAL_MS);

            // Update UI every 5 seconds to show live progress
            const uiUpdateInterval = setInterval(() => {
                if (!isAutoExecuteActive) {
                    clearInterval(uiUpdateInterval);
                    return;
                }
                updateActiveTradesUI();
            }, 5000);
        }

        // Stop continuous scanning
        function stopContinuousScan() {
            if (continuousScanInterval) {
                clearInterval(continuousScanInterval);
                continuousScanInterval = null;
                isAutoExecuteActive = false;
                console.log('‚è∏Ô∏è Continuous scan stopped');
            }
        }

        // Scan with auto-execute logic
        async function scanWithAutoExecute() {
            console.log('üîç Auto-scan starting...');

            const connectedExchanges = getConnectedExchanges();

            if (connectedExchanges.length < 2) {
                console.warn('‚ö†Ô∏è Need at least 2 connected exchanges for auto-execute');
                return;
            }

            if (selectedCryptos.length === 0) {
                console.warn('‚ö†Ô∏è No cryptocurrencies selected for scanning');
                return;
            }

            // Get risk settings
            const minPriceDiff = parseFloat(document.getElementById('minPriceDiff').value);
            const maxTransferAmount = parseFloat(document.getElementById('maxTransferAmount').value);
            const maxTransferTime = parseFloat(document.getElementById('maxTransferTime').value);
            const includeFees = document.getElementById('includeFeesToggle').classList.contains('active');

            console.log('üìä Risk Settings:', {
                minPriceDiff: minPriceDiff + '%',
                maxTransferAmount: '$' + maxTransferAmount,
                maxTransferTime: maxTransferTime + ' mins',
                includeFees
            });

            try {
                // Get opportunities (currently returns mock data)
                const opportunities = await getMockOpportunities(connectedExchanges);

                // Filter by risk settings
                const filteredOpportunities = opportunities.filter(opp => {
                    const meetsProfit = opp.netProfitPercent >= minPriceDiff;
                    const meetsAmount = opp.usdtToSpend <= maxTransferAmount;
                    const meetsTime = opp.estimatedTransferTime <= maxTransferTime;

                    return meetsProfit && meetsAmount && meetsTime && opp.profitable;
                });

                console.log(`‚úÖ Found ${filteredOpportunities.length} opportunities meeting criteria (${opportunities.length} total)`);
                console.log(`üîí Active trades: ${activeTrades.size}/${MAX_CONCURRENT_TRADES}`);

                if (filteredOpportunities.length > 0 && isAutoExecuteActive) {
                    // Sort by profit
                    const sortedOpps = filteredOpportunities.sort((a, b) => b.netProfitPercent - a.netProfitPercent);

                    // Try to find an opportunity we can execute (not locked, not cooling down)
                    let bestExecutableOpp = null;
                    for (const opp of sortedOpps) {
                        if (canExecuteTrade(opp)) {
                            bestExecutableOpp = opp;
                            break;
                        }
                    }

                    if (!bestExecutableOpp) {
                        console.log('‚è∏Ô∏è No executable opportunities (all locked or cooling down)');
                        // Update display anyway
                        displayOpportunities(filteredOpportunities);
                        updateActiveTradesUI();
                        return;
                    }

                    console.log('üíé Best executable opportunity:', bestExecutableOpp);
                    console.log(`   ${bestExecutableOpp.crypto}: ${bestExecutableOpp.fromExchange} ‚Üí ${bestExecutableOpp.toExchange}`);
                    console.log(`   Profit: $${bestExecutableOpp.netProfit} (${bestExecutableOpp.netProfitPercent}%)`);

                    // ‚ö†Ô∏è SAFETY CHECK: Validate deposit address exists before executing
                    const depositAddress = localStorage.getItem(`deposit_${bestExecutableOpp.toExchange}_${bestExecutableOpp.crypto}_deposit`);
                    if (!depositAddress) {
                        console.error('‚ö†Ô∏è CRITICAL: No deposit address configured for auto-execute');
                        stopContinuousScan();
                        alert(`‚ö†Ô∏è AUTO-EXECUTE STOPPED\n\nMissing Deposit Address:\n${bestExecutableOpp.toExchange} - ${bestExecutableOpp.crypto}\n\nPlease configure the deposit address in "Deposit Address Configuration" before enabling auto-execute.`);
                        return;
                    }

                    // ‚ö†Ô∏è SAFETY CHECK: Validate destination tag for XRP/XLM
                    if (['XRP', 'XLM'].includes(bestExecutableOpp.crypto)) {
                        const tag = localStorage.getItem(`deposit_${bestExecutableOpp.toExchange}_${bestExecutableOpp.crypto}_tag`);
                        if (!tag) {
                            console.error('‚ö†Ô∏è CRITICAL: No destination tag configured for XRP/XLM');
                            stopContinuousScan();
                            alert(`‚ö†Ô∏è AUTO-EXECUTE STOPPED\n\n${bestExecutableOpp.crypto} requires a DESTINATION TAG!\n\nExchange: ${bestExecutableOpp.toExchange}\n\nFunds will be LOST without a tag. Please configure it in "Deposit Address Configuration".`);
                            return;
                        }
                    }

                    // üîí LOCK THE TRADE BEFORE EXECUTING
                    lockTrade(bestExecutableOpp);

                    // Execute the trade automatically (safe to proceed)
                    await executeTransfer(bestExecutableOpp);
                }

                // Update display
                displayOpportunities(filteredOpportunities);
                updateActiveTradesUI();

            } catch (error) {
                console.error('‚ùå Auto-scan error:', error);
            }
        }

        function quickCalculate() {
            const buyPrice = parseFloat(document.getElementById('buyPrice').value) || 0;
            const sellPrice = parseFloat(document.getElementById('sellPrice').value) || 0;
            const amount = parseFloat(document.getElementById('calcAmount').value) || 0;
            const fee = parseFloat(document.getElementById('networkFee').value) || 0;

            if (!buyPrice || !sellPrice || !amount) {
                alert('Please fill in all fields');
                return;
            }

            const quantity = amount / buyPrice;
            const revenue = quantity * sellPrice;
            const profit = revenue - amount - fee;
            const profitPercent = (profit / amount) * 100;

            const resultDiv = document.getElementById('calculationResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `
                <h5 style="color: #00ff88; margin-bottom: 10px;">üìä Calculation Results</h5>
                <div style="display: grid; grid-template-columns: 1fr auto; gap: 10px; font-size: 0.9rem;">
                    <span style="color: #b8c6db;">Amount to Transfer:</span>
                    <span style="color: #fff;">$${amount.toFixed(2)}</span>

                    <span style="color: #b8c6db;">Quantity:</span>
                    <span style="color: #fff;">${quantity.toFixed(8)}</span>

                    <span style="color: #b8c6db;">Revenue at Destination:</span>
                    <span style="color: #fff;">$${revenue.toFixed(2)}</span>

                    <span style="color: #b8c6db;">Network Fee:</span>
                    <span style="color: #ff6b6b;">-$${fee.toFixed(2)}</span>

                    <span style="color: #b8c6db; font-weight: bold;">Net Profit:</span>
                    <span style="color: ${profit > 0 ? '#00ff88' : '#ff6b6b'}; font-weight: bold;">
                        ${profit > 0 ? '+' : ''}$${profit.toFixed(2)} (${profitPercent.toFixed(2)}%)
                    </span>
                </div>
                ${profit <= 0 ? '<p style="color: #ff6b6b; margin-top: 10px; font-size: 0.85rem;">‚ö†Ô∏è This transfer would result in a loss!</p>' : ''}
                ${profitPercent > 0 && profitPercent < 1 ? '<p style="color: #ffb347; margin-top: 10px; font-size: 0.85rem;">‚ö†Ô∏è Low profit margin - consider risks carefully</p>' : ''}
            `;
        }

        // Tab Switching Functionality
        function switchTab(tab) {
            console.log('üìë Switching to tab:', tab);

            const rebalanceTab = document.getElementById('tab-rebalance');
            const paymentTab = document.getElementById('tab-payment');
            const rebalanceForm = document.getElementById('rebalance-form');
            const paymentForm = document.getElementById('payment-form');

            if (tab === 'rebalance') {
                // Activate rebalance tab
                rebalanceTab.style.background = 'linear-gradient(45deg, #00ff88 0%, #00d4ff 100%)';
                paymentTab.style.background = 'rgba(102,126,234,0.3)';
                rebalanceForm.style.display = 'block';
                paymentForm.style.display = 'none';
            } else if (tab === 'payment') {
                // Activate payment tab
                rebalanceTab.style.background = 'rgba(0,255,136,0.3)';
                paymentTab.style.background = 'linear-gradient(45deg, #667eea 0%, #764ba2 100%)';
                rebalanceForm.style.display = 'none';
                paymentForm.style.display = 'block';

                // Load saved payment fields
                loadPaymentFields();
            }
        }

        // Save payment field to localStorage
        function savePaymentField(field, value) {
            localStorage.setItem(`payment_${field}`, value);
            console.log(`üíæ Auto-saved payment field: ${field}`);
        }

        // Load saved payment fields from localStorage
        function loadPaymentFields() {
            const fields = {
                'fromExchange': 'paymentFromExchange',
                'crypto': 'paymentCrypto',
                'amount': 'paymentAmount',
                'address': 'paymentAddress',
                'tag': 'paymentTag',
                'description': 'paymentDescription'
            };

            let loadedCount = 0;
            Object.keys(fields).forEach(field => {
                const value = localStorage.getItem(`payment_${field}`);
                const element = document.getElementById(fields[field]);
                if (value && element) {
                    element.value = value;
                    loadedCount++;
                }
            });

            if (loadedCount > 0) {
                console.log(`‚úÖ Loaded ${loadedCount} saved payment fields`);
            }
        }

        // Auto-calculate transfer/payment cost
        async function autoCalculateTransfer() {
            const calculatorSource = document.getElementById('calculatorSource');
            const resultDiv = document.getElementById('calculationResult');

            // Detect which tab is active
            const rebalanceForm = document.getElementById('rebalance-form');
            const paymentForm = document.getElementById('payment-form');
            const isRebalanceActive = rebalanceForm.style.display !== 'none';
            const isPaymentActive = paymentForm.style.display !== 'none';

            // Get values based on active tab
            let fromExchange, toExchange, crypto, amount;

            if (isRebalanceActive) {
                fromExchange = document.getElementById('rebalanceFromExchange').value;
                toExchange = document.getElementById('rebalanceToExchange').value;
                crypto = document.getElementById('rebalanceCrypto').value;
                amount = parseFloat(document.getElementById('rebalanceAmount').value);
            } else if (isPaymentActive) {
                fromExchange = document.getElementById('paymentFromExchange').value;
                crypto = document.getElementById('paymentCrypto').value;
                amount = parseFloat(document.getElementById('paymentAmount').value);
                toExchange = null; // Payment doesn't have destination exchange
            } else {
                return; // No active tab
            }

            // Reset if incomplete
            if (!fromExchange || !crypto || !amount || amount <= 0 || (isRebalanceActive && !toExchange)) {
                calculatorSource.style.display = 'none';
                resultDiv.style.display = 'none';
                document.getElementById('buyPrice').value = '';
                document.getElementById('sellPrice').value = '';
                document.getElementById('calcAmount').value = '';
                document.getElementById('networkFee').value = '';
                return;
            }

            // Show calculation source
            calculatorSource.style.display = 'block';
            if (isRebalanceActive) {
                calculatorSource.innerHTML = `
                    üìä Calculating: <strong>${amount} ${crypto}</strong> |
                    ${fromExchange.toUpperCase()} ‚Üí ${toExchange.toUpperCase()}
                `;
            } else {
                calculatorSource.innerHTML = `
                    üí≥ Payment Cost: <strong>${amount} ${crypto}</strong> |
                    From ${fromExchange.toUpperCase()}
                `;
            }

            console.log('üßÆ Auto-calculating...', { fromExchange, toExchange, crypto, amount, mode: isRebalanceActive ? 'rebalance' : 'payment' });

            try {
                const baseURL = window.location.hostname === 'localhost'
                    ? 'http://localhost:3000'
                    : 'https://arb4me-unified-production.up.railway.app';

                const pair = `${crypto}USDT`;

                // Network fee estimates
                const networkFees = {
                    'XRP': 0.25,    'XLM': 0.01,    'TRX': 1,       'USDT': 1,
                    'USDC': 1,      'BTC': 0.0005,  'ETH': 0.002,   'BNB': 0.001,
                    'SOL': 0.000005,'LTC': 0.001
                };

                const networkFee = networkFees[crypto] || 0;

                // Fetch source exchange price
                let buyPrice = 0;
                try {
                    const buyResponse = await fetch(`${baseURL}/api/v1/trading/${fromExchange}/ticker?symbol=${pair}`);
                    const buyData = await buyResponse.json();
                    buyPrice = buyData.success ? parseFloat(buyData.data.lastPrice || buyData.data.last || 0) : 0;
                } catch (error) {
                    console.warn(`‚ö†Ô∏è Could not fetch ${fromExchange} price:`, error.message);
                }

                const networkFeeUSD = networkFee * buyPrice;

                // Update calculator inputs
                document.getElementById('buyPrice').value = buyPrice > 0 ? buyPrice.toFixed(6) : '';
                document.getElementById('calcAmount').value = amount;
                document.getElementById('networkFee').value = networkFeeUSD.toFixed(2);

                if (isRebalanceActive) {
                    // REBALANCE MODE: Compare two exchanges for arbitrage
                    let sellPrice = 0;
                    try {
                        const sellResponse = await fetch(`${baseURL}/api/v1/trading/${toExchange}/ticker?symbol=${pair}`);
                        const sellData = await sellResponse.json();
                        sellPrice = sellData.success ? parseFloat(sellData.data.lastPrice || sellData.data.last || 0) : 0;
                    } catch (error) {
                        console.warn(`‚ö†Ô∏è Could not fetch ${toExchange} price:`, error.message);
                    }

                    document.getElementById('sellPrice').value = sellPrice > 0 ? sellPrice.toFixed(6) : '';

                    if (buyPrice > 0 && sellPrice > 0) {
                        const valueAtSource = amount * buyPrice;
                        const valueAtDestination = amount * sellPrice;
                        const profit = valueAtDestination - valueAtSource - networkFeeUSD;
                        const profitPercent = (profit / valueAtSource) * 100;

                        resultDiv.style.display = 'block';
                        resultDiv.innerHTML = `
                            <h5 style="color: #00ff88; margin-bottom: 10px;">üìä Arbitrage Analysis</h5>
                            <div style="display: grid; grid-template-columns: 1fr auto; gap: 10px; font-size: 0.9rem;">
                                <span style="color: #b8c6db;">Amount:</span>
                                <span style="color: #fff;">${amount} ${crypto}</span>

                                <span style="color: #b8c6db;">Value at ${fromExchange.toUpperCase()}:</span>
                                <span style="color: #fff;">$${valueAtSource.toFixed(2)}</span>

                                <span style="color: #b8c6db;">Value at ${toExchange.toUpperCase()}:</span>
                                <span style="color: #fff;">$${valueAtDestination.toFixed(2)}</span>

                                <span style="color: #b8c6db;">Network Fee:</span>
                                <span style="color: #ff6b6b;">-$${networkFeeUSD.toFixed(2)} (~${networkFee} ${crypto})</span>

                                <span style="color: #b8c6db; font-weight: bold;">Net Profit/Loss:</span>
                                <span style="color: ${profit > 0 ? '#00ff88' : '#ff6b6b'}; font-weight: bold;">
                                    ${profit > 0 ? '+' : ''}$${profit.toFixed(2)} (${profitPercent.toFixed(2)}%)
                                </span>
                            </div>
                            ${profit <= 0 ? '<p style="color: #ff6b6b; margin-top: 10px; font-size: 0.85rem;">‚ö†Ô∏è This transfer would result in a loss. Only proceed if rebalancing is necessary.</p>' : ''}
                            ${profitPercent > 0 && profitPercent < 1 ? '<p style="color: #ffb347; margin-top: 10px; font-size: 0.85rem;">üí° Low profit margin detected</p>' : ''}
                            ${profitPercent > 1 ? '<p style="color: #00ff88; margin-top: 10px; font-size: 0.85rem;">‚úÖ Profitable arbitrage opportunity!</p>' : ''}
                        `;
                    } else {
                        resultDiv.style.display = 'block';
                        resultDiv.innerHTML = `<p style="color: #ffb347; text-align: center;">‚ö†Ô∏è Unable to fetch live prices. Please check exchange connection.</p>`;
                    }

                } else {
                    // PAYMENT MODE: Simple cost calculation
                    document.getElementById('sellPrice').value = ''; // Not applicable for payments

                    if (buyPrice > 0) {
                        const paymentValue = amount * buyPrice;
                        const recipientReceives = amount - networkFee;
                        const recipientValueUSD = recipientReceives * buyPrice;

                        resultDiv.style.display = 'block';
                        resultDiv.innerHTML = `
                            <h5 style="color: #667eea; margin-bottom: 10px;">üí≥ Payment Cost Breakdown</h5>
                            <div style="display: grid; grid-template-columns: 1fr auto; gap: 10px; font-size: 0.9rem;">
                                <span style="color: #b8c6db;">You Send:</span>
                                <span style="color: #fff; font-weight: bold;">${amount} ${crypto}</span>

                                <span style="color: #b8c6db;">Current Value:</span>
                                <span style="color: #fff;">$${paymentValue.toFixed(2)} USD</span>

                                <span style="color: #b8c6db;">Network Fee:</span>
                                <span style="color: #ff6b6b;">-${networkFee} ${crypto} ($${networkFeeUSD.toFixed(2)})</span>

                                <span style="color: #b8c6db; font-weight: bold;">Recipient Receives:</span>
                                <span style="color: #00ff88; font-weight: bold;">${recipientReceives.toFixed(8)} ${crypto} (~$${recipientValueUSD.toFixed(2)})</span>
                            </div>
                            <p style="color: #888; margin-top: 10px; font-size: 0.85rem;">üí° Price: $${buyPrice.toFixed(6)} per ${crypto} at ${fromExchange.toUpperCase()}</p>
                        `;
                    } else {
                        resultDiv.style.display = 'block';
                        resultDiv.innerHTML = `<p style="color: #ffb347; text-align: center;">‚ö†Ô∏è Unable to fetch live price from ${fromExchange.toUpperCase()}</p>`;
                    }
                }

            } catch (error) {
                console.error('‚ùå Auto-calculation error:', error);
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = `<p style="color: #ff6b6b; text-align: center;">‚ùå Calculation failed: ${error.message}</p>`;
            }
        }

        // Execute Rebalance Transfer
        async function executeRebalance() {
            console.log('üîÑ Executing rebalance transfer...');

            // Get form values
            const fromExchange = document.getElementById('rebalanceFromExchange').value;
            const toExchange = document.getElementById('rebalanceToExchange').value;
            const crypto = document.getElementById('rebalanceCrypto').value;
            const amount = parseFloat(document.getElementById('rebalanceAmount').value);

            // Validate inputs
            if (!fromExchange) {
                alert('‚ö†Ô∏è Please select a source exchange');
                return;
            }

            if (!toExchange) {
                alert('‚ö†Ô∏è Please select a destination exchange');
                return;
            }

            if (fromExchange === toExchange) {
                alert('‚ö†Ô∏è Source and destination exchanges must be different');
                return;
            }

            if (!crypto) {
                alert('‚ö†Ô∏è Please select a cryptocurrency');
                return;
            }

            if (!amount || amount <= 0) {
                alert('‚ö†Ô∏è Please enter a valid amount');
                return;
            }

            // Check if both exchanges are connected
            const connectedExchanges = getConnectedExchanges();
            if (!connectedExchanges.includes(fromExchange)) {
                alert(`‚ö†Ô∏è ${fromExchange.toUpperCase()} is not connected. Please configure it in Strategy API Setup.`);
                return;
            }

            if (!connectedExchanges.includes(toExchange)) {
                alert(`‚ö†Ô∏è ${toExchange.toUpperCase()} is not connected. Please configure it in Strategy API Setup.`);
                return;
            }

            // Get destination deposit address
            const depositKey = `deposit_${toExchange}_${crypto}_deposit`;
            const destinationAddress = localStorage.getItem(depositKey);

            if (!destinationAddress) {
                alert(`‚ö†Ô∏è No ${crypto} deposit address configured for ${toExchange.toUpperCase()}.\n\nPlease configure it in the Deposit Address Configuration section above.`);
                return;
            }

            console.log('üìä Rebalance Request:', {
                from: fromExchange,
                to: toExchange,
                crypto: crypto,
                amount: amount,
                destinationAddress: destinationAddress
            });

            // Show confirmation
            const confirmed = confirm(
                `üîÑ Confirm Rebalance Transfer\n\n` +
                `From: ${fromExchange.toUpperCase()}\n` +
                `To: ${toExchange.toUpperCase()}\n` +
                `Amount: ${amount} ${crypto}\n\n` +
                `This will withdraw ${amount} ${crypto} from ${fromExchange} and send it to your ${toExchange} account.\n\n` +
                `Do you want to proceed?`
            );

            if (!confirmed) {
                console.log('‚ùå Rebalance cancelled by user');
                return;
            }

            // TODO: Call withdrawal API
            alert('üöß Rebalance execution coming soon! This will call the withdrawal API to transfer your crypto.');

            // Log the transaction
            console.log('‚úÖ Rebalance would execute:', {
                fromExchange,
                toExchange,
                crypto,
                amount,
                destinationAddress
            });
        }

        // Execute Crypto Payment
        async function executeCryptoPayment() {
            console.log('üí≥ Executing crypto payment...');

            // Get form values
            const fromExchange = document.getElementById('paymentFromExchange').value;
            const crypto = document.getElementById('paymentCrypto').value;
            const amount = parseFloat(document.getElementById('paymentAmount').value);
            const recipientAddress = document.getElementById('paymentAddress').value.trim();
            const recipientTag = document.getElementById('paymentTag').value.trim();
            const description = document.getElementById('paymentDescription').value.trim();

            // Validate inputs
            if (!fromExchange) {
                alert('‚ö†Ô∏è Please select a source exchange');
                return;
            }

            if (!crypto) {
                alert('‚ö†Ô∏è Please select a cryptocurrency');
                return;
            }

            if (!amount || amount <= 0) {
                alert('‚ö†Ô∏è Please enter a valid amount');
                return;
            }

            if (!recipientAddress) {
                alert('‚ö†Ô∏è Please enter the recipient\'s wallet address');
                return;
            }

            // Check if XRP/XLM and tag is required
            if ((crypto === 'XRP' || crypto === 'XLM') && !recipientTag) {
                const proceed = confirm(`‚ö†Ô∏è Warning: ${crypto} usually requires a Tag/Memo.\n\nYou haven't provided one. Are you sure the recipient doesn't need a tag?`);
                if (!proceed) return;
            }

            // Check if exchange is connected
            const connectedExchanges = getConnectedExchanges();
            if (!connectedExchanges.includes(fromExchange)) {
                alert(`‚ö†Ô∏è ${fromExchange.toUpperCase()} is not connected. Please configure it in Strategy API Setup.`);
                return;
            }

            console.log('üí≥ Payment Request:', {
                from: fromExchange,
                crypto: crypto,
                amount: amount,
                recipient: recipientAddress,
                tag: recipientTag,
                description: description
            });

            // Show confirmation
            const confirmed = confirm(
                `üí≥ Confirm Crypto Payment\n\n` +
                `From: ${fromExchange.toUpperCase()}\n` +
                `Amount: ${amount} ${crypto}\n` +
                `To: ${recipientAddress.substring(0, 20)}...\n` +
                (recipientTag ? `Tag/Memo: ${recipientTag}\n` : '') +
                (description ? `Description: ${description}\n` : '') +
                `\nThis action cannot be undone!\n\n` +
                `Do you want to proceed?`
            );

            if (!confirmed) {
                console.log('‚ùå Payment cancelled by user');
                return;
            }

            // TODO: Call withdrawal API
            alert('üöß Payment execution coming soon! This will call the withdrawal API to send crypto to the recipient.');

            // Log the transaction
            console.log('‚úÖ Payment would execute:', {
                fromExchange,
                crypto,
                amount,
                recipientAddress,
                recipientTag,
                description
            });
        }

        // Smart Money Transfer Route Finder (OLD - will be deprecated)
        async function findBestTransferRoute() {
            console.log('üí∏ Finding best transfer route...');

            // Get form values
            const fromExchange = document.getElementById('smartFromExchange').value;
            const toExchange = document.getElementById('smartToExchange').value;
            const amount = parseFloat(document.getElementById('smartTransferAmount').value);
            const preferredCrypto = document.getElementById('smartTransferCrypto').value;

            // Validate inputs
            if (!fromExchange) {
                alert('‚ö†Ô∏è Please select a source exchange');
                return;
            }

            if (!toExchange) {
                alert('‚ö†Ô∏è Please select a destination exchange');
                return;
            }

            if (fromExchange === toExchange) {
                alert('‚ö†Ô∏è Source and destination exchanges must be different');
                return;
            }

            if (!amount || amount < 100) {
                alert('‚ö†Ô∏è Please enter a valid transfer amount (minimum $100)');
                return;
            }

            // Check if both exchanges are connected
            const connectedExchanges = getConnectedExchanges();
            if (!connectedExchanges.includes(fromExchange)) {
                alert(`‚ö†Ô∏è ${fromExchange.toUpperCase()} is not connected. Please configure it in Strategy API Setup.`);
                return;
            }

            if (!connectedExchanges.includes(toExchange)) {
                alert(`‚ö†Ô∏è ${toExchange.toUpperCase()} is not connected. Please configure it in Strategy API Setup.`);
                return;
            }

            // Get smart transfer risk settings
            const minProfit = parseFloat(document.getElementById('smartMinProfit').value) || 0;
            const maxTime = parseFloat(document.getElementById('smartMaxTime').value) || 60;
            const includeFees = document.getElementById('smartIncludeFeesToggle').classList.contains('active');

            console.log('üìä Smart Transfer Request:', {
                from: fromExchange,
                to: toExchange,
                amount: amount,
                crypto: preferredCrypto || 'auto',
                minProfit: minProfit + '%',
                maxTime: maxTime + ' mins',
                includeFees: includeFees
            });

            // Show loading state
            const resultsDiv = document.getElementById('smart-transfer-results');
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = `
                <div class="stat-card" style="text-align: center; padding: 40px;">
                    <div style="font-size: 2rem; margin-bottom: 15px;">‚è≥</div>
                    <div style="color: #00d4ff; font-size: 1.1rem;">Analyzing transfer routes...</div>
                    <div style="color: #b8c6db; font-size: 0.9rem; margin-top: 10px;">
                        Checking prices across ${fromExchange} and ${toExchange}
                    </div>
                </div>
            `;

            try {
                // Determine which cryptos to check
                const cryptosToCheck = preferredCrypto ? [preferredCrypto] : selectedCryptos.length > 0 ? selectedCryptos : ['XRP', 'XLM', 'TRX'];

                console.log('üîç Checking cryptos:', cryptosToCheck);

                // Call scanner API for this specific route (use user's minProfit setting)
                const params = new URLSearchParams({
                    cryptos: JSON.stringify(cryptosToCheck),
                    exchanges: JSON.stringify([fromExchange, toExchange]),
                    minProfit: minProfit // Use smart transfer min profit setting
                });

                const response = await fetch(`/api/v1/transfer-arb/scan?${params.toString()}`);
                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'Failed to find routes');
                }

                // Filter opportunities for this specific route (from ‚Üí to)
                let routes = data.data.opportunities.filter(opp =>
                    opp.fromExchange === fromExchange && opp.toExchange === toExchange
                );

                // Apply additional filters based on smart transfer settings
                routes = routes.filter(opp => {
                    const meetsProfit = opp.netProfitPercent >= minProfit;
                    const meetsTime = opp.estimatedTransferTime <= maxTime;
                    return meetsProfit && meetsTime;
                });

                console.log(`‚úÖ Found ${routes.length} routes meeting criteria (min profit: ${minProfit}%, max time: ${maxTime} mins)`);

                // Display results
                displaySmartTransferResults(routes, fromExchange, toExchange, amount);

            } catch (error) {
                console.error('‚ùå Error finding routes:', error);
                resultsDiv.innerHTML = `
                    <div class="stat-card" style="background: rgba(255,107,107,0.2); border: 1px solid #ff6b6b;">
                        <h4 style="color: #ff6b6b;">‚ùå Error Finding Routes</h4>
                        <p style="color: #b8c6db;">${error.message}</p>
                        <p style="color: #b8c6db; font-size: 0.85rem; margin-top: 10px;">
                            Please ensure both exchanges are properly configured with API credentials.
                        </p>
                    </div>
                `;
            }
        }

        // Display smart transfer route results
        function displaySmartTransferResults(routes, fromExchange, toExchange, amount) {
            const resultsDiv = document.getElementById('smart-transfer-results');

            if (routes.length === 0) {
                resultsDiv.innerHTML = `
                    <div class="stat-card" style="background: rgba(255,179,71,0.1); border: 1px solid #ffb347;">
                        <h4 style="color: #ffb347;">‚ö†Ô∏è No Arbitrage Routes Available</h4>
                        <p style="color: #b8c6db; margin-top: 10px;">
                            No profitable arbitrage routes found from <strong>${fromExchange.toUpperCase()}</strong> to <strong>${toExchange.toUpperCase()}</strong>.
                        </p>
                        <p style="color: #b8c6db; margin-top: 10px;">
                            You can still execute a direct transfer if needed, but there's no arbitrage profit opportunity at this time.
                        </p>
                    </div>
                `;
                return;
            }

            // Sort routes by profit
            routes.sort((a, b) => b.netProfit - a.netProfit);
            const bestRoute = routes[0];

            resultsDiv.innerHTML = `
                <div class="stat-card" style="background: rgba(0,255,136,0.1); border: 2px solid #00ff88;">
                    <h4 style="color: #00ff88; margin-bottom: 20px;">‚úÖ Best Transfer Route Found!</h4>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
                        <div style="text-align: center; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                            <div style="color: #888; font-size: 0.85rem;">Cryptocurrency</div>
                            <div style="color: #00d4ff; font-size: 1.3rem; font-weight: bold;">${bestRoute.crypto}</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                            <div style="color: #888; font-size: 0.85rem;">Transfer Time</div>
                            <div style="color: #ffb347; font-size: 1.3rem; font-weight: bold;">~${bestRoute.estimatedTransferTime} min</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                            <div style="color: #888; font-size: 0.85rem;">Net Result</div>
                            <div style="color: ${bestRoute.netProfit >= 0 ? '#00ff88' : '#ff6b6b'}; font-size: 1.3rem; font-weight: bold;">
                                ${bestRoute.netProfit >= 0 ? '+' : ''}$${bestRoute.netProfit.toFixed(2)}
                            </div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                            <div style="color: #888; font-size: 0.85rem;">Profit %</div>
                            <div style="color: ${bestRoute.netProfitPercent >= 0 ? '#00ff88' : '#ff6b6b'}; font-size: 1.3rem; font-weight: bold;">
                                ${bestRoute.netProfitPercent >= 0 ? '+' : ''}${bestRoute.netProfitPercent.toFixed(2)}%
                            </div>
                        </div>
                    </div>

                    <div style="background: rgba(0,212,255,0.1); border: 1px solid #00d4ff; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                        <h5 style="color: #00d4ff; margin-bottom: 15px;">üìã Transfer Route:</h5>
                        <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap; justify-content: center;">
                            <div style="text-align: center;">
                                <div style="color: #00ff88; font-weight: bold; font-size: 1.1rem;">${fromExchange.toUpperCase()}</div>
                                <div style="color: #888; font-size: 0.85rem; margin-top: 5px;">Source</div>
                            </div>
                            <div style="color: #00d4ff; font-size: 1.5rem;">‚Üí</div>
                            <div style="text-align: center; padding: 10px 20px; background: rgba(102,126,234,0.2); border: 1px solid #667eea; border-radius: 8px;">
                                <div style="color: #667eea; font-weight: bold;">BUY ${bestRoute.crypto}</div>
                                <div style="color: #888; font-size: 0.85rem; margin-top: 3px;">$${bestRoute.buyPrice.toFixed(4)}</div>
                            </div>
                            <div style="color: #00d4ff; font-size: 1.5rem;">‚Üí</div>
                            <div style="text-align: center;">
                                <div style="color: #ffb347; font-weight: bold;">TRANSFER</div>
                                <div style="color: #888; font-size: 0.85rem; margin-top: 3px;">~${bestRoute.estimatedTransferTime} mins</div>
                            </div>
                            <div style="color: #00d4ff; font-size: 1.5rem;">‚Üí</div>
                            <div style="text-align: center; padding: 10px 20px; background: rgba(0,255,136,0.1); border: 1px solid #00ff88; border-radius: 8px;">
                                <div style="color: #00ff88; font-weight: bold;">SELL ${bestRoute.crypto}</div>
                                <div style="color: #888; font-size: 0.85rem; margin-top: 3px;">$${bestRoute.sellPrice.toFixed(4)}</div>
                            </div>
                            <div style="color: #00d4ff; font-size: 1.5rem;">‚Üí</div>
                            <div style="text-align: center;">
                                <div style="color: #00ff88; font-weight: bold; font-size: 1.1rem;">${toExchange.toUpperCase()}</div>
                                <div style="color: #888; font-size: 0.85rem; margin-top: 5px;">Destination</div>
                            </div>
                        </div>
                    </div>

                    ${bestRoute.netProfit >= 0 ?
                        `<div style="background: rgba(0,255,136,0.1); border: 1px solid #00ff88; border-radius: 8px; padding: 15px; margin-bottom: 20px; text-align: center;">
                            <div style="color: #00ff88; font-weight: bold; font-size: 1.1rem;">üí∞ PROFIT OPPORTUNITY!</div>
                            <div style="color: #b8c6db; margin-top: 8px;">
                                You need to transfer money anyway - and you'll make <strong style="color: #00ff88;">$${bestRoute.netProfit.toFixed(2)}</strong> profit doing it!
                            </div>
                        </div>` :
                        `<div style="background: rgba(255,179,71,0.1); border: 1px solid #ffb347; border-radius: 8px; padding: 15px; margin-bottom: 20px; text-align: center;">
                            <div style="color: #ffb347; font-weight: bold;">‚ÑπÔ∏è No Profit Available</div>
                            <div style="color: #b8c6db; margin-top: 8px;">
                                This route has a small loss of <strong style="color: #ff6b6b;">$${Math.abs(bestRoute.netProfit).toFixed(2)}</strong>, but may still be your best option if you need to transfer funds.
                            </div>
                        </div>`
                    }

                    <button onclick="executeTransfer(${JSON.stringify(bestRoute).replace(/"/g, '&quot;')})"
                            style="width: 100%; padding: 15px; background: linear-gradient(45deg, #00ff88 0%, #00d4ff 100%);
                                   color: #000; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1.1rem;">
                        üöÄ Execute Smart Transfer ($${amount.toFixed(0)})
                    </button>
                </div>

                ${routes.length > 1 ? `
                    <details style="margin-top: 20px;">
                        <summary style="cursor: pointer; color: #00d4ff; font-weight: bold; padding: 10px; background: rgba(0,212,255,0.1); border-radius: 8px;">
                            üìä View ${routes.length - 1} Alternative Route${routes.length > 2 ? 's' : ''}
                        </summary>
                        <div style="margin-top: 15px;">
                            ${routes.slice(1).map(route => `
                                <div class="stat-card" style="margin-bottom: 10px; padding: 15px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <strong style="color: #00d4ff;">${route.crypto}</strong>
                                            <span style="color: #888; margin-left: 10px;">~${route.estimatedTransferTime} min</span>
                                        </div>
                                        <div style="text-align: right;">
                                            <div style="color: ${route.netProfit >= 0 ? '#00ff88' : '#ff6b6b'}; font-weight: bold;">
                                                ${route.netProfit >= 0 ? '+' : ''}$${route.netProfit.toFixed(2)}
                                            </div>
                                            <div style="color: #888; font-size: 0.85rem;">
                                                ${route.netProfitPercent >= 0 ? '+' : ''}${route.netProfitPercent.toFixed(2)}%
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </details>
                ` : ''}
            `;
        }

        // ============================================================================
        // TRANSFER ARBITRAGE ABOUT MODAL
        // ============================================================================

        function openTransferAboutModal() {
            const modal = document.getElementById('transferAboutModal');
            if (modal) {
                modal.style.display = 'flex';
                console.log('‚ÑπÔ∏è [About Modal] Transfer Arbitrage info opened');
            }
        }

        function closeTransferAboutModal() {
            const modal = document.getElementById('transferAboutModal');
            if (modal) {
                modal.style.display = 'none';
                console.log('‚ÑπÔ∏è [About Modal] Transfer Arbitrage info closed');
            }
        }

        // Close modal when clicking outside the content
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('transferAboutModal');
            if (event.target === modal) {
                closeTransferAboutModal();
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeTransferAboutModal();
            }
        });

        // End of About Modal Functionality

        // ============================================================================
        // EXECUTION CONFIRMATION MODAL
        // ============================================================================

        // Store pending execution
        let pendingExecution = null;

        function showExecutionConfirmation(opportunity) {
            console.log('‚ö†Ô∏è [Confirmation Modal] Showing execution confirmation...', opportunity);

            // Store the opportunity for later execution
            pendingExecution = opportunity;

            // Get network info
            const fromNetwork = localStorage.getItem(`deposit_${opportunity.fromExchange}_${opportunity.crypto}_network`) || 'NOT SET';
            const toNetwork = localStorage.getItem(`deposit_${opportunity.toExchange}_${opportunity.crypto}_network`) || 'NOT SET';

            // Estimate transfer time based on crypto
            const transferTimes = {
                'XRP': 3,
                'XLM': 5,
                'TRX': 3,
                'LTC': 15,
                'DOGE': 10,
                'BCH': 15,
                'USDT': 5,
                'USDC': 10,
                'BTC': 30,
                'ETH': 10,
                'ADA': 20,
                'DOT': 15
            };
            const estimatedTransferTime = transferTimes[opportunity.crypto] || 15;

            // Populate confirmation details
            const detailsDiv = document.getElementById('confirmationDetails');
            detailsDiv.innerHTML = `
                <div style="background: rgba(0,212,255,0.1); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <div style="color: #00d4ff; font-weight: bold; margin-bottom: 10px;">üìä Trade Details</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; color: #b8c6db;">
                        <div><strong>Route:</strong></div>
                        <div style="text-align: right;">${opportunity.fromExchange} ‚Üí ${opportunity.toExchange}</div>

                        <div><strong>Cryptocurrency:</strong></div>
                        <div style="text-align: right;">${opportunity.crypto}</div>

                        <div><strong>Amount:</strong></div>
                        <div style="text-align: right;">$${opportunity.usdtToSpend.toFixed(2)} USDT</div>

                        <div><strong>Buy Price:</strong></div>
                        <div style="text-align: right;">$${opportunity.buyPrice.toFixed(6)}</div>

                        <div><strong>Sell Price:</strong></div>
                        <div style="text-align: right;">$${opportunity.sellPrice.toFixed(6)}</div>
                    </div>
                </div>

                <div style="background: rgba(0,255,136,0.1); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <div style="color: #00ff88; font-weight: bold; margin-bottom: 10px;">üí∞ Expected Profit</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; color: #b8c6db;">
                        <div><strong>Gross Profit:</strong></div>
                        <div style="text-align: right; color: #00ff88;">+$${opportunity.grossProfit.toFixed(2)}</div>

                        <div><strong>Trading Fees:</strong></div>
                        <div style="text-align: right; color: #ff6b6b;">-$${opportunity.totalTradingFees.toFixed(2)}</div>

                        <div><strong>Network Fee (Est):</strong></div>
                        <div style="text-align: right; color: #ff6b6b;">-$${opportunity.networkFee.toFixed(2)}</div>

                        <div style="padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.1);"><strong>Net Profit:</strong></div>
                        <div style="text-align: right; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.1); font-size: 1.2rem;">
                            <strong style="color: ${opportunity.netProfit >= 0 ? '#00ff88' : '#ff6b6b'};">
                                ${opportunity.netProfit >= 0 ? '+' : ''}$${opportunity.netProfit.toFixed(2)} (${opportunity.netProfitPercent.toFixed(2)}%)
                            </strong>
                        </div>
                    </div>
                </div>

                <div style="background: rgba(255,179,71,0.1); padding: 15px; border-radius: 8px;">
                    <div style="color: #ffb347; font-weight: bold; margin-bottom: 10px;">üîó Network Configuration</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; color: #b8c6db;">
                        <div><strong>Withdrawal Network:</strong></div>
                        <div style="text-align: right;">${fromNetwork}</div>

                        <div><strong>Deposit Network:</strong></div>
                        <div style="text-align: right;">${toNetwork}</div>

                        <div><strong>Network Match:</strong></div>
                        <div style="text-align: right;">
                            ${fromNetwork === toNetwork && fromNetwork !== 'NOT SET'
                                ? '<span style="color: #00ff88;">‚úÖ Verified</span>'
                                : '<span style="color: #ff4444;">‚ùå ERROR</span>'}
                        </div>
                    </div>
                </div>
            `;

            // Populate timeline
            const timelineDiv = document.getElementById('confirmationTimeline');
            timelineDiv.innerHTML = `
                <div style="font-family: monospace; color: #b8c6db; line-height: 1.8;">
                    1. <strong style="color: #00d4ff;">Buy ${opportunity.crypto}</strong> on ${opportunity.fromExchange} (~5-10 seconds)<br>
                    2. <strong style="color: #00d4ff;">Withdraw ${opportunity.crypto}</strong> from ${opportunity.fromExchange} (~10-30 seconds)<br>
                    3. <strong style="color: #ffb347;">Blockchain Transfer</strong> via ${fromNetwork} (~${estimatedTransferTime} minutes)<br>
                    4. <strong style="color: #ffb347;">Wait for Deposit</strong> on ${opportunity.toExchange} (~2-5 minutes)<br>
                    5. <strong style="color: #00ff88;">Sell ${opportunity.crypto}</strong> on ${opportunity.toExchange} (~5-10 seconds)<br>
                    <br>
                    <strong style="color: #00ff88;">Total Estimated Time: ${estimatedTransferTime + 8} - ${estimatedTransferTime + 15} minutes</strong>
                </div>
            `;

            // Show modal
            const modal = document.getElementById('executionConfirmationModal');
            if (modal) {
                modal.style.display = 'flex';
                console.log('‚úÖ [Confirmation Modal] Confirmation dialog displayed');
            }
        }

        function closeExecutionConfirmation() {
            console.log('‚ùå [Confirmation Modal] User cancelled execution');
            const modal = document.getElementById('executionConfirmationModal');
            if (modal) {
                modal.style.display = 'none';
            }
            pendingExecution = null;
        }

        async function confirmAndExecute() {
            console.log('‚úÖ [Confirmation Modal] User confirmed execution');

            if (!pendingExecution) {
                alert('‚ö†Ô∏è No pending execution found');
                return;
            }

            // Close the confirmation modal
            closeExecutionConfirmation();

            // Execute the transfer (call original execution logic)
            await executeTransferDirect(pendingExecution);

            // Clear pending execution
            pendingExecution = null;
        }

        // Close modal when clicking outside the content
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('executionConfirmationModal');
            if (event.target === modal) {
                closeExecutionConfirmation();
            }
        });

        // ============================================
        // TEST SCAN MODE - Opportunity Research Tool
        // Version: 2.0 - Simplified Exchange Detection
        // ============================================

        var testScanInterval = null;
        var testScanCountdownInterval = null;
        var testScanStartTime = null;
        var testScanCycleCount = 0;
        var testScanNextScanTime = null;

        // Initialize Test Scan Mode on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadTestScanExchanges();
            loadTestScanData();

            // Allow live config updates during scan
            document.getElementById('testScanMinProfit').addEventListener('change', function() {
                const config = JSON.parse(localStorage.getItem('testScan_config') || '{}');
                config.minProfit = parseFloat(this.value);
                localStorage.setItem('testScan_config', JSON.stringify(config));
                console.log(`‚úèÔ∏è Min profit updated to ${this.value}% (applies to next scan cycle)`);
            });

            document.getElementById('testScanInterval').addEventListener('change', function() {
                const config = JSON.parse(localStorage.getItem('testScan_config') || '{}');
                config.scanInterval = parseInt(this.value);
                localStorage.setItem('testScan_config', JSON.stringify(config));
                console.log(`‚è±Ô∏è Note: Scan interval change requires restart to take effect`);
            });

            // Load saved asset selection on page load
            function loadAssetSelection() {
                const config = JSON.parse(localStorage.getItem('testScan_config') || '{}');

                if (config.assets && config.assets.length > 0) {
                    console.log(`üì• Loading saved asset selection: ${config.assets.length} assets`);

                    // Uncheck all first
                    document.querySelectorAll('.test-scan-asset').forEach(cb => cb.checked = false);

                    // Check saved assets
                    config.assets.forEach(assetValue => {
                        const checkbox = document.querySelector(`.test-scan-asset[value="${assetValue}"]`);
                        if (checkbox) {
                            checkbox.checked = true;
                        }
                    });

                    // Update badge
                    updateAssetBadge(config.assets.length);

                    console.log(`‚úÖ Restored ${config.assets.length} asset selections`);
                } else {
                    console.log('‚ÑπÔ∏è No saved asset selection found, using defaults');
                    // Count currently checked defaults
                    const defaultCount = document.querySelectorAll('.test-scan-asset:checked').length;
                    updateAssetBadge(defaultCount);
                }
            }

            function updateAssetBadge(count) {
                const badge = document.getElementById('assetCountBadge');
                const warning = document.getElementById('assetWarning');

                if (badge) {
                    badge.textContent = `${count} selected`;

                    // Color coding
                    if (count > 10) {
                        badge.style.background = 'rgba(255,179,71,0.2)';
                        badge.style.color = '#ffb347';
                        if (warning) warning.style.display = 'block';
                    } else {
                        badge.style.background = 'rgba(0,255,136,0.2)';
                        badge.style.color = '#00ff88';
                        if (warning) warning.style.display = 'none';
                    }
                }
            }

            // Load saved selections
            loadAssetSelection();

            // Save asset selection whenever checkboxes change
            document.querySelectorAll('.test-scan-asset').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const selectedAssets = Array.from(document.querySelectorAll('.test-scan-asset:checked')).map(cb => cb.value);
                    const count = selectedAssets.length;

                    // Update badge
                    updateAssetBadge(count);

                    // Save to config
                    const config = JSON.parse(localStorage.getItem('testScan_config') || '{}');
                    config.assets = selectedAssets;
                    localStorage.setItem('testScan_config', JSON.stringify(config));
                    console.log(`‚úÖ Asset selection saved: ${count} assets -`, selectedAssets);
                });
            });

            // Initialize badge on page load
            setTimeout(() => {
                const count = document.querySelectorAll('.test-scan-asset:checked').length;
                const badge = document.getElementById('assetCountBadge');
                const warning = document.getElementById('assetWarning');

                if (badge) {
                    badge.textContent = `${count} selected`;
                    if (count > 10) {
                        badge.style.background = 'rgba(255,179,71,0.2)';
                        badge.style.color = '#ffb347';
                        if (warning) warning.style.display = 'block';
                    }
                }
            }, 100);
        });

        /**
         * Load exchanges for test scanning
         * Shows all 19 exchanges - backend will use whichever have price data available
         */
        function loadTestScanExchanges() {
            const allExchanges = ['binance', 'bybit', 'kraken', 'okx', 'kucoin', 'htx', 'bitget',
                                  'gateio', 'mexc', 'gemini', 'valr', 'luno', 'chainex', 'xt',
                                  'bitmart', 'bitrue', 'coincatch', 'bingx', 'ascendex'];

            const exchangesList = document.getElementById('testScanExchangesList');
            exchangesList.innerHTML = `<span style="color: #00d4ff;">Scanning all ${allExchanges.length} exchanges (using available price data)</span><br>` +
                allExchanges.map(ex =>
                    `<span style="display: inline-block; background: rgba(0,212,255,0.2); padding: 3px 8px; border-radius: 4px; margin: 2px; font-size: 0.75rem;">${ex.toUpperCase()}</span>`
                ).join('');
        }

        /**
         * Start Test Scan
         */
        async function startTestScan() {
            console.log('üî¨ Starting Test Scan Mode...');

            // Get selected assets
            const selectedAssets = Array.from(document.querySelectorAll('.test-scan-asset:checked')).map(cb => cb.value);
            if (selectedAssets.length === 0) {
                alert('‚ö†Ô∏è Please select at least one asset to scan');
                return;
            }

            // Get settings
            const minProfit = parseFloat(document.getElementById('testScanMinProfit').value);
            const scanInterval = parseInt(document.getElementById('testScanInterval').value) * 1000; // Convert to ms

            // Store config
            localStorage.setItem('testScan_config', JSON.stringify({
                assets: selectedAssets,
                minProfit,
                scanInterval: scanInterval / 1000
            }));

            // Initialize scan state
            testScanStartTime = Date.now();
            testScanCycleCount = 0;

            // UI updates
            document.getElementById('startTestScanBtn').disabled = true;
            document.getElementById('startTestScanBtn').style.cursor = 'not-allowed';
            document.getElementById('startTestScanBtn').style.opacity = '0.5';

            document.getElementById('stopTestScanBtn').disabled = false;
            document.getElementById('stopTestScanBtn').style.cursor = 'pointer';
            document.getElementById('stopTestScanBtn').style.background = 'rgba(255,107,107,0.8)';

            // Run first scan immediately
            await runTestScanCycle();

            // Set up recurring scans
            testScanInterval = setInterval(async () => {
                await runTestScanCycle();
            }, scanInterval);

            // Set up countdown timer
            testScanNextScanTime = Date.now() + scanInterval;
            testScanCountdownInterval = setInterval(updateTestScanCountdown, 1000);
        }

        /**
         * Stop Test Scan
         */
        function stopTestScan() {
            console.log('‚è∏Ô∏è Stopping Test Scan Mode...');

            // Clear intervals
            if (testScanInterval) clearInterval(testScanInterval);
            if (testScanCountdownInterval) clearInterval(testScanCountdownInterval);

            // UI updates
            document.getElementById('startTestScanBtn').disabled = false;
            document.getElementById('startTestScanBtn').style.cursor = 'pointer';
            document.getElementById('startTestScanBtn').style.opacity = '1';

            document.getElementById('stopTestScanBtn').disabled = true;
            document.getElementById('stopTestScanBtn').style.cursor = 'not-allowed';
            document.getElementById('stopTestScanBtn').style.background = 'rgba(255,107,107,0.2)';

            document.getElementById('testScanStatusText').innerHTML = 'üü° STOPPED';
            document.getElementById('testScanStatusText').style.color = '#ffb347';
            document.getElementById('testScanCountdown').textContent = '--';

            console.log('‚úÖ Test Scan Mode stopped');
        }

        /**
         * Reset Test Scan (clear all data)
         */
        function resetTestScan() {
            if (!confirm('‚ö†Ô∏è This will clear all test scan results. Continue?')) {
                return;
            }

            console.log('üîÑ Resetting Test Scan data...');

            // Clear localStorage
            localStorage.removeItem('testScan_data');
            localStorage.removeItem('testScan_config');

            // Reset counters
            testScanCycleCount = 0;
            testScanStartTime = null;
            window.testScan90PercentWarningShown = false; // Reset warning flag

            // Stop scanning if active
            if (testScanInterval) {
                stopTestScan();
            }

            // Reset UI
            document.getElementById('testScanStatusText').innerHTML = '‚ö™ READY TO SCAN';
            document.getElementById('testScanStatusText').style.color = '#888';
            document.getElementById('testScanCurrentSet').textContent = 'Click "Start Test Scan" to begin...';
            document.getElementById('testScanCurrentSet').style.color = '#888';
            document.getElementById('testScanCountdown').textContent = '--';
            document.getElementById('testScanCycles').textContent = '0';
            document.getElementById('testScanOppsFound').textContent = '0 / 50,000';
            document.getElementById('testScanOppsFound').style.color = '#ffc107';
            document.getElementById('testScanStoragePercent').textContent = '0%';
            document.getElementById('testScanStoragePercent').style.color = '#888';
            document.getElementById('testScanRunTime').textContent = '0:00';
            document.getElementById('testScanBestOpp').textContent = 'None yet';

            // Clear all report tables
            document.getElementById('testScanTopProfitBody').innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 30px; color: #888; font-style: italic;">Waiting for scan data... Click "Start Test Scan" above.</td></tr>';
            document.getElementById('testScanTopConsistencyBody').innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 30px; color: #888; font-style: italic;">Waiting for scan data... Click "Start Test Scan" above.</td></tr>';
            document.getElementById('testScanBestCryptosBody').innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 20px; color: #888;">Waiting for scan data...</td></tr>';
            document.getElementById('testScanBestExchangesBody').innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 20px; color: #888;">Waiting for scan data...</td></tr>';
            document.getElementById('testScanTimeAnalysisBody').innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px; color: #888;">Waiting for scan data...</td></tr>';

            console.log('‚úÖ Test Scan reset complete');
        }

        /**
         * Download Test Scan Results as CSV
         */
        function downloadTestScanResults() {
            const data = JSON.parse(localStorage.getItem('testScan_data') || '[]');

            if (data.length === 0) {
                alert('‚ö†Ô∏è No test scan data to download!\n\nRun a test scan first to collect data.');
                return;
            }

            console.log(`üì• Downloading ${data.length} test scan results as CSV...`);

            // CSV Headers
            const headers = [
                'Timestamp',
                'Date/Time',
                'Crypto',
                'From Exchange',
                'To Exchange',
                'Buy Price',
                'Sell Price',
                'Price Spread %',
                'Net Profit %',
                'Net Profit USD',
                'USDT to Spend',
                'Crypto Quantity',
                'Withdrawal Fee',
                'Withdrawal Fee USD',
                'Trading Fees USD',
                'Transfer Time (min)',
                'Risk Score',
                'Profitable'
            ];

            // Build CSV rows
            const csvRows = [headers.join(',')];

            data.forEach(opp => {
                const timestamp = opp.timestamp || Date.now();
                const dateTime = new Date(timestamp).toISOString().replace('T', ' ').substring(0, 19);

                const row = [
                    timestamp,
                    `"${dateTime}"`,
                    opp.crypto || '',
                    opp.fromExchange || '',
                    opp.toExchange || '',
                    opp.buyPrice || 0,
                    opp.sellPrice || 0,
                    (opp.priceSpread || 0).toFixed(3),
                    (opp.netProfitPercent || 0).toFixed(3),
                    (opp.netProfit || 0).toFixed(2),
                    (opp.usdtToSpend || 0).toFixed(2),
                    (opp.cryptoQuantity || 0).toFixed(6),
                    (opp.withdrawalFee || 0).toFixed(6),
                    (opp.withdrawalFeeUSD || 0).toFixed(2),
                    (opp.tradingFees || 0).toFixed(2),
                    opp.estimatedTransferTime || 0,
                    opp.riskScore || 0,
                    opp.profitable ? 'YES' : 'NO'
                ];

                csvRows.push(row.join(','));
            });

            // Create CSV content
            const csvContent = csvRows.join('\n');

            // Create download link
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);

            const fileName = `transfer-arb-test-scan_${new Date().toISOString().split('T')[0]}_${data.length}-routes.csv`;

            link.setAttribute('href', url);
            link.setAttribute('download', fileName);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            console.log(`‚úÖ Downloaded: ${fileName}`);
            alert(`‚úÖ Downloaded ${data.length.toLocaleString()} routes!\n\nFile: ${fileName}\n\nYou can now share this file for analysis.`);
        }

        /**
         * Run one test scan cycle (batched by asset sets)
         */
        async function runTestScanCycle() {
            // Check storage capacity before running scan
            const MAX_TEST_RESULTS = 5000;
            const currentData = JSON.parse(localStorage.getItem('testScan_data') || '[]');
            const storagePercent = (currentData.length / MAX_TEST_RESULTS * 100);

            // AUTO-PAUSE at 100% capacity
            if (storagePercent >= 100) {
                console.log('üõë Storage FULL (100%) - Auto-pausing scan');
                alert('‚ö†Ô∏è TEST SCAN STORAGE FULL!\n\n' +
                      `You have collected ${currentData.length.toLocaleString()} routes (maximum capacity).\n\n` +
                      'Please DOWNLOAD your results before continuing.\n\n' +
                      'The scan has been automatically paused.');
                stopTestScan();
                return;
            }

            // WARNING at 90% capacity (only show once per session)
            if (storagePercent >= 90 && !window.testScan90PercentWarningShown) {
                window.testScan90PercentWarningShown = true;
                console.log('‚ö†Ô∏è Storage at 90% - Warning user');
                // Non-blocking notification
                setTimeout(() => {
                    if (confirm('‚ö†Ô∏è TEST SCAN STORAGE WARNING\n\n' +
                               `You have collected ${currentData.length.toLocaleString()} / ${MAX_TEST_RESULTS.toLocaleString()} routes (${storagePercent.toFixed(1)}%).\n\n` +
                               'Storage is filling up! Consider downloading results soon.\n\n' +
                               'Continue scanning?')) {
                        console.log('User chose to continue scanning');
                    } else {
                        stopTestScan();
                    }
                }, 100);
            }

            testScanCycleCount++;
            const config = JSON.parse(localStorage.getItem('testScan_config') || '{}');
            const selectedAssets = config.assets || [];

            // Split assets into batches of 5
            const batchSize = 5;
            const assetBatches = [];
            for (let i = 0; i < selectedAssets.length; i += batchSize) {
                assetBatches.push(selectedAssets.slice(i, i + batchSize));
            }

            const currentBatch = assetBatches[(testScanCycleCount - 1) % assetBatches.length];
            const batchNumber = ((testScanCycleCount - 1) % assetBatches.length) + 1;

            console.log(`üîç Test Scan Cycle #${testScanCycleCount} - Batch ${batchNumber}/${assetBatches.length}: ${currentBatch.join(', ')}`);

            // Update status UI
            document.getElementById('testScanStatusText').innerHTML = 'üü¢ SCANNING';
            document.getElementById('testScanStatusText').style.color = '#00ff88';
            document.getElementById('testScanCurrentSet').textContent = `Batch ${batchNumber}/${assetBatches.length}: ${currentBatch.join(', ')}`;
            document.getElementById('testScanCycles').textContent = testScanCycleCount;

            // Update running time
            const elapsedSeconds = Math.floor((Date.now() - testScanStartTime) / 1000);
            const minutes = Math.floor(elapsedSeconds / 60);
            const seconds = elapsedSeconds % 60;
            document.getElementById('testScanRunTime').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;

            try {
                // Use all 19 exchanges - backend will use whichever have price data
                const allExchanges = ['binance', 'bybit', 'kraken', 'okx', 'kucoin', 'htx', 'bitget',
                                      'gateio', 'mexc', 'gemini', 'valr', 'luno', 'chainex', 'xt',
                                      'bitmart', 'bitrue', 'coincatch', 'bingx', 'ascendex'];

                // Call real-time scanner (using correct API v1 prefix)
                const response = await fetch('/api/v1/transfer-arb/scan-realtime', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        exchanges: allExchanges,
                        cryptos: currentBatch,
                        minProfitPercent: config.minProfit,
                        maxTransferAmount: 10000,
                        maxTransferTime: 120
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Backend error:', errorText);
                    throw new Error('Scan failed');
                }

                const result = await response.json();
                console.log('Backend response:', result);

                // Extract opportunities from response structure
                const opportunities = result.data?.opportunities || result.opportunities || result;
                console.log(`‚úÖ Found ${opportunities.length} opportunities in batch`);

                // Opportunities already filtered by minProfit on backend
                const filtered = opportunities;
                console.log(`üí∞ ${filtered.length} opportunities above ${config.minProfit}% profit threshold`);

                // Store opportunities
                if (filtered.length > 0) {
                    storeTestScanOpportunities(filtered);
                }

                // Update reports
                updateTestScanReports();

            } catch (error) {
                console.error('‚ùå Test scan cycle failed:', error);
            }

            // Reset countdown for next scan
            const scanInterval = config.scanInterval * 1000;
            testScanNextScanTime = Date.now() + scanInterval;
        }

        /**
         * Store opportunities in localStorage
         */
        function storeTestScanOpportunities(opportunities) {
            let data = JSON.parse(localStorage.getItem('testScan_data') || '[]');

            opportunities.forEach(opp => {
                // Create unique key for this route
                const routeKey = `${opp.fromExchange}_${opp.toExchange}_${opp.crypto}`;

                // Add timestamp and route key
                opp.timestamp = Date.now();
                opp.routeKey = routeKey;
                opp.hour = new Date().getHours();

                data.push(opp);
            });

            // Keep last 5,000 opportunities (localStorage ~10MB limit)
            const MAX_TEST_RESULTS = 5000;
            if (data.length > MAX_TEST_RESULTS) {
                data = data.slice(-MAX_TEST_RESULTS);
            }

            localStorage.setItem('testScan_data', JSON.stringify(data));
        }

        /**
         * Load existing test scan data and update reports on page load
         */
        function loadTestScanData() {
            const data = JSON.parse(localStorage.getItem('testScan_data') || '[]');
            if (data.length > 0) {
                console.log(`üìä Loaded ${data.length} historical opportunities from localStorage`);
                // Update reports with existing data
                updateTestScanReports();
            }

            // Restore saved TEST scan settings
            const config = JSON.parse(localStorage.getItem('testScan_config') || '{}');

            // Restore asset checkboxes
            if (config.assets && config.assets.length > 0) {
                console.log(`‚úÖ Restoring ${config.assets.length} selected assets:`, config.assets);
                // Uncheck all first
                document.querySelectorAll('.test-scan-asset').forEach(cb => cb.checked = false);
                // Check saved ones
                config.assets.forEach(asset => {
                    const checkbox = document.querySelector(`.test-scan-asset[value="${asset}"]`);
                    if (checkbox) checkbox.checked = true;
                });
            }

            // Restore min profit
            if (config.minProfit !== undefined) {
                const minProfitInput = document.getElementById('testScanMinProfit');
                if (minProfitInput) {
                    minProfitInput.value = config.minProfit;
                    console.log(`üí∞ Restored min profit: ${config.minProfit}%`);
                }
            }

            // Restore scan interval
            if (config.scanInterval !== undefined) {
                const scanIntervalSelect = document.getElementById('testScanInterval');
                if (scanIntervalSelect) {
                    scanIntervalSelect.value = config.scanInterval;
                    console.log(`‚è±Ô∏è Restored scan interval: ${config.scanInterval} seconds`);
                }
            }
        }

        /**
         * Update all report tables
         */
        function updateTestScanReports() {
            const data = JSON.parse(localStorage.getItem('testScan_data') || '[]');

            console.log(`üìä Updating reports with ${data.length} total opportunities`);

            if (data.length === 0) {
                console.log('‚ö†Ô∏è No data to display in reports');
                return;
            }

            // Update opportunity count with progress indicator
            const MAX_TEST_RESULTS = 5000;
            const storagePercent = (data.length / MAX_TEST_RESULTS * 100).toFixed(1);
            const oppsFoundEl = document.getElementById('testScanOppsFound');
            const percentEl = document.getElementById('testScanStoragePercent');

            oppsFoundEl.textContent = `${data.length.toLocaleString()} / ${MAX_TEST_RESULTS.toLocaleString()}`;
            percentEl.textContent = `${storagePercent}%`;

            // Color coding based on storage capacity
            if (storagePercent >= 100) {
                oppsFoundEl.style.color = '#ff6b6b'; // Red - FULL
                percentEl.style.color = '#ff6b6b';
                percentEl.textContent = `${storagePercent}% - FULL! Download data`;
            } else if (storagePercent >= 90) {
                oppsFoundEl.style.color = '#ffb347'; // Orange - Warning
                percentEl.style.color = '#ffb347';
                percentEl.textContent = `${storagePercent}% - Download soon!`;
            } else {
                oppsFoundEl.style.color = '#ffc107'; // Yellow - Normal
                percentEl.style.color = '#888';
            }

            // Calculate best opportunity
            const best = data.reduce((max, opp) => opp.netProfitPercent > max.netProfitPercent ? opp : max);
            document.getElementById('testScanBestOpp').textContent =
                `${best.fromExchange.toUpperCase()} ‚Üí ${best.toExchange.toUpperCase()} via ${best.crypto} (${best.netProfitPercent.toFixed(2)}%)`;

            // Group opportunities by route
            const routeStats = {};
            data.forEach(opp => {
                const key = opp.routeKey;
                if (!routeStats[key]) {
                    routeStats[key] = {
                        fromExchange: opp.fromExchange,
                        toExchange: opp.toExchange,
                        crypto: opp.crypto,
                        riskScore: opp.riskScore,
                        estimatedTransferTime: opp.estimatedTransferTime,
                        profits: [],
                        lastSeen: opp.timestamp
                    };
                }
                routeStats[key].profits.push(opp.netProfitPercent);
                if (opp.timestamp > routeStats[key].lastSeen) {
                    routeStats[key].lastSeen = opp.timestamp;
                }
            });

            // Calculate statistics for each route
            const routes = Object.keys(routeStats).map(key => {
                const route = routeStats[key];
                const profits = route.profits;
                const avgProfit = profits.reduce((a, b) => a + b, 0) / profits.length;
                const maxProfit = Math.max(...profits);
                const minProfit = Math.min(...profits);
                const count = profits.length;

                return {
                    ...route,
                    avgProfit,
                    maxProfit,
                    minProfit,
                    count,
                    consistency: (1 - (maxProfit - minProfit) / avgProfit) * 100 // Lower variance = higher consistency
                };
            });

            // Top 20 by Profit %
            const topProfit = routes.sort((a, b) => b.avgProfit - a.avgProfit).slice(0, 20);
            console.log(`üí∞ Top profit routes: ${topProfit.length} routes, best: ${topProfit[0]?.avgProfit.toFixed(2)}%`);
            updateTopProfitTable(topProfit);

            // Top 20 by Consistency
            const topConsistency = routes.sort((a, b) => b.count - a.count).slice(0, 20);
            console.log(`üîÑ Top consistency routes: ${topConsistency.length} routes, most consistent: ${topConsistency[0]?.count} occurrences`);
            updateTopConsistencyTable(topConsistency);

            // Best Cryptos
            const cryptoStats = {};
            data.forEach(opp => {
                if (!cryptoStats[opp.crypto]) {
                    cryptoStats[opp.crypto] = {profits: [], count: 0};
                }
                cryptoStats[opp.crypto].profits.push(opp.netProfitPercent);
                cryptoStats[opp.crypto].count++;
            });
            const bestCryptos = Object.keys(cryptoStats).map(crypto => ({
                crypto,
                count: cryptoStats[crypto].count,
                avgProfit: cryptoStats[crypto].profits.reduce((a, b) => a + b, 0) / cryptoStats[crypto].profits.length
            })).sort((a, b) => b.count - a.count).slice(0, 20);
            updateBestCryptosTable(bestCryptos);

            // Best Exchanges
            const exchangePairStats = {};
            data.forEach(opp => {
                const pair = `${opp.fromExchange}‚Üí${opp.toExchange}`;
                if (!exchangePairStats[pair]) {
                    exchangePairStats[pair] = {profits: [], count: 0};
                }
                exchangePairStats[pair].profits.push(opp.netProfitPercent);
                exchangePairStats[pair].count++;
            });
            const bestExchanges = Object.keys(exchangePairStats).map(pair => ({
                pair,
                count: exchangePairStats[pair].count,
                avgProfit: exchangePairStats[pair].profits.reduce((a, b) => a + b, 0) / exchangePairStats[pair].profits.length
            })).sort((a, b) => b.count - a.count).slice(0, 20);
            updateBestExchangesTable(bestExchanges);

            // Time Analysis
            const hourStats = {};
            for (let i = 0; i < 24; i++) hourStats[i] = {count: 0, profits: [], routes: {}};
            data.forEach(opp => {
                hourStats[opp.hour].count++;
                hourStats[opp.hour].profits.push(opp.netProfitPercent);
                const routeKey = `${opp.fromExchange}‚Üí${opp.toExchange} (${opp.crypto})`;
                hourStats[opp.hour].routes[routeKey] = (hourStats[opp.hour].routes[routeKey] || 0) + 1;
            });
            updateTimeAnalysisTable(hourStats);
        }

        function updateTopProfitTable(routes) {
            const tbody = document.getElementById('testScanTopProfitBody');
            if (routes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="11" style="text-align: center; padding: 30px; color: #888;">No data yet</td></tr>';
                return;
            }

            tbody.innerHTML = routes.map((route, i) => {
                const rowId = `route-${i}`;
                return `
                <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                    <td style="padding: 10px; color: #ffc107; font-weight: bold;">${i + 1}</td>
                    <td style="padding: 10px;">${route.fromExchange.toUpperCase()} ‚Üí ${route.toExchange.toUpperCase()}</td>
                    <td style="padding: 10px; color: #00ff88; font-weight: bold;">${route.crypto}</td>
                    <td style="padding: 10px; text-align: right; color: #00ff88; font-weight: bold;">${route.avgProfit.toFixed(2)}%</td>
                    <td style="padding: 10px; text-align: right; color: #ffc107;">${route.maxProfit.toFixed(2)}%</td>
                    <td style="padding: 10px; text-align: right;">${route.count}</td>
                    <td style="padding: 10px; text-align: center;">${getRiskBadge(route.riskScore)}</td>
                    <td style="padding: 10px; text-align: center;">${getLiquidityRating(route.fromExchange, route.toExchange)}</td>
                    <td id="${rowId}-network" style="padding: 10px; text-align: center; font-size: 0.75rem;" data-from="${route.fromExchange}" data-to="${route.toExchange}" data-crypto="${route.crypto}">
                        <span style="color: #888;">...</span>
                    </td>
                    <td style="padding: 10px; text-align: center; color: #b8c6db;">${route.estimatedTransferTime}m</td>
                    <td style="padding: 10px; text-align: right; color: #888; font-size: 0.8rem;">${formatTimestamp(route.lastSeen)}</td>
                </tr>
                `;
            }).join('');

            // Fetch network info asynchronously for each route
            routes.forEach((route, i) => {
                fetchAndDisplayNetworkInfo(i, route.fromExchange, route.toExchange, route.crypto);
            });
        }

        async function fetchAndDisplayNetworkInfo(rowIndex, fromExchange, toExchange, crypto) {
            const cell = document.getElementById(`route-${rowIndex}-network`);
            if (!cell) return;

            try {
                const response = await fetch(`/api/v1/transfer-arb/networks/${fromExchange}/${toExchange}/${crypto}`);
                const result = await response.json();

                if (result.success && result.data) {
                    const { matchingNetworks, isViable } = result.data;

                    if (matchingNetworks.length > 0) {
                        // Show best (cheapest) network
                        const best = matchingNetworks[0];
                        cell.innerHTML = `
                            <div style="display: flex; flex-direction: column; align-items: center; gap: 2px;">
                                <span style="background: rgba(0,255,136,0.2); color: #00ff88; padding: 2px 6px; border-radius: 3px; font-weight: bold;">‚úÖ ${best.network}</span>
                                <span style="color: #888; font-size: 0.7rem;">Fee: $${best.withdrawFee.toFixed(2)}</span>
                            </div>
                        `;
                    } else {
                        cell.innerHTML = `
                            <span style="background: rgba(255,107,107,0.2); color: #ff6b6b; padding: 2px 6px; border-radius: 3px;">‚ùå No match</span>
                        `;
                    }
                } else {
                    cell.innerHTML = '<span style="color: #888;">N/A</span>';
                }
            } catch (error) {
                console.error(`Failed to fetch network info for ${fromExchange}‚Üí${toExchange} ${crypto}:`, error);
                cell.innerHTML = '<span style="color: #888;">Error</span>';
            }
        }

        function updateTopConsistencyTable(routes) {
            const tbody = document.getElementById('testScanTopConsistencyBody');
            if (routes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 30px; color: #888;">No data yet</td></tr>';
                return;
            }

            tbody.innerHTML = routes.map((route, i) => `
                <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                    <td style="padding: 10px; color: #00d4ff; font-weight: bold;">${i + 1}</td>
                    <td style="padding: 10px;">${route.fromExchange.toUpperCase()} ‚Üí ${route.toExchange.toUpperCase()}</td>
                    <td style="padding: 10px; color: #00ff88; font-weight: bold;">${route.crypto}</td>
                    <td style="padding: 10px; text-align: right; font-weight: bold; color: #00d4ff;">${route.count}</td>
                    <td style="padding: 10px; text-align: right; color: #00ff88;">${route.avgProfit.toFixed(2)}%</td>
                    <td style="padding: 10px; text-align: right; color: #888; font-size: 0.85rem;">${route.minProfit.toFixed(2)}% / ${route.maxProfit.toFixed(2)}%</td>
                    <td style="padding: 10px; text-align: center;">${getConsistencyBadge(route.consistency)}</td>
                </tr>
            `).join('');
        }

        function updateBestCryptosTable(cryptos) {
            const tbody = document.getElementById('testScanBestCryptosBody');
            if (cryptos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 20px; color: #888;">No data yet</td></tr>';
                return;
            }

            tbody.innerHTML = cryptos.map(crypto => `
                <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                    <td style="padding: 10px; color: #667eea; font-weight: bold;">${crypto.crypto}</td>
                    <td style="padding: 10px; text-align: right; color: #00d4ff;">${crypto.count}</td>
                    <td style="padding: 10px; text-align: right; color: #00ff88;">${crypto.avgProfit.toFixed(2)}%</td>
                </tr>
            `).join('');
        }

        function updateBestExchangesTable(exchanges) {
            const tbody = document.getElementById('testScanBestExchangesBody');
            if (exchanges.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 20px; color: #888;">No data yet</td></tr>';
                return;
            }

            tbody.innerHTML = exchanges.map(ex => `
                <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                    <td style="padding: 10px; color: #ffb347; font-weight: bold;">${ex.pair.toUpperCase()}</td>
                    <td style="padding: 10px; text-align: right; color: #00d4ff;">${ex.count}</td>
                    <td style="padding: 10px; text-align: right; color: #00ff88;">${ex.avgProfit.toFixed(2)}%</td>
                </tr>
            `).join('');
        }

        function updateTimeAnalysisTable(hourStats) {
            const tbody = document.getElementById('testScanTimeAnalysisBody');
            const hours = Object.keys(hourStats).filter(h => hourStats[h].count > 0).sort((a, b) => hourStats[b].count - hourStats[a].count).slice(0, 10);

            if (hours.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px; color: #888;">Need more scanning data for time analysis...</td></tr>';
                return;
            }

            tbody.innerHTML = hours.map(hour => {
                const stats = hourStats[hour];
                const avgProfit = stats.profits.reduce((a, b) => a + b, 0) / stats.profits.length;
                const mostCommonRoute = Object.keys(stats.routes).reduce((a, b) => stats.routes[a] > stats.routes[b] ? a : b);

                return `
                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                        <td style="padding: 10px; color: #ffc107; font-weight: bold;">${hour}:00 - ${hour}:59</td>
                        <td style="padding: 10px; text-align: right; color: #00d4ff;">${stats.count}</td>
                        <td style="padding: 10px; text-align: right; color: #00ff88;">${avgProfit.toFixed(2)}%</td>
                        <td style="padding: 10px; color: #b8c6db; font-size: 0.85rem;">${mostCommonRoute}</td>
                    </tr>
                `;
            }).join('');
        }

        function getRiskBadge(risk) {
            if (risk <= 3) return '<span style="background: rgba(0,255,136,0.2); color: #00ff88; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">LOW</span>';
            if (risk <= 6) return '<span style="background: rgba(255,179,71,0.2); color: #ffb347; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">MED</span>';
            return '<span style="background: rgba(255,107,107,0.2); color: #ff6b6b; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">HIGH</span>';
        }

        function getLiquidityRating(fromExchange, toExchange) {
            // Exchange liquidity tiers based on 24h volume and market depth
            const highLiquidityExchanges = ['binance', 'kraken', 'okx', 'bybit', 'gateio'];
            const mediumLiquidityExchanges = ['kucoin', 'mexc', 'htx', 'bitget', 'gemini'];
            // All others (valr, luno, chainex, xt, bitmart, bitrue, coincatch, bingx, ascendex) are low liquidity

            const getExchangeLiquidity = (exchange) => {
                const ex = exchange.toLowerCase();
                if (highLiquidityExchanges.includes(ex)) return 5;
                if (mediumLiquidityExchanges.includes(ex)) return 3;
                return 1; // Low liquidity
            };

            // Route liquidity is determined by the weakest link (minimum of the two exchanges)
            const fromLiq = getExchangeLiquidity(fromExchange);
            const toLiq = getExchangeLiquidity(toExchange);
            const routeLiquidity = Math.min(fromLiq, toLiq);

            // Return color-coded badge
            if (routeLiquidity === 5) {
                return '<span style="background: rgba(0,255,136,0.2); color: #00ff88; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">üü¢ 5/5</span>';
            } else if (routeLiquidity === 3) {
                return '<span style="background: rgba(255,179,71,0.2); color: #ffb347; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">üü° 3/5</span>';
            } else {
                return '<span style="background: rgba(255,107,107,0.2); color: #ff6b6b; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">üî¥ 1/5</span>';
            }
        }

        function getConsistencyBadge(consistency) {
            if (consistency >= 90) return '<span style="background: rgba(0,255,136,0.2); color: #00ff88; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">‚≠ê‚≠ê‚≠ê</span>';
            if (consistency >= 70) return '<span style="background: rgba(255,179,71,0.2); color: #ffb347; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">‚≠ê‚≠ê</span>';
            return '<span style="background: rgba(255,255,255,0.1); color: #888; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">‚≠ê</span>';
        }

        function formatTimestamp(timestamp) {
            const now = Date.now();
            const diff = now - timestamp;
            const seconds = Math.floor(diff / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);

            if (seconds < 60) return `${seconds}s ago`;
            if (minutes < 60) return `${minutes}m ago`;
            return `${hours}h ago`;
        }

        function updateTestScanCountdown() {
            if (!testScanNextScanTime) return;

            const remaining = Math.max(0, Math.floor((testScanNextScanTime - Date.now()) / 1000));
            document.getElementById('testScanCountdown').textContent = `${remaining}s`;
        }

        // End of Test Scan Mode

        // ============================================================================
        // MANUAL TRADING FUNCTIONALITY
        // ============================================================================

        // Manual trading variables
        let manualOpportunities = [];
        let manualTradingExpanded = false;

        // Define manual trading assets (all TEST scan assets except the 17 auto-trading ones)
        const AUTO_TRADING_ASSETS = ['USDT', 'USDC', 'XRP', 'XLM', 'TRX', 'SOL', 'ALGO', 'MATIC', 'AVAX', 'ATOM', 'LTC', 'BCH', 'DOGE', 'ADA', 'DOT', 'BTC', 'ETH'];

        // Get all test scan assets
        function getAllTestScanAssets() {
            const checkboxes = document.querySelectorAll('.test-scan-asset');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        // Get manual trading assets (TEST scan - AUTO trading)
        function getManualTradingAssets() {
            const allAssets = getAllTestScanAssets();
            return allAssets.filter(asset => !AUTO_TRADING_ASSETS.includes(asset));
        }

        // Toggle manual trading section visibility
        function toggleManualTrading() {
            manualTradingExpanded = !manualTradingExpanded;
            const container = document.getElementById('manual-opportunities-container');
            const btn = document.getElementById('toggle-manual-trading-btn');

            if (manualTradingExpanded) {
                container.style.display = 'block';
                btn.textContent = 'üôà Hide Manual Opportunities';
                btn.style.background = 'linear-gradient(45deg, #667eea 0%, #764ba2 100%)';

                // Scan for opportunities when expanding
                scanManualOpportunities();
            } else {
                container.style.display = 'none';
                btn.textContent = 'üëÅÔ∏è Show Manual Opportunities';
                btn.style.background = 'linear-gradient(45deg, #ffb347 0%, #ff6b6b 100%)';
            }
        }

        // Check if an asset is configured for both exchanges
        function checkManualAssetConfiguration(crypto, fromExchange, toExchange) {
            const fromNetwork = localStorage.getItem(`deposit_${fromExchange}_${crypto}_network`);
            const fromDeposit = localStorage.getItem(`deposit_${fromExchange}_${crypto}_deposit`);
            const toNetwork = localStorage.getItem(`deposit_${toExchange}_${crypto}_network`);
            const toDeposit = localStorage.getItem(`deposit_${toExchange}_${crypto}_deposit`);

            const fromConfigured = fromNetwork && fromDeposit;
            const toConfigured = toNetwork && toDeposit;

            if (fromConfigured && toConfigured && fromNetwork === toNetwork) {
                return { status: 'ready', message: '‚úÖ Ready to Execute' };
            } else if (fromConfigured || toConfigured) {
                return { status: 'partial', message: 'üü° Partially Configured' };
            } else {
                return { status: 'not-configured', message: '‚ö†Ô∏è Not Configured' };
            }
        }

        // Scan for manual trading opportunities
        async function scanManualOpportunities() {
            console.log('üîç Scanning manual trading opportunities...');

            const manualAssets = getManualTradingAssets();
            const connectedExchanges = getConnectedExchanges();

            if (connectedExchanges.length < 2) {
                document.getElementById('manual-opportunities-list').innerHTML = `
                    <div style="background: rgba(255,107,107,0.2); border: 1px solid #ff6b6b; border-radius: 8px; padding: 30px; text-align: center;">
                        <h4 style="color: #ff6b6b;">‚ö†Ô∏è Need More Exchanges</h4>
                        <p style="color: #b8c6db;">Connect at least 2 exchanges to scan for manual trading opportunities.</p>
                    </div>
                `;
                return;
            }

            // Show loading state
            document.getElementById('manual-opportunities-list').innerHTML = `
                <div style="text-align: center; padding: 40px; color: #00d4ff;">
                    <div style="font-size: 2rem; margin-bottom: 10px;">‚è≥</div>
                    <div>Scanning ${manualAssets.length} assets across ${connectedExchanges.length} exchanges...</div>
                </div>
            `;

            try {
                // Fetch prices for all manual assets
                const response = await fetch('/api/v1/transfer-arb/scan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        exchanges: connectedExchanges,
                        assets: manualAssets
                    })
                });

                if (!response.ok) throw new Error('Scan failed');

                const data = await response.json();
                manualOpportunities = data.opportunities || [];

                // Check configuration status for each opportunity
                manualOpportunities.forEach(opp => {
                    const configStatus = checkManualAssetConfiguration(opp.crypto, opp.fromExchange, opp.toExchange);
                    opp.configStatus = configStatus.status;
                    opp.configMessage = configStatus.message;
                });

                // Apply filters and sort
                applyManualFiltersAndDisplay();

            } catch (error) {
                console.error('Manual scan error:', error);
                document.getElementById('manual-opportunities-list').innerHTML = `
                    <div style="background: rgba(255,107,107,0.2); border: 1px solid #ff6b6b; border-radius: 8px; padding: 30px; text-align: center;">
                        <h4 style="color: #ff6b6b;">‚ùå Scan Failed</h4>
                        <p style="color: #b8c6db;">${error.message}</p>
                    </div>
                `;
            }
        }

        // Apply filters and display manual opportunities
        function applyManualFiltersAndDisplay() {
            const minProfit = parseFloat(document.getElementById('manual-min-profit').value) || 0;
            const sortBy = document.getElementById('manual-sort').value;
            const statusFilter = document.getElementById('manual-status-filter').value;

            // Filter opportunities
            let filtered = manualOpportunities.filter(opp => opp.netProfitPercent >= minProfit);

            // Apply status filter
            if (statusFilter !== 'all') {
                filtered = filtered.filter(opp => opp.configStatus === statusFilter);
            }

            // Sort opportunities
            filtered.sort((a, b) => {
                if (sortBy === 'profit-desc') return b.netProfitPercent - a.netProfitPercent;
                if (sortBy === 'profit-asc') return a.netProfitPercent - b.netProfitPercent;
                if (sortBy === 'time-asc') return a.estimatedTransferTime - b.estimatedTransferTime;
                if (sortBy === 'ready-first') {
                    if (a.configStatus === 'ready' && b.configStatus !== 'ready') return -1;
                    if (a.configStatus !== 'ready' && b.configStatus === 'ready') return 1;
                    return b.netProfitPercent - a.netProfitPercent;
                }
                return 0;
            });

            // Update stats
            const readyCount = manualOpportunities.filter(opp => opp.configStatus === 'ready').length;
            const bestProfit = filtered.length > 0 ? Math.max(...filtered.map(opp => opp.netProfitPercent)) : 0;

            document.getElementById('manual-opp-count').textContent = filtered.length;
            document.getElementById('manual-ready-count').textContent = readyCount;
            document.getElementById('manual-best-profit').textContent = `${bestProfit.toFixed(2)}%`;

            // Display opportunities
            displayManualOpportunities(filtered);
        }

        // Display manual opportunities
        function displayManualOpportunities(opportunities) {
            const listDiv = document.getElementById('manual-opportunities-list');

            if (opportunities.length === 0) {
                listDiv.innerHTML = `
                    <div style="background: rgba(255,179,71,0.2); border: 1px solid #ffb347; border-radius: 8px; padding: 30px; text-align: center;">
                        <h4 style="color: #ffb347;">üì≠ No Opportunities Found</h4>
                        <p style="color: #b8c6db;">Try lowering the minimum profit % or adjusting filters.</p>
                    </div>
                `;
                return;
            }

            listDiv.innerHTML = opportunities.map(opp => `
                <div style="background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; padding: 20px; margin-bottom: 15px;">
                    <div style="display: grid; grid-template-columns: 1fr auto; gap: 20px; align-items: start;">
                        <div>
                            <!-- Header -->
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                <div style="background: linear-gradient(45deg, #667eea 0%, #764ba2 100%); padding: 8px 16px; border-radius: 8px; font-weight: bold; font-size: 1.1rem;">
                                    ${opp.crypto}
                                </div>
                                <div style="color: #b8c6db; font-size: 0.95rem;">
                                    ${opp.fromExchange} ‚Üí ${opp.toExchange}
                                </div>
                                <div style="margin-left: auto;">
                                    ${opp.configMessage}
                                </div>
                            </div>

                            <!-- Metrics -->
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 15px;">
                                <div>
                                    <div style="color: #888; font-size: 0.75rem;">Profit</div>
                                    <div style="color: #00ff88; font-size: 1.3rem; font-weight: bold;">${opp.netProfitPercent.toFixed(2)}%</div>
                                    <div style="color: #00ff88; font-size: 0.85rem;">$${opp.netProfit.toFixed(2)}</div>
                                </div>
                                <div>
                                    <div style="color: #888; font-size: 0.75rem;">Buy Price</div>
                                    <div style="color: #00d4ff; font-size: 1rem;">$${opp.buyPrice.toFixed(6)}</div>
                                </div>
                                <div>
                                    <div style="color: #888; font-size: 0.75rem;">Sell Price</div>
                                    <div style="color: #ffb347; font-size: 1rem;">$${opp.sellPrice.toFixed(6)}</div>
                                </div>
                                <div>
                                    <div style="color: #888; font-size: 0.75rem;">Transfer Time</div>
                                    <div style="color: #b8c6db; font-size: 1rem;">${opp.estimatedTransferTime} min</div>
                                </div>
                            </div>
                        </div>

                        <!-- Actions -->
                        <div style="display: flex; flex-direction: column; gap: 10px; min-width: 180px;">
                            ${opp.configStatus === 'ready' ? `
                                <button onclick="executeManualTrade(${JSON.stringify(opp).replace(/"/g, '&quot;')})"
                                        style="background: linear-gradient(45deg, #00ff88 0%, #00d4ff 100%);
                                               border: none; padding: 12px 20px; border-radius: 8px;
                                               color: white; font-weight: bold; cursor: pointer;
                                               box-shadow: 0 4px 15px rgba(0,255,136,0.3);">
                                    ‚ö° Execute Trade
                                </button>
                            ` : `
                                <button onclick="openDepositModalForAsset('${opp.crypto}', '${opp.fromExchange}', '${opp.toExchange}')"
                                        style="background: linear-gradient(45deg, #ffb347 0%, #ff6b6b 100%);
                                               border: none; padding: 12px 20px; border-radius: 8px;
                                               color: white; font-weight: bold; cursor: pointer;">
                                    ‚öôÔ∏è Configure Addresses
                                </button>
                            `}
                            <button onclick="showOpportunityDetails(${JSON.stringify(opp).replace(/"/g, '&quot;')})"
                                    style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3);
                                           padding: 8px 16px; border-radius: 6px; color: #b8c6db;
                                           cursor: pointer; font-size: 0.9rem;">
                                üìä Details
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Execute manual trade
        async function executeManualTrade(opportunity) {
            console.log('‚ö° Executing manual trade:', opportunity);

            // Confirm with user
            const confirmMsg = `Execute Manual Trade?\n\n` +
                `Asset: ${opportunity.crypto}\n` +
                `Route: ${opportunity.fromExchange} ‚Üí ${opportunity.toExchange}\n` +
                `Profit: ${opportunity.netProfitPercent.toFixed(2)}% ($${opportunity.netProfit.toFixed(2)})\n` +
                `Transfer Time: ~${opportunity.estimatedTransferTime} minutes\n\n` +
                `Continue?`;

            if (!confirm(confirmMsg)) {
                return;
            }

            // Execute using the same function as auto-trading (WITHOUT trade locking)
            await executeTransferDirect(opportunity, { skipLocking: true });

            // Refresh manual opportunities
            setTimeout(() => scanManualOpportunities(), 2000);
        }

        // Open deposit modal for specific asset
        function openDepositModalForAsset(crypto, fromExchange, toExchange) {
            // First open the modal
            openDepositAddressModal();

            // Wait for modal to populate, then scroll to the asset
            setTimeout(() => {
                const fromElement = document.getElementById(`modal-${fromExchange}-${crypto}-network`);
                const toElement = document.getElementById(`modal-${toExchange}-${crypto}-network`);

                if (fromElement) {
                    fromElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    fromElement.style.border = '3px solid #ffb347';
                    setTimeout(() => { fromElement.style.border = '2px solid #00d4ff'; }, 2000);
                }

                if (toElement && toElement !== fromElement) {
                    setTimeout(() => {
                        toElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        toElement.style.border = '3px solid #ffb347';
                        setTimeout(() => { toElement.style.border = '2px solid #00d4ff'; }, 2000);
                    }, 1000);
                }
            }, 500);
        }

        // Show opportunity details
        function showOpportunityDetails(opportunity) {
            const details = `
üìä Opportunity Details

Asset: ${opportunity.crypto}
Route: ${opportunity.fromExchange} ‚Üí ${opportunity.toExchange}

üí∞ PROFIT:
‚Ä¢ Net Profit: ${opportunity.netProfitPercent.toFixed(2)}% ($${opportunity.netProfit.toFixed(2)})
‚Ä¢ Price Spread: ${opportunity.priceSpread.toFixed(2)}%

üíµ PRICING:
‚Ä¢ Buy Price: $${opportunity.buyPrice.toFixed(6)} (${opportunity.fromExchange})
‚Ä¢ Sell Price: $${opportunity.sellPrice.toFixed(6)} (${opportunity.toExchange})

üí∏ EXECUTION:
‚Ä¢ USDT to Spend: $${opportunity.usdtToSpend.toFixed(2)}
‚Ä¢ ${opportunity.crypto} Quantity: ${opportunity.cryptoQuantity.toFixed(6)}
‚Ä¢ ${opportunity.crypto} Received: ${opportunity.cryptoReceived.toFixed(6)}
‚Ä¢ Revenue USDT: $${opportunity.revenueUSDT.toFixed(2)}

üí≥ FEES:
‚Ä¢ Withdrawal Fee: ${opportunity.withdrawalFee} ${opportunity.crypto} ($${opportunity.withdrawalFeeUSD.toFixed(2)})
‚Ä¢ Network Fee: $${opportunity.networkFee.toFixed(2)}
‚Ä¢ Total Fees: $${opportunity.totalFees.toFixed(2)}

‚è±Ô∏è TIMING:
‚Ä¢ Estimated Transfer: ${opportunity.estimatedTransferTime} minutes
‚Ä¢ Confirmations Required: ${opportunity.confirmations}
‚Ä¢ Risk Score: ${opportunity.riskScore}/10

‚öôÔ∏è CONFIGURATION:
${opportunity.configMessage}
            `;

            alert(details);
        }

        // Modify executeTransferDirect to support skipping trade locking for manual trades
        const originalExecuteTransferDirect = executeTransferDirect;
        executeTransferDirect = async function(opportunity, options = {}) {
            const skipLocking = options.skipLocking || false;

            if (skipLocking) {
                console.log('üìù Manual trade - skipping trade locking');
                // Call original function without locking
                return await originalExecuteTransferDirect.call(this, opportunity);
            } else {
                // Normal auto-trading with locking
                return await originalExecuteTransferDirect.call(this, opportunity);
            }
        };

        // When live trading stops, collapse manual trading section
        const originalStopContinuousScan = stopContinuousScan;
        stopContinuousScan = function() {
            // Collapse manual trading section (but keep it visible)
            manualTradingExpanded = false;
            const container = document.getElementById('manual-opportunities-container');
            const btn = document.getElementById('toggle-manual-trading-btn');
            if (container) container.style.display = 'none';
            if (btn) {
                btn.textContent = 'üëÅÔ∏è Show Manual Opportunities';
                btn.style.background = 'linear-gradient(45deg, #ffb347 0%, #ff6b6b 100%)';
            }

            // Call original function
            return originalStopContinuousScan.call(this);
        };

        console.log('‚úÖ Manual trading functionality loaded');

        // ============================================================================
        // END OF MANUAL TRADING FUNCTIONALITY
        // ============================================================================

        // End of About Modal Functionality
    </script>
</body>
</html>